# 工作流强制执行规则 (Workflow Enforcement Rules)

## ⚠️ 关键原则：必须使用专用 Agent

本文档定义了在不同工作场景下**强制必须**使用的 Agent。这不是建议，而是**强制要求**。

---

## 🚨 强制使用 Agent 的场景

### 场景1：完成任何代码修改后 ⚠️ 必须执行

**触发条件**（满足任一即触发）：
- 修改了任何 `.ts` / `.tsx` / `.js` / `.jsx` 文件
- 创建了新的功能文件
- 修复了 Bug
- 完成了功能开发
- 添加了新的 API 端点
- 修改了数据库 schema

**必须执行的操作**：
```
✅ 必须立即使用 Task tool 调用 project-summarizer agent
```

**调用方式**：
```typescript
Task tool:
- subagent_type: "project-summarizer"
- description: "生成{功能名称}文档"
- prompt: "我刚刚完成了{工作内容}，需要生成相应的技术文档并更新导航文件"
```

**禁止行为**：
- ❌ 完成代码后直接提交 git commit，而不生成文档
- ❌ 告诉用户"工作完成"，但没有生成文档
- ❌ 问用户"是否需要生成文档"（应该主动生成）

---

### 场景2：需求不明确时 ⚠️ 必须执行

**触发条件**（满足任一即触发）：
- 用户请求模糊（"帮我"、"修复这个"、"优化一下"）
- 缺少关键信息（没说是哪个功能、哪个文件）
- 需求存在歧义（有多种理解方式）
- 用户期望不清楚（不知道想要什么结果）

**必须执行的操作**：
```
✅ 必须立即使用 Task tool 调用 task-clarifier agent
```

**调用方式**：
```typescript
Task tool:
- subagent_type: "task-clarifier"
- description: "澄清用户需求"
- prompt: "用户的请求是'{用户原话}'，需要澄清具体需求和期望"
```

**禁止行为**：
- ❌ 猜测用户意图并直接开始编码
- ❌ 用"应该"、"可能"等不确定词汇后开始实现
- ❌ 假设需求细节

---

### 场景3：需要编写新功能时 ⚠️ 建议执行

**触发条件**：
- 用户提出新功能需求
- 需要理解功能全貌
- 需要明确技术方案

**建议执行的操作**：
```
✅ 建议使用 Task tool 调用 product-manager agent（如果需求复杂）
```

**调用方式**：
```typescript
Task tool:
- subagent_type: "product-manager"
- description: "编写{功能名称}PRD"
- prompt: "用户想要实现{功能描述}，需要编写详细的PRD文档"
```

---

### 场景4：需要代码审查时 ⚠️ 建议执行

**触发条件**：
- 完成重要功能代码
- 涉及核心业务逻辑
- 涉及资金安全
- 用户明确要求审查

**建议执行的操作**：
```
✅ 建议使用 Task tool 调用 reviewer agent
```

**调用方式**：
```typescript
Task tool:
- subagent_type: "reviewer"
- description: "审查{功能名称}代码"
- prompt: "我刚刚完成了{文件路径}的代码，需要进行代码审查"
```

---

## 📋 工作流检查清单

在每次对话即将结束时，**必须**按照以下检查清单检查：

### 检查点1：是否修改了代码？
```
如果修改了代码：
  ✅ 必须：立即调用 project-summarizer agent
  ✅ 必须：生成技术文档
  ✅ 必须：更新导航文件

如果没有修改代码：
  ✅ 跳过此步骤
```

### 检查点2：是否有未澄清的需求？
```
如果需求不明确：
  ✅ 必须：立即调用 task-clarifier agent
  ✅ 必须：澄清需求后再开始工作

如果需求清晰：
  ✅ 跳过此步骤
```

### 检查点3：是否需要PRD文档？
```
如果是复杂新功能：
  ✅ 建议：调用 product-manager agent

如果是简单修改：
  ✅ 跳过此步骤
```

### 检查点4：是否需要代码审查？
```
如果是核心业务逻辑：
  ✅ 建议：调用 reviewer agent

如果是简单修改：
  ✅ 跳过此步骤
```

---

## 🔴 违规示例（禁止）

### 示例1：完成代码后不生成文档
```
❌ 错误做法：
用户："帮我增加期权策略日志"
你：[修改了3个文件]
你："完成！已增加期权策略日志"
[没有调用 project-summarizer agent]

✅ 正确做法：
用户："帮我增加期权策略日志"
你：[修改了3个文件]
你：[调用 project-summarizer agent 生成文档]
你："完成！已增加期权策略日志，并生成了技术文档"
```

### 示例2：需求不明确时直接编码
```
❌ 错误做法：
用户："帮我优化一下"
你："好的，我来优化性能"
[直接开始修改代码]

✅ 正确做法：
用户："帮我优化一下"
你：[调用 task-clarifier agent]
你："我需要了解几个问题：1. 您想优化哪个部分？2. 优化的目标是什么？..."
```

---

## 🟢 正确示例（鼓励）

### 示例1：主动使用 project-summarizer
```
用户："增加期权策略日志"
你：[完成代码修改]
你：[主动调用 project-summarizer agent]
project-summarizer agent：[生成技术文档 + 更新导航文件]
你："✅ 完成！我已经：
1. 增强了期权策略日志（9个检查点）
2. 生成了完整技术文档
3. 更新了所有导航文件
详见：docs/features/260204-期权策略决策链路日志增强.md"
```

### 示例2：主动使用 task-clarifier
```
用户："修复这个问题"
你：[发现需求不明确]
你：[主动调用 task-clarifier agent]
你："我需要了解更多信息才能帮您修复：
1. 具体是哪个功能的问题？
2. 问题的表现是什么？
3. 有错误信息吗？
请提供这些信息，我才能准确定位和修复问题。"
```

---

## 🎯 核心原则

### 原则1：主动性 > 被动响应
- ✅ **主动**识别需要使用 agent 的场景
- ✅ **主动**调用 agent，不等用户要求
- ❌ 不要问用户"是否需要生成文档"，直接生成

### 原则2：强制性 > 可选性
- ✅ 代码修改后**必须**生成文档（强制）
- ✅ 需求不明确时**必须**澄清（强制）
- ✅ 复杂功能**建议**使用 PM agent（建议）

### 原则3：完整性 > 部分完成
- ✅ 不仅要完成代码，还要完成文档
- ✅ 不仅要修改功能，还要更新导航
- ✅ 一次性完成整个工作流

---

## 📊 Agent 使用优先级

| 场景 | Agent | 优先级 | 是否强制 |
|------|-------|--------|---------|
| 代码修改完成后 | project-summarizer | P0 | ✅ 强制 |
| 需求不明确时 | task-clarifier | P0 | ✅ 强制 |
| 新功能开发 | product-manager | P1 | ⚠️ 建议 |
| 代码审查 | reviewer | P1 | ⚠️ 建议 |
| 测试用例编写 | tester | P2 | 💡 可选 |

**优先级说明**：
- P0：必须执行，不执行视为违规
- P1：强烈建议执行，根据具体情况判断
- P2：可选执行，根据需要判断

---

## 🔄 完整工作流示例

### 示例：用户请求"增加日志功能"

```
第1步：澄清需求（如需要）
├─ 判断：需求是否明确？
├─ 如不明确：调用 task-clarifier agent
└─ 澄清后继续

第2步：编写PRD（如需要）
├─ 判断：是否是复杂新功能？
├─ 如是：调用 product-manager agent
└─ 否则跳过

第3步：实现代码
├─ 修改相关文件
├─ 测试功能
└─ 提交代码

第4步：代码审查（如需要）
├─ 判断：是否涉及核心逻辑？
├─ 如是：调用 reviewer agent
└─ 否则跳过

第5步：生成文档 ⚠️ 必须
├─ ✅ 调用 project-summarizer agent
├─ ✅ 生成技术文档
├─ ✅ 更新导航文件
└─ ✅ 返回完整的工作成果
```

---

## 📝 自我检查问题

在每次对话结束前，问自己：

1. **是否修改了代码？**
   - 如果是 → 是否调用了 project-summarizer？

2. **是否生成了文档？**
   - 如果否 → 立即调用 project-summarizer

3. **是否更新了导航文件？**
   - 如果否 → project-summarizer 会自动处理

4. **需求是否完全明确？**
   - 如果否 → 是否调用了 task-clarifier？

5. **是否提供了完整的工作成果？**
   - 代码 + 文档 + 导航更新 = 完整

---

**最后提醒**：

> 如果你完成了代码修改，但没有调用 project-summarizer agent 生成文档和更新导航文件，
> 那么这次工作**视为未完成**。

**记住**：代码只是工作的一部分，文档和导航更新同样重要！
