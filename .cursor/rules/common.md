# 通用规范

## ⚠️ 全局约束：先确认后开发（最高优先级）

**核心原则**: 在每次对话开始时，**必须先确认需求，再执行任何操作**。禁止在需求不明确时直接开始开发、生成文档或执行其他操作。

### 必须咨询确认的情况

- ❌ **需求不明确** - 不要猜测用户意图，必须先询问
- ❌ **技术方案不确定** - 不要假设实现方式，必须先询问
- ❌ **业务逻辑模糊** - 不要自行推断业务规则，必须先询问
- ❌ **数据格式不明确** - 不要假设数据格式，必须先询问
- ❌ **集成点不清楚** - 不要假设API接口，必须先询问
- ❌ **文档是否已存在** - 生成文档前必须先检查是否已存在相关文档

### 咨询确认流程（强制执行）

**步骤1：立即停止**
- 收到用户需求后，**立即停止**，不要开始任何操作
- 不要生成代码、文档、测试用例等

**步骤2：识别不确定点**
- 仔细分析用户需求
- 识别所有不确定的地方

**步骤3：列出问题列表**
- 使用清晰的结构列出需要确认的问题
- 使用分类（需求、技术、业务、数据、集成）
- 使用列表格式，便于用户回答
- 每个问题要具体明确

**步骤4：等待用户确认**
- **必须等待**用户回答所有问题
- 不要急于开始开发或生成文档
- 如果用户只回答了部分问题，继续询问未回答的问题

**步骤5：根据确认结果执行**
- 根据用户的确认结果进行开发
- 如果确认后仍有不确定的地方，继续询问
- 执行过程中发现新的不确定点，立即停止并询问

### 违反原则的处理

如果发现以下行为，**必须立即停止并重新确认**：
- ❌ 在需求不明确时直接开始编码
- ❌ 在需求不明确时直接生成PRD文档
- ❌ 假设用户意图或业务规则
- ❌ 跳过确认环节，直接提供代码或文档
- ❌ 使用"可能"、"应该"等不确定词汇后直接实现

---

## 🔒 安全规范

### 数据安全

- ✅ 敏感信息（API Key、Token）必须使用环境变量
- ✅ 数据库密码不能硬编码
- ✅ API 密钥不能提交到代码仓库

### 输入验证

- ✅ 所有用户输入必须验证
- ✅ 使用参数化查询防止 SQL 注入
- ✅ 验证文件上传类型和大小

### 权限控制

- ✅ API 路由必须验证权限
- ✅ 敏感操作必须记录日志

## 🚀 性能优化规范

### 数据库优化

- ✅ 使用索引优化查询性能
- ✅ 避免 N+1 查询问题
- ✅ 使用连接池管理数据库连接

### API 优化

- ✅ 使用缓存减少重复查询
- ✅ 分页查询大量数据
- ✅ 使用批量操作减少请求次数

### 前端优化

- ✅ 使用 Next.js 自动代码分割
- ✅ 图片使用 Next.js Image 组件
- ✅ 避免不必要的重新渲染

## 🐳 Docker 规范

### Dockerfile

- ✅ 使用多阶段构建减少镜像大小
- ✅ 使用 `.dockerignore` 排除不必要文件
- ✅ 使用非 root 用户运行容器

### 环境变量

- ✅ 所有配置通过环境变量传递
- ✅ 提供 `env.example` 文件
- ✅ 敏感信息使用 Docker secrets

## 📋 文档规范

### PRD 文档

- ✅ 使用标准 PRD 模板（参考 `docs/features/` 目录）
- ✅ 包含背景、目标、功能需求、验收标准
- ✅ 文档命名: `YYMMDD-功能名称-PRD.md`

### 技术文档

- ✅ 技术实现文档放在 `docs/technical/` 目录
- ✅ 包含架构设计、API 设计、实现细节

## 💼 交易系统特定规范

### 订单处理

- ✅ 订单提交前必须验证资金充足
- ✅ 订单状态变更必须同步到数据库
- ✅ 订单追踪必须处理超时和失败情况

### 策略执行

- ✅ 策略执行必须记录执行摘要
- ✅ 策略状态变更必须记录日志
- ✅ 策略错误必须立即通知（日志 + 错误处理）

### 资金管理

- ✅ 资金分配必须原子性操作
- ✅ 资金释放必须及时（订单完成或失败）
- ✅ 资金计算必须准确（考虑持仓、挂单）

