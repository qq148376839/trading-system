# 市场状态矩阵测试文档

## 测试目标

本测试套件用于验证市场状态矩阵对量化策略的正确影响，确保：

1. **市场状态矩阵计算正确性**
   - 验证4种市场状态的正确判定（Goldilocks、Volatile Bull、Fear、Stagnant）
   - 验证边界条件的处理

2. **一票否决权机制**
   - 验证VIX > 35时的强制风控
   - 验证市场温度 < 10时的强制观望

3. **环境分计算**
   - 验证市场温度和VIX对环境分的正确影响
   - 验证权重分配（基础强度40%、市场温度40%、VIX20%）

4. **市场环境评估**
   - 验证不同环境分对应的市场环境等级
   - 验证一票否决权对市场环境的强制调整

5. **止损止盈调整**
   - 验证高VIX时的止损止盈收紧机制

## 运行测试

```bash
# 运行所有测试
npm test

# 只运行市场状态矩阵测试
npm test -- market-regime-matrix.test.ts

# 运行测试并显示详细输出
npm test -- --verbose market-regime-matrix.test.ts

# 运行测试并监听文件变化
npm test -- --watch market-regime-matrix.test.ts
```

## 测试用例说明

### 1. 市场状态矩阵计算测试

#### 1.1 Goldilocks (黄金做多) 状态
- **条件**：温度 > 50 且 VIX < 20
- **预期**：市场状态为 "Goldilocks (黄金做多)"
- **策略影响**：应该产生积极的环境分，适合做多

#### 1.2 Volatile Bull (疯狂博弈) 状态
- **条件**：温度 > 50 且 VIX >= 20
- **预期**：市场状态为 "Volatile Bull (疯狂博弈)"
- **策略影响**：虽然温度高，但VIX也高，需要收紧止损

#### 1.3 Fear (恐慌下跌) 状态
- **条件**：温度 <= 50 且 VIX > 20
- **预期**：市场状态为 "Fear (恐慌下跌)"
- **策略影响**：应该产生消极的环境分，不适合做多

#### 1.4 Stagnant (阴跌/盘整) 状态
- **条件**：温度 <= 50 且 VIX <= 20
- **预期**：市场状态为 "Stagnant (阴跌/盘整)"
- **策略影响**：市场缺乏方向，环境分较低

### 2. 一票否决权测试

#### 2.1 VIX > 35 触发一票否决权
- **条件**：VIX > 35
- **预期**：设置 `veto_reason` 为 "VIX恐慌指数过高，强制风控"
- **策略影响**：强制将市场环境设为"较差"，阻止做多

#### 2.2 市场温度 < 10 触发一票否决权
- **条件**：市场温度 < 10
- **预期**：设置 `veto_reason` 为 "市场温度冰点，缺乏广度支持"
- **策略影响**：强制将市场环境设为"中性"，阻止做多

#### 2.3 正常市场条件不触发
- **条件**：VIX <= 35 且 市场温度 >= 10
- **预期**：`veto_reason` 为 `undefined`
- **策略影响**：正常执行策略逻辑

### 3. 环境分计算测试

#### 3.1 正常计算
- **输入**：基础强度50，温度70，VIX15
- **计算过程**：
  - 温度归一化：(70-50)*2 = 40
  - VIX归一化：(15-15)*2 = 0
  - 环境分：50*0.4 + 40*0.4 + 0*0.2 = 36
- **预期**：环境分为36

#### 3.2 高VIX降低环境分
- **输入**：基础强度50，温度60，VIX30
- **计算过程**：
  - 温度归一化：(60-50)*2 = 20
  - VIX归一化：(15-30)*5 = -75
  - 环境分：50*0.4 + 20*0.4 + (-75)*0.2 = 13
- **预期**：环境分降低到13

#### 3.3 低温度降低环境分
- **输入**：基础强度50，温度30，VIX15
- **计算过程**：
  - 温度归一化：(30-50)*2 = -40
  - VIX归一化：0
  - 环境分：50*0.4 + (-40)*0.4 + 0*0.2 = 4
- **预期**：环境分降低到4

### 4. 市场环境评估测试

#### 4.1 环境分 > 50 → "良好"
- **条件**：环境分 > 50
- **预期**：市场环境为"良好"
- **策略影响**：适合积极做多

#### 4.2 环境分 < -50 → "较差"
- **条件**：环境分 < -50
- **预期**：市场环境为"较差"
- **策略影响**：不适合做多

#### 4.3 一票否决权强制调整
- **条件**：VIX > 35
- **预期**：无论环境分如何，市场环境强制设为"较差"
- **策略影响**：阻止所有做多操作

### 5. 止损止盈调整测试

#### 5.1 VIX > 25 收紧止损止盈
- **条件**：VIX > 25
- **调整**：止损倍数 *= 0.8，止盈倍数 *= 0.8
- **示例**：止损从2.0变为1.6，止盈从3.0变为2.4
- **策略影响**：在高波动环境下保护利润，快速止盈

#### 5.2 正常VIX不调整
- **条件**：VIX <= 25
- **预期**：止损止盈倍数保持不变
- **策略影响**：使用正常的止损止盈策略

### 6. 完整策略影响测试

#### 6.1 Goldilocks状态产生积极影响
- **场景**：温度70，VIX12，基础强度60
- **预期**：
  - 市场状态：Goldilocks (黄金做多)
  - 环境分：> 20（中性利好）
  - 无一票否决权
  - 止损止盈正常

#### 6.2 Fear状态产生消极影响
- **场景**：温度40，VIX30，基础强度30
- **预期**：
  - 市场状态：Fear (恐慌下跌)
  - 环境分：< 0（中性或中性利空）
  - 可能触发一票否决权（如果VIX > 35）
  - 止损止盈收紧（VIX > 25）

### 7. 边界条件测试

#### 7.1 温度正好50
- **条件**：温度 = 50
- **预期**：归类为低温区域（<= 50），状态为Stagnant或Fear

#### 7.2 VIX正好20
- **条件**：VIX = 20
- **预期**：归类为高VIX区域（>= 20）

#### 7.3 VIX正好35
- **条件**：VIX = 35
- **预期**：不触发一票否决权（需要 > 35）

#### 7.4 温度正好10
- **条件**：温度 = 10
- **预期**：不触发一票否决权（需要 < 10）

## 测试结果解读

### 通过标准

所有测试用例都应该通过，表示：

1. ✅ 市场状态矩阵计算逻辑正确
2. ✅ 一票否决权机制正常工作
3. ✅ 环境分计算准确
4. ✅ 市场环境评估合理
5. ✅ 止损止盈调整生效
6. ✅ 边界条件处理正确

### 失败处理

如果测试失败，请检查：

1. **计算逻辑错误**：检查 `trading-recommendation.service.ts` 中的相关方法
2. **参数传递错误**：检查市场数据是否正确传递
3. **边界条件处理**：检查 `>` 和 `>=` 的使用是否正确
4. **权重分配**：检查环境分计算的权重是否正确

## 集成到CI/CD

建议将本测试集成到CI/CD流程中：

```yaml
# .github/workflows/test.yml
- name: Run Market Regime Matrix Tests
  run: npm test -- market-regime-matrix.test.ts
```

## 扩展测试

未来可以添加的测试：

1. **实际API集成测试**：使用真实的市场数据测试
2. **性能测试**：测试计算性能
3. **并发测试**：测试多线程环境下的正确性
4. **历史回测验证**：使用历史数据验证策略效果

## 相关文档

- [市场温度实现PRD](../docs/features/251218-MARKET_TEMPERATURE_IMPLEMENTATION_PRD.md)
- [交易推荐逻辑总结](../docs/technical/251212-交易推荐逻辑总结.md)

