# æœŸæƒç­–ç•¥ä¼˜åŒ–å®æ–½æ–‡æ¡£

**æ–‡æ¡£ç±»å‹**: åŠŸèƒ½å¼€å‘
**åˆ›å»ºæ—¥æœŸ**: 2026-02-03
**æœ€åæ›´æ–°**: 2026-02-08 (b)
**å®æ–½çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆ + ç®—æ³•è°ƒä¼˜è¿­ä»£ + å®ç›˜ä¼˜åŒ–
**ä¼˜å…ˆçº§**: P0ï¼ˆç´§æ€¥ï¼‰

---

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜èƒŒæ™¯](#é—®é¢˜èƒŒæ™¯)
2. [æ ¸å¿ƒé—®é¢˜è¯Šæ–­](#æ ¸å¿ƒé—®é¢˜è¯Šæ–­)
3. [å®æ–½çš„ä¿®æ”¹](#å®æ–½çš„ä¿®æ”¹)
4. [æ–‡ä»¶å˜æ›´æ¸…å•](#æ–‡ä»¶å˜æ›´æ¸…å•)
5. [é¢„æœŸæ•ˆæœ](#é¢„æœŸæ•ˆæœ)
6. [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
7. [ç›‘æ§æŒ‡æ ‡](#ç›‘æ§æŒ‡æ ‡)
8. [åç»­ä¼˜åŒ–](#åç»­ä¼˜åŒ–)

---

## é—®é¢˜èƒŒæ™¯

### å½“å‰çŠ¶å†µ
- **ç­–ç•¥ID**: 10 (æœŸæƒæ—¥å†…ç­–ç•¥)
- **æ‰§è¡Œæ¬¡æ•°**: 390æ¬¡
- **å®é™…æŒä»“**: 0
- **é”™è¯¯æ¬¡æ•°**: 39æ¬¡
- **é”™è¯¯ç‡**: 10%

### æ—¥å¿—åˆ†æå‘ç°
1. **å¸‚åœºæ•°æ®ä¸è¶³** (18æ¬¡): BTC/SPX/USD Index æ•°æ®ä¸è¶³ï¼ˆ0 < 50æ¡ï¼‰
2. **å¯Œé€”æœŸæƒAPIå¤±è´¥** (18æ¬¡â†’2æ¬¡): `getOptionDetail` è°ƒç”¨å¤±è´¥
3. **æ¨èä¿¡å·é—®é¢˜**: ä½¿ç”¨è‚¡ç¥¨äº¤æ˜“é€»è¾‘ï¼Œä¸é€‚åˆ0DTEæœŸæƒ

---

## æ ¸å¿ƒé—®é¢˜è¯Šæ–­

### é—®é¢˜1: æ¨èé€»è¾‘ä¸é€‚åˆæœŸæƒ ğŸ”¥ **æ ¹æœ¬åŸå› **

**ç°çŠ¶**:
```typescript
// option-intraday-strategy.ts (ä¿®æ”¹å‰)
const rec = await tradingRecommendationService.calculateRecommendation(symbol);
if (rec.action === 'HOLD') return null;  // è‚¡ç¥¨é€»è¾‘ï¼šéœ€è¦æ˜ç¡®ä¸Šå‡è¶‹åŠ¿

direction = rec.action === 'BUY' ? 'CALL' : 'PUT';
```

**é—®é¢˜åˆ†æ**:
- è‚¡ç¥¨æ¨èéœ€è¦**åŒæ—¶æ»¡è¶³**ï¼šå¸‚åœºç¯å¢ƒè‰¯å¥½ AND è‚¡ç¥¨ä¸Šå‡è¶‹åŠ¿
- QQQ ä½œä¸º Nasdaq ETFï¼Œæ³¢åŠ¨é¢‘ç¹ï¼Œä½†ä¸æ€»æ˜¯"ä¸Šå‡è¶‹åŠ¿"
- 0DTEæœŸæƒéœ€è¦**æ—¥å†…æ–¹å‘é¢„æµ‹**ï¼Œè€Œä¸æ˜¯æ—¥Kçº¿è¶‹åŠ¿
- ç¼ºå°‘**å¤§ç›˜èµ°å‘+åˆ†æ—¶é¢„æµ‹**çš„ç»„åˆé€»è¾‘

**å½±å“**: å¯¼è‡´æ¨èå§‹ç»ˆè¿”å› HOLDï¼Œæ— æ³•ç”Ÿæˆäº¤æ˜“ä¿¡å·

### é—®é¢˜2: å¸‚åœºæ•°æ®è·å–ä¸ç¨³å®š

**ç°çŠ¶**: APIè¶…æ—¶æ— é‡è¯•ï¼Œç›´æ¥å¤±è´¥

**å½±å“**: 18æ¬¡æ•°æ®è·å–å¤±è´¥ï¼Œé˜»æ­¢æ‰€æœ‰äº¤æ˜“å†³ç­–

### é—®é¢˜3: æœŸæƒAPIä¸ç¨³å®š

**ç°çŠ¶**: `getOptionDetail` æ— é‡è¯•æœºåˆ¶

**å½±å“**: 18æ¬¡APIè°ƒç”¨å¤±è´¥ï¼Œæ— æ³•è·å–æœŸæƒæŠ¥ä»·

---

## å®æ–½çš„ä¿®æ”¹

### âœ… ä¿®æ”¹1: åˆ›å»ºæœŸæƒä¸“ç”¨æ¨èæœåŠ¡

**æ–‡ä»¶**: `api/src/services/option-recommendation.service.ts` (æ–°å»º)

**æ ¸å¿ƒé€»è¾‘**:
```typescript
/**
 * æœŸæƒæ¨èç®—æ³• (0DTEæ—¥å†…äº¤æ˜“ä¸“ç”¨)
 *
 * å†³ç­–å› å­ï¼š
 * - å¤§ç›˜ç¯å¢ƒè¯„åˆ† (40%): SPXè¶‹åŠ¿ + å¸‚åœºæ¸©åº¦ + VIX + USD + BTC
 * - åˆ†æ—¶åŠ¨é‡è¯„åˆ† (40%): BTC/USDå°æ—¶K + çŸ­æœŸåŠ¨é‡
 * - æ—¶é—´çª—å£è°ƒæ•´ (20%): å¼€ç›˜åˆæœŸ+20åˆ†ï¼Œæ”¶ç›˜å‰-50åˆ†
 *
 * è¾“å‡º:
 * - direction: CALL | PUT | HOLD
 * - confidence: 0-100
 * - reasoning: å†³ç­–ç†ç”±
 * - riskLevel: LOW | MEDIUM | HIGH | EXTREME
 */

// å…³é”®æ”¹è¿›ï¼šé™ä½å…¥åœºé—¨æ§›
if (finalScore > 15) {  // ä»30é™è‡³15ï¼Œå¢åŠ äº¤æ˜“é¢‘ç‡
  direction = 'CALL';
  confidence = Math.min(Math.round((finalScore / 100) * 100), 100);
} else if (finalScore < -15) {
  direction = 'PUT';
  confidence = Math.min(Math.round((Math.abs(finalScore) / 100) * 100), 100);
} else {
  direction = 'HOLD';
}
```

**å…³é”®ç‰¹æ€§**:
1. ä¸ä¾èµ–åº•å±‚è‚¡ç¥¨æ—¥Kçº¿è¶‹åŠ¿
2. ä½¿ç”¨åˆ†æ—¶æ•°æ®æ•æ‰æ—¥å†…åŠ¨é‡
3. æ—¶é—´çª—å£è°ƒæ•´ï¼ˆå¼€ç›˜vsæ”¶ç›˜ï¼‰
4. VIXææ…ŒæŒ‡æ•°ä¸€ç¥¨å¦å†³ï¼ˆ>35ç¦æ­¢äº¤æ˜“ï¼‰
5. å¸‚åœºæ¸©åº¦åŠ¨æ€è°ƒæ•´

---

### âœ… ä¿®æ”¹2: å¸‚åœºæ•°æ®è·å–é‡è¯•æœºåˆ¶

**æ–‡ä»¶**: `api/src/services/market-data.service.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
import { retryWithBackoff } from '../utils/longport-rate-limiter';

// å…³é”®å¸‚åœºæŒ‡æ ‡ï¼šä½¿ç”¨é‡è¯•æœºåˆ¶ï¼ˆ3æ¬¡ï¼Œé—´éš”500msï¼‰
const criticalPromises = [
  retryWithBackoff(
    () => this.getSPXCandlesticks(count),
    { maxRetries: 3, initialDelayMs: 500 }  // 500ms â†’ 1000ms â†’ 2000ms
  ).catch(err => {
    console.error(`è·å–SPXæ•°æ®å¤±è´¥ï¼ˆå·²é‡è¯•3æ¬¡ï¼‰:`, err.message);
    throw new Error(`SPXæ•°æ®è·å–å¤±è´¥: ${err.message}`);
  }),
  // USD Index å’Œ BTC ç±»ä¼¼
];
```

**é¢„æœŸæ•ˆæœ**: æ•°æ®è·å–å¤±è´¥ä»18æ¬¡é™è‡³<1æ¬¡

---

### âœ… ä¿®æ”¹3: option-intraday-strategyä½¿ç”¨æ–°æ¨è

**æ–‡ä»¶**: `api/src/services/strategies/option-intraday-strategy.ts`

**æ ¸å¿ƒå˜æ›´**:
```typescript
import optionRecommendationService from '../option-recommendation.service';

async generateSignal(symbol: string): Promise<TradingIntent | null> {
  // æ—§ï¼šä½¿ç”¨è‚¡ç¥¨æ¨è
  // const rec = await tradingRecommendationService.calculateRecommendation(symbol);

  // æ–°ï¼šä½¿ç”¨æœŸæƒä¸“ç”¨æ¨è
  const optionRec = await optionRecommendationService.calculateOptionRecommendation(symbol);

  console.log(`ğŸ“Š [æœŸæƒæ¨è] ${symbol}:`, {
    direction: optionRec.direction,        // CALL/PUT/HOLD
    confidence: optionRec.confidence,      // 0-100
    marketScore: optionRec.marketScore,    // å¤§ç›˜å¾—åˆ†
    intradayScore: optionRec.intradayScore,// åˆ†æ—¶å¾—åˆ†
    finalScore: optionRec.finalScore,      // ç»¼åˆå¾—åˆ†
    riskLevel: optionRec.riskLevel,        // é£é™©ç­‰çº§
    reasoning: optionRec.reasoning          // å†³ç­–ç†ç”±
  });

  // å¦‚æœæ¨èHOLDæˆ–é£é™©è¿‡é«˜ï¼Œè·³è¿‡
  if (optionRec.direction === 'HOLD') return null;
  if (optionRec.riskLevel === 'EXTREME') {
    console.warn(`âš ï¸ é£é™©ç­‰çº§è¿‡é«˜(EXTREME)ï¼Œè·³è¿‡äº¤æ˜“`);
    return null;
  }

  // å†³ç­–ï¼šCALL/PUTç›´æ¥æ¥è‡ªæœŸæƒæ¨è
  direction = optionRec.direction as 'CALL' | 'PUT';

  // ç»§ç»­é€‰æ‹©æœŸæƒåˆçº¦...
}
```

**å…³é”®æ”¹è¿›**:
1. æ›¿æ¢æ¨èæœåŠ¡ä¸ºæœŸæƒä¸“ç”¨ç®—æ³•
2. æ·»åŠ è¯¦ç»†æ—¥å¿—è¾“å‡ºï¼ˆä¾¿äºè°ƒè¯•ï¼‰
3. é£é™©ç­‰çº§æ£€æŸ¥ï¼ˆEXTREMEçº§åˆ«è·³è¿‡ï¼‰
4. ç›´æ¥ä½¿ç”¨ CALL/PUT æ–¹å‘ï¼ˆä¸ç»è¿‡è‚¡ç¥¨ä¿¡å·è½¬æ¢ï¼‰

---

## æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å»ºæ–‡ä»¶
1. âœ… `api/src/services/option-recommendation.service.ts` (588è¡Œ)
2. âœ… `docs/features/260203-æœŸæƒç­–ç•¥ä¼˜åŒ–å®æ–½æ–‡æ¡£.md` (æœ¬æ–‡æ¡£)

### ä¿®æ”¹æ–‡ä»¶
1. âœ… `api/src/services/market-data.service.ts`
   - ç¬¬6è¡Œ: æ·»åŠ  `import { retryWithBackoff }`
   - ç¬¬857-879è¡Œ: æ·»åŠ é‡è¯•æœºåˆ¶åˆ°å…³é”®æ•°æ®è·å–

2. âœ… `api/src/services/strategies/option-intraday-strategy.ts`
   - ç¬¬14è¡Œ: æ·»åŠ  `import optionRecommendationService`
   - ç¬¬58-94è¡Œ: æ›¿æ¢æ¨èé€»è¾‘ï¼Œä½¿ç”¨æ–°æœåŠ¡
   - ç¬¬153è¡Œ: ä¿®æ”¹ reason å­—æ®µå†…å®¹

---

## é¢„æœŸæ•ˆæœ

### ä¿®æ”¹å‰ (å®é™…æ•°æ®)
| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|-----|------|
| æ‰§è¡Œæ¬¡æ•° | 390æ¬¡ | ç­–ç•¥è°ƒåº¦æ‰§è¡Œ |
| ç”Ÿæˆä¿¡å· | 0æ¬¡ | å…¨æ˜¯HOLD |
| å®é™…æŒä»“ | 0 | æ— äº¤æ˜“ |
| é”™è¯¯æ¬¡æ•° | 39æ¬¡ | 10%å¤±è´¥ç‡ |
| æ•°æ®è·å–å¤±è´¥ | 18æ¬¡ | SPX/USD/BTC |
| APIè°ƒç”¨å¤±è´¥ | 18æ¬¡ | æœŸæƒè¯¦æƒ… |

### ä¿®æ”¹åé¢„æœŸ
| æŒ‡æ ‡ | é¢„æœŸå€¼ | æ”¹å–„å¹…åº¦ |
|------|-------|---------|
| ä¿¡å·ç”Ÿæˆç‡ | 20-40% | +âˆ (ä»0%) |
| åˆçº¦é€‰æ‹©æˆåŠŸç‡ | 80%+ | æ–°åŠŸèƒ½ |
| æ•°æ®è·å–å¤±è´¥ | <1æ¬¡ | -94% |
| APIè°ƒç”¨å¤±è´¥ | <2æ¬¡ | -89% |
| å®é™…æˆäº¤ | 1-5ç¬”/å¤© | æ–°åŠŸèƒ½ |

---

## éƒ¨ç½²æ­¥éª¤

### 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
```bash
cd D:\Python\trading-system
git add .
git commit -m "feat: æœŸæƒç­–ç•¥æ ¸å¿ƒä¼˜åŒ– - æ–°æ¨èæœåŠ¡+é‡è¯•æœºåˆ¶"
```

### 2. ç¼–è¯‘æ£€æŸ¥ (å·²å®Œæˆ âœ…)
```bash
cd api
npx tsc --noEmit
# ç»“æœ: ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯
```

### 3. å¯åŠ¨æœåŠ¡
```bash
npm run dev
```

### 4. è§‚å¯Ÿæ—¥å¿—

**æœŸæœ›çœ‹åˆ°çš„å…³é”®è¾“å‡º**:
```
ğŸ“Š [æœŸæƒæ¨è] QQQ.US: {
  direction: 'CALL',      â† åº”è¯¥æ˜¯CALL/PUTï¼Œä¸æ˜¯HOLD
  confidence: 65,         â† åº”è¯¥>40
  marketScore: 28.5,      â† å¤§ç›˜ç¯å¢ƒå¾—åˆ†
  intradayScore: 15.2,    â† åˆ†æ—¶åŠ¨é‡å¾—åˆ†
  finalScore: 32.5,       â† ç»¼åˆå¾—åˆ†ï¼Œåº”è¯¥>15æˆ–<-15
  riskLevel: 'MEDIUM',    â† ä¸åº”è¯¥æ˜¯EXTREME
  reasoning: 'å¤§ç›˜ç¯å¢ƒåå¤š(28.5åˆ†)ï¼›åˆ†æ—¶åŠ¨é‡åå¤š(15.2åˆ†)ï¼›...'
}
```

---

## ç›‘æ§æŒ‡æ ‡

### å…³é”®æˆåŠŸæŒ‡æ ‡ (KSI)

#### 1. æœŸæƒæ¨èç”Ÿæˆç‡ ğŸ¯
- **å®šä¹‰**: ç”ŸæˆCALL/PUTæ¨èçš„æ¯”ä¾‹
- **ç›®æ ‡**: >20%
- **å½“å‰**: ~0%
- **æ£€æŸ¥æ–¹æ³•**: æ—¥å¿—ä¸­æœç´¢ `direction: 'CALL'` æˆ– `direction: 'PUT'`

#### 2. å¸‚åœºæ•°æ®è·å–æˆåŠŸç‡
- **å®šä¹‰**: SPX/USD/BTCæ•°æ®è·å–æˆåŠŸç‡
- **ç›®æ ‡**: >99%
- **å½“å‰**: ~95%
- **æ£€æŸ¥æ–¹æ³•**: æ—¥å¿—ä¸­æœç´¢ `å·²é‡è¯•3æ¬¡` çš„é”™è¯¯

#### 3. åˆçº¦é€‰æ‹©æˆåŠŸç‡
- **å®šä¹‰**: æ‰¾åˆ°åˆé€‚æœŸæƒåˆçº¦çš„æ¯”ä¾‹
- **ç›®æ ‡**: >80%
- **å½“å‰**: æœªçŸ¥
- **æ£€æŸ¥æ–¹æ³•**: æ—¥å¿—ä¸­æœç´¢ `æœªæ‰¾åˆ°åˆé€‚çš„æœŸæƒåˆçº¦`

#### 4. äº¤æ˜“æ‰§è¡ŒæˆåŠŸç‡
- **å®šä¹‰**: ç”Ÿæˆäº¤æ˜“æ„å›¾åæˆåŠŸæäº¤è®¢å•çš„æ¯”ä¾‹
- **ç›®æ ‡**: >90%
- **å½“å‰**: 0%
- **æ£€æŸ¥æ–¹æ³•**: æ•°æ®åº“ `execution_orders` è¡¨

### å®æ—¶ç›‘æ§å‘½ä»¤

```bash
# æŸ¥çœ‹æœŸæƒæ¨èæ—¥å¿—
tail -f logs-$(date +%Y-%m-%d).json | grep "æœŸæƒæ¨è"

# æŸ¥çœ‹æ•°æ®è·å–é‡è¯•æ—¥å¿—
tail -f logs-$(date +%Y-%m-%d).json | grep "å·²é‡è¯•3æ¬¡"

# æŸ¥çœ‹åˆçº¦é€‰æ‹©å¤±è´¥æ—¥å¿—
tail -f logs-$(date +%Y-%m-%d).json | grep "æœªæ‰¾åˆ°åˆé€‚çš„æœŸæƒåˆçº¦"

# ç»Ÿè®¡ä»Šæ—¥äº¤æ˜“æ•°
echo "SELECT COUNT(*) FROM execution_orders WHERE DATE(created_at) = CURRENT_DATE;" | psql
```

---

## åç»­ä¼˜åŒ– (å¯é€‰ï¼Œéä»Šæ™šå¿…éœ€)

### ä¼˜å…ˆçº§ P1: æµåŠ¨æ€§è¿‡æ»¤æ”¾å®½
**æ–‡ä»¶**: `api/src/services/strategies/option-intraday-strategy.ts`

```typescript
// å½“å‰é…ç½®ï¼ˆå¯èƒ½è¿‡ä¸¥ï¼‰
liquidityFilters: {
  minOpenInterest: 100,
  maxBidAskSpreadPct: 20
}

// å»ºè®®é…ç½®ï¼ˆæ”¾å®½ï¼‰
liquidityFilters: {
  minOpenInterest: 50,    // QQQæµåŠ¨æ€§å¾ˆå¥½
  maxBidAskSpreadPct: 30, // 0DTEæœŸæƒspreadè¾ƒå¤§
  minVolume: 10           // æ–°å¢
}

greekFilters: {
  deltaMin: 0.25,  // ä»0.3æ”¾å®½
  deltaMax: 0.75   // ä»0.7æ”¾å®½
}
```

### ä¼˜å…ˆçº§ P1: æœŸæƒAPIé‡è¯•+ç¼“å­˜
**æ–‡ä»¶**: `api/src/services/options-contract-selector.service.ts`

```typescript
// æ·»åŠ 30ç§’ç¼“å­˜
private optionPriceCache = new Map<string, {
  detail: any,
  timestamp: number
}>();

// è·å–æœŸæƒè¯¦æƒ…ï¼ˆå¸¦ç¼“å­˜+é‡è¯•ï¼‰
async getOptionDetailWithCache(optionId: string, stockId: string) {
  const cacheKey = `${optionId}_${stockId}`;
  const cached = this.optionPriceCache.get(cacheKey);

  if (cached && Date.now() - cached.timestamp < 30000) {
    return cached.detail;
  }

  const detail = await retryWithBackoff(
    () => getOptionDetail(optionId, stockId),
    { maxRetries: 3, initialDelayMs: 500 }
  );

  this.optionPriceCache.set(cacheKey, {
    detail,
    timestamp: Date.now()
  });

  return detail;
}
```

### ä¼˜å…ˆçº§ P2: è¯Šæ–­æ—¥å¿—å¢å¼º
**ä½ç½®**: åˆçº¦é€‰æ‹©å¤±è´¥æ—¶

```typescript
if (!selectedContract) {
  console.warn('âŒ æœŸæƒåˆçº¦é€‰æ‹©å¤±è´¥', {
    symbol: underlyingSymbol,
    totalContracts: chain.length,
    afterExpiryFilter: afterExpiry.length,
    afterLiquidityFilter: afterLiquidity.length,
    afterGreekFilter: afterGreek.length,
    filters: config.liquidityFilters,
    sampleContracts: chain.slice(0, 3)
  });
}
```

### ä¼˜å…ˆçº§ P2: æ•°æ®é¢„çƒ­
**æ–‡ä»¶**: `api/src/services/strategy-scheduler.service.ts`

```typescript
async onApplicationBootstrap() {
  try {
    console.log('é¢„çƒ­å¸‚åœºæ•°æ®...');
    await marketDataCacheService.getMarketData(100, true);
    console.log('âœ… å¸‚åœºæ•°æ®é¢„çƒ­å®Œæˆ');
  } catch (error: any) {
    console.error('âŒ å¸‚åœºæ•°æ®é¢„çƒ­å¤±è´¥:', error.message);
  }
}
```

---

## 2026-02-08 è¿­ä»£æ›´æ–°

### å˜æ›´1: æ¨èç®—æ³•æƒé‡é‡æ„
**æ–‡ä»¶**: `api/src/services/option-recommendation.service.ts`

| å˜æ›´é¡¹ | æ—§å€¼ | æ–°å€¼ | åŸå›  |
|--------|------|------|------|
| ç»¼åˆå¾—åˆ†æƒé‡ | å¤§ç›˜40% + åˆ†æ—¶40% + æ—¶é—´çª—å£20% | å¤§ç›˜50% + åˆ†æ—¶50% + æ—¶é—´çª—å£Ã—0.15ä¿®æ­£ | æ—¶é—´çª—å£Â±50å¤ªå¤§ä¼šä¸»å¯¼ç»“æœ |
| æ–°å¢SPXå½“æ—¥æ¶¨è·Œå¹… | æ—  | æƒé‡35%ï¼ˆå¤§ç›˜è¯„åˆ†æœ€å¤§æƒé‡ï¼‰ | å½“æ—¥çœŸå®èµ°åŠ¿æ˜¯æœ€ç›´æ¥çš„ä¿¡å· |
| SPXå¤šæ—¥è¶‹åŠ¿ | 40% | 15% | é™æƒï¼Œä¸­æœŸè¶‹åŠ¿ä½œå‚è€ƒ |
| å‡çº¿åˆ†æ | MA10/MA20 + æ”¾å¤§10å€ | MA5/MA10/MA20 + æ”¾å¤§30å€ + å¤šç©ºæ’åˆ—Â±25 | æ›´æ•æ„Ÿï¼ŒåŒºåˆ†å®Œç¾æ’åˆ— |
| åˆ†æ—¶SPXæ—¥å†…ä¿¡å· | ä½¿ç”¨æœ€è¿‘5æ—¥Kçº¿åŠ¨é‡ | ä½¿ç”¨å½“æ—¥Kçº¿å®ä½“å¼ºåº¦Ã—æŒ¯å¹… | æ•æ‰æ—¥å†…çœŸå®æ–¹å‘ |
| åŠ¨é‡è®¡ç®— | é€barå¹³å‡å˜åŒ–ç‡Ã—1000 | é¦–å°¾ç´¯è®¡å˜åŒ–ç‡Ã—3000Ã—æ–¹å‘ä¸€è‡´æ€§ | é¿å…æ­£è´ŸæŠµæ¶ˆ |

### å˜æ›´2: æœŸæƒè®¢å•å…¨é¢ä½¿ç”¨å¸‚ä»·å•
**æ–‡ä»¶**: `api/src/services/basic-execution.service.ts`

- **æ—§é€»è¾‘**: ä»…æœŸæƒå¼ºåˆ¶å¹³ä»“ï¼ˆ`forceClose=true`ï¼‰ä½¿ç”¨å¸‚ä»·å•
- **æ–°é€»è¾‘**: æ‰€æœ‰æœŸæƒè®¢å•ï¼ˆä¹°å…¥+å–å‡ºï¼‰éƒ½ä½¿ç”¨å¸‚ä»·å•ï¼Œå®ç°å¿«è¿›å¿«å‡º
- **Fallbackç­–ç•¥åŒºåˆ†ä¹°å–æ–¹å‘**:
  - ä¹°å…¥: é™ä»·å•ä½¿ç”¨ `å½“å‰ä»· Ã— 1.05`ï¼ˆå‘ä¸Šå–æ•´åˆ°åˆ†ï¼‰
  - å–å‡º: é™ä»·å•ä½¿ç”¨ `å½“å‰ä»· Ã— 0.1`ï¼ˆæœ€ä½$0.01ï¼‰

### å˜æ›´3: èµ„é‡‘ç®¡ç†æ”¯æŒæœŸæƒåˆçº¦
**æ–‡ä»¶**: `api/src/services/capital-manager.service.ts`

- **é—®é¢˜**: æœŸæƒåˆçº¦symbolï¼ˆå¦‚`QQQ260208C520000.US`ï¼‰ä¸auto_tradesä¸­çš„underlying symbolä¸åŒ¹é…ï¼Œå¯¼è‡´æŒä»“æŸ¥è¯¢è¿”å›0
- **ä¿®å¤**: é€šè¿‡ `isLikelyOptionSymbol()` åˆ¤æ–­ï¼ŒæœŸæƒèµ° `strategy_instances` è¡¨æŸ¥è¯¢ï¼Œè‚¡ç¥¨èµ° `auto_trades` è¡¨ï¼ˆåŸé€»è¾‘ï¼‰
- **æ–°å¢ä¾èµ–**: `options-symbol.ts` çš„ `isLikelyOptionSymbol` å’Œ `getOptionPrefixesForUnderlying`

### å˜æ›´4: æœŸæƒå…¥åœºå†³ç­–ä½¿ç”¨ç»¼åˆå¾—åˆ†
**æ–‡ä»¶**: `api/src/services/strategies/option-intraday-strategy.ts`

- ä»·å·®ç­–ç•¥ï¼ˆBULL/BEAR_SPREADï¼‰ä»ä½¿ç”¨ `marketScore`ï¼ˆå¤§ç›˜å¾—åˆ†ï¼‰æ”¹ä¸º `finalScore`ï¼ˆç»¼åˆå¾—åˆ†ï¼‰
- æ¿€è¿›æ¨¡å¼é˜ˆå€¼ä» 15/20 é™è‡³ 10/10
- æ—¥å¿—ä¸­"å¤§ç›˜å¾—åˆ†"æ”¹ä¸º"ç»¼åˆå¾—åˆ†"

### å˜æ›´5: æœŸæƒå–å‡ºæ•°é‡ä»¥åˆ¸å•†ä¸ºå‡†
**æ–‡ä»¶**: `api/src/services/strategy-scheduler.service.ts`

- **é—®é¢˜**: DBè®°å½•çš„æ•°é‡å¯èƒ½ä¸åˆ¸å•†å®é™…æŒä»“ä¸ä¸€è‡´
- **ä¿®å¤**: å½“ `DBæ•°é‡ > å®é™…æŒä»“` æ—¶ï¼Œä»¥å®é™…æŒä»“ä¸ºå‡†å¹¶æ‰“å° WARN æ—¥å¿—
- å½“å¯ç”¨æŒä»“ä¸º0æ—¶ç›´æ¥è¿”å›ï¼ˆä¸å°è¯•å–å‡ºï¼‰

### å˜æ›´6: æœŸæƒå ç”¨æ§½ä½è®¡ç®—æ‰©å±•
**æ–‡ä»¶**: `api/src/services/strategy-scheduler.service.ts`

- **æ—§é€»è¾‘**: ä»… `HOLDING` çŠ¶æ€ç®—å·²å ç”¨
- **æ–°é€»è¾‘**: `HOLDING` + `OPENING` + `CLOSING` éƒ½ç®—å·²å ç”¨ï¼Œé˜²æ­¢é‡å¤ä¹°å…¥

### å˜æ›´7: è¿ç§»è„šæœ¬åˆå¹¶
**æ–‡ä»¶**: `api/migrations/000_init_schema.sql`

- å°† 010~013 åŠ `create_order_prevention_metrics_table.sql` åˆå¹¶å…¥ `000_init_schema.sql`
- åˆ é™¤ç‹¬ç«‹è¿ç§»æ–‡ä»¶ï¼Œç®€åŒ–éƒ¨ç½²

### å˜æ›´8: log-worker é‡å¤å¯¼å…¥ä¿®å¤
**æ–‡ä»¶**: `api/src/services/log-worker.service.ts`

- ç§»é™¤é‡å¤çš„ `infraLogger` import

---

## 2026-02-08 (b) å®ç›˜æ•°æ®é©±åŠ¨ä¼˜åŒ–

**æ•°æ®æ¥æº**: 2026-02-06 å®ç›˜è¿è¡Œæ•°æ®
- éƒ¨ç½²åå‡€ç›ˆäº +$48ï¼ˆå‡ ä¹æŒå¹³ï¼‰
- 9 ç¬”è¶…çŸ­æŒä»“ï¼ˆ<3minï¼‰äºæŸ -$200
- 36 ç¬”æ— æ•ˆå–æ¶ˆè®¢å•ï¼ˆæ”¶ç›˜å‰æ—¶é—´ä¸è¶³ï¼‰

### å˜æ›´9: åŠ¨æ€æ­¢æŸå†·é™æœŸ
**æ–‡ä»¶**: `api/src/services/option-dynamic-exit.service.ts`

**é—®é¢˜**: åˆšå¼€ä»“ 1-2 åˆ†é’Ÿå†…æœŸæƒ premium æ³¢åŠ¨å¤§ï¼Œå¸¸è§„æ­¢æŸçº¿è¢«é¢‘ç¹è§¦å‘å¯¼è‡´è¶…çŸ­æŒä»“äºæŸã€‚

**æ–¹æ¡ˆ**: `checkExitCondition()` ä¸­æ­¢æŸæ£€æŸ¥æ”¹ä¸ºæŒä»“æ—¶é—´æ„ŸçŸ¥çš„ä¸‰é˜¶æ®µé€»è¾‘ï¼š

| æŒä»“æ—¶é—´ | æ­¢æŸè¡Œä¸º | åŸå›  |
|----------|----------|------|
| 0-3 åˆ†é’Ÿ | è·³è¿‡å¸¸è§„æ­¢æŸï¼Œä»…å®‰å…¨é˜€(50%)ç”Ÿæ•ˆ | å¼€ä»“åˆæœŸæ³¢åŠ¨å¤§ï¼Œé¿å…è¢«å™ªéŸ³æ­¢æŸ |
| 3-10 åˆ†é’Ÿ | æ­¢æŸçº¿æ”¾å®½ 1.5 å€ | å†·é™æœŸè¿‡æ¸¡ï¼Œç»™æŒä»“è¶³å¤Ÿå‘å±•ç©ºé—´ |
| 10+ åˆ†é’Ÿ | æ ‡å‡†æ­¢æŸï¼ˆåŸé€»è¾‘ï¼‰ | æŒä»“å……åˆ†å‘å±•åå›åˆ°æ­£å¸¸é£æ§ |

**å®‰å…¨æ€§**:
- `ctx.entryTime` ç¼ºå¤±æ—¶ fallback ä¸º `now` â†’ holdingMinutesâ‰ˆ0 â†’ æœ€ä¿å®ˆæ¨¡å¼
- å®‰å…¨é˜€ï¼ˆ50%ç»å¯¹æ­¢æŸï¼‰å…¨æ—¶æ®µä¸å˜ï¼Œèµ„é‡‘å®‰å…¨æœ‰ä¿éšœ
- æ—¥å¿—å…³é”®è¯: `å†·é™æœŸ1.5x`

### å˜æ›´10: æ—¶é—´çª—å£æ”¶ç´§
**æ–‡ä»¶**: `api/src/services/strategies/option-intraday-strategy.ts`

| å‚æ•° | æ—§å€¼ | æ–°å€¼ | æ•ˆæœ |
|------|------|------|------|
| `noNewEntryBeforeCloseMinutes` | 60 | 120 | 14:00 ET åä¸å¼€æ–°ä»“ï¼ˆåŸ 15:00 ETï¼‰ |

- ç›´æ¥æ¶ˆé™¤å…¨éƒ¨ 36 ç¬”å› æ—¶é—´ä¸è¶³å¯¼è‡´çš„æ— æ•ˆå–æ¶ˆè®¢å•
- æ•°æ®åº“ä¸­å·²é…ç½®è‡ªå®šä¹‰å€¼çš„ç­–ç•¥ä¸å—å½±å“ï¼ˆä»…æ”¹é»˜è®¤å€¼ï¼‰

### å˜æ›´11: å–æ¶ˆè®¢å•é€€é¿
**æ–‡ä»¶**: `api/src/services/strategy-scheduler.service.ts`

**é—®é¢˜**: è®¢å•è¢«å–æ¶ˆåï¼Œä¸‹ä¸€è½®è°ƒåº¦ç«‹å³é‡è¯•åŒä¸€æ ‡çš„ï¼Œäº§ç”Ÿé‡å¤æ— æ•ˆè®¢å•ã€‚

**æ–¹æ¡ˆ**:
1. **å­˜å‚¨é€€é¿å…ƒæ•°æ®**: `handleOrderCancelled()` å’Œ `handleOrderRejected()` åœ¨ `updateState(symbol, 'IDLE', context)` ä¸­å†™å…¥ `{ lastCancelTime, cancelCount }`
2. **IDLE è·¯å¾„é€€é¿æ£€æŸ¥**: `processSymbol()` åœ¨ noNewEntry æ£€æŸ¥åã€hasPosition æ£€æŸ¥å‰ï¼ŒæŒ‰æŒ‡æ•°é€€é¿è·³è¿‡ï¼š

| cancelCount | é€€é¿æ—¶é—´ | å…¬å¼ |
|-------------|----------|------|
| 1 | 5 åˆ†é’Ÿ | `5 * 2^0` |
| 2 | 10 åˆ†é’Ÿ | `5 * 2^1` |
| 3 | 20 åˆ†é’Ÿ | `5 * 2^2` |
| â‰¥4 | 30 åˆ†é’Ÿï¼ˆä¸Šé™ï¼‰ | `min(30, 5 * 2^(n-1))` |

**è‡ªç„¶æ¸…ç†**: ä¸‹æ¬¡æˆåŠŸå¼€ä»“æ—¶ `updateState(symbol, 'OPENING', holdingContext)` è¦†ç›–æ•´ä¸ª contextï¼Œé€€é¿å…ƒæ•°æ®è‡ªåŠ¨æ¶ˆå¤±ã€‚

**æ—¥å¿—å…³é”®è¯**: `CANCEL_BACKOFF`

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: ä»ç„¶å…¨æ˜¯HOLD

**æ£€æŸ¥æ­¥éª¤**:
1. æŸ¥çœ‹æ—¥å¿—ä¸­çš„ `marketScore` å’Œ `intradayScore`
2. ç¡®è®¤ `finalScore` çš„å€¼æ˜¯å¦æ¥è¿‘Â±15
3. æ£€æŸ¥å¸‚åœºæ•°æ®æ˜¯å¦å……è¶³ï¼ˆSPX/USD/BTC > 50æ¡ï¼‰

**å¯èƒ½åŸå› **:
- å¸‚åœºç¯å¢ƒç¡®å®å¹³æ·¡ï¼ˆæ‰€æœ‰æŒ‡æ ‡éƒ½åœ¨ä¸­æ€§åŒºé—´ï¼‰
- éœ€è¦è¿›ä¸€æ­¥é™ä½é˜ˆå€¼ï¼ˆå¦‚æ”¹ä¸º10ï¼‰

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**:
```typescript
// option-recommendation.service.ts ç¬¬217è¡Œ
if (finalScore > 10) {  // ä»15è¿›ä¸€æ­¥é™ä½åˆ°10
  direction = 'CALL';
}
```

### é—®é¢˜2: æ‰¾ä¸åˆ°åˆçº¦

**æ£€æŸ¥æ­¥éª¤**:
1. æŸ¥çœ‹ `æœªæ‰¾åˆ°åˆé€‚çš„æœŸæƒåˆçº¦` è­¦å‘Š
2. æ£€æŸ¥QQQæ˜¯å¦æœ‰0DTEæœŸæƒï¼ˆäº¤æ˜“æ—¥ï¼‰
3. ç¡®è®¤æµåŠ¨æ€§è¿‡æ»¤å‚æ•°

**å¯èƒ½åŸå› **:
- éäº¤æ˜“æ—¥ï¼ˆå‘¨æœ«ï¼‰
- æµåŠ¨æ€§è¿‡æ»¤è¿‡ä¸¥
- QQQ stockId æ˜ å°„é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**: å®æ–½P1ä¼˜å…ˆçº§çš„æµåŠ¨æ€§æ”¾å®½ä¼˜åŒ–

### é—®é¢˜3: ç¼–è¯‘/è¿è¡Œé”™è¯¯

**æ£€æŸ¥æ­¥éª¤**:
1. ç¡®è®¤æ‰€æœ‰æ–°æ–‡ä»¶å·²ä¿å­˜
2. é‡æ–°è¿è¡Œ `npm run dev`
3. æ£€æŸ¥ import è·¯å¾„

**å¸¸è§é”™è¯¯**:
- æ‰¾ä¸åˆ°æ¨¡å—: æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œimportè¯­å¥
- ç±»å‹é”™è¯¯: è¿è¡Œ `npx tsc --noEmit` æŸ¥çœ‹è¯¦æƒ…

---

## æŠ€æœ¯ç»†èŠ‚

### æœŸæƒæ¨èç®—æ³•è¯¦è§£

> **2026-02-08 æ›´æ–°**: ç®—æ³•æƒé‡ç»è¿‡å®ç›˜è¿­ä»£è°ƒä¼˜ï¼Œä» 40/40/20 æ”¹ä¸º 50/50/15ï¼Œæ–°å¢ SPX å½“æ—¥æ¶¨è·Œå¹…ä¿¡å·ï¼Œå¢å¼ºè¯„åˆ†å¯è§‚æµ‹æ€§ã€‚

#### ç»¼åˆå¾—åˆ†è®¡ç®—
```typescript
// å¤§ç›˜ + åˆ†æ—¶å„å 50%ï¼Œæ—¶é—´çª—å£ä½œä¸ºä¿®æ­£é¡¹ï¼ˆÂ±10èŒƒå›´ï¼‰
finalScore = marketScore * 0.5 + intradayScore * 0.5 + timeWindowAdjustment * 0.15;
```

#### å¤§ç›˜ç¯å¢ƒè¯„åˆ† (50%æƒé‡)
```typescript
// 1. SPXå½“æ—¥æ¶¨è·Œå¹… (æƒé‡35%) â€” æœ€é‡è¦çš„ä¿¡å·
//    1%æ¶¨å¹… = 35åˆ†ï¼Œæ”¾å¤§35å€
score += todayScore * 0.35;

// 2. SPXå¤šæ—¥è¶‹åŠ¿ (æƒé‡15%) â€” ä¸­æœŸæ–¹å‘å‚è€ƒ
//    MA5/MA10/MA20åç¦»åº¦ + å‡çº¿æ’åˆ—ï¼ˆå¤šå¤´+25/ç©ºå¤´-25ï¼‰
score += spxAnalysis.trendStrength * 0.15;

// 3. USD Indexå½±å“ (æƒé‡15%, åå‘)
score += -usdAnalysis.trendStrength * 0.15;

// 4. BTCæ”¯æŒ/é˜»åŠ› (æƒé‡15%ï¼Œå…±æŒ¯æ—¶æ»¡æƒé‡ï¼Œä¸å…±æŒ¯é™è‡³8%)
const btcWeight = btcCorrelation > 0.5 ? 0.15 : 0.08;
score += btcAnalysis.trendStrength * btcWeight;

// 5. VIXææ…ŒæŒ‡æ•° (æƒé‡10%)
if (currentVix > 35) vixScore = -50;        // æåº¦ææ…Œ
else if (currentVix > 25) vixScore = -20;   // é«˜ææ…Œ
else if (currentVix < 15) vixScore = 10;    // ä½ææ…Œ

// 6. å¸‚åœºæ¸©åº¦ (æƒé‡10%) â€” çº¿æ€§è¯„åˆ†
//    æ¸©åº¦80 â†’ +18åˆ†ï¼›æ¸©åº¦20 â†’ -18åˆ†
tempScore = ((temp - 50) / 50) * 30;
```

#### åˆ†æ—¶åŠ¨é‡è¯„åˆ† (50%æƒé‡)
```typescript
// 1. SPXå½“æ—¥Kçº¿å®ä½“å¼ºåº¦ (æƒé‡40%) â€” æ–¹å‘ Ã— æŒ¯å¹…
//    bodyStrength * amplifier * 25
score += spxDayScore * 0.4;

// 2. BTCå°æ—¶KåŠ¨é‡ (æƒé‡30%) â€” ç´¯è®¡å˜åŒ–ç‡ Ã— æ–¹å‘ä¸€è‡´æ€§
score += btcHourlyMomentum * 0.3;

// 3. USDå°æ—¶KåŠ¨é‡ (æƒé‡15%, åå‘)
score += -usdHourlyMomentum * 0.15;

// 4. SPXçŸ­æœŸè¶‹åŠ¿åŠ¨é‡ (æƒé‡15%) â€” æœ€è¿‘3æ—¥æ–¹å‘ä¸€è‡´æ€§
score += consistencyScore * 0.15;
```

#### æ—¶é—´çª—å£è°ƒæ•´ (ä¿®æ­£é¡¹ï¼Œç³»æ•°0.15)
```typescript
// å¼€ç›˜å1å°æ—¶ â†’ +20  |  æ”¶ç›˜å‰30åˆ†é’Ÿ â†’ -50
// æ”¶ç›˜å‰90-30åˆ†é’Ÿ â†’ -30  |  å¼€ç›˜å2å°æ—¶ä»¥ä¸Š â†’ -10
// ç¼©æ”¾ç³»æ•°0.15ï¼Œå®é™…å½±å“èŒƒå›´ Â±7.5 åˆ†
```

#### è¯„åˆ†å¯è§‚æµ‹æ€§ï¼ˆæ–°å¢ï¼‰
æ¯æ¬¡è¯„åˆ†è¾“å‡ºæ˜ç»†æ—¥å¿—ï¼š
```
[å¤§ç›˜è¯„åˆ†æ˜ç»†] æ€»åˆ†=35.2 | SPXå½“æ—¥+0.85%â†’29.8 | SPXè¶‹åŠ¿15.3â†’2.3 | USD-8.1â†’1.2 | BTC12.5*0.15â†’1.9 | æ¸©åº¦=65â†’9.0
[åˆ†æ—¶è¯„åˆ†æ˜ç»†] æ€»åˆ†=28.7 | SPXæ—¥å†…ä½“=0.85%,å¹…=1.2%â†’20.4 | BTCæ—¶K=15.3â†’4.6 | USDæ—¶K=-5.2â†’0.8 | SPX3æ—¥è¶‹åŠ¿3/3æ¶¨â†’3.0
```

---

## æˆåŠŸæ ‡å‡†

### ä»Šæ™šç›®æ ‡ (2026-02-03)

#### æœ€ä½ç›®æ ‡ âœ…
- ç­–ç•¥æ‰§è¡Œæ—¶ç”ŸæˆCALL/PUTæ¨èï¼ˆä¸æ˜¯å…¨HOLDï¼‰
- æ—¥å¿—ä¸­çœ‹åˆ° `ğŸ“Š [æœŸæƒæ¨è]` è¾“å‡º
- `direction` å­—æ®µä¸º 'CALL' æˆ– 'PUT'

#### ç†æƒ³ç›®æ ‡ ğŸ¯
- å®Œæˆ1-3ç¬”æœŸæƒäº¤æ˜“
- è®¢å•æˆåŠŸæäº¤å¹¶è¿”å› orderId
- æŒä»“çŠ¶æ€æ›´æ–°ä¸º HOLDING

#### ç»ˆæç›®æ ‡ ğŸ†
- è‡³å°‘1ç¬”äº¤æ˜“ç›ˆåˆ©
- æ­¢ç›ˆ/æ­¢æŸæœºåˆ¶æ­£å¸¸å·¥ä½œ
- æ”¶ç›˜å‰è‡ªåŠ¨å¹³ä»“

---

## ç›¸å…³æ–‡æ¡£

- [CODE_MAP.md](../../CODE_MAP.md) - ä»£ç åœ°å›¾
- [é‡åŒ–äº¤æ˜“ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£](../technical/251202-é‡åŒ–äº¤æ˜“ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£.md) - ç³»ç»Ÿæ¶æ„
- [äº¤æ˜“æ¨èé€»è¾‘æ€»ç»“](../technical/251212-äº¤æ˜“æ¨èé€»è¾‘æ€»ç»“.md) - æ¨èç®—æ³•

---

## é™„å½•

### A. æ—¥å¿—åˆ†æç»“æœ (2026-01-30 vs 2026-02-02)

| æŒ‡æ ‡ | 01-30 | 02-02 | å˜åŒ–è¶‹åŠ¿ |
|------|-------|-------|---------|
| æ€»æ—¥å¿—æ•° | 1,617 | 4,149 | +156% |
| é”™è¯¯ç‡ | 3.5% | 0.5% | âœ… -86% |
| å¯Œé€”APIé”™è¯¯ | 18æ¬¡ | 2æ¬¡ | âœ… -89% |
| ç­–ç•¥å¤±è´¥ç‡ | 10% | 1.75% | âœ… -82.5% |
| ç­–ç•¥æ‰§è¡Œé€Ÿåº¦ | 163ms | 1ms | âœ… +99.4% |

**æ´å¯Ÿ**: ç³»ç»Ÿåœ¨01-30åˆ°02-02æœŸé—´å·²æœ‰æ˜¾è‘—æ”¹å–„ï¼Œä½†æ ¸å¿ƒé—®é¢˜ï¼ˆé›¶æŒä»“ï¼‰ä»æœªè§£å†³

### B. ç¼–è¯‘æ£€æŸ¥ç»“æœ
```bash
$ npx tsc --noEmit
# è¾“å‡º: (æ— é”™è¯¯)
# çŠ¶æ€: âœ… ç¼–è¯‘é€šè¿‡
```

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£åº”åœ¨æ¯æ¬¡é‡å¤§ä¿®æ”¹åæ›´æ–°
**æœ€åéªŒè¯**: 2026-02-08 ç®—æ³•è°ƒä¼˜è¿­ä»£
**å˜æ›´å†å²**: 2026-02-03 é¦–ç‰ˆ â†’ 2026-02-08 ç®—æ³•æƒé‡é‡æ„ + å¸‚ä»·å•å…¨è¦†ç›– + èµ„é‡‘ç®¡ç†æœŸæƒæ”¯æŒ
