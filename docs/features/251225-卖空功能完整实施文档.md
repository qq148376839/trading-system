# å–ç©ºåŠŸèƒ½å®Œæ•´å®æ–½æ–‡æ¡£

**æ–‡æ¡£ç±»å‹**: åŠŸèƒ½å¼€å‘
**åˆ›å»ºæ—¥æœŸ**: 2025-12-25
**æœ€åæ›´æ–°**: 2026-02-03
**å®æ–½çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éƒ¨ç½²
**ä¼˜å…ˆçº§**: P0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
**æäº¤è®°å½•**: c1b2ebf

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
3. [æŠ€æœ¯å®ç°](#æŠ€æœ¯å®ç°)
4. [æ•°æ®åº“å˜æ›´](#æ•°æ®åº“å˜æ›´)
5. [å…³é”®æœåŠ¡](#å…³é”®æœåŠ¡)
6. [çŠ¶æ€æµè½¬](#çŠ¶æ€æµè½¬)
7. [é£é™©æ§åˆ¶](#é£é™©æ§åˆ¶)
8. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
9. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)

---

## åŠŸèƒ½æ¦‚è¿°

### èƒŒæ™¯
é‡åŒ–äº¤æ˜“ç³»ç»ŸåŸæœ¬åªæ”¯æŒåšå¤šï¼ˆä¹°å…¥ â†’ æŒæœ‰ â†’ å–å‡ºï¼‰æ“ä½œï¼Œæ— æ³•åœ¨ä¸‹è·Œè¡Œæƒ…ä¸­è·åˆ©ã€‚å–ç©ºåŠŸèƒ½çš„å®æ–½ä½¿ç³»ç»Ÿèƒ½å¤Ÿæ”¯æŒåŒå‘äº¤æ˜“ï¼Œå¢å¼ºäº†ç­–ç•¥çš„çµæ´»æ€§å’Œç›ˆåˆ©èƒ½åŠ›ã€‚

### ä¸šåŠ¡ä»·å€¼
- **åŒå‘äº¤æ˜“èƒ½åŠ›**: æ”¯æŒåšå¤šå’Œåšç©ºï¼Œé€‚åº”ä¸åŒå¸‚åœºç¯å¢ƒ
- **é£é™©å¯¹å†²**: å¯åœ¨æŒæœ‰å¤šå¤´ä»“ä½æ—¶å¼€ç©ºå¤´å¯¹å†²é£é™©
- **ç­–ç•¥å¤šæ ·åŒ–**: æ”¯æŒå¯¹å†²ç­–ç•¥ã€å¥—åˆ©ç­–ç•¥ç­‰å¤æ‚äº¤æ˜“ç­–ç•¥
- **å¸‚åœºé€‚åº”æ€§**: åœ¨ç†Šå¸‚æˆ–éœ‡è¡å¸‚ä¸­ä¹Ÿèƒ½å®ç°ç›ˆåˆ©

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. å–ç©ºæƒé™éªŒè¯
- æ£€æŸ¥è´¦æˆ·æ˜¯å¦æ”¯æŒèèµ„èåˆ¸ï¼ˆMargin Accountï¼‰
- éªŒè¯ç‰¹å®šè‚¡ç¥¨æ˜¯å¦å¯å–ç©º
- ç¡®è®¤è´¦æˆ·ä¿è¯é‡‘ä½™é¢å……è¶³

### 2. ä¿è¯é‡‘ç®¡ç†
- **åˆå§‹ä¿è¯é‡‘è¦æ±‚**: 50%ï¼ˆç¾è‚¡æ ‡å‡†ï¼‰
- **å®‰å…¨ç¼“å†²**: é¢å¤–10%å®‰å…¨è¾¹é™…
- **åŠ¨æ€ç›‘æ§**: å®æ—¶ç›‘æ§ä¿è¯é‡‘ä½¿ç”¨ç‡
- **é«˜ä½¿ç”¨ç‡é¢„è­¦**: è¶…è¿‡80%è§¦å‘è­¦å‘Š

### 3. æ•°é‡æ§åˆ¶
- **å•ç¬”æœ€å¤§æ•°é‡**: 10,000è‚¡
- **è‡ªåŠ¨è®¡ç®—é™é¢**: é»˜è®¤100è‚¡
- **ä¿è¯é‡‘çº¦æŸ**: æ ¹æ®å¯ç”¨ä¿è¯é‡‘è®¡ç®—æœ€å¤§å¯å¼€ä»“æ•°é‡

### 4. çŠ¶æ€ç®¡ç†
æ–°å¢3ä¸ªå–ç©ºç›¸å…³çŠ¶æ€ï¼š
- `SHORTING`: å–ç©ºä¸­ï¼ˆå·²æäº¤å–ç©ºè®¢å•ï¼Œç­‰å¾…æˆäº¤ï¼‰
- `SHORT`: æŒæœ‰ç©ºå¤´ï¼ˆç©ºå¤´ä»“ä½æŒæœ‰ä¸­ï¼‰
- `COVERING`: å¹³ä»“ä¸­ï¼ˆå·²æäº¤ä¹°å…¥å¹³ä»“è®¢å•ï¼Œç­‰å¾…æˆäº¤ï¼‰

---

## æŠ€æœ¯å®ç°

### æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Strategy Scheduler                     â”‚
â”‚           (ç­–ç•¥è°ƒåº¦å™¨ - ä¸»æ§åˆ¶å™¨)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â†’ Trading Recommendation Service
              â”‚   (åˆ¤æ–­åšå¤š/åšç©ºä¿¡å·)
              â”‚
              â”œâ”€â†’ Short Position Validation Service
              â”‚   â”œâ”€ checkShortPermission()      è´¦æˆ·æƒé™
              â”‚   â”œâ”€ validateMargin()            ä¿è¯é‡‘éªŒè¯
              â”‚   â”œâ”€ validateQuantity()          æ•°é‡éªŒè¯
              â”‚   â””â”€ validateStateTransition()   çŠ¶æ€è½¬æ¢éªŒè¯
              â”‚
              â”œâ”€â†’ Basic Execution Service
              â”‚   â”œâ”€ executeSell() â†’ SHORTINGçŠ¶æ€
              â”‚   â””â”€ executeBuy()  â†’ COVERINGçŠ¶æ€
              â”‚
              â”œâ”€â†’ Dynamic Position Manager
              â”‚   â””â”€ ç›‘æ§SHORTä»“ä½ï¼Œè§¦å‘æ­¢ç›ˆ/æ­¢æŸ
              â”‚
              â””â”€â†’ Trading Session Service
                  â””â”€ æ”¶ç›˜å‰å¼ºåˆ¶å¹³ä»“ç©ºå¤´
```

---

## æ•°æ®åº“å˜æ›´

### è¿ç§»è„šæœ¬: `010_add_short_positions_states.sql`

**ç›®çš„**: æ‰©å±• `strategy_instances.current_state` å­—æ®µä»¥æ”¯æŒå–ç©ºçŠ¶æ€

**æ–°å¢çŠ¶æ€**:
```sql
CHECK (current_state IN (
    'IDLE',           -- ç©ºé—²
    'OPENING',        -- å¼€å¤šä»“
    'HOLDING',        -- æŒæœ‰å¤šä»“
    'CLOSING',        -- å¹³å¤šä»“
    'SHORTING',       -- å¼€ç©ºä»“ â† æ–°å¢
    'SHORT',          -- æŒæœ‰ç©ºä»“ â† æ–°å¢
    'COVERING',       -- å¹³ç©ºä»“ â† æ–°å¢
    'COOLDOWN'        -- å†·å´æœŸ
));
```

**æ‰§è¡Œæ–¹å¼**:
```bash
psql -U postgres -d trading_db -f api/migrations/010_add_short_positions_states.sql
```

**å½±å“èŒƒå›´**:
- `strategy_instances` è¡¨çš„çº¦æŸæ›´æ–°
- ä¸å½±å“ç°æœ‰æ•°æ®
- å‘åå…¼å®¹åŸæœ‰çŠ¶æ€

---

## å…³é”®æœåŠ¡

### 1. ShortPositionValidationService

**æ–‡ä»¶**: `api/src/services/short-position-validation.service.ts` (466è¡Œï¼Œæ–°å»º)

**æ ¸å¿ƒæ–¹æ³•**:

#### `checkShortPermission(symbol: string)`
éªŒè¯è´¦æˆ·æ˜¯å¦å…·æœ‰å–ç©ºæƒé™
```typescript
// æ£€æŸ¥è¦ç‚¹ï¼š
// 1. è´¦æˆ·ä½™é¢APIå¯è®¿é—®
// 2. è´¦æˆ·æ”¯æŒèèµ„èåˆ¸ï¼ˆæœ‰initMarginæˆ–maintenanceMarginå­—æ®µï¼‰
// 3. ç‰¹å®šè‚¡ç¥¨å¯å–ç©ºï¼ˆé¢„ç•™æ¥å£ï¼‰

è¿”å›: { valid: boolean, error?: string }
```

#### `validateMargin(symbol: string, quantity: number, price: number)`
éªŒè¯ä¿è¯é‡‘æ˜¯å¦å……è¶³
```typescript
// è®¡ç®—é€»è¾‘ï¼š
// requiredMargin = quantity Ã— price Ã— (INITIAL_MARGIN_RATIO + MARGIN_SAFETY_BUFFER)
//                = quantity Ã— price Ã— 0.6 (50% + 10%)

// æ¯”è¾ƒï¼šrequiredMargin vs availableMargin

è¿”å›: {
  valid: boolean,
  data: {
    requiredMargin: number,
    availableMargin: number,
    marginRatio: number,
    isSufficient: boolean
  }
}
```

#### `validateQuantity(quantity: number)`
éªŒè¯å–ç©ºæ•°é‡æ˜¯å¦åˆè§„
```typescript
// æ£€æŸ¥è§„åˆ™ï¼š
// 1. quantity > 0 (å¿…é¡»ä¸ºæ­£æ•°)
// 2. quantity <= MAX_SHORT_QUANTITY_PER_ORDER (10,000)
// 3. quantity ä¸ºæ•´æ•°

è¿”å›: { valid: boolean, error?: string }
```

#### `validateStateTransition(currentState: string, action: 'short' | 'cover')`
éªŒè¯çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
```typescript
// åˆæ³•è½¬æ¢ï¼š
// short:  IDLE â†’ SHORTING
// cover:  SHORT â†’ COVERING

è¿”å›: { valid: boolean, error?: string }
```

---

### 2. Strategy Scheduler å¢å¼º

**æ–‡ä»¶**: `api/src/services/strategy-scheduler.service.ts` (+554è¡Œ)

**æ–°å¢é€»è¾‘**:

#### å–ç©ºä¿¡å·ç”Ÿæˆ
```typescript
// åœ¨ generateAndProcessSignal() ä¸­ï¼š
const recommendation = await tradingRecommendationService.calculateRecommendation(symbol);

if (recommendation.action === 'SELL') {
  // è§¦å‘å–ç©ºéªŒè¯æµç¨‹
  const validations = await shortPositionValidationService.validate({
    symbol,
    quantity: autoCalculatedQty,
    price: currentPrice
  });

  if (validations.allPassed) {
    // æ‰§è¡Œå–ç©º
    await basicExecutionService.executeSell(strategyInstanceId, symbol, autoCalculatedQty);
    await stateManager.updateInstanceState(strategyInstanceId, 'SHORTING');
  }
}
```

#### ç©ºå¤´ä»“ä½ç›‘æ§
```typescript
// åœ¨ monitorPositions() ä¸­ï¼š
for (const instance of instances) {
  if (instance.current_state === 'SHORT') {
    // æ£€æŸ¥æ­¢ç›ˆ/æ­¢æŸ
    const shouldCover = await this.checkCoveringConditions(instance);

    if (shouldCover) {
      // æ‰§è¡Œä¹°å…¥å¹³ä»“
      await basicExecutionService.executeBuy(instance.id, symbol, holdingQty);
      await stateManager.updateInstanceState(instance.id, 'COVERING');
    }
  }
}
```

---

### 3. Basic Execution Service æ‰©å±•

**æ–‡ä»¶**: `api/src/services/basic-execution.service.ts` (+255è¡Œ)

**å…³é”®å˜æ›´**:

#### `executeSell()` æ–¹æ³•å¢å¼º
```typescript
// åŸæœ¬åªæ”¯æŒå¹³å¤šä»“å–å‡º
// ç°åœ¨æ ¹æ®å½“å‰çŠ¶æ€åˆ¤æ–­ï¼š
if (currentState === 'HOLDING') {
  // å¹³å¤šä»“å–å‡º
  orderSide = 'SELL';
} else if (currentState === 'IDLE') {
  // å¼€ç©ºä»“å–å‡º
  orderSide = 'SELL';  // æˆ– 'SHORT_SELL'ï¼ˆå–å†³äºåˆ¸å•†APIï¼‰
}
```

#### `executeBuy()` æ–¹æ³•æ‰©å±•
```typescript
// åŸæœ¬åªæ”¯æŒå¼€å¤šä»“ä¹°å…¥
// ç°åœ¨æ ¹æ®å½“å‰çŠ¶æ€åˆ¤æ–­ï¼š
if (currentState === 'IDLE') {
  // å¼€å¤šä»“ä¹°å…¥
  orderSide = 'BUY';
} else if (currentState === 'SHORT') {
  // å¹³ç©ºä»“ä¹°å…¥ï¼ˆä¹°å…¥å¹³ä»“ï¼‰
  orderSide = 'BUY_TO_COVER';  // æˆ– 'BUY'ï¼ˆå–å†³äºåˆ¸å•†APIï¼‰
}
```

---

### 4. Dynamic Position Manager æ”¹è¿›

**æ–‡ä»¶**: `api/src/services/dynamic-position-manager.service.ts` (+155è¡Œ)

**æ–°å¢åŠŸèƒ½**:

#### ç©ºå¤´æ­¢ç›ˆ/æ­¢æŸé€»è¾‘
```typescript
// ç©ºå¤´ç›ˆäºè®¡ç®—ï¼ˆåå‘ï¼‰
const profit = (entryPrice - currentPrice) / entryPrice;

// ç©ºå¤´æ­¢ç›ˆï¼šä»·æ ¼ä¸‹è·Œè¾¾åˆ°ç›®æ ‡
if (profit >= stopGainPct) {
  return { shouldClose: true, reason: 'STOP_GAIN' };
}

// ç©ºå¤´æ­¢æŸï¼šä»·æ ¼ä¸Šæ¶¨è¶…è¿‡é˜ˆå€¼
if (profit <= -stopLossPct) {
  return { shouldClose: true, reason: 'STOP_LOSS' };
}
```

---

### 5. Trading Session Service

**æ–‡ä»¶**: `api/src/services/trading-session.service.ts` (546è¡Œï¼Œæ–°å»º)

**åŠŸèƒ½**: äº¤æ˜“æ—¶æ®µç®¡ç†å’Œæ”¶ç›˜å‰å¼ºåˆ¶å¹³ä»“

**æ ¸å¿ƒæ–¹æ³•**:

#### `forceCloseAllPositions()`
æ”¶ç›˜å‰30åˆ†é’Ÿå¼ºåˆ¶å¹³ä»“æ‰€æœ‰æŒä»“ï¼ˆåŒ…æ‹¬ç©ºå¤´ï¼‰
```typescript
// æŸ¥è¯¢æ‰€æœ‰HOLDINGå’ŒSHORTçŠ¶æ€çš„å®ä¾‹
const instances = await this.getActiveInstances();

for (const instance of instances) {
  if (instance.current_state === 'SHORT') {
    // å¼ºåˆ¶å¹³ç©ºä»“
    await basicExecutionService.executeBuy(instance.id, symbol, holdingQty);
    await stateManager.updateInstanceState(instance.id, 'COVERING');
  }
}
```

---

## çŠ¶æ€æµè½¬

### å®Œæ•´çŠ¶æ€æœº

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  IDLE   â”‚
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
    (åšå¤šä¿¡å·)               (åšç©ºä¿¡å·)
         â”‚                       â”‚
         v                       v
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ OPENING  â”‚            â”‚ SHORTING â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                       â”‚
    (è®¢å•æˆäº¤)              (è®¢å•æˆäº¤)
        â”‚                       â”‚
        v                       v
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ HOLDING  â”‚            â”‚  SHORT  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                       â”‚
  (æ­¢ç›ˆ/æ­¢æŸ/æ”¶ç›˜)        (æ­¢ç›ˆ/æ­¢æŸ/æ”¶ç›˜)
        â”‚                       â”‚
        v                       v
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ CLOSING  â”‚            â”‚ COVERING â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                       â”‚
    (å¹³ä»“æˆäº¤)              (å¹³ä»“æˆäº¤)
        â”‚                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    v
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ COOLDOWN â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                   â”‚
              (å†·å´æœŸç»“æŸ)
                   â”‚
                   v
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  IDLE   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é£é™©æ§åˆ¶

### 1. ä¿è¯é‡‘é£é™©
- **åˆå§‹ä¿è¯é‡‘**: 50%åŸºç¡€ + 10%å®‰å…¨ç¼“å†²
- **ç»´æŒä¿è¯é‡‘ç›‘æ§**: å®æ—¶æ£€æŸ¥
- **é«˜ä½¿ç”¨ç‡é¢„è­¦**: >80%è§¦å‘è­¦å‘Š
- **å¼ºåˆ¶å¹³ä»“**: ä¿è¯é‡‘ä¸è¶³æ—¶æ‹’ç»å¼€ä»“

### 2. æ•°é‡é£é™©
- **å•ç¬”é™é¢**: æœ€å¤š10,000è‚¡
- **æ€»é‡æ§åˆ¶**: å¯é…ç½®è´¦æˆ·çº§åˆ«æ€»ç©ºå¤´é™é¢
- **åˆ†æ•£é£é™©**: é¿å…å•ä¸€è‚¡ç¥¨è¿‡åº¦é›†ä¸­

### 3. æ—¶é—´é£é™©
- **æ”¶ç›˜å‰å¼ºåˆ¶å¹³ä»“**: é¿å…éš”å¤œæŒä»“é£é™©
- **äº¤æ˜“æ—¶æ®µæ£€æŸ¥**: åªåœ¨ç›˜ä¸­å…è®¸å–ç©º
- **èŠ‚å‡æ—¥å¤„ç†**: éäº¤æ˜“æ—¥ç¦æ­¢æ“ä½œ

### 4. å¸‚åœºé£é™©
- **æ­¢æŸä¿æŠ¤**: è‡ªåŠ¨æ­¢æŸé˜²æ­¢æ— é™æŸå¤±
- **æ³¢åŠ¨ç‡ç›‘æ§**: é«˜æ³¢åŠ¨æ—¶é™ä½æ æ†
- **ç†”æ–­æœºåˆ¶**: æç«¯è¡Œæƒ…æ—¶æš‚åœäº¤æ˜“

---

## æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•

**æ–‡ä»¶**: `api/src/__tests__/short-position-validation.test.ts` (770è¡Œ)

**è¦†ç›–åœºæ™¯**:
1. âœ… å–ç©ºæƒé™éªŒè¯
2. âœ… ä¿è¯é‡‘è®¡ç®—å’ŒéªŒè¯
3. âœ… æ•°é‡éªŒè¯ï¼ˆè¾¹ç•Œæ¡ä»¶ï¼‰
4. âœ… çŠ¶æ€è½¬æ¢éªŒè¯
5. âœ… å®Œæ•´æµç¨‹é›†æˆæµ‹è¯•

**æ–‡ä»¶**: `api/src/__tests__/short-position-integration.test.ts` (341è¡Œ)

**ç«¯åˆ°ç«¯æµ‹è¯•**:
1. âœ… å–ç©ºå¼€ä»“ â†’ æŒæœ‰ç©ºå¤´ â†’ å¹³ç©ºä»“
2. âœ… æ­¢ç›ˆåœºæ™¯ï¼ˆä»·æ ¼ä¸‹è·Œï¼‰
3. âœ… æ­¢æŸåœºæ™¯ï¼ˆä»·æ ¼ä¸Šæ¶¨ï¼‰
4. âœ… æ”¶ç›˜å‰å¼ºåˆ¶å¹³ä»“
5. âœ… ä¿è¯é‡‘ä¸è¶³æ‹’ç»

### æµ‹è¯•æ‰§è¡Œ
```bash
# è¿è¡Œå–ç©ºç›¸å…³æµ‹è¯•
cd api
npm test -- short-position

# é¢„æœŸç»“æœï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡
```

---

## ä½¿ç”¨æŒ‡å—

### 1. å¯ç”¨å–ç©ºåŠŸèƒ½

**å‰ç½®æ¡ä»¶**:
- åˆ¸å•†è´¦æˆ·æ”¯æŒèèµ„èåˆ¸
- æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œ
- æœåŠ¡ç‰ˆæœ¬ >= c1b2ebf

**æ£€æŸ¥è´¦æˆ·æƒé™**:
```bash
# ä½¿ç”¨APIæ£€æŸ¥
curl http://localhost:3001/api/account/short-permission

# é¢„æœŸè¿”å›
{
  "hasPermission": true,
  "marginAccountEnabled": true
}
```

### 2. é…ç½®ç­–ç•¥æ”¯æŒå–ç©º

**åœ¨ç­–ç•¥é…ç½®ä¸­å¯ç”¨**:
```typescript
// ç­–ç•¥é…ç½®ç¤ºä¾‹
{
  strategyId: 1,
  symbol: 'AAPL.US',
  enableShortSelling: true,        // â† å¯ç”¨å–ç©º
  maxShortQuantity: 100,           // â† æœ€å¤§å–ç©ºæ•°é‡
  shortStopLossPct: 0.05,         // â† ç©ºå¤´æ­¢æŸ5%
  shortStopGainPct: 0.10          // â† ç©ºå¤´æ­¢ç›ˆ10%
}
```

### 3. ç›‘æ§å–ç©ºä»“ä½

**æŸ¥è¯¢å½“å‰ç©ºå¤´æŒä»“**:
```sql
SELECT
  si.id,
  si.strategy_id,
  si.symbol,
  si.current_state,
  si.entry_price,
  si.current_price,
  si.quantity,
  (si.entry_price - si.current_price) / si.entry_price AS profit_pct
FROM strategy_instances si
WHERE si.current_state IN ('SHORTING', 'SHORT', 'COVERING')
ORDER BY si.updated_at DESC;
```

**æ—¥å¿—ç›‘æ§**:
```bash
# æŸ¥çœ‹å–ç©ºç›¸å…³æ—¥å¿—
tail -f logs-$(date +%Y-%m-%d).json | grep -E "SHORTING|SHORT|COVERING"
```

### 4. æ‰‹åŠ¨å¹³ä»“ç©ºå¤´

**APIè°ƒç”¨**:
```bash
# å¼ºåˆ¶å¹³ä»“æŒ‡å®šå®ä¾‹
curl -X POST http://localhost:3001/api/strategies/instances/{instanceId}/close \
  -H "Content-Type: application/json" \
  -d '{"reason": "manual"}'
```

---

## ç›¸å…³æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶
1. `api/src/services/short-position-validation.service.ts` (466è¡Œ)
2. `api/src/services/trading-session.service.ts` (546è¡Œ)
3. `api/migrations/010_add_short_positions_states.sql` (79è¡Œ)
4. `api/src/__tests__/short-position-validation.test.ts` (770è¡Œ)
5. `api/src/__tests__/short-position-integration.test.ts` (341è¡Œ)

### ä¿®æ”¹æ–‡ä»¶
1. `api/src/services/strategy-scheduler.service.ts` (+554è¡Œ)
2. `api/src/services/basic-execution.service.ts` (+255è¡Œ)
3. `api/src/services/dynamic-position-manager.service.ts` (+155è¡Œ)
4. `api/src/services/backtest.service.ts` (+281è¡Œ)
5. `api/src/services/market-data.service.ts` (+51è¡Œ)
6. `api/src/services/trading-days.service.ts` (+169è¡Œ)

### æ€»ä»£ç å˜æ›´
- **æ–°å¢**: ~2,200è¡Œ
- **ä¿®æ”¹**: ~1,500è¡Œ
- **æµ‹è¯•**: ~1,100è¡Œ
- **æ€»è®¡**: ~4,800è¡Œ

---

## å·²çŸ¥é™åˆ¶

### 1. åˆ¸å•†APIé™åˆ¶
- ä¸åŒåˆ¸å•†å¯¹å–ç©ºçš„APIè°ƒç”¨æ–¹å¼å¯èƒ½ä¸åŒ
- éƒ¨åˆ†åˆ¸å•†å¯èƒ½éœ€è¦é¢å¤–çš„å–ç©ºåè®®ç­¾ç½²
- éœ€è¦æ ¹æ®å®é™…åˆ¸å•†SDKè°ƒæ•´å®ç°

### 2. åŠŸèƒ½é™åˆ¶
- å½“å‰ä¸æ”¯æŒè£¸å–ç©ºï¼ˆNaked Short Sellingï¼‰
- ä¸æ”¯æŒå–ç©ºETFä¸­çš„ä¸ªè‚¡
- æš‚ä¸æ”¯æŒè·¨å“ç§å¯¹å†²

### 3. ç›‘æ§é™åˆ¶
- å®æ—¶ä¿è¯é‡‘ç›‘æ§ä¾èµ–åˆ¸å•†æ¨é€
- ç›˜åæŒä»“å¯èƒ½æœ‰å»¶è¿Ÿæ›´æ–°
- æç«¯è¡Œæƒ…ä¸‹å¯èƒ½æ— æ³•åŠæ—¶æ­¢æŸ

---

## åç»­ä¼˜åŒ–è®¡åˆ’

### P1 ä¼˜å…ˆçº§
1. **å®æ—¶ä¿è¯é‡‘ç›‘æ§**: å¢åŠ WebSocketæ¨é€ä¿è¯é‡‘å˜åŒ–
2. **å–ç©ºæˆæœ¬è·Ÿè¸ª**: è®°å½•å€Ÿåˆ¸è´¹ç”¨å’Œåˆ©æ¯
3. **å¼ºå¹³é€šçŸ¥**: ä¿è¯é‡‘ä¸è¶³æ—¶å‘é€å‘Šè­¦

### P2 ä¼˜å…ˆçº§
1. **å–ç©ºæ± ç®¡ç†**: è¿½è¸ªåˆ¸æºå¯ç”¨æ€§
2. **å¯¹å†²ç­–ç•¥**: æ”¯æŒå¤šç©ºå¯¹å†²ç­–ç•¥
3. **å›æµ‹æ”¯æŒ**: å›æµ‹ä¸­æ¨¡æ‹Ÿå–ç©ºæˆæœ¬

### P3 ä¼˜å…ˆçº§
1. **è·¨å“ç§å¯¹å†²**: æ”¯æŒè‚¡ç¥¨-æœŸæƒå¯¹å†²
2. **å–ç©ºåˆ†æ**: ç»Ÿè®¡å–ç©ºç­–ç•¥ç»©æ•ˆ
3. **æ™ºèƒ½å€Ÿåˆ¸**: è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜åˆ¸æº

---

## æŠ€æœ¯å€ºåŠ¡

1. **åˆ¸å•†APIæŠ½è±¡**: å½“å‰ä»£ç ä¸LongPortå¼ºè€¦åˆï¼Œéœ€è¦æŠ½è±¡å±‚æ”¯æŒå¤šåˆ¸å•†
2. **ä¿è¯é‡‘è®¡ç®—ç²¾åº¦**: éœ€è¦è€ƒè™‘ä¸åŒå¸‚åœºçš„ä¿è¯é‡‘è§„åˆ™
3. **çŠ¶æ€æ¢å¤**: æœåŠ¡é‡å¯åéœ€è¦æ¢å¤å–ç©ºä»“ä½çŠ¶æ€
4. **å¼‚å¸¸å¤„ç†**: éœ€è¦å¢å¼ºå–ç©ºè®¢å•å¤±è´¥çš„é‡è¯•å’Œå›æ»šé€»è¾‘

---

## å‚è€ƒèµ„æ–™

### ç›‘ç®¡è§„åˆ™
- [SEC Regulation SHO](https://www.sec.gov/rules/final/34-50103.htm) - å–ç©ºç›‘ç®¡è§„åˆ™
- [FINRA Margin Requirements](https://www.finra.org/rules-guidance/rulebooks/finra-rules/4210) - ä¿è¯é‡‘è¦æ±‚

### æŠ€æœ¯æ–‡æ¡£
- [LongPort API - å–ç©ºæ¥å£](https://open.longportapp.com/docs/trade/order/submit) - è®¢å•æäº¤
- [ä¿è¯é‡‘è®¡ç®—å…¬å¼](https://www.investopedia.com/terms/i/initialmargin.asp) - Investopedia

### é¡¹ç›®æ–‡æ¡£
- [CODE_MAP.md](../../CODE_MAP.md) - ä»£ç åœ°å›¾
- [é‡åŒ–äº¤æ˜“ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£](../technical/251202-é‡åŒ–äº¤æ˜“ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£.md) - ç³»ç»Ÿæ¶æ„
- [åŠ¨æ€ä»“ä½ç®¡ç†](../technical/251203-åŠ¨æ€ä»“ä½ç®¡ç†.md) - ä»“ä½ç®¡ç†é€»è¾‘

---

## æ›´æ–°è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 2025-12-25 | 1.0 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŠŸèƒ½å®æ–½å®Œæˆ | Rio Wang |
| 2026-02-03 | 1.1 | è¡¥å……æ–‡æ¡£ï¼Œæ·»åŠ ä½¿ç”¨æŒ‡å—å’ŒæŠ€æœ¯ç»†èŠ‚ | Claude Code |

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£åº”åœ¨å–ç©ºåŠŸèƒ½æœ‰é‡å¤§å˜æ›´æ—¶æ›´æ–°
**æœ€åéªŒè¯**: 2026-02-03 åŠŸèƒ½éªŒè¯é€šè¿‡
**éƒ¨ç½²çŠ¶æ€**: âœ… å·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
