# 订单重复提交防护机制 - 测试计划

**文档版本**：v1.0  
**创建时间**：2025-12-12  
**状态**：待测试

---

## 📋 测试概述

本文档描述订单重复提交防护机制的测试计划，包括功能测试、集成测试和性能测试。

---

## 1. 测试环境

### 1.1 环境要求
- **交易环境**：模拟盘环境（避免实盘风险）
- **数据库**：PostgreSQL（包含测试数据）
- **Longbridge SDK**：已配置并可用
- **测试账户**：模拟账户，包含测试持仓和资金

### 1.2 测试数据准备
- 创建测试策略实例
- 准备测试持仓（多个标的，不同数量）
- 准备测试订单（已成交、未成交、已拒绝）

---

## 2. 功能测试

### 2.1 卖出订单持仓验证测试

#### 测试用例 TC-001：正常卖出（持仓充足）
**前置条件**：
- 账户持有 ACHR.US 100股
- 无未成交卖出订单

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 验证订单是否成功提交
3. 检查日志中是否有持仓验证通过记录

**预期结果**：
- ✅ 订单成功提交
- ✅ 日志显示：`持仓验证通过，可用持仓=100，请求卖出=50`
- ✅ 订单状态为 `SUBMITTED` 或 `NEW`

---

#### 测试用例 TC-002：卖出数量超过可用持仓
**前置条件**：
- 账户持有 ACHR.US 100股
- 无未成交卖出订单

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=150
2. 验证订单是否被拒绝
3. 检查错误信息

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`可用持仓不足：实际持仓=100，未成交订单占用=0，可用持仓=100，请求卖出=150`
- ✅ 订单状态为 `REJECTED`

---

#### 测试用例 TC-003：卖出数量超过可用持仓（有未成交订单）
**前置条件**：
- 账户持有 ACHR.US 100股
- 已有未成交卖出订单：ACHR.US，数量=60

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 验证订单是否被拒绝
3. 检查错误信息

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`可用持仓不足：实际持仓=100，未成交订单占用=60，可用持仓=40，请求卖出=50`
- ✅ 订单状态为 `REJECTED`

---

#### 测试用例 TC-004：部分成交订单的持仓计算
**前置条件**：
- 账户持有 ACHR.US 100股
- 已有部分成交卖出订单：ACHR.US，总数量=60，已成交=20，未成交=40

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 验证订单是否被拒绝
3. 检查错误信息

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`可用持仓不足：实际持仓=100，未成交订单占用=40，可用持仓=60，请求卖出=50`
- ✅ 订单状态为 `REJECTED`

---

### 2.2 订单去重测试

#### 测试用例 TC-005：重复提交检测（缓存检查）
**前置条件**：
- 策略ID=1，标的=ACHR.US
- 60秒内已提交过卖出订单

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 立即（5秒内）再次提交相同订单
3. 验证第二次提交是否被拒绝

**预期结果**：
- ✅ 第一次提交成功
- ❌ 第二次提交被拒绝
- ❌ 错误信息：`标的 ACHR.US 在最近60秒内已提交过 SELL 订单，防止重复提交`

---

#### 测试用例 TC-006：重复提交检测（未成交订单检查）
**前置条件**：
- 策略ID=1，标的=ACHR.US
- 已有未成交卖出订单：ACHR.US，状态=NewStatus

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 验证订单是否被拒绝

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`标的 ACHR.US 已有未成交订单，不允许重复下单`

---

### 2.3 卖空检测和平仓测试

#### 测试用例 TC-007：卖空检测
**前置条件**：
- 账户持有 ACHR.US -50股（卖空持仓）

**测试步骤**：
1. 触发账户余额同步（`AccountBalanceSyncService.syncAccountBalance()`）
2. 检查是否检测到卖空持仓
3. 检查是否自动生成平仓订单

**预期结果**：
- ✅ 检测到卖空持仓：`检测到卖空持仓: ACHR.US, 持仓数量=-50`
- ✅ 自动生成买入平仓订单：数量=50
- ✅ 平仓订单成功提交

---

#### 测试用例 TC-008：多个卖空持仓平仓
**前置条件**：
- 账户持有 ACHR.US -50股
- 账户持有 AAPL.US -30股

**测试步骤**：
1. 触发账户余额同步
2. 检查是否检测到所有卖空持仓
3. 检查是否自动生成所有平仓订单

**预期结果**：
- ✅ 检测到2个卖空持仓
- ✅ 自动生成2个买入平仓订单
- ✅ 所有平仓订单成功提交

---

### 2.4 交易推送测试

#### 测试用例 TC-009：交易推送订阅
**前置条件**：
- 系统已启动
- Longbridge SDK 可用

**测试步骤**：
1. 启动系统
2. 检查日志中是否有交易推送订阅成功记录
3. 提交一个测试订单
4. 检查是否收到推送通知

**预期结果**：
- ✅ 日志显示：`[交易推送] 已订阅交易推送 (TopicType.Private)`
- ✅ 订单提交后收到推送通知
- ✅ 日志显示：`[交易推送] 收到订单变更: ...`

---

#### 测试用例 TC-010：交易推送更新缓存
**前置条件**：
- 交易推送已订阅
- 订单提交缓存为空

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 等待推送通知（1-2秒）
3. 检查订单提交缓存是否已更新
4. 立即再次提交相同订单
5. 验证第二次提交是否被拒绝

**预期结果**：
- ✅ 订单提交成功
- ✅ 收到推送通知
- ✅ 订单提交缓存已更新
- ❌ 第二次提交被拒绝（缓存检查）

---

## 3. 集成测试

### 3.1 完整流程测试

#### 测试用例 TC-011：完整卖出流程
**前置条件**：
- 账户持有 ACHR.US 100股
- 策略ID=1已启动

**测试步骤**：
1. 策略生成卖出信号（止盈触发）
2. 验证持仓验证是否通过
3. 验证订单是否成功提交
4. 验证订单状态是否正确更新
5. 验证可用持仓是否重新计算

**预期结果**：
- ✅ 持仓验证通过
- ✅ 订单成功提交
- ✅ 订单状态正确更新
- ✅ 可用持仓重新计算（扣除未成交订单占用）

---

#### 测试用例 TC-012：卖空自动平仓流程
**前置条件**：
- 账户持有 ACHR.US -50股（卖空持仓）
- 账户余额同步服务已启动（每5分钟）

**测试步骤**：
1. 等待账户余额同步触发（或手动触发）
2. 检查是否检测到卖空持仓
3. 检查是否自动生成平仓订单
4. 检查平仓订单是否成功提交
5. 等待订单成交
6. 检查卖空持仓是否已平仓

**预期结果**：
- ✅ 检测到卖空持仓
- ✅ 自动生成平仓订单
- ✅ 平仓订单成功提交
- ✅ 订单成交后，卖空持仓已平仓

---

## 4. 性能测试

### 4.1 持仓验证性能测试

#### 测试用例 TC-013：持仓验证响应时间
**前置条件**：
- 账户持有多个标的（10个）
- 每个标的有多个未成交订单（5个）

**测试步骤**：
1. 记录开始时间
2. 调用 `calculateAvailablePosition()` 计算可用持仓
3. 记录结束时间
4. 计算响应时间

**预期结果**：
- ✅ 响应时间 < 500ms（单次查询）
- ✅ 响应时间 < 1000ms（包含API调用）

---

### 4.2 并发测试

#### 测试用例 TC-014：并发订单提交
**前置条件**：
- 账户持有 ACHR.US 100股
- 无未成交订单

**测试步骤**：
1. 同时提交10个卖出订单（数量=10）
2. 验证只有1个订单成功提交
3. 验证其他9个订单被拒绝

**预期结果**：
- ✅ 只有1个订单成功提交
- ✅ 其他9个订单被拒绝（去重检查）
- ✅ 无重复订单提交

---

## 5. 边界测试

### 5.1 边界条件测试

#### 测试用例 TC-015：零持仓卖出
**前置条件**：
- 账户持有 ACHR.US 0股

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=1
2. 验证订单是否被拒绝

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`可用持仓不足：实际持仓=0，未成交订单占用=0，可用持仓=0，请求卖出=1`

---

#### 测试用例 TC-016：负数持仓（卖空）
**前置条件**：
- 账户持有 ACHR.US -50股（卖空持仓）

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=10
2. 验证订单是否被拒绝

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`可用持仓不足：实际持仓=-50，未成交订单占用=0，可用持仓=0，请求卖出=10`

---

#### 测试用例 TC-017：API调用失败降级
**前置条件**：
- Longbridge API 不可用（模拟）

**测试步骤**：
1. 调用 `calculateAvailablePosition()`
2. 验证是否返回保守值（0）
3. 验证订单是否被拒绝

**预期结果**：
- ✅ 返回保守值：`{ actualQuantity: 0, pendingQuantity: 0, availableQuantity: 0 }`
- ❌ 订单被拒绝（保守处理）

---

## 6. 回归测试

### 6.1 现有功能回归测试

#### 测试用例 TC-018：正常买入流程不受影响
**前置条件**：
- 账户资金充足
- 无持仓

**测试步骤**：
1. 提交买入订单：ACHR.US，数量=100
2. 验证订单是否成功提交

**预期结果**：
- ✅ 订单成功提交（买入流程不受影响）

---

#### 测试用例 TC-019：正常卖出流程（无持仓验证问题）
**前置条件**：
- 账户持有 ACHR.US 100股
- 无未成交订单

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 验证订单是否成功提交

**预期结果**：
- ✅ 订单成功提交（正常卖出流程不受影响）

---

## 7. 测试执行计划

### 7.1 测试阶段

**阶段1：单元测试**（1天）
- TC-001 至 TC-004：持仓验证测试
- TC-005 至 TC-006：订单去重测试

**阶段2：集成测试**（1天）
- TC-007 至 TC-010：卖空检测和交易推送测试
- TC-011 至 TC-012：完整流程测试

**阶段3：性能和边界测试**（1天）
- TC-013 至 TC-017：性能和边界测试

**阶段4：回归测试**（0.5天）
- TC-018 至 TC-019：回归测试

### 7.2 测试环境

- **测试环境**：模拟盘环境
- **测试账户**：专用测试账户
- **测试数据**：预置测试持仓和订单

### 7.3 测试工具

- **手动测试**：Postman / curl
- **自动化测试**：Jest / Mocha（可选）
- **日志分析**：查看系统日志

---

## 8. 测试报告模板

### 8.1 测试结果记录

| 测试用例ID | 测试用例名称 | 执行结果 | 执行时间 | 备注 |
|-----------|-------------|---------|---------|------|
| TC-001 | 正常卖出（持仓充足） | ✅/❌ | YYYY-MM-DD HH:MM:SS | |
| TC-002 | 卖出数量超过可用持仓 | ✅/❌ | YYYY-MM-DD HH:MM:SS | |
| ... | ... | ... | ... | ... |

### 8.2 缺陷记录

| 缺陷ID | 测试用例ID | 缺陷描述 | 严重程度 | 状态 |
|--------|-----------|---------|---------|------|
| BUG-001 | TC-002 | 持仓验证错误信息不准确 | 中 | 待修复 |
| ... | ... | ... | ... | ... |

---

## 9. 验收标准

### 9.1 功能验收标准

- ✅ 所有P0功能测试用例通过率 ≥ 100%
- ✅ 所有P1功能测试用例通过率 ≥ 95%
- ✅ 无严重缺陷（P0级别）

### 9.2 性能验收标准

- ✅ 持仓验证响应时间 < 500ms（单次查询）
- ✅ 订单提交去重检查响应时间 < 100ms
- ✅ 并发订单提交无重复订单

### 9.3 稳定性验收标准

- ✅ 系统运行24小时无崩溃
- ✅ 订单拒绝率（因持仓不足）降低至0%
- ✅ 重复订单提交事件减少至0次/天

---

## 10. 附录

### 10.1 测试数据准备脚本

```sql
-- 创建测试策略实例
INSERT INTO strategy_instances (strategy_id, symbol, current_state, context)
VALUES (1, 'ACHR.US', 'HOLDING', '{"quantity": 100, "entryPrice": 10.0}');

-- 创建测试持仓（通过API或手动设置）
-- 注意：实际持仓需要通过 Longbridge SDK 设置
```

### 10.2 测试工具使用说明

**手动测试步骤**：
1. 使用 Postman 调用订单提交API
2. 检查数据库订单记录
3. 查看系统日志

**日志查看命令**：
```bash
# 查看持仓验证日志
grep "持仓验证" log.log

# 查看卖空检测日志
grep "卖空持仓" log.log

# 查看交易推送日志
grep "交易推送" log.log
```

---

**文档版本**：v1.0  
**创建时间**：2025-12-12  
**最后更新**：2025-12-12

