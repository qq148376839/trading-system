# 日志系统优化PRD检查报告

## 📋 检查信息
- **检查时间**：2025-12-16
- **检查范围**：PRD文档与实际项目代码对比
- **检查结果**：已修正所有发现的问题

---

## ✅ 已修正的问题

### 1. 前端依赖缺失
**问题**：PRD中使用了 `dayjs-timezone`，但前端 `package.json` 中未包含此依赖

**修正**：
- ✅ 在技术方案中添加了依赖安装说明
- ✅ 在验收标准中添加了依赖检查项
- ✅ 在迭代计划中标注了前置条件

**位置**：`5.2.4 日期快捷选择` 章节

---

### 2. API接口实现细节
**问题**：PRD中的接口实现直接使用了 `MODULE_MAPPINGS`，但该变量是私有的

**修正**：
- ✅ 修改为使用 `getAllModuleMappings()` 函数
- ✅ 添加了正确的导入语句说明
- ✅ 优化了模块查找逻辑（使用 Map 提高性能）

**位置**：`5.1.3 新增获取模块列表接口` 章节

---

### 3. Task_queues 模块映射不明确
**问题**：PRD中提到 `Task_queues` 但未说明其来源和映射目标

**修正**：
- ✅ 添加了问题分析：`Task_queues` 可能来自 `inferModuleFromPath` 函数的推断
- ✅ 提供了映射方案：映射到 `Strategy.Scheduler` 或创建新模块
- ✅ 添加了映射规则示例代码
- ✅ 在风险评估中添加了相关风险项

**位置**：
- `5.1.2 模块命名统一修复` 章节
- `9.2 需要添加映射的模块` 章节
- `6.1 技术风险` 章节

---

### 4. 查询兼容性处理缺失
**问题**：PRD中提到了向后兼容，但未提供具体的实现方案

**修正**：
- ✅ 添加了查询时的兼容性处理代码示例
- ✅ 说明支持同时查询旧格式（`Task_queues`）和新格式（`Task.Queues`）

**位置**：`5.1.2 模块命名统一修复` 章节

---

### 5. 前端API方法缺失
**问题**：PRD中前端调用了 `logsApi.getModules()`，但实际代码中未定义此方法

**修正**：
- ✅ 添加了前端API修改说明
- ✅ 提供了完整的 `getModules` 方法实现
- ✅ 在迭代计划中标注了需要修改的文件

**位置**：
- `5.2.1 模块下拉选择组件` 章节
- `7.1 MVP范围` 章节

---

### 6. 消息列展开/收起实现细节
**问题**：PRD中提到了展开/收起功能，但未说明当前代码使用的是 `ellipsis` 和 `Tooltip`

**修正**：
- ✅ 技术方案中已包含完整的实现代码
- ✅ 说明了需要添加状态管理（`expandedMessages`）
- ✅ 提供了完整的组件实现示例

**位置**：`5.2.3 消息列展开/收起` 章节

---

## 📝 需要进一步确认的事项

### 1. Task_queues 的实际来源 ✅ 已确认

**确认结果**：
- ✅ 通过 API 查询确认，所有 `Task_queues` 日志都是策略相关的日志
- ✅ 应该映射到 `Strategy.Scheduler`（策略调度器）
- ✅ 问题根源：`inferModuleFromPath` 函数没有处理下划线，导致推断出下划线格式的模块名称

**修复方案**：
- 参见 [Task_queues 模块问题修复指南](251216-TASK_QUEUES_MODULE_FIX.md)
- 添加 `normalizeModuleName` 函数进行模块名称标准化
- 修复 `inferModuleFromPath` 函数，统一将下划线转换为点号

---

### 2. 数据库索引优化
**建议**：确保 `system_logs` 表的 `module` 字段有索引

**操作**：
```sql
-- 检查索引
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'system_logs' AND indexdef LIKE '%module%';

-- 如果没有索引，创建索引
CREATE INDEX IF NOT EXISTS idx_system_logs_module ON system_logs(module);
```

---

### 3. 模块列表接口缓存
**建议**：考虑添加缓存机制，避免频繁查询数据库

**实现方案**：
- 使用内存缓存（如 Node.js 的 Map）
- 缓存时间：5分钟
- 缓存键：`modules_list`
- 缓存失效：当有新日志写入时（可选）

---

## 🎯 实施建议

### Phase 1 实施步骤
1. **确认 Task_queues 来源**（1小时）
   - 查询数据库，找出 `Task_queues` 的实际来源文件
   - 根据文件路径和功能决定映射目标

2. **后端开发**（1-2天）
   - 添加 `chineseName` 字段到映射规则
   - 实现 `getModuleChineseName` 函数
   - 添加 `Task_queues` 映射规则
   - 实现 `/api/logs/modules` 接口
   - 添加查询兼容性处理

3. **前端开发**（1-2天）
   - 安装 `dayjs-timezone` 依赖
   - 添加 `getModules` API 方法
   - 实现模块下拉选择组件
   - 实现模块中文名称展示

### Phase 2 实施步骤
1. **消息列优化**（0.5天）
   - 实现展开/收起功能
   - 添加状态管理

2. **日期快捷选择**（0.5天）
   - 配置 dayjs-timezone
   - 实现快捷选择按钮
   - 实现美股盘中时间计算

---

## 📊 检查总结

### 修正项统计
- ✅ 已修正问题：6项
- ⚠️ 需要确认事项：3项
- 📝 实施建议：已提供

### 文档质量
- ✅ 技术方案与实际代码一致
- ✅ 依赖和前置条件已明确
- ✅ 实施步骤清晰可执行
- ✅ 风险评估完整

### 下一步行动
1. 确认 `Task_queues` 的实际来源和功能
2. 开始 Phase 1 开发
3. 完成开发后进行功能测试
4. 更新文档中的实际映射规则

---

**检查完成时间**：2025-12-16  
**检查人**：AI Product Manager  
**文档状态**：已修正，可开始实施

