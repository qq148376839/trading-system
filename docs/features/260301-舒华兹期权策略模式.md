# 舒华兹期权策略模式 (OPTION_SCHWARTZ_V1)

## 概述
基于马丁·舒华兹 (Pit Bull) 交易哲学的期权策略，使用 10 日 EMA 硬过滤 + IV Rank 过滤 + 震荡区间检测 + 大赚后仓位缩减。

## 策略架构
- 独立策略类型 `OPTION_SCHWARTZ_V1`，与 `OPTION_INTRADAY_V1` 并列
- 复用 `optionRecommendationService` 基础信号 + 叠加 Schwartz 过滤层
- 独立 `strategy_id` 天然隔离日志/订单/PnL
- 独立资金池（`capital_allocation_id`），互不干扰

## 核心过滤器

### 1. 10 EMA 硬过滤
- CALL 信号：标的价格 < 10 EMA → 拒绝（无例外）
- PUT 信号：标的价格 > 10 EMA → 拒绝（无例外）
- |当前价 - EMA| / EMA < 0.3% → 缠绕区间，拒绝所有方向

### 2. IV Rank 过滤
- FULL 模式（>=30天历史）：ivRank > 60 → 拒绝买方
- FALLBACK 模式（<30天历史）：VIX > 25 且 contractIV > 0.8 → 拒绝
- 数据来源：`iv_history` 表，每日首次评估时自动采集

### 3. 震荡区间检测 (CHOP)
- 10MA 与 20MA 偏离度 < 0.5% → CHOP 区间
- CHOP 时入场门槛翻倍（30→60）

### 4. 仓位缩减
- 上笔盈利 > 30% → 仓位 × 0.5
- 连续 2 笔盈利 > 20% → 仓位 = 1 张

## 默认配置参数
| 参数 | 默认值 | 说明 |
|---|---|---|
| emaPeriod | 10 | EMA 计算周期 |
| emaWrapThreshold | 0.3% | EMA 缠绕判定阈值 |
| chopThreshold | 0.5% | MA 震荡判定阈值 |
| ivRankRejectThreshold | 60 | IV Rank 拒绝阈值 |
| ivFallbackRejectIV | 0.8 | 降级模式 IV 拒绝阈值 |
| bigWinThreshold | 30% | 大赚定义阈值 |
| directionalScoreMin | 30 | 入场最低分数（CHOP 时 60） |

## Schwartz vs Momentum 对比
| 维度 | Momentum | Schwartz |
|---|---|---|
| 趋势过滤 | VWAP 软过滤 | 10 EMA 硬过滤 |
| 入场门槛 | >15 | >30（CHOP >60） |
| 震荡过滤 | 无 | MA 缠绕检测 |
| IV 处理 | 仅 VIX | 个股 IV Rank |
| 仓位管理 | 固定 | 大赚后缩减 |

## 文件变更清单

### 新增文件
- `api/src/utils/ema.ts` — EMA/SMA 计算工具
- `api/src/services/schwartz-signal-filter.service.ts` — Schwartz 信号过滤服务
- `api/src/services/strategies/schwartz-option-strategy.ts` — Schwartz 策略类
- `api/migrations/015_iv_history.sql` — IV 历史表
- `frontend/app/quant/compare/page.tsx` — 策略对比页面

### 修改文件
- `api/migrations/000_init_schema.sql` — 新增 iv_history 表
- `api/src/services/strategy-scheduler.service.ts` — 注册 OPTION_SCHWARTZ_V1
- `api/src/utils/log-module-mapper.ts` — 新增模块映射
- `api/src/routes/quant.ts` — 策略对比 API
- `frontend/lib/api.ts` — 对比 API 客户端
- `frontend/app/quant/strategies/page.tsx` — 创建策略弹窗
- `frontend/components/EditStrategyModal.tsx` — 编辑策略弹窗
- `frontend/app/quant/strategies/[id]/page.tsx` — 策略详情页
- `frontend/app/quant/page.tsx` — 量化首页对比卡片

## 数据库变更
新增 `iv_history` 表，无需修改现有表结构。

## 日志标识
- 模块名：`Strategy.Schwartz` / `Strategy.Schwartz.Filter`
- 日志前缀：`[SCHWARTZ][symbol]`
- 信号格式：`[SCHWARTZ][TSLA.US信号] BUY_CALL | 得分=42.3 | EMA=✓ | IV=PASS(rank=35) | CHOP=✗`
