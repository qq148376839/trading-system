# SPX/USD/BTC 分时K线数据持久化存储

## 文档信息
- **创建时间**: 2026-02-18
- **更新时间**: 2026-02-18
- **状态**: 已完成

## 概述

实现 SPX、USD_INDEX、BTC 三大市场标的的 1 分钟 K 线数据持久化存储到 PostgreSQL。采集服务定时从 Moomoo API 获取数据并批量写入，查询服务支持分时数据读取、可用性检查和完整度查询。回测场景下可直接从 DB 读取历史分时数据，减少对实时 API 的依赖。

## 实现内容

### 1. 数据库设计

#### `market_kline_history` 表
- **主键**: `(source, symbol, timestamp)` — 自动去重
- **字段**: source, symbol, timestamp, open, high, low, close, volume, turnover, created_at
- **索引**: `idx_kline_source_symbol_time` (source, symbol, timestamp DESC)
- **分区**: 按 source 和时间范围查询优化

#### `kline_collection_status` 表
- **主键**: source
- **字段**: last_collection_time, records_collected, last_error, error_count, updated_at
- 记录每个 source 的采集健康状况

#### `system_config` 种子数据
- `kline_collection_enabled`: 采集开关（默认 true）
- `kline_collection_interval_minutes`: 采集间隔（默认 60 分钟）
- `kline_collection_sources`: 采集标的列表（默认 SPX,USD_INDEX,BTC）

### 2. 采集服务（kline-collection.service.ts）

**核心逻辑**:
- 启动时延迟 7 秒，等待数据库和 Moomoo 代理就绪
- 自适应采集间隔：
  - 交易时段（美东 9:30-16:00）: 每 60 分钟采集一次
  - 非交易时段: 每 240 分钟采集一次
- 对每个 source 调用 Moomoo API 获取当日 1m K 线数据
- 批量 upsert: `INSERT ... ON CONFLICT (source, symbol, timestamp) DO NOTHING`
- 采集完成后更新 `kline_collection_status` 表
- 错误处理: 单个 source 失败不影响其他 source，错误计数递增
- 数据清理: 定期清理超过保留天数（默认 90 天）的旧数据

### 3. 查询服务（kline-history.service.ts）

**方法列表**:
| 方法 | 参数 | 返回 | 用途 |
|------|------|------|------|
| `getIntradayData` | source, date? | K 线数组 | 获取指定日期分时数据 |
| `getIntradayByDate` | source, date | K 线数组 | 按日期精确查询 |
| `checkAvailability` | source, date | boolean | 检查某日数据是否可用 |
| `getCompleteness` | source, date | {count, firstTime, lastTime, coveragePercent} | 数据完整度分析 |

### 4. REST API（kline-history.ts）

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/kline-history/:source` | GET | 查询 K 线数据（支持 date 参数） |
| `/api/kline-history/status` | GET | 所有 source 的采集状态总览 |
| `/api/kline-history/health` | GET | 健康检查（采集服务是否运行） |
| `/api/kline-history/completeness/:source/:date` | GET | 指定 source 和日期的数据完整度 |
| `/api/kline-history/collect` | POST | 手动触发一次采集 |

### 5. 回测数据源优化

`market-data-cache.service.ts` 变更:
- 新增 `getHistoricalIntradayFromDB(source, date)` 方法
- `getHistoricalMarketData()` 在回测场景下优先从 DB 读取分时数据
- DB 无数据时自动 fallback 到原有 Moomoo API 链路
- 对调用方透明，无需修改上层逻辑

### 6. Server 集成

`server.ts` 变更:
- 注册 `/api/kline-history` 路由
- 启动时延迟 7s 调用 `klineCollectionService.start()`
- graceful shutdown 时调用 `klineCollectionService.stop()`

## 技术细节

### 数据流
```
Moomoo API (1m K线)
    |
    v
kline-collection.service.ts (定时采集)
    |
    v
PostgreSQL: market_kline_history (批量 upsert)
    |
    v
kline-history.service.ts (查询)
    |
    +---> routes/kline-history.ts (REST API)
    +---> market-data-cache.service.ts (回测数据源)
```

### 去重策略
- 使用 `ON CONFLICT (source, symbol, timestamp) DO NOTHING`
- 同一时间戳的数据只保留首次写入
- 重复采集不会产生重复记录

### 自适应间隔
```
美东时间 09:30-16:00 → 60 分钟间隔（交易时段数据更新频繁）
其他时段             → 240 分钟间隔（非交易时段节省 API 调用）
```

## 相关文档

- [CHANGELOG.md](../../CHANGELOG.md) — 2026-02-18 条目
- [CODE_MAP.md](../../CODE_MAP.md) — 新增文件的调用关系
