# 卖出价格错误修复 - 功能测试计划

## 📋 测试概述

**测试目标**：验证价格计算逻辑修复的正确性和完整性

**测试范围**：
- 平仓卖出价格计算
- 买入价格计算
- 做空价格计算
- 价格验证逻辑

**测试环境**：测试环境（建议先使用模拟数据）

---

## 1. 单元测试

### 1.1 TradingIntent接口测试

**测试用例1：sellPrice字段支持**
- **输入**：创建包含`sellPrice`的`TradingIntent`
- **预期**：`sellPrice`字段正确设置
- **验证**：检查字段值

**测试用例2：sellPrice可选性**
- **输入**：创建不包含`sellPrice`的`TradingIntent`
- **预期**：`sellPrice`为`undefined`，不报错
- **验证**：检查字段值

### 1.2 价格字段语义测试

**测试用例3：买入场景价格语义**
- **输入**：`action = 'BUY'`, `entryPrice = 150.50`
- **预期**：`entryPrice`正确作为买入价格
- **验证**：检查`entryPrice`值

**测试用例4：平仓场景价格语义**
- **输入**：`action = 'SELL'`, `entryPrice = 100`, `sellPrice = 105`
- **预期**：`entryPrice`用于记录买入价格，`sellPrice`用于提交订单
- **验证**：检查两个字段的值和用途

**测试用例5：做空场景价格语义**
- **输入**：`action = 'SELL'`, `entryPrice = 150`, 无`sellPrice`
- **预期**：`entryPrice`作为做空价格
- **验证**：检查`entryPrice`值

### 1.3 价格计算逻辑测试

**测试用例6：平仓卖出价格优先级**
- **输入**：`entryPrice = 100`, `sellPrice = 105`
- **预期**：优先使用`sellPrice`（105）
- **验证**：检查实际使用的价格

**测试用例7：做空卖出价格fallback**
- **输入**：`entryPrice = 150`, 无`sellPrice`
- **预期**：使用`entryPrice`（150）
- **验证**：检查实际使用的价格

### 1.4 价格验证逻辑测试

**测试用例8：卖出价格偏差超过20%**
- **输入**：`sellPrice = 100`, `currentPrice = 80`（偏差25%）
- **预期**：拒绝订单
- **验证**：检查返回的错误信息

**测试用例9：卖出价格偏差5%-20%**
- **输入**：`sellPrice = 100`, `currentPrice = 90`（偏差11.11%）
- **预期**：警告但允许提交
- **验证**：检查警告日志

**测试用例10：卖出价格偏差小于5%**
- **输入**：`sellPrice = 100`, `currentPrice = 98`（偏差2.04%）
- **预期**：通过验证
- **验证**：检查验证结果

**测试用例11：买入价格偏差超过5%**
- **输入**：`buyPrice = 100`, `currentPrice = 94`（偏差6.38%）
- **预期**：拒绝订单
- **验证**：检查返回的错误信息

**测试用例12：买入价格偏差1%-5%**
- **输入**：`buyPrice = 100`, `currentPrice = 97`（偏差3.09%）
- **预期**：警告但允许提交
- **验证**：检查警告日志

**测试用例13：买入价格偏差小于1%**
- **输入**：`buyPrice = 100`, `currentPrice = 99.5`（偏差0.5%）
- **预期**：通过验证
- **验证**：检查验证结果

### 1.5 边界情况测试

**测试用例14：entryPrice不存在时fallback**
- **输入**：`sellPrice = 105`, 无`entryPrice`
- **预期**：使用`sellPrice`作为fallback
- **验证**：检查实际使用的价格

**测试用例15：价格都不存在**
- **输入**：无`entryPrice`，无`sellPrice`
- **预期**：返回错误
- **验证**：检查错误信息

**测试用例16：价格小于等于0**
- **输入**：`sellPrice = 0`或负数
- **预期**：返回错误
- **验证**：检查错误信息

---

## 2. 集成测试

### 2.1 完整平仓卖出流程测试

**测试场景1：正常平仓卖出**
1. 创建持仓（`entryPrice = 100`）
2. 触发止盈卖出（`currentPrice = 105`）
3. 验证：
   - `sellIntent.entryPrice = 100`（实际买入价格）
   - `sellIntent.sellPrice = 105`（当前市场价格）
   - 订单提交价格 = 105
   - 日志记录正确

**测试场景2：价格获取失败处理**
1. 创建持仓（`entryPrice = 100`）
2. 模拟价格获取失败
3. 验证：
   - 使用`currentPrice`作为fallback
   - 记录警告日志
   - 不提交错误价格的订单

**测试场景3：entryPrice不存在**
1. 创建持仓（无`entryPrice`）
2. 触发卖出
3. 验证：
   - 使用`latestPrice`作为`entryPrice`的fallback
   - 记录警告日志
   - 订单正常提交

### 2.2 完整买入流程测试

**测试场景4：正常买入**
1. 生成买入信号（`entryPrice = 150`）
2. 执行买入
3. 验证：
   - `entryPrice`正确作为买入价格
   - 订单提交价格 = 150
   - 日志记录正确

**测试场景5：买入价格验证**
1. 生成买入信号（`entryPrice = 150`）
2. 当前市场价格 = 145（偏差3.45%）
3. 验证：
   - 记录警告日志
   - 订单正常提交

### 2.3 做空流程测试

**测试场景6：正常做空**
1. IDLE状态下生成SELL信号（`entryPrice = 150`）
2. 执行做空
3. 验证：
   - `entryPrice`正确作为做空价格
   - 订单提交价格 = 150
   - 日志记录正确

---

## 3. 回归测试

### 3.1 现有功能验证

**测试范围**：
- 所有使用`TradingIntent`的地方
- 所有调用`executeBuyIntent`的地方
- 所有调用`executeSellIntent`的地方
- 所有调用`processHoldingPosition`的地方

**测试重点**：
- 确保不影响现有功能
- 确保向后兼容性
- 确保价格计算正确

### 3.2 性能测试

**测试场景7：价格获取性能**
- **目标**：价格获取时间 ≤ 1秒
- **方法**：测量`getCurrentMarketPrice`执行时间
- **验证**：平均响应时间符合要求

**测试场景8：价格验证性能**
- **目标**：价格验证时间 ≤ 100ms
- **方法**：测量价格验证逻辑执行时间
- **验证**：平均响应时间符合要求

---

## 4. 测试数据准备

### 4.1 测试用例数据

**买入测试数据**：
```typescript
{
  symbol: 'AAPL.US',
  entryPrice: 150.50,
  quantity: 10,
  currentPrice: 150.00, // 偏差0.33%
}
```

**平仓卖出测试数据**：
```typescript
{
  symbol: 'AAPL.US',
  entryPrice: 100,      // 实际买入价格
  sellPrice: 105,       // 当前市场价格
  quantity: 10,
  currentPrice: 105,
}
```

**做空测试数据**：
```typescript
{
  symbol: 'AAPL.US',
  entryPrice: 150,      // 做空价格
  quantity: 10,
  currentPrice: 150,
}
```

### 4.2 Mock数据

**价格获取Mock**：
```typescript
jest.mock('../config/longport', () => ({
  getQuoteContext: jest.fn(() => ({
    quote: jest.fn(() => Promise.resolve([
      { lastDone: 150.00 }
    ]))
  }))
}));
```

---

## 5. 测试执行计划

### 5.1 第一阶段：单元测试（1小时）

1. 运行所有单元测试
2. 验证接口和逻辑正确性
3. 修复发现的bug

### 5.2 第二阶段：集成测试（2小时）

1. 运行完整流程测试
2. 验证端到端功能
3. 验证价格计算准确性

### 5.3 第三阶段：回归测试（1小时）

1. 运行回归测试套件
2. 验证现有功能不受影响
3. 性能测试

### 5.4 第四阶段：生产环境验证（持续监控）

1. 部署到生产环境
2. 监控价格计算日志
3. 验证实际订单价格正确性

---

## 6. 测试验收标准

### 6.1 功能验收

- [ ] 所有单元测试通过（覆盖率 ≥ 80%）
- [ ] 所有集成测试通过
- [ ] 所有回归测试通过
- [ ] 价格计算逻辑正确
- [ ] 价格验证逻辑正确

### 6.2 性能验收

- [ ] 价格获取时间 ≤ 1秒
- [ ] 价格验证时间 ≤ 100ms
- [ ] 订单提交时间无明显增加

### 6.3 质量验收

- [ ] 日志记录完整
- [ ] 错误处理正确
- [ ] 代码质量符合规范

---

## 7. 测试报告模板

### 7.1 测试结果汇总

| 测试类型 | 测试用例数 | 通过数 | 失败数 | 通过率 |
|---------|-----------|--------|--------|--------|
| 单元测试 | 16 | - | - | - |
| 集成测试 | 8 | - | - | - |
| 回归测试 | - | - | - | - |

### 7.2 问题记录

| 问题ID | 描述 | 严重程度 | 状态 | 修复时间 |
|--------|------|---------|------|---------|
| - | - | - | - | - |

---

## 8. 测试工具和环境

### 8.1 测试工具

- **单元测试框架**：Jest
- **集成测试**：Jest + Supertest
- **Mock工具**：Jest Mock

### 8.2 测试环境

- **开发环境**：本地开发环境
- **测试环境**：测试服务器
- **生产环境**：生产服务器（验证阶段）

---

**测试计划创建时间**：2025-12-09  
**测试执行时间**：待定  
**测试负责人**：开发团队

