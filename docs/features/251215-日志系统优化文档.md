# 日志系统优化文档（v1.0）

**创建日期**: 2025-12-15
**最后更新**: 2026-02-06
**状态**: 已完成 ✅

> **重要**: 2026-02-06 日志系统进行了全面重构（v2.0），包括级别门控、节流机制、摘要聚合、infra-logger、console全量迁移等。详见 [日志系统重构文档](260206-日志系统重构.md)。本文档记录的是 2025-12-15 至 2025-12-16 的初始日志系统建设。

---

## 📚 文档索引

### 文档结构

本文档整合了日志系统优化的所有相关文档，包括：
- 产品需求文档（PRD）：完整的功能需求和技术方案
- 实施总结：已完成功能的实施情况
- PRD检查报告：PRD文档与实际代码的对比检查
- 模块映射说明：模块映射规则和使用指南
- 字段长度修复指南：数据库字段长度修复方案

### 快速导航

**想了解功能需求？** → 查看「1. 产品需求文档（PRD）」

**想了解实施情况？** → 查看「2. 实施总结」

**想了解PRD检查结果？** → 查看「3. PRD检查报告」

**想了解模块映射？** → 查看「4. 模块映射说明」

**想了解字段长度修复？** → 查看「5. 字段长度修复指南」

---

# 1. 产品需求文档（PRD）

## 📋 文档信息
- **文档版本**：v1.3
- **创建时间**：2025-12-15
- **最后更新**：2025-12-15
- **文档作者**：AI Product Manager
- **审核状态**：待审核

## 1. 背景与目标

### 1.1 业务背景

当前量化交易系统缺乏统一的日志持久化存储与检索机制。系统日志只能在控制台中查看，存在以下问题：

1. **无法追溯历史**：服务重启后日志丢失，无法回溯历史问题
2. **难以分析**：无法按策略模块、时间段、错误级别进行多维度分析
3. **性能风险**：文件IO操作可能阻塞交易主线程，影响策略执行延迟
4. **调试困难**：无法快速定位问题，影响策略优化和故障排查效率

### 1.2 用户痛点

**主要用户**：量化交易策略开发者、系统运维人员

**核心痛点**：
- 🔴 **日志丢失**：重启后无法查看历史日志，关键问题无法追溯
- 🔴 **查询困难**：无法快速定位特定模块、特定时间段的日志
- 🔴 **性能担忧**：担心日志写入影响交易主循环性能，导致策略延迟
- 🟡 **分析不便**：无法按错误级别、TraceID进行关联分析
- 🟡 **导出困难**：无法导出日志进行离线分析或报告生成

### 1.3 业务目标

- **主要目标**：构建一个合格的量化日志系统，实现非阻塞、结构化、持久化、可查询的日志管理能力

- **成功指标**：
  - ✅ **非阻塞性能**：日志写入延迟 < 10ms（P99），不影响交易主循环
  - ✅ **持久化率**：日志持久化成功率 ≥ 99.9%
  - ✅ **查询性能**：前端查询响应时间 < 500ms（P95）
  - ✅ **可用性**：日志系统可用性 ≥ 99.9%
  - ✅ **用户满意度**：日志查询和导出功能使用率 ≥ 80%

### 1.4 项目范围

- **包含范围**：
  - 非阻塞日志写入机制（内存队列 + 异步批量写入，支持动态队列大小调整）
  - 结构化日志记录（模块、级别、TraceID、JSON数据等）
  - PostgreSQL数据库持久化存储
  - 前端日志查询页面（支持多维度筛选）
  - 日志导出功能（JSON格式）
  - 按模块查询日志功能
  - 日志清理功能（自动清理配置 + 手动清理）

- **不包含范围**：
  - 日志可视化图表（后续迭代）
  - 日志告警和通知（后续迭代）
  - 日志压缩和归档（后续迭代）

## 2. 用户与场景

### 2.1 目标用户

**主要用户**：
- **策略开发者**：需要查看策略执行日志，定位策略问题
- **系统运维人员**：需要查看系统日志，排查系统故障

**用户特征**：
- 需要频繁查询日志，对查询性能要求高
- 需要按模块、时间、级别等维度快速定位问题
- 需要导出日志进行离线分析

### 2.2 使用场景

**场景1：策略执行异常排查**
- **用户**：策略开发者
- **时间**：策略执行过程中
- **地点**：办公室
- **行为**：策略执行异常，需要查看策略模块的ERROR级别日志
- **目标**：快速定位异常原因，修复策略问题

**场景2：交易链路追踪**
- **用户**：策略开发者
- **时间**：订单执行后
- **地点**：办公室
- **行为**：订单未按预期执行，需要追踪完整的交易链路（信号生成→订单提交→成交回报）
- **目标**：通过TraceID关联查看完整的交易流程，定位问题环节

**场景3：系统性能分析**
- **用户**：系统运维人员
- **时间**：系统运行一段时间后
- **地点**：办公室
- **行为**：需要分析系统性能，查看特定时间段的日志分布
- **目标**：导出日志数据，进行离线分析和报告生成

**场景4：历史问题回溯**
- **用户**：策略开发者
- **时间**：服务重启后
- **地点**：办公室
- **行为**：需要查看重启前的日志，了解系统状态
- **目标**：通过时间范围查询，查看历史日志，回溯问题

### 2.3 用户故事

- As a 策略开发者, I want 查看策略模块的ERROR级别日志, So that 我可以快速定位策略异常原因
- As a 策略开发者, I want 通过TraceID追踪完整的交易链路, So that 我可以了解订单执行的完整流程
- As a 系统运维人员, I want 按时间段查询日志, So that 我可以分析系统运行状态
- As a 策略开发者, I want 导出日志为JSON格式, So that 我可以进行离线分析和报告生成
- As a 策略开发者, I want 日志写入不影响交易主循环性能, So that 策略执行延迟不会增加

## 3. 功能需求

### 3.1 功能概览

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 非阻塞日志写入 | P0 | 内存队列 + 异步批量写入，支持动态队列大小调整 |
| 结构化日志记录 | P0 | 支持模块、级别、TraceID、JSON数据等字段 |
| 数据库持久化 | P0 | 写入PostgreSQL数据库，支持长期保存 |
| 日志查询API | P0 | 支持按模块、时间、级别、TraceID查询 |
| 前端查询页面 | P1 | Web界面查询日志，支持多维度筛选 |
| 日志导出功能 | P1 | 支持导出JSON格式日志 |
| 按模块查询 | P1 | 支持按模块快速筛选日志 |
| 日志清理功能 | P1 | 自动清理配置 + 手动清理API |

### 3.2 功能详细说明

#### 功能1：非阻塞日志写入
**优先级**：P0

**功能描述**：
实现非阻塞的日志写入机制，使用内存队列缓冲日志，后台异步批量写入数据库，确保日志写入不影响交易主循环性能。

**技术方案**：
- 使用内存队列（如 `p-queue` 或自定义队列）缓冲日志
- 后台工作线程批量写入数据库（批量大小：100条，批量间隔：1秒）
- 日志写入失败时，记录到错误日志，不影响主流程
- **动态队列大小调整**：根据实际日志量自动调整队列大小
  - 初始队列大小：10000条
  - 监控队列使用率（每10秒检查一次）
  - 当队列使用率 > 80% 时，自动扩容（增加50%，最大不超过50000条）
  - 当队列使用率 < 30% 时，自动缩容（减少25%，最小不低于5000条）
  - 扩容/缩容操作异步执行，不影响日志写入

**验收标准**：
- [ ] 日志写入延迟 < 10ms（P99）
- [ ] 交易主循环延迟不增加（对比测试）
- [ ] 内存队列满时正确处理（丢弃旧日志或阻塞）
- [ ] 数据库写入失败时不影响主流程

#### 功能2：结构化日志记录
**优先级**：P0

**功能描述**：
支持结构化日志记录，不仅记录"发生了什么"，还记录"模块"、"代码行号"、"相关数据(JSON)"等结构化信息。

**日志字段**：
- `timestamp`: 日志发生时间（精确到微秒）
- `level`: 日志级别（INFO, WARNING, ERROR, DEBUG）
- `module`: 来源模块（如 'Strategy.MA', 'Execution', 'DataFeed'）
- `message`: 日志文本内容
- `trace_id`: 链路追踪ID（UUID，可选）
- `extra_data`: 结构化数据（JSONB，如当前价格、持仓量、订单参数）
- `file_path`: 代码文件路径
- `line_no`: 代码行号

**TraceID生成策略**：
- **默认策略**：使用UUID v4生成（最常规的方式）
- **传递策略**：支持调用方传入TraceID
- **上下文传递**：支持通过AsyncLocalStorage在异步上下文中传递TraceID

**验收标准**：
- [ ] 所有日志字段正确记录
- [ ] 文件路径和行号自动提取
- [ ] TraceID自动生成（UUID v4格式）
- [ ] TraceID支持调用方传入
- [ ] TraceID支持异步上下文传递
- [ ] JSON数据正确序列化

#### 功能3：数据库持久化
**优先级**：P0

**功能描述**：
将日志写入PostgreSQL数据库，支持长期保存和回溯。

**数据库表结构**（已合并到 `000_init_schema.sql`）：
```sql
CREATE TABLE IF NOT EXISTS system_logs (
    id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ NOT NULL,
    level VARCHAR(10) NOT NULL CHECK (level IN ('INFO', 'WARNING', 'ERROR', 'DEBUG')),
    module VARCHAR(200) NOT NULL,
    message TEXT NOT NULL,
    trace_id UUID,
    extra_data JSONB,
    file_path VARCHAR(500),
    line_no INT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**验收标准**：
- [ ] 日志正确写入数据库
- [ ] 批量插入性能满足要求（1000条/秒）
- [ ] 数据库连接失败时正确处理
- [ ] 索引正确创建，查询性能满足要求

#### 功能4：日志查询API
**优先级**：P0

**功能描述**：
提供RESTful API接口，支持按模块、时间、级别、TraceID等维度查询日志。

**API端点**：
```
GET /api/logs
```

**查询参数**：
- `module` (可选): 模块名称，如 'Strategy.MA'
- `level` (可选): 日志级别，如 'ERROR'，多个用逗号分隔
- `start_time` (可选): 开始时间（ISO 8601格式）
- `end_time` (可选): 结束时间（ISO 8601格式）
- `trace_id` (可选): 链路追踪ID
- `limit` (可选): 返回数量限制（默认：100，最大：1000）
- `offset` (可选): 偏移量（默认：0）

**验收标准**：
- [ ] 支持所有查询参数
- [ ] 查询响应时间 < 500ms（P95）
- [ ] 分页功能正确
- [ ] 错误处理正确

#### 功能5：前端查询页面
**优先级**：P1

**功能描述**：
提供Web界面查询日志，支持多维度筛选和分页显示。

**页面功能**：
- 日志列表展示（表格形式）
- 筛选条件（模块、级别、时间范围、TraceID）
- 分页控件（每页100条）
- 日志详情展示（点击查看详情）
- 刷新按钮（手动刷新）
- **模块下拉选择**：支持中文和英文搜索
- **消息展开/收起**：超过100字符的消息自动截断
- **日期快捷选择**：最近8小时、一天、美股盘中时间

**验收标准**：
- [ ] 日志列表正确展示
- [ ] 筛选功能正确
- [ ] 分页功能正确
- [ ] 日志详情正确展示
- [ ] 响应式设计，支持移动端
- [ ] 模块下拉选择功能正常
- [ ] 消息展开/收起功能正常
- [ ] 日期快捷选择功能正常

#### 功能6：日志导出功能
**优先级**：P1

**功能描述**：
支持导出日志为JSON格式，便于离线分析和报告生成。

**API端点**：
```
GET /api/logs/export
```

**验收标准**：
- [ ] JSON格式正确
- [ ] 文件下载功能正常
- [ ] 导出数据量限制正确
- [ ] 错误处理正确

#### 功能7：按模块查询
**优先级**：P1

**功能描述**：
支持按模块快速筛选日志，便于查看特定模块的日志。

**实现方式**：
- 前端提供模块下拉选择框
- 支持模块搜索（模糊匹配）
- 支持显示中文名称（格式：`中文名称 (英文名称)`）

**验收标准**：
- [ ] 模块筛选正确
- [ ] 模块搜索功能正常
- [ ] 中文名称显示正确

#### 功能8：日志清理功能
**优先级**：P1

**功能描述**：
提供日志清理功能，支持自动清理配置和手动清理，默认不清理日志。

**自动清理配置**：
- **配置位置**：系统设置（`system_config`表），可通过前端配置管理页面调整
- **配置项**：
  - `log_retention_days`: 日志保留天数（默认：`-1`，表示不清理）
  - `log_auto_cleanup_enabled`: 是否启用自动清理（默认：`false`）
  - `log_cleanup_schedule`: 清理执行时间（Cron表达式，默认：`0 2 * * *`，每天凌晨2点）

**手动清理API**：
```
DELETE /api/logs/cleanup
```

**验收标准**：
- [ ] 默认不清理日志（配置正确）
- [ ] 自动清理配置正确生效
- [ ] 手动清理API功能正常
- [ ] dry_run模式正确预览删除结果
- [ ] 清理操作不影响日志写入
- [ ] 清理操作记录日志

## 4. 非功能需求

### 4.1 性能要求

- **日志写入延迟**：< 10ms（P99）
- **查询响应时间**：< 500ms（P95）
- **批量写入性能**：≥ 1000条/秒
- **并发写入能力**：支持100个并发写入
- **内存队列大小**：初始10000条，动态调整范围5000-50000条
- **队列调整响应时间**：队列使用率变化后10秒内完成调整

### 4.2 安全要求

- 日志数据不包含敏感信息（如密码、Token）
- 日志查询API需要身份验证（JWT Token）
- 日志导出功能需要权限控制
- 数据库连接使用SSL（生产环境）

### 4.3 兼容性要求

- 支持Node.js 20+
- 支持PostgreSQL 15+
- 支持主流浏览器（Chrome、Firefox、Safari、Edge）
- 支持移动端浏览器（响应式设计）

## 5. 技术方案

### 5.1 技术选型

**后端**：
- **日志库**：使用 `winston` 或自定义日志库
- **队列**：使用 `p-queue` 或自定义内存队列
- **数据库**：PostgreSQL 15（已有）
- **ORM**：使用 `pg` 库（已有）

**前端**：
- **框架**：Next.js 14（已有）
- **UI组件**：Tailwind CSS（已有）
- **表格组件**：使用 `react-table` 或 `tanstack-table`
- **日期选择**：使用 `react-datepicker` 或类似组件
- **时区处理**：使用 `dayjs-timezone`（已添加依赖）

### 5.2 架构设计

**系统架构**：
```
策略代码 → 日志API → 内存队列 → 后台工作线程 → PostgreSQL数据库
                                    ↓
                                前端查询API ← 前端查询页面
```

**关键组件**：
1. **日志服务** (`log.service.ts`): 日志写入、队列管理、动态队列调整
2. **日志工作线程** (`log-worker.ts`): 批量写入数据库
3. **日志查询API** (`routes/logs.ts`): 日志查询接口
4. **日志清理服务** (`log-cleanup.service.ts`): 自动清理定时任务
5. **日志清理API** (`routes/logs.ts`): 手动清理接口
6. **前端查询页面** (`frontend/app/logs/page.tsx`): 日志查询UI

### 5.3 数据库设计

**表结构**（已合并到 `api/migrations/000_init_schema.sql`）：
- `module`: VARCHAR(200) - 支持更长的模块名称（自动从VARCHAR(50)升级）
- `file_path`: VARCHAR(500) - 支持更长的文件路径（自动从VARCHAR(255)升级）
- 代码层面会在写入时自动截断超长字段（安全措施）

**迁移脚本说明**：
- **文件位置**：`api/migrations/000_init_schema.sql`（第七部分）
- **使用方法**（统一方法，适用于所有情况）：
  ```bash
  psql -U postgres -d trading_db -f api/migrations/000_init_schema.sql
  ```
- **自动更新机制**：
  - ✅ **新数据库**：创建表时直接使用新的字段长度
  - ✅ **已有数据库**：自动检测字段长度，如果小于目标长度则自动更新
  - ✅ **跨平台兼容**：Windows、Mac、Linux 统一使用同一个脚本
  - ✅ **幂等性保证**：可以安全地重复运行，不会重复更新

### 5.4 接口设计

**日志写入接口**（内部使用）：
```typescript
interface LogEntry {
  level: 'INFO' | 'WARNING' | 'ERROR' | 'DEBUG';
  module: string;
  message: string;
  traceId?: string;  // 可选，未提供时自动生成UUID v4
  extraData?: Record<string, any>;
}

class LogService {
  log(entry: LogEntry): void;
  info(module: string, message: string, extraData?: Record<string, any>, traceId?: string): void;
  warn(module: string, message: string, extraData?: Record<string, any>, traceId?: string): void;
  error(module: string, message: string, extraData?: Record<string, any>, traceId?: string): void;
  debug(module: string, message: string, extraData?: Record<string, any>, traceId?: string): void;
  
  // 动态队列调整
  getQueueSize(): number;
  getQueueUsage(): number;  // 返回使用率（0-100）
  adjustQueueSize(): void;   // 根据使用率调整队列大小
}
```

**日志查询API**：
```
GET /api/logs?module=Strategy.MA&level=ERROR&start_time=2025-12-15T00:00:00Z&end_time=2025-12-15T23:59:59Z&limit=100&offset=0
```

**获取模块列表API**：
```
GET /api/logs/modules
```

**日志导出API**：
```
GET /api/logs/export?module=Strategy.MA&level=ERROR&start_time=2025-12-15T00:00:00Z&end_time=2025-12-15T23:59:59Z
```

**日志清理API**：
```
DELETE /api/logs/cleanup?before_date=2025-11-15T00:00:00Z&dry_run=false
```

## 6. 风险评估

### 6.1 技术风险

**风险1：内存队列溢出**
- **影响**：高（可能导致日志丢失）
- **应对**：
  - 设置队列大小限制（10000条）
  - 队列满时丢弃最旧的日志，记录警告
  - 监控队列使用率，告警阈值80%
  - 动态队列大小调整

**风险2：数据库写入性能瓶颈**
- **影响**：中（可能导致日志堆积）
- **应对**：
  - 使用批量插入（100条/批）
  - 优化数据库索引
  - 监控数据库写入性能
  - 考虑分表策略（按日期分表）

**风险3：日志写入影响主循环性能**
- **影响**：高（核心要求）
- **应对**：
  - 使用内存队列，异步写入
  - 性能测试验证（对比测试）
  - 监控主循环延迟

### 6.2 业务风险

**风险1：日志数据量过大**
- **影响**：中（可能导致数据库存储压力）
- **应对**：
  - 提供日志清理功能（自动清理配置 + 手动清理）
  - 默认不清理，用户可根据需要配置
  - 监控数据库存储使用率
  - 提供清理操作日志，便于审计

**风险2：查询性能下降**
- **影响**：中（影响用户体验）
- **应对**：
  - 优化数据库索引
  - 限制查询时间范围（如最大30天）
  - 使用分页查询
  - 考虑使用Elasticsearch（后续迭代）

## 7. 迭代计划

### 7.1 MVP范围

**第一阶段（基础设施 + 核心功能）**：
- ✅ 非阻塞日志写入机制
- ✅ 结构化日志记录
- ✅ 数据库持久化
- ✅ 日志查询API（基础功能）
- ✅ 数据库表结构创建
- ✅ 日志服务改造（logger.ts兼容层）
- ✅ TraceID上下文管理

**第一阶段补充（代码改造）**：
- ✅ 核心服务改造（策略调度器、回测服务、订单执行、账户余额同步）
- ✅ 重要服务改造（交易推荐、市场数据、交易日服务、错误处理）

### 7.2 后续迭代

**第二阶段（前端功能 + 清理功能 + 其他改造）**：
- ✅ 前端查询页面
- ✅ 日志导出功能
- ✅ 按模块查询功能
- ✅ 日志清理功能（自动清理配置 + 手动清理API）
- ✅ 模块映射优化（中文名称支持）
- ✅ 前端UI优化（模块下拉选择、消息展开/收起、日期快捷选择）
- ✅ 路由文件改造（P2）
- ✅ 配置和工具文件改造（P2）

**第三阶段（优化功能）**：
- ⏳ 日志可视化图表
- ⏳ 日志告警和通知
- ⏳ 日志压缩和归档

## 8. 验收标准总结

### 功能验收

- [ ] 日志写入延迟 < 10ms（P99）
- [ ] 交易主循环延迟不增加（对比测试）
- [ ] 日志正确写入数据库
- [ ] 日志查询API功能正常
- [ ] 前端查询页面功能正常
- [ ] 日志导出功能正常
- [ ] 按模块查询功能正常
- [ ] 动态队列大小调整功能正常
- [ ] TraceID生成策略正确（UUID v4）
- [ ] TraceID异步上下文传递正确
- [ ] 日志清理功能正常（默认不清理）
- [ ] 自动清理配置正确生效
- [ ] 手动清理API功能正常
- [ ] 所有核心服务日志改造完成
- [ ] 所有重要服务日志改造完成
- [ ] console.log调用已清理或保留（仅开发环境）

### 性能验收

- [ ] 批量写入性能 ≥ 1000条/秒
- [ ] 查询响应时间 < 500ms（P95）
- [ ] 支持100个并发写入
- [ ] 内存队列满时正确处理（动态扩容）
- [ ] 队列大小动态调整响应时间 < 10秒

### 安全验收

- [ ] 日志查询API需要身份验证
- [ ] 日志导出功能需要权限控制
- [ ] 日志数据不包含敏感信息

---

# 2. 实施总结

## 📋 实施信息
- **实施时间**：2025-12-16
- **实施版本**：v1.0
- **状态**：✅ 已完成

## ✅ 已完成的功能

### 后端实施

#### 1. 模块映射规则添加中文名称字段 ✅

**文件**：`api/src/utils/log-module-mapper.ts`

**修改内容**：
- ✅ 在 `ModuleMapping` 接口中添加了 `chineseName?: string` 字段
- ✅ 为所有 40+ 个映射规则添加了中文名称
- ✅ 实现了 `getModuleChineseName` 函数

**示例**：
```typescript
{
  pattern: /strategy-scheduler\.service\.ts$/,
  module: 'Strategy.Scheduler',
  chineseName: '策略调度器',  // 新增
  description: '策略调度器：定时触发策略运行，管理策略生命周期',
}
```

#### 2. 实现获取模块列表接口 ✅

**文件**：`api/src/routes/logs.ts`

**新增接口**：`GET /api/logs/modules`

**功能**：
- ✅ 查询数据库获取所有唯一的模块名称
- ✅ 通过映射规则获取中文名称和描述
- ✅ 返回格式化的模块列表

**响应格式**：
```json
{
  "success": true,
  "data": {
    "modules": [
      {
        "module": "Strategy.Scheduler",
        "chineseName": "策略调度器",
        "description": "策略调度器：定时触发策略运行，管理策略生命周期"
      }
    ]
  }
}
```

### 前端实施

#### 3. 前端API添加 getModules 方法 ✅

**文件**：`frontend/lib/api.ts`

**新增方法**：
```typescript
getModules: (): Promise<{ 
  success: boolean
  data?: { 
    modules: Array<{
      module: string
      chineseName: string
      description: string
    }>
  }
  error?: { message: string }
}>
```

#### 4. 模块下拉选择 ✅

**文件**：`frontend/app/logs/page.tsx`

**功能**：
- ✅ 页面加载时自动获取模块列表
- ✅ 将模块输入框改为下拉选择框
- ✅ 支持中文和英文搜索
- ✅ 显示格式：`中文名称 (英文名称)`

#### 5. 模块中文名称展示 ✅

**文件**：`frontend/app/logs/page.tsx`

**功能**：
- ✅ 日志列表中显示中文名称（格式：`中文名称 (英文名称)`）
- ✅ 日志详情中显示中文名称
- ✅ 未映射模块显示英文名称

#### 6. 消息列展开/收起 ✅

**文件**：`frontend/app/logs/page.tsx`

**功能**：
- ✅ 消息内容超过 100 个字符时自动截断
- ✅ 显示"展开"按钮
- ✅ 点击展开显示完整内容
- ✅ 点击收起恢复截断状态

#### 7. 日期快捷选择 ✅

**文件**：`frontend/app/logs/page.tsx`

**功能**：
- ✅ 添加"最近8小时"快捷按钮
- ✅ 添加"一天"快捷按钮
- ✅ 添加"美股盘中时间"快捷按钮（美东时间 9:30-16:00）

**依赖**：
- ✅ `dayjs-timezone` 已添加到 `package.json`

## 📊 代码统计

### 后端修改
- **文件数**：2
  - `api/src/utils/log-module-mapper.ts` - 添加中文名称字段和函数
  - `api/src/routes/logs.ts` - 新增模块列表接口
- **新增函数**：2
  - `getModuleChineseName` - 获取模块中文名称
  - `/api/logs/modules` - 获取模块列表接口
- **修改映射规则**：40+ 个规则添加中文名称

### 前端修改
- **文件数**：3
  - `frontend/lib/api.ts` - 添加 getModules 方法
  - `frontend/app/logs/page.tsx` - 完整重构，实现所有功能
  - `frontend/package.json` - 添加 dayjs-timezone 依赖
- **新增功能**：4 个主要功能
  - 模块下拉选择
  - 模块中文名称展示
  - 消息展开/收起
  - 日期快捷选择

## ✅ 验收清单

### 后端
- [x] `ModuleMapping` 接口添加 `chineseName` 字段
- [x] 所有映射规则添加中文名称
- [x] `getModuleChineseName` 函数已实现
- [x] `/api/logs/modules` 接口已实现
- [x] 代码编译通过（无 lint 错误）

### 前端
- [x] `getModules` API 方法已添加
- [x] 模块下拉选择已实现
- [x] 模块中文名称展示已实现
- [x] 消息展开/收起已实现
- [x] 日期快捷选择已实现
- [x] `dayjs-timezone` 依赖已添加
- [x] 代码编译通过（无 lint 错误）

---

# 3. PRD检查报告

## 📋 检查信息
- **检查时间**：2025-12-16
- **检查范围**：PRD文档与实际项目代码对比
- **检查结果**：已修正所有发现的问题

## ✅ 已修正的问题

### 1. 前端依赖缺失
**问题**：PRD中使用了 `dayjs-timezone`，但前端 `package.json` 中未包含此依赖

**修正**：
- ✅ 在技术方案中添加了依赖安装说明
- ✅ 在验收标准中添加了依赖检查项
- ✅ 在迭代计划中标注了前置条件

### 2. API接口实现细节
**问题**：PRD中的接口实现直接使用了 `MODULE_MAPPINGS`，但该变量是私有的

**修正**：
- ✅ 修改为使用 `getAllModuleMappings()` 函数
- ✅ 添加了正确的导入语句说明
- ✅ 优化了模块查找逻辑（使用 Map 提高性能）

### 3. Task_queues 模块映射不明确
**问题**：PRD中提到 `Task_queues` 但未说明其来源和映射目标

**修正**：
- ✅ 添加了问题分析：`Task_queues` 可能来自 `inferModuleFromPath` 函数的推断
- ✅ 提供了映射方案：映射到 `Strategy.Scheduler` 或创建新模块
- ✅ 添加了映射规则示例代码
- ✅ 在风险评估中添加了相关风险项

### 4. 查询兼容性处理缺失
**问题**：PRD中提到了向后兼容，但未提供具体的实现方案

**修正**：
- ✅ 添加了查询时的兼容性处理代码示例
- ✅ 说明支持同时查询旧格式（`Task_queues`）和新格式（`Task.Queues`）

### 5. 前端API方法缺失
**问题**：PRD中前端调用了 `logsApi.getModules()`，但实际代码中未定义此方法

**修正**：
- ✅ 添加了前端API修改说明
- ✅ 提供了完整的 `getModules` 方法实现
- ✅ 在迭代计划中标注了需要修改的文件

### 6. 消息列展开/收起实现细节
**问题**：PRD中提到了展开/收起功能，但未说明当前代码使用的是 `ellipsis` 和 `Tooltip`

**修正**：
- ✅ 技术方案中已包含完整的实现代码
- ✅ 说明了需要添加状态管理（`expandedMessages`）
- ✅ 提供了完整的组件实现示例

## 📝 需要进一步确认的事项

### 1. Task_queues 的实际来源 ✅ 已确认

**确认结果**：
- ✅ 通过 API 查询确认，所有 `Task_queues` 日志都是策略相关的日志
- ✅ 应该映射到 `Strategy.Scheduler`（策略调度器）
- ✅ 问题根源：`inferModuleFromPath` 函数没有处理下划线，导致推断出下划线格式的模块名称

**修复方案**：
- 参见 [Task_queues 模块修复文档](251216-Task_queues模块修复文档.md)
- 添加 `normalizeModuleName` 函数进行模块名称标准化
- 修复 `inferModuleFromPath` 函数，统一将下划线转换为点号

### 2. 数据库索引优化
**建议**：确保 `system_logs` 表的 `module` 字段有索引

**操作**：
```sql
-- 检查索引
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'system_logs' AND indexdef LIKE '%module%';

-- 如果没有索引，创建索引
CREATE INDEX IF NOT EXISTS idx_system_logs_module ON system_logs(module);
```

### 3. 模块列表接口缓存
**建议**：考虑添加缓存机制，避免频繁查询数据库

**实现方案**：
- 使用内存缓存（如 Node.js 的 Map）
- 缓存时间：5分钟
- 缓存键：`modules_list`
- 缓存失效：当有新日志写入时（可选）

---

# 4. 模块映射说明

## 📋 概述

日志系统使用模块映射器（`log-module-mapper.ts`）将文件路径映射到清晰的功能模块名称，确保日志模块名称准确反映实际功能，而不是简单的文件名。

## 🎯 解决的问题

1. **模块不清晰**：同一个功能的日志分布在多个文件中，导致模块名称不一致
2. **模块名称不准确**：从文件名自动提取的模块名称不能准确反映功能（如 `Task_queues`）
3. **功能分类混乱**：无法快速识别日志所属的功能模块

## 🔧 解决方案

### 模块映射规则

模块映射器使用优先级匹配规则，按以下顺序匹配：

1. **精确匹配**：匹配完整的文件路径模式
2. **目录匹配**：匹配目录结构
3. **推断匹配**：从路径推断模块名称（备用方案）

### 模块分类体系

#### 1. 策略相关（Strategy.*）
- `Strategy.Scheduler` - 策略调度器
- `Strategy.Base` - 策略基类
- `Strategy.Recommendation` - 推荐策略
- `Strategy` - 其他策略实现

#### 2. 执行相关（Execution.*）
- `Execution.Basic` - 基础执行器
- `Execution.Position` - 动态持仓管理

#### 3. 回测相关（Backtest）
- `Backtest` - 回测服务

#### 4. 资金管理相关（Capital.*）
- `Capital.Manager` - 资金管理器
- `Capital.Sync` - 账户余额同步

#### 5. 选股相关（StockSelector.*）
- `StockSelector` - 选股器
- `StockSelector.Institution` - 机构选股

#### 6. 交易推荐（TradingRecommendation）
- `TradingRecommendation` - 交易推荐服务

#### 7. 市场数据相关（MarketData.*）
- `MarketData` - 市场数据服务
- `MarketData.Cache` - 市场数据缓存
- `MarketData.Filter` - 日内数据过滤

#### 8. 订单相关（Order.*）
- `Order.Prevention` - 订单预防指标
- `Order.Push` - 交易推送
- `Order.RateLimit` - API限流

#### 9. 期权相关（Option.*）
- `Option.Chain` - 期权链
- `Option.Quote` - 期权行情
- `Option.InstitutionCache` - 机构缓存

#### 10. 状态管理（StateManager）
- `StateManager` - 状态管理器

#### 11. 日志系统相关（Log.*）
- `Log.Service` - 日志服务
- `Log.Worker` - 日志工作线程
- `Log.Cleanup` - 日志清理

#### 12. 配置相关（Config.*）
- `Config` - 配置管理
- `Config.Token` - Token刷新
- `Config.TradingDays` - 交易日服务
- `Config.LongPort` - LongPort配置
- `Config.Database` - 数据库配置

#### 13. API接口（API.*）
- `API.Backtest` - 回测API
- `API.Logs` - 日志API
- `API.Orders` - 订单API
- `API.Config` - 配置API
- `API.Quant` - 量化API
- `API` - 其他API路由

#### 14. 工具类（Utils.*）
- `Utils.Logger` - 日志工具
- `Utils.TradingDays` - 交易日工具
- `Utils.OrderValidation` - 订单验证
- `Utils` - 其他工具类

#### 15. 中间件（Middleware）
- `Middleware` - 请求处理中间件

#### 16. 服务器（Server）
- `Server` - Express服务器

## 📝 映射规则示例

### 示例1：策略调度器
```
文件路径: api/src/services/strategy-scheduler.service.ts
映射结果: Strategy.Scheduler
```

### 示例2：基础执行器
```
文件路径: api/src/services/basic-execution.service.ts
映射结果: Execution.Basic
```

### 示例3：回测服务
```
文件路径: api/src/services/backtest.service.ts
映射结果: Backtest
```

### 示例4：API路由
```
文件路径: api/src/routes/backtest.ts
映射结果: API.Backtest
```

## 🔍 如何添加新的映射规则

在 `api/src/utils/log-module-mapper.ts` 的 `MODULE_MAPPINGS` 数组中添加新规则：

```typescript
{
  pattern: /your-service-file\.ts$/,
  module: 'Your.Module.Name',
  chineseName: '中文名称',  // 可选
  description: '模块描述：说明该模块的功能',
},
```

**注意事项**：
1. 规则按优先级排序，越靠前的规则优先级越高
2. 使用正则表达式可以匹配更灵活的模式
3. 模块名称建议使用点号分隔的层级结构（如 `Module.SubModule`）
4. 建议添加中文名称和描述，便于前端展示

## 📊 模块统计

可以通过以下SQL查询统计各模块的日志数量：

```sql
SELECT 
  module,
  COUNT(*) as log_count,
  COUNT(DISTINCT DATE(timestamp)) as days_active
FROM system_logs
GROUP BY module
ORDER BY log_count DESC;
```

## 🎯 最佳实践

1. **使用明确的模块名称**：在代码中调用日志时，尽量传入明确的模块名称
2. **保持模块名称一致性**：同一功能的日志使用相同的模块名称
3. **定期审查映射规则**：根据实际使用情况调整映射规则
4. **文档化模块职责**：在映射规则中添加描述，说明模块的功能

---

# 5. 字段长度修复指南

## 📋 问题描述

日志系统在写入数据库时出现错误：
```
对于可变字符类型来说，值太长了(50)
```

**原因**：
- `module` 字段定义为 `VARCHAR(50)`，但实际生成的模块名称可能超过50个字符
- `file_path` 字段定义为 `VARCHAR(255)`，但实际文件路径可能超过255个字符

## 🔧 解决方案

### 1. 数据库字段长度已更新

**新字段长度**：
- `module`: `VARCHAR(50)` → `VARCHAR(200)`
- `file_path`: `VARCHAR(255)` → `VARCHAR(500)`

### 2. 修复步骤

**统一修复方法（适用于新数据库和已有数据库）**：

直接运行统一初始化脚本，脚本会自动检测并更新字段长度：
```bash
# Windows
psql -U postgres -d trading_db -f api\migrations\000_init_schema.sql

# Mac/Linux
psql -U postgres -d trading_db -f api/migrations/000_init_schema.sql
```

**脚本会自动处理**：
- ✅ **新数据库**：创建表时直接使用新的字段长度（VARCHAR(200) 和 VARCHAR(500)）
- ✅ **已有数据库**：自动检测字段长度，如果小于目标长度则自动更新
- ✅ **跨平台兼容**：Windows、Mac、Linux 统一使用同一个脚本
- ✅ **幂等性**：可以安全地重复运行，不会重复更新

**验证更新**：
```sql
-- 检查字段类型
SELECT column_name, data_type, character_maximum_length 
FROM information_schema.columns 
WHERE table_name = 'system_logs' 
  AND column_name IN ('module', 'file_path');
```

预期结果：
- `module`: `character varying` / `200`
- `file_path`: `character varying` / `500`

**注意**：`013_update_system_logs_field_lengths.sql` 脚本已不再需要，统一初始化脚本已包含自动更新逻辑。

### 3. 代码层面的安全措施

日志工作线程 (`log-worker.service.ts`) 已添加字段截断逻辑：
- `module` 超过200字符：截断到197字符 + "..."
- `file_path` 超过500字符：保留最后497字符 + "..."

这确保了即使字段长度超限，也不会导致写入失败。

## ✅ 验证修复

修复后，日志系统应该能够正常写入数据库。可以通过以下方式验证：

1. **检查日志写入**：
   - 查看控制台是否还有 "值太长了" 的错误
   - 检查数据库是否有新的日志记录

2. **查询日志**：
   ```sql
   SELECT id, module, file_path, message, timestamp 
   FROM system_logs 
   ORDER BY timestamp DESC 
   LIMIT 10;
   ```

3. **检查字段长度**：
   ```sql
   SELECT 
     MAX(LENGTH(module)) as max_module_length,
     MAX(LENGTH(file_path)) as max_file_path_length
   FROM system_logs;
   ```

## 📝 相关文件

- **数据库迁移脚本**：
  - `api/migrations/000_init_schema.sql` - 统一初始化脚本（已包含自动更新逻辑）
  - `api/migrations/013_update_system_logs_field_lengths.sql` - 已废弃（功能已合并到000_init_schema.sql）

- **代码文件**：
  - `api/src/services/log-worker.service.ts` - 已添加字段截断逻辑

## 🎯 后续优化建议

如果未来仍然遇到字段长度问题，可以考虑：
1. 将 `module` 和 `file_path` 改为 `TEXT` 类型（无长度限制）
2. 优化模块名称提取逻辑，生成更短的模块名称
3. 使用相对路径而不是绝对路径

---

## 📚 相关文档

- [日志系统重构（v2.0 - 2026-02-06）](260206-日志系统重构.md) - 全面重构：级别门控、节流、摘要聚合
- [日志聚合与降噪功能实施](251219-LOG_AGGREGATION_IMPLEMENTATION.md) - 日志聚合第一版
- [Task_queues模块修复文档](251216-Task_queues模块修复文档.md) - 模块名称标准化相关
- [订单重复提交防护机制文档](251212-订单重复提交防护机制文档.md) - 订单验证相关

---

**文档版本**：v1.0
**最后更新**：2026-02-06（添加 v2.0 重构引用）
**状态**：已完成 ✅（后续版本见 260206-日志系统重构.md）

