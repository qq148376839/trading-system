# 机构选股功能 - 产品需求文档（PRD）

## 📋 文档信息
- **文档版本**：v1.0
- **创建时间**：2025-12-05
- **最后更新**：2025-12-05
- **文档作者**：AI Product Manager
- **审核状态**：待审核

---

## 1. 背景与目标

### 1.1 业务背景

在量化交易策略创建过程中，用户需要手动输入股票代码或从关注列表选择股票，这种方式存在以下问题：

1. **选股困难**：个人量化交易者和新手用户缺乏专业的选股能力，不知道应该选择哪些股票
2. **效率低下**：手动输入股票代码容易出错，且需要用户具备一定的股票知识
3. **策略收益不稳定**：用户选择的股票可能不是最优的投资标的，影响策略收益

### 1.2 用户痛点

- **痛点1**：选股困难，不知道应该选择哪些股票
- **痛点2**：缺乏专业的选股能力，无法判断哪些股票值得投资
- **痛点3**：手动输入股票代码容易出错，效率低下
- **痛点4**：希望学习顶尖机构的投资思路，但不知道如何获取机构持仓信息

### 1.3 业务目标

- **主要目标**：通过机构选股功能，帮助用户快速构建高质量的股票池，提升策略收益
- **成功指标**：
  - 使用机构选股功能的策略占比 ≥ 30%
  - 用户选股时间从平均5分钟降低到1分钟以内
  - 使用机构选股功能的策略平均收益提升 ≥ 10%（需要后续数据验证）
  - 用户满意度 ≥ 4.0/5.0

### 1.4 项目范围

- **包含范围**：
  - 机构列表查询（热门机构）
  - 机构持仓查询
  - 智能选股（按持仓比例排序）
  - 资金分配方案预览
  - 手动调整资金分配比例
  - 智能调整资金分配比例
  - 股票代码格式转换（moomoo格式 → 系统格式）
  - 机构数据缓存（5-10分钟）
- **不包含范围**：
  - 多机构组合选股（仅支持单机构）
  - 机构类型筛选（API不支持）
  - 持仓变动分析（增持/减持趋势分析，后续迭代）
  - 机构历史持仓查询（仅支持最新持仓）

---

## 2. 用户与场景

### 2.1 目标用户

- **主要用户**：个人量化交易者、新手用户
- **用户特征**：
  - 缺乏专业的选股能力
  - 希望学习顶尖机构的投资思路
  - 需要快速构建股票池
  - 对资金分配有一定了解，但需要系统辅助

### 2.2 使用场景

**场景1：新手用户创建策略**
- **用户**：量化交易新手
- **时间**：工作日上午
- **地点**：办公室
- **行为**：想要创建一个量化交易策略，但不知道选择哪些股票
- **目标**：快速选择一个知名机构（如巴菲特），系统自动推荐股票池，并自动分配资金

**场景2：个人交易者优化策略**
- **用户**：有一定经验的个人量化交易者
- **时间**：晚上复盘时间
- **地点**：家中
- **行为**：想要参考ARK投资的持仓，创建新的策略
- **目标**：选择ARK投资，查看其持仓，手动调整资金分配比例，创建策略

**场景3：学习机构投资思路**
- **用户**：量化交易学习者
- **时间**：周末学习时间
- **地点**：家中
- **行为**：想要学习索罗斯的投资思路，了解其持仓情况
- **目标**：选择索罗斯持仓，查看其持仓比例和市值，学习其投资组合结构

### 2.3 用户故事

- As a 量化交易新手, I want 通过选择知名机构自动生成股票池, So that 我可以快速创建策略，无需手动选股
- As a 个人量化交易者, I want 参考顶尖机构的持仓情况, So that 我可以学习机构的投资思路，提升策略收益
- As a 策略创建者, I want 系统自动分配资金比例, So that 我可以快速预览资金分配方案，并根据需要调整

---

## 3. 功能需求

### 3.1 功能概览

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 机构列表查询 | P0 | 获取热门机构列表 |
| 机构持仓查询 | P0 | 查询指定机构的持仓情况 |
| 智能选股 | P0 | 按持仓比例排序，筛选股票 |
| 资金分配预览 | P0 | 预览资金分配方案 |
| 手动调整资金分配 | P1 | 支持手动调整每只股票的资金比例 |
| 智能调整资金分配 | P1 | 根据选择的股票动态调整资金比例 |
| 股票代码转换 | P0 | 将moomoo格式转换为系统格式 |
| 数据缓存 | P1 | 缓存机构数据，减少API调用 |

### 3.2 功能详细说明

#### 功能1：机构列表查询
**优先级**：P0

**功能描述**：
查询热门机构列表，供用户选择。

**交互流程**：
1. 用户在创建策略时，选择"机构选股"模式
2. 系统调用边缘函数，查询热门机构列表
3. 显示机构列表（机构名称、持仓市值、持仓变动等）
4. 用户选择目标机构

**输入输出**：
- **输入**：无
- **输出**：机构列表（机构ID、机构名称、持仓市值、持仓变动、持仓股票数等）

**API接口**：
```
GET /api/moomooapi?path=/quote-api/quote-v2/get-popular-position
```

**边界条件**：
- API调用失败：提示"获取机构列表失败，请重试"
- 机构列表为空：提示"暂无机构数据"
- 网络超时：提示"网络超时，请检查网络连接"

**验收标准**：
- [ ] 可以成功获取热门机构列表
- [ ] 机构列表包含机构名称、持仓市值、持仓变动等信息
- [ ] API调用失败时显示错误提示
- [ ] 支持缓存，5-10分钟内不重复调用API

---

#### 功能2：机构持仓查询
**优先级**：P0

**功能描述**：
查询指定机构的持仓情况，包括持仓股票、持仓比例、持仓市值等。

**交互流程**：
1. 用户选择目标机构
2. 系统调用边缘函数，查询机构持仓
3. 显示机构持仓列表（股票代码、持仓比例、持仓市值、增持/减持等）
4. 用户可以根据持仓比例和市值筛选股票

**输入输出**：
- **输入**：机构ID（ownerObjectId）、周期ID（periodId）、页码（page）、每页数量（pageSize）
- **输出**：持仓列表（股票代码、持仓比例、持仓市值、增持/减持、持仓变动等）

**API接口**：
```
GET /api/moomooapi?path=/quote-api/quote-v2/get-share-holding-list
参数：
- ownerObjectId: 机构ID（必填）
- periodId: 周期ID（必填，默认88）
- page: 页码（默认0）
- pageSize: 每页数量（默认50）
```

**边界条件**：
- 机构ID无效：提示"机构不存在"
- 持仓数据为空：提示"该机构暂无持仓数据"
- 网络超时：提示"网络超时，请重试"

**验收标准**：
- [ ] 可以成功查询机构持仓
- [ ] 持仓列表包含股票代码、持仓比例、持仓市值等信息
- [ ] 支持分页查询
- [ ] 支持缓存，5-10分钟内不重复调用API

---

#### 功能3：智能选股
**优先级**：P0

**功能描述**：
根据机构持仓，按持仓比例排序，筛选股票，并支持设置最小持仓比例阈值。

**交互流程**：
1. 用户选择机构后，系统获取机构持仓列表
2. 按持仓比例从高到低排序
3. 根据最小持仓比例阈值（默认1%）筛选股票
4. 显示筛选后的股票列表
5. 用户可以选择/取消选择股票

**输入输出**：
- **输入**：机构持仓列表、最小持仓比例阈值（默认1%）
- **输出**：筛选后的股票列表（按持仓比例排序）

**选股算法**：
1. 获取机构持仓列表（调用 `get-share-holding-list` API）
2. 按 `percentOfPortfolio`（持仓占比）从高到低排序
3. 过滤 `percentOfPortfolio` < 最小持仓比例阈值的股票
4. 如果 `percentOfPortfolio` 相同，使用 `shareHoldingValueNumeric`（持仓市值）作为次要排序
5. 返回排序后的股票列表

**重要说明**：
- **主要排序字段**：`percentOfPortfolio`（持仓占比），不是 `shareHoldingPct`（持股比例）
- `percentOfPortfolio` 表示该股票在机构投资组合中的占比
- `shareHoldingPct` 表示机构持有该股票流通股的比例（可能很小，但不代表不重要）

**边界条件**：
- 持仓比例数据缺失：使用持仓市值作为参考
- 股票代码格式不标准：自动转换为系统格式
- 筛选后无股票：提示"没有符合条件的股票，请调整最小持仓比例阈值"

**验收标准**：
- [ ] 可以按持仓比例排序
- [ ] 支持设置最小持仓比例阈值（默认1%）
- [ ] 持仓比例缺失时，使用持仓市值作为参考
- [ ] 股票代码自动转换为系统格式（如 `AAPL.US`）

---

#### 功能4：资金分配预览
**优先级**：P0

**功能描述**：
根据选择的股票和可用资金，预览资金分配方案。

**交互流程**：
1. 用户选择股票后，系统获取策略的可用资金
2. 根据持仓比例计算每只股票的资金分配
3. 显示资金分配预览（股票代码、持仓比例、分配金额、分配比例、购买数量等）
4. 用户确认或调整资金分配

**输入输出**：
- **输入**：选择的股票列表、可用资金、资金分配模式（按持仓比例/手动调整/智能调整）
- **输出**：资金分配方案（每只股票的分配金额、分配比例、购买数量等）

**资金分配算法（按持仓比例）**：
1. 获取策略可用资金（从资金分配账户获取）
2. 计算所有选择股票的持仓比例总和
3. 按持仓比例分配资金：
   ```
   每只股票分配金额 = 可用资金 × (该股票持仓比例 / 所有股票持仓比例总和)
   ```
4. 计算购买数量：
   ```
   购买数量 = floor(分配金额 / 股票当前价格)
   ```
5. 如果购买数量 < 1，则设置为1（最小1股）

**边界条件**：
- 可用资金不足：提示"可用资金不足，请减少股票数量或调整资金分配"
- 股票价格获取失败：提示"无法获取股票价格，请重试"
- 分配金额小于最小投资金额：提示"分配金额小于最小投资金额，请调整"

**验收标准**：
- [ ] 可以正确计算资金分配方案
- [ ] 显示每只股票的分配金额、分配比例、购买数量
- [ ] 总分配金额不超过可用资金
- [ ] 支持设置单只股票上限和最小投资金额

---

#### 功能5：手动调整资金分配
**优先级**：P1

**功能描述**：
支持用户手动调整每只股票的资金分配比例。

**交互流程**：
1. 用户在资金分配预览页面，点击"手动调整"
2. 显示每只股票的分配比例输入框
3. 用户调整分配比例
4. 系统实时计算分配金额和购买数量
5. 用户确认调整

**输入输出**：
- **输入**：用户调整的分配比例
- **输出**：更新后的资金分配方案

**调整规则**：
- 分配比例总和不能超过100%
- 单只股票分配比例不能超过单只股票上限
- 分配金额不能小于最小投资金额
- 实时验证并提示错误

**边界条件**：
- 分配比例总和超过100%：提示"分配比例总和不能超过100%"
- 分配金额小于最小投资金额：提示"分配金额小于最小投资金额"
- 分配金额超过单只股票上限：提示"分配金额超过单只股票上限"

**验收标准**：
- [ ] 可以手动调整分配比例
- [ ] 实时计算分配金额和购买数量
- [ ] 分配比例总和不能超过100%
- [ ] 支持设置单只股票上限和最小投资金额

---

#### 功能6：智能调整资金分配
**优先级**：P1

**功能描述**：
根据选择的N只股票在机构中的比例占比，动态调整资金分配比例。

**交互流程**：
1. 用户选择N只股票（例如10只）
2. 系统计算这N只股票在机构中的总持仓比例
3. 根据这N只股票在机构中的比例占比，重新分配资金
4. 显示调整后的资金分配方案

**智能调整算法**：
1. 计算选择的N只股票在机构中的总持仓比例：
   ```
   总持仓比例 = sum(每只股票的持仓比例)
   ```
2. 计算每只股票在N只股票中的占比：
   ```
   股票占比 = 该股票持仓比例 / 总持仓比例
   ```
3. 按占比分配资金：
   ```
   每只股票分配金额 = 可用资金 × 股票占比
   ```

**边界条件**：
- 选择的股票数量为0：提示"请至少选择一只股票"
- 总持仓比例为0：提示"无法计算资金分配，请重新选择股票"

**验收标准**：
- [ ] 可以智能调整资金分配比例
- [ ] 根据选择的股票在机构中的比例占比动态调整
- [ ] 总分配金额不超过可用资金
- [ ] 分配比例总和为100%

---

#### 功能7：股票代码格式处理
**优先级**：P0

**功能描述**：
验证和处理moomoo API返回的股票代码格式。

**格式说明**：
- **API返回格式**：已经是系统格式（如 `AAPL.US`、`TSLA.US`、`00300.HK`）
- **系统格式**：`ticker.region`（如 `AAPL.US`、`700.HK`）
- **无需转换**：API返回的 `symbol` 字段已经是正确格式

**处理逻辑**：
1. 直接使用API返回的 `symbol` 字段
2. 验证格式是否符合系统要求（`ticker.region`）
3. 如果格式不符合，记录错误日志，但不影响其他股票的处理

**边界条件**：
- 股票代码格式不符合：记录警告日志，跳过该股票
- 股票代码为空：跳过该股票

**验收标准**：
- [ ] API返回的股票代码可以直接使用
- [ ] 支持美股、港股等不同市场的股票代码
- [ ] 格式验证通过率 ≥ 99%

---

#### 功能8：数据缓存
**优先级**：P1

**功能描述**：
缓存机构数据，减少API调用，提升性能。

**缓存策略**：
- 缓存时间：5-10分钟（可配置）
- 缓存键：机构ID + 周期ID
- 缓存存储：后端内存缓存或Redis（如果可用）

**边界条件**：
- 缓存失效：重新调用API获取最新数据
- 缓存数据过期：自动刷新缓存

**验收标准**：
- [ ] 机构数据缓存5-10分钟
- [ ] 缓存命中时直接返回缓存数据
- [ ] 缓存失效时自动刷新

---

## 4. 非功能需求

### 4.1 性能要求
- **响应时间**：机构列表查询 ≤ 2秒，机构持仓查询 ≤ 3秒
- **并发量**：支持同时10个用户使用机构选股功能
- **缓存命中率**：≥ 80%

### 4.2 安全要求
- API调用通过边缘函数中转，避免暴露API密钥
- 机构数据缓存，避免频繁调用第三方API
- 用户输入验证，防止SQL注入和XSS攻击

### 4.3 兼容性要求
- 支持主流浏览器（Chrome、Firefox、Safari、Edge）
- 支持移动端浏览器（响应式设计）

### 4.4 可维护性要求
- 代码规范：遵循项目现有的TypeScript代码规范
- 错误处理：完善的错误处理和日志记录
- 文档：API接口文档和代码注释

---

## 5. 技术方案

### 5.1 技术选型

**后端**：
- **API服务**：Express.js + TypeScript
- **缓存**：Node.js内存缓存（或Redis，如果可用）
- **API代理**：通过Cloudflare Workers边缘函数代理moomoo API

**前端**：
- **框架**：Next.js 14 + TypeScript
- **UI组件**：Tailwind CSS
- **状态管理**：React Hooks

**边缘函数**：
- **平台**：Cloudflare Workers
- **语言**：JavaScript

### 5.2 架构设计

```
前端 (Next.js)
  ↓
后端 API (Express.js)
  ↓
边缘函数 (Cloudflare Workers)
  ↓
Moomoo API
```

### 5.3 接口设计

#### 5.3.1 获取热门机构列表

**接口**：`GET /api/quant/institutions/popular`

**请求参数**：无

**实际API返回数据结构**：
```json
{
  "code": 0,
  "message": "成功",
  "data": [
    {
      "shareHolding": [
        {
          "stockId": "205189",
          "symbol": "AAPL.US",
          "shareHoldingValue": "66408954348",
          "shareHoldingPct": "1.61",
          "percentOfPortfolio": "21.04",
          "percentOfShareChange": "-0.28",
          "holdingDate": "1759161600",
          "shareChange": "-41787236",
          "lastShareHoldingPct": "NaN"
        }
      ],
      "increaseHolding": [
        {
          "stockId": "202189",
          "symbol": "SIRI.US",
          "shareHoldingValue": "2749500788",
          "shareHoldingPct": "37.08",
          "percentOfPortfolio": "0.87",
          "percentOfShareChange": "1.49",
          "holdingDate": "1759161600",
          "shareChange": "5030425",
          "lastShareHoldingPct": "NaN"
        }
      ],
      "ownerObjectId": 255251,
      "ownerObjectName": "巴菲特持仓",
      "pictureUrl": "https://static.futunn.com/..."
    }
  ]
}
```

**后端处理后的响应格式**：
```json
{
  "success": true,
  "data": [
    {
      "id": "255251",
      "name": "巴菲特持仓",
      "pictureUrl": "https://static.futunn.com/...",
      "topHoldings": [
        {
          "symbol": "AAPL.US",
          "percentOfPortfolio": 21.04,
          "shareHoldingValue": 66408954348
        }
      ],
      "topIncreases": [
        {
          "symbol": "SIRI.US",
          "percentOfPortfolio": 0.87,
          "percentOfShareChange": 1.49
        }
      ]
    },
    {
      "id": "268937190",
      "name": "ARK投资",
      "pictureUrl": "https://static.futunn.com/...",
      "topHoldings": [
        {
          "symbol": "TSLA.US",
          "percentOfPortfolio": 10.14,
          "shareHoldingValue": 1633278010
        }
      ],
      "topIncreases": [
        {
          "symbol": "SLMT.US",
          "percentOfPortfolio": 0.10,
          "percentOfShareChange": 11.38
        }
      ]
    }
  ]
}
```

**数据字段说明**：
- `ownerObjectId`: 机构ID（用于后续查询持仓）
- `ownerObjectName`: 机构名称
- `shareHolding`: 主要持仓列表（按持仓比例排序）
- `increaseHolding`: 增持股票列表
- `percentOfPortfolio`: 持仓占比（%），用于选股排序
- `shareHoldingPct`: 持股比例（%），表示持有该股票流通股的比例
- `shareHoldingValue`: 持仓市值（字符串格式，需要转换为数字）

#### 5.3.2 获取机构持仓

**接口**：`GET /api/quant/institutions/:institutionId/holdings`

**请求参数**：
- `institutionId` (路径参数)：机构ID（如 `268937190`）
- `periodId` (查询参数)：周期ID，默认88（88表示最新季度，从代码看是季度选择器）
- `page` (查询参数)：页码，默认0
- `pageSize` (查询参数)：每页数量，默认50

**实际API返回数据结构**：
```json
{
  "code": 0,
  "message": "成功",
  "data": {
    "pagination": {
      "page": 0,
      "pageSize": 50,
      "pageCount": 5,
      "total": 206
    },
    "shareHoldingList": [
      {
        "stockId": "201335",
        "symbol": "TSLA.US",
        "industryId": "7",
        "industryName": "汽车",
        "shareHoldingValue": "15.29亿",
        "shareHoldingPct": "0.11",
        "lastShareHoldingPct": "0.11",
        "oldShareChange": 512158,
        "percentOfPortfolio": "9.69",
        "percentOfShareChange": "+0.02",
        "holdingDate": "1759161600",
        "ownerObjectId": 268937190,
        "ownerObjectName": "ARK投资",
        "shareChange": "+51.22万",
        "sourceGroupName": "13F",
        "stockCode": "TSLA",
        "stockName": "特斯拉",
        "marketLabel": "US",
        "instrumentType": 3,
        "price": "429.240",
        "priceDirect": "down",
        "shareChangeDirect": "up",
        "shareChangeValue": "512158",
        "shareHoldingPctDirect": "flat"
      }
    ]
  }
}
```

**后端处理后的响应格式**：
```json
{
  "success": true,
  "data": {
    "institutionId": "268937190",
    "institutionName": "ARK投资",
    "holdings": [
      {
        "symbol": "TSLA.US",
        "stockCode": "TSLA",
        "stockName": "特斯拉",
        "percentOfPortfolio": 9.69,
        "shareHoldingPct": 0.11,
        "shareHoldingValue": "15.29亿",
        "shareHoldingValueNumeric": 1529000000,
        "percentOfShareChange": 0.02,
        "shareChange": "+51.22万",
        "shareChangeValue": 512158,
        "price": 429.240,
        "industryName": "汽车",
        "holdingDate": 1759161600,
        "sourceGroupName": "13F"
      }
    ],
    "pagination": {
      "page": 0,
      "pageSize": 50,
      "pageCount": 5,
      "total": 206
    }
  }
}
```

**数据字段说明**：
- `percentOfPortfolio`: 持仓占比（%），**这是用于选股排序的主要字段**
- `shareHoldingPct`: 持股比例（%），表示持有该股票流通股的比例
- `shareHoldingValue`: 持仓市值（中文格式，如"15.29亿"，需要转换为数字）
- `percentOfShareChange`: 持仓变动比例（%），正数表示增持，负数表示减持
- `price`: 当前价格（用于计算购买数量）
- `symbol`: 股票代码（已经是系统格式，如 `TSLA.US`）

**重要说明**：
- `periodId=88` 表示最新季度，如果需要查询历史季度，需要从 `reportPeriod` 列表中获取对应的 `periodId`
- 股票代码格式已经是系统格式（`AAPL.US`），无需转换
- `shareHoldingValue` 是中文格式（如"15.29亿"），需要转换为数字进行计算

#### 5.3.3 智能选股

**接口**：`POST /api/quant/institutions/select-stocks`

**请求体**：
```json
{
  "institutionId": "268937190",
  "minHoldingRatio": 1.0,
  "availableCapital": 5000
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "stocks": [
      {
        "symbol": "AAPL.US",
        "holdingRatio": 21.04,
        "marketValue": 100000000,
        "change": "增持",
        "changeRatio": 1.49
      },
      {
        "symbol": "MSFT.US",
        "holdingRatio": 15.20,
        "marketValue": 80000000,
        "change": "减持",
        "changeRatio": -0.50
      }
    ],
    "totalSelected": 10
  }
}
```

#### 5.3.4 计算资金分配方案

**接口**：`POST /api/quant/institutions/calculate-allocation`

**请求体**：
```json
{
  "strategyId": 1,
  "stocks": [
    {
      "symbol": "AAPL.US",
      "holdingRatio": 21.04
    },
    {
      "symbol": "MSFT.US",
      "holdingRatio": 15.20
    }
  ],
  "allocationMode": "PROPORTIONAL",
  "maxPositionPerSymbol": 1000,
  "minInvestmentAmount": 100
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "availableCapital": 5000,
    "allocations": [
      {
        "symbol": "AAPL.US",
        "holdingRatio": 21.04,
        "allocationRatio": 58.05,
        "allocationAmount": 2902.50,
        "currentPrice": 150.25,
        "quantity": 19
      },
      {
        "symbol": "MSFT.US",
        "holdingRatio": 15.20,
        "allocationRatio": 41.95,
        "allocationAmount": 2097.50,
        "currentPrice": 350.50,
        "quantity": 5
      }
    ],
    "totalAllocation": 5000.00,
    "totalRatio": 100.00
  }
}
```

### 5.4 数据模型

#### 5.4.1 机构缓存表（内存缓存）

```typescript
interface InstitutionCache {
  institutionId: string;
  institutionName: string;
  data: any;
  timestamp: number;
  ttl: number; // 5-10分钟，单位：毫秒
}
```

#### 5.4.2 持仓数据模型

```typescript
interface InstitutionHolding {
  symbol: string; // 系统格式：AAPL.US（API已返回正确格式）
  stockCode: string; // 股票代码：AAPL
  stockName: string; // 股票名称：苹果
  percentOfPortfolio: number; // 持仓占比（%），用于选股排序
  shareHoldingPct: number; // 持股比例（%），持有流通股比例
  shareHoldingValue: string; // 持仓市值（中文格式，如"15.29亿"）
  shareHoldingValueNumeric: number; // 持仓市值（数字格式）
  percentOfShareChange: number; // 持仓变动比例（%）
  shareChange: string; // 持仓变动（中文格式，如"+51.22万"）
  shareChangeValue: number; // 持仓变动（数字格式）
  price: number; // 当前价格
  industryName: string; // 行业名称
  holdingDate: number; // 持仓日期（时间戳）
  sourceGroupName: string; // 数据来源（如"13F"）
}
```

#### 5.4.3 缓存方案对比

**方案1：内存缓存（Node.js内存）**
- **优点**：
  - 实现简单，无需额外依赖
  - 访问速度快（内存读写）
  - 适合单机部署
- **缺点**：
  - 服务器重启后缓存丢失
  - 多实例部署时缓存不共享
  - 内存占用限制（受服务器内存限制）
- **适用场景**：单机部署、小规模应用

**方案2：Redis缓存**
- **优点**：
  - 数据持久化（可配置）
  - 多实例共享缓存
  - 支持分布式部署
  - 内存管理更灵活
- **缺点**：
  - 需要额外的Redis服务
  - 网络延迟（虽然很小）
  - 需要维护Redis服务
- **适用场景**：多实例部署、大规模应用、需要缓存持久化

**推荐方案**：
- **MVP阶段（V1.0）**：使用**内存缓存**，实现简单，满足单机部署需求
- **后续优化（V1.1+）**：如果有多实例部署需求，再迁移到Redis缓存

**缓存实现示例（内存缓存）**：
```typescript
class InstitutionCache {
  private cache: Map<string, { data: any; timestamp: number }> = new Map();
  private ttl: number = 5 * 60 * 1000; // 5分钟

  get(key: string): any | null {
    const item = this.cache.get(key);
    if (!item) return null;
    
    const now = Date.now();
    if (now - item.timestamp > this.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    return item.data;
  }

  set(key: string, data: any): void {
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }

  clear(): void {
    this.cache.clear();
  }
}
```

### 5.5 边缘函数集成

**边缘函数URL**：`https://cfapi.riowang.win/api/moomooapi`

**调用示例**：
```typescript
import { moomooProxy } from '../utils/moomoo-proxy';

// 获取热门机构列表
const response = await moomooProxy({
  path: '/quote-api/quote-v2/get-popular-position',
  params: {},
  cookies: DEFAULT_COOKIES,
  csrfToken: DEFAULT_CSRF_TOKEN,
  referer: 'https://www.moomoo.com/hans/quote/institution-tracking',
  timeout: 10000,
});

// 获取机构持仓
const response = await moomooProxy({
  path: '/quote-api/quote-v2/get-share-holding-list',
  params: {
    ownerObjectId: institutionId,
    periodId: 88, // 88表示最新季度
    page: 0,
    pageSize: 50,
  },
  cookies: DEFAULT_COOKIES,
  csrfToken: DEFAULT_CSRF_TOKEN,
  referer: 'https://www.moomoo.com/hans/quote/institution-tracking',
  timeout: 10000,
});
```

**注意事项**：
- 使用项目现有的 `moomooProxy` 工具函数（参考 `api/src/utils/moomoo-proxy.ts`）
- 边缘函数会自动处理CSRF token和cookies
- 需要设置正确的 `referer` header
- API返回的股票代码已经是系统格式（`AAPL.US`），无需转换

---

## 6. 风险评估

### 6.1 技术风险

**风险1：moomoo API变更**
- **影响**：高（功能完全依赖第三方API）
- **应对**：
  - 使用边缘函数代理，便于统一处理API变更
  - 完善的错误处理和日志记录
  - 定期检查API可用性

**风险2：股票代码格式转换失败**
- **影响**：中（部分股票可能无法转换）
- **应对**：
  - 建立股票代码映射表
  - 转换失败时提示用户手动输入
  - 记录转换失败的股票代码，后续优化

**风险3：API调用频率限制**
- **影响**：中（可能触发API限流）
- **应对**：
  - 实现数据缓存（5-10分钟）
  - 控制API调用频率
  - 使用边缘函数代理，减少直接调用

### 6.2 业务风险

**风险1：机构数据不准确**
- **影响**：中（可能影响选股质量）
- **应对**：
  - 明确提示数据来源和更新时间
  - 允许用户手动调整选股结果
  - 提供数据更新频率说明

**风险2：资金分配不合理**
- **影响**：中（可能影响策略收益）
- **应对**：
  - 提供资金分配预览功能
  - 支持手动调整资金分配
  - 设置单只股票上限和最小投资金额

### 6.3 时间风险

**风险1：API接口调试时间过长**
- **影响**：中（可能影响开发进度）
- **应对**：
  - 提前测试API接口
  - 准备API mock数据
  - 预留充足的调试时间

---

## 7. 迭代计划

### 7.1 MVP范围（V1.0）

**核心功能**：
- ✅ 机构列表查询
- ✅ 机构持仓查询
- ✅ 智能选股（按持仓比例排序）
- ✅ 资金分配预览（按持仓比例分配）
- ✅ 股票代码格式转换
- ✅ 数据缓存（5-10分钟）

**不包含功能**：
- ❌ 手动调整资金分配（V1.1）
- ❌ 智能调整资金分配（V1.1）
- ❌ 持仓变动分析（V1.2）
- ❌ 机构历史持仓查询（V1.2）

### 7.2 后续迭代

**V1.1（预计2周后）**：
- 手动调整资金分配比例
- 智能调整资金分配比例
- 单只股票上限和最小投资金额设置

**V1.2（预计1个月后）**：
- 持仓变动分析（增持/减持趋势）
- 机构历史持仓查询
- 多机构对比功能（如果API支持）

**V1.3（预计2个月后）**：
- 机构选股策略模板
- 机构选股历史记录
- 机构选股效果分析

---

## 8. 交互设计

### 8.1 创建策略流程

```
1. 用户点击"创建策略"
   ↓
2. 选择"机构选股"模式
   ↓
3. 显示机构列表，用户选择机构
   ↓
4. 显示机构持仓列表，用户选择股票（可设置最小持仓比例）
   ↓
5. 显示资金分配预览
   ↓
6. 用户确认或调整资金分配
   ↓
7. 生成股票池，完成策略创建
```

### 8.2 UI界面设计

#### 8.2.1 机构选择界面

```
┌─────────────────────────────────────┐
│  选择机构                            │
├─────────────────────────────────────┤
│  🔍 搜索机构...                      │
│                                     │
│  ┌─────────────────────────────┐  │
│  │ 📊 巴菲特持仓                │  │
│  │ 持仓市值：$1000亿  ↑$50亿    │  │
│  │ 持仓股票：50只    ↑5只       │  │
│  └─────────────────────────────┘  │
│                                     │
│  ┌─────────────────────────────┐  │
│  │ 📊 ARK投资                   │  │
│  │ 持仓市值：$800亿   ↓$10亿    │  │
│  │ 持仓股票：30只    ↑2只       │  │
│  └─────────────────────────────┘  │
└─────────────────────────────────────┘
```

#### 8.2.2 股票选择界面

```
┌─────────────────────────────────────┐
│  机构持仓 - 巴菲特持仓               │
├─────────────────────────────────────┤
│  最小持仓比例：1%  [调整]            │
│                                     │
│  ☑ AAPL.US  持仓比例：21.04%       │
│     持仓市值：$1000亿  增持 1.49%   │
│                                     │
│  ☑ MSFT.US  持仓比例：15.20%       │
│     持仓市值：$800亿   减持 -0.50%  │
│                                     │
│  ☐ GOOGL.US 持仓比例：11.12%       │
│     持仓市值：$500亿   增持 0.31%   │
│                                     │
│  已选择：10只股票                   │
└─────────────────────────────────────┘
```

#### 8.2.3 资金分配预览界面

```
┌─────────────────────────────────────┐
│  资金分配预览                        │
├─────────────────────────────────────┤
│  可用资金：$5,000.00                │
│                                     │
│  分配模式：[按持仓比例] [手动调整]  │
│                                     │
│  ┌─────────────────────────────┐  │
│  │ AAPL.US                      │  │
│  │ 持仓比例：21.04%             │  │
│  │ 分配比例：58.05%             │  │
│  │ 分配金额：$2,902.50          │  │
│  │ 当前价格：$150.25            │  │
│  │ 购买数量：19股               │  │
│  └─────────────────────────────┘  │
│                                     │
│  ┌─────────────────────────────┐  │
│  │ MSFT.US                      │  │
│  │ 持仓比例：15.20%             │  │
│  │ 分配比例：41.95%             │  │
│  │ 分配金额：$2,097.50          │  │
│  │ 当前价格：$350.50            │  │
│  │ 购买数量：5股                │  │
│  └─────────────────────────────┘  │
│                                     │
│  总分配金额：$5,000.00 (100%)      │
│                                     │
│  [确认] [取消]                     │
└─────────────────────────────────────┘
```

---

## 9. 验收标准

### 9.1 功能验收

**机构列表查询**：
- [ ] 可以成功获取热门机构列表
- [ ] 机构列表包含机构名称、持仓市值、持仓变动等信息
- [ ] API调用失败时显示错误提示
- [ ] 支持缓存，5-10分钟内不重复调用API

**机构持仓查询**：
- [ ] 可以成功查询机构持仓
- [ ] 持仓列表包含股票代码、持仓比例、持仓市值等信息
- [ ] 支持分页查询
- [ ] 支持缓存，5-10分钟内不重复调用API

**智能选股**：
- [ ] 可以按持仓比例排序
- [ ] 支持设置最小持仓比例阈值（默认1%）
- [ ] 持仓比例缺失时，使用持仓市值作为参考
- [ ] 股票代码自动转换为系统格式

**资金分配预览**：
- [ ] 可以正确计算资金分配方案
- [ ] 显示每只股票的分配金额、分配比例、购买数量
- [ ] 总分配金额不超过可用资金
- [ ] 支持设置单只股票上限和最小投资金额

### 9.2 性能验收

- [ ] 机构列表查询响应时间 ≤ 2秒
- [ ] 机构持仓查询响应时间 ≤ 3秒
- [ ] 缓存命中率 ≥ 80%

### 9.3 用户体验验收

- [ ] 交互流程顺畅，无明显卡顿
- [ ] 错误提示清晰明确
- [ ] 界面美观，符合现有设计风格
- [ ] 支持移动端访问（响应式设计）

---

## 10. 附录

### 10.1 参考资料

- [Moomoo机构追踪页面](https://www.moomoo.com/hans/quote/institution-tracking)
- [边缘函数集成指南](trading-system/edge-functions/INTEGRATION_GUIDE.md)
- [策略管理API文档](trading-system/api/src/routes/quant.ts)

### 10.2 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2025-12-05 | 初始版本 | AI Product Manager |

### 10.3 已确认事项

1. ✅ **股票代码格式**：API返回的 `symbol` 字段已经是系统格式（`AAPL.US`），无需转换
2. ✅ **API参数**：`periodId=88` 表示最新季度，从代码看是季度选择器，默认使用88
3. ✅ **边缘函数URL**：`https://cfapi.riowang.win/api/moomooapi`
4. ✅ **缓存存储**：MVP阶段使用内存缓存，后续可迁移到Redis

### 10.4 数据格式转换说明

**持仓市值转换**：
- API返回格式：中文格式（如 `"15.29亿"`、`"7.62亿"`）
- 需要转换为数字：`1529000000`、`762000000`
- 转换规则：
  - "亿" = × 100000000
  - "万" = × 10000
  - "千万" = × 10000000
  - 示例：`"15.29亿"` → `1529000000`

**持仓变动转换**：
- API返回格式：中文格式（如 `"+51.22万"`、`"-23.37万"`）
- 需要转换为数字：`512200`、`-233700`
- 转换规则：同上

**实现建议**：
```typescript
function parseChineseNumber(str: string): number {
  const match = str.match(/([+-]?)(\d+\.?\d*)([万亿千万]+)/);
  if (!match) return 0;
  
  const sign = match[1] === '-' ? -1 : 1;
  const num = parseFloat(match[2]);
  const unit = match[3];
  
  let multiplier = 1;
  if (unit.includes('亿')) multiplier = 100000000;
  else if (unit.includes('千万')) multiplier = 10000000;
  else if (unit.includes('万')) multiplier = 10000;
  
  return sign * num * multiplier;
}
```

---

**文档状态**：✅ 已完成  
**下一步行动**：等待技术团队评审，确认技术方案可行性

