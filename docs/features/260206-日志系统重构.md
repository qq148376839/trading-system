# 日志系统重构

## 文档信息
- **创建时间**: 2026-02-06
- **最后更新**: 2026-02-06
- **文档状态**: 已完成

## 1. 功能概述

对日志系统进行全面重构，实现级别门控、节流机制、摘要聚合，将数据库写入量从每分钟 25,000-50,000 条降低到 500-1,000 条（减少 95-98%），同时确保所有 ERROR/WARN 日志完整入库。

### 改造后数据流

```
调用方 -> logger.ts (控制台输出 - 始终执行)
              |
              +-- DEBUG: 仅控制台，不入队列
              +-- ERROR: 必入队列，不节流
              +-- WARN:  必入队列，走节流
              +-- INFO:  默认入队列走节流 | 可通过 {dbWrite:false} 跳过
              |
              v
        log.service.ts (节流门控 + 内存队列)
              |
              v
        log-worker.service.ts (批量写库，逻辑不变)

        log-digest.service.ts [新增] (定期聚合高频指标，写入摘要)
```

## 2. 实现内容

### 2.1 新建文件（3个）

| 文件 | 作用 |
|------|------|
| `api/src/utils/infra-logger.ts` | 基础设施轻量 Logger，供 config.service、log-worker 等底层模块使用，避免循环依赖 |
| `api/src/services/log-digest.service.ts` | 摘要聚合服务，高频指标每 5 分钟写一条聚合日志 |
| `api/migrations/013_add_log_throttle_digest_config.sql` | 节流/摘要/DEBUG 入库开关等配置项 |

### 2.2 修改的核心文件（4个）

| 文件 | 变更说明 |
|------|----------|
| `api/src/utils/logger.ts` | 级别门控、`{dbWrite:false}` 选项、`console()` / `metric()` 新方法 |
| `api/src/services/log.service.ts` | 节流机制（throttleMap、generateThrottleKey、shouldEnqueue）、DEBUG 门控 |
| `api/src/utils/log-module-mapper.ts` | 新增 `Log.Digest` 映射 |
| `api/src/server.ts` | digest 服务初始化和关闭 |

### 2.3 基础设施迁移（4个文件）

将以下底层模块的 `console.*` 替换为 `infraLogger.*`，防止循环依赖：

- `api/src/services/config.service.ts`
- `api/src/services/log-worker.service.ts`
- `api/src/config/database.ts`
- `api/src/services/log.service.ts`

### 2.4 Console 全量迁移（约 38 个文件，约 398 处）

所有业务文件的 `console.*` 迁移到 `logger.*`：

**高频服务**:
- market-data, trading-recommendation, options-contract-selector
- futunn-option-chain/quote, strategy-scheduler, option-intraday-strategy

**中频服务**:
- token-refresh, option-recommendation, option-decision-logger
- api-rate-limiter, intraday-data-filter, market-data-cache
- capital-manager, state-manager 等 15 个

**路由（9个）**:
- orders, quote, positions, futunn-test, logs, quant
- trading-recommendation, config, forex

**工具/配置（7个）**:
- longport-fallback, futunn, moomoo-proxy, chinese-number-parser
- quota-monitor, api-rate-limiter, market-simulation

### 2.5 保留 console 的文件（设计如此）

| 文件 | 原因 |
|------|------|
| `server.ts` | 启停生命周期 |
| `config/longport.ts` | SDK 初始化阶段 |
| `utils/logger.ts` | 内部 console 输出实现 |
| `utils/infra-logger.ts` | 基础设施 logger 实现 |

## 3. 新增配置项

| Key | 默认值 | 说明 |
|-----|--------|------|
| `log_throttle_enabled` | `true` | 启用节流 |
| `log_throttle_window_seconds` | `30` | 节流窗口（秒） |
| `log_digest_enabled` | `true` | 启用摘要 |
| `log_digest_interval_minutes` | `5` | 摘要刷新间隔（分钟） |
| `log_debug_to_db` | `false` | 应急开关：重新启用 DEBUG 入库 |

## 4. 技术细节

### 4.1 级别门控

- **DEBUG**: 仅输出到控制台，默认不入数据库队列（可通过 `log_debug_to_db` 配置开启）
- **ERROR**: 必须入队列，不走节流，确保所有错误日志完整记录
- **WARN**: 必须入队列，走节流窗口（默认 30 秒内相同消息只入库一次）
- **INFO**: 默认入队列走节流；可通过 `{dbWrite:false}` 选项跳过入库

### 4.2 节流机制

`log.service.ts` 新增节流逻辑：
- `throttleMap`: 内存中的节流状态记录
- `generateThrottleKey()`: 基于模块+消息摘要生成节流键
- `shouldEnqueue()`: 根据级别和节流状态判断是否入队列

### 4.3 摘要聚合

`log-digest.service.ts` 实现定期摘要：
- 每 5 分钟（可配置）扫描高频指标
- 将多条同类日志聚合为一条摘要
- 写入数据库，减少大量重复日志

### 4.4 infra-logger

`infra-logger.ts` 是一个轻量级的日志工具：
- 仅依赖 `console.*`，不依赖任何服务
- 专供底层基础设施模块使用（config、database、log-worker、log.service）
- 解决了 logger -> log.service -> config.service -> logger 的循环依赖问题

### 4.5 logger.ts 新增方法

- `console()`: 仅输出到控制台，不入库（替代 `{dbWrite:false}`）
- `metric()`: 标记为指标类日志，参与摘要聚合

## 5. 阶段5：降噪 — 减少不必要的 DB 写入

### 5.1 问题分析

导出 215 条日志分析，约 175 条（81.4%）为不必要的 DB 写入：

| 类别 | 占比 | 来源 | 频率 |
|------|-----|------|------|
| 策略执行汇总（无活动） | ~42% | strategy-scheduler | 每 5-60s |
| 账户余额同步心跳 | ~20% | account-balance-sync | 每 5min |
| 启动/配置消息 | ~15% | 多文件 | 每次重启 |
| 待处理订单心跳 | ~5% | strategy-scheduler | 每 5-60s |

### 5.2 修改内容

通过 `{ dbWrite: false }` 跳过不必要的 DB 写入，消息仍在控制台可见：

| 文件 | 修改数 | 说明 |
|------|--------|------|
| `strategy-scheduler.service.ts` | 7 处 | 启停消息、空跑日志、无活动执行汇总、订单心跳 |
| `account-balance-sync.service.ts` | 3 处 | 余额同步心跳、启停消息 |
| `state-manager.service.ts` | 2 处 | 启动状态恢复消息 |
| `trade-push.service.ts` | 2 处 | 订阅/取消订阅确认 |
| `config/futunn.ts` | 1 处 | 配置加载确认 |
| `routes/quote.ts` | 1 处 | 缓存刷新确认 |
| `routes/logs.ts` | 4 处 | 合并重复 debug 块、删除 5 个诊断 SQL 查询、删除调试残留 |

### 5.3 未修改内容（保持入库）

- 所有 `logger.error()` / `logger.warn()` 调用
- 策略执行汇总的有活动路径（信号/错误/操作）
- 资金差异告警
- 订单成交/提交/取消/拒绝日志
- 买入/卖出操作日志、信号生成日志

### 5.4 预期效果

| 场景 | 修改前 DB 写入/小时 | 修改后 | 减少 |
|------|-------------------|--------|------|
| 执行汇总（无活动） | ~720 | 0 | 100% |
| 余额同步心跳 | ~12 | 0 | 100% |
| 启动消息（每次重启） | ~7-8 | 0 | 100% |
| 待处理订单心跳 | ~120-720 | 0 | 100% |
| 配置/缓存确认 | ~3 | 0 | 100% |
| **合计** | **~860-1460** | **仅业务事件** | **~80-90%** |

## 6. 测试

- **测试文件**: `api/src/__tests__/logger-overhaul.test.ts`、`api/src/__tests__/logger-simulation.test.ts`
- **测试用例**: 279 个测试全部通过
- **覆盖范围**: 级别门控、节流、摘要、向后兼容、infraLogger、降噪

## 7. 预期效果（总体）

| 指标 | 改造前 | 改造后 |
|------|--------|--------|
| DB 写入/min（盘中） | 25,000-50,000 | 500-1,000 |
| DB 减量 | -- | 95-98% |
| 日志完整性 | ERROR/WARN 可能遗漏 | 全部 ERROR/WARN 入库 |
| 心跳/空跑 DB 写入 | ~860-1460/小时 | 0（仅控制台） |

## 8. 相关文档

- [日志系统优化文档（v1.0 - 2025-12-15）](251215-日志系统优化文档.md) - 日志系统初始建设
- [日志聚合与降噪功能实施](251219-LOG_AGGREGATION_IMPLEMENTATION.md) - 日志聚合第一版
- [日志系统优化PRD审查](251216-LOG_SYSTEM_OPTIMIZATION_PRD_REVIEW.md) - PRD 审查报告
