# æœºæ„é€‰è‚¡åŠŸèƒ½ - ç¼“å­˜æ–¹æ¡ˆå¯¹æ¯”

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å¯¹æ¯”ä¸¤ç§ç¼“å­˜æ–¹æ¡ˆï¼ˆå†…å­˜ç¼“å­˜ vs Redisç¼“å­˜ï¼‰ï¼Œå¸®åŠ©æŠ€æœ¯å›¢é˜Ÿé€‰æ‹©åˆé€‚çš„ç¼“å­˜ç­–ç•¥ã€‚

---

## ğŸ” æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ1ï¼šå†…å­˜ç¼“å­˜ï¼ˆNode.jså†…å­˜ï¼‰

#### å®ç°æ–¹å¼
```typescript
class InstitutionCache {
  private cache: Map<string, { data: any; timestamp: number }> = new Map();
  private ttl: number = 5 * 60 * 1000; // 5åˆ†é’Ÿ

  get(key: string): any | null {
    const item = this.cache.get(key);
    if (!item) return null;
    
    const now = Date.now();
    if (now - item.timestamp > this.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    return item.data;
  }

  set(key: string, data: any): void {
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }
}
```

#### ä¼˜ç‚¹ âœ…
1. **å®ç°ç®€å•**ï¼šæ— éœ€é¢å¤–ä¾èµ–ï¼Œä»£ç é‡å°‘
2. **è®¿é—®é€Ÿåº¦å¿«**ï¼šå†…å­˜è¯»å†™ï¼Œå»¶è¿Ÿæä½ï¼ˆ<1msï¼‰
3. **é›¶é…ç½®**ï¼šæ— éœ€é…ç½®RedisæœåŠ¡
4. **é€‚åˆå•æœºéƒ¨ç½²**ï¼šå•å®ä¾‹åº”ç”¨æ€§èƒ½æœ€ä½³
5. **å¼€å‘æ•ˆç‡é«˜**ï¼šå¿«é€Ÿå®ç°ï¼Œå¿«é€Ÿä¸Šçº¿

#### ç¼ºç‚¹ âŒ
1. **æ•°æ®æ˜“ä¸¢å¤±**ï¼šæœåŠ¡å™¨é‡å¯åç¼“å­˜æ¸…ç©º
2. **ä¸å…±äº«**ï¼šå¤šå®ä¾‹éƒ¨ç½²æ—¶ï¼Œæ¯ä¸ªå®ä¾‹ç‹¬ç«‹ç¼“å­˜
3. **å†…å­˜é™åˆ¶**ï¼šå—æœåŠ¡å™¨å†…å­˜é™åˆ¶ï¼Œç¼“å­˜å®¹é‡æœ‰é™
4. **æ— æ³•æŒä¹…åŒ–**ï¼šæ— æ³•è·¨è¿›ç¨‹/è·¨æœåŠ¡å™¨å…±äº«æ•°æ®

#### é€‚ç”¨åœºæ™¯
- âœ… å•æœºéƒ¨ç½²
- âœ… å°è§„æ¨¡åº”ç”¨ï¼ˆç”¨æˆ·é‡ < 1000ï¼‰
- âœ… MVPé˜¶æ®µå¿«é€Ÿä¸Šçº¿
- âœ… å¼€å‘/æµ‹è¯•ç¯å¢ƒ

---

### æ–¹æ¡ˆ2ï¼šRedisç¼“å­˜

#### å®ç°æ–¹å¼
```typescript
import { createClient } from 'redis';

class InstitutionRedisCache {
  private client: ReturnType<typeof createClient>;
  private ttl: number = 5 * 60; // 5åˆ†é’Ÿï¼ˆç§’ï¼‰

  async get(key: string): Promise<any | null> {
    const data = await this.client.get(key);
    return data ? JSON.parse(data) : null;
  }

  async set(key: string, data: any): Promise<void> {
    await this.client.setEx(
      key,
      this.ttl,
      JSON.stringify(data)
    );
  }
}
```

#### ä¼˜ç‚¹ âœ…
1. **æ•°æ®æŒä¹…åŒ–**ï¼šå¯é…ç½®æŒä¹…åŒ–ï¼Œæ•°æ®ä¸ä¸¢å¤±
2. **å¤šå®ä¾‹å…±äº«**ï¼šå¤šä¸ªæœåŠ¡å™¨å®ä¾‹å…±äº«åŒä¸€ç¼“å­˜
3. **åˆ†å¸ƒå¼æ”¯æŒ**ï¼šæ”¯æŒé›†ç¾¤æ¨¡å¼ï¼Œæ¨ªå‘æ‰©å±•
4. **å†…å­˜ç®¡ç†**ï¼šRedisè‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œæ”¯æŒLRUæ·˜æ±°
5. **åŠŸèƒ½ä¸°å¯Œ**ï¼šæ”¯æŒè¿‡æœŸæ—¶é—´ã€æ‰¹é‡æ“ä½œç­‰é«˜çº§åŠŸèƒ½

#### ç¼ºç‚¹ âŒ
1. **éœ€è¦é¢å¤–æœåŠ¡**ï¼šéœ€è¦éƒ¨ç½²å’Œç»´æŠ¤RedisæœåŠ¡
2. **ç½‘ç»œå»¶è¿Ÿ**ï¼šè™½ç„¶å¾ˆå°ï¼ˆé€šå¸¸<5msï¼‰ï¼Œä½†æ¯”å†…å­˜æ…¢
3. **å¤æ‚åº¦å¢åŠ **ï¼šéœ€è¦å¤„ç†Redisè¿æ¥ã€é”™è¯¯é‡è¯•ç­‰
4. **èµ„æºæ¶ˆè€—**ï¼šRedisæœåŠ¡æœ¬èº«éœ€è¦å†…å­˜å’ŒCPUèµ„æº

#### é€‚ç”¨åœºæ™¯
- âœ… å¤šå®ä¾‹éƒ¨ç½²ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
- âœ… å¤§è§„æ¨¡åº”ç”¨ï¼ˆç”¨æˆ·é‡ > 1000ï¼‰
- âœ… éœ€è¦ç¼“å­˜æŒä¹…åŒ–
- âœ… ç”Ÿäº§ç¯å¢ƒé«˜å¯ç”¨éœ€æ±‚

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | å†…å­˜ç¼“å­˜ | Redisç¼“å­˜ |
|------|---------|-----------|
| **è¯»å–å»¶è¿Ÿ** | <1ms | 1-5ms |
| **å†™å…¥å»¶è¿Ÿ** | <1ms | 1-5ms |
| **å¹¶å‘èƒ½åŠ›** | å—Node.jså•çº¿ç¨‹é™åˆ¶ | é«˜ï¼ˆRediså¤šçº¿ç¨‹ï¼‰ |
| **å†…å­˜å ç”¨** | åº”ç”¨è¿›ç¨‹å†…å­˜ | ç‹¬ç«‹Redisè¿›ç¨‹ |
| **æ•°æ®æŒä¹…åŒ–** | âŒ | âœ…ï¼ˆå¯é…ç½®ï¼‰ |
| **å¤šå®ä¾‹å…±äº«** | âŒ | âœ… |

---

## ğŸ’¡ æ¨èæ–¹æ¡ˆ

### MVPé˜¶æ®µï¼ˆV1.0ï¼‰ï¼šå†…å­˜ç¼“å­˜

**ç†ç”±**ï¼š
1. **å¿«é€Ÿä¸Šçº¿**ï¼šå®ç°ç®€å•ï¼Œå¼€å‘æ—¶é—´çŸ­
2. **æ»¡è¶³éœ€æ±‚**ï¼šå•æœºéƒ¨ç½²åœºæ™¯ä¸‹æ€§èƒ½è¶³å¤Ÿ
3. **é™ä½å¤æ‚åº¦**ï¼šæ— éœ€é¢å¤–æœåŠ¡ï¼Œå‡å°‘è¿ç»´è´Ÿæ‹…
4. **æˆæœ¬ä½**ï¼šæ— éœ€RedisæœåŠ¡å™¨èµ„æº

**å®ç°æ­¥éª¤**ï¼š
1. åˆ›å»º `InstitutionCache` ç±»ï¼ˆå†…å­˜ç¼“å­˜ï¼‰
2. åœ¨APIæœåŠ¡ä¸­é›†æˆç¼“å­˜é€»è¾‘
3. è®¾ç½®5-10åˆ†é’ŸTTL
4. æ·»åŠ ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§

---

### åç»­ä¼˜åŒ–ï¼ˆV1.1+ï¼‰ï¼šRedisç¼“å­˜

**è¿ç§»æ¡ä»¶**ï¼š
- å¤šå®ä¾‹éƒ¨ç½²éœ€æ±‚
- ç”¨æˆ·é‡å¢é•¿ï¼ˆ>1000å¹¶å‘ï¼‰
- éœ€è¦ç¼“å­˜æŒä¹…åŒ–
- éœ€è¦è·¨æœåŠ¡å™¨å…±äº«ç¼“å­˜

**è¿ç§»æ­¥éª¤**ï¼š
1. åˆ›å»º `InstitutionRedisCache` ç±»
2. å®ç°ç¼“å­˜æ¥å£æŠ½è±¡å±‚ï¼ˆä¾¿äºåˆ‡æ¢ï¼‰
3. é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ä½¿ç”¨å“ªç§ç¼“å­˜
4. é€æ­¥è¿ç§»ï¼Œä¿æŒå‘åå…¼å®¹

---

## ğŸ”§ å®ç°å»ºè®®

### ç¼“å­˜æ¥å£æŠ½è±¡

ä¸ºäº†ä¾¿äºåç»­è¿ç§»ï¼Œå»ºè®®å…ˆå®šä¹‰ç¼“å­˜æ¥å£ï¼š

```typescript
interface ICache {
  get(key: string): Promise<any | null>;
  set(key: string, data: any): Promise<void>;
  delete(key: string): Promise<void>;
  clear(): Promise<void>;
}

// å†…å­˜ç¼“å­˜å®ç°
class MemoryCache implements ICache {
  // ... å®ç°
}

// Redisç¼“å­˜å®ç°
class RedisCache implements ICache {
  // ... å®ç°
}

// ç¼“å­˜å·¥å‚
class CacheFactory {
  static create(): ICache {
    if (process.env.USE_REDIS_CACHE === 'true') {
      return new RedisCache();
    }
    return new MemoryCache();
  }
}
```

### ç¼“å­˜é”®è®¾è®¡

```typescript
// æœºæ„åˆ—è¡¨ç¼“å­˜
const CACHE_KEY_POPULAR_INSTITUTIONS = 'institutions:popular';

// æœºæ„æŒä»“ç¼“å­˜
const CACHE_KEY_INSTITUTION_HOLDINGS = (institutionId: string, periodId: number) => 
  `institutions:${institutionId}:holdings:${periodId}`;

// ç¼“å­˜é”®ç¤ºä¾‹
// institutions:popular
// institutions:268937190:holdings:88
```

### ç¼“å­˜ç­–ç•¥

1. **ç¼“å­˜æ—¶é—´**ï¼š5-10åˆ†é’Ÿï¼ˆå¯é…ç½®ï¼‰
2. **ç¼“å­˜é”®**ï¼šåŒ…å«æœºæ„IDå’Œå‘¨æœŸID
3. **ç¼“å­˜å¤±æ•ˆ**ï¼šTTLè¿‡æœŸè‡ªåŠ¨å¤±æ•ˆ
4. **ç¼“å­˜é¢„çƒ­**ï¼šåº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½çƒ­é—¨æœºæ„æ•°æ®ï¼ˆå¯é€‰ï¼‰

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **ç¼“å­˜å‘½ä¸­ç‡**ï¼š`å‘½ä¸­æ¬¡æ•° / æ€»è¯·æ±‚æ¬¡æ•°`
   - ç›®æ ‡ï¼šâ‰¥ 80%
   - å¦‚æœå‘½ä¸­ç‡ä½ï¼Œè€ƒè™‘å¢åŠ ç¼“å­˜æ—¶é—´

2. **ç¼“å­˜å¤§å°**ï¼šå†…å­˜å ç”¨æƒ…å†µ
   - å†…å­˜ç¼“å­˜ï¼šç›‘æ§Node.jsè¿›ç¨‹å†…å­˜
   - Redisç¼“å­˜ï¼šç›‘æ§Rediså†…å­˜ä½¿ç”¨

3. **å“åº”æ—¶é—´**ï¼šAPIå“åº”æ—¶é—´
   - ç¼“å­˜å‘½ä¸­ï¼š< 10ms
   - ç¼“å­˜æœªå‘½ä¸­ï¼š< 3ç§’ï¼ˆåŒ…å«APIè°ƒç”¨æ—¶é—´ï¼‰

---

## ğŸ¯ æ€»ç»“

| é˜¶æ®µ | æ¨èæ–¹æ¡ˆ | åŸå›  |
|------|---------|------|
| **MVP (V1.0)** | å†…å­˜ç¼“å­˜ | å¿«é€Ÿä¸Šçº¿ï¼Œæ»¡è¶³å•æœºéœ€æ±‚ |
| **V1.1+** | Redisç¼“å­˜ | æ”¯æŒå¤šå®ä¾‹ï¼Œæå‡å¯æ‰©å±•æ€§ |

**æœ€ç»ˆå»ºè®®**ï¼š
- **ç°åœ¨**ï¼šä½¿ç”¨å†…å­˜ç¼“å­˜ï¼Œå¿«é€Ÿå®ç°åŠŸèƒ½
- **æœªæ¥**ï¼šå¦‚æœæœ‰å¤šå®ä¾‹éœ€æ±‚ï¼Œå†è¿ç§»åˆ°Redis
- **è®¾è®¡**ï¼šæå‰å®šä¹‰ç¼“å­˜æ¥å£ï¼Œä¾¿äºåç»­è¿ç§»

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¶é—´**ï¼š2025-12-05  
**æœ€åæ›´æ–°**ï¼š2025-12-05

