# R5v2 竞价机制优化：移除多仓 + 自动分组 + 资金动态分配

**日期**: 2026-02-27
**状态**: 开发中

## 概述

四项改动，按依赖顺序执行：

1. **移除多仓模式** — 消除绕过竞价的入场路径
2. **资金动态分配** — survivorCount 替代 symbolCount + maxConcentration 封顶
3. **自动相关性分组** — Pearson 相关系数替代硬编码分组
4. **回测同步配置** — 回测读取策略配置中的分组，不再硬编码

## 涉及文件

| 文件 | 变更 |
|---|---|
| `api/src/services/strategy-scheduler.service.ts` | 移除多仓调用、传 survivorCount、读配置分组 |
| `api/src/services/capital-manager.service.ts` | getMaxPositionPerSymbol + requestAllocation 支持 survivorCount/maxConcentration |
| `api/src/services/option-backtest.service.ts` | 移除硬编码分组，从策略 config 读取 |
| `api/src/services/market-data.service.ts` | 新增 getDailyCloseHistory() |
| `api/src/utils/correlation.ts` | 新建：Pearson 计算 + 分组算法 + 共享工具函数 |
| `api/src/routes/quant.ts` | 新增 POST /strategies/:id/correlation-groups |

## 边界情况

- **策略无 correlationGroups 配置**：回退到 DEFAULT_CORRELATION_GROUPS（硬编码兜底）
- **标的池 < 2 个**：API 返回 400，不计算
- **Longport API 某标的无数据**：跳过该标的，不参与分组（自成一组）
- **maxConcentration 未配置**：默认 0.33
- **survivorCount = 0**：兜底为 1（min 保护）
- **非期权策略**：不走竞价路径，capital-manager 向后兼容（无 survivorCount 时走原逻辑）
