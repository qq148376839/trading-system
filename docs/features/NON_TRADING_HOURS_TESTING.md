# 非交易时间测试指南

**文档版本**：v1.0  
**创建时间**：2025-12-12

---

## 📋 交易时间 vs 非交易时间

### 交易时间限制

**无法测试的功能**：
- ❌ 实际订单提交（需要交易所开放）
- ❌ 持仓验证（需要实时持仓数据）
- ❌ 订单去重（需要实际订单提交）
- ❌ 交易推送（需要实际订单状态变更）

**可以测试的功能**：
- ✅ API 服务健康检查
- ✅ 监控指标 API 可用性
- ✅ 数据库连接
- ✅ 代码逻辑验证（单元测试）

---

## 🔍 非交易时间可以做的测试

### 1. 系统健康检查 ✅

**测试内容**：
- API 服务是否运行
- 数据库连接是否正常
- 监控指标 API 是否可用

**测试命令**：
```bash
# 健康检查
curl http://localhost:3001/api/health

# 监控指标
curl http://localhost:3001/api/order-prevention-metrics

# 持仓数据（从数据库）
curl http://localhost:3001/api/positions
```

**预期结果**：
- ✅ 所有 API 正常响应
- ✅ 监控指标初始值为 0（正常）

---

### 2. 代码逻辑验证 ✅

**测试内容**：
- 持仓计算逻辑
- 订单去重逻辑
- 卖空检测逻辑

**方法**：编写单元测试或手动验证代码逻辑

---

### 3. 数据库验证 ✅

**测试内容**：
- 监控指标表是否创建成功
- 表结构是否正确

**测试命令**：
```bash
# 检查表是否存在
psql -U postgres -d trading_db -c "\d order_prevention_metrics"

# 查看表结构
psql -U postgres -d trading_db -c "\d+ order_prevention_metrics"
```

---

### 4. 配置验证 ✅

**测试内容**：
- Longbridge SDK 配置
- Token 状态
- 环境变量配置

**测试命令**：
```bash
# 检查 Token 状态（如果API可用）
curl http://localhost:3001/api/token-refresh/status
```

---

## ⏰ 交易时间测试计划

### 美股交易时间（EST）
- **常规交易时间**：9:30 AM - 4:00 PM EST
- **盘前交易**：4:00 AM - 9:30 AM EST
- **盘后交易**：4:00 PM - 8:00 PM EST

### 港股交易时间（HKT）
- **上午交易时段**：9:30 AM - 12:00 PM HKT
- **下午交易时段**：1:00 PM - 4:00 PM HKT

---

## 📝 交易时间测试清单

### 开盘前准备（30分钟）

- [ ] 检查 API 服务运行状态
- [ ] 检查数据库连接
- [ ] 检查监控指标 API
- [ ] 启动监控脚本：`.\scripts\monitor-metrics.ps1`
- [ ] 查看当前持仓数据
- [ ] 确认测试标的（ACHR.US 有 197 股）

### 交易时间测试（开盘后）

#### 阶段1：基础功能测试（开盘后30分钟内）

- [ ] **TC-001**：正常卖出（持仓充足）
  - 提交卖出订单：ACHR.US，数量=50
  - 验证指标：`positionValidationTotal` 和 `positionValidationPassed` 应该增加

- [ ] **TC-002**：卖出数量超过可用持仓
  - 提交卖出订单：ACHR.US，数量=200（超过197）
  - 验证指标：`positionValidationFailed` 和 `orderRejectedByPosition` 应该增加

- [ ] **TC-005**：重复提交检测
  - 提交卖出订单后立即再次提交
  - 验证指标：`duplicateOrderPrevented` 和 `orderRejectedByDuplicate` 应该增加

#### 阶段2：集成测试（开盘后1小时内）

- [ ] **TC-003**：卖出数量超过可用持仓（有未成交订单）
  - 先提交一个未成交订单
  - 再次提交订单验证是否被拒绝

- [ ] **TC-007**：卖空检测（如果有卖空持仓）
  - 触发账户余额同步
  - 验证是否检测到卖空持仓并自动平仓

- [ ] **TC-009**：交易推送订阅
  - 提交订单后验证是否收到推送
  - 验证指标：`tradePushReceived` 应该增加

---

## 🧪 模拟测试方法（非交易时间）

### 方法1：Mock 测试

**创建 Mock 测试脚本**：
```typescript
// 模拟持仓验证测试
const mockPosition = { actualQuantity: 100, pendingQuantity: 0 };
const mockSellQuantity = 50;

// 测试通过场景
if (mockSellQuantity <= mockPosition.actualQuantity - mockPosition.pendingQuantity) {
  console.log('✅ 持仓验证通过');
} else {
  console.log('❌ 持仓验证失败');
}
```

### 方法2：代码审查

**审查关键代码逻辑**：
- `calculateAvailablePosition()` 方法
- `validateSellPosition()` 方法
- `checkAvailablePosition()` 方法
- 卖空检测逻辑

---

## 📊 当前状态总结

### ✅ 已完成的工作

1. **代码实施**：所有核心功能已实现
2. **数据库迁移**：监控指标表已创建
3. **监控系统**：监控指标 API 已部署
4. **测试文档**：测试计划和指南已创建
5. **监控脚本**：实时监控脚本已创建

### ⏳ 待交易时间验证

1. **功能测试**：需要实际订单提交
2. **集成测试**：需要实际订单状态变更
3. **性能测试**：需要实际交易负载
4. **交易推送**：需要实际推送事件

---

## 🎯 建议行动

### 非交易时间

1. **代码审查**
   - 检查关键逻辑是否正确
   - 验证错误处理是否完善

2. **文档完善**
   - 确认测试计划完整
   - 准备测试数据

3. **环境准备**
   - 确认测试账户可用
   - 确认测试标的持仓

### 交易时间

1. **开盘前30分钟**
   - 启动监控脚本
   - 检查系统状态

2. **开盘后立即测试**
   - 执行基础功能测试
   - 观察指标变化

3. **持续监控**
   - 观察系统运行情况
   - 记录异常情况

---

## 📝 测试记录模板

### 非交易时间检查清单

**日期**：2025-12-12  
**时间**：非交易时间

- [x] API 服务健康检查
- [x] 监控指标 API 可用
- [x] 数据库表已创建
- [x] 持仓数据可查询
- [ ] 代码逻辑审查（待完成）
- [ ] 测试数据准备（待完成）

### 交易时间测试记录

**日期**：待定  
**交易时段**：待定

| 测试用例 | 执行时间 | 结果 | 指标变化 | 备注 |
|---------|---------|------|---------|------|
| TC-001 | | | | |
| TC-002 | | | | |
| TC-005 | | | | |

---

## ✅ 总结

**当前状态**：
- ✅ 系统已准备就绪
- ✅ 所有代码已实施
- ✅ 监控系统已部署
- ⏳ 等待交易时间进行实际测试

**下一步**：
1. 等待交易时间
2. 开盘前启动监控
3. 开盘后执行测试
4. 记录测试结果

---

**最后更新**：2025-12-12

