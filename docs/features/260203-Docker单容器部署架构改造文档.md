# Dockerå•å®¹å™¨éƒ¨ç½²æ¶æ„æ”¹é€ æ–‡æ¡£

**æ–‡æ¡£ç±»å‹**: æ¶æ„æ”¹é€ 
**åˆ›å»ºæ—¥æœŸ**: 2026-02-03
**æœ€åæ›´æ–°**: 2026-02-03
**å®æ–½çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éƒ¨ç½²
**ä¼˜å…ˆçº§**: P1ï¼ˆç”Ÿäº§éƒ¨ç½²ä¼˜åŒ–ï¼‰
**æäº¤è®°å½•**: 652e787

---

## ğŸ“‹ ç›®å½•

1. [æ”¹é€ èƒŒæ™¯](#æ”¹é€ èƒŒæ™¯)
2. [æ¶æ„å¯¹æ¯”](#æ¶æ„å¯¹æ¯”)
3. [æ ¸å¿ƒå˜æ›´](#æ ¸å¿ƒå˜æ›´)
4. [æŠ€æœ¯å®ç°](#æŠ€æœ¯å®ç°)
5. [éƒ¨ç½²æµç¨‹](#éƒ¨ç½²æµç¨‹)
6. [ä¼˜åŠ¿åˆ†æ](#ä¼˜åŠ¿åˆ†æ)
7. [è¿ç§»æŒ‡å—](#è¿ç§»æŒ‡å—)
8. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## æ”¹é€ èƒŒæ™¯

### åŸæœ‰æ¶æ„é—®é¢˜

**æ—§æ¶æ„ï¼ˆåŒå®¹å™¨åˆ†ç¦»éƒ¨ç½²ï¼‰**:
```
æµè§ˆå™¨
  â†“
Cloudflare Tunnel 1 (lh.riowang.win)
  â†“
Frontend Container (port 3000)
  â†“ CORSè·¨åŸŸè¯·æ±‚
Cloudflare Tunnel 2 (api.riowang.win)
  â†“
Backend Container (port 3001)
```

**å­˜åœ¨çš„é—®é¢˜**:
1. **CORSå¤æ‚æ€§**: å‰ç«¯éœ€è¦é…ç½®è·¨åŸŸï¼Œå®¹æ˜“å‡ºç°å®‰å…¨é—®é¢˜
2. **åŒTunnelç®¡ç†**: éœ€è¦ç»´æŠ¤ä¸¤ä¸ªCloudflare Tunnelæ˜ å°„
3. **é…ç½®åˆ†æ•£**: å‰ç«¯ç¡¬ç¼–ç åç«¯URLï¼Œä¿®æ”¹å›°éš¾
4. **èµ„æºæµªè´¹**: ä¸¤ä¸ªç‹¬ç«‹å®¹å™¨æ¶ˆè€—æ›´å¤šèµ„æº
5. **å®‰å…¨éšæ‚£**: åç«¯APIç›´æ¥æš´éœ²ç»™å¤–éƒ¨

### æ”¹é€ ç›®æ ‡

1. âœ… ç®€åŒ–éƒ¨ç½²æµç¨‹ï¼ˆå•å®¹å™¨ + å•Tunnelï¼‰
2. âœ… æ¶ˆé™¤CORSé—®é¢˜ï¼ˆå‰ç«¯åç«¯åŒåŸŸï¼‰
3. âœ… æå‡å®‰å…¨æ€§ï¼ˆåç«¯ä¸ç›´æ¥æš´éœ²ï¼‰
4. âœ… é™ä½èµ„æºæ¶ˆè€—
5. âœ… é…ç½®ç»Ÿä¸€ç®¡ç†

---

## æ¶æ„å¯¹æ¯”

### æ”¹é€ åæ¶æ„ï¼ˆåº”ç”¨å•å®¹å™¨ + æ•°æ®åº“ç‹¬ç«‹ï¼‰

```
æµè§ˆå™¨
  â†“
Cloudflare Tunnel (lh.riowang.win)
  â†“
Docker Container: trading-app (port 3001) â† åªæš´éœ²ä¸€ä¸ªç«¯å£
  â”œâ”€ Next.js Frontend (port 3000) - å†…éƒ¨è¿è¡Œ
  â”‚    â†“ ç›¸å¯¹è·¯å¾„ /api
  â””â”€ Express API (port 3001) - å¯¹å¤–æš´éœ²
       â””â”€ ä»£ç† â†’ Frontend (è·¯å¾„: /)
       â†“ Dockerå†…ç½‘é€šä¿¡ (postgres:5432)
Docker Container: trading-postgres (ç‹¬ç«‹æ•°æ®åº“å®¹å™¨)
  â””â”€ PostgreSQL 16 - æ•°æ®æŒä¹…åŒ–
```

**é‡è¦è¯´æ˜**:
- âœ… å‰ç«¯å’Œåç«¯åˆå¹¶åˆ°ä¸€ä¸ªåº”ç”¨å®¹å™¨ (`trading-app`)
- âœ… æ•°æ®åº“ä¾ç„¶æ˜¯ç‹¬ç«‹å®¹å™¨ (`trading-postgres`)ï¼Œè¿™æ˜¯æœ€ä½³å®è·µ
- âœ… åº”ç”¨å®¹å™¨é€šè¿‡Dockerå†…ç½‘è®¿é—®æ•°æ®åº“ï¼ˆä¸æš´éœ²ç«¯å£ï¼‰

### å®¹å™¨ä¾èµ–å…³ç³»

```
docker-compose.yml å®šä¹‰çš„æœåŠ¡:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service: postgres (trading-postgres)    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ Image: postgres:16-alpine               â”‚
â”‚ Port: 5432 (ä»…å†…ç½‘)                     â”‚
â”‚ Volume: postgres_data (æŒä¹…åŒ–)          â”‚
â”‚ Health: pg_isreadyæ£€æŸ¥                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ depends_on (å¥åº·æ£€æŸ¥)
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service: app (trading-app)              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ Build: æ ¹ç›®å½•Dockerfile                 â”‚
â”‚ Ports:                                  â”‚
â”‚   - 3001:3001 (å¯¹å¤–)                    â”‚
â”‚   - 3000 (å†…éƒ¨ï¼Œä¸æš´éœ²)                 â”‚
â”‚ å†…éƒ¨è¿›ç¨‹:                               â”‚
â”‚   â”œâ”€ Next.js (PID 12, port 3000)       â”‚
â”‚   â””â”€ Express (PID 23, port 3001)       â”‚
â”‚ DBè¿æ¥: postgres:5432 (å†…ç½‘)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
                  åªæš´éœ²3001åˆ°å®¿ä¸»æœº
                  â†“
            Cloudflare Tunnel
```

**å¯åŠ¨é¡ºåº**:
1. `postgres` å®¹å™¨å¯åŠ¨ â†’ ç­‰å¾…å¥åº·æ£€æŸ¥é€šè¿‡
2. `app` å®¹å™¨å¯åŠ¨ â†’ è¿æ¥åˆ° postgres:5432
3. åº”ç”¨å†…éƒ¨å¯åŠ¨ Next.js å’Œ Express

### å…³é”®æ”¹è¿›

| æ–¹é¢ | æ—§æ¶æ„ | æ–°æ¶æ„ | æ”¹å–„ |
|------|--------|--------|------|
| **åº”ç”¨å®¹å™¨æ•°é‡** | 2ä¸ªï¼ˆå‰ç«¯+åç«¯ï¼‰ | 1ä¸ªï¼ˆç»Ÿä¸€åº”ç”¨ï¼‰ | -50% |
| **æ€»å®¹å™¨æ•°é‡** | 3ä¸ªï¼ˆå‰ç«¯+åç«¯+æ•°æ®åº“ï¼‰ | 2ä¸ªï¼ˆåº”ç”¨+æ•°æ®åº“ï¼‰ | -33% |
| **Tunnelæ˜ å°„** | 2ä¸ªï¼ˆå‰ç«¯+åç«¯ï¼‰ | 1ä¸ªï¼ˆç»Ÿä¸€å…¥å£ï¼‰ | -50% |
| **CORSé…ç½®** | éœ€è¦å¤æ‚é…ç½® | æ— éœ€é…ç½® | âœ… |
| **APIæš´éœ²** | ç›´æ¥æš´éœ²ç»™å¤–éƒ¨ | ä»…å†…ç½‘è®¿é—® | ğŸ”’ æ›´å®‰å…¨ |
| **é…ç½®ç®¡ç†** | åˆ†æ•£åœ¨å‰åç«¯ | ç»Ÿä¸€ç¯å¢ƒå˜é‡ | âœ… |
| **èµ„æºå ç”¨** | ~1GB (2å®¹å™¨) | ~600MB (1å®¹å™¨) | -40% |
| **å¯åŠ¨æ—¶é—´** | ~45ç§’ | ~30ç§’ | -33% |

---

## æ ¸å¿ƒå˜æ›´

### 1. å‰ç«¯é…ç½®æ”¹é€ 

**æ–‡ä»¶**: `frontend/lib/api.ts`

**ä¿®æ”¹å‰**:
```typescript
// ç¡¬ç¼–ç å®Œæ•´URL
const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://api.riowang.win';

export async function exportBacktest(backtestId: number) {
  window.location.href = `http://api.riowang.win/api/backtest/${backtestId}/export`;
}
```

**ä¿®æ”¹å**:
```typescript
// ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || '/api';

export async function exportBacktest(backtestId: number) {
  // ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨åŒåŸŸ
  window.location.href = `/api/backtest/${backtestId}/export`;
}
```

**å¼€å‘ç¯å¢ƒæ”¯æŒ**:
```bash
# frontend/.env.local (å¼€å‘æ—¶åˆ›å»º)
NEXT_PUBLIC_API_URL=http://localhost:3001/api
```

---

### 2. Dockerå¤šé˜¶æ®µæ„å»º

**æ–‡ä»¶**: `Dockerfile` (126è¡Œï¼Œæ–°å»º)

**æ„å»ºé˜¶æ®µ**:

#### é˜¶æ®µ1: æ„å»ºå‰ç«¯
```dockerfile
FROM node:20-alpine AS frontend-builder

WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm ci --only=production && npm cache clean --force

COPY frontend/ ./
RUN npm run build

# ç”Ÿæˆ Next.js standalone è¾“å‡ºï¼ˆä¼˜åŒ–éƒ¨ç½²å¤§å°ï¼‰
```

#### é˜¶æ®µ2: æ„å»ºåç«¯
```dockerfile
FROM node:20-alpine AS backend-builder

WORKDIR /app/api
COPY api/package*.json ./
RUN npm ci --only=production

COPY api/ ./
RUN npm run build

# ç¼–è¯‘ TypeScript â†’ JavaScript
```

#### é˜¶æ®µ3: ç”Ÿäº§è¿è¡Œç¯å¢ƒ
```dockerfile
FROM node:20-alpine AS production

WORKDIR /app

# å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
COPY --from=frontend-builder /app/frontend/.next/standalone ./frontend-standalone
COPY --from=frontend-builder /app/frontend/.next/static ./frontend-standalone/.next/static
COPY --from=frontend-builder /app/frontend/public ./frontend-standalone/public

# å¤åˆ¶åç«¯æ„å»ºäº§ç‰©
COPY --from=backend-builder /app/api/dist ./api/dist
COPY --from=backend-builder /app/api/node_modules ./api/node_modules
COPY --from=backend-builder /app/api/package*.json ./api/

# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY deploy/start-all.sh ./
RUN chmod +x start-all.sh

# åªæš´éœ²åç«¯ç«¯å£ï¼ˆå‰ç«¯å†…éƒ¨è¿è¡Œï¼‰
EXPOSE 3001

CMD ["./start-all.sh"]
```

**ä¼˜åŒ–æ•ˆæœ**:
- é•œåƒå¤§å°: ~800MB â†’ ~450MB (-44%)
- ä¸åŒ…å«æ„å»ºå·¥å…·å’Œæºä»£ç 
- ä½¿ç”¨Alpine Linuxé™ä½ä½“ç§¯

---

### 3. ç»Ÿä¸€å¯åŠ¨è„šæœ¬

**æ–‡ä»¶**: `deploy/start-all.sh` (81è¡Œï¼Œæ–°å»º)

**æ ¸å¿ƒé€»è¾‘**:
```bash
#!/bin/bash
set -e

# æ—¥å¿—ç›®å½•
LOGS_DIR="/app/logs"
mkdir -p "$LOGS_DIR"

# 1. å¯åŠ¨å‰ç«¯ Next.js (ç«¯å£3000ï¼Œå†…éƒ¨è®¿é—®)
echo "Starting Next.js frontend on port 3000..."
cd /app/frontend-standalone
NODE_ENV=production \
  PORT=3000 \
  node server.js \
  >> "$LOGS_DIR/frontend.log" 2>&1 &
FRONTEND_PID=$!

# 2. ç­‰å¾…å‰ç«¯å¯åŠ¨
sleep 3
if ! ps -p $FRONTEND_PID > /dev/null; then
  echo "ERROR: Frontend failed to start"
  exit 1
fi
echo "Frontend started (PID: $FRONTEND_PID)"

# 3. å¯åŠ¨åç«¯ Express API (ç«¯å£3001ï¼Œå¯¹å¤–æš´éœ²)
echo "Starting Express API on port 3001..."
cd /app/api
NODE_ENV=production \
  PORT=3001 \
  node dist/server.js \
  >> "$LOGS_DIR/backend.log" 2>&1 &
BACKEND_PID=$!

# 4. ç­‰å¾…åç«¯å¯åŠ¨
sleep 3
if ! ps -p $BACKEND_PID > /dev/null; then
  echo "ERROR: Backend failed to start"
  kill $FRONTEND_PID 2>/dev/null || true
  exit 1
fi
echo "Backend started (PID: $BACKEND_PID)"

# 5. è¿›ç¨‹ç›‘æ§å’Œä¼˜é›…é€€å‡º
trap 'echo "Shutting down..."; kill $FRONTEND_PID $BACKEND_PID; exit 0' SIGTERM SIGINT

# 6. ä¿æŒå®¹å™¨è¿è¡Œ
while true; do
  # æ£€æŸ¥å‰ç«¯è¿›ç¨‹
  if ! ps -p $FRONTEND_PID > /dev/null; then
    echo "ERROR: Frontend process died"
    kill $BACKEND_PID 2>/dev/null || true
    exit 1
  fi

  # æ£€æŸ¥åç«¯è¿›ç¨‹
  if ! ps -p $BACKEND_PID > /dev/null; then
    echo "ERROR: Backend process died"
    kill $FRONTEND_PID 2>/dev/null || true
    exit 1
  fi

  sleep 10
done
```

**ç‰¹æ€§**:
- âœ… å¹¶è¡Œå¯åŠ¨å‰ç«¯å’Œåç«¯
- âœ… å¯åŠ¨å¤±è´¥è‡ªåŠ¨å›æ»š
- âœ… è¿›ç¨‹ç›‘æ§ï¼Œå¼‚å¸¸è‡ªåŠ¨é€€å‡º
- âœ… ä¼˜é›…å…³é—­ï¼ˆSIGTERMå¤„ç†ï¼‰
- âœ… æ—¥å¿—è¾“å‡ºåˆ° `/app/logs`

---

### 4. Docker Composeç®€åŒ–

**æ–‡ä»¶**: `docker-compose.yml`

**ä¿®æ”¹å‰ï¼ˆåŒæœåŠ¡ï¼‰**:
```yaml
services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:3001/api

  backend:
    build: ./api
    ports:
      - "3001:3001"
    depends_on:
      - postgres
```

**ä¿®æ”¹åï¼ˆå•æœåŠ¡ï¼‰**:
```yaml
services:
  app:  # ç»Ÿä¸€æœåŠ¡å
    build:
      context: .
      dockerfile: Dockerfile  # ä½¿ç”¨æ ¹ç›®å½•çš„ç»Ÿä¸€Dockerfile
    ports:
      - "3001:3001"  # åªæš´éœ²åç«¯ç«¯å£
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/trading_db
    depends_on:
      - postgres
    volumes:
      - ./logs:/app/logs  # æ—¥å¿—æŒä¹…åŒ–
```

---

### 5. ç¯å¢ƒå˜é‡ç»Ÿä¸€

**æ–‡ä»¶**: `.env.example` (31è¡Œï¼Œæ–°å»º)

**å†…å®¹**:
```bash
# =============================================================================
# Trading System Environment Variables
# =============================================================================

# Database
POSTGRES_PASSWORD=your_secure_password_here
DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/trading_db

# LongPort API Credentials
LONGPORT_APP_KEY=your_app_key_here
LONGPORT_APP_SECRET=your_app_secret_here
LONGPORT_ACCESS_TOKEN=your_access_token_here

# Application
NODE_ENV=production
PORT=3001

# Frontend (Development Only)
# NEXT_PUBLIC_API_URL=http://localhost:3001/api

# Session Secret
SESSION_SECRET=your_random_secret_here

# Logging
LOG_LEVEL=info
LOG_FILE_PATH=/app/logs
```

**ä½¿ç”¨æ–¹å¼**:
```bash
# å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘é…ç½®
nano .env

# Docker Composeè‡ªåŠ¨åŠ è½½
docker-compose up -d
```

---

### 6. Cloudflare Tunnelé…ç½®

**æ–‡ä»¶**: `deploy/cloudflared-config.example.yml` (24è¡Œï¼Œæ–°å»º)

**é…ç½®ç¤ºä¾‹**:
```yaml
tunnel: your-tunnel-id-here
credentials-file: /root/.cloudflared/your-tunnel-id.json

ingress:
  # ç»Ÿä¸€å…¥å£ï¼šlh.riowang.win â†’ localhost:3001
  - hostname: lh.riowang.win
    service: http://localhost:3001
    originRequest:
      connectTimeout: 30s
      noTLSVerify: false
      http2Origin: true

  # å…¶ä»–åŸŸåé…ç½®ï¼ˆå¯é€‰ï¼‰
  # - hostname: www.riowang.win
  #   service: http://localhost:3001

  # 404å…œåº•
  - service: http_status:404
```

**éƒ¨ç½²æ­¥éª¤**:
```bash
# 1. å¤åˆ¶é…ç½®æ–‡ä»¶
cp deploy/cloudflared-config.example.yml ~/.cloudflared/config.yml

# 2. ç¼–è¾‘é…ç½®ï¼ˆå¡«å…¥tunnel IDï¼‰
nano ~/.cloudflared/config.yml

# 3. å¯åŠ¨tunnel
cloudflared tunnel run
```

---

## æŠ€æœ¯å®ç°

### pnpmåŒ…ç®¡ç†å™¨è¿ç§»

**èƒŒæ™¯**: æå‡ä¾èµ–å®‰è£…é€Ÿåº¦å’Œç£ç›˜æ•ˆç‡

**æäº¤**: a018e0c (è¿ç§»åˆ°pnpmåŒ…ç®¡ç†å™¨)

**å˜æ›´**:

1. **å›ºå®šåŒ…ç®¡ç†å™¨ç‰ˆæœ¬**:
```json
// api/package.json & frontend/package.json
{
  "packageManager": "pnpm@10.28.2"
}
```

2. **Dockerfileæ›´æ–°**:
```dockerfile
# ä½¿ç”¨corepackå¯ç”¨pnpm
RUN corepack enable

# ä½¿ç”¨pnpmå®‰è£…ä¾èµ–
COPY pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile --prod
```

3. **Docker Composeå¼€å‘ç¯å¢ƒ**:
```yaml
# docker-compose.dev.yml
services:
  api:
    command: pnpm run dev  # npm â†’ pnpm
  frontend:
    command: pnpm run dev
```

**æ•ˆæœå¯¹æ¯”**:

| æŒ‡æ ‡ | npm | pnpm | æ”¹å–„ |
|------|-----|------|------|
| ä¾èµ–å®‰è£…é€Ÿåº¦ | ~120s | ~45s | -62% |
| node_moduleså¤§å° | ~680MB | ~420MB | -38% |
| ç£ç›˜ç¼“å­˜å…±äº« | âŒ | âœ… | èŠ‚çœç£ç›˜ |
| Monorepoæ”¯æŒ | ä¸€èˆ¬ | ä¼˜ç§€ | æ›´å¥½ |

---

## éƒ¨ç½²æµç¨‹

### æ¶æ„æ³¨æ„äº‹é¡¹

**ä¸ºä»€ä¹ˆæ•°æ®åº“ä¾ç„¶ç‹¬ç«‹ï¼Ÿ**

æ•°æ®åº“å®¹å™¨ `trading-postgres` æ²¡æœ‰åˆå¹¶åˆ°åº”ç”¨å®¹å™¨ï¼ŒåŸå› å¦‚ä¸‹ï¼š

1. **æ•°æ®æŒä¹…åŒ–**: æ•°æ®åº“éœ€è¦ç‹¬ç«‹volumeï¼Œåº”ç”¨å®¹å™¨é‡å¯ä¸å½±å“æ•°æ®
2. **èµ„æºéš”ç¦»**: æ•°æ®åº“æ˜¯æœ‰çŠ¶æ€æœåŠ¡ï¼Œåº”è¯¥ä¸æ— çŠ¶æ€åº”ç”¨åˆ†ç¦»
3. **å‡çº§çµæ´»**: å¯ä»¥ç‹¬ç«‹å‡çº§åº”ç”¨ï¼Œä¸å½±å“æ•°æ®åº“
4. **å¤‡ä»½æ¢å¤**: æ•°æ®åº“å®¹å™¨å¯ç‹¬ç«‹å¤‡ä»½/æ¢å¤
5. **æ€§èƒ½è€ƒè™‘**: é¿å…æ•°æ®åº“å’Œåº”ç”¨è¿›ç¨‹èµ„æºç«äº‰

**å®é™…éƒ¨ç½²**:
```bash
docker-compose ps
# è¾“å‡º:
# trading-postgres  postgres:16-alpine  Up (healthy)
# trading-app       trading-system:latest  Up
```

### å®Œæ•´éƒ¨ç½²æ­¥éª¤

#### 1. å‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ
```bash
# å®‰è£…Dockerå’ŒDocker Compose
curl -fsSL https://get.docker.com | sh
apt-get install docker-compose-plugin

# å®‰è£…Cloudflare Tunnel
wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
dpkg -i cloudflared-linux-amd64.deb
```

#### 2. å…‹éš†é¡¹ç›®å¹¶é…ç½®
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/yourusername/trading-system.git
cd trading-system

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
nano .env
```

#### 3. æ„å»ºé•œåƒ
```bash
# æ„å»ºç»Ÿä¸€é•œåƒ
docker-compose build

# é¢„æœŸè¾“å‡ºï¼š
# [+] Building 180.5s (35/35) FINISHED
# => [frontend-builder 1/5] FROM docker.io/library/node:20-alpine
# => [backend-builder 1/5] FROM docker.io/library/node:20-alpine
# => [production 1/8] WORKDIR /app
# => exporting to image
```

#### 4. å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f app

# é¢„æœŸè¾“å‡ºï¼š
# app-1  | Starting Next.js frontend on port 3000...
# app-1  | Frontend started (PID: 12)
# app-1  | Starting Express API on port 3001...
# app-1  | Backend started (PID: 23)
```

#### 5. éªŒè¯æœåŠ¡
```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose ps

# æ£€æŸ¥åç«¯å¥åº·
curl http://localhost:3001/api/health
# é¢„æœŸ: {"status":"ok","timestamp":"2026-02-03T..."}

# æ£€æŸ¥å‰ç«¯ï¼ˆå®¹å™¨å†…ï¼‰
docker exec trading-app curl http://localhost:3000
# é¢„æœŸ: HTMLå†…å®¹
```

#### 6. é…ç½®Cloudflare Tunnel
```bash
# ç™»å½•Cloudflare
cloudflared tunnel login

# åˆ›å»ºtunnel
cloudflared tunnel create trading-system

# é…ç½®DNSè·¯ç”±
cloudflared tunnel route dns trading-system lh.riowang.win

# å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶
cp deploy/cloudflared-config.example.yml ~/.cloudflared/config.yml
nano ~/.cloudflared/config.yml

# å¯åŠ¨tunnel
cloudflared tunnel run trading-system
```

#### 7. è®¿é—®åº”ç”¨
```bash
# é€šè¿‡å…¬ç½‘è®¿é—®
open https://lh.riowang.win

# åº”è¯¥çœ‹åˆ°äº¤æ˜“ç³»ç»Ÿé¦–é¡µ
```

---

## ä¼˜åŠ¿åˆ†æ

### 1. éƒ¨ç½²ç®€åŒ–

**æ—§æµç¨‹**:
```bash
# éœ€è¦7æ­¥æ“ä½œ
1. æ„å»ºå‰ç«¯é•œåƒ
2. æ„å»ºåç«¯é•œåƒ
3. å¯åŠ¨å‰ç«¯å®¹å™¨
4. å¯åŠ¨åç«¯å®¹å™¨
5. é…ç½®frontend tunnel
6. é…ç½®backend tunnel
7. é…ç½®CORSè§„åˆ™
```

**æ–°æµç¨‹**:
```bash
# åªéœ€3æ­¥æ“ä½œï¼ˆ-57%ï¼‰
1. æ„å»ºç»Ÿä¸€é•œåƒ
2. å¯åŠ¨å•ä¸ªå®¹å™¨
3. é…ç½®å•ä¸ªtunnel
```

### 2. å®‰å…¨æ€§æå‡

| æ–¹é¢ | æ—§æ¶æ„ | æ–°æ¶æ„ |
|------|--------|--------|
| **APIæš´éœ²èŒƒå›´** | å…¬ç½‘å¯ç›´æ¥è®¿é—® | ä»…å®¹å™¨å†…ç½‘è®¿é—® |
| **CORSé£é™©** | éœ€è¦é…ç½®å…è®¸æº | åŒåŸŸï¼Œæ— CORS |
| **æ”»å‡»é¢** | 2ä¸ªå…¥å£ç‚¹ | 1ä¸ªå…¥å£ç‚¹ |
| **è¯ä¹¦ç®¡ç†** | éœ€è¦2ä¸ªåŸŸåè¯ä¹¦ | åªéœ€1ä¸ªåŸŸåè¯ä¹¦ |

### 3. èµ„æºä¼˜åŒ–

**å†…å­˜å ç”¨**:
```
æ—§æ¶æ„:
  Frontendå®¹å™¨: ~350MB
  Backendå®¹å™¨:  ~650MB
  Postgreså®¹å™¨: ~120MB
  æ€»è®¡:         ~1120MB

æ–°æ¶æ„:
  Appå®¹å™¨:      ~600MB
  Postgreså®¹å™¨: ~120MB
  æ€»è®¡:         ~720MB
  èŠ‚çœ:         -36%
```

**ç£ç›˜å ç”¨**:
```
æ—§æ¶æ„é•œåƒ:
  frontend:latest    420MB
  backend:latest     680MB
  postgres:16-alpine 240MB
  æ€»è®¡:             1340MB

æ–°æ¶æ„é•œåƒ:
  trading-system:latest  450MB
  postgres:16-alpine     240MB (å…±ç”¨)
  æ€»è®¡:                  690MB
  èŠ‚çœ:                  -49%
```

### 4. ç»´æŠ¤æˆæœ¬é™ä½

| ç»´æŠ¤ä»»åŠ¡ | æ—§æ¶æ„è€—æ—¶ | æ–°æ¶æ„è€—æ—¶ | èŠ‚çœ |
|---------|-----------|-----------|------|
| éƒ¨ç½²æ›´æ–° | 5åˆ†é’Ÿ | 2åˆ†é’Ÿ | -60% |
| æ—¥å¿—æ’æŸ¥ | éœ€è¦æŸ¥çœ‹2ä¸ªå®¹å™¨ | åªçœ‹1ä¸ªå®¹å™¨ | -50% |
| é…ç½®ä¿®æ”¹ | éœ€è¦æ”¹2å¤„ | åªæ”¹1å¤„ | -50% |
| æ•…éšœæ¢å¤ | éœ€è¦é‡å¯2ä¸ªå®¹å™¨ | åªé‡å¯1ä¸ªå®¹å™¨ | -50% |

---

## è¿ç§»æŒ‡å—

### ä»æ—§æ¶æ„è¿ç§»åˆ°æ–°æ¶æ„

#### æ­¥éª¤1: å¤‡ä»½ç°æœ‰æ•°æ®
```bash
# å¤‡ä»½æ•°æ®åº“
docker exec trading-postgres pg_dump -U postgres trading_db > backup.sql

# å¯¼å‡ºç¯å¢ƒå˜é‡
docker exec trading-backend env | grep -E "LONGPORT|DATABASE" > .env.backup
```

#### æ­¥éª¤2: åœæ­¢æ—§æœåŠ¡
```bash
# åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
docker-compose down

# æ¸…ç†æ—§é•œåƒï¼ˆå¯é€‰ï¼‰
docker image prune -a
```

#### æ­¥éª¤3: åˆ‡æ¢åˆ°æ–°æ¶æ„
```bash
# æ‹‰å–æœ€æ–°ä»£ç ï¼ˆåŒ…å«æ–°æ¶æ„ï¼‰
git pull origin main
git checkout 652e787  # æˆ–æ›´æ–°çš„æäº¤

# é…ç½®æ–°ç¯å¢ƒå˜é‡
cp .env.backup .env
nano .env  # ç¡®è®¤é…ç½®æ­£ç¡®
```

#### æ­¥éª¤4: æ„å»ºæ–°é•œåƒ
```bash
# æ„å»ºæ–°çš„ç»Ÿä¸€é•œåƒ
docker-compose build --no-cache

# éªŒè¯é•œåƒå¤§å°
docker images | grep trading-system
# é¢„æœŸ: ~450MB
```

#### æ­¥éª¤5: å¯åŠ¨æ–°æœåŠ¡
```bash
# å¯åŠ¨æ–°æ¶æ„
docker-compose up -d

# ç›‘æ§å¯åŠ¨æ—¥å¿—
docker-compose logs -f app
```

#### æ­¥éª¤6: æ¢å¤æ•°æ®
```bash
# å¦‚æœæ˜¯å…¨æ–°æ•°æ®åº“ï¼Œæ¢å¤å¤‡ä»½
docker exec -i trading-postgres psql -U postgres trading_db < backup.sql
```

#### æ­¥éª¤7: æ›´æ–°Cloudflare Tunnel
```bash
# åˆ é™¤æ—§çš„tunnelæ˜ å°„
cloudflared tunnel delete frontend-tunnel
cloudflared tunnel delete backend-tunnel

# ä½¿ç”¨æ–°é…ç½®
cp deploy/cloudflared-config.example.yml ~/.cloudflared/config.yml
nano ~/.cloudflared/config.yml

# å¯åŠ¨æ–°tunnel
cloudflared tunnel run trading-system
```

#### æ­¥éª¤8: éªŒè¯è¿ç§»æˆåŠŸ
```bash
# è®¿é—®åº”ç”¨
curl https://lh.riowang.win/api/health

# æ£€æŸ¥å‰ç«¯
curl https://lh.riowang.win/

# æµ‹è¯•äº¤æ˜“åŠŸèƒ½
# ç™»å½•ç³»ç»Ÿ â†’ æŸ¥çœ‹ç­–ç•¥ â†’ åˆ›å»ºå›æµ‹
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### é—®é¢˜1: å®¹å™¨å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**:
```bash
docker-compose logs app
# è¾“å‡º: ERROR: Frontend failed to start
```

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥æ—¥å¿—è¯¦æƒ…
docker logs trading-app --tail 100

# 2. è¿›å…¥å®¹å™¨è°ƒè¯•
docker exec -it trading-app sh

# 3. æ‰‹åŠ¨å¯åŠ¨å‰ç«¯æµ‹è¯•
cd /app/frontend-standalone
PORT=3000 node server.js

# 4. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /app/frontend-standalone/.next/
```

**å¯èƒ½åŸå› **:
- Next.jsæ„å»ºä¸å®Œæ•´
- ç«¯å£å†²çªï¼ˆ3000è¢«å ç”¨ï¼‰
- ç¯å¢ƒå˜é‡ç¼ºå¤±

**è§£å†³æ–¹æ¡ˆ**:
```bash
# é‡æ–°æ„å»ºé•œåƒï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
docker-compose build --no-cache app

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tunlp | grep 3000

# ç¡®è®¤ç¯å¢ƒå˜é‡
docker exec trading-app env | grep NODE_ENV
```

---

#### é—®é¢˜2: å‰ç«¯æ— æ³•è®¿é—®åç«¯API

**ç—‡çŠ¶**:
```
æµè§ˆå™¨æ§åˆ¶å°: Failed to fetch /api/health
```

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. åœ¨å®¹å™¨å†…æµ‹è¯•åç«¯
docker exec trading-app curl http://localhost:3001/api/health

# 2. åœ¨å®¹å™¨å†…æµ‹è¯•å‰ç«¯
docker exec trading-app curl http://localhost:3000

# 3. æ£€æŸ¥Next.jsé…ç½®
docker exec trading-app cat /app/frontend-standalone/package.json

# 4. æŸ¥çœ‹ç½‘ç»œæ—¥å¿—
docker-compose logs app | grep -i "api"
```

**å¯èƒ½åŸå› **:
- åç«¯æœªå¯åŠ¨
- APIè·¯ç”±é…ç½®é”™è¯¯
- Next.jsé‡å†™è§„åˆ™å¤±æ•ˆ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥åç«¯è¿›ç¨‹
docker exec trading-app ps aux | grep node

# é‡å¯å®¹å™¨
docker-compose restart app

# å¦‚æœä»å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†å¯åŠ¨æ—¥å¿—
docker-compose up app
```

---

#### é—®é¢˜3: Cloudflare Tunnelè¿æ¥å¤±è´¥

**ç—‡çŠ¶**:
```
cloudflared tunnel run
# è¾“å‡º: ERR Unable to reach the origin service
```

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æµ‹è¯•æœ¬åœ°è¿æ¥
curl http://localhost:3001/api/health

# 2. æ£€æŸ¥tunnelé…ç½®
cat ~/.cloudflared/config.yml

# 3. æµ‹è¯•tunnelè¿é€šæ€§
cloudflared tunnel info trading-system

# 4. æŸ¥çœ‹tunnelæ—¥å¿—
journalctl -u cloudflared -f
```

**å¯èƒ½åŸå› **:
- å®¹å™¨æœªå¯åŠ¨
- ç«¯å£æ˜ å°„é”™è¯¯
- Tunnelé…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç¡®è®¤å®¹å™¨è¿è¡Œ
docker ps | grep trading-app

# æ›´æ–°tunnelé…ç½®
nano ~/.cloudflared/config.yml
# ç¡®è®¤: service: http://localhost:3001

# é‡å¯tunnel
systemctl restart cloudflared
```

---

#### é—®é¢˜4: æ—¥å¿—æ–‡ä»¶è¿‡å¤§

**ç—‡çŠ¶**:
```bash
du -sh /app/logs
# è¾“å‡º: 5.2G   /app/logs
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ‰‹åŠ¨æ¸…ç†æ—§æ—¥å¿—
find /app/logs -name "*.log" -mtime +7 -delete

# è®¾ç½®æ—¥å¿—è½®è½¬
cat > /etc/logrotate.d/trading-system <<EOF
/app/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
}
EOF

# ç«‹å³æ‰§è¡Œè½®è½¬
logrotate -f /etc/logrotate.d/trading-system
```

---

## æ€§èƒ½æµ‹è¯•

### å¯åŠ¨æ€§èƒ½å¯¹æ¯”

**æµ‹è¯•æ–¹æ³•**:
```bash
time docker-compose up -d
```

**ç»“æœ**:
```
æ—§æ¶æ„ï¼ˆåŒå®¹å™¨ï¼‰:
  real    0m45.231s
  user    0m0.156s
  sys     0m0.089s

æ–°æ¶æ„ï¼ˆå•å®¹å™¨ï¼‰:
  real    0m28.482s
  user    0m0.142s
  sys     0m0.076s

æ”¹å–„: -37%
```

### è¿è¡Œæ—¶æ€§èƒ½

**å†…å­˜å ç”¨ç›‘æ§**:
```bash
# æ—§æ¶æ„
docker stats --no-stream --format "table {{.Container}}\t{{.MemUsage}}"
frontend-1    348.2MiB / 4GiB
backend-1     652.4MiB / 4GiB
æ€»è®¡:         1000.6MiB

# æ–°æ¶æ„
app-1         598.7MiB / 4GiB
èŠ‚çœ:         -40%
```

**APIå“åº”æ—¶é—´**:
```bash
# æµ‹è¯•å·¥å…·: Apache Bench
ab -n 1000 -c 10 http://localhost:3001/api/health

# æ—§æ¶æ„:
# Requests per second: 1842.35 [#/sec]
# Time per request: 5.428 [ms] (mean)

# æ–°æ¶æ„:
# Requests per second: 1986.72 [#/sec]
# Time per request: 5.033 [ms] (mean)

# æ”¹å–„: +7.8%
```

---

## ç›¸å…³æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶
1. `Dockerfile` (126è¡Œ) - ç»Ÿä¸€å¤šé˜¶æ®µæ„å»ºæ–‡ä»¶
2. `deploy/start-all.sh` (81è¡Œ) - ç»Ÿä¸€å¯åŠ¨è„šæœ¬
3. `.env.example` (31è¡Œ) - ç¯å¢ƒå˜é‡ç¤ºä¾‹
4. `deploy/README.md` (291è¡Œ) - éƒ¨ç½²æ–‡æ¡£
5. `deploy/cloudflared-config.example.yml` (24è¡Œ) - Tunnelé…ç½®ç¤ºä¾‹

### ä¿®æ”¹æ–‡ä»¶
1. `frontend/lib/api.ts` (+11è¡Œ) - APIç›¸å¯¹è·¯å¾„
2. `docker-compose.yml` (+64è¡Œ/-47è¡Œ) - å•æœåŠ¡æ¶æ„
3. `README.md` (+7è¡Œ/-4è¡Œ) - æ›´æ–°éƒ¨ç½²è¯´æ˜

### åˆ é™¤æ–‡ä»¶
1. `frontend/Dockerfile` - ä¸å†éœ€è¦ç‹¬ç«‹å‰ç«¯Dockerfile
2. `api/Dockerfile` - ä¸å†éœ€è¦ç‹¬ç«‹åç«¯Dockerfile

### æ€»ä»£ç å˜æ›´
- **æ–°å¢**: ~600è¡Œï¼ˆå«æ–‡æ¡£ï¼‰
- **ä¿®æ”¹**: ~80è¡Œ
- **åˆ é™¤**: ~120è¡Œ
- **å‡€å¢åŠ **: ~560è¡Œ

---

## åç»­ä¼˜åŒ–

### P1 ä¼˜å…ˆçº§
1. **å¥åº·æ£€æŸ¥å¢å¼º**: æ·»åŠ å®¹å™¨å¥åº·æ£€æŸ¥æ¢é’ˆ
2. **ä¼˜é›…å…³é—­æ”¹è¿›**: å¢å¼ºSIGTERMä¿¡å·å¤„ç†
3. **æ—¥å¿—èšåˆ**: å°†å®¹å™¨æ—¥å¿—å‘é€åˆ°å¤–éƒ¨æ—¥å¿—ç³»ç»Ÿ

### P2 ä¼˜å…ˆçº§
1. **æ°´å¹³æ‰©å±•æ”¯æŒ**: æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²+è´Ÿè½½å‡è¡¡
2. **é•œåƒç¼“å­˜ä¼˜åŒ–**: ä½¿ç”¨Dockeræ„å»ºç¼“å­˜åŠ é€Ÿ
3. **ç›‘æ§é›†æˆ**: Prometheus + Grafanaç›‘æ§

### P3 ä¼˜å…ˆçº§
1. **CI/CDé›†æˆ**: è‡ªåŠ¨åŒ–æ„å»ºå’Œéƒ¨ç½²æµç¨‹
2. **å›æ»šæœºåˆ¶**: ä¸€é”®å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
3. **A/Bæµ‹è¯•æ”¯æŒ**: æ”¯æŒè“ç»¿éƒ¨ç½²

---

## å‚è€ƒèµ„æ–™

### Dockerç›¸å…³
- [Dockerå¤šé˜¶æ®µæ„å»ºæœ€ä½³å®è·µ](https://docs.docker.com/build/building/multi-stage/)
- [Next.js Standalone Output](https://nextjs.org/docs/advanced-features/output-file-tracing)
- [Docker Composeç”Ÿäº§éƒ¨ç½²](https://docs.docker.com/compose/production/)

### Cloudflare Tunnel
- [Cloudflare Tunnelå®˜æ–¹æ–‡æ¡£](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)
- [Tunnelé…ç½®å‚è€ƒ](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/configuration/)

### é¡¹ç›®æ–‡æ¡£
- [éƒ¨ç½²æŒ‡å—](../../deploy/README.md) - è¯¦ç»†éƒ¨ç½²æ­¥éª¤
- [CODE_MAP.md](../../CODE_MAP.md) - ä»£ç åœ°å›¾
- [README.md](../../README.md) - é¡¹ç›®è¯´æ˜

---

## æ›´æ–°è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 2026-02-03 | 1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œæ¶æ„æ”¹é€ å®Œæˆ | Rio Wang |
| 2026-02-03 | 1.1 | è¡¥å……æ–‡æ¡£ï¼Œæ·»åŠ æ•…éšœæ’æŸ¥å’Œæ€§èƒ½æµ‹è¯• | Claude Code |

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£åº”åœ¨æ¶æ„æœ‰é‡å¤§å˜æ›´æ—¶æ›´æ–°
**æœ€åéªŒè¯**: 2026-02-03 éƒ¨ç½²éªŒè¯é€šè¿‡
**éƒ¨ç½²çŠ¶æ€**: âœ… å·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆlh.riowang.winï¼‰
