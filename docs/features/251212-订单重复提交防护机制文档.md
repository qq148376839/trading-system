# 订单重复提交防护机制文档

**创建日期**: 2025-12-12  
**最后更新**: 2025-12-12  
**状态**: 已完成 ✅

---

## 📚 文档索引

### 文档结构

本文档整合了订单重复提交防护机制的所有相关文档，包括：
- 实施总结：功能实现和代码变更
- 测试计划：完整的测试用例和测试流程
- 测试执行指南：详细的测试执行步骤
- 测试状态：测试环境检查和执行状态

### 快速导航

**想了解实施情况？** → 查看「1. 实施总结」

**想了解测试计划？** → 查看「2. 测试计划」

**想了解如何执行测试？** → 查看「3. 测试执行指南」

**想了解测试状态？** → 查看「4. 测试状态」

---

# 1. 实施总结

## 📋 实施概述

**文档版本**：v1.0  
**创建时间**：2025-12-12  
**状态**：✅ 已完成实施

本文档总结订单重复提交防护机制的完整实施过程，包括功能实现、代码变更、测试计划和监控方案。

## 1. 实施目标

### 1.1 核心目标
- ✅ 防止重复卖出订单提交，避免卖空
- ✅ 准确计算可用持仓（扣除未成交订单占用）
- ✅ 检测并自动平仓卖空持仓
- ✅ 实时更新订单状态，减少竞态条件

### 1.2 成功标准
- ✅ 订单拒绝率（因持仓不足）降低至0%
- ✅ 重复订单提交事件减少至0次/天
- ✅ 卖空持仓自动检测和平仓
- ✅ 交易推送功能集成完成

## 2. 实施内容

### 2.1 核心功能实现

#### 功能1：卖出订单持仓验证 ✅
**文件**：`api/src/services/basic-execution.service.ts`

**实现内容**：
- 新增 `calculateAvailablePosition()` 方法：计算可用持仓（扣除未成交订单占用）
- 新增 `validateSellPosition()` 方法：验证卖出数量是否超过可用持仓
- 在 `executeSellIntent()` 中添加持仓验证逻辑

**关键代码**：
```typescript
// 持仓验证：验证卖出数量是否超过实际可用持仓
const positionValidation = await this.validateSellPosition(
  intent.symbol,
  intent.quantity,
  strategyId
);

if (!positionValidation.valid) {
  return {
    success: false,
    error: positionValidation.reason || '持仓验证失败',
  };
}
```

#### 功能2：订单提交去重增强 ✅
**文件**：`api/src/services/strategy-scheduler.service.ts`

**实现内容**：
- 增强 `validateStrategyExecution()` 方法：添加卖出订单持仓验证
- 新增 `checkAvailablePosition()` 方法：返回可用持仓数量
- 在 `processHoldingPosition()` 中添加持仓数量验证

**关键代码**：
```typescript
// 卖出订单持仓验证（新增）
if (intent.action === 'SELL' && intent.quantity) {
  const positionValidation = await basicExecutionService.validateSellPosition(
    symbol,
    intent.quantity,
    strategyId
  );
  if (!positionValidation.valid) {
    return {
      valid: false,
      reason: positionValidation.reason || '持仓验证失败'
    };
  }
}
```

#### 功能3：卖空检测和防护 ✅
**文件**：`api/src/services/account-balance-sync.service.ts`

**实现内容**：
- 新增 `detectShortPositions()` 方法：检测卖空持仓
- 新增 `closeShortPosition()` 方法：自动平仓卖空持仓
- 在 `syncAccountBalance()` 中集成自动检测和平仓

**关键代码**：
```typescript
// 检测卖空持仓
const shortPositions: Array<{ symbol: string; quantity: number }> = [];

for (const pos of positionsArray) {
  const quantity = parseInt(pos.quantity?.toString() || '0');
  if (quantity < 0) {
    shortPositions.push({ symbol, quantity });
  }
}

// 自动平仓卖空持仓
if (shortPositions.length > 0) {
  for (const shortPos of shortPositions) {
    await this.closeShortPosition(shortPos.symbol, shortPos.quantity);
  }
}
```

#### 功能4：交易推送集成 ✅
**文件**：`api/src/services/trade-push.service.ts`（新建）

**实现内容**：
- 创建交易推送服务：订阅 Longbridge SDK 交易推送
- 实时接收订单状态变更，立即更新可用持仓计算
- 在 `server.ts` 中启动交易推送服务

**关键代码**：
```typescript
// 订阅交易推送（TopicType.Private）
const longport = require('longport');
const { TopicType } = longport;

if (tradeCtx.subscribe) {
  await tradeCtx.subscribe([TopicType.Private]);
  this.isSubscribed = true;
}

// 设置订单变更回调
tradeCtx.setOnOrderChanged((err: Error, event: any) => {
  this.handleOrderChanged(err, event);
});
```

### 2.2 监控和日志

#### 监控指标服务 ✅
**文件**：`api/src/services/order-prevention-metrics.service.ts`（新建）

**实现内容**：
- 创建监控指标服务：跟踪关键指标
- 记录持仓验证、订单去重、卖空检测、交易推送等指标
- 提供指标查询和报告生成功能

**关键指标**：
- 持仓验证总次数、通过次数、失败次数
- 阻止重复订单提交次数
- 检测到卖空持仓次数、自动平仓次数
- 收到交易推送次数、推送错误次数

#### 监控指标 API ✅
**文件**：`api/src/routes/order-prevention-metrics.ts`（新建）

**实现内容**：
- 创建监控指标 API 端点
- 提供指标查询、重置、保存功能

**API 端点**：
- `GET /api/order-prevention-metrics`：获取当前监控指标
- `POST /api/order-prevention-metrics/reset`：重置所有监控指标
- `POST /api/order-prevention-metrics/save`：保存监控指标到数据库

#### 数据库表结构 ✅
**文件**：`api/migrations/create_order_prevention_metrics_table.sql`（新建）

**实现内容**：
- 创建监控指标表：`order_prevention_metrics`
- 记录所有关键指标的历史数据

## 3. 代码变更清单

### 3.1 新增文件

1. `api/src/services/trade-push.service.ts` - 交易推送服务
2. `api/src/services/order-prevention-metrics.service.ts` - 监控指标服务
3. `api/src/routes/order-prevention-metrics.ts` - 监控指标 API
4. `api/migrations/create_order_prevention_metrics_table.sql` - 数据库迁移脚本

### 3.2 修改文件

1. `api/src/services/basic-execution.service.ts`
   - 新增 `calculateAvailablePosition()` 方法
   - 新增 `validateSellPosition()` 方法
   - 在 `executeSellIntent()` 中添加持仓验证

2. `api/src/services/strategy-scheduler.service.ts`
   - 增强 `validateStrategyExecution()` 方法
   - 新增 `checkAvailablePosition()` 方法
   - 在 `processHoldingPosition()` 中添加持仓验证

3. `api/src/services/account-balance-sync.service.ts`
   - 新增 `detectShortPositions()` 方法
   - 新增 `closeShortPosition()` 方法
   - 在 `syncAccountBalance()` 中集成卖空检测和平仓

4. `api/src/server.ts`
   - 添加交易推送服务启动逻辑
   - 添加监控指标 API 路由

## 4. 技术实现细节

### 4.1 持仓验证逻辑

**流程**：
1. 获取实际持仓（`stockPositions()` API）
2. 查询未成交卖出订单（`todayOrders()` API）
3. 计算未成交订单占用数量（总数量 - 已成交数量）
4. 计算可用持仓（实际持仓 - 未成交订单占用）
5. 验证卖出数量是否超过可用持仓

**关键点**：
- 支持部分成交订单的未成交数量计算
- 处理不同的持仓数据结构（`channels[].positions` 和 `positions.positions`）
- 保守处理：查询失败时返回0，避免卖空

### 4.2 订单去重机制

**三层防护**：
1. **缓存检查**：`orderSubmissionCache`（60秒TTL）
2. **未成交订单检查**：`todayOrders()` API 查询
3. **数据库检查**：`execution_orders` 表查询（双重检查）

**关键点**：
- 订单提交成功后立即更新缓存
- 交易推送实时更新缓存（如果启用）
- 多重检查确保无遗漏

### 4.3 卖空检测和平仓

**流程**：
1. 账户余额同步时检测卖空持仓（数量 < 0）
2. 自动生成买入平仓订单（数量 = 绝对值）
3. 提交平仓订单
4. 记录平仓结果

**关键点**：
- 使用策略ID -1 表示系统自动平仓
- 获取当前市场价格作为买入价格
- 记录详细的平仓日志

### 4.4 交易推送集成

**流程**：
1. 系统启动时订阅交易推送（`TopicType.Private`）
2. 设置订单变更回调（`setOnOrderChanged`）
3. 收到推送后立即更新缓存和可用持仓计算

**关键点**：
- 降级处理：推送失败时降级到轮询模式
- 实时更新：订单状态变更时立即重新计算可用持仓
- 错误处理：推送错误不影响主流程

## 5. 监控和告警

### 5.1 监控指标

**关键指标**：
- 持仓验证通过率/失败率
- 阻止重复订单提交次数
- 检测到卖空持仓次数
- 自动平仓成功率
- 交易推送成功率
- 订单拒绝原因分布

### 5.2 告警规则（建议）

**告警条件**：
- 持仓验证失败率 > 10%
- 检测到卖空持仓
- 自动平仓失败
- 交易推送错误率 > 5%

## 6. 部署说明

### 6.1 数据库迁移

**执行步骤**：
```bash
# 执行数据库迁移脚本
psql -U postgres -d trading_system -f api/migrations/create_order_prevention_metrics_table.sql
```

### 6.2 配置检查

**检查项**：
- ✅ Longbridge SDK 配置正确
- ✅ 数据库连接正常
- ✅ 交易推送功能可用（可选）

### 6.3 启动顺序

1. 启动数据库
2. 执行数据库迁移
3. 启动 API 服务
4. 验证交易推送服务启动成功
5. 验证监控指标 API 可用

## 7. 后续优化建议

### 7.1 性能优化

- **缓存优化**：增加持仓缓存时间，减少API调用
- **批量查询**：批量查询多个标的的持仓和订单
- **异步处理**：异步处理卖空平仓，不阻塞主流程

### 7.2 功能增强

- **买入订单持仓验证**：买入前验证资金和持仓状态
- **持仓状态实时同步**：实时同步持仓状态，确保一致性
- **监控面板**：可视化监控指标和告警

### 7.3 测试完善

- **自动化测试**：编写自动化测试脚本
- **压力测试**：测试高并发场景下的性能
- **故障注入测试**：测试API失败时的降级处理

## 8. 风险评估

### 8.1 技术风险

**风险1：API调用失败**
- **影响**：持仓验证失败，订单可能被错误拒绝
- **应对**：保守处理，查询失败时拒绝订单

**风险2：交易推送不可用**
- **影响**：降级到轮询模式，延迟增加
- **应对**：系统自动降级，不影响主流程

### 8.2 业务风险

**风险1：持仓计算不准确**
- **影响**：订单可能被错误拒绝或错误通过
- **应对**：多重验证，保守处理

**风险2：卖空平仓失败**
- **影响**：卖空持仓未平仓，可能导致后续问题
- **应对**：记录详细日志，手动处理

---

# 2. 测试计划

## 📋 测试概述

**文档版本**：v1.0  
**创建时间**：2025-12-12  
**状态**：待测试

本文档描述订单重复提交防护机制的测试计划，包括功能测试、集成测试和性能测试。

## 1. 测试环境

### 1.1 环境要求
- **交易环境**：模拟盘环境（避免实盘风险）
- **数据库**：PostgreSQL（包含测试数据）
- **Longbridge SDK**：已配置并可用
- **测试账户**：模拟账户，包含测试持仓和资金

### 1.2 测试数据准备
- 创建测试策略实例
- 准备测试持仓（多个标的，不同数量）
- 准备测试订单（已成交、未成交、已拒绝）

## 2. 功能测试

### 2.1 卖出订单持仓验证测试

#### 测试用例 TC-001：正常卖出（持仓充足）
**前置条件**：
- 账户持有 ACHR.US 100股
- 无未成交卖出订单

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 验证订单是否成功提交
3. 检查日志中是否有持仓验证通过记录

**预期结果**：
- ✅ 订单成功提交
- ✅ 日志显示：`持仓验证通过，可用持仓=100，请求卖出=50`
- ✅ 订单状态为 `SUBMITTED` 或 `NEW`

#### 测试用例 TC-002：卖出数量超过可用持仓
**前置条件**：
- 账户持有 ACHR.US 100股
- 无未成交卖出订单

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=150
2. 验证订单是否被拒绝
3. 检查错误信息

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`可用持仓不足：实际持仓=100，未成交订单占用=0，可用持仓=100，请求卖出=150`
- ✅ 订单状态为 `REJECTED`

#### 测试用例 TC-003：卖出数量超过可用持仓（有未成交订单）
**前置条件**：
- 账户持有 ACHR.US 100股
- 已有未成交卖出订单：ACHR.US，数量=60

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 验证订单是否被拒绝
3. 检查错误信息

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`可用持仓不足：实际持仓=100，未成交订单占用=60，可用持仓=40，请求卖出=50`
- ✅ 订单状态为 `REJECTED`

#### 测试用例 TC-004：部分成交订单的持仓计算
**前置条件**：
- 账户持有 ACHR.US 100股
- 已有部分成交卖出订单：ACHR.US，总数量=60，已成交=20，未成交=40

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 验证订单是否被拒绝
3. 检查错误信息

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`可用持仓不足：实际持仓=100，未成交订单占用=40，可用持仓=60，请求卖出=50`
- ✅ 订单状态为 `REJECTED`

### 2.2 订单去重测试

#### 测试用例 TC-005：重复提交检测（缓存检查）
**前置条件**：
- 策略ID=1，标的=ACHR.US
- 60秒内已提交过卖出订单

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 立即（5秒内）再次提交相同订单
3. 验证第二次提交是否被拒绝

**预期结果**：
- ✅ 第一次提交成功
- ❌ 第二次提交被拒绝
- ❌ 错误信息：`标的 ACHR.US 在最近60秒内已提交过 SELL 订单，防止重复提交`

#### 测试用例 TC-006：重复提交检测（未成交订单检查）
**前置条件**：
- 策略ID=1，标的=ACHR.US
- 已有未成交卖出订单：ACHR.US，状态=NewStatus

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 验证订单是否被拒绝

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`标的 ACHR.US 已有未成交订单，不允许重复下单`

### 2.3 卖空检测和平仓测试

#### 测试用例 TC-007：卖空检测
**前置条件**：
- 账户持有 ACHR.US -50股（卖空持仓）

**测试步骤**：
1. 触发账户余额同步（`AccountBalanceSyncService.syncAccountBalance()`）
2. 检查是否检测到卖空持仓
3. 检查是否自动生成平仓订单

**预期结果**：
- ✅ 检测到卖空持仓：`检测到卖空持仓: ACHR.US，持仓数量=-50`
- ✅ 自动生成买入平仓订单：数量=50
- ✅ 平仓订单成功提交

#### 测试用例 TC-008：多个卖空持仓平仓
**前置条件**：
- 账户持有 ACHR.US -50股
- 账户持有 AAPL.US -30股

**测试步骤**：
1. 触发账户余额同步
2. 检查是否检测到所有卖空持仓
3. 检查是否自动生成所有平仓订单

**预期结果**：
- ✅ 检测到2个卖空持仓
- ✅ 自动生成2个买入平仓订单
- ✅ 所有平仓订单成功提交

### 2.4 交易推送测试

#### 测试用例 TC-009：交易推送订阅
**前置条件**：
- 系统已启动
- Longbridge SDK 可用

**测试步骤**：
1. 启动系统
2. 检查日志中是否有交易推送订阅成功记录
3. 提交一个测试订单
4. 检查是否收到推送通知

**预期结果**：
- ✅ 日志显示：`[交易推送] 已订阅交易推送 (TopicType.Private)`
- ✅ 订单提交后收到推送通知
- ✅ 日志显示：`[交易推送] 收到订单变更: ...`

#### 测试用例 TC-010：交易推送更新缓存
**前置条件**：
- 交易推送已订阅
- 订单提交缓存为空

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 等待推送通知（1-2秒）
3. 检查订单提交缓存是否已更新
4. 立即再次提交相同订单
5. 验证第二次提交是否被拒绝

**预期结果**：
- ✅ 订单提交成功
- ✅ 收到推送通知
- ✅ 订单提交缓存已更新
- ❌ 第二次提交被拒绝（缓存检查）

## 3. 集成测试

### 3.1 完整流程测试

#### 测试用例 TC-011：完整卖出流程
**前置条件**：
- 账户持有 ACHR.US 100股
- 策略ID=1已启动

**测试步骤**：
1. 策略生成卖出信号（止盈触发）
2. 验证持仓验证是否通过
3. 验证订单是否成功提交
4. 验证订单状态是否正确更新
5. 验证可用持仓是否重新计算

**预期结果**：
- ✅ 持仓验证通过
- ✅ 订单成功提交
- ✅ 订单状态正确更新
- ✅ 可用持仓重新计算（扣除未成交订单占用）

#### 测试用例 TC-012：卖空自动平仓流程
**前置条件**：
- 账户持有 ACHR.US -50股（卖空持仓）
- 账户余额同步服务已启动（每5分钟）

**测试步骤**：
1. 等待账户余额同步触发（或手动触发）
2. 检查是否检测到卖空持仓
3. 检查是否自动生成平仓订单
4. 检查平仓订单是否成功提交
5. 等待订单成交
6. 检查卖空持仓是否已平仓

**预期结果**：
- ✅ 检测到卖空持仓
- ✅ 自动生成平仓订单
- ✅ 平仓订单成功提交
- ✅ 订单成交后，卖空持仓已平仓

## 4. 性能测试

### 4.1 持仓验证性能测试

#### 测试用例 TC-013：持仓验证响应时间
**前置条件**：
- 账户持有多个标的（10个）
- 每个标的有多个未成交订单（5个）

**测试步骤**：
1. 记录开始时间
2. 调用 `calculateAvailablePosition()` 计算可用持仓
3. 记录结束时间
4. 计算响应时间

**预期结果**：
- ✅ 响应时间 < 500ms（单次查询）
- ✅ 响应时间 < 1000ms（包含API调用）

### 4.2 并发测试

#### 测试用例 TC-014：并发订单提交
**前置条件**：
- 账户持有 ACHR.US 100股
- 无未成交订单

**测试步骤**：
1. 同时提交10个卖出订单（数量=10）
2. 验证只有1个订单成功提交
3. 验证其他9个订单被拒绝

**预期结果**：
- ✅ 只有1个订单成功提交
- ✅ 其他9个订单被拒绝（去重检查）
- ✅ 无重复订单提交

## 5. 边界测试

### 5.1 边界条件测试

#### 测试用例 TC-015：零持仓卖出
**前置条件**：
- 账户持有 ACHR.US 0股

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=1
2. 验证订单是否被拒绝

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`可用持仓不足：实际持仓=0，未成交订单占用=0，可用持仓=0，请求卖出=1`

#### 测试用例 TC-016：负数持仓（卖空）
**前置条件**：
- 账户持有 ACHR.US -50股（卖空持仓）

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=10
2. 验证订单是否被拒绝

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息：`可用持仓不足：实际持仓=-50，未成交订单占用=0，可用持仓=0，请求卖出=10`

#### 测试用例 TC-017：API调用失败降级
**前置条件**：
- Longbridge API 不可用（模拟）

**测试步骤**：
1. 调用 `calculateAvailablePosition()`
2. 验证是否返回保守值（0）
3. 验证订单是否被拒绝

**预期结果**：
- ✅ 返回保守值：`{ actualQuantity: 0, pendingQuantity: 0, availableQuantity: 0 }`
- ❌ 订单被拒绝（保守处理）

## 6. 回归测试

### 6.1 现有功能回归测试

#### 测试用例 TC-018：正常买入流程不受影响
**前置条件**：
- 账户资金充足
- 无持仓

**测试步骤**：
1. 提交买入订单：ACHR.US，数量=100
2. 验证订单是否成功提交

**预期结果**：
- ✅ 订单成功提交（买入流程不受影响）

#### 测试用例 TC-019：正常卖出流程（无持仓验证问题）
**前置条件**：
- 账户持有 ACHR.US 100股
- 无未成交订单

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 验证订单是否成功提交

**预期结果**：
- ✅ 订单成功提交（正常卖出流程不受影响）

## 7. 测试执行计划

### 7.1 测试阶段

**阶段1：单元测试**（1天）
- TC-001 至 TC-004：持仓验证测试
- TC-005 至 TC-006：订单去重测试

**阶段2：集成测试**（1天）
- TC-007 至 TC-010：卖空检测和交易推送测试
- TC-011 至 TC-012：完整流程测试

**阶段3：性能和边界测试**（1天）
- TC-013 至 TC-017：性能和边界测试

**阶段4：回归测试**（0.5天）
- TC-018 至 TC-019：回归测试

### 7.2 测试环境

- **测试环境**：模拟盘环境
- **测试账户**：专用测试账户
- **测试数据**：预置测试持仓和订单

### 7.3 测试工具

- **手动测试**：Postman / curl
- **自动化测试**：Jest / Mocha（可选）
- **日志分析**：查看系统日志

## 8. 验收标准

### 8.1 功能验收标准

- ✅ 所有P0功能测试用例通过率 ≥ 100%
- ✅ 所有P1功能测试用例通过率 ≥ 95%
- ✅ 无严重缺陷（P0级别）

### 8.2 性能验收标准

- ✅ 持仓验证响应时间 < 500ms（单次查询）
- ✅ 订单提交去重检查响应时间 < 100ms
- ✅ 并发订单提交无重复订单

### 8.3 稳定性验收标准

- ✅ 系统运行24小时无崩溃
- ✅ 订单拒绝率（因持仓不足）降低至0%
- ✅ 重复订单提交事件减少至0次/天

---

# 3. 测试执行指南

## 📋 测试准备

### 1. 环境检查

**检查项**：
- ✅ 数据库迁移已完成（`order_prevention_metrics` 表已创建）
- ✅ API 服务已启动
- ✅ Longbridge SDK 配置正确
- ✅ 测试账户可用（模拟盘环境）

**验证命令**：
```bash
# 检查数据库表是否存在
psql -U postgres -d trading_db -c "\d order_prevention_metrics"

# 检查 API 服务是否运行
curl http://localhost:3001/api/health

# 检查监控指标 API 是否可用
curl http://localhost:3001/api/order-prevention-metrics
```

## 2. 测试数据准备

### 2.1 准备测试持仓

**方法1：通过 Longbridge SDK 手动设置**
- 在模拟盘环境中手动买入测试标的
- 记录标的代码和持仓数量

**方法2：使用现有持仓**
- 查看当前账户持仓：`GET /api/positions`
- 选择有持仓的标的进行测试

### 2.2 准备测试策略

**创建测试策略实例**（如果需要）：
```sql
-- 查询现有策略
SELECT id, name, status FROM strategies WHERE status = 'RUNNING';

-- 创建测试策略实例（如果不存在）
INSERT INTO strategy_instances (strategy_id, symbol, current_state, context)
VALUES (1, 'ACHR.US', 'HOLDING', '{"quantity": 100, "entryPrice": 10.0}')
ON CONFLICT DO NOTHING;
```

## 3. 功能测试执行

### 3.1 测试用例 TC-001：正常卖出（持仓充足）

**前置条件**：
- 账户持有 ACHR.US 100股
- 无未成交卖出订单

**测试步骤**：
1. 查看当前持仓：
   ```bash
   curl http://localhost:3001/api/positions
   ```

2. 提交卖出订单（通过策略或API）

3. 查看订单状态：
   ```bash
   curl http://localhost:3001/api/orders/today
   ```

4. 查看日志：
   ```bash
   grep "持仓验证" log.log | tail -20
   ```

**预期结果**：
- ✅ 订单成功提交
- ✅ 日志显示：`持仓验证通过，可用持仓=100，请求卖出=50`
- ✅ 订单状态为 `SUBMITTED` 或 `NEW`

**验证命令**：
```bash
# 查看监控指标
curl http://localhost:3001/api/order-prevention-metrics | jq '.data.metrics.position_validation_passed'
```

### 3.2 测试用例 TC-002：卖出数量超过可用持仓

**前置条件**：
- 账户持有 ACHR.US 100股
- 无未成交卖出订单

**测试步骤**：
1. 手动触发卖出订单（数量=150）
2. 查看订单是否被拒绝
3. 查看错误信息

**预期结果**：
- ❌ 订单被拒绝
- ❌ 错误信息包含：`可用持仓不足`
- ✅ 监控指标记录失败次数

**验证命令**：
```bash
# 查看监控指标
curl http://localhost:3001/api/order-prevention-metrics | jq '.data.metrics.position_validation_failed'

# 查看订单拒绝原因
curl http://localhost:3001/api/orders/today | jq '.[] | select(.status == "REJECTED")'
```

### 3.3 测试用例 TC-005：重复提交检测（缓存检查）

**前置条件**：
- 策略ID=1，标的=ACHR.US
- 无未成交订单

**测试步骤**：
1. 提交卖出订单：ACHR.US，数量=50
2. 立即（5秒内）再次提交相同订单
3. 验证第二次提交是否被拒绝

**预期结果**：
- ✅ 第一次提交成功
- ❌ 第二次提交被拒绝
- ❌ 错误信息：`在最近60秒内已提交过 SELL 订单`

**验证命令**：
```bash
# 查看监控指标
curl http://localhost:3001/api/order-prevention-metrics | jq '.data.metrics.duplicate_order_by_cache'
```

### 3.4 测试用例 TC-007：卖空检测

**前置条件**：
- 账户持有 ACHR.US -50股（卖空持仓）
   - 注意：需要手动创建卖空持仓（在模拟盘中）

**测试步骤**：
1. 手动触发账户余额同步：
   ```bash
   curl -X POST http://localhost:3001/api/quant/sync-balance
   ```

2. 查看是否检测到卖空持仓
3. 查看是否自动生成平仓订单

**预期结果**：
- ✅ 检测到卖空持仓
- ✅ 自动生成买入平仓订单
- ✅ 平仓订单成功提交

**验证命令**：
```bash
# 查看监控指标
curl http://localhost:3001/api/order-prevention-metrics | jq '.data.metrics.short_position_detected'

# 查看平仓订单
curl http://localhost:3001/api/orders/today | jq '.[] | select(.side == "BUY" and .symbol == "ACHR.US")'

# 查看日志
grep "卖空持仓" log.log | tail -10
```

### 3.5 测试用例 TC-009：交易推送订阅

**前置条件**：
- 系统已启动
- Longbridge SDK 可用

**测试步骤**：
1. 检查系统启动日志：
   ```bash
   grep "交易推送" log.log | head -5
   ```

2. 提交一个测试订单
3. 检查是否收到推送通知

**预期结果**：
- ✅ 日志显示：`[交易推送] 已订阅交易推送`
- ✅ 订单提交后收到推送通知
- ✅ 日志显示：`[交易推送] 收到订单变更`

**验证命令**：
```bash
# 查看交易推送日志
grep "交易推送" log.log | tail -20

# 查看监控指标
curl http://localhost:3001/api/order-prevention-metrics | jq '.data.metrics.trade_push_received'
```

## 4. 监控指标验证

### 4.1 查看当前指标

```bash
# 获取所有监控指标
curl http://localhost:3001/api/order-prevention-metrics | jq '.'

# 获取指标报告
curl http://localhost:3001/api/order-prevention-metrics | jq '.data.report'
```

### 4.2 验证指标更新

**测试步骤**：
1. 执行一个测试用例
2. 立即查看监控指标
3. 验证指标是否更新

**示例**：
```bash
# 执行持仓验证测试
# ... 执行测试 ...

# 查看指标
curl http://localhost:3001/api/order-prevention-metrics | jq '.data.metrics.position_validation_total'
```

## 5. 日志验证

### 5.1 关键日志查看

**持仓验证日志**：
```bash
grep "持仓验证" log.log | tail -20
```

**订单去重日志**：
```bash
grep "阻止重复订单" log.log | tail -20
```

**卖空检测日志**：
```bash
grep "卖空持仓" log.log | tail -20
```

**交易推送日志**：
```bash
grep "交易推送" log.log | tail -20
```

**监控指标日志**：
```bash
grep "监控指标" log.log | tail -20
```

## 6. 快速测试脚本

### 6.1 自动化测试脚本（示例）

```bash
#!/bin/bash

# 测试脚本：订单重复提交防护机制

API_BASE="http://localhost:3001"
TEST_SYMBOL="ACHR.US"

echo "=== 订单重复提交防护机制测试 ==="
echo ""

# 1. 检查 API 服务
echo "1. 检查 API 服务..."
curl -s "$API_BASE/api/health" | jq '.'
echo ""

# 2. 查看当前持仓
echo "2. 查看当前持仓..."
curl -s "$API_BASE/api/positions" | jq ".[] | select(.symbol == \"$TEST_SYMBOL\")"
echo ""

# 3. 查看监控指标
echo "3. 查看监控指标..."
curl -s "$API_BASE/api/order-prevention-metrics" | jq '.data.metrics'
echo ""

# 4. 查看今日订单
echo "4. 查看今日订单..."
curl -s "$API_BASE/api/orders/today" | jq ".[] | select(.symbol == \"$TEST_SYMBOL\")"
echo ""

echo "=== 测试完成 ==="
```

## 7. 常见问题排查

### 7.1 持仓验证失败

**问题**：持仓验证总是失败

**排查步骤**：
1. 检查持仓数据是否正确：
   ```bash
   curl http://localhost:3001/api/positions
   ```

2. 检查未成交订单：
   ```bash
   curl http://localhost:3001/api/orders/today
   ```

3. 查看详细日志：
   ```bash
   grep "计算可用持仓" log.log | tail -10
   ```

### 7.2 交易推送未收到

**问题**：交易推送未收到

**排查步骤**：
1. 检查推送服务是否启动：
   ```bash
   grep "交易推送.*已订阅" log.log
   ```

2. 检查推送错误：
   ```bash
   grep "交易推送.*错误" log.log
   ```

3. 检查监控指标：
   ```bash
   curl http://localhost:3001/api/order-prevention-metrics | jq '.data.metrics.trade_push_error'
   ```

### 7.3 卖空检测未触发

**问题**：卖空持仓未检测到

**排查步骤**：
1. 检查账户余额同步是否执行：
   ```bash
   grep "账户余额同步" log.log | tail -10
   ```

2. 手动触发同步：
   ```bash
   curl -X POST http://localhost:3001/api/quant/sync-balance
   ```

3. 查看持仓数据：
   ```bash
   curl http://localhost:3001/api/positions | jq '.[] | select(.quantity < 0)'
   ```

---

# 4. 测试状态

## ✅ 测试环境检查结果

### 1. API 服务状态
- ✅ **健康检查**：通过
- ✅ **数据库连接**：正常
- ✅ **监控指标 API**：可用

### 2. 监控指标状态
- ✅ **API 端点**：`/api/order-prevention-metrics` 正常响应
- ✅ **初始状态**：所有指标为 0（正常，尚未执行操作）

### 3. 持仓数据
- ✅ **持仓数据**：正常获取
- ✅ **测试标的**：ACHR.US 有 197 股持仓（可用于测试）

### 4. 已知问题
- ⚠️ **TradeContext 初始化失败**：`/api/orders/today` 无法访问
  - 原因：网络连接问题或 Longbridge API 服务暂时不可用
  - 影响：无法查询今日订单（不影响持仓验证功能）
  - 建议：检查网络连接或稍后重试

## 📋 可执行的测试用例

### ✅ 可以立即测试的功能

#### TC-001：正常卖出（持仓充足）
**测试标的**：ACHR.US（持仓 197 股）

**测试步骤**：
1. 通过策略触发卖出订单（数量 < 197）
2. 或通过 API 直接提交卖出订单

**验证方法**：
```bash
# 查看监控指标（持仓验证通过次数应该增加）
curl http://localhost:3001/api/order-prevention-metrics

# 查看日志
grep "持仓验证" log.log | tail -10
```

#### TC-002：卖出数量超过可用持仓
**测试标的**：ACHR.US（持仓 197 股）

**测试步骤**：
1. 尝试卖出数量 > 197（例如 200）
2. 验证订单是否被拒绝

**验证方法**：
```bash
# 查看监控指标（持仓验证失败次数应该增加）
curl http://localhost:3001/api/order-prevention-metrics

# 查看日志
grep "持仓验证失败" log.log | tail -10
```

#### TC-005：重复提交检测（缓存检查）
**测试标的**：ACHR.US

**测试步骤**：
1. 提交卖出订单
2. 立即（5秒内）再次提交相同订单
3. 验证第二次提交是否被拒绝

**验证方法**：
```bash
# 查看监控指标（重复订单阻止次数应该增加）
curl http://localhost:3001/api/order-prevention-metrics
```

## 🔧 Windows 友好的测试命令

### 查看监控指标（不使用 jq）

**PowerShell 方式**：
```powershell
# 获取监控指标
$response = Invoke-RestMethod -Uri "http://localhost:3001/api/order-prevention-metrics"
$response.data.metrics | ConvertTo-Json -Depth 10

# 查看持仓验证指标
$response.data.metrics.positionValidationTotal
$response.data.metrics.positionValidationPassed
$response.data.metrics.positionValidationFailed
```

**curl + 格式化**：
```bash
# 查看完整响应（格式化）
curl http://localhost:3001/api/order-prevention-metrics | python -m json.tool

# 或者保存到文件查看
curl http://localhost:3001/api/order-prevention-metrics > metrics.json
type metrics.json
```

## 📊 测试执行建议

### 阶段1：基础功能测试（当前可执行）

1. **持仓验证测试**
   - TC-001：正常卖出
   - TC-002：卖出数量超过可用持仓

2. **订单去重测试**
   - TC-005：重复提交检测

### 阶段2：集成测试（需要 TradeContext 可用）

1. **未成交订单测试**
   - TC-003：卖出数量超过可用持仓（有未成交订单）
   - TC-004：部分成交订单的持仓计算

2. **卖空检测测试**
   - TC-007：卖空检测
   - TC-008：多个卖空持仓平仓

3. **交易推送测试**
   - TC-009：交易推送订阅
   - TC-010：交易推送更新缓存

## 🐛 问题排查

### TradeContext 初始化失败

**问题**：`/api/orders/today` 返回错误

**可能原因**：
1. 网络连接问题
2. Longbridge API 服务暂时不可用
3. Token 过期或无效
4. SDK 配置问题

**排查步骤**：
1. 检查网络连接：
   ```bash
   ping openapi.longportapp.com
   ```

2. 检查 Token 状态：
   ```bash
   curl http://localhost:3001/api/token-refresh/status
   ```

3. 尝试刷新 Token：
   ```bash
   curl -X POST http://localhost:3001/api/token-refresh/refresh
   ```

4. 查看详细错误日志：
   ```bash
   grep "TradeContext" log.log | tail -20
   ```

## 📝 测试记录模板

### 测试执行记录

| 测试用例ID | 测试用例名称 | 执行时间 | 执行结果 | 备注 |
|-----------|-------------|---------|---------|------|
| TC-001 | 正常卖出（持仓充足） | | ✅/❌ | |
| TC-002 | 卖出数量超过可用持仓 | | ✅/❌ | |
| TC-005 | 重复提交检测（缓存检查） | | ✅/❌ | |

### 监控指标记录

**测试前指标**：
- 持仓验证总次数：0
- 持仓验证通过次数：0
- 持仓验证失败次数：0
- 阻止重复订单总数：0

**测试后指标**：
- 持仓验证总次数：___
- 持仓验证通过次数：___
- 持仓验证失败次数：___
- 阻止重复订单总数：___

## ✅ 下一步行动

1. **执行基础功能测试**
   - 使用 ACHR.US（197 股）进行测试
   - 验证持仓验证功能
   - 验证订单去重功能

2. **解决 TradeContext 问题**
   - 检查网络连接
   - 检查 Token 状态
   - 查看错误日志

3. **继续集成测试**
   - 待 TradeContext 可用后执行
   - 测试未成交订单检查
   - 测试卖空检测

---

## 📚 相关文档

- [卖出价格错误修复文档](251209-卖出价格错误修复文档.md) - 价格计算相关
- [动态交易策略文档](251203-动态交易策略文档.md) - 策略执行相关

---

**文档版本**：v1.0  
**最后更新**：2025-12-12  
**状态**：已完成 ✅

