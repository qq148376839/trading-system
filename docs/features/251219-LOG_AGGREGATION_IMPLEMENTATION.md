# ç­–ç•¥æ—¥å¿—èšåˆä¸é™å™ª - å®æ–½æ€»ç»“

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
- **åˆ›å»ºæ—¶é—´**ï¼š2025-12-19
- **å®æ–½æ—¥æœŸ**ï¼š2025-12-19
- **å¯¹åº”PRD**ï¼š[ç­–ç•¥æ—¥å¿—èšåˆä¸é™å™ªPRD](251219-LOG_AGGREGATION_PRD.md)
- **å®æ–½çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

## 1. å®æ–½æ¦‚è¿°

### 1.1 å®æ–½ç›®æ ‡
æ ¹æ®PRDè¦æ±‚ï¼Œä¼˜åŒ–ç­–ç•¥è°ƒåº¦å™¨çš„æ—¥å¿—è¾“å‡ºæœºåˆ¶ï¼Œå®ç°æ—¥å¿—èšåˆå’Œé™å™ªï¼Œå‡å°‘ä¸å¿…è¦çš„æ—¥å¿—è¾“å‡ºï¼Œæå‡å…³é”®ä¿¡æ¯çš„å¯è§æ€§ã€‚

### 1.2 å®æ–½èŒƒå›´
- âœ… ä¼˜åŒ– `logExecutionSummary` æ–¹æ³•ï¼Œæ”¹è¿›æ±‡æ€»æ—¥å¿—çš„è¾“å‡ºæ ¼å¼å’Œmetadataç»“æ„
- âœ… ä¿ç•™å…³é”®ä¿¡æ¯çš„å®æ—¶è¾“å‡ºï¼ˆä¿¡å·ç”Ÿæˆã€é”™è¯¯ã€é‡è¦æ“ä½œï¼‰
- âœ… ä¼˜åŒ–metadataç»“æ„ï¼Œå‡å°‘æ•°æ®åº“å­˜å‚¨ç©ºé—´

---

## 2. ä»£ç ä¿®æ”¹è¯¦æƒ…

### 2.1 ä¿®æ”¹æ–‡ä»¶
- `api/src/services/strategy-scheduler.service.ts`

### 2.2 ä¸»è¦ä¿®æ”¹å†…å®¹

#### ä¿®æ”¹1ï¼šä¼˜åŒ–æ±‡æ€»æ—¥å¿—è¾“å‡ºæ ¼å¼
**ä½ç½®**ï¼š`logExecutionSummary` æ–¹æ³•ï¼ˆç¬¬255-290è¡Œï¼‰

**ä¿®æ”¹å‰**ï¼š
- çº¯å‡€æ¨¡å¼çš„æ—¥å¿—è¾“å‡ºæ ¼å¼ä¸å¤Ÿæ¸…æ™°
- metadataç»“æ„ä¸å¤Ÿä¼˜åŒ–

**ä¿®æ”¹å**ï¼š
- æ”¹è¿›æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œä½¿ç”¨æ›´æ¸…æ™°çš„æè¿°
- ä¼˜åŒ–metadataç»“æ„ï¼š
  - **æœ‰æ´»åŠ¨æ—¶**ï¼šåŒ…å«å®Œæ•´çš„signalsã€errorsã€actionsæ•°ç»„ï¼Œä¾¿äºåç»­åˆ†æ
  - **çº¯å‡€æ¨¡å¼**ï¼šåªåŒ…å«ç»Ÿè®¡è®¡æ•°ï¼ŒèŠ‚çœæ•°æ®åº“ç©ºé—´

**ä»£ç å˜æ›´**ï¼š
```typescript
// ä¿®æ”¹å‰
logger.info(
  `ç­–ç•¥ ${summary.strategyId} æ‰§è¡Œå®Œæˆ: è€—æ—¶ ${duration}ms, ` +
  `æ‰«æ ${summary.totalTargets} (æ— é‡è¦äº‹ä»¶, IDLE: ${summary.idle.length}, HOLDING: ${summary.holding.length})`,
  { 
    metadata: { 
      strategyId: summary.strategyId,
      duration,
      totalTargets: summary.totalTargets,
      counts: {
        idle: summary.idle.length,
        holding: summary.holding.length,
        other: summary.other.length
      }
    } 
  }
);

// ä¿®æ”¹å
logger.info(
  `ç­–ç•¥ ${summary.strategyId} æ‰§è¡Œå®Œæˆ: è€—æ—¶ ${duration}ms, ` +
  `æ‰«æ ${summary.totalTargets} ä¸ªæ ‡çš„ (IDLE: ${summary.idle.length}, HOLDING: ${summary.holding.length})`,
  { 
    metadata: { 
      strategyId: summary.strategyId,
      duration,
      totalTargets: summary.totalTargets,
      counts: {
        idle: summary.idle.length,
        holding: summary.holding.length,
        other: summary.other.length
      }
    } 
  }
);
```

#### ä¿®æ”¹2ï¼šä¼˜åŒ–æœ‰æ´»åŠ¨æ—¶çš„metadataç»“æ„
**ä½ç½®**ï¼š`logExecutionSummary` æ–¹æ³•ï¼ˆç¬¬260-270è¡Œï¼‰

**ä¿®æ”¹å†…å®¹**ï¼š
- åœ¨æœ‰æ´»åŠ¨æ—¶ï¼Œmetadataä¸­åŒ…å«å®Œæ•´çš„signalsã€errorsã€actionsæ•°ç»„
- ä¾¿äºåç»­æŸ¥è¯¢å’Œåˆ†æå“ªäº›æ ‡çš„äº§ç”Ÿäº†ä¿¡å·ã€å“ªäº›å‘ç”Ÿäº†é”™è¯¯

**ä»£ç å˜æ›´**ï¼š
```typescript
// ä¿®æ”¹å
logger.info(
  `ç­–ç•¥ ${summary.strategyId} æ‰§è¡Œå®Œæˆ: è€—æ—¶ ${duration}ms, ` +
  `æ‰«æ ${summary.totalTargets} ä¸ªæ ‡çš„, ` +
  `âš ï¸ ä¿¡å· ${summary.signals.length}, ` +
  `âŒ é”™è¯¯ ${summary.errors.length}, ` +
  `âš¡ æ“ä½œ ${summary.actions.length}, ` +
  `IDLE: ${summary.idle.length}, HOLDING: ${summary.holding.length}`,
  { 
    metadata: {
      strategyId: summary.strategyId,
      duration,
      totalTargets: summary.totalTargets,
      signals: summary.signals,        // æ–°å¢ï¼šå®Œæ•´çš„ä¿¡å·åˆ—è¡¨
      errors: summary.errors,           // æ–°å¢ï¼šå®Œæ•´çš„é”™è¯¯åˆ—è¡¨
      actions: summary.actions,          // æ–°å¢ï¼šå®Œæ•´çš„æ“ä½œåˆ—è¡¨
      counts: {
        idle: summary.idle.length,
        holding: summary.holding.length,
        other: summary.other.length
      }
    }
  }
);
```

---

## 3. å®æ–½æ•ˆæœ

### 3.1 æ—¥å¿—è¾“å‡ºä¼˜åŒ–
- âœ… **çº¯å‡€æ¨¡å¼**ï¼šæ¯åˆ†é’Ÿåªè¾“å‡º1æ¡æ±‡æ€»æ—¥å¿—ï¼Œä¸å†æœ‰20+æ¡IDLEæ—¥å¿—åˆ·å±
- âœ… **æœ‰æ´»åŠ¨æ—¶**ï¼šå…³é”®ä¿¡æ¯ï¼ˆä¿¡å·ã€é”™è¯¯ã€æ“ä½œï¼‰åœ¨å¾ªç¯ä¸­å®æ—¶è¾“å‡ºï¼Œæ±‡æ€»æ—¥å¿—æä¾›ç»Ÿè®¡æ¦‚è§ˆ
- âœ… **æ•°æ®åº“ä¼˜åŒ–**ï¼šçº¯å‡€æ¨¡å¼çš„metadataåªåŒ…å«ç»Ÿè®¡è®¡æ•°ï¼Œå¤§å¹…å‡å°‘å­˜å‚¨ç©ºé—´

### 3.2 é¢„æœŸæ•ˆæœ
æ ¹æ®PRDè¦æ±‚ï¼Œå®æ–½åçš„æ—¥å¿—è¾“å‡ºæ•ˆæœï¼š

**åœºæ™¯1ï¼šç³»ç»Ÿæ­£å¸¸å¾…æœºï¼ˆæœ€å¸¸è§ï¼‰**
```
[INFO] ç­–ç•¥ 5 æ‰§è¡Œå®Œæˆ: è€—æ—¶ 200ms, æ‰«æ 20 ä¸ªæ ‡çš„ (IDLE: 18, HOLDING: 2)
```
- âœ… ä»åŸæ¥çš„20+æ¡æ—¥å¿—å‡å°‘åˆ°1æ¡
- âœ… æ•°æ®åº“æ¯åˆ†é’Ÿåªå¢åŠ 1æ¡è®°å½•

**åœºæ™¯2ï¼šè§¦å‘äº¤æ˜“ä¿¡å·**
```
[INFO] ç­–ç•¥ 5 æ ‡çš„ TSLA.US: ç”Ÿæˆä¿¡å· BUY, ä»·æ ¼=250.00, åŸå› =...
[INFO] ç­–ç•¥ 5 æ‰§è¡Œå®Œæˆ: è€—æ—¶ 250ms, æ‰«æ 20 ä¸ªæ ‡çš„, âš ï¸ ä¿¡å· 1, IDLE: 19, HOLDING: 2
```
- âœ… ä¿¡å·æ—¥å¿—å®æ—¶è¾“å‡ºï¼Œä¸ä¼šè¢«æ·¹æ²¡
- âœ… æ±‡æ€»æ—¥å¿—æä¾›ç»Ÿè®¡æ¦‚è§ˆ

---

## 4. éªŒè¯æ–¹æ³•

### 4.1 åŠŸèƒ½éªŒè¯
1. **å¯åŠ¨ç­–ç•¥**ï¼šå¯åŠ¨ä¸€ä¸ªåŒ…å«20+ä¸ªæ ‡çš„çš„ç­–ç•¥
2. **è§‚å¯Ÿæ—¥å¿—**ï¼š
   - æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ¯åˆ†é’Ÿåº”è¯¥åªçœ‹åˆ°1æ¡æ±‡æ€»æ—¥å¿—
   - å½“æœ‰ä¿¡å·ç”Ÿæˆæ—¶ï¼Œåº”è¯¥çœ‹åˆ°ä¿¡å·æ—¥å¿— + 1æ¡æ±‡æ€»æ—¥å¿—
3. **æ£€æŸ¥æ•°æ®åº“**ï¼š
   - æŸ¥è¯¢ `system_logs` è¡¨ï¼Œç¡®è®¤æ¯åˆ†é’Ÿåªæœ‰1æ¡ç­–ç•¥çº§è®°å½•
   - æ£€æŸ¥metadataå­—æ®µï¼Œç¡®è®¤ç»“æ„æ­£ç¡®

### 4.2 æ€§èƒ½éªŒè¯
- **æ—¥å¿—å†™å…¥å»¶è¿Ÿ**ï¼šåº”è¯¥ < 10msï¼ˆP99ï¼‰
- **æ•°æ®åº“å­˜å‚¨**ï¼šçº¯å‡€æ¨¡å¼çš„metadataåº”è¯¥ < 500å­—èŠ‚
- **å†…å­˜ä½¿ç”¨**ï¼šsummaryå¯¹è±¡åº”è¯¥åœ¨å¾ªç¯ç»“æŸååŠæ—¶é‡Šæ”¾

---

## 5. åç»­ä¼˜åŒ–å»ºè®®

### 5.1 å¯é€‰ä¼˜åŒ–
1. **æ—¥å¿—çº§åˆ«è°ƒæ•´**ï¼šå¯ä»¥è€ƒè™‘å°†çº¯å‡€æ¨¡å¼çš„æ—¥å¿—é™çº§ä¸º `DEBUG` çº§åˆ«ï¼Œåªåœ¨å¼€å‘è°ƒè¯•æ—¶è¾“å‡º
2. **æ‰¹é‡å†™å…¥ä¼˜åŒ–**ï¼šå¦‚æœå¤šä¸ªç­–ç•¥åŒæ—¶è¿è¡Œï¼Œå¯ä»¥è€ƒè™‘æ‰¹é‡å†™å…¥æ±‡æ€»æ—¥å¿—
3. **ç»Ÿè®¡åˆ†æ**ï¼šåˆ©ç”¨metadataä¸­çš„signalsã€errorsæ•°ç»„ï¼Œå¯ä»¥ç”Ÿæˆç­–ç•¥æ‰§è¡Œè´¨é‡æŠ¥å‘Š

### 5.2 ç›‘æ§æŒ‡æ ‡
å»ºè®®æ·»åŠ ä»¥ä¸‹ç›‘æ§æŒ‡æ ‡ï¼š
- ç­–ç•¥æ‰§è¡Œå¹³å‡è€—æ—¶
- ä¿¡å·ç”Ÿæˆé¢‘ç‡
- é”™è¯¯å‘ç”Ÿé¢‘ç‡
- æ—¥å¿—èšåˆæ•ˆæœï¼ˆæ—¥å¿—æ¡æ•°å‡å°‘æ¯”ä¾‹ï¼‰

---

## 6. ç›¸å…³æ–‡æ¡£

- [ç­–ç•¥æ—¥å¿—èšåˆä¸é™å™ªPRD](251219-LOG_AGGREGATION_PRD.md) - éœ€æ±‚æ–‡æ¡£
- [æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–æ–‡æ¡£](../features/251215-æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–æ–‡æ¡£.md) - æ—¥å¿—ç³»ç»Ÿæ¶æ„æ–‡æ¡£

---

## 7. å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | å˜æ›´äºº |
|------|------|----------|--------|
| v1.0 | 2025-12-19 | åˆå§‹å®æ–½å®Œæˆ | AI Engineer |






