# 期权策略回测模块 (Option Intraday Backtest)

**创建时间**: 2026-02-20
**状态**: 已完成

---

## 概述

实现独立的期权策略回测引擎，用于回放 `OPTION_INTRADAY_V1` 策略在指定日期的表现。核心思路：**不修改生产服务**，新建独立回测引擎，复用现有评分/退出算法。

## 架构

```
                   ┌───────────────────────┐
                   │  option-backtest      │
                   │  .service.ts (新建)    │
                   └───────┬───────────────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
   ┌───────▼──────┐ ┌─────▼──────┐ ┌──────▼──────┐
   │ kline-history │ │ intraday-  │ │ Longport    │
   │ .service.ts  │ │ data-filter│ │ SDK         │
   │ (DB: SPX/    │ │ .service   │ │ (VIX/股票/  │
   │ USD/BTC 1m)  │ │            │ │ 期权 K-line)│
   └──────────────┘ └────────────┘ └─────────────┘
                           │
                    ┌──────▼──────┐
                    │ option-     │
                    │ dynamic-    │
                    │ exit.service│
                    │ (退出判定)   │
                    └─────────────┘
```

## 数据源

| 数据 | 来源 | 方法 |
|------|------|------|
| SPX 1m K-lines | DB `market_kline_history` | `klineHistoryService.getIntradayByDate('SPX', date)` |
| USD_INDEX 1m | DB | `klineHistoryService.getIntradayByDate('USD_INDEX', date)` |
| BTC 1m | DB | `klineHistoryService.getIntradayByDate('BTC', date)` |
| VIX 1m K-lines | Longport SDK | `quoteCtx.historyCandlesticksByOffset('.VIX.US', ...)` |
| 标的股票 1m | Longport SDK | `quoteCtx.historyCandlesticksByOffset(symbol, ...)` |
| 期权合约 1m | Longport SDK | `quoteCtx.historyCandlesticksByOffset(optionSymbol, ...)` |
| 市场温度 | 固定值 50（中性） | 历史温度不可用，权重仅 10% |

## 新增文件

### 后端

| 文件 | 行数 | 说明 |
|------|------|------|
| `api/src/services/option-backtest.service.ts` | ~580 | 核心回测引擎 |
| `api/src/routes/option-backtest.ts` | ~170 | REST API 路由 |

### 前端

| 文件 | 说明 |
|------|------|
| `frontend/app/quant/backtest/option/[id]/page.tsx` | 期权回测详情页 |

### 修改文件

| 文件 | 改动 |
|------|------|
| `api/src/server.ts` | +2 行：import 和注册 `/api/option-backtest` 路由 |
| `frontend/lib/api.ts` | +30 行：`optionBacktestApi` 客户端方法 |
| `frontend/app/quant/backtest/page.tsx` | 添加 `Tabs` 组件，新增"期权回测"tab |
| `api/src/services/backtest.service.ts` | 修复 180 行预存 bug（缺失方法名） |

## 未修改的生产文件

- `option-intraday-strategy.ts`
- `option-recommendation.service.ts`
- `option-dynamic-exit.service.ts`
- `strategy-scheduler.service.ts`
- `market-data-cache.service.ts`

## 核心回测流程

```
for each date in dates:
  for each symbol in symbols:
    1. 预加载: SPX/USD/BTC from DB, underlying/VIX from Longport
    2. 预计算: BTC/USD 小时级 K-line 聚合

    for each minute from tradeWindowStart to 16:00 ET:
      if state == IDLE && minute <= tradeWindowEnd:
        a. 构建滑动窗口 MarketDataWindow（最近 100 根 1m bar）
        b. 评分: marketScore(40%) + intradayScore(40%) + timeWindowAdj(20%)
        c. 如果 |score| > entryThreshold:
           - 确定方向 (CALL/PUT)
           - 构造 ATM 期权符号
           - 拉取期权合约 1m K-line
           - 入场 → state = HOLDING

      if state == HOLDING:
        a. 获取期权当前 K-line
        b. 构建 PositionContext（虚拟时间）
        c. 调用 optionDynamicExitService.checkExitCondition()
        d. 如果触发退出 → 记录 PnL → state = IDLE

    if 收盘仍持仓 → 强制平仓
```

## API 接口

### POST /api/option-backtest

创建期权回测任务（异步执行）。

**Request Body:**
```json
{
  "dates": ["2026-02-18", "2026-02-19"],
  "symbols": ["QQQ.US"],
  "config": {
    "entryThreshold": 15,
    "riskPreference": "CONSERVATIVE",
    "positionContracts": 1,
    "tradeWindowStartET": 570,
    "tradeWindowEndET": 630,
    "maxTradesPerDay": 3
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": { "id": 42, "status": "PENDING" }
}
```

### GET /api/option-backtest/:id

获取回测结果。

**Response (完成后):**
```json
{
  "success": true,
  "data": {
    "id": 42,
    "status": "COMPLETED",
    "dates": ["2026-02-18"],
    "symbols": ["QQQ.US"],
    "trades": [
      {
        "date": "2026-02-18",
        "optionSymbol": "QQQ260218C480000.US",
        "direction": "CALL",
        "entryTime": "2026-02-18T09:42:00-05:00",
        "exitTime": "2026-02-18T10:15:00-05:00",
        "entryPrice": 2.50,
        "exitPrice": 3.75,
        "grossPnL": 125.00,
        "grossPnLPercent": 50.0,
        "exitReason": "TAKE_PROFIT: ...",
        "holdingMinutes": 33,
        "entryScore": 22.5
      }
    ],
    "summary": {
      "totalTrades": 3,
      "winningTrades": 2,
      "losingTrades": 1,
      "winRate": 66.67,
      "totalNetPnL": 180.00,
      "avgGrossPnLPercent": 15.2,
      "maxDrawdownPercent": 8.5,
      "profitFactor": 2.4,
      "avgHoldingMinutes": 28
    },
    "diagnosticLog": { ... }
  }
}
```

## 前端 UI

### 回测管理页面（Tabs 切换）

- **策略回测** tab：原有股票策略回测功能（不变）
- **期权回测** tab：
  - 结果列表表格：日期、标的、状态、交易数、胜率、总 PnL、平均 PnL%、盈利因子
  - "执行期权回测"弹窗：
    - 多日期选择器
    - 标的选择器（快捷 tag + 手动输入）
    - 策略参数卡：入场阈值、风险偏好、合约数、每日最大交易、交易窗口

### 期权回测详情页 (`/quant/backtest/option/[id]`)

- 8 项汇总指标卡片
- 逐笔 PnL 柱状图（红绿色标）
- 交易明细表（方向 tag、期权合约、入场/退出时间 ET、PnL、持仓分钟、评分、退出原因 tag）
- 数据获取诊断表
- 信号日志表（时间、方向、综合/市场/分时评分、动作 tag）

## 关键设计决策

| 决策 | 方案 | 原因 |
|------|------|------|
| 评分算法 | 在回测服务中复制（~100 行） | 不修改生产代码，最安全 |
| 退出逻辑 | 直接调用 `optionDynamicExitService.checkExitCondition()` | 已是纯函数，只依赖 PositionContext |
| 虚拟时间 | 临时替换 `global.Date` 构造函数 | checkExitCondition 内部通过 `new Date()` 获取时间 |
| 市场温度 | 固定 50 | 历史温度不可用，权重仅 10% |
| ATM 合约 | 根据标的价格 + strike 间距四舍五入 | 不调用实时期权链 API |
| DB 存储 | 复用 `backtest_results` 表，`strategy_id = -1` | 避免新建表 |

## 验证方式

1. 启动 API 服务 `cd api && pnpm dev`
2. 调用 `POST /api/option-backtest` 发起回测
3. 轮询 `GET /api/option-backtest/:id` 获取结果
4. 前端访问 `/quant/backtest`，切换到"期权回测"tab
