# 260216 — 0DTE 单腿动态风控交易方案 开发文档

**创建时间**: 2026-02-16
**完成时间**: 2026-02-17
**方案来源**: `docs/analysis/260216-0DTE-single-leg-dynamic-risk-playbook.md`
**分析依据**: `docs/analysis/260213-trading-analysis.md`
**状态**: ✅ Phase 1 + Phase 2 全部完成

---

## 1. 方案评估

### 1.1 方案核心目标

解决 02-13 暴露的关键问题：0DTE 开盘噪声放大 → V 反转 → 期权价格崩塌 → 硬安全阀才离场。方案通过四个维度改善：交易窗口、入场确认、动态退出、追踪止盈。

### 1.2 与 02-13 分析的对应关系

| 02-13 暴露的问题 | 方案中的对策 | 评估 |
|---|---|---|
| 0DTE 开盘 Gamma 风险（问题1） | 09:30-10:00 禁止 0DTE 新开仓 | **有效** — 直接规避最高风险窗口 |
| direction_confirm -5 阈值过松（问题2） | 入场阈值从 -10 提升到 -12 + 连续确认 | **有效** — 双重过滤减少噪声触发 |
| 止损后无再入场策略（问题3） | 方案未直接涉及，靠更严入场间接改善 | **部分覆盖** — V1 可接受 |
| firstHourOnly 过于严格（问题4） | 方案未放宽，保留 firstHourOnly | **未覆盖** — 但 V1 优先收紧而非放宽是正确方向 |
| 3-10 分钟冷却期放宽到 52.5%（附录分析） | 0DTE 禁用放宽或反向收紧 | **关键修复** — 避免跳过正常止损直达硬安全阀 |

### 1.3 方案风险评估

| 风险点 | 等级 | 说明 | 缓解措施 |
|---|---|---|---|
| VWAP 数据不可用 | **高** | 当前系统无 VWAP 计算，需新增 | 已从 LongPort 1m K 线自行计算，60s 缓存 + 5min 降级缓存 |
| 1m K 线获取频率受限 | **中** | LongPort API 有限流 | 60s 缓存 TTL，失败时使用 5 分钟内旧缓存 |
| 结构确认增加入场延迟 | **低** | 连续 2 根 1m 收盘确认 ≈ 额外 1-2 分钟 | 可接受的延迟换取更高确定性 |
| 阈值 -12 可能错过有效信号 | **中** | 02-12 盈利信号得分 -12.8，刚好满足 -12 | 参数可通过 DB 配置热更新 |
| 时间止损 T 依赖波动率分桶 | **低** | 开盘 30 分钟波动数据在 10:00 后可用 | 10:00 后才允许 0DTE 开仓，时序无冲突 |

### 1.4 评估结论

方案整体**可行且合理**。核心设计（禁入窗口 + 入场确认加严 + 结构/时间/PnL 三层退出）符合 02-13 暴露问题的本质。

分为 **两个阶段** 实现：
- **Phase 1（核心）**：交易窗口限制 + 入场阈值 + 连续确认 + 0DTE 止损收紧 + PnL 兜底 -25% ✅
- **Phase 2（结构增强）**：VWAP 计算 + 结构确认入场/退出 + 时间止损分桶 + 追踪止盈动态化 ✅

---

## 2. 涉及文件清单

| 文件 | 改动类型 | 改动范围 | 状态 |
|---|---|---|---|
| `api/src/services/strategies/option-intraday-strategy.ts` | **大改** | 入场逻辑（窗口、阈值、连续确认、VWAP结构确认） | ✅ |
| `api/src/services/option-dynamic-exit.service.ts` | **大改** | 退出逻辑（结构失效、时间止损、PnL 兜底收紧、追踪止盈动态化） | ✅ |
| `api/src/services/options-contract-selector.service.ts` | **中改** | 支持 0DTE 禁入期跳过当日到期合约 | ✅ |
| `api/src/services/strategy-scheduler.service.ts` | **中改** | 传递 midPrice/VWAP/方向/波动率等参数到退出服务 | ✅ |
| `api/src/services/market-data.service.ts` | **中改** | 新增 `getIntradayVWAP()` 方法（VWAP 计算 + 波动率） | ✅ |
| `api/src/services/capital-manager.service.ts` | **无改动** | 资金逻辑不受影响 | — |

---

## 3. 详细实现方案

### 3.1 Phase 1：交易窗口 + 入场阈值 + 连续确认 + 退出收紧 ✅

#### Task 1.1：0DTE 开盘禁入窗口 ✅

**文件**: `option-intraday-strategy.ts` + `options-contract-selector.service.ts`

**实际改动**:

1. `TradeWindowConfig` 新增 `zdteCooldownMinutes?: number`（默认 30）
2. `SelectOptionContractParams` 新增 `skip0DTE?: boolean`
3. 在 `generateSignal()` 中计算禁入状态：
```typescript
const zdteCooldownMinutes = this.cfg.tradeWindow?.zdteCooldownMinutes ?? 30;
const isInZdteCooldown = minutesSinceOpen >= 0 && minutesSinceOpen < zdteCooldownMinutes;
const skip0DTE = expirationMode === '0DTE' && isInZdteCooldown;
const is0DTEEntry = expirationMode === '0DTE' && !isInZdteCooldown;
```
4. 合约选择器 LongPort 路径：`skip0DTE` 时选择 `sorted.find(d => d > todayStr)`（严格 > 今天）
5. 合约选择器 Moomoo 路径：`skip0DTE` 时选择 `sorted.find(d => d.leftDay > 0)`

**日志**: `zdteFlags.isInZdteCooldown`, `zdteFlags.skip0DTE` 记录在 `OptionDecisionLogData` 中

---

#### Task 1.2：入场阈值提升（-10 → -12）✅

**文件**: `option-intraday-strategy.ts`

**实际改动**:

1. `OptionIntradayStrategyConfig` 新增 `zdteEntryThreshold?: number`（默认 12）
2. `evaluateDirectionalBuyer()` 签名新增 `is0DTE: boolean = false` 参数
3. `evaluateSpreadStrategy()` 签名新增 `is0DTE: boolean = false` 参数
4. 0DTE 时使用 `Math.max(thresholds.spreadScoreMin, zdteEntryThreshold ?? 12)` 替代标准阈值

**日志**: `zdteFlags.is0DTEEntry`, `zdteFlags.zdteEntryThreshold` 记录实际使用的阈值

---

#### Task 1.3：连续确认（Consecutive Confirm）✅

**文件**: `option-intraday-strategy.ts`

**实际改动**:

1. `OptionIntradayStrategyConfig` 新增 `consecutiveConfirmCycles?: number`（默认 2）
2. 类级别新增 `consecutiveStates: Map<string, { direction: string; count: number; lastTime: number }>`
3. 逻辑（在策略评估和合约选择之间）：
   - 方向一致且时间间隔 < 15s → `count++`
   - 方向不一致或超时 → 重置 `count = 1`
   - `count >= consecutiveConfirmCycles` → 允许入场并重置
   - 否则 → `NO_SIGNAL`（checkpoint: `consecutive_confirm`）

**日志**: `consecutiveCount` 记录当前连续确认计数

---

#### Task 1.4：0DTE 止损收紧 + 禁用冷却期放宽 ✅

**文件**: `option-dynamic-exit.service.ts` + `strategy-scheduler.service.ts`

**实际改动**:

**A. PositionContext 新增 `midPrice` 字段**
- `midPrice?: number` — `(bid+ask)/2` 中间价
- `calculatePnL()` 中 0DTE 时优先使用 midPrice：
  ```typescript
  const priceForPnL = (ctx.is0DTE && ctx.midPrice && ctx.midPrice > 0) ? ctx.midPrice : ctx.currentPrice;
  ```

**B. 0DTE PnL 兜底 -25%**
- 在 `checkExitCondition()` 中，止盈检查之后新增：
  ```typescript
  if (ctx.is0DTE && pnl.grossPnLPercent <= -25) → exitTag: '0dte_pnl_floor'
  ```

**C. 0DTE 禁用冷却期放宽**
- 0DTE 仓位全程使用标准止损阈值，不再因 3-10 分钟冷却期放宽到 1.5x
- exitTag: `0dte_stop_loss_no_widen`

**D. scheduler 传递 midPrice**
- `processOptionDynamicExit()` 新增 `optionMidPrice: number = 0` 参数
- 从 `getOptionPrice()` 的 bid/ask 计算 mid 并传入

**0DTE 退出层级（Phase 1）**:
```
Level 1: PnL 兜底  -25%（mid 价格）→ exitTag: 0dte_pnl_floor
Level 2: 标准止损  -35%（不再被冷却期放宽）→ exitTag: 0dte_stop_loss_no_widen
Level 3: 硬安全阀  -40% → 不变
```

---

### 3.2 Phase 2：VWAP 结构确认 + 时间止损 + 追踪止盈动态化 ✅

#### Task 2.1：VWAP 计算服务 ✅

**文件**: `market-data.service.ts`（新增方法）

**数据源**: LongPort SDK `candlesticks(symbol, Period.Min_1, 240, AdjustType.NoAdjust)` 获取 1m K 线

> 选择 LongPort 而非 Moomoo：LongPort 支持任意 symbol 直接查询，无需 stockId 映射。

**实际实现**:
```typescript
async getIntradayVWAP(symbol: string): Promise<{
  vwap: number;
  dataPoints: number;
  rangePct: number;
  recentKlines: { open: number; high: number; low: number; close: number; volume: number; timestamp: number }[];
} | null>
```

**返回值**:
- `vwap`: VWAP = Σ(TP × Volume) / Σ(Volume)，其中 TP = (H+L+C)/3
- `dataPoints`: 参与计算的 K 线数量
- `rangePct`: 前 30 根 K 线的波动率 = (High - Low) / Open，用于时间止损分桶
- `recentKlines`: 最近 5 根 1m K 线，用于结构确认

**缓存策略**:
- `vwapCache: Map<string, { ...data, timestamp }>` 内存缓存
- 正常 TTL: 60 秒
- 失败降级: 5 分钟内旧缓存仍可用
- 返回 null 时上游逻辑跳过结构确认

---

#### Task 2.2：结构确认入场 ✅

**文件**: `option-intraday-strategy.ts`

**实际改动**: 在连续确认通过后、合约选择之前，新增 VWAP 结构确认检查。

**逻辑**:
```
1. 调用 marketDataService.getIntradayVWAP(symbol)
2. 取最近 2 根 K 线
3. PUT 方向：
   a. 2 根收盘价均 < VWAP
   b. 无强反转阳线（实体占比 > 70% && close > VWAP）
4. CALL 方向：
   a. 2 根收盘价均 > VWAP
   b. 无强反转阴线（实体占比 > 70% && close < VWAP）
5. 条件不满足 → NO_SIGNAL（checkpoint: 'structure_confirm'）
```

**降级策略**: VWAP 获取失败 → 跳过结构确认（`logger.warn` 记录），依赖连续确认结果。

---

#### Task 2.3：结构失效止损（Level A）✅

**文件**: `option-dynamic-exit.service.ts`

**实际改动**: 在 `checkExitCondition()` 中，止盈检查之后、追踪止盈之前新增结构失效检查。

**触发条件**:
- 需要 `ctx.vwap > 0 && ctx.recentKlines.length >= 2 && ctx.optionDirection` 全部有值
- PUT 持仓：最近 2 根 K 线收盘价均 > VWAP → 做空结构失效 → 平仓
- CALL 持仓：最近 2 根 K 线收盘价均 < VWAP → 做多结构失效 → 平仓

**exitTag**: `structure_invalidation`

**降级策略**: VWAP 不可用时跳过结构失效检查，依赖 PnL 止损兜底。

---

#### Task 2.4：时间止损（Level B）✅

**文件**: `option-dynamic-exit.service.ts` + `strategy-scheduler.service.ts`

**退出服务改动**:

1. `PositionContext` 新增字段：
   - `optionDirection?: 'CALL' | 'PUT'`
   - `vwap?: number`
   - `recentKlines?: KlineData[]`
   - `entryUnderlyingPrice?: number`
   - `timeStopMinutes?: number`

2. 在 `checkExitCondition()` 结构失效检查之后新增时间止损：
```typescript
if (holdingMin >= ctx.timeStopMinutes) {
  // 检查是否有"最小顺风延续"
  // 方式A：标的创新低(PUT)/新高(CALL) - 从最近K线判断
  // 方式B：期权 mid 盈利 >= +5%
  if (!hasTailwind) → exitTag: 'time_stop_no_tailwind'
}
```

**波动率分桶**（由 scheduler 计算后传入）:

| rangePct | timeStopMinutes |
|---|---|
| ≥ 0.65% | 3 min |
| 0.45% ~ 0.65% | 5 min |
| < 0.45% | 8 min |

**Scheduler 集成改动**:

在 `processOptionDynamicExit()` 中新增步骤 6（构建 positionCtx 之前）：

```
6a. 从 optionMeta.optionType 或 symbol 解析 → optionDirection
6b. 从 context.underlyingSymbol 或 symbol 解析 → resolvedUnderlyingSymbol
6c. 从 optionMeta.underlyingPrice → entryUnderlyingPrice
6d. 调用 marketDataService.getIntradayVWAP(underlyingSymbol) → vwapData
6e. 从 rangePct 计算 → timeStopMinutes
```

所有字段传入 `positionCtx`：`optionDirection`, `vwap`, `recentKlines`, `entryUnderlyingPrice`, `timeStopMinutes`, `rangePct`, `peakPnLPercent`

---

#### Task 2.5：追踪止盈动态化 ✅

**文件**: `option-dynamic-exit.service.ts`

**实际改动**:

1. `PositionContext` 新增字段：
   - `rangePct?: number` — 30 分钟开盘波动率
   - `peakPnLPercent?: number` — 历史最高盈亏百分比（scheduler 追踪）

2. `getDynamicExitParams()` 中 0DTE 波动率分桶追踪止盈参数：
   ```
   高波动 (rangePct ≥ 0.65%): trigger=15%, trail=15%（宽松避噪声）
   中波动 (0.45~0.65%):       trigger=15%, trail=12%
   低波动 (< 0.45%):          trigger=15%, trail=10%（紧凑锁利润）
   ```
   非 0DTE 保持原有时段递减参数不变。

3. `checkExitCondition()` 中移动止损改进：
   - 使用 scheduler 追踪的 `peakPnLPercent`（精确值）替代旧的 `grossPnLPercent * 1.1` 启发式估算
   - 触发条件增加：`peakPnLPercent` 曾超过触发阈值也算（捕捉当前 PnL 已回落但峰值曾达标的情况）
   - 日志改进：`峰值X% → 当前Y%，回撤Z% ≥ trail%`
   - 新增 `exitTag: 'trailing_stop'`

---

## 4. 退出检查完整优先级（Phase 1 + Phase 2 最终版）

```
持仓退出检查顺序（每个持仓，循环检查）：
  1. 0DTE 时间强平（收盘前 180 分钟）→ exitTag: 0dte_time_stop
  2. 常规时间强平（收盘前 10 分钟）
  3. 止盈
  4. 结构失效止损（Phase 2 新增）→ exitTag: structure_invalidation
  5. 时间止损（Phase 2 新增）→ exitTag: time_stop_no_tailwind
  6. 追踪止盈（Phase 2 动态化）→ exitTag: trailing_stop
  7. 0DTE PnL 兜底 -25%（Phase 1 新增）→ exitTag: 0dte_pnl_floor
  8. 0DTE 标准止损（不放宽）→ exitTag: 0dte_stop_loss_no_widen
  9. 非 0DTE 止损（含冷却期放宽逻辑）
 10. 硬安全阀 -40%
```

---

## 5. 入场检查完整流程（Phase 1 + Phase 2 最终版）

```
入场检查顺序（每个标的）：
  1. 交易窗口检查（firstHourOnly 等）
  2. 方向确认窗口（开盘 30 分钟，大盘得分 ±5）
  3. 0DTE 禁入窗口（10:00 前禁 0DTE）→ Phase 1
  4. 策略评估（分数达标检查）
     - 0DTE: score ≤ -(zdteEntryThreshold ?? 12) → Phase 1
     - 非 0DTE: score ≤ -(spreadScoreMin)
  5. 连续确认 N 次达标 → Phase 1
  6. VWAP 结构确认（2 根 1m 收盘在 VWAP 同侧 + 无反转形态）→ Phase 2
  7. 合约选择（skip0DTE 时跳过当日到期）
  8. 下单
```

---

## 6. 配置变更汇总

### 6.1 新增配置字段

```typescript
// OptionIntradayStrategyConfig 新增
{
  tradeWindow: {
    zdteCooldownMinutes: 30,          // 0DTE 开盘禁入（默认 30 分钟）
  },
  zdteEntryThreshold: 12,             // 0DTE 入场阈值（默认 12）
  consecutiveConfirmCycles: 2,         // 连续确认次数（默认 2）
}

// SelectOptionContractParams 新增
{
  skip0DTE: false,                     // 跳过 0DTE 合约（默认 false）
}
```

### 6.2 PositionContext 新增字段（退出服务）

```typescript
interface PositionContext {
  // Phase 1
  is0DTE?: boolean;
  midPrice?: number;
  // Phase 2
  optionDirection?: 'CALL' | 'PUT';
  vwap?: number;
  recentKlines?: KlineData[];
  entryUnderlyingPrice?: number;
  timeStopMinutes?: number;
  rangePct?: number;
  peakPnLPercent?: number;
}
```

### 6.3 默认值设计原则

- 所有新增参数都有默认值，**不改变现有行为**直到显式启用
- 通过数据库 `strategy_config` JSON 字段配置，支持热更新
- 与现有深度合并逻辑兼容（`c13b441` 已修复浅合并问题）
- Phase 2 数据（VWAP/结构/时间止损）获取失败时自动降级，不阻塞核心流程

---

## 7. 日志与可观测性

### 7.1 入场日志（OptionDecisionLogData）

```typescript
interface OptionDecisionLogData {
  // ... 现有字段
  zdteFlags?: {
    isInZdteCooldown: boolean;
    skip0DTE: boolean;
    is0DTEEntry: boolean;
    zdteEntryThreshold?: number;
  };
  consecutiveCount?: number;     // 连续确认计数
}
```

### 7.2 退出日志（exitTag）

| exitTag | 含义 | Phase |
|---|---|---|
| `0dte_time_stop` | 0DTE 收盘前时间强平 | 1 |
| `0dte_pnl_floor` | 0DTE PnL 兜底 -25% | 1 |
| `0dte_stop_loss_no_widen` | 0DTE 标准止损（不放宽） | 1 |
| `structure_invalidation` | VWAP 结构失效止损 | 2 |
| `time_stop_no_tailwind` | 时间止损（无顺风延续） | 2 |
| `trailing_stop` | 追踪止盈回撤触发 | 2 |

### 7.3 退出日志附加字段

退出触发时 scheduler 日志包含：
- `midPrice`（0DTE 时）
- `vwap`, `rangePct`（VWAP 可用时）
- `T=Xmin`（时间止损分钟数）
- `dir=CALL/PUT`（期权方向）

---

## 8. 数据库变更

**无 schema 变更**。所有新配置通过现有 `strategy_config` JSON 字段存储。

连续确认状态使用内存 Map，策略重启后自动重置。

---

## 9. 测试方案

### 9.1 单元测试

| 测试项 | 文件 | 关键场景 |
|---|---|---|
| 0DTE 禁入窗口 | `option-intraday-strategy.test.ts` | 09:45 ET 0DTE 被拒，1DTE 放行；10:05 ET 0DTE 放行 |
| 入场阈值 | 同上 | score=-11 非 0DTE 触发、0DTE 不触发；score=-12 0DTE 触发 |
| 连续确认 | 同上 | 单次达标不触发；连续 2 次触发；中间方向翻转重置 |
| VWAP 结构确认 | 同上 | 2 根 K 线在 VWAP 同侧通过；反转阳线阻止；VWAP 不可用时跳过 |
| 0DTE 止损收紧 | `option-dynamic-exit.test.ts` | 0DTE 在 -25% 触发；非 0DTE 在 -35% 触发 |
| 冷却期放宽禁用 | 同上 | 0DTE 持仓 5 分钟，止损不放宽到 52.5% |
| mid 价格使用 | 同上 | 0DTE 使用 mid 计算 PnL；非 0DTE 使用 lastDone |
| 结构失效止损 | 同上 | PUT + 2 根 close > VWAP → 平仓；VWAP 不可用时跳过 |
| 时间止损 | 同上 | 持仓超过 T 分钟且无顺风 → 平仓；有顺风 → 不平 |
| 追踪止盈动态化 | 同上 | 0DTE 高波动 trail=15%；低波动 trail=10%；peakPnL 精确追踪 |
| 合约选择跳过 0DTE | `options-contract-selector.test.ts` | skip0DTE=true 时选 1DTE |

### 9.2 反事实验证（手动）

**02-13 验证目标**:
- 09:40 的信号因 0DTE 禁入窗口被阻止 → 避免 -$485 亏损
- 或者如果 10:00 后信号仍存在但得分不足 -12 → 不开仓

**02-12 验证目标**:
- 盈利交易（得分 -12.8）仍能在阈值 -12 下触发
- 确认不会因新规则完全错过盈利机会

### 9.3 线上灰度

1. 先在策略10（$2,000 期权资金）上启用 Phase 1 + Phase 2
2. 观察 3-5 个交易日的信号日志
3. 关注指标：
   - `zdte_cooldown` 拦截次数
   - `consecutive_confirm` 拦截次数
   - `structure_confirm` 拦截次数（Phase 2 新增）
   - 0DTE 止损触发位置（应在 -25% 附近而非 -40%）
   - `structure_invalidation` / `time_stop_no_tailwind` 退出次数
   - 每日交易次数（预期下降）
   - 硬安全阀触发次数（预期显著下降）

---

## 10. 风控检查清单

- [x] 所有新参数有安全默认值，不会因配置缺失导致异常行为
- [x] 0DTE 禁入不影响非 0DTE 合约的正常交易
- [x] 连续确认状态在策略重启后自动重置（内存级别，不持久化）
- [x] mid 价格为 0 或 NaN 时降级到 lastDone
- [x] VWAP 计算失败时跳过结构确认/结构失效，不阻塞交易流程
- [x] 止损收紧不会与硬安全阀冲突（-25% < -40%，顺序正确）
- [x] 新增日志检查点可追踪每个拦截原因（exitTag + zdteFlags）
- [x] 追踪止盈使用精确 peakPnLPercent 而非启发式估算
- [x] Phase 2 VWAP 数据通过 try-catch 包裹，失败不影响核心止盈止损

---

*文档结束*
