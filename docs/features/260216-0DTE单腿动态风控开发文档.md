# 260216 — 0DTE 单腿动态风控交易方案 开发文档

**创建时间**: 2026-02-16
**方案来源**: `docs/analysis/260216-0DTE-single-leg-dynamic-risk-playbook.md`
**分析依据**: `docs/analysis/260213-trading-analysis.md`

---

## 1. 方案评估

### 1.1 方案核心目标

解决 02-13 暴露的关键问题：0DTE 开盘噪声放大 → V 反转 → 期权价格崩塌 → 硬安全阀才离场。方案通过四个维度改善：交易窗口、入场确认、动态退出、追踪止盈。

### 1.2 与 02-13 分析的对应关系

| 02-13 暴露的问题 | 方案中的对策 | 评估 |
|---|---|---|
| 0DTE 开盘 Gamma 风险（问题1） | 09:30-10:00 禁止 0DTE 新开仓 | **有效** — 直接规避最高风险窗口 |
| direction_confirm -5 阈值过松（问题2） | 入场阈值从 -10 提升到 -12 + 连续确认 | **有效** — 双重过滤减少噪声触发 |
| 止损后无再入场策略（问题3） | 方案未直接涉及，靠更严入场间接改善 | **部分覆盖** — V1 可接受 |
| firstHourOnly 过于严格（问题4） | 方案未放宽，保留 firstHourOnly | **未覆盖** — 但 V1 优先收紧而非放宽是正确方向 |
| 3-10 分钟冷却期放宽到 52.5%（附录分析） | 0DTE 禁用放宽或反向收紧 | **关键修复** — 避免跳过正常止损直达硬安全阀 |

### 1.3 方案风险评估

| 风险点 | 等级 | 说明 | 缓解措施 |
|---|---|---|---|
| VWAP 数据不可用 | **高** | 当前系统无 VWAP 计算，需新增 | 需从 1m K 线自行计算，增加复杂度和延迟 |
| 1m K 线获取频率受限 | **中** | Moomoo API 有 800ms 限流 + 403 风险 | 需缓存机制，评估周期可能与 5 秒策略周期冲突 |
| 结构确认增加入场延迟 | **低** | 连续 2 根 1m 收盘确认 ≈ 额外 1-2 分钟 | 可接受的延迟换取更高确定性 |
| 阈值 -12 可能错过有效信号 | **中** | 02-12 盈利信号得分 -12.8，刚好满足 -12 | 需更多交易日验证，参数可配置 |
| 时间止损 T 依赖波动率分桶 | **低** | 开盘 30 分钟波动数据在 10:00 后可用 | 10:00 后才允许 0DTE 开仓，时序无冲突 |

### 1.4 评估结论

方案整体**可行且合理**。核心设计（禁入窗口 + 入场确认加严 + 结构/时间/PnL 三层退出）符合 02-13 暴露问题的本质。**最大技术风险是 VWAP 计算的引入** — 当前系统无此数据源，需新增。

建议将实现分为 **两个阶段**：
- **Phase 1（核心）**：交易窗口限制 + 入场阈值 + 连续确认 + 0DTE 止损收紧 + PnL 兜底 -25%
- **Phase 2（结构增强）**：VWAP 计算 + 结构确认入场/退出 + 时间止损分桶 + 追踪止盈动态化

---

## 2. 涉及文件清单

| 文件 | 改动类型 | 改动范围 |
|---|---|---|
| `api/src/services/strategies/option-intraday-strategy.ts` | **大改** | 入场逻辑重构（窗口、阈值、连续确认、结构确认） |
| `api/src/services/option-dynamic-exit.service.ts` | **大改** | 退出逻辑重构（结构失效、时间止损、PnL 兜底收紧） |
| `api/src/services/options-contract-selector.service.ts` | **中改** | 支持 0DTE 禁入期优先选 1DTE/2DTE |
| `api/src/services/strategy-scheduler.service.ts` | **小改** | 传递新参数，连续确认状态管理 |
| `api/src/services/market-data.service.ts` | **中改**（Phase 2） | 新增 VWAP 计算、1m K 线缓存 |
| `api/src/services/capital-manager.service.ts` | **无改动** | 资金逻辑不受影响 |

---

## 3. 详细实现方案

### 3.1 Phase 1：交易窗口 + 入场阈值 + 连续确认 + 退出收紧

#### Task 1.1：0DTE 开盘禁入窗口

**文件**: `option-intraday-strategy.ts`

**改动内容**: 在 `generateSignal()` 的交易窗口检查中新增 0DTE 禁入逻辑。

**配置新增**:
```typescript
// TradeWindowConfig 新增字段
interface TradeWindowConfig {
  // ... 现有字段
  zdteCooldownMinutes?: number;   // 0DTE 开盘禁入时长（默认 30，即 09:30-10:00）
}
```

**逻辑**:
```
1. 计算当前 ET 时间距开盘的分钟数
2. 如果 minutesSinceOpen < zdteCooldownMinutes（默认 30）
   a. 检查待选合约是否为 0DTE
   b. 如果是 0DTE → 返回 NO_SIGNAL（checkpoint: 'zdte_cooldown'）
   c. 如果不是 0DTE（1DTE/2DTE）→ 正常评估
3. 如果 minutesSinceOpen >= zdteCooldownMinutes → 正常评估所有合约
```

**实现位置**: 在现有 `direction_confirm` 检查之前，新增 `zdte_cooldown` 检查点。

**需要 `options-contract-selector.service.ts` 配合**: 在 0DTE 禁入期间，合约选择器需支持"跳过 0DTE、选择最近的 1DTE/2DTE"。

**`options-contract-selector.service.ts` 改动**:

```typescript
// SelectOptionContractParams 新增字段
interface SelectOptionContractParams {
  // ... 现有字段
  skip0DTE?: boolean;  // 为 true 时跳过当日到期合约，选择最近的非 0DTE
}
```

逻辑改动：在 `selectOptionContract()` 中，当 `skip0DTE === true` 时，过滤掉 `todayExpiry`，从剩余到期日中选择最近的。

---

#### Task 1.2：入场阈值提升（-10 → -12）

**文件**: `option-intraday-strategy.ts`

**改动内容**: 修改 0DTE 场景下的入场得分阈值。

**配置新增**:
```typescript
// OptionIntradayStrategyConfig 新增字段
interface OptionIntradayStrategyConfig {
  // ... 现有字段
  zdteEntryThreshold?: number;   // 0DTE 入场阈值（默认 12，即 score ≤ -12 触发 PUT）
}
```

**逻辑**: 当检测到合约为 0DTE 时，使用 `zdteEntryThreshold`（默认 12）替代标准阈值（10）。

**实现位置**: 在 `evaluateStrategies()` / `evaluateSpreadStrategies()` 中，根据 `is0DTE` 标志动态调整 `spreadScoreMin`。

```
if (is0DTE) {
  effectiveThreshold = config.zdteEntryThreshold ?? 12
} else {
  effectiveThreshold = ENTRY_THRESHOLDS[riskPreference].spreadScoreMin  // 10
}
```

**与现有 ENTRY_THRESHOLDS 的关系**: `ENTRY_THRESHOLDS.CONSERVATIVE.spreadScoreMin = 10` 是非 0DTE 的默认值。0DTE 使用独立参数覆盖。

---

#### Task 1.3：连续确认（Consecutive Confirm）

**文件**: `option-intraday-strategy.ts` + `strategy-scheduler.service.ts`

**改动内容**: 入场信号需连续 N 次评估同向达标才触发。

**配置新增**:
```typescript
// OptionIntradayStrategyConfig 新增字段
interface OptionIntradayStrategyConfig {
  // ... 现有字段
  consecutiveConfirmCycles?: number;  // 连续确认次数（默认 2）
}
```

**状态管理**: 需在策略实例级别维护每个标的的确认计数器。

```typescript
// 新增内部状态（不持久化，内存级别）
interface ConsecutiveState {
  symbol: string;
  direction: 'BEARISH' | 'BULLISH';
  count: number;
  lastEvalTime: number;  // 时间戳，用于判断是否连续
}

// Map<symbol, ConsecutiveState>
private consecutiveStates: Map<string, ConsecutiveState> = new Map();
```

**逻辑**:
```
1. 当某标的得分达标时，检查 consecutiveStates[symbol]
2. 如果方向一致且时间间隔 < 15 秒（3 个评估周期容忍）→ count++
3. 如果方向不一致或超时 → 重置 count = 1
4. 当 count >= consecutiveConfirmCycles → 允许入场，重置 count
5. 如果 count < consecutiveConfirmCycles → 返回 NO_SIGNAL（checkpoint: 'consecutive_confirm'）
```

**`strategy-scheduler.service.ts` 改动**: 无需改动。连续确认状态在策略实例内管理，调度器不感知。

---

#### Task 1.4：0DTE 止损收紧 + 禁用冷却期放宽

**文件**: `option-dynamic-exit.service.ts`

**改动内容**:

**A. 0DTE PnL 兜底收紧到 -25%**

当前逻辑中，止损在 3-10 分钟冷却期被放宽到 `stopLossPercent × 1.5`（35% → 52.5%），然后硬安全阀在 -40% 兜底。0DTE 场景下这导致仓位在 -35% 到 -52.5% 之间无保护。

改动：
```
if (position.is0DTE) {
  // 0DTE 场景：
  // 1. 禁用 3-10 分钟冷却期放宽（直接使用标准止损）
  // 2. PnL 兜底收紧到 -25%（使用 mid 价格计算）
  effectiveStopLoss = Math.min(stopLossPercent, zdtePnlFloorPercent)  // min(35, 25) = 25
  cooldownMultiplier = 1.0  // 不放宽
} else {
  // 非 0DTE：保持现有逻辑
  effectiveStopLoss = stopLossPercent
  cooldownMultiplier = 1.5  // 冷却期放宽
}
```

**配置新增**:
```typescript
// 可在 ExitRulesConfig 或独立配置中新增
zdtePnlFloorPercent?: number;  // 0DTE PnL 兜底止损百分比（默认 25）
```

**B. 0DTE 使用 mid 价格计算 PnL**

当前系统使用 `lastDone`（最新成交价）计算 PnL。对 0DTE 期权，成交价可能跳动剧烈，`mid = (bid + ask) / 2` 更稳定。

改动：在 `calculatePnL()` 中，当 `is0DTE === true` 时，优先使用传入的 `midPrice`。

```typescript
interface PositionContext {
  // ... 现有字段
  midPrice?: number;  // (bid + ask) / 2，0DTE 优先使用
}
```

PnL 计算逻辑：
```
const priceForPnL = (context.is0DTE && context.midPrice) ? context.midPrice : context.currentPrice;
```

**`strategy-scheduler.service.ts` 改动**: 在持仓监控循环中，获取报价时同时取 `bid` / `ask`，计算 `mid = (bid + ask) / 2` 并传入 `PositionContext.midPrice`。

---

#### Task 1.5：硬安全阀保持 -40%

硬安全阀（-40%）**不改动**，作为最后防线。Phase 1 中 0DTE 的止损层级变为：

```
0DTE 退出层级（Phase 1）:
  Level 1: PnL 兜底  -25%（mid 价格）→ 新增
  Level 2: 标准止损  -35%（不再被冷却期放宽）→ 修改
  Level 3: 硬安全阀  -40% → 不变
```

对比当前（修改前）：
```
当前 0DTE 退出层级:
  Level 1: 标准止损 -35%（但 3-10 分钟被放宽到 -52.5%）
  Level 2: 硬安全阀 -40%
  → 导致 3-10 分钟内只有 -40% 兜底
```

---

### 3.2 Phase 2：VWAP 结构确认 + 时间止损 + 追踪止盈动态化

> Phase 2 依赖 Phase 1 完成后的线上验证数据。以下为设计规范，不阻塞 Phase 1 开发。

#### Task 2.1：VWAP 计算服务

**文件**: `market-data.service.ts`（新增方法）

**数据源**: 从 Moomoo `getCandlesticksIntraday()` 获取 1m K 线（type=1），自行计算 VWAP。

**VWAP 计算公式**:
```
VWAP = Σ(Typical_Price_i × Volume_i) / Σ(Volume_i)
Typical_Price = (High + Low + Close) / 3
```

**新增方法**:
```typescript
/**
 * 计算标的当日 VWAP
 * @param symbol 标的代码（如 "SPY.US"）
 * @returns { vwap: number, dataPoints: number } 或 null
 */
async calculateIntradayVWAP(symbol: string): Promise<{ vwap: number; dataPoints: number } | null>
```

**缓存策略**:
- 缓存 TTL: 60 秒（1 分钟，与 K 线周期一致）
- 缓存 key: `vwap:${symbol}:${dateStr}`
- 失败降级: 返回 null，上游逻辑跳过结构确认

**API 限流处理**:
- 复用现有 `getCandlesticksIntraday()` 的 800ms 串行限流机制
- 使用现有的断路器模式（5 次连续失败 → 60 秒冷却）

**风险**: Moomoo API 返回的 1m K 线可能不含盘前/盘后数据，只包含 09:30 开始的正式交易时段。需验证数据完整性。

---

#### Task 2.2：结构确认入场

**文件**: `option-intraday-strategy.ts`

**依赖**: Task 2.1（VWAP 数据）

**逻辑**: 在入场流程中，连续确认通过后，增加结构确认检查。

```typescript
/**
 * 检查标的是否满足结构确认条件
 * @param symbol 标的代码
 * @param direction 'BEARISH' | 'BULLISH'
 * @returns boolean
 */
async checkStructureConfirm(symbol: string, direction: string): Promise<boolean>
```

**PUT 入场结构确认**:
1. 获取标的当日 VWAP（Task 2.1）
2. 获取最近 3 根 1m K 线
3. 检查最近 2 根收盘价是否都在 VWAP 下方
4. 检查最近 3 根是否存在"强反转"形态（定义见下）
5. 条件 3 满足 && 条件 4 不存在 → 确认通过

**CALL 入场结构确认**: 对称逻辑（VWAP 上方 + 无强下砸）。

**"强反转"形态定义**:
```
对于 PUT 方向，以下任一情况视为强反转，阻止入场：
1. 单根 1m 阳线实体占比 > 70%（(close - open) / (high - low) > 0.7）
   且 close > VWAP（从低点拉回 VWAP 上方）
2. 单根 1m 涨幅 > 当日前 30 分钟平均 1m 涨幅的 2 倍
```

**降级策略**: 如果 VWAP 或 1m K 线获取失败 → 跳过结构确认，依赖连续确认结果。

---

#### Task 2.3：结构失效止损（Level A）

**文件**: `option-dynamic-exit.service.ts`

**依赖**: Task 2.1（VWAP 数据）

**逻辑**: 在退出检查的最高优先级位置新增结构失效检查。

```typescript
/**
 * 检查持仓是否因结构失效需要退出
 * @param position 持仓上下文
 * @param direction 'PUT' | 'CALL'
 * @param vwapData VWAP 数据
 * @param recentKlines 最近 K 线数据
 * @returns { shouldExit: boolean, reason: string }
 */
checkStructureInvalidation(
  position: PositionContext,
  direction: string,
  vwapData: { vwap: number } | null,
  recentKlines: CandlestickData[]
): { shouldExit: boolean; reason: string }
```

**PUT 持仓结构失效条件**:
- 标的连续 2 根 1m 收盘价站回 VWAP 上方 → 做空结构失效 → 平仓

**CALL 持仓结构失效条件**:
- 标的连续 2 根 1m 收盘价跌回 VWAP 下方 → 做多结构失效 → 平仓

**退出检查优先级变更**:
```
当前顺序:
  1. 0DTE 时间强平
  2. 收盘时间强平
  3. 止盈
  4. 追踪止盈
  5. 止损（含冷却期放宽）
  6. 硬安全阀

Phase 2 顺序:
  1. 硬安全阀 -40%（最高优先级不变，保证资金安全）
  2. 0DTE 时间强平
  3. 收盘时间强平
  4. 结构失效止损（新增 Level A）     ← 新增
  5. 时间止损（新增 Level B）          ← 新增
  6. PnL 兜底 -25%（0DTE）/ -35%（非 0DTE）
  7. 追踪止盈
  8. 止盈
```

**降级策略**: VWAP 不可用时跳过结构失效检查，依赖 PnL 止损兜底。

---

#### Task 2.4：时间止损（Level B）

**文件**: `option-dynamic-exit.service.ts`

**依赖**: Task 2.1（波动率分桶数据）

**逻辑**: 入场后 T 分钟内未出现"最小顺风延续"则退出。

**波动率分桶计算**:
```typescript
/**
 * 计算标的开盘 30 分钟波动率，确定时间止损 T
 * @param symbol 标的代码
 * @returns T 分钟数（3/5/8）
 */
async getTimeStopMinutes(symbol: string): Promise<number>
```

| 条件 | T |
|---|---|
| rangePct >= 0.65% | 3 分钟 |
| 0.45% <= rangePct < 0.65% | 5 分钟 |
| rangePct < 0.45% | 8 分钟 |

`rangePct = (High_0930_1000 - Low_0930_1000) / Open_0930 * 100%`

**"最小顺风延续"判定**:
- 方式 A：标的在 T 分钟内创出新低（PUT）/ 新高（CALL）
- 方式 B：期权 mid 价格回到 >= +5% 盈利

满足其一即视为"顺风延续"，不触发时间止损。

**状态管理**: 需在持仓元数据中记录入场时标的价格，用于判断是否创新低/新高。

```typescript
// PositionContext 新增
interface PositionContext {
  // ... 现有字段
  entryUnderlyingPrice?: number;  // 入场时标的现货价格
  timeStopMinutes?: number;       // 该仓位的时间止损 T
}
```

---

#### Task 2.5：追踪止盈动态化

**文件**: `option-dynamic-exit.service.ts`

**改动内容**: 将当前固定的追踪止盈参数改为按波动率分桶动态调整。

**当前实现**:
```
EARLY: trailingStopTrigger=30%, trailingStopPercent=15%
```

**改为**:
```
触发条件: mid 盈利 >= +15%（降低触发门槛，更早保护利润）

追踪回撤参数（按波动率分桶）:
  高波动: 15%（宽松，避免噪声扫掉）
  中波动: 12%
  低波动: 10%（紧凑，锁住利润）

阶梯收紧:
  浮盈 >= +30%: trail 下调 2pp
  浮盈 >= +50%: trail 再下调 2pp
```

**配置新增**:
```typescript
interface TrailingStopConfig {
  activationPercent: number;         // 追踪止盈触发（默认 15）
  trailByVolatility: {
    high: number;                    // 高波动回撤%（默认 15）
    mid: number;                     // 中波动回撤%（默认 12）
    low: number;                     // 低波动回撤%（默认 10）
  };
  tightenSteps?: Array<{
    profitPercent: number;           // 浮盈达到此百分比
    trailReduction: number;          // trail 下调 pp 数
  }>;
}
```

---

## 4. 配置变更汇总

### 4.1 新增配置字段

```typescript
// OptionIntradayStrategyConfig 新增
{
  tradeWindow: {
    zdteCooldownMinutes: 30,          // 0DTE 开盘禁入（默认 30 分钟）
  },
  zdteEntryThreshold: 12,             // 0DTE 入场阈值（默认 12）
  consecutiveConfirmCycles: 2,         // 连续确认次数（默认 2）
}

// ExitRulesConfig 新增
{
  zdtePnlFloorPercent: 25,            // 0DTE PnL 兜底止损（默认 25%）
  zdteDisableCooldownWidening: true,   // 0DTE 禁用冷却期止损放宽（默认 true）
}

// SelectOptionContractParams 新增
{
  skip0DTE: false,                     // 跳过 0DTE 合约（默认 false）
}
```

### 4.2 默认值设计原则

- 所有新增参数都有默认值，**不改变现有行为**直到显式启用
- 通过数据库 `strategy_config` JSON 字段配置，支持热更新
- 与现有深度合并逻辑兼容（`c13b441` 已修复浅合并问题）

---

## 5. 数据库变更

**无 schema 变更**。所有新配置通过现有 `strategy_config` JSON 字段存储。

如需持久化连续确认状态（可选），可后续在 `signal_logs` 表中新增字段，但 V1 使用内存状态即可。

---

## 6. 测试方案

### 6.1 单元测试

| 测试项 | 文件 | 关键场景 |
|---|---|---|
| 0DTE 禁入窗口 | `option-intraday-strategy.test.ts` | 09:45 ET 0DTE 被拒，1DTE 放行；10:05 ET 0DTE 放行 |
| 入场阈值 | 同上 | score=-11 非 0DTE 触发、0DTE 不触发；score=-12 0DTE 触发 |
| 连续确认 | 同上 | 单次达标不触发；连续 2 次触发；中间方向翻转重置 |
| 0DTE 止损收紧 | `option-dynamic-exit.test.ts` | 0DTE 在 -25% 触发；非 0DTE 在 -35% 触发 |
| 冷却期放宽禁用 | 同上 | 0DTE 持仓 5 分钟，止损不放宽到 52.5% |
| mid 价格使用 | 同上 | 0DTE 使用 mid 计算 PnL；非 0DTE 使用 lastDone |
| 合约选择跳过 0DTE | `options-contract-selector.test.ts` | skip0DTE=true 时选 1DTE |

### 6.2 反事实验证（手动）

使用 02-12 和 02-13 数据进行回测验证：

**02-13 验证目标**:
- 09:40 的信号因 0DTE 禁入窗口被阻止 → 避免 -$485 亏损
- 或者如果 10:00 后信号仍存在但得分不足 -12 → 不开仓

**02-12 验证目标**:
- 盈利交易（得分 -12.8）仍能在阈值 -12 下触发
- 确认不会因新规则完全错过盈利机会

### 6.3 线上灰度

1. 先在策略10（$2,000 期权资金）上启用 Phase 1
2. 观察 3-5 个交易日的信号日志
3. 关注指标：
   - `zdte_cooldown` 拦截次数
   - `consecutive_confirm` 拦截次数
   - 0DTE 止损触发位置（应在 -25% 附近而非 -40%）
   - 每日交易次数（预期下降）
   - 硬安全阀触发次数（预期显著下降）

---

## 7. 实现优先级与依赖关系

```
Phase 1（核心，无外部依赖）:
  ┌─ Task 1.1: 0DTE 禁入窗口
  │   └─ 改动: option-intraday-strategy.ts + options-contract-selector.service.ts
  │
  ├─ Task 1.2: 入场阈值提升
  │   └─ 改动: option-intraday-strategy.ts
  │
  ├─ Task 1.3: 连续确认
  │   └─ 改动: option-intraday-strategy.ts
  │
  └─ Task 1.4: 0DTE 止损收紧
      └─ 改动: option-dynamic-exit.service.ts + strategy-scheduler.service.ts

Phase 2（结构增强，依赖 Phase 1 + VWAP 数据）:
  ┌─ Task 2.1: VWAP 计算服务 ← Phase 2 前置
  │   └─ 改动: market-data.service.ts
  │
  ├─ Task 2.2: 结构确认入场（依赖 2.1）
  │   └─ 改动: option-intraday-strategy.ts
  │
  ├─ Task 2.3: 结构失效止损（依赖 2.1）
  │   └─ 改动: option-dynamic-exit.service.ts
  │
  ├─ Task 2.4: 时间止损（依赖 2.1 的波动率数据）
  │   └─ 改动: option-dynamic-exit.service.ts
  │
  └─ Task 2.5: 追踪止盈动态化（依赖 2.1 的波动率数据）
      └─ 改动: option-dynamic-exit.service.ts
```

---

## 8. 风控检查清单

- [ ] 所有新参数有安全默认值，不会因配置缺失导致异常行为
- [ ] 0DTE 禁入不影响非 0DTE 合约的正常交易
- [ ] 连续确认状态在策略重启后自动重置（内存级别，不持久化）
- [ ] mid 价格为 0 或 NaN 时降级到 lastDone
- [ ] VWAP 计算失败时跳过结构确认，不阻塞交易流程
- [ ] 止损收紧不会与硬安全阀冲突（-25% < -40%，顺序正确）
- [ ] 新增日志检查点可追踪每个拦截原因

---

*文档结束*
