# 回测-实盘信号对齐：真实温度 + 日K分时修正

## 问题

回测 10:17 ET 入场（finalScore=-8.1），实盘 10:30 ET 才入场（晚 13 分钟），根因：

1. **市场温度不同**：实盘用 Longport API 真实温度（68 → +9.0 贡献），回测用 `estimateMarketTemperature()` 估算
2. **日K当天 close 滞后**：`calculateMarketScore()` 用 `marketData.spx`（日K）做趋势计算，当天那根 bar 的 close 依赖 API 缓存刷新，导致 SPX 趋势在 -0.9 和 -22.1 之间跳动

## 涉及文件

| 文件 | 变更 |
|---|---|
| `api/migrations/014_add_market_temperature_history.sql` | 新建温度历史表 |
| `api/src/services/market-data.service.ts` | `getMarketTemperature()` 写入 DB |
| `api/src/services/option-backtest.service.ts` | 读取真实温度替代估算 |
| `api/src/services/option-recommendation.service.ts` | 日K close 分时修正 |

---

## 修改 1：新建温度历史表

**文件**: `api/migrations/014_add_market_temperature_history.sql`

```sql
CREATE TABLE IF NOT EXISTS market_temperature_history (
    id BIGSERIAL PRIMARY KEY,
    timestamp BIGINT NOT NULL,          -- 毫秒时间戳
    value DECIMAL(5, 2) NOT NULL,       -- 温度值 0-100
    source VARCHAR(20) NOT NULL DEFAULT 'longport',  -- 数据来源
    collected_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE UNIQUE INDEX IF NOT EXISTS idx_temp_hist_ts
  ON market_temperature_history (timestamp);
CREATE INDEX IF NOT EXISTS idx_temp_hist_ts_brin
  ON market_temperature_history USING BRIN (timestamp);
```

轻量表，每次缓存刷新写一行（约每 5 分钟一条 = 每天 ~80 行）。

---

## 修改 2：实盘保存真实温度到 DB

**文件**: `api/src/services/market-data.service.ts`

在 `getMarketTemperature()` 缓存写入之后，异步写 DB（不阻塞返回）。
新增 `saveTemperatureToDb()` 私有方法，5 分钟窗口去重 + `ON CONFLICT DO NOTHING`。

---

## 修改 3：回测读取真实温度

**文件**: `api/src/services/option-backtest.service.ts`

- 新增 `loadRealTemperature(date, timeMinutes)` 方法，查询 DB ±5 分钟窗口内最近一条
- `buildMarketDataWindow()` 改为 async，优先用真实温度，无数据回退到 `estimateMarketTemperature()`

---

## 修改 4：日K close 分时修正（SPX + USD + BTC）

**文件**: `api/src/services/option-recommendation.service.ts`

- 新增 `correctDailyCloseWithIntraday()` 方法
- 在 `calculateMarketScore()` 入口处修正 SPX/USD/BTC 日K 当天最后一根 bar 的 close

---

## 边界情况

- **温度 DB 无数据**：回退到 `estimateMarketTemperature()`
- **分时数据为空**：`correctDailyCloseWithIntraday` 直接 return
- **timestamp 比较**：分时 bar timestamp >= 日K bar timestamp 才修正
- **高频写 DB**：5 分钟去重 + `ON CONFLICT DO NOTHING`
- **mutation 安全性**：cache 每 15 秒刷新覆盖，下次评估用新鲜数据

## 验证

1. `pnpm run build` 通过
2. DB 中 `market_temperature_history` 表有数据写入
3. 实盘日志 `[大盘评分明细]` SPX趋势不再跳动
4. 次日回测对比：回测 marketScore 与实盘日志中大盘评分接近
