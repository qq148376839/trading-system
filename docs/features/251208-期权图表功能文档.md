# 期权图表功能文档

**创建日期**: 2025-12-08  
**最后更新**: 2025-12-08  
**状态**: ✅ 已完成

---

## 📚 文档索引

### 相关文档列表

#### 1. 期权图表功能实施总结 ⭐

**内容**: 功能实施的完整总结，包括：
- 功能概述和目标
- 技术实现细节（后端和前端）
- API接口说明
- 测试验证结果
- 修改文件清单

**适用对象**: 开发者、产品经理

---

#### 2. 期权图表API分析文档

**内容**: API分析和设计文档，包括：
- API接口分析
- 数据格式说明
- 实现方案设计
- 注意事项和优先级

**适用对象**: 开发者、架构师

**状态**: ✅ 已完成（已标记为完成状态）

---

## 🔗 相关文档

- [Moomoo边缘函数集成文档](../integration/MOOMOO_EDGE_FUNCTION_INTEGRATION.md) - 边缘函数集成说明
- [期权行情API文档](../technical/OPTION_QUOTE_API.md) - 期权行情API开发文档

---

## 📝 快速导航

**想了解功能实现？** → 查看下方「功能实施总结」章节

**想了解API设计？** → [期权图表API分析文档](OPTION_CHART_API_ANALYSIS.md)

**想了解边缘函数集成？** → [Moomoo边缘函数集成文档](../integration/MOOMOO_EDGE_FUNCTION_INTEGRATION.md)

---

# 期权图表功能实施总结

## 📋 功能概述

实现了期权详情页面的图表功能，支持三种图表类型：
- **分时图**：实时价格走势
- **5日图**：最近5天的收盘价走势
- **日K图**：历史收盘价走势

所有图表统一使用折线图（LineChart）显示，提供一致的用户体验。

---

## 🎯 实现目标

1. ✅ 实现分时图数据获取和显示
2. ✅ 实现日K线数据获取和显示
3. ✅ 实现5日图（从日K数据筛选）
4. ✅ 统一使用折线图显示
5. ✅ 通过边缘函数代理调用Moomoo API

---

## 🛠️ 技术实现

### 后端实现

#### 1. 服务层 (`api/src/services/futunn-option-chain.service.ts`)

**新增函数**：

```typescript
/**
 * 获取期权K线数据（日K）
 * @param optionId 期权ID
 * @param marketType 市场类型（默认2=美股）
 * @param count 数据条数（默认100）
 */
export async function getOptionKline(
  optionId: string,
  marketType: number = 2,
  count: number = 100
): Promise<Array<{
  timestamp: number;      // 时间戳（秒）
  open: number;           // 开盘价
  close: number;          // 收盘价
  high: number;           // 最高价
  low: number;            // 最低价
  volume: number;         // 成交量
  turnover: number;       // 成交额
  prevClose: number;      // 昨收
  change: number;         // 涨跌额
  openInterest?: number;  // 持仓量（可选）
}>>

/**
 * 获取期权分时数据
 * @param optionId 期权ID
 * @param marketType 市场类型（默认2=美股）
 */
export async function getOptionMinute(
  optionId: string,
  marketType: number = 2
): Promise<Array<{
  timestamp: number;      // 时间戳（秒）
  price: number;          // 价格
  volume: number;         // 成交量
  turnover: number;       // 成交额
  changeRatio: number;    // 涨跌幅（%）
  changePrice: number;    // 涨跌额
}>>
```

**技术要点**：
- 使用 `moomooProxy` 通过边缘函数代理调用Moomoo API
- 自动处理 cookies、CSRF token 和 quote-token
- 数据格式转换（时间戳、价格单位等）
- 完善的错误处理和日志记录

#### 2. 路由层 (`api/src/routes/options.ts`)

**新增端点**：

```typescript
/**
 * GET /api/options/kline
 * 获取期权K线数据（日K）
 * 
 * 请求参数：
 * - optionId: string (必需) - 期权ID
 * - marketType: number (可选) - 市场类型，默认2（美股）
 * - count: number (可选) - 数据条数，默认100
 */
optionsRouter.get('/kline', rateLimiter, async (req, res, next) => {
  // 实现逻辑
})

/**
 * GET /api/options/minute
 * 获取期权分时数据
 * 
 * 请求参数：
 * - optionId: string (必需) - 期权ID
 * - marketType: number (可选) - 市场类型，默认2（美股）
 */
optionsRouter.get('/minute', rateLimiter, async (req, res, next) => {
  // 实现逻辑
})
```

**技术要点**：
- 参数验证和错误处理
- 使用 rateLimiter 限流保护
- 统一的响应格式

### 前端实现

#### 1. API 客户端 (`frontend/lib/api.ts`)

**新增方法**：

```typescript
export const optionsApi = {
  // ... 其他方法
  
  /**
   * 获取期权K线数据（日K）
   */
  getOptionKline: (params: {
    optionId: string
    marketType?: number
    count?: number
  }) => {
    return api.get('/options/kline', { params })
  },

  /**
   * 获取期权分时数据
   */
  getOptionMinute: (params: {
    optionId: string
    marketType?: number
  }) => {
    return api.get('/options/minute', { params })
  },
}
```

#### 2. 图表组件 (`frontend/app/options/[optionCode]/page.tsx`)

**实现要点**：
- 使用 `Recharts` 库绘制图表
- 根据 `chartType` 状态切换显示不同的图表
- 分时图：显示 `time`（时间）和 `price`（价格）
- K线图（5日和日K）：显示 `date`（日期）和 `close`（收盘价）
- 统一使用 `LineChart` 显示，提供一致的用户体验
- 加载状态使用 `Spin` 组件
- 数据格式化（时间戳转换、价格格式化）

**关键代码**：

```typescript
// 数据获取
useEffect(() => {
  if (optionId) {
    fetchChartData()
  }
}, [optionId, chartType])

// 图表数据准备
const chartData = useMemo(() => {
  if (chartType === 'minute') {
    return minuteData.map(item => ({
      time: new Date(item.timestamp * 1000).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
      price: item.price,
    }))
  } else {
    const data = chartType === '5day' 
      ? klineData.slice(-5) 
      : klineData
    
    return data.map(item => ({
      date: new Date(item.timestamp * 1000).toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }),
      close: item.close,
    }))
  }
}, [chartType, minuteData, klineData])
```

---

## 📊 API 接口说明

### 1. 日K线 API

**接口**: `GET /api/options/kline`

**请求参数**:
- `optionId` (string, 必需): 期权ID
- `marketType` (number, 可选): 市场类型，默认2（美股）
- `count` (number, 可选): 数据条数，默认100

**响应示例**:
```json
{
  "success": true,
  "data": {
    "klineData": [
      {
        "timestamp": 1761796800,
        "open": 49.13,
        "close": 46.6,
        "high": 49.4,
        "low": 44.42,
        "volume": 12,
        "turnover": 56523,
        "prevClose": 49.13,
        "change": -2.53,
        "openInterest": 9
      }
    ]
  }
}
```

### 2. 分时图 API

**接口**: `GET /api/options/minute`

**请求参数**:
- `optionId` (string, 必需): 期权ID
- `marketType` (number, 可选): 市场类型，默认2（美股）

**响应示例**:
```json
{
  "success": true,
  "data": {
    "minuteData": [
      {
        "timestamp": 1765204260,
        "price": 28.85,
        "volume": 3,
        "turnover": 8770,
        "changeRatio": -21.28,
        "changePrice": -7.8
      }
    ]
  }
}
```

---

## 🔧 技术细节

### 边缘函数代理

所有API调用通过 `moomooProxy` 工具使用Cloudflare边缘函数代理，解决了大陆IP无法直接访问Moomoo API的问题。

**代理配置**:
- 边缘函数URL: `https://cfapi.riowang.win`
- 自动计算 quote-token
- 自动处理 cookies 和 CSRF token
- 支持超时和错误重试

### 数据格式转换

1. **时间戳转换**: 
   - API返回秒级时间戳，前端转换为Date对象
   - 分时图：显示为 `HH:mm` 格式
   - K线图：显示为 `MM/dd` 格式

2. **价格单位**:
   - 分时数据优先使用 `cc_price`（元）
   - 如果只有 `price`（分），需要除以1000

3. **数据筛选**:
   - 5日图从日K数据中筛选最近5条记录

---

## ✅ 测试验证

### 功能测试

1. ✅ 分时图数据获取和显示正常
2. ✅ 日K图数据获取和显示正常
3. ✅ 5日图数据筛选和显示正常
4. ✅ 图表切换功能正常
5. ✅ 加载状态显示正常
6. ✅ 错误处理正常

### 边界情况测试

1. ✅ 无数据时显示友好提示
2. ✅ API调用失败时显示错误信息
3. ✅ 数据加载时显示加载状态
4. ✅ 图表数据为空时正常处理

---

## 📝 修改文件清单

### 后端文件

1. `api/src/services/futunn-option-chain.service.ts`
   - 新增 `getOptionKline()` 函数
   - 新增 `getOptionMinute()` 函数

2. `api/src/routes/options.ts`
   - 新增 `GET /api/options/kline` 路由
   - 新增 `GET /api/options/minute` 路由

### 前端文件

1. `frontend/lib/api.ts`
   - 新增 `optionsApi.getOptionKline()` 方法
   - 新增 `optionsApi.getOptionMinute()` 方法

2. `frontend/app/options/[optionCode]/page.tsx`
   - 新增图表数据状态管理
   - 新增数据获取逻辑
   - 实现图表组件（使用Recharts）
   - 实现图表切换功能

---

## 🎨 UI/UX 改进

1. **统一图表样式**: 所有图表统一使用折线图，提供一致的用户体验
2. **加载状态**: 数据加载时显示友好的加载提示
3. **错误提示**: API调用失败时显示清晰的错误信息
4. **数据格式化**: 时间、价格等数据格式化显示，提升可读性

---

## 🚀 后续优化建议

1. **数据缓存**: 可以考虑在前端缓存数据，避免频繁请求
2. **图表交互**: 可以添加缩放、拖拽等交互功能
3. **数据刷新**: 可以添加自动刷新功能，实时更新图表数据
4. **图表样式**: 可以根据涨跌情况使用不同颜色显示

---

**最后更新**: 2025-12-08  
**实施人员**: 开发团队  
**状态**: ✅ 已完成并测试通过

