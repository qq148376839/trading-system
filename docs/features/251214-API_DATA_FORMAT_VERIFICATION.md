# APIæ•°æ®æ ¼å¼æ ¸å¯¹æ¸…å•

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **åˆ›å»ºæ—¶é—´**ï¼š2025-12-14
- **ç›®çš„**ï¼šæ ¸å¯¹å„APIæ¥å£è¿”å›æ•°æ®çš„å®é™…æ ¼å¼ï¼Œç¡®ä¿PRDæ–‡æ¡£å‡†ç¡®æ€§
- **çŠ¶æ€**ï¼šå¾…ç¡®è®¤

---

## 1. Longbridge APIæ•°æ®æ ¼å¼

### 1.1 `candlesticks()` æ–¹æ³•ï¼ˆå½“å‰ä½¿ç”¨ï¼‰

**ä»£ç ä½ç½®**ï¼š`api/src/services/backtest.service.ts` ç¬¬83-88è¡Œï¼Œ`api/src/routes/candlesticks.ts` ç¬¬101-107è¡Œ

**âœ… å®é™…è¿”å›æ ¼å¼**ï¼ˆå·²ç¡®è®¤ï¼‰ï¼š
```json
{
  "symbol": "700.HK",
  "candlesticks": [
    {
      "close": "362.000",      // å­—ç¬¦ä¸²ç±»å‹
      "open": "364.600",       // å­—ç¬¦ä¸²ç±»å‹
      "low": "361.600",        // å­—ç¬¦ä¸²ç±»å‹
      "high": "368.800",       // å­—ç¬¦ä¸²ç±»å‹
      "volume": 10853604,      // æ•°å­—ç±»å‹
      "turnover": "3954556819.000",  // å­—ç¬¦ä¸²ç±»å‹
      "timestamp": 1650384000  // æ•°å­—ç±»å‹ï¼Œç§’çº§æ—¶é—´æˆ³
    }
  ]
}
```

**âœ… å·²ç¡®è®¤**ï¼š
- âœ… `open/high/low/close` æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼ˆå¦‚ "362.000"ï¼‰
- âœ… `timestamp` æ˜¯ç§’çº§æ—¶é—´æˆ³ï¼ˆnumberç±»å‹ï¼Œå¦‚ 1650384000ï¼‰
- âœ… `turnover` å­˜åœ¨ï¼Œæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼ˆå¦‚ "3954556819.000"ï¼‰
- âœ… `volume` æ˜¯æ•°å­—ç±»å‹ï¼ˆå¦‚ 10853604ï¼‰
- â“ `tradeSession` å­—æ®µæœªåœ¨ç¤ºä¾‹ä¸­å‡ºç°ï¼Œå¯èƒ½ä¸å­˜åœ¨æˆ–å¯é€‰

---

### 1.2 `historyCandlesticksByOffset()` æ–¹æ³•ï¼ˆè®¡åˆ’ä½¿ç”¨ï¼‰

**ä»£ç ä½ç½®**ï¼šæš‚æ— å®é™…ä½¿ç”¨ä»£ç 

**âœ… å®é™…è¿”å›æ ¼å¼**ï¼ˆå·²ç¡®è®¤ï¼Œä¸`candlesticks()`ç›¸åŒï¼‰ï¼š
```json
{
  "symbol": "700.HK",
  "candlesticks": [
    {
      "close": "362.000",
      "open": "364.600",
      "low": "361.600",
      "high": "368.800",
      "volume": 10853604,
      "turnover": "3954556819.000",
      "timestamp": 1650384000
    }
  ]
}
```

**âœ… å·²ç¡®è®¤**ï¼š
- âœ… `historyCandlesticksByOffset()` è¿”å›çš„æ•°æ®æ ¼å¼ä¸ `candlesticks()` ç›¸åŒ
- âœ… `timestamp` æ˜¯ç§’çº§æ—¶é—´æˆ³ï¼ˆnumberç±»å‹ï¼‰
- âœ… `open/high/low/close` æ˜¯å­—ç¬¦ä¸²ç±»å‹
- âœ… `volume` æ˜¯numberç±»å‹ï¼ˆä¸æ˜¯int64ï¼‰
- âœ… `turnover` å­˜åœ¨ï¼Œæ˜¯å­—ç¬¦ä¸²ç±»å‹
- âœ… è¿”å›ç»“æ„åŒ…å« `symbol` å’Œ `candlesticks` æ•°ç»„

---

### 1.3 `historyCandlesticksByDate()` æ–¹æ³•ï¼ˆè®¡åˆ’ä½¿ç”¨ï¼‰

**ä»£ç ä½ç½®**ï¼šæš‚æ— å®é™…ä½¿ç”¨ä»£ç 

**âœ… å®é™…è¿”å›æ ¼å¼**ï¼ˆå·²ç¡®è®¤ï¼Œä¸`candlesticks()`å’Œ`historyCandlesticksByOffset()`ç›¸åŒï¼‰ï¼š
```json
{
  "symbol": "700.HK",
  "candlesticks": [
    {
      "close": "362.000",
      "open": "364.600",
      "low": "361.600",
      "high": "368.800",
      "volume": 10853604,
      "turnover": "3954556819.000",
      "timestamp": 1650384000
    }
  ]
}
```

**âœ… å·²ç¡®è®¤**ï¼š
- âœ… `historyCandlesticksByDate()` è¿”å›çš„æ•°æ®æ ¼å¼ä¸ `candlesticks()` å’Œ `historyCandlesticksByOffset()` ç›¸åŒ
- âœ… æ‰€æœ‰å­—æ®µçš„ç±»å‹å’Œæ ¼å¼å®Œå…¨ä¸€è‡´

---

## 2. Moomoo APIæ•°æ®æ ¼å¼

### 2.1 æ—¥Kæ•°æ®ï¼ˆ`get-kline`ï¼Œ`type=2`ï¼‰

**ä»£ç ä½ç½®**ï¼š`api/src/services/market-data.service.ts` ç¬¬249-350è¡Œ

**âœ… å®é™…è¿”å›æ ¼å¼**ï¼ˆå·²ç¡®è®¤ï¼‰ï¼š
```json
{
  "code": 0,
  "message": "æˆåŠŸ",
  "data": {
    "list": [
      {
        "k": 1275364800,        // æ—¶é—´æˆ³ï¼ˆç§’çº§ï¼Œæ•°å­—ç±»å‹ï¼‰
        "o": "1.266654",         // å¼€ç›˜ä»·ï¼ˆå­—ç¬¦ä¸²ï¼‰
        "c": "1.58865078",       // æ”¶ç›˜ä»·ï¼ˆå­—ç¬¦ä¸²ï¼‰
        "h": "2.027926387",      // æœ€é«˜ä»·ï¼ˆå­—ç¬¦ä¸²ï¼‰
        "l": "1.16932164",       // æœ€ä½ä»·ï¼ˆå­—ç¬¦ä¸²ï¼‰
        "v": 539665050,          // æˆäº¤é‡ï¼ˆæ•°å­—ç±»å‹ï¼‰
        "t": 0,                  // å…¶ä»–å­—æ®µï¼ˆæ•°å­—ï¼‰
        "r": 0.20715,            // å…¶ä»–å­—æ®µï¼ˆæ•°å­—ï¼‰
        "lc": "1.133322",        // å…¶ä»–å­—æ®µï¼ˆå­—ç¬¦ä¸²ï¼‰
        "cp": "0.45532878"       // å…¶ä»–å­—æ®µï¼ˆå­—ç¬¦ä¸²ï¼‰
      }
    ]
  }
}
```

**âœ… å·²ç¡®è®¤**ï¼š
- âœ… æ—¥Kæ•°æ®ï¼ˆ`type=2`ï¼‰ä½¿ç”¨ `c/o/h/l/v/k` æ ¼å¼
- âœ… æ—¶é—´æˆ³`k`æ˜¯ç§’çº§æ—¶é—´æˆ³ï¼ˆnumberç±»å‹ï¼‰
- âœ… ä»·æ ¼å­—æ®µï¼ˆ`c/o/h/l`ï¼‰æ˜¯å­—ç¬¦ä¸²ç±»å‹
- âœ… æˆäº¤é‡`v`æ˜¯æ•°å­—ç±»å‹
- âœ… æ•°æ®åµŒå¥—åœ¨ `data.list` æ•°ç»„ä¸­
- â“ æˆäº¤é¢ï¼ˆturnoverï¼‰å­—æ®µä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦è®¡ç®—æˆ–ä½¿ç”¨å…¶ä»–å­—æ®µï¼ˆå¦‚`r`, `cp`ç­‰ï¼‰
- â“ å…¶ä»–å­—æ®µï¼ˆ`t`, `r`, `lc`, `cp`ï¼‰çš„ç”¨é€”éœ€è¦ç¡®è®¤

---

### 2.2 åˆ†æ—¶æ•°æ®ï¼ˆ`get-quote-minute`ï¼Œ`type=1`ï¼‰

**ä»£ç ä½ç½®**ï¼š`api/src/services/market-data.service.ts` ç¬¬249-350è¡Œ

**å®é™…è¿”å›æ ¼å¼**ï¼ˆæ ¹æ®ä»£ç æ¨æ–­ï¼‰ï¼š
```typescript
{
  cc_price: string,   // æ”¶ç›˜ä»·
  cc_open: string,     // å¼€ç›˜ä»·
  cc_high: string,     // æœ€é«˜ä»·
  cc_low: string,      // æœ€ä½ä»·
  v: number,           // æˆäº¤é‡
  k: number,           // æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
  // æˆ–å…¶ä»–æ ¼å¼
}
```

**éœ€è¦ç¡®è®¤**ï¼š
- âœ… åˆ†æ—¶æ•°æ®æ˜¯å¦æ€»æ˜¯ä½¿ç”¨ `cc_*` æ ¼å¼ï¼Ÿ
- âœ… æ—¶é—´æˆ³æ ¼å¼æ˜¯å¦ä¸æ—¥Kæ•°æ®ç›¸åŒï¼Ÿ
- â“ åˆ†æ—¶æ•°æ®æ˜¯å¦æ”¯æŒå†å²æ—¥æœŸæŸ¥è¯¢ï¼Ÿï¼ˆå·²çŸ¥ä¸æ”¯æŒï¼Œä½†éœ€è¦ç¡®è®¤ï¼‰

---

## 3. æ•°æ®æ ¼å¼è½¬æ¢éœ€æ±‚

### 3.1 Longbridge -> å†…éƒ¨æ ¼å¼

**å½“å‰å¤„ç†**ï¼ˆ`backtest.service.ts` ç¬¬98-106è¡Œï¼‰ï¼š
```typescript
{
  timestamp: new Date(c.timestamp),  // è½¬æ¢ä¸ºDateå¯¹è±¡
  open: typeof c.open === 'number' ? c.open : parseFloat(String(c.open || 0)),
  high: typeof c.high === 'number' ? c.high : parseFloat(String(c.high || 0)),
  low: typeof c.low === 'number' ? c.low : parseFloat(String(c.low || 0)),
  close: typeof c.close === 'number' ? c.close : parseFloat(String(c.close || 0)),
  volume: typeof c.volume === 'number' ? c.volume : parseFloat(String(c.volume || 0)),
}
```

**éœ€è¦ç¡®è®¤**ï¼š
- â“ `historyCandlesticksByOffset()` è¿”å›çš„æ•°æ®æ˜¯å¦éœ€è¦ç›¸åŒçš„è½¬æ¢é€»è¾‘ï¼Ÿ
- â“ å¦‚æœè¿”å›çš„æ˜¯Decimalç±»å‹ï¼Œæ˜¯å¦éœ€è¦å…ˆè°ƒç”¨`toString()`å†`parseFloat()`ï¼Ÿ

---

### 3.2 Moomoo -> å†…éƒ¨æ ¼å¼

**å½“å‰å¤„ç†**ï¼ˆ`market-data.service.ts` ç¬¬249-350è¡Œï¼‰ï¼š
```typescript
{
  close: parseFloat(String(item.c || item.cc_price || item.price/100 || item.close)),
  open: parseFloat(String(item.o || item.cc_open || item.open)),
  high: parseFloat(String(item.h || item.cc_high || item.high)),
  low: parseFloat(String(item.l || item.cc_low || item.low)),
  volume: parseFloat(String(item.v || item.volume)),
  turnover: parseFloat(String(item.turnover || 0)),
  timestamp: (item.k || item.t || Date.now()/1000) * 1000,  // è½¬æ¢ä¸ºæ¯«ç§’æ—¶é—´æˆ³
}
```

**éœ€è¦ç¡®è®¤**ï¼š
- âœ… è½¬æ¢é€»è¾‘æ˜¯å¦æ­£ç¡®ï¼Ÿ
- â“ æ˜¯å¦è¿˜æœ‰å…¶ä»–æ ¼å¼å˜ä½“éœ€è¦å¤„ç†ï¼Ÿ

---

## 4. å†…éƒ¨æ ‡å‡†æ ¼å¼

**å½“å‰å®šä¹‰**ï¼ˆ`market-data.service.ts` ç¬¬11-19è¡Œï¼‰ï¼š
```typescript
interface CandlestickData {
  close: number;      // æ”¶ç›˜ä»·ï¼ˆæ•°å­—ï¼‰
  open: number;       // å¼€ç›˜ä»·ï¼ˆæ•°å­—ï¼‰
  low: number;        // æœ€ä½ä»·ï¼ˆæ•°å­—ï¼‰
  high: number;       // æœ€é«˜ä»·ï¼ˆæ•°å­—ï¼‰
  volume: number;     // æˆäº¤é‡ï¼ˆæ•°å­—ï¼‰
  turnover: number;   // æˆäº¤é¢ï¼ˆæ•°å­—ï¼‰
  timestamp: number;  // æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
}
```

**å›æµ‹æœåŠ¡ä½¿ç”¨çš„æ ¼å¼**ï¼ˆ`backtest.service.ts` ç¬¬64è¡Œï¼‰ï¼š
```typescript
{
  timestamp: Date,    // Dateå¯¹è±¡ï¼ˆä¸æ˜¯æ¯«ç§’æ—¶é—´æˆ³ï¼‰
  open: number,
  high: number,
  low: number,
  close: number,
  volume: number
}
```

**éœ€è¦ç¡®è®¤**ï¼š
- â“ å›æµ‹æœåŠ¡ä½¿ç”¨çš„æ ¼å¼ï¼ˆtimestampæ˜¯Dateå¯¹è±¡ï¼‰æ˜¯å¦åº”è¯¥ç»Ÿä¸€ä¸ºæ¯«ç§’æ—¶é—´æˆ³ï¼Ÿ
- â“ æ˜¯å¦éœ€è¦ç»Ÿä¸€æ‰€æœ‰æœåŠ¡çš„æ•°æ®æ ¼å¼ï¼Ÿ

---

## 5. å·²ç¡®è®¤å’Œå¾…ç¡®è®¤çš„ä¿¡æ¯

### 5.1 Longbridge API âœ… å·²ç¡®è®¤

1. **`historyCandlesticksByOffset()` è¿”å›æ ¼å¼**ï¼š
   - [x] âœ… `timestamp` æ˜¯ç§’çº§æ—¶é—´æˆ³ï¼ˆnumberç±»å‹ï¼‰
   - [x] âœ… `open/high/low/close` æ˜¯å­—ç¬¦ä¸²ç±»å‹
   - [x] âœ… `volume` æ˜¯numberç±»å‹
   - [x] âœ… `turnover` å­˜åœ¨ï¼Œæ˜¯å­—ç¬¦ä¸²ç±»å‹
   - [x] âœ… è¿”å›ç»“æ„åŒ…å« `symbol` å’Œ `candlesticks` æ•°ç»„

2. **`historyCandlesticksByDate()` è¿”å›æ ¼å¼**ï¼š
   - [x] âœ… ä¸ `historyCandlesticksByOffset()` ç›¸åŒ
   - [x] âœ… æ‰€æœ‰å­—æ®µçš„ç±»å‹å’Œæ ¼å¼å®Œå…¨ä¸€è‡´

3. **ä¸ `candlesticks()` çš„å·®å¼‚**ï¼š
   - [x] âœ… è¿”å›æ ¼å¼å®Œå…¨ä¸€è‡´
   - [x] âœ… æ²¡æœ‰å­—æ®µå·®å¼‚

### 5.2 Moomoo API âœ… å·²ç¡®è®¤

1. **æ—¥Kæ•°æ®æ ¼å¼**ï¼š
   - [x] âœ… ä½¿ç”¨ `c/o/h/l/v/k` æ ¼å¼
   - [x] âœ… æ•°æ®åµŒå¥—åœ¨ `data.list` æ•°ç»„ä¸­
   - [x] âœ… æ—¶é—´æˆ³`k`æ˜¯ç§’çº§æ—¶é—´æˆ³
   - [x] âœ… ä»·æ ¼å­—æ®µæ˜¯å­—ç¬¦ä¸²ç±»å‹
   - [x] âœ… æˆäº¤é¢å­—æ®µä¸å­˜åœ¨ï¼Œè®¾ä¸º0ï¼ˆä¸å½“å‰ä»£ç å®ç°ä¸€è‡´ï¼‰
   - [ ] â“ å…¶ä»–å­—æ®µï¼ˆ`t`, `r`, `lc`, `cp`ï¼‰çš„ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰

2. **åˆ†æ—¶æ•°æ®æ ¼å¼**ï¼š
   - [x] âœ… åªæ”¯æŒå½“å¤©æ•°æ®ï¼Œå›æµ‹ä¸­ä¸åšå¤„ç†
   - [x] âœ… ä¸æ”¯æŒå†å²æ—¥æœŸæŸ¥è¯¢ï¼ˆå·²çŸ¥ï¼‰

---

## 6. å»ºè®®çš„éªŒè¯æ–¹æ³•

1. **å®é™…è°ƒç”¨APIæµ‹è¯•**ï¼š
   - è°ƒç”¨ `historyCandlesticksByOffset()` è·å–å®é™…æ•°æ®
   - æ‰“å°è¿”å›æ•°æ®çš„å®Œæ•´ç»“æ„
   - ç¡®è®¤æ¯ä¸ªå­—æ®µçš„ç±»å‹å’Œæ ¼å¼

2. **å¯¹æ¯”ç°æœ‰ä»£ç **ï¼š
   - å¯¹æ¯” `candlesticks()` å’Œ `historyCandlesticksByOffset()` çš„è¿”å›æ ¼å¼
   - ç¡®è®¤æ˜¯å¦éœ€è¦ä¸åŒçš„å¤„ç†é€»è¾‘

3. **æ–‡æ¡£æ ¸å¯¹**ï¼š
   - æŸ¥çœ‹Longbridgeå®˜æ–¹æ–‡æ¡£
   - ç¡®è®¤APIè¿”å›æ ¼å¼çš„å‡†ç¡®æè¿°

---

## 7. å¾…è¡¥å……ä¿¡æ¯æ¸…å•

### âœ… å·²ç¡®è®¤ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

- [x] âœ… **Longbridge `historyCandlesticksByOffset()` è¿”å›çš„æ•°æ®æ ¼å¼**
- [x] âœ… **Longbridge `historyCandlesticksByDate()` è¿”å›çš„æ•°æ®æ ¼å¼**
- [x] âœ… **Longbridge APIè¿”å›çš„ `timestamp` ç±»å‹å’Œå•ä½**ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼Œnumberç±»å‹ï¼‰
- [x] âœ… **Longbridge APIè¿”å›çš„ `open/high/low/close` ç±»å‹**ï¼ˆå­—ç¬¦ä¸²ç±»å‹ï¼‰
- [x] âœ… **Longbridge APIè¿”å›çš„ `volume` ç±»å‹**ï¼ˆnumberç±»å‹ï¼‰
- [x] âœ… **Longbridge APIè¿”å›çš„ `turnover` å­˜åœ¨**ï¼ˆå­—ç¬¦ä¸²ç±»å‹ï¼‰
- [x] âœ… **Moomooæ—¥Kæ•°æ®æ ¼å¼**ï¼ˆ`c/o/h/l/v/k`ï¼ŒåµŒå¥—åœ¨`data.list`ä¸­ï¼‰

### âœ… å·²ç¡®è®¤ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

- [x] âœ… Moomooæ—¥Kæ•°æ®çš„æˆäº¤é¢å­—æ®µä¸å­˜åœ¨ï¼Œè®¾ä¸º0ï¼ˆä¸å½“å‰ä»£ç å®ç°ä¸€è‡´ï¼‰
- [x] âœ… Moomooåˆ†æ—¶æ•°æ®åªæ”¯æŒå½“å¤©ï¼Œå›æµ‹ä¸­ä¸åšå¤„ç†

### â“ å¾…ç¡®è®¤ï¼ˆä½ä¼˜å…ˆçº§ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰

- [ ] â“ Moomooæ—¥Kæ•°æ®ä¸­å…¶ä»–å­—æ®µï¼ˆ`t`, `r`, `lc`, `cp`ï¼‰çš„ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ç¡®è®¤ï¼‰

- [ ] æ•°æ®æ ¼å¼çš„ç»Ÿä¸€æ€§ï¼ˆtimestampæ˜¯Dateè¿˜æ˜¯æ¯«ç§’æ—¶é—´æˆ³ï¼‰
- [ ] æ˜¯å¦éœ€è¦ç»Ÿä¸€æ‰€æœ‰æœåŠ¡çš„æ•°æ®æ ¼å¼
- [ ] Longbridge APIè¿”å›çš„ `tradeSession` å­—æ®µæ˜¯å¦å­˜åœ¨ï¼Ÿ

---

**âœ… å·²å®Œæˆçš„ç¡®è®¤**ï¼š
1. âœ… å·²æä¾› `historyCandlesticksByOffset()` çš„å®é™…è¿”å›æ•°æ®ç¤ºä¾‹
2. âœ… å·²ç¡®è®¤è¿™äº›æ–¹æ³•çš„è¿”å›æ ¼å¼ä¸ `candlesticks()` ç›¸åŒ
3. âœ… å·²ç¡®è®¤Moomooæ—¥Kæ•°æ®çš„åŸºæœ¬æ ¼å¼
4. âœ… å·²ç¡®è®¤Moomooæ—¥Kæ•°æ®çš„æˆäº¤é¢å­—æ®µå¤„ç†æ–¹å¼ï¼ˆè®¾ä¸º0ï¼‰
5. âœ… å·²ç¡®è®¤Moomooåˆ†æ—¶æ•°æ®åªæ”¯æŒå½“å¤©ï¼Œå›æµ‹ä¸­ä¸åšå¤„ç†

**â“ å‰©ä½™å¾…ç¡®è®¤**ï¼ˆä½ä¼˜å…ˆçº§ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰ï¼š
1. Moomooæ—¥Kæ•°æ®ä¸­å…¶ä»–å­—æ®µï¼ˆ`t`, `r`, `lc`, `cp`ï¼‰çš„ç”¨é€”

