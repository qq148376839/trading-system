# 期权价格获取切换长桥 API 主源

**日期**: 2026-02-10
**类型**: 功能优化
**状态**: ✅ 已完成

---

## 背景

此前期权价格/IV 的获取以富途 API 为主源，长桥 API 仅作为备用。由于长桥 SDK 直接集成在系统中、延迟更低，且 `optionQuote()` 能同时返回价格和 IV，因此切换为长桥主源、富途降级备用。

## 核心变更

### 新增：统一长桥期权行情服务

**文件**: `api/src/services/longport-option-quote.service.ts`

封装三个方法供各服务调用：

| 方法 | 数据源 | 返回 |
|------|--------|------|
| `getOptionQuote(symbol)` | `quoteCtx.optionQuote()` | price, iv, openInterest, bid, ask |
| `getOptionDepth(symbol)` | `quoteCtx.depth()` | bestBid, bestAsk, midPrice |
| `getOptionPrice(symbol, meta?)` | 统一价格链 | price, bid, ask, iv, source |

`getOptionPrice()` 价格获取链：
1. 缓存（optionPriceCacheService，10秒 TTL）
2. LongPort `optionQuote()` → lastDone + IV
3. LongPort `depth()` → bid/ask 中间价（当 lastDone=0）
4. 富途 `getOptionDetail()`（备用）
5. LongPort `quote()`（最终备用）

### 变更 1：止盈止损价格获取

**文件**: `api/src/services/strategy-scheduler.service.ts`
**方法**: `processHoldingPosition()`

改动前（4 层 if/else）：
```
cache → LongPort quote() → position_cache → Futu getOptionDetail → Futu chain fallback
```

改动后：
```
longportOptionQuoteService.getOptionPrice() → position_cache（额外备用）
```

### 变更 2：动态止盈止损 IV 获取

**文件**: `api/src/services/strategy-scheduler.service.ts`
**方法**: `processOptionDynamicExit()`

改动前：
```
Futu getOptionDetail() → IV + Delta + timeValue
```

改动后：
```
LongPort optionQuote() → IV（主源）
Futu getOptionDetail() → IV(备用) + Delta + timeValue
```

### 变更 3：订单执行价格验证

**文件**: `api/src/services/basic-execution.service.ts`
**方法**: `getCurrentMarketPrice()`

改动前：
```
cache → Futu getOptionDetail（主）→ LongPort quote()（备用）
```

改动后：
```
longportOptionQuoteService.getOptionPrice()（含缓存 + LongPort主 + 富途备用）
```

### 变更 4：动态止盈止损上下文构建

**文件**: `api/src/services/option-dynamic-exit.service.ts`
**方法**: `buildPositionContext()`

改动前：
```
Futu getOptionDetail() → IV + Delta + timeValue
```

改动后：
```
LongPort optionQuote() → IV（主源）
Futu getOptionDetail() → IV(备用) + Delta + timeValue
```

## 修改文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `api/src/services/longport-option-quote.service.ts` | 新建 | 统一长桥期权行情服务 |
| `api/src/services/strategy-scheduler.service.ts` | 修改 | 价格/IV获取切换长桥主源 |
| `api/src/services/basic-execution.service.ts` | 修改 | 期权价格验证切换长桥主源 |
| `api/src/services/option-dynamic-exit.service.ts` | 修改 | IV获取切换长桥主源 |

## 验证方式

1. `npx tsc --noEmit` 编译通过
2. 日志中 source 字段显示 `longport-optionQuote` 确认主源生效
3. 富途 API 仅在长桥失败时被调用（日志中出现 `futunn-*` source）

## 兼容性

- 富途 API 完整保留为备用，不影响现有降级逻辑
- 缓存机制不变（optionPriceCacheService，10秒 TTL）
- 权限错误（301604）自动降级到富途
