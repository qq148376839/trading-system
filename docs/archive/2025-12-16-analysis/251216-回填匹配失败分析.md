# å›å¡«åŒ¹é…å¤±è´¥åˆ†æ

## ğŸ“‹ é—®é¢˜æè¿°

**æ¸…ç†åé‡æ–°è¿è¡Œå›å¡«è„šæœ¬**ï¼š
- PENDINGä¿¡å·æ•°é‡ï¼šä»40,193å‡å°‘åˆ°29,858ï¼ˆå‡å°‘25.8%ï¼‰
- **åŒ¹é…ç»“æœ**ï¼šä»ç„¶æ˜¯0ä¸ªåŒ¹é…æˆåŠŸ
- æœªæ‰¾åˆ°ä¿¡å·çš„è®¢å•æ•°ï¼š45
- æœªæ‰¾åˆ°è®¢å•çš„ä¿¡å·æ•°ï¼š29,858

**ç»“è®º**ï¼šé—®é¢˜ä¸æ˜¯æ•°æ®é‡å¤ªå¤§ï¼Œè€Œæ˜¯**æ—¶é—´çª—å£åŒ¹é…é€»è¾‘çš„é—®é¢˜**ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜1ï¼šæ—¶é—´çª—å£å¤ªå° âš ï¸ **é«˜æ¦‚ç‡**

**å½“å‰è®¾ç½®**ï¼šé»˜è®¤Â±5åˆ†é’Ÿ

**é—®é¢˜**ï¼š
- ä¿¡å·å’Œè®¢å•çš„åˆ›å»ºæ—¶é—´å¯èƒ½å·®è·è¾ƒå¤§ï¼ˆè¶…è¿‡5åˆ†é’Ÿï¼‰
- ç­–ç•¥ç”Ÿæˆä¿¡å·åï¼Œå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´æ‰æ‰§è¡Œè®¢å•
- æˆ–è€…è®¢å•æ˜¯æ‰‹åŠ¨æäº¤çš„ï¼Œæ—¶é—´å·®è·æ›´å¤§

**éªŒè¯æ–¹æ³•**ï¼š
```sql
-- æ£€æŸ¥è®¢å•å’Œä¿¡å·çš„æ—¶é—´å·®åˆ†å¸ƒ
SELECT 
  eo.order_id,
  eo.created_at as order_time,
  ss.id as signal_id,
  ss.created_at as signal_time,
  ABS(EXTRACT(EPOCH FROM (eo.created_at - ss.created_at))) / 60 as time_diff_minutes
FROM execution_orders eo
CROSS JOIN strategy_signals ss
WHERE eo.strategy_id = ss.strategy_id
  AND eo.symbol = ss.symbol
  AND (
    (eo.side = 'BUY' AND ss.signal_type = 'BUY')
    OR (eo.side = 'SELL' AND ss.signal_type = 'SELL')
  )
  AND eo.signal_id IS NULL
  AND ss.status = 'PENDING'
ORDER BY time_diff_minutes
LIMIT 100;
```

### é—®é¢˜2ï¼šåŒ¹é…æ¡ä»¶å¤ªä¸¥æ ¼ âš ï¸ **ä¸­æ¦‚ç‡**

**å½“å‰åŒ¹é…æ¡ä»¶**ï¼š
- strategy_id å¿…é¡»ç›¸åŒ
- symbol å¿…é¡»ç›¸åŒ
- side å¿…é¡»åŒ¹é…ï¼ˆBUY/SELLï¼‰
- æ—¶é—´çª—å£Â±5åˆ†é’Ÿ
- ä¿¡å·çŠ¶æ€å¿…é¡»æ˜¯PENDING

**é—®é¢˜**ï¼š
- sideçš„æ ¼å¼å¯èƒ½ä¸ä¸€è‡´ï¼ˆBUY vs Buyï¼‰
- symbolæ ¼å¼å¯èƒ½ä¸ä¸€è‡´ï¼ˆ.US vs .usï¼‰
- ä¿¡å·çŠ¶æ€å¯èƒ½å·²ç»æ”¹å˜

**éªŒè¯æ–¹æ³•**ï¼š
```sql
-- æ£€æŸ¥sideæ ¼å¼åˆ†å¸ƒ
SELECT DISTINCT side FROM execution_orders WHERE signal_id IS NULL;
SELECT DISTINCT signal_type FROM strategy_signals WHERE status = 'PENDING';

-- æ£€æŸ¥symbolæ ¼å¼
SELECT DISTINCT symbol FROM execution_orders WHERE signal_id IS NULL LIMIT 10;
SELECT DISTINCT symbol FROM strategy_signals WHERE status = 'PENDING' LIMIT 10;
```

### é—®é¢˜3ï¼šä¿¡å·å’Œè®¢å•ä¸åŒ¹é… âš ï¸ **ä¸­æ¦‚ç‡**

**é—®é¢˜**ï¼š
- è®¢å•å¯èƒ½æ˜¯æ‰‹åŠ¨æäº¤çš„ï¼Œæ²¡æœ‰å¯¹åº”çš„ä¿¡å·
- æˆ–è€…ä¿¡å·ç”Ÿæˆåï¼Œè®¢å•æ‰§è¡Œå¤±è´¥ï¼Œæ²¡æœ‰å…³è”
- æˆ–è€…è®¢å•æ˜¯ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„ï¼ˆå¦‚æ­¢æŸ/æ­¢ç›ˆï¼‰ï¼Œæ²¡æœ‰å¯¹åº”çš„ä¿¡å·

**éªŒè¯æ–¹æ³•**ï¼š
```sql
-- æ£€æŸ¥è®¢å•çš„åˆ›å»ºæ—¶é—´åˆ†å¸ƒ
SELECT 
  DATE(created_at) as date,
  COUNT(*) as count,
  MIN(created_at) as earliest,
  MAX(created_at) as latest
FROM execution_orders
WHERE signal_id IS NULL
GROUP BY DATE(created_at)
ORDER BY date DESC
LIMIT 30;

-- æ£€æŸ¥ä¿¡å·çš„åˆ›å»ºæ—¶é—´åˆ†å¸ƒ
SELECT 
  DATE(created_at) as date,
  COUNT(*) as count,
  MIN(created_at) as earliest,
  MAX(created_at) as latest
FROM strategy_signals
WHERE status = 'PENDING'
GROUP BY DATE(created_at)
ORDER BY date DESC
LIMIT 30;
```

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ‰©å¤§æ—¶é—´çª—å£ â­ **æ¨èå…ˆå°è¯•**

**å®æ–½æ­¥éª¤**ï¼š

1. **ä½¿ç”¨30åˆ†é’Ÿæ—¶é—´çª—å£æµ‹è¯•**ï¼š
   ```bash
   npm run backfill-signals:dry-run -- --time-window-minutes=30
   ```

2. **å¦‚æœä»ç„¶åŒ¹é…å¤±è´¥ï¼Œå°è¯•60åˆ†é’Ÿ**ï¼š
   ```bash
   npm run backfill-signals:dry-run -- --time-window-minutes=60
   ```

3. **å¦‚æœä»ç„¶åŒ¹é…å¤±è´¥ï¼Œå°è¯•120åˆ†é’Ÿ**ï¼š
   ```bash
   npm run backfill-signals:dry-run -- --time-window-minutes=120
   ```

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ æ—¶é—´çª—å£è¶Šå¤§ï¼Œè¯¯åŒ¹é…çš„é£é™©è¶Šé«˜
- âš ï¸ å»ºè®®å…ˆè¿è¡Œdry-runæ¨¡å¼æŸ¥çœ‹ç»“æœ
- âš ï¸ é€æ­¥æ‰©å¤§æ—¶é—´çª—å£ï¼Œæ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹

### æ–¹æ¡ˆ2ï¼šåˆ†ææ•°æ®æ—¶é—´å·®åˆ†å¸ƒ â­ **æ¨èå…ˆæ‰§è¡Œ**

**æ‰§è¡ŒSQLæŸ¥è¯¢ï¼Œäº†è§£æ•°æ®æƒ…å†µ**ï¼š

```sql
-- æŸ¥è¯¢1ï¼šæ£€æŸ¥è®¢å•å’Œä¿¡å·çš„æ—¶é—´å·®åˆ†å¸ƒ
SELECT 
  CASE 
    WHEN time_diff <= 5 THEN '0-5åˆ†é’Ÿ'
    WHEN time_diff <= 15 THEN '5-15åˆ†é’Ÿ'
    WHEN time_diff <= 30 THEN '15-30åˆ†é’Ÿ'
    WHEN time_diff <= 60 THEN '30-60åˆ†é’Ÿ'
    WHEN time_diff <= 120 THEN '60-120åˆ†é’Ÿ'
    ELSE '120åˆ†é’Ÿä»¥ä¸Š'
  END as time_range,
  COUNT(*) as count
FROM (
  SELECT 
    eo.order_id,
    ss.id as signal_id,
    ABS(EXTRACT(EPOCH FROM (eo.created_at - ss.created_at))) / 60 as time_diff
  FROM execution_orders eo
  CROSS JOIN strategy_signals ss
  WHERE eo.strategy_id = ss.strategy_id
    AND eo.symbol = ss.symbol
    AND (
      (eo.side = 'BUY' AND ss.signal_type = 'BUY')
      OR (eo.side = 'SELL' AND ss.signal_type = 'SELL')
    )
    AND eo.signal_id IS NULL
    AND ss.status = 'PENDING'
) t
GROUP BY time_range
ORDER BY time_range;
```

**æ ¹æ®æŸ¥è¯¢ç»“æœå†³å®š**ï¼š
- å¦‚æœå¤§éƒ¨åˆ†æ—¶é—´å·®åœ¨5-30åˆ†é’Ÿï¼šä½¿ç”¨30åˆ†é’Ÿæ—¶é—´çª—å£
- å¦‚æœå¤§éƒ¨åˆ†æ—¶é—´å·®åœ¨30-60åˆ†é’Ÿï¼šä½¿ç”¨60åˆ†é’Ÿæ—¶é—´çª—å£
- å¦‚æœå¤§éƒ¨åˆ†æ—¶é—´å·®åœ¨60åˆ†é’Ÿä»¥ä¸Šï¼šè€ƒè™‘å…¶ä»–æ–¹æ¡ˆ

### æ–¹æ¡ˆ3ï¼šä¼˜åŒ–åŒ¹é…é€»è¾‘ â­ **é•¿æœŸä¼˜åŒ–**

**æ”¹è¿›å»ºè®®**ï¼š

1. **æ”¾å®½sideåŒ¹é…**ï¼š
   - æ”¯æŒBUY/Buy/buyç­‰å¤šç§æ ¼å¼
   - æ”¯æŒSELL/Sell/sellç­‰å¤šç§æ ¼å¼

2. **æ”¾å®½symbolåŒ¹é…**ï¼š
   - æ”¯æŒå¤§å°å†™ä¸æ•æ„ŸåŒ¹é…
   - æ”¯æŒ.US/.usç­‰å¤šç§æ ¼å¼

3. **ä¼˜å…ˆçº§åŒ¹é…**ï¼š
   - ä¼˜å…ˆåŒ¹é…è®¢å•åˆ›å»ºæ—¶é—´ä¹‹å‰çš„ä¿¡å·ï¼ˆæœ€è¿‘çš„ï¼‰
   - é™çº§åŒ¹é…è®¢å•åˆ›å»ºæ—¶é—´ä¹‹åçš„ä¿¡å·ï¼ˆæœ€è¿‘çš„ï¼‰

4. **æ·»åŠ æ‰‹åŠ¨åŒ¹é…åŠŸèƒ½**ï¼š
   - å¯¹äºæ— æ³•è‡ªåŠ¨åŒ¹é…çš„è®¢å•ï¼Œæä¾›æ‰‹åŠ¨å…³è”ç•Œé¢

### æ–¹æ¡ˆ4ï¼šæ¸…ç†æ— æ³•åŒ¹é…çš„ä¿¡å· â­ **å¯é€‰**

**å¦‚æœç¡®è®¤å¤§éƒ¨åˆ†PENDINGä¿¡å·éƒ½æ— æ³•åŒ¹é…**ï¼š

```bash
# æ¸…ç†æ‰€æœ‰éæŒä»“æ ‡çš„çš„PENDINGä¿¡å·ï¼ˆæ— è®ºæ—¶é—´ï¼‰
# æ³¨æ„ï¼šæ­¤æ“ä½œè¾ƒæ¿€è¿›ï¼Œå»ºè®®å…ˆå¤‡ä»½æ•°æ®åº“
```

**æˆ–è€…**ï¼š
```sql
-- å°†è¶…è¿‡30å¤©æœªåŒ¹é…çš„PENDINGä¿¡å·æ ‡è®°ä¸ºIGNORED
UPDATE strategy_signals
SET status = 'IGNORED'
WHERE status = 'PENDING'
  AND created_at < NOW() - INTERVAL '30 days'
  AND symbol NOT IN (
    SELECT DISTINCT symbol 
    FROM strategy_instances 
    WHERE current_state = 'HOLDING'
  );
```

---

## ğŸš€ æ¨èæ‰§è¡Œæ­¥éª¤

### æ­¥éª¤1ï¼šåˆ†ææ•°æ®æ—¶é—´å·®åˆ†å¸ƒ â­ **å¿…é¡»å…ˆæ‰§è¡Œ**

è¿è¡ŒSQLæŸ¥è¯¢ï¼Œäº†è§£è®¢å•å’Œä¿¡å·çš„æ—¶é—´å·®åˆ†å¸ƒï¼š

```sql
-- æ£€æŸ¥æ—¶é—´å·®åˆ†å¸ƒ
SELECT 
  CASE 
    WHEN time_diff <= 5 THEN '0-5åˆ†é’Ÿ'
    WHEN time_diff <= 15 THEN '5-15åˆ†é’Ÿ'
    WHEN time_diff <= 30 THEN '15-30åˆ†é’Ÿ'
    WHEN time_diff <= 60 THEN '30-60åˆ†é’Ÿ'
    WHEN time_diff <= 120 THEN '60-120åˆ†é’Ÿ'
    ELSE '120åˆ†é’Ÿä»¥ä¸Š'
  END as time_range,
  COUNT(*) as count
FROM (
  SELECT 
    ABS(EXTRACT(EPOCH FROM (eo.created_at - ss.created_at))) / 60 as time_diff
  FROM execution_orders eo
  CROSS JOIN strategy_signals ss
  WHERE eo.strategy_id = ss.strategy_id
    AND eo.symbol = ss.symbol
    AND (
      (eo.side = 'BUY' AND ss.signal_type = 'BUY')
      OR (eo.side = 'SELL' AND ss.signal_type = 'SELL')
    )
    AND eo.signal_id IS NULL
    AND ss.status = 'PENDING'
) t
GROUP BY time_range
ORDER BY time_range;
```

### æ­¥éª¤2ï¼šæ ¹æ®åˆ†æç»“æœæ‰©å¤§æ—¶é—´çª—å£

**å¦‚æœæ—¶é—´å·®ä¸»è¦åœ¨5-30åˆ†é’Ÿ**ï¼š
```bash
npm run backfill-signals:dry-run -- --time-window-minutes=30
```

**å¦‚æœæ—¶é—´å·®ä¸»è¦åœ¨30-60åˆ†é’Ÿ**ï¼š
```bash
npm run backfill-signals:dry-run -- --time-window-minutes=60
```

**å¦‚æœæ—¶é—´å·®ä¸»è¦åœ¨60åˆ†é’Ÿä»¥ä¸Š**ï¼š
- è€ƒè™‘ä½¿ç”¨æ›´å¤§çš„æ—¶é—´çª—å£ï¼ˆ120åˆ†é’Ÿæˆ–æ›´é•¿ï¼‰
- æˆ–è€…è€ƒè™‘è¿™äº›ä¿¡å·å’Œè®¢å•å¯èƒ½ä¸åŒ¹é…

### æ­¥éª¤3ï¼šéªŒè¯åŒ¹é…ç»“æœ

å¦‚æœåŒ¹é…æˆåŠŸï¼ŒæŸ¥çœ‹åŒ¹é…çš„è®¢å•å’Œä¿¡å·ï¼š

```sql
-- æ£€æŸ¥åŒ¹é…æˆåŠŸçš„è®¢å•
SELECT 
  eo.order_id,
  eo.symbol,
  eo.side,
  eo.created_at as order_time,
  ss.id as signal_id,
  ss.created_at as signal_time,
  ABS(EXTRACT(EPOCH FROM (eo.created_at - ss.created_at))) / 60 as time_diff_minutes
FROM execution_orders eo
JOIN strategy_signals ss ON eo.signal_id = ss.id
WHERE eo.signal_id IS NOT NULL
ORDER BY eo.created_at DESC
LIMIT 20;
```

---

## âš ï¸ é‡è¦æé†’

1. **æ•°æ®å¤‡ä»½**ï¼šæ‰§è¡Œä»»ä½•æ•°æ®ä¿®æ”¹å‰ï¼Œç¡®ä¿æ•°æ®åº“æœ‰å¤‡ä»½
2. **é€æ­¥æµ‹è¯•**ï¼šå…ˆè¿è¡Œdry-runæ¨¡å¼ï¼Œç¡®è®¤ç»“æœåå†å®é™…æ‰§è¡Œ
3. **æ—¶é—´çª—å£å¹³è¡¡**ï¼šæ—¶é—´çª—å£è¶Šå¤§ï¼Œè¯¯åŒ¹é…çš„é£é™©è¶Šé«˜
4. **æ‰‹åŠ¨éªŒè¯**ï¼šåŒ¹é…æˆåŠŸåï¼Œå»ºè®®æ‰‹åŠ¨éªŒè¯å‡ ä¸ªè®¢å•å’Œä¿¡å·çš„å…³è”æ˜¯å¦æ­£ç¡®

---

## ğŸ“ æ€»ç»“

**å½“å‰æƒ…å†µ**ï¼š
- âŒ 0ä¸ªè®¢å•å’Œä¿¡å·åŒ¹é…æˆåŠŸ
- âš ï¸ 29,858ä¸ªPENDINGä¿¡å·æœªå…³è”
- âš ï¸ 45ä¸ªè®¢å•æœªå…³è”ä¿¡å·

**å¯èƒ½åŸå› **ï¼š
1. æ—¶é—´çª—å£å¤ªå°ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰
2. ä¿¡å·å’Œè®¢å•çš„åˆ›å»ºæ—¶é—´å·®è·è¾ƒå¤§
3. åŒ¹é…æ¡ä»¶å¤ªä¸¥æ ¼

**å»ºè®®è¡ŒåŠ¨**ï¼š
1. âœ… **å…ˆåˆ†ææ•°æ®**ï¼šè¿è¡ŒSQLæŸ¥è¯¢ï¼Œäº†è§£æ—¶é—´å·®åˆ†å¸ƒ
2. âœ… **æ‰©å¤§æ—¶é—´çª—å£**ï¼šæ ¹æ®åˆ†æç»“æœï¼Œä½¿ç”¨30-120åˆ†é’Ÿçš„æ—¶é—´çª—å£
3. âœ… **éªŒè¯åŒ¹é…ç»“æœ**ï¼šåŒ¹é…æˆåŠŸåï¼ŒéªŒè¯å…³è”æ˜¯å¦æ­£ç¡®
4. â³ **é•¿æœŸä¼˜åŒ–**ï¼šä¼˜åŒ–åŒ¹é…é€»è¾‘ï¼Œæ”¯æŒæ›´çµæ´»çš„åŒ¹é…æ¡ä»¶

---

**åˆ†æå®Œæˆæ—¶é—´**ï¼š2025-12-16  
**ä¸‹æ¬¡æ›´æ–°è®¡åˆ’**ï¼šæ‰©å¤§æ—¶é—´çª—å£æµ‹è¯•åæ›´æ–°




