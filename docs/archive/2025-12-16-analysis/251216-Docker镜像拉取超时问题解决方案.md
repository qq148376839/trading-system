# Docker 镜像拉取超时问题解决方案

## 问题描述

Docker 构建时出现 TLS handshake timeout 错误，无法从镜像源拉取 `node:20` 镜像。

## 解决方案

### 方案 1: 检查并修复 Docker 镜像源配置（推荐）

在 NAS 上检查 Docker 的镜像源配置：

```bash
# 检查 Docker daemon 配置
cat /etc/docker/daemon.json
```

如果配置了自定义镜像源（如 `dockerhub.riowang.win`），可以：

**选项 A：使用官方 Docker Hub**
```json
{
  "registry-mirrors": []
}
```

**选项 B：使用国内镜像源（如果在中国）**
```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
```

修改后重启 Docker：
```bash
sudo systemctl restart docker
# 或者在 Synology NAS 上通过 DSM 界面重启 Docker
```

### 方案 2: 使用代理（如果 NAS 有代理）

如果 NAS 配置了代理，确保 Docker 可以使用代理：

```bash
# 创建或编辑 Docker 服务配置
sudo mkdir -p /etc/systemd/system/docker.service.d
sudo nano /etc/systemd/system/docker.service.d/http-proxy.conf
```

添加：
```ini
[Service]
Environment="HTTP_PROXY=http://proxy.example.com:8080"
Environment="HTTPS_PROXY=http://proxy.example.com:8080"
Environment="NO_PROXY=localhost,127.0.0.1"
```

然后：
```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### 方案 3: 手动拉取镜像

如果镜像源不稳定，可以手动拉取镜像：

```bash
# 尝试直接拉取
docker pull node:20

# 如果失败，尝试使用官方源
docker pull docker.io/library/node:20

# 或者使用其他镜像源
docker pull registry.cn-hangzhou.aliyuncs.com/acs/node:20
```

### 方案 4: 使用国内镜像（临时方案）

如果上述方案都不行，可以修改 Dockerfile 使用国内镜像：

```dockerfile
FROM registry.cn-hangzhou.aliyuncs.com/acs/node:20
```

或者使用阿里云镜像：
```dockerfile
FROM registry.cn-hangzhou.aliyuncs.com/google_containers/node:20
```

### 方案 5: 增加超时时间和重试

在 docker-compose.yml 中添加构建参数：

```yaml
services:
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
```

或者使用环境变量：
```bash
export DOCKER_BUILDKIT=1
export BUILDKIT_STEP_LOG_MAX_SIZE=10485760
docker-compose build --no-cache api
```

## 推荐操作步骤

1. **首先检查 Docker 镜像源配置**
   ```bash
   cat /etc/docker/daemon.json
   ```

2. **如果配置了不稳定的镜像源，临时移除或更换**
   ```bash
   sudo nano /etc/docker/daemon.json
   # 修改或清空 registry-mirrors
   ```

3. **重启 Docker 服务**
   ```bash
   sudo systemctl restart docker
   # 或在 Synology DSM 中重启 Docker 套件
   ```

4. **重新尝试构建**
   ```bash
   docker-compose build --no-cache api
   ```

5. **如果仍然超时，尝试手动拉取镜像**
   ```bash
   docker pull node:20
   docker-compose build --no-cache api
   ```

## Synology NAS 特定说明

在 Synology NAS 上：

1. **通过 DSM 界面配置**：
   - 打开 Docker 套件
   - 进入"注册表" → "设置"
   - 检查或修改镜像源设置

2. **通过 SSH 配置**：
   ```bash
   sudo vi /var/packages/Docker/etc/dockerd.json
   # 修改 registry-mirrors 配置
   # 然后重启 Docker 套件
   ```

3. **检查网络连接**：
   - 确保 NAS 可以访问互联网
   - 检查防火墙设置
   - 检查 DNS 设置

## 验证

构建成功后，验证镜像：
```bash
docker images | grep node
docker-compose up -d api
docker-compose logs api
```





