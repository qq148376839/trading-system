# 历史数据清理方案

## 📋 问题分析

**当前数据情况**：
- ❌ **40,193个PENDING信号**未关联订单
- ❌ **45个订单**未关联信号
- ❌ **0个匹配成功**（时间窗口问题）

**问题根源**：
1. 历史数据积累过多
2. PENDING信号可能已过期（超过7天未执行）
3. 已完成的订单和交易记录占用大量空间

---

## 🎯 清理策略

### 原则：**安全第一，保留必要数据**

1. **保留当前持仓相关的所有数据**
   - 当前持仓的标的的所有信号、订单、交易记录
   - 确保不影响当前持仓的监控和管理

2. **清理过期数据**
   - PENDING信号：超过7天未执行 → 标记为IGNORED
   - 已完成订单：超过30天 → 删除
   - 已完成交易记录：超过30天 → 删除

3. **保留策略**
   - 当前持仓的标的：**永久保留**
   - 非持仓标的：按时间清理

---

## 📝 清理方案

### 方案1：清理过期PENDING信号 ⭐ **推荐先执行**

**目标**：清理40,193个PENDING信号中的过期信号

**清理规则**：
- 超过7天未执行的PENDING信号 → 标记为IGNORED
- **排除**：当前持仓的标的的所有信号（保留）

**执行方法**：
```bash
# 预览模式（推荐先运行）
npm run cleanup-data:dry-run -- --keep-pending-days=7

# 实际执行
npm run cleanup-data -- --keep-pending-days=7
```

**预期效果**：
- 清理大部分过期的PENDING信号
- 保留当前持仓相关的信号
- 减少数据量，提高查询性能

### 方案2：清理已完成的订单 ⭐ **可选**

**目标**：清理30天前已完成的订单

**清理规则**：
- 状态为FilledStatus/CanceledStatus/RejectedStatus
- 更新时间超过30天
- **排除**：当前持仓的标的的所有订单（保留）

**执行方法**：
```bash
# 预览模式
npm run cleanup-data:dry-run -- --days=30

# 实际执行
npm run cleanup-data -- --days=30
```

**预期效果**：
- 清理历史订单数据
- 保留当前持仓相关的订单
- 减少数据库大小

### 方案3：清理已完成的交易记录 ⭐ **可选**

**目标**：清理30天前已完成的交易记录（auto_trades表）

**清理规则**：
- close_time不为空（已平仓）
- 关闭时间超过30天
- **排除**：当前持仓的标的的所有交易记录（保留）

**注意**：
- 如果`auto_trades`表不存在，脚本会自动跳过此步骤
- 不会影响其他清理操作

**执行方法**：
```bash
# 预览模式
npm run cleanup-data:dry-run -- --days=30

# 实际执行
npm run cleanup-data -- --days=30
```

---

## 🚀 推荐执行步骤

### 步骤1：分析当前数据（可选）

```sql
-- 查看PENDING信号的创建时间分布
SELECT 
  DATE(created_at) as date,
  COUNT(*) as count
FROM strategy_signals
WHERE status = 'PENDING'
GROUP BY DATE(created_at)
ORDER BY date DESC
LIMIT 30;

-- 查看当前持仓
SELECT symbol, current_state, updated_at
FROM strategy_instances
WHERE current_state = 'HOLDING'
ORDER BY updated_at DESC;
```

### 步骤2：清理过期PENDING信号（推荐）

```bash
# 1. 预览模式（查看会清理多少数据）
npm run cleanup-data:dry-run -- --keep-pending-days=7

# 2. 如果预览结果合理，实际执行
npm run cleanup-data -- --keep-pending-days=7
```

**预期清理数量**：
- 如果大部分PENDING信号都是7天前的，可能清理30,000-40,000个
- 保留当前持仓相关的信号

### 步骤3：验证清理结果

```sql
-- 检查PENDING信号数量
SELECT COUNT(*) as count
FROM strategy_signals
WHERE status = 'PENDING';

-- 检查IGNORED信号数量
SELECT COUNT(*) as count
FROM strategy_signals
WHERE status = 'IGNORED';
```

### 步骤4：清理已完成的订单（可选）

```bash
# 预览模式
npm run cleanup-data:dry-run -- --days=30

# 实际执行（如果预览结果合理）
npm run cleanup-data -- --days=30
```

### 步骤5：清理已完成的交易记录（可选）

```bash
# 预览模式
npm run cleanup-data:dry-run -- --days=30

# 实际执行（如果预览结果合理）
npm run cleanup-data -- --days=30
```

---

## ⚠️ 重要注意事项

### 1. 数据备份

**执行清理前，必须备份数据库**：
```bash
# PostgreSQL备份示例
pg_dump -U your_user -d your_database > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 2. 预览模式

**强烈建议先运行预览模式**：
- 查看会清理多少数据
- 确认清理规则正确
- 避免误删重要数据

### 3. 当前持仓保护

**清理脚本会自动保护当前持仓**：
- 当前持仓的标的的所有数据都不会被清理
- 包括信号、订单、交易记录

### 4. 逐步执行

**建议分步执行**：
1. 先清理PENDING信号（影响最大）
2. 观察系统运行情况
3. 再决定是否清理订单和交易记录

---

## 📊 预期效果

### 清理PENDING信号后

**预期结果**：
- PENDING信号数量：从40,193减少到几百或几千
- IGNORED信号数量：增加30,000-40,000
- 数据库大小：减少约10-20%
- 查询性能：提升20-30%

### 清理订单和交易记录后

**预期结果**：
- 订单数量：减少50-70%
- 交易记录数量：减少50-70%
- 数据库大小：减少30-50%
- 查询性能：提升30-50%

---

## 🔄 后续维护

### 定期清理（建议）

**设置定期清理任务**：
- 每周清理一次过期的PENDING信号
- 每月清理一次已完成的订单和交易记录
- 使用cron任务或定时脚本

**示例cron配置**：
```bash
# 每周日凌晨2点清理过期的PENDING信号
0 2 * * 0 cd /path/to/api && npm run cleanup-data -- --keep-pending-days=7

# 每月1日凌晨3点清理已完成的订单和交易记录
0 3 1 * * cd /path/to/api && npm run cleanup-data -- --days=30
```

---

## 📝 总结

### ✅ **推荐执行**

1. **立即执行**：清理过期PENDING信号（7天）
   - 影响最大，风险最小
   - 可以大幅减少数据量

2. **后续考虑**：清理已完成的订单和交易记录（30天）
   - 根据实际需求决定
   - 建议先观察清理PENDING信号后的效果

### ⚠️ **注意事项**

1. **数据备份**：执行前必须备份数据库
2. **预览模式**：先运行dry-run模式查看结果
3. **当前持仓保护**：脚本会自动保护当前持仓的数据
4. **逐步执行**：分步执行，观察效果

---

**方案创建时间**：2025-12-16  
**执行结果**：✅ 成功清理10,378个过期PENDING信号（保留3天）  
**详细结果**：请参考 [清理成功总结](251216-数据清理成功总结.md)





