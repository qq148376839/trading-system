# Docker 构建问题修复说明

## 问题分析

### 根本原因
1. **项目使用 pnpm 管理依赖**：`api` 目录有 `pnpm-lock.yaml`，但 Dockerfile 使用了 `npm ci`
2. **npm ci 需要 package-lock.json**：`npm ci` 命令要求存在 `package-lock.json` 文件，但项目只有 `pnpm-lock.yaml`
3. **依赖管理工具不一致**：Windows 上可能使用了 npm，但项目实际应该使用 pnpm

### 错误信息
```
npm error The `npm ci` command can only install with an existing package-lock.json
```

## 已修复的内容

### 1. API Dockerfile (`api/Dockerfile`)
- ✅ 安装 pnpm
- ✅ 复制 `pnpm-lock.yaml` 而不是 `package-lock.json`
- ✅ 使用 `pnpm install --frozen-lockfile` 代替 `npm ci`
- ✅ 使用 `pnpm run build` 和 `pnpm start`

### 2. Frontend Dockerfile (`frontend/Dockerfile`)
- ✅ 安装 pnpm
- ✅ 智能检测 lock 文件：
  - 优先使用 `pnpm-lock.yaml`（如果存在）
  - 回退到 `package-lock.json`（如果存在）
  - 都没有则使用 `pnpm install` 生成新的 lock 文件
- ✅ 使用 pnpm 或 npm 构建（根据 lock 文件自动选择）

## 后续步骤

### 1. 确保 frontend 使用 pnpm（推荐）

在 `frontend` 目录执行：
```bash
cd frontend
pnpm install
```

这会生成 `frontend/pnpm-lock.yaml`，然后提交到 Git：
```bash
git add frontend/pnpm-lock.yaml
git commit -m "Add pnpm-lock.yaml for frontend"
git push
```

### 2. 清理不需要的 package-lock.json（可选）

如果 frontend 目录有 `package-lock.json` 但不再需要，可以删除：
```bash
cd frontend
rm package-lock.json
git add package-lock.json
git commit -m "Remove package-lock.json, use pnpm instead"
```

### 3. 验证 Docker 构建

在项目根目录执行：
```bash
docker-compose build
```

如果 frontend 还没有 `pnpm-lock.yaml`，Dockerfile 会：
- 尝试使用 `package-lock.json`（如果存在）
- 或者使用 `pnpm install` 生成新的 lock 文件

## 最佳实践建议

1. **统一使用 pnpm**：整个项目应该统一使用 pnpm 管理依赖
2. **提交 lock 文件**：确保 `pnpm-lock.yaml` 提交到 Git，保证构建一致性
3. **不要混用 npm 和 pnpm**：避免在同一个项目中混用两种包管理器

## 验证构建

构建成功后，可以启动服务：
```bash
docker-compose up -d
```

检查服务状态：
```bash
docker-compose ps
```

查看日志：
```bash
docker-compose logs api
docker-compose logs frontend
```




