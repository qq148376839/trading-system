# 回测功能修复说明

## 问题分析

### 发现的问题

1. **买入资金扣除错误**：
   - **原逻辑**：买入时扣除 `tradeAmount = currentCapital * 0.1`（计划投入金额）
   - **实际买入成本**：`price * quantity`（由于向下取整，`price * quantity <= tradeAmount`）
   - **问题**：多扣了资金，导致现金计算错误

2. **资金不平衡**：
   - 买入时扣除：`tradeAmount`（可能大于实际成本）
   - 卖出时收回：`price * quantity`（实际卖出金额）
   - 导致资金不平衡，权益计算错误

3. **连锁影响**：
   - 每日权益计算错误（权益 = 现金 + 持仓市值，但现金错误）
   - 总收益率计算错误（基于最后一天的权益）
   - 最大回撤计算错误（基于每日权益）
   - 夏普比率计算错误（基于每日收益率）

## 修复方案

### 修复内容

1. **买入逻辑修复**（`simulateBuy` 方法）：
   ```typescript
   // 修复前
   onCapitalChange(tradeAmount); // 扣除计划投入金额
   
   // 修复后
   const actualCost = price * quantity; // 计算实际买入成本
   onCapitalChange(-actualCost); // 扣除实际买入成本（负数）
   ```

2. **买入回调修复**：
   ```typescript
   // 修复前
   (amount) => {
     currentCapital -= amount; // amount 是正数
   }
   
   // 修复后
   (amount) => {
     currentCapital += amount; // amount 是负数（实际买入成本）
   }
   ```

3. **卖出逻辑保持不变**（已经是正确的）：
   ```typescript
   const sellAmount = price * trade.quantity;
   onCapitalChange(sellAmount); // 加上卖出收回的资金（正数）
   ```

### 修复后的资金流

1. **买入时**：
   - 扣除：`price * quantity`（实际买入成本）
   - 现金变化：`currentCapital -= price * quantity`

2. **卖出时**：
   - 收回：`price * quantity`（实际卖出金额）
   - 现金变化：`currentCapital += price * quantity`

3. **盈亏计算**：
   - PnL = `(exitPrice - entryPrice) * quantity`
   - 最终资金 = `初始资金 - 买入成本 + 卖出金额 = 初始资金 + PnL`

## 验证方法

### 手动验证

根据您提供的回测数据：
- 初始资本：$10,000
- 交易明细显示总盈利：$667.77
- 预期最终权益：$10,000 + $667.77 = $10,667.77
- 预期总收益率：($10,667.77 - $10,000) / $10,000 * 100 = 6.68%

### 代码验证

修复后，回测应该：
1. 正确计算每笔交易的买入成本
2. 正确计算每日权益（现金 + 持仓市值）
3. 正确计算总收益率
4. 正确计算最大回撤和夏普比率

## 注意事项

1. **需要重新运行回测**：修复后的代码需要重新运行回测才能看到正确的结果
2. **历史数据不受影响**：已保存的回测结果不会自动更新，需要重新运行回测
3. **测试建议**：建议先用小数据集测试，验证修复后的计算结果是否正确

## 后续优化建议

1. **添加单元测试**：为资金计算逻辑添加单元测试
2. **添加日志**：在关键步骤添加日志，便于调试
3. **数据验证**：添加数据一致性检查，确保资金计算正确

