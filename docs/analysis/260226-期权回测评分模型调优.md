# 期权回测评分模型调优 — marketScore修复 + SPX粒度对齐 + 诊断日志 + 禁用时间止损

**日期**: 2026-02-26
**状态**: 待实现
**优先级**: P2
**来源**: 回测 #86 深度分析 → 评分模型逐层探索

---

## 背景

回测评分公式：
```
finalScore = marketScore × 0.2 + intradayScore × 0.6 + timeAdj × 0.2
```

入场条件：`finalScore > dynamicThreshold`（CALL）或 `finalScore < -dynamicThreshold`（PUT）
- dynamicThreshold = baseThreshold × vixFactor
- AGGRESSIVE base=10, CONSERVATIVE base=30, vixFactor = clamp(VIX/20, 0.5, 2.5)

通过深度代码探索（逐行对比实盘 vs 回测），发现 3 个实质性评分问题。

---

## 问题总览

| # | 问题 | 影响占比 | 严重度 |
|---|------|----------|--------|
| 1 | SPX日内动量粒度不匹配（1m vs hourly） | 15% of finalScore | **高** |
| 2 | Temperature dead zone (20-50无贡献) | 2% of finalScore | **中** |
| 3 | 诊断日志缺intradayScore分量明细 | 调优可见性 | **高** |
| 4 | 时间止损(time_stop_no_tailwind)在多重保障下冗余且有害 | 回测72%亏损来源 | **P0** |

---

## 问题 1: SPX 日内动量粒度不匹配（最高影响）

### 现象

`intradayScore` 的第3分量（SPX日内动量，25%权重）在回测中数值比实盘小约15倍。

### 根因

| 维度 | 实盘 | 回测 |
|------|------|------|
| 数据源 | SPX 小时K线 (`spxHourly`) | SPX 原始 1m bars (`spxIntraday.slice(-10)`) |
| 滤波 | `intradayDataFilterService.filterData()` (Z-score+EMA) | 无 |
| 典型动量值 | ~2.0-5.0 | ~0.1-0.3 |
| 加权后 (×0.25) | ~0.5-1.25 | ~0.025-0.075 |

`calculateMomentum()` 计算相邻bar收益率均值 × 1000：
- 1m bar 收益率: ~0.02% → momentum ~0.2
- 1h bar 收益率: ~0.3% → momentum ~3.0

**代码位置**:
- 实盘: `option-recommendation.service.ts:423` → `spxHourly` + `intradayDataFilterService.filterData()`
- 回测: `option-backtest.service.ts:274` → `spxIntraday.slice(-10)` (raw 1m, 无滤波)

### 影响量化

SPX日内分量占 intradayScore 的 25%，intradayScore 占 finalScore 的 60%。
有效影响: 25% × 60% = **15% of finalScore**。

正常回测该分量贡献 ~0.03-0.08 分（vs 实盘 0.5-1.25 分），差距 15-40 倍。

### 修复方案

1. `buildMarketDataWindow()` 中将 SPX 1m bars 聚合为小时K线（复用已有 `aggregateToHourly()`）
2. `MarketDataWindow` 接口新增 `spxHourlyFromIntraday` 字段
3. `calculateIntradayScore()` 第3分量改用聚合后的小时K线 + `filterData()` 滤波
4. 保留 fallback：开盘初期1m不足60根时直接用1m（精度降低但不阻塞）

---

## 问题 2: Temperature Dead Zone (20-50)

### 现象

`calculateMarketScore` 中市场温度分量（10%权重）在最常见的市场条件下贡献恒为零。

### 根因

当前逻辑 (`option-backtest.service.ts:229-234` 和 `option-recommendation.service.ts:359-369`):
```typescript
if (temp > 50) { score += (temp - 50) * coeff; }      // 温度 > 50 才加分
else if (temp < 20) { score -= (20 - temp) * 0.5; }    // 温度 < 20 才减分
// temp 20-50: 贡献 = 0 (dead zone)
```

`estimateMarketTemperature()` 公式: `temp = (100 - VIX×2.5) + (upDays-2.5)×6`

**典型VIX区间（18-24）的温度输出**:

| VIX | 5日涨跌 | temp | 贡献(旧) |
|-----|---------|------|----------|
| 17 | 3/5涨 | 60.5 | +3.15 |
| 18 | 3/5涨 | 58.0 | +2.40 |
| 20 | 2/5涨 | 47.0 | **0** |
| 20 | 3/5涨 | 53.0 | +0.90 |
| 22 | 3/5涨 | 48.0 | **0** |
| 22 | 2/5涨 | 42.0 | **0** |
| 24 | 3/5涨 | 43.0 | **0** |

VIX 在 20-24 时（最常见区间），温度基本落在 35-55 的 dead zone 中。**实盘同样存在此问题**（Longbridge API返回的温度值也可能在此区间）。

### 影响量化

温度占 marketScore 的 ~10%，marketScore 占 finalScore 的 20%。
有效影响: ~10% × 20% = **2% of finalScore**。

单独看不大，但在阈值边缘（score ≈ threshold ± 2分）时，这2分决定了是否入场。

### 修复方案

改为连续贡献模型（消除 dead zone）:
```typescript
const tempDelta = temp - 50;
if (tempDelta !== 0) {
  const tempCoeff = Math.abs(tempDelta) > 15 ? 0.5 : 0.3;
  score += tempDelta * tempCoeff;
}
```

**新效果对比**:

| VIX | 5日涨跌 | temp | 旧贡献 | 新贡献 |
|-----|---------|------|--------|--------|
| 17 | 3/5涨 | 60.5 | +3.15 | +3.15 |
| 20 | 2/5涨 | 47.0 | 0 | -0.9 |
| 22 | 3/5涨 | 48.0 | 0 | -0.6 |
| 15 | 4/5涨 | 71.5 | +6.45 | +10.75 |
| 30 | 1/5跌 | 16.0 | -2.0 | -17.0 |

极端值影响增大（VIX=30 从-2变-17），但受 `Math.max(-100, Math.min(100, score))` 总分限制保护。

**同步修改实盘和回测**（保持评分一致性）。

---

## 问题 3: 诊断日志缺 intradayScore 分量明细

### 现象

当前 `diagnosticLog.signals` 记录:
```
{ date, time, score, marketScore, intradayScore, direction, vixFactor, dynamicThreshold }
```

无法看到 intradayScore 的 5 个子分量（underlaying momentum 30%, VWAP 15%, SPX intraday 25%, BTC hourly 15%, USD hourly 15%）。对比实盘，`option-recommendation.service.ts:386` 返回完整的 `intradayComponents` 对象。

### 影响

intradayScore 占 finalScore 的 60%，是评分系统的核心。没有分量明细，无法判断：
- 哪个分量在驱动/压制评分
- 修复 SPX 粒度后效果是否符合预期
- 是否有其他分量异常

### 修复方案

1. 重构 `calculateIntradayScore` 返回 `{ score, components }` 结构（对齐实盘）
2. 扩展诊断信号结构，增加 `intradayComponents` 和 `timeWindowAdj`
3. 前端详情页用 `Table expandable` 展示子分量（不增加主表列数）

---

## 问题 4: 时间止损冗余且有害 — 回测+实盘同步禁用

### 现象

回测 #87 中，`time_stop_no_tailwind` 触发 13 笔退出，**胜率 0%**，贡献总亏损的 72%（-$3,384 / -$4,775）。

### 数据分析（回测 #87，21 笔交易）

**按退出类型统计：**

| 退出类型 | 笔数 | 盈利 | 亏损 | 总净PnL | 平均PnL% |
|---------|------|------|------|---------|----------|
| time_stop_no_tailwind | 13 | 0 | 13 | -$3,384 | -14.2% |
| trailing_stop | 3 | 2 | 1 | +$640 | +11.5% |
| take_profit | 3 | 3 | 0 | +$3,608 | +63.2% |
| 0dte_pnl_floor | 2 | 0 | 2 | -$1,391 | -35.4% |

**13 笔时间止损中 10 笔曾经盈利（peakPnLPercent > 0%）：**

| 交易 | 合约 | 持仓 | 出场PnL% | 峰值PnL% | 净PnL |
|------|------|------|----------|----------|-------|
| 2/19 #1 | QQQ C605 | 5min | -21.7% | +1.0% | -$413 |
| 2/20 #3 | QQQ C605 | 3min | -11.2% | +10.1% | -$231 |
| 2/20 #8 | SPY C690 | 5min | -12.2% | +6.1% | -$287 |
| 2/23 #14 | SPY P680 | 5min | -14.4% | +13.4% | -$319 |
| 2/24 #15 | QQQ C605 | 5min | -6.2% | +7.4% | -$136 |
| 2/24 #18 | SPY C685 | 8min | -17.0% | +8.5% | -$359 |

**典型案例 — 2/19 "低卖高买"：**

```
Trade#1: 09:55 入 $2.02 → 10:00 时间止损出 $1.58 (亏 -$413)
         合约 3 分钟内反弹 +53%
Trade#2: 10:03 入 $2.42 → 10:08 时间止损出 $1.96 (亏 -$384)
         一笔时间止损变成两笔亏损，合计 -$797
```

### 根因

时间止损在 0DTE 高 gamma 环境下窗口太短（T=3-5min），频繁在噪声中平掉方向正确的仓位。

设计前提"X 分钟无顺风 = 方向错误"在 0DTE 期权上不成立：
- 0DTE gamma 极高，3 分钟内 ±50% 波动是常态
- T=3min 只覆盖约半个波动周期，几乎保证在回调中被甩出
- 被甩出后（无冷却时）又追高入场，形成恶性循环

### 现有多重保障（移除时间止损后仍完整）

| 层级 | 机制 | 触发条件 |
|------|------|----------|
| 1 | 0DTE 兜底止损 | 亏损 ≥ 25% |
| 2 | 移动止损 | 盈利 ≥ 15% 后回撤 15% |
| 3 | 止盈目标 | 盈利达 40-50% |
| 4 | 收盘前强平 | 到期前 30 分钟 |

### 修复方案

**回测 + 实盘同步禁用时间止损**：不传 `timeStopMinutes` 给 `PositionContext`，`checkExitCondition` 中的 2.6 时间止损分支自然跳过（`ctx.timeStopMinutes` 为 undefined）。

保留 `option-dynamic-exit.service.ts` 中的时间止损代码不删除，仅通过不传参禁用，便于未来评估后可快速恢复。

**代码变更：**

| 文件 | 改动 |
|------|------|
| `option-backtest.service.ts` | 注释掉 timeStopMinutes 计算 + 传递 |
| `strategy-scheduler.service.ts` | 注释掉 timeStopMinutes 计算 + 传递 |

---

## 评分系统完整架构参考

```
finalScore = marketScore × 0.2 + intradayScore × 0.6 + timeAdj × 0.2
             ↓                    ↓                      ↓
             │                    │                      calculateTimeWindowAdjustment(etMin)
             │                    │                      9:30-10:00: +15
             │                    │                      10:00-10:30: +15→+5 (渐变)
             │                    │                      10:30-11:30: +5→0
             │                    │                      11:30-13:00: 0
             │                    │                      13:00-14:30: 0→-15
             │                    │                      14:30-15:30: -15→-50
             │                    │                      15:30+: -50
             │                    │
             │                    calculateIntradayScore(md)
             │                    ├─ underlying 1m momentum  × 0.30
             │                    ├─ VWAP position           × 0.15
             │                    ├─ SPX intraday momentum   × 0.25  ← [问题1: 粒度不匹配]
             │                    ├─ BTC hourly momentum     × 0.15
             │                    └─ USD hourly momentum     × 0.15 (inverted)
             │
             calculateMarketScore(md)
             ├─ SPX 20日趋势           × 0.4  (analyzeMarketTrend)
             ├─ USD 20日趋势 (反向)     × 0.2
             ├─ BTC 20日趋势           × 0.2/0.1 (依相关性)
             ├─ VIX 级别               (阶梯: +10/0/-20/-50)
             └─ 市场温度 (10%)          ← [问题2: dead zone 20-50]
                └─ estimateMarketTemperature(vix, spx)
                   temp = (100 - VIX×2.5) + (upDays-2.5)×6
```

---

## 修改文件清单

| 文件 | 改动内容 |
|------|----------|
| `api/src/services/option-backtest.service.ts` | SPX聚合小时K + 温度dead zone + 诊断分量返回 + 禁用时间止损 |
| `api/src/services/option-recommendation.service.ts` | 温度dead zone同步修复（实盘） |
| `api/src/services/strategy-scheduler.service.ts` | 禁用时间止损（实盘） |
| `frontend/app/quant/backtest/option/[id]/page.tsx` | 信号日志分量展开行 |

---

## 不在本次范围

| 项目 | 原因 |
|------|------|
| 权重调整 (0.2/0.6/0.2) | 先修复数据层面问题，用新诊断数据评估后再决定 |
| Longbridge历史温度API | `getHistoricalMarketTemperature()` 已存在但未测试，单独处理 |
| 实盘 timeWindowAdjustment 对齐 | 回测平滑曲线 vs 实盘阶梯属有意设计差异 |
| marketTemperature DB存储 | 需要设计每日采集cron + 历史回填，属独立任务 |

---

## 验证标准

1. TypeScript 编译通过（api + frontend）
2. 运行回测诊断日志验证:
   - `intradayComponents.spxIntraday` 数值在 ±0.5-2.0（不再是 ±0.02-0.05）
   - `marketScore` 在 VIX 18-24 时不再恒为 ~0（温度连续贡献）
   - 5 个子分量均有合理非零数值
3. 前端详情页信号表可展开查看子分量
4. 对比同一日期修复前后: 信号数量和入场时间应有合理变化（非剧烈）
