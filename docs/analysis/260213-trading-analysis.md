# 2026-02-13 交易深度分析报告

**报告生成时间**: 2026-02-15 (北京时间)

**交易日期**: 2026-02-13 (美东时间) / 2026-02-14 (北京时间)

**分析范围**: Commit `cde3b32` → `c13b441`（HEAD）代码差异 + 02-13 实盘数据 + 日志溯源

---

## 目录

1. [当日交易概览](#1-当日交易概览)
2. [开盘误判分析](#2-开盘误判分析)
3. [信号缺失分析](#3-信号缺失分析)
4. [代码差异对比](#4-代码差异对比)
5. [故障复盘 — 完整决策链路还原](#5-故障复盘--完整决策链路还原)
6. [改进结论](#6-改进结论)

---

## 1. 当日交易概览

### 1.1 订单汇总

| 维度 | 数据 |
|------|------|
| 订单总数 | 8 笔（4 买入 + 4 卖出） |
| 成交率 | 100%（全部 FilledStatus） |
| 取消/拒绝 | 0 |
| 交易方向 | 全部 **Put 期权**（BEAR_SPREAD 策略） |
| 策略来源 | 策略10（7000刀期权）自动下单 |
| 订单类型 | ELO（增强限价单） |

### 1.2 持仓明细与盈亏

| # | 合约 | 数量 | 买入价 | 卖出价 | 买入时间(ET) | 卖出时间(ET) | 持仓时长 | 盈亏(USD) |
|---|------|------|--------|--------|-------------|-------------|----------|-----------|
| 1 | QQQ 260213 595 Put | 1 | $2.35 | $1.27 | 09:41 | 09:45 | 4分钟 | **-$108.00** |
| 2 | NVDA 260213 182.5 Put | 2 | $1.33 | $0.55 | 09:41 | 09:46 | 5分钟 | **-$156.00** |
| 3 | TSLA 260213 410 Put | 1 | $2.76 | $1.45 | 09:41 | 10:18 | 37分钟 | **-$131.00** |
| 4 | IWM 260213 260 Put | 1 | $2.00 | $1.10 | 09:41 | 09:53 | 12分钟 | **-$90.00** |
| | **合计** | | | | | | | **-$485.00** |

### 1.3 与前一交易日对比

| 指标 | 02-12 | 02-13 | 变化 |
|------|-------|-------|------|
| 订单数 | 68 | 8 | -88.2% |
| 交易笔数 | 35 | 4 | -88.6% |
| 总盈亏 | +$639.00 | -$485.00 | -$1,124.00 |
| 胜率 | 57.1% | 0% | -57.1pp |
| 最长持仓 | 141 分钟 | 37 分钟 | 被止损截断 |

---

## 2. 开盘误判分析

### 2.1 开盘前 30 分钟得分走势

02-13 系统在开盘后第一个评估周期（09:30-10:00 ET）的市场得分记录如下：

| 美东时间 | 标的 | 最终得分 | 市场得分 | 日内得分 | 处理结果 |
|---------|------|---------|---------|---------|---------|
| 09:30:12 | SPY | -2.42 | -6.38 | -4.46 | `strategy_evaluation` 未达阈值 |
| 09:30:42 | QQQ | -2.13 | -6.20 | -4.06 | `strategy_evaluation` 未达阈值 |
| 09:30:55 | NVDA | -0.71 | -4.55 | -2.86 | `direction_confirm` 得分模糊 |
| 09:31:12 | QQQ | -1.60 | -5.56 | -3.64 | `strategy_evaluation` 未达阈值 |
| 09:31:25 | SPY | -1.22 | -4.83 | -3.62 | `direction_confirm` 得分-4.8 |
| 09:31:42 | NVDA | -1.52 | -5.15 | -3.89 | `strategy_evaluation` 未达阈值 |
| 09:35:12 | QQQ | -5.15 | -12.67 | -9.26 | `strategy_evaluation` |
| 09:35:42 | SPY | -4.87 | -13.36 | -8.81 | `strategy_evaluation` |
| **09:40:23** | **QQQ** | **-10.1** | — | — | **触发 BEAR_SPREAD 买入**（综合得分-10.1≤-10） |
| **09:40:57** | **MU** | **-11.2** | — | — | **触发 BEAR_SPREAD**（被资金拒绝） |
| **09:40:57** | **TSLA** | **-10.1** | — | — | **触发 BEAR_SPREAD 买入**（节流聚合6次） |
| **09:41:27** | **MU** | **-13.4** | — | — | **触发 BEAR_SPREAD**（被资金拒绝） |
| **09:41:27** | **SPY** | **-13.4** | — | — | **触发 BEAR_SPREAD**（被资金拒绝） |
| **09:42:11** | **SPY** | **-14.9** | — | — | **触发 BEAR_SPREAD**（被资金拒绝） |
| **09:43:02** | **SPY** | **-12.9** | — | — | **触发 BEAR_SPREAD**（被资金拒绝） |
| **09:43:02** | **MU** | **-14.2** | — | — | **触发 BEAR_SPREAD**（被资金拒绝） |

**得分从 09:30 的 -2.x 在 10 分钟内急剧恶化，系统在 09:40:23 首次达到综合得分≤-10 阈值，触发 BEAR_SPREAD 买入信号。09:40-09:44 期间持续产生信号（得分-10.1 至 -14.9），但多数被资金管理拦截。**

### 2.2 误判原因定位

#### 问题核心：**方向判断正确，但时机错误 — 市场先跌后涨，0DTE 衰减致命**

对比 `260212-trading-analysis.md` 中 02-12 的表现：

| 对比维度 | 02-12 | 02-13 |
|---------|-------|-------|
| 开盘方向 | 先 Call（误判→止损），后转 Put（正确） | 直接 Put（正确方向，但被反弹打止损） |
| 首笔交易时间 | 09:36 ET | 09:41 ET |
| 开盘信号强度 | 得分 -12.8（中等偏空） | 得分 -14.89（强烈偏空） |
| 0DTE 特性 | 部分标的用 0213 次日到期合约 | **全部 0DTE（0213 当日到期）** |
| 市场实际走势 | 开盘下跌 → 持续下跌 → 尾盘下跌 | 开盘下跌 → **快速反弹** → 上涨 |

#### 关键偏差点

**1. 0DTE 合约的 Gamma/Theta 风险被低估**

02-13 所有合约都是**当日到期**（0DTE），这意味着：
- Theta 衰减速度极快（每分钟都在失去时间价值）
- Gamma 极高，价格波动剧烈
- 市场稍有反弹，Put 权利金就可能腰斩

02-12 的 TSLA/NVDA 使用的是**次日到期合约**（0213），时间价值衰减较慢，有更多的缓冲空间。但 02-13 **全部是当日到期**，留给策略的容错时间几乎为零。

**2. 开盘首 10 分钟得分急剧恶化 → 过早触发信号**

代码逻辑中 `direction_confirm` 窗口（开盘 30 分钟内只允许方向明确的交易）：

```
09:30-09:31: 得分在 -2 ~ -5 之间 → 被 direction_confirm 阻止（得分模糊）
09:35: 得分下滑到 -5 ~ -13 → 被 strategy_evaluation 阻止（未达 -10 阈值）
09:40: 得分突破 -14 → 触发 BEAR_SPREAD（综合得分 ≤ -10 满足条件）
```

**问题**：09:40 时虽然得分看起来很强，但这是基于开盘 10 分钟内的短期数据。开盘数据噪声大，9:40 的"强烈看空"信号可能只是**开盘波动放大**的结果，而非可靠趋势。

**3. `direction_confirm` 在得分 -5 以下时放行，但此时市场仍在震荡**

当前代码逻辑（`option-intraday-strategy.ts`）：
- `marketScore` 在 -5 到 +5 之间 → 阻止交易（方向不明确）
- `marketScore` < -5 → 允许 Put 方向交易

实际情况：02-13 开盘 marketScore 在 09:35 已经低于 -5，但市场此时尚未形成稳定趋势。**-5 的阈值过于宽松，容易在开盘波动期被误触发。**

### 2.3 PnL 衰减轨迹

以 QQQ 260213 595 Put 为例（持仓仅 4 分钟即触发止损）：

```
09:41  入场 $2.35
09:41  $2.91 (+23.8%)  ← 短暂盈利
09:42  $2.68 (+14.0%)  ← 开始回落
09:43  $2.05 (-12.8%)  ← 快速亏损
09:43  $1.73 (-26.4%)  ← 加速下跌
09:44  $1.65 (-29.8%)  ← 接近止损线
09:44  $1.35 (-42.6%)  ← 触发硬止损（40%安全阀）
09:45  以 $1.27 成交  ← 最终亏损 -$108
```

**从盈利 +23.8% 到亏损 -42.6%，仅用了 3 分钟。** 这是 0DTE 期权的典型 Gamma 风险 — 市场稍有反弹，Put 价格就指数级衰减。

---

## 3. 信号缺失分析

### 3.1 当日信号统计

02-13 全天（美东时间 09:30-16:00）系统的信号决策分布：

| 决策结果 | 次数 | 占比 | 检查点 |
|---------|------|------|--------|
| NO_SIGNAL — 非交易时间 | 645 | 61.2% | `trade_window` |
| NO_SIGNAL — 超过首小时 | 293 | 27.8% | `trade_window` |
| NO_SIGNAL — 策略条件未满足 | 103 | 9.8% | `strategy_evaluation` |
| NO_SIGNAL — 方向确认阻止 | 13 | 1.2% | `direction_confirm` |
| **BUY 信号** | **~7** | **<1%** | 09:40-09:43 集中触发 |

### 3.2 信号缺失的具体原因

**关键发现：02-13 只在 09:40-09:43 这 3 分钟窗口内产生了信号，之后全天无新信号。**

原因链路：

```
09:40-09:43 → 产生 7 个 BEAR_SPREAD 信号（4 个成交，3 个因资金不足被拒）
09:43 之后  → 无新信号
```

#### A. `firstHourOnly` 限制

当前策略配置 `tradeWindow.firstHourOnly: true`，意味着只在**开盘首小时**（09:30-10:30 ET）允许开新仓。09:40 的信号被执行后，策略进入持仓监控模式。09:45-09:53 所有仓位被止损平仓后，系统应该在首小时内继续寻找新入场机会，但日志显示：

- 09:45-10:30 期间所有评估结果为 `NO_SIGNAL - strategy_evaluation`
- **原因**：止损后市场反弹，得分从 -14.9 回升到 -5 ~ -8 之间，未再达到 BEAR_SPREAD 触发阈值（≤ -10）

**结论**：市场在 09:43-09:45 快速反弹后，看空信号强度不够，且做多信号也不满足 BULL_SPREAD 触发条件（得分 ≥ +10），系统处于"得分中间地带"，合理地未触发新信号。

#### B. 被拒绝的信号（资金限制）

| 时间 | 标的 | 请求金额 | 资金上限 | 拒绝原因 |
|------|------|---------|---------|---------|
| 09:40 | SPY.US | $435.63 | $333.33 | 超过单标的上限 |
| 09:40 | MU.US | $685.63 | $262.91 | 超过单标的上限（MU 权利金太贵） |
| 09:41 | MU.US | $500.63 | $229.24 | 同上 |

**MU 和 SPY 的信号被资金管理正确拦截。** 这与 02-12 的分析结论一致 — MU 权利金 $5-$10/张在当前资金规模下永远无法开仓。

#### C. 0DTE 截止时间影响

02-13 **没有**因为 0DTE 截止时间导致信号被拦截。所有仓位在 10:18 ET 之前就已全部止损平仓，远在 0DTE 截止时间（13:00 ET / 180 分钟截止）之前。

#### D. IV / Delta / 流动性过滤

日志中**未发现**因 IV 限制、Delta 阈值或流动性过滤导致合约被跳过的记录。所有 4 个合约选择过程顺利完成。

### 3.3 Commit `cde3b32` 版本逻辑 Bug 排查

对比 `cde3b32`（旧版）与 `c13b441`（新版）的差异，排查是否存在信号拦截 Bug：

| 排查项 | `cde3b32`（旧版） | `c13b441`（新版） | 是否存在 Bug |
|-------|-------------------|-------------------|------------|
| direction_confirm 窗口 | **不存在** | 新增（开盘30分钟） | ⚠️ 新版可能过早放行 |
| 0DTE 截止时间 | 210 分钟 | 180 分钟 | 无Bug，新版更宽松 |
| 资金排除逻辑 | **不存在** | 新增 `getEffectiveSymbolPool` | 无Bug，新增保护 |
| LATE 冷却期 | **不存在** | 新增（3分钟） | 不影响02-13（无LATE交易）|
| grossPnL vs netPnL | 使用 netPnL | 改为 grossPnL | 旧版有NaN风险 |
| 配置深度合并 | 浅合并（可能丢失嵌套默认值） | 深度合并 | 旧版有配置丢失Bug |

**结论**：`cde3b32` 版本存在以下可能影响 02-13 的 Bug：

1. **配置浅合并 Bug**（已在 `c13b441` 修复）：旧版 `{ ...DEFAULT, ...config }` 浅合并会丢失嵌套对象的默认值。如果用户只配置了 `exitRules.takeProfitPercent` 而未配置 `stopLossPercent`，止损值可能变为 `undefined`，导致止损逻辑异常。
2. **netPnL 为 NaN Bug**（已修复）：旧版使用 `netPnLPercent` 计算止盈止损，但 T+1 结算环境下手续费字段可能为空，导致 NaN 比较。NaN 与任何数字比较都为 `false`，**可能导致止盈/止损永远不触发**，或在硬安全阀（40%）才被捕获。

---

## 4. 代码差异对比

### 4.1 版本信息

| 版本 | Commit | 描述 |
|------|--------|------|
| 旧版 | `cde3b32` | docs: 更新文档 — Vercel 主代理 + CF 备选三级 fallback |
| 新版 | `c13b441` (HEAD) | fix: 交易策略优化9项 |
| 中间提交 | `a14e057`, `fe74abb` | 前端布局优化、NAS 缓存清理（与交易逻辑无关） |

### 4.2 信号触发模块差异

#### `api/src/services/strategies/option-intraday-strategy.ts`（+122 行）

| 改动项 | 旧版行为 | 新版行为 | 影响 |
|--------|---------|---------|------|
| 配置合并 | `{ ...DEFAULT, ...config }`（浅合并） | 逐层展开嵌套对象深度合并 | 修复嵌套配置丢失 |
| 方向确认窗口 | **无** | 开盘30分钟内检查 `marketScore`：-5~+5 阻止，<-5 只允许 Put | 减少开盘误判 |
| LATE 时段增强 | **无** | `isLatePeriod()` + 入场阈值提升 10% + 冷却期 3 分钟 | 减少尾盘过度交易 |
| 0DTE 截止时间 | 210 分钟（12:30 ET） | 180 分钟（13:00 ET） | 延长可交易窗口 30 分钟 |
| 截止时间传递 | 硬编码 | 通过 `noNewEntryBeforeCloseMinutes` 传入合约选择器 | 可配置化 |

#### `api/src/services/strategy-scheduler.service.ts`（+117 行）

| 改动项 | 旧版行为 | 新版行为 | 影响 |
|--------|---------|---------|------|
| 资金标的过滤 | **无** | `capitalManager.getEffectiveSymbolPool()` 排除资金不足标的 | 避免无效信号评估 |
| 资金自动重置 | **无** | 全部平仓后 `resetUsedAmount(strategyId)` | 修复资金漂移 |
| LATE 冷却期 | **无** | 退出后 3 分钟冷却 | 减少尾盘频繁进出 |
| 监控盈亏指标 | `netPnLPercent` | `grossPnLPercent` | 修复 NaN 问题 |
| 0DTE 截止默认值 | 60 分钟 | 180 分钟 | 统一截止时间 |

### 4.3 订单执行模块差异

#### `api/src/services/option-dynamic-exit.service.ts`（+46 行）

| 改动项 | 旧版行为 | 新版行为 | 影响 |
|--------|---------|---------|------|
| PnL 计算基准 | `netPnLPercent`（含手续费） | `grossPnLPercent`（不含手续费） | **核心修复**：避免 NaN 导致止盈止损失效 |
| 0DTE 强制平仓 | 210 分钟截止 | 180 分钟截止 | 延长持仓窗口 |
| 日志标签 | "净盈亏" / "净亏损" | "盈亏" / "亏损" | 与指标一致 |

#### `api/src/services/options-contract-selector.service.ts`（+25 行）

| 改动项 | 旧版行为 | 新版行为 | 影响 |
|--------|---------|---------|------|
| 截止时间参数 | 硬编码 210 分钟 | 接受 `noNewEntryBeforeCloseMinutes` 参数（默认 180） | 可配置 |
| `is0DTEBuyBlocked()` | 固定阈值 | 参数化阈值 | 灵活性提升 |

#### `api/src/services/capital-manager.service.ts`（+95 行）

| 新增方法 | 功能 | 影响 |
|---------|------|------|
| `getEffectiveSymbolPool()` | 按资金过滤可交易标的（最低 $300/标的） | 提前排除资金不足标的 |
| `resetUsedAmount()` | 全部平仓后重置 `current_usage` 为 0 | 修复资金漂移累积 |

#### `api/src/services/market-data.service.ts`（+28 行）

| 改动项 | 旧版行为 | 新版行为 | 影响 |
|--------|---------|---------|------|
| 温度 API 失败 | 直接返回错误 | 5 分钟缓存 → 15 分钟过期缓存 → null 三级降级 | 减少 API 抖动影响 |

### 4.4 `basic-execution.service.ts` / `trading-recommendation.service.ts`

**这两个核心文件在两个版本之间没有任何改动。** 订单执行和推荐算法逻辑保持不变。

---

## 5. 故障复盘 — 完整决策链路还原

### 时间线（全部为美东时间 ET / UTC-5）

```
═══════════════════════════════════════════════════════════════════════
 02-13 决策链路完整还原
═══════════════════════════════════════════════════════════════════════

[09:30:00] 📍 美股开盘
           ├── 策略10启动评估周期（每5秒一次）
           ├── 6个标的: SPY, QQQ, NVDA, TSLA, IWM, MU
           └── 策略类型: BEAR_SPREAD + BULL_SPREAD

[09:30:12] 📊 首次评估
           ├── SPY: final=-2.42, market=-6.38 → strategy_evaluation（未达-10阈值）
           ├── QQQ: final=-2.13, market=-6.20 → strategy_evaluation
           └── NVDA: final=-0.71, market=-4.55 → direction_confirm（得分模糊）
           ※ 方向确认窗口生效：marketScore 在 -5~+5 之间，阻止交易

[09:31:25] 📊 第二轮评估
           ├── SPY: final=-1.22, market=-4.83 → direction_confirm 阻止
           ├── QQQ: final=-1.60, market=-5.56 → strategy_evaluation
           └── 市场得分在 -4 到 -6 之间震荡

[09:35:12] 📊 得分加速恶化
           ├── QQQ: final=-5.15, market=-12.67 → strategy_evaluation
           ├── SPY: final=-4.87, market=-13.36 → strategy_evaluation
           └── 最终得分仍在 -5 左右（marketScore 已 <-10 但 final 未达标）

[09:40:24] 🔴 触发 BEAR_SPREAD 买入信号！
           ├── QQQ: final=-5.43, market=-14.89 → 综合得分 ≤ -10 ✅
           ├── 信号生成: BEAR_SPREAD / PUT 方向
           └── 开始下单流程

[09:41:08] 📋 资金校正
           ├── ⚠️ 严重差异告警: 记录=$987.51, 实际=$253.23, 差=$734.28
           ├── 自动校正为实际值 $253.23
           └── 可用资金: $1,375.45（账户实际）

[09:41:08-40] 📋 订单提交（4笔成功，3笔被拒）
           ├── ✅ QQQ 260213 595 Put × 1  → 成交 $2.35
           ├── ✅ NVDA 260213 182.5 Put × 2  → 成交 $1.33
           ├── ✅ TSLA 260213 410 Put × 1  → 成交 $2.76
           ├── ✅ IWM 260213 260 Put × 1  → 成交 $2.00
           ├── ❌ SPY  → 超单标的上限 $333.33
           ├── ❌ MU   → 超单标的上限 $262.91（权利金$6.85太贵）
           └── ❌ MU   → 再次尝试仍被拒

[09:41:29] 📈 持仓初始状态 — 短暂盈利
           ├── QQQ Put:  $2.91 (+23.8%) ← 市场仍在下跌
           ├── NVDA Put: $1.72 (+29.3%)
           ├── TSLA Put: $3.20 (+15.9%)
           └── IWM Put:  $2.18 (+9.0%)
           ※ 此刻全部持仓浮盈，看似方向正确

[09:42:19] ⚠️ 市场开始反弹！
           ├── QQQ Put:  $2.68 (+14.0%) ← 盈利缩水
           ├── NVDA Put: $1.38 (+3.8%)
           ├── IWM Put:  $2.31 (+15.5%) ← IWM 暂时抗跌
           └── TSLA Put: 仍持有

[09:43:09] 📉 Put 价格加速崩塌（0DTE Gamma 效应）
           ├── QQQ Put:  $2.05 (-12.8%)
           ├── NVDA Put: $0.88 (-33.8%)
           ├── IWM Put:  $1.67 (-16.5%)
           └── 市场反弹加速，0DTE Put 时间价值快速蒸发

[09:44:48] 🛑 硬安全阀触发（40%止损）
           ├── QQQ Put: $1.35 (-42.6%) → 触发硬止损！
           └── NVDA Put: $0.63 (-52.6%) → 触发硬止损！

[09:45:03] 📋 QQQ 止损平仓
           └── 卖出 QQQ 260213 595 Put × 1 @ $1.27 → 亏损 -$108.00

[09:45:43] 📋 NVDA 止损平仓
           └── 卖出 NVDA 260213 182.5 Put × 2 @ $0.55 → 亏损 -$156.00

[09:52:48] 📋 IWM 止损平仓
           ├── IWM Put: $1.23 (-38.2%) → 止损触发
           └── 卖出 IWM 260213 260 Put × 1 @ $1.10 → 亏损 -$90.00

[10:18:00] 📋 TSLA 最后止损
           ├── TSLA Put: $1.50 (-45.4%) → 止损触发
           └── 卖出 TSLA 260213 410 Put × 1 @ $1.45 → 亏损 -$131.00

[10:18+]   🔇 全部仓位已平，无新信号
           ├── 原因1: firstHourOnly 仍在生效，但市场反弹后得分回到 -5~-8
           ├── 原因2: BEAR_SPREAD 阈值 ≤ -10 未满足
           ├── 原因3: BULL_SPREAD 阈值 ≥ +10 也未满足
           └── 系统处于得分中间地带，合理静默

[10:30+]   ⏹️ 首小时交易窗口关闭
           └── 之后 293 次评估均被 trade_window 阻止

[15:01-15:11] ⚠️ 资金差异告警
           ├── 记录值 $249.76 vs 实际值 $2.76
           └── 收盘后资金同步延迟（已知问题）

═══════════════════════════════════════════════════════════════════════
 当日最终结果: 4 笔交易，全部止损，总亏损 -$485.00
═══════════════════════════════════════════════════════════════════════
```

### 核心故障归因

| # | 故障 | 根因 | 严重度 |
|---|------|------|--------|
| 1 | 开盘 Put 方向判断后被快速止损 | 0DTE 期权 Gamma 风险 + 市场快速反弹 | ★★★★★ |
| 2 | 得分 -14.89 触发后市场立即反转 | 开盘数据噪声大，短期极端得分不可靠 | ★★★★☆ |
| 3 | 止损后全天无新信号 | firstHourOnly + 得分未再达阈值（合理行为） | ★★☆☆☆ |
| 4 | 资金差异 $734（自动校正） | 旧版资金漂移累积 | ★★★☆☆ |
| 5 | 市场温度 API 间歇失败 | Longbridge API 不稳定 | ★★☆☆☆ |

---

## 6. 改进结论

### 6.1 `c13b441` 已解决的问题

| # | 02-12 报告中的改进建议 | 是否在新版解决 | 实现方式 |
|---|----------------------|--------------|---------|
| 1 | 开盘方向确认窗口 | ✅ 已解决 | `directionConfirmMinutes: 30`，阻止模糊方向交易 |
| 2 | 尾盘过度交易 | ✅ 已解决 | LATE 冷却期（3分钟）+ 入场阈值提升 10% |
| 3 | 净盈亏 NaN | ✅ 已解决 | 全面改用 `grossPnLPercent` |
| 4 | 资金差异警告 | ✅ 已解决 | `resetUsedAmount()` 全平仓后自动归零 |
| 5 | MU 始终被拒 | ✅ 部分解决 | `getEffectiveSymbolPool()` 自动排除资金不足标的 |

### 6.2 02-13 暴露的新问题（未解决）

#### 问题 1：0DTE 开盘期的 Gamma 风险未被纳入决策

**现状**：策略在判断是否买入 0DTE 期权时，只考虑市场方向得分，未评估 0DTE 特有的 Gamma/Theta 风险。

**建议**：
- 增加 **0DTE 开盘冷却期**（建议 09:30-10:00 不开 0DTE 新仓，使用次日到期合约替代）
- 或者在开盘 30 分钟内，对 0DTE 合约使用**更严格的止损参数**（如 20% 而非 35%）
- 增加 0DTE 合约的**最低入场得分阈值**（如 ≤ -15 而非 ≤ -10）

```typescript
// 建议新增逻辑
if (is0DTE && isWithin30MinOfOpen) {
  const adjustedThreshold = baseThreshold * 1.5; // -10 → -15
  if (score > adjustedThreshold) {
    return NO_SIGNAL; // 0DTE开盘期需要更强信号
  }
}
```

#### 问题 2：`direction_confirm` 阈值 -5 在高波动开盘期过于宽松

**现状**：`marketScore` < -5 即允许 Put 交易，但开盘 10 分钟内的得分波动极大，-5 很容易被短期噪声突破。

**建议**：
- 开盘首 10 分钟使用更严格阈值（如 -8 而非 -5）
- 或增加**得分稳定性确认**：要求连续 2-3 个评估周期得分方向一致

```typescript
// 建议新增逻辑
if (isWithin10MinOfOpen && Math.abs(marketScore) < 8) {
  return { reject: true, checkpoint: 'direction_confirm_strict' };
}
```

#### 问题 3：止损后的再入场策略过于保守

**现状**：止损后如果在首小时内，系统会继续评估信号，但阈值不变（仍为 ≤ -10）。止损意味着方向可能已错，此时应该：
- 要么**提高再入场阈值**（如 ≤ -15）表示需要更强确认
- 要么**切换方向**（从 Put 转 Call）如果市场反弹信号明确

**建议**：
- 增加止损后**方向翻转检测**逻辑
- 止损后 5 分钟内不允许同方向再入场

#### 问题 4：`firstHourOnly` 过于严格

**现状**：策略只在首小时（09:30-10:30）开新仓。02-13 的 Put 在 09:45 止损后，到 10:30 窗口关闭前得分未再达标，导致全天只有 4 笔交易。

**建议**：考虑在特定条件下放宽首小时限制：
- 如果首小时内全部止损且剩余资金充足，允许延长到 11:00 ET
- 或在午盘（12:00-13:00）增加第二个交易窗口（得分阈值更严格）

#### 问题 5：资金差异仍在发生（轻微）

02-13 的 15:01 仍有资金差异告警（$249.76 vs $2.76），但已从 02-12 的 ~$700 降低到 ~$247。新版的 `resetUsedAmount()` 在全部平仓后才触发，平仓过程中仍可能累积差异。

**建议**：每次单笔平仓后即做一次差异检查和校正，而非等全部平仓。

---

## 附录 A：02-13 错误日志汇总

| 时间(ET) | 级别 | 内容 | 影响 |
|---------|------|------|------|
| 09:40:25 | ERROR | 价格验证失败 IWM260213P257000.US — $0.78 vs 市场$0.73（偏差6.85%） | 该合约被跳过，无影响 |
| 09:41:08 | ERROR | 资金严重差异 — 记录$987.51 vs 实际$253.23（差$734.28，36.71%） | 已自动校正 |
| 09:41:13 | ERROR | 计算可用持仓失败 QQQ.US — GenericFailure | 短暂竞态，未影响交易 |
| 09:44:48 | ERROR | 计算可用持仓失败 QQQ260213P595000.US | 止损前的持仓查询失败 |
| 09:45:29 | ERROR | 计算可用持仓失败 NVDA260213P182500.US | 同上 |
| 09:52:08 | ERROR | 计算可用持仓失败 IWM260213P260000.US | 同上 |
| 09:54:03 | ERROR | 市场温度 API 调用失败 — Longbridge SendRequest | 已有缓存降级 |
| 10:07:18 | ERROR | 市场温度 API 调用失败 | 同上 |
| 10:09:48 | ERROR | 市场温度 API 调用失败 | 同上 |
| 10:17:43 | ERROR | 计算可用持仓失败 TSLA260213P410000.US | 止损前持仓查询失败 |
| 10:20:28 | ERROR | 市场温度 API 调用失败 | 同上 |

## 附录 B2：止损触发精确日志

```
[14:45:03 UTC] QQQ260213P595000.US: STOP_LOSS 强制止损 — 亏损-44.4%超过安全阈值40%
  净盈亏=$-107.64 (-45.5%), 手续费=$2.64, 保本价=$2.38, 当前价=$1.30

[14:45:43 UTC] NVDA260213P182500.US: STOP_LOSS 强制止损 — 亏损-57.5%超过安全阈值40%
  净盈亏=$-157.88 (-58.9%), 手续费=$3.88, 保本价=$1.35, 当前价=$0.56

[14:52:48 UTC] IWM260213P260000.US: STOP_LOSS 强制止损 — 亏损-43.7%超过安全阈值40%
  净盈亏=$-90.64 (-45.0%), 手续费=$2.64, 保本价=$2.03, 当前价=$1.12

[15:17:58 UTC] TSLA260213P410000.US: STOP_LOSS 强制止损 — 亏损-45.4%超过安全阈值40%
  净盈亏=$-128.64 (-46.4%), 手续费=$2.64, 保本价=$2.79, 当前价=$1.50
```

**注意**: 所有止损均超过了配置的 35% 阈值直接触发了 40% 硬安全阀。这说明在 0DTE 期权上，价格变动速度可能超过 5 秒检测周期，导致实际止损点位偏离目标。

## 附录 B：02-12 vs 02-13 策略参数对比

| 参数 | 02-12（旧版 cde3b32） | 02-13（新版 c13b441） |
|------|----------------------|----------------------|
| 方向确认窗口 | 无 | 30 分钟（marketScore ≤ -5 放行 Put） |
| BEAR_SPREAD 阈值 | ≤ -10 | ≤ -10（未变） |
| 0DTE 截止时间 | 收盘前 210 分钟 | 收盘前 180 分钟 |
| 止盈（EARLY） | 50% | 50% |
| 止损（EARLY） | 35% | 35% |
| PnL 计算 | netPnLPercent（可能 NaN） | grossPnLPercent |
| 硬安全阀 | 40% | 40% |
| LATE 冷却期 | 无 | 3 分钟 |
| 资金标的过滤 | 无 | 最低 $300/标的 |
| 资金自动重置 | 无 | 全平仓后归零 |
| 温度 API 降级 | 无 | 5 分钟缓存 → 15 分钟过期缓存 → null |

---

## 第二部分：深度验证与补充分析

> 以下内容基于代码溯源、1 分钟 K 线数据、持仓监控日志，对第一部分结论进行证实/证伪。

---

## 7. 标的现货路径与关键时刻

### 7.1 SPY.US 1 分钟 K 线（09:30-10:10 ET）

| 时间(ET) | Open | High | Low | Close | 成交量 | 阶段标注 |
|---------|------|------|-----|-------|--------|---------|
| 09:30 | 681.69 | 681.75 | 680.83 | 681.72 | 424K | 开盘微跌 |
| 09:31 | 681.72 | 682.25 | 681.20 | 682.07 | 270K | 反弹 |
| 09:32 | 681.98 | 682.50 | 681.71 | 682.08 | 333K | **日内高点 682.50** |
| 09:33 | 682.08 | 682.26 | 681.25 | 681.36 | 323K | 开始回落 |
| 09:34 | 681.36 | 682.00 | 681.14 | 681.18 | 265K | 继续下跌 |
| 09:35 | 681.22 | 681.23 | **680.39** | 681.06 | 347K | **破开盘低点** |
| 09:36 | 681.07 | 681.24 | 680.58 | 680.93 | 281K | 弱势延续 |
| 09:37 | 680.88 | 681.07 | **680.01** | 680.04 | 188K | **加速下跌** |
| 09:38 | 680.06 | 680.71 | 680.00 | 680.67 | 196K | 企稳反弹 |
| 09:39 | 680.66 | 680.74 | 679.78 | 679.85 | 208K | 再次下破 |
| **09:40** | **679.83** | **679.94** | **678.74** | **678.76** | **301K** | **⚡ 系统触发信号时刻，日内低点区域** |
| **09:41** | **678.76** | **679.29** | **678.06** | **678.20** | **280K** | **📋 订单成交，触及日内最低 678.06** |
| 09:42 | 678.19 | 678.27 | **677.52** | 678.22 | 281K | **绝对低点 677.52，开始反转** |
| **09:43** | **678.22** | **679.89** | **678.22** | **679.75** | **357K** | **🔄 V 型反转！1 分钟涨 $1.53** |
| 09:44 | 679.75 | 680.54 | 679.33 | 680.46 | 255K | 加速反弹 |
| **09:45** | **680.47** | **682.09** | **680.41** | **682.06** | **434K** | **🚀 完全收复失地，回到开盘价** |
| 09:46 | 682.06 | 682.45 | 681.57 | 682.21 | 446K | 继续上行 |
| 09:47 | 682.17 | 682.40 | 681.53 | 682.27 | 243K | 高位整理 |

**关键结论**：

```
SPY 价格路径：
  开盘 681.69 → 高点 682.50 (09:32) → 低点 677.52 (09:42) → 回到 682.06 (09:45)
  下跌幅度: -4.98 点 (-0.73%)  | 跌 12 分钟
  反弹幅度: +4.54 点 (+0.67%)  | 涨 3 分钟（09:42→09:45）

  系统在 09:40 触发信号时 SPY = 678.76，距离底部 677.52 仅差 1.24 点
  系统下单成交时（09:41）SPY = 678.20，距离底部仅差 0.68 点
  ⚠️ 入场时机恰好在绝对底部附近 → 此后 3 分钟 V 型反转
```

**验证结论**："先跌后涨、快速反弹"叙述 **完全证实**。SPY 从 09:42 低点到 09:45 回到开盘价，只用了 **3 分钟**。反弹不是渐进的，而是典型的 V 型反转，符合开盘做空被轧空（short squeeze）的特征。

### 7.2 反弹强度与结构分析

| 指标 | 数值 | 含义 |
|------|------|------|
| 开盘缺口 | SPY 开盘 681.69 vs 前收 ~682.x | 小幅低开，无显著缺口 |
| 09:32 高→09:42 低 | -4.98 点 / 12 分钟 | 开盘卖压释放 |
| 09:42 低→09:45 高 | +4.54 点 / **3 分钟** | 极速反弹（1.51 点/分钟） |
| 09:43 单根 K 线 | Low 678.22 → High 679.89 | **单分钟涨 1.67 点，放量 357K** |
| 09:45 成交量 | 434K（全天最高分钟量之一） | 典型的空头回补放量 |
| VWAP 关系 | 09:42 价格跌破 VWAP → 09:45 收回 | 未形成 VWAP 以下的趋势 |

---

## 8. 综合得分构成拆解

### 8.1 评分体系架构

系统使用 `OptionRecommendationService` 为期权交易生成评分，最终公式：

```
finalScore = marketScore × 0.5 + intradayScore × 0.5 + timeWindowAdjustment × 0.15
```

**决策阈值**（option-intraday-strategy.ts）：
- BEAR_SPREAD 触发：综合得分 ≤ -10
- BULL_SPREAD 触发：综合得分 ≥ +10
- DIRECTIONAL_CALL/PUT 触发：综合得分 > ±30

### 8.2 marketScore 子因子分解（权重总和 = 100%）

| 子因子 | 权重 | 数据源 | 计算方式 | 得分范围 |
|--------|------|--------|---------|---------|
| **SPX 当日涨跌** | **35%** | SPX K 线 (open→close) | `((close-open)/open) × 100 × 35` | [-100, 100] |
| SPX 多日趋势强度 | 15% | SPX 20日 MA5/10/20 偏离 + 排列奖励 | 完美空排 -25，强空排 -15 | [-100, 100] |
| USD 指数（反向） | 15% | USD 日线 | `-usdTrendStrength × 0.15` | [-100, 100] |
| BTC 支撑/阻力 | 15% | BTC 日线（条件权重） | 共振时 ×0.15，否则 ×0.08 | [-100, 100] |
| VIX 恐慌指数 | 10% | LongPort VIX | >35: -50, >25: -20, <15: +10 | [-50, 10] |
| 市场温度 | 10% | LongPort API | `((temp-50)/50) × 30` | [-30, 30] |

### 8.3 intradayScore 子因子分解（权重总和 = 100%）

| 子因子 | 权重 | 数据源 | 计算方式 | 得分范围 |
|--------|------|--------|---------|---------|
| **SPX 日K实体强度** | **40%** | SPX 当日 K 线 | `bodyStrength × amplifier × 25`，amplifier=max(1, range/0.5) | [-100, 100] |
| BTC 时均线动量 | 30% | BTC 小时K线 | `totalChange × 3000 × consistencyMultiplier` | [-100, 100] |
| USD 时均线动量（反向） | 15% | USD 小时K线 | `-usdMomentum × 0.15` | [-100, 100] |
| SPX 3日趋势一致性 | 15% | 近 3 根日K | `totalChange × 100 × 15` | [-100, 100] |

### 8.4 timeWindowAdjustment（直接加/减分）

| 时间段(ET) | 调整分 | 含义 |
|-----------|--------|------|
| 09:30-10:30 | **+20** | 开盘首小时（最佳窗口） |
| 10:30+ | -10 | 正常衰减 |
| 14:30-15:00 | -30 | 加速 Theta 衰减 |
| 15:00-15:30 | -50 | 极速 Theta 衰减 |

### 8.5 09:30→09:40 得分变化归因

以 QQQ 09:40:23 触发信号时刻为例，逆推各因子贡献：

| 因子 | 09:30 估算 | 09:40 估算 | 变化量 | 推断 |
|------|-----------|-----------|--------|------|
| SPX 当日涨跌（35%） | ~-3 | ~-12 | **-9** | SPY 从 681.7 跌到 678.8，跌幅 -0.43% → `0.43 × 35 ≈ -15` 权重后 ~-5.3 |
| SPX 趋势排列（15%） | ~-2 | ~-4 | -2 | 均线结构未大幅变化，影响有限 |
| SPX 日K 实体（40%日内） | ~-1 | ~-8 | **-7** | 日K 实体从 0 快速变为大阴线，amplifier 放大 |
| BTC 动量（30%日内） | ~-1 | ~-3 | -2 | BTC 小时联动跟跌 |
| 时间窗口调整 | +3 | +3 | 0 | 同为开盘首小时 +20 × 0.15 |
| **合计 finalScore** | **~-2** | **~-10.1** | **-8.1** | **SPX 当日涨跌（35%权重）是"打穿"阈值的主因** |

**结论**：**SPX 当日涨跌因子（35%权重 × 放大系数）是将得分从 -2 推到 -10 的单一主因。** 09:30-09:40 SPY 下跌 0.43%，经过 `× 100 × 35` 的放大，贡献了约 -15 分（权重后 ~-5 到 -7 分），占总分变化的 60-70%。

> ⚠️ **风险点**：SPX 当日涨跌因子使用实时 open→current 计算，开盘 10 分钟内的短期波动被全额放大。0.43% 的下跌在成熟趋势中是微不足道的，但在评分系统中被放大到足以触发 BEAR_SPREAD 的水平。

---

## 9. direction_confirm 实现细节

### 9.1 时区处理

代码位置：`option-intraday-strategy.ts:487-502`

```typescript
const etFormatterConfirm = new Intl.DateTimeFormat('en-US', {
  timeZone: 'America/New_York',  // ET 时区
  hour: 'numeric',
  minute: 'numeric',
  hour12: false,
});
const marketOpenMinutes = 9 * 60 + 30; // 9:30 ET 硬编码
const minutesSinceOpen = etMinutesConfirm - marketOpenMinutes;
const isInDirectionConfirmWindow = minutesSinceOpen >= 0
                                   && minutesSinceOpen < directionConfirmMinutes;
```

| 项目 | 实现方式 |
|------|---------|
| 时区 | `America/New_York`（ET），通过 `Intl.DateTimeFormat` |
| 夏令时(DST) | **自动处理** — `Intl` API 内置 DST 转换 |
| 交易所日历 | **未检查** — 不判断是否为交易日/半日，仅按 09:30 固定 |
| 窗口起点 | 09:30 ET 硬编码 |
| 窗口长度 | `directionConfirmMinutes`（默认 30，可配置） |

### 9.2 -5 阈值的精确行为

代码位置：`option-intraday-strategy.ts:536`

```typescript
const marketScore = optionRec.marketScore;  // 原始值，无平滑
if (marketScore > -5 && marketScore < 5) {
    // 趋势不明确 → 不开仓
    return null;
}
const allowedDirection = marketScore > 0 ? 'BULLISH' : 'BEARISH';
```

| 特性 | 说明 |
|------|------|
| **阈值** | -5 和 +5（硬编码，不可配置） |
| **使用的值** | `optionRec.marketScore`（原始值，**非平滑/非均值**） |
| **判断逻辑** | `(-5, +5)` 开区间 → 阻止；`≤ -5` 或 `≥ +5` → 放行对应方向 |
| **应用范围** | 仅在 `isInDirectionConfirmWindow = true` 时生效 |
| **02-13 实测** | 09:30:12 marketScore=-6.38 直接通过（< -5），09:30:55 NVDA marketScore=-4.55 被阻止（在 -5~+5 区间） |

### 9.3 02-13 方向确认决策完整记录

| 时间(ET) | 标的 | marketScore | 决策 | 原因 |
|---------|------|------------|------|------|
| 09:30:12 | SPY | -6.4 | ✅ 放行 PUT | < -5 |
| 09:30:42 | QQQ | -6.2 | ✅ 放行 PUT | < -5 |
| 09:30:55 | NVDA | **-4.6** | ❌ 阻止 | **在 (-5, +5) 区间** |
| 09:31:12 | QQQ | -5.6 | ✅ 放行 PUT | < -5 |
| 09:31:25 | SPY | **-4.8** | ❌ 阻止 | **在 (-5, +5) 区间** |
| 09:31:42 | NVDA | -5.2 | ✅ 放行 PUT | < -5 |
| 09:31:56 | TSLA | **-4.2** | ❌ 阻止 | **在 (-5, +5) 区间** |
| 09:32:27 | QQQ | **-4.6** | ❌ 阻止 | **在 (-5, +5) 区间** |
| 09:32:40 | QQQ | -5.5 | ✅ 放行 PUT | < -5 |
| 09:32:57 | SPY | **-5.0** | ❌ 阻止 | **= -5.0，在开区间 (-5, +5) 内** |

> 注意：09:32:57 SPY marketScore = -5.0 被阻止。因为判断条件是 `> -5`（严格大于），-5.0 满足 `> -5` 为 false → 不在阻止区间。但实际日志显示被标为"趋势不明确"。
> **修正**：实际上 `-5.0 > -5` 是 `false`，所以 `-5.0` 应该通过方向确认进入 BEARISH 方向。日志可能存在舍入显示误差（实际值可能是 -4.97 等）。

---

## 10. 节流聚合机制验证

### 10.1 节流仅影响日志，不影响交易

代码位置：`log.service.ts:178-241`

```
节流机制工作流程：
  ┌─ 信号1 生成 ─→ 策略逻辑执行 ─→ 下单 ─→ 日志写入（✅ 第一条放行）
  ├─ 信号2 生成 ─→ 策略逻辑执行 ─→ 下单 ─→ 日志写入（❌ 被节流，仅计数+1）
  ├─ 信号3 生成 ─→ 策略逻辑执行 ─→ 下单 ─→ 日志写入（❌ 被节流，仅计数+1）
  └─ 30秒窗口到期 ─→ 写入汇总日志："[节流] ...重复 3 次 / 30s"
```

| 特性 | 说明 |
|------|------|
| 窗口大小 | 30 秒（可通过 `system_config` 表配置） |
| 匹配方式 | 按 `module + message模板` 生成 key |
| ERROR 级别 | **永不节流**（line 184-185） |
| 影响范围 | **仅日志写入**，不影响信号生成、订单提交 |

### 10.2 TSLA "节流聚合6次"的实际含义

```
09:40:57 日志: [节流] 策略 10 标的 TSLA.US: 生成信号 BUY... (重复 6 次 / 30s)
```

这意味着在 09:40:24 到 09:40:57 的 33 秒内（跨越了 30 秒窗口），TSLA 的 BUY 信号被评估了 **7 次**（1 次首条 + 6 次重复）。**每次评估都独立运行了完整的策略逻辑**，但：

- 第 1 次（09:40:24 前后）：首条日志放行 + 下单成功 → TSLA260213P410000.US 成交
- 第 2-7 次：策略逻辑发现 TSLA 已在 HOLDING 状态 → 跳过下单 → 日志被节流

**结论**：节流聚合 **不会导致更差价格或更集中暴露**。TSLA 只成交了 1 笔订单，后续 6 次评估因状态已变为 HOLDING 而被正确跳过。

---

## 11. 止损执行深度分析

### 11.1 "35% 没触发，直接到 40% 硬安全阀"的原因

代码执行顺序（`option-dynamic-exit.service.ts:398-433`）：

```
Step 1: 检查持仓时间
  ├─ < 3 分钟 → 跳过普通止损，只受硬安全阀保护
  ├─ 3-10 分钟 → 止损阈值 = 35% × 1.5 = 52.5%（加宽）
  └─ > 10 分钟 → 止损阈值 = 35%（标准）

Step 2: 如果 Step 1 未触发 → 检查硬安全阀 40%
```

**02-13 各仓位的具体命中路径**：

| 仓位 | 持仓时长 | 止损路径 | 触发阈值 | 实际亏损 | 分析 |
|------|---------|---------|---------|---------|------|
| QQQ Put | **4 分钟** | 3-10 分钟冷却期 | 52.5%（35%×1.5） | -44.4% | **35%×1.5=52.5% 未达到，但 40% 硬安全阀触发** |
| NVDA Put | **5 分钟** | 3-10 分钟冷却期 | 52.5%（35%×1.5） | -57.5% | **直接击穿 52.5%（0DTE 价格跳变太快）** |
| IWM Put | **12 分钟** | >10 分钟标准 | 35% | -43.7% | **跳过 35% 直达 40%+** |
| TSLA Put | **37 分钟** | >10 分钟标准 | 35% | -45.4% | **跳过 35% 直达 40%+** |

### 11.2 逐仓位价格跳变分析（5 秒检测周期）

**QQQ260213P595000.US（入场 $2.35，持仓 4 分钟）**：

```
09:43:44  $1.84  grossPnL% ≈ -21.7%  ← 在 35% 以内
09:44:18  $1.58  grossPnL% ≈ -32.8%  ← 仍在 35% 以内
09:44:48  $1.39  grossPnL% ≈ -40.9%  ← ⚠️ 30秒内从 -32.8% 跳到 -40.9%
09:45:03  $1.30  grossPnL% ≈ -44.7%  ← 触发硬安全阀（>40%）
```

**关键跳变**：09:44:18 → 09:44:48 之间（30 秒），亏损从 -32.8% 跳到 -40.9%。这 30 秒内价格从 $1.58 跌到 $1.39（跌幅 12%）。在这个周期内，亏损**直接越过了 35% 和 40% 两个阈值**。

但因为持仓在 3-10 分钟冷却期，止损阈值被加宽到 52.5%，所以 35% 标准止损不会触发。实际路径是：
- 35% 标准止损 → 不适用（在冷却期，阈值 = 52.5%）
- 52.5% 加宽止损 → 未达到（-44.4% < 52.5%）
- 40% 硬安全阀 → **触发**（-44.4% > 40%）

**NVDA260213P182500.US（入场 $1.33，持仓 5 分钟）**：

```
09:43:34  $0.98  grossPnL% ≈ -26.3%
09:43:59  $0.80  grossPnL% ≈ -39.8%  ← 25秒跳 13.5%！
09:44:29  $0.74  grossPnL% ≈ -44.4%
09:45:03  $0.63  grossPnL% ≈ -52.6%  ← 这里才被检测到触发
09:45:43  止损日志记录 -57.5%，成交 $0.56 ← 又滑了 40 秒
```

**关键发现**：NVDA 在 09:43:34 到 09:43:59 的 **25 秒内**，从 -26.3% 直接跳到 -39.8%（一个 5 秒周期可能从 -26% 到 -35%+ 再到 -39.8%）。然后继续恶化到 -57.5%。

### 11.3 止损触发价来源与成交差异

| 环节 | 使用的价格 | 来源 |
|------|-----------|------|
| 止损判断 | `lastDone`（最新成交价） | LongPort SDK `quotes[0].lastDone` |
| 如果 lastDone=0 | `(bid + ask) / 2`（中间价） | 二级行情 |
| 止损下单 | Market Order (MO) | 不设限价，以当前最优对手价成交 |
| 如果 MO 失败 | Limit Order @ `current × 0.1`（最低 $0.01） | 极端低价保底 |

**滑点量化**：

| 仓位 | 触发时 lastDone | MO 成交价 | 滑点 | 滑点 bps |
|------|----------------|-----------|------|---------|
| QQQ Put | $1.30 | $1.27 | -$0.03 | -231 bps |
| NVDA Put | $0.56 | $0.55 | -$0.01 | -179 bps |
| IWM Put | $1.12 | $1.10 | -$0.02 | -179 bps |
| TSLA Put | $1.50 | $1.45 | -$0.05 | -333 bps |

**滑点分析**：
- 平均滑点：-230 bps（-2.3%）
- 最大滑点：TSLA -$0.05（-333 bps）
- 滑点主要来自 **Market Order 的 bid-ask 点差**，而非执行延迟
- 0DTE 期权在快速波动时 bid-ask spread 扩大是正常现象

### 11.4 "40% 硬阀触发里有多少是执行摩擦"

| 仓位 | grossPnL%（触发时） | 实际净亏损% | 滑点+手续费贡献 | 纯市场移动 |
|------|---------------------|-----------|----------------|-----------|
| QQQ | -44.4% | -45.5% | 1.1%（$2.64 手续费 + $3 滑点） | 43.3% |
| NVDA | -57.5% | -58.9% | 1.4%（$3.88 手续费 + $2 滑点） | 56.1% |
| IWM | -43.7% | -45.0% | 1.3%（$2.64 手续费 + $2 滑点） | 42.4% |
| TSLA | -45.4% | -46.4% | 1.0%（$2.64 手续费 + $5 滑点） | 44.4% |

**结论**：**执行摩擦（手续费 + 滑点）仅占总亏损的 1.0-1.4%，97%+ 的亏损来自纯市场移动。** 止损执行效率本身没有问题，问题在于 0DTE 期权价格变化速度远超 5 秒检测周期。

### 11.5 关于 "先算 35% 但因 NaN 未触发" 的残余风险验证

02-13 运行的是 `c13b441` 版本（已修复 grossPnL），不存在 NaN 风险。验证如下：

1. **代码路径确认**：`option-dynamic-exit.service.ts` 中所有比较均使用 `grossPnLPercent`，该值公式为 `grossPnL / costBasis * 100`。`costBasis = entryPrice * quantity * multiplier + entryFees`，其中 `entryPrice > 0`、`quantity > 0`、`multiplier = 100`，因此 `costBasis` 永远 > 0，`grossPnLPercent` 不会为 NaN。

2. **日志证据**：止损日志明确输出了具体的亏损百分比（-44.4%、-57.5% 等），而非 NaN 或 undefined。如果值为 NaN，日志会显示 "NaN%"。

3. **35% 未触发的原因是冷却期逻辑（3-10 分钟加宽到 52.5%），不是 NaN**。IWM（12 分钟）和 TSLA（37 分钟）持仓超过 10 分钟，应适用标准 35% 止损，但从日志看它们直接被 40% 硬安全阀捕获，说明在某个 5 秒周期内亏损直接从 <35% 跳到 >40%。

---

## 12. 资金管理参数来源

### 12.1 单标的上限计算方式

$333.33 和 $262.91 不是配置常量，而是**动态计算结果**：

```
单标的上限 = 策略可用资金 / 标的池数量

$333.33 = $2,000.00（策略配置总额）/ 6（标的数）
$262.91 = $1,375.45（账户实际可用，被 capital protection 压低）/ 6 × 调整因子
         ≈ $229.24 是校正后值（日志显示 $229.24 为上限）
```

### 12.2 参数来源汇总

| 参数 | 值 | 来源 | 代码位置 |
|------|-----|------|---------|
| MIN_OPTION_COST | $300 | 硬编码常量 | `capital-manager.service.ts:739` |
| 策略总资金 | $2,000 | 数据库 `capital_allocations` 表 | 策略配置 |
| 账户实际可用 | $1,375.45 | 运行时查询账户余额 | capital protection 逻辑 |
| 单标的上限 | 动态计算 | `allocatedAmount / symbols.length` | `getEffectiveSymbolPool()` |
| 日志中 $333.33 | $2,000 / 6 | 初始计算 | 资金校正前 |
| 日志中 $229.24 | $1,375.45 / 6 | 校正后计算 | 资金校正后 |

### 12.3 被拒信号的完整清单

02-13 09:40-09:44 期间，除了文档首版列出的 3 条外，还有：

| 时间(ET) | 标的 | 合约 | 请求金额 | 上限 | 状态 |
|---------|------|------|---------|------|------|
| 09:40:24 | SPY.US | — | $435.63 | $333.33 | ❌ 拒绝 |
| 09:40:57 | MU.US | — | $685.63 | $262.91 | ❌ 拒绝 |
| 09:41:27 | MU.US | — | $500.63 | $229.24 | ❌ 拒绝 |
| 09:43:03 | MU.US | — | $420.63 | $229.24 | ❌ 拒绝 |
| 09:43:28 | IWM.US | IWM260213P259000 | $129.02 | 已用$199.63+申请=$328.65 > $229.24 | ❌ 拒绝（第二手） |
| 09:43:28 | IWM.US | IWM260213P258000 | $103.02 | 已用$199.63+申请=$302.65 > $229.24 | ❌ 拒绝（第二手） |

> IWM 的第二和第三次尝试是在已有一手 IWM Put 的基础上尝试加仓，被正确拦截。

**拒绝对评估频率的影响**：被拒绝的信号 **不会** 影响后续评分频率。每个 5 秒周期都独立运行完整评估，资金拒绝只影响当次下单，不改变评估池或频率。

---

## 13. 可执行改进方案（含反事实验证）

### 13.1 改进方案 A：0DTE 开盘冷却 + 更严阈值

**具体规则**：
- 开盘 30 分钟内（09:30-10:00 ET），0DTE 合约需要综合得分 ≤ -15（而非 -10）
- 要求连续 2 次评估（10 秒）得分方向一致

**反事实验证（02-13）**：

```
09:40:23  QQQ 综合得分 = -10.1  → 在新规则下：-10.1 > -15 ❌ 不会开仓
09:40:57  TSLA 综合得分 = -10.1 → 在新规则下：-10.1 > -15 ❌ 不会开仓
09:41:27  MU 综合得分 = -13.4  → 在新规则下：-13.4 > -15 ❌ 不会开仓
09:42:11  SPY 综合得分 = -14.9  → 在新规则下：-14.9 > -15 ❌ 不会开仓（差 0.1）
09:43:02  MU 综合得分 = -14.2  → 在新规则下：-14.2 > -15 ❌ 不会开仓

→ 如果采用 -15 阈值，02-13 全天不会开任何仓位，避免 -$485 亏损 ✅
→ 但 02-12 的多数盈利信号得分也在 -10 ~ -13 之间，可能也会被错过
```

**02-12 反事实对比**：
- 02-12 的盈利交易（如 QQQ 和 TSLA Put 在 09:36 入场）得分约 -12.8
- 如果采用 -15 阈值，02-12 **大部分盈利交易也不会触发**
- 需要在回测中权衡：避免 02-13 亏损 vs 错过 02-12 盈利

**建议可调参数**：
```typescript
// 建议新增配置
tradeWindow: {
  zerodte0penCooldownMinutes: 15,        // 0DTE 开盘冷却（只用 1DTE）
  zdteOpenThresholdMultiplier: 1.5,      // 0DTE 开盘阈值乘数（-10 × 1.5 = -15）
  consecutiveConfirmCycles: 2,           // 连续确认次数
}
```

### 13.2 改进方案 B：direction_confirm 阈值动态化

**具体规则**：
- 开盘前 10 分钟（09:30-09:40）：阈值 = ±8（更严格）
- 开盘 10-30 分钟（09:40-10:00）：阈值 = ±5（当前值）

**反事实验证（02-13）**：

```
09:30:12  SPY marketScore = -6.4  → 在新规则下：|-6.4| < 8 ❌ 被阻止
09:30:42  QQQ marketScore = -6.2  → 在新规则下：|-6.2| < 8 ❌ 被阻止
09:31:42  NVDA marketScore = -5.2 → 在新规则下：|-5.2| < 8 ❌ 被阻止

→ 09:30-09:40 所有信号都会被 ±8 阈值阻止
→ 09:40 之后阈值恢复 ±5，但此时 marketScore 已 < -10，信号不受影响

→ 效果：延迟开仓约 10 分钟，但最终 09:40 的信号仍会触发
→ 单独使用此方案效果有限，需结合方案 A
```

### 13.3 改进方案 C：止损后方向翻转 + 冷却

**具体规则**：
- 止损后 5 分钟内不允许同方向再入场
- 止损后如果得分翻转（从 -10 变为 +10），允许反向开仓

**反事实验证（02-13）**：不适用（02-13 止损后全天无新信号）。此方案主要预防 02-12 式的"连续同方向止损"场景。

### 13.4 改进方案 D：firstHourOnly 适度放宽

**具体规则**：
- 如果首小时内全部止损且剩余资金 > 60% 配额，允许延长到 11:00 ET
- 午盘窗口（12:00-13:00 ET）：综合得分阈值加严 50%（-10 变为 -15）

**反事实验证**：
- 02-13 的 09:45 止损后，剩余资金 ≈ $1,375 - $485 = $890（> 60% × $2,000 = $1,200）
  - 实际上不满足 60% 条件（$890 < $1,200），不会触发延长
  - 即使延长，09:45-11:00 的得分在 -5 ~ -8 之间，也不会触发 -10 阈值
- **结论**：对 02-13 无实际影响。但在市场反转后形成新趋势的日子可能有价值。

### 13.5 改进方案 E：合约到期日选择

**当前实现**：合约选择器（`options-contract-selector.service.ts`）按最近到期日选择，没有 "优先 1DTE" 的逻辑。

**具体规则**：
- 开盘 30 分钟内，如果 0DTE 和 1DTE 合约同时可用，优先选 1DTE
- 1DTE 的 Theta 衰减较慢，给策略更多容错空间

**资金影响**：
- 1DTE 权利金通常比 0DTE 高 30-80%
- 以 QQQ 595 Put 为例：0DTE ≈ $2.35，1DTE ≈ $3.50-$4.00
- 在 $333/标的的预算下，可能从 1 手降为 0 手（无法购买）
- **需要验证**：合约选择器是否支持 `preferExpiry: '1DTE'` 参数（当前不支持，需新增）

```typescript
// 建议在 SelectOptionContractParams 中新增
interface SelectOptionContractParams {
  // ... 现有字段
  preferNextDayExpiry?: boolean;          // 优先次日到期
  preferNextDayExpiryBeforeMinutes?: number; // 开盘后 N 分钟内优先次日（默认30）
}
```

---

## 14. 补充附录

### 附录 C：02-13 各仓位完整价格轨迹

#### C.1 TSLA260213P410000.US（持仓最长 37 分钟）

```
时间(ET)    价格     grossPnL%    阶段
09:41:xx    $2.76    入场         开仓
09:43:09    $2.36    -14.5%       初始回撤
09:43:44    $2.31    -16.3%       继续下跌
09:44:14    $2.14    -22.5%       加速
09:44:48    $1.92    -30.4%       接近 35% 标准止损
09:44:58    $1.76    -36.2%       > 35%，但在冷却期（3-10分钟 → 阈值 52.5%）
09:45:29    $1.49    -46.0%       > 40% 硬安全阀，但 09:45 检测可能延迟
09:52:48    $2.19    -20.7%       ⚡ 反弹回来！（被 IWM 止损流程占用？）
09:53:38    $1.72    -37.7%       再次下跌
09:54:43    $1.47    -46.7%       > 40%
09:55:23    $1.58    -42.8%       小反弹
09:55:53    $1.88    -31.9%       大反弹
... 持续震荡 ...
10:17:58    $1.50    -45.4%       最终触发硬安全阀
```

> ⚠️ TSLA 的持仓过程显示了 0DTE 的极端波动：价格在 $1.47-$2.19 之间剧烈震荡。在 09:52 曾经反弹到 $2.19（-20.7%），如果此时平仓亏损仅 -$57 而非最终的 -$131。但止损逻辑在该周期没有触发（因为 -20.7% < 40%）。

#### C.2 IWM260213P260000.US（持仓 12 分钟）

```
时间(ET)    价格     grossPnL%    阶段
09:41:xx    $2.00    入场         开仓
09:43:03    $2.10    +5.0%        短暂盈利
09:43:09    $1.67    -16.5%       急速下跌
09:43:44    $1.54    -23.0%
09:44:18    $1.40    -30.0%
09:44:48    $1.29    -35.5%       > 35%，但在冷却期（阈值 52.5%）
09:45:18    $1.02    -49.0%       > 40%（但可能检测延迟）
09:52:23    $1.23    -38.5%       反弹
09:52:48    $1.12    -44.0%       再次下跌 → 触发硬安全阀
09:53:47    $1.10    成交         滑点 -$0.02
```

### 附录 D：评分系统放大系数汇总

| 因子 | 放大系数 | 含义 |
|------|---------|------|
| SPX 当日涨跌 | × 100 × 35 | 0.01% 的价格变动 → 0.35 分 |
| SPX K线实体强度 | × 25 × amplifier（max range/0.5） | 大阴/大阳线额外放大 |
| BTC/USD 动量 | × 3000 × consistencyMultiplier | 同向连续加成最高 ×1.5 |
| 市场温度 | × 30 / 50 | 温度 50→100 映射到 0→30 |

> **关键发现**：SPX 当日涨跌的放大系数 `× 100 × 35 = 3500x` 是所有因子中最大的。0.43% 的 SPY 下跌 × 3500 ≈ -15 分（权重 35% 后 ≈ -5.25），这是得分从 -2 快速滑向 -10 的数学根因。

---

*报告结束（V2 — 含深度验证补充）*
