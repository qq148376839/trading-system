# 反转行情连续亏损根因分析

**日期**: 2026-02-24 (交易日 2026-02-23)
**类型**: 事后复盘分析
**策略**: 策略10 (0DTE PUT 期权)
**严重性**: P0 — 系统性缺陷导致反转行情下持续亏损

---

## 一、事件概述

2026-02-23 交易时段，策略10 在市场约 11:05 ET 开始反转后，仍持续产生 PUT 买入信号并执行，形成"亏损 → 平仓 → 立即重入 → 再亏损"的死循环。反转前盈利 +$691，反转后亏损 -$512，13 轮交易净结果仅 +$179（扣除手续费后接近盈亏平衡）。

---

## 二、订单全景

### 反转前（~10:36 - 11:04 ET）— 盈利阶段

| # | 时间(ET) | 标的 | 买/卖 | 数量 | 成交价 | 单笔盈亏 |
|---|----------|------|-------|------|--------|----------|
| 1 | 10:36 | QQQ P604 | Buy | 2 | $2.35 | |
| 2 | 10:40 | SPY P684 | Buy | 1 | $1.65 | |
| 3 | 10:56 | QQQ P604 | Sell | 2 | $3.39 | **+$208** (+44.3%) |
| 4 | 10:56 | SPY P684 | Sell | 1 | $2.47 | **+$82** (+49.7%) |
| 5 | 10:57 | SPY P683 | Buy | 2 | $1.89 | |
| 6 | 10:58 | QQQ P600 | Buy | 3 | $1.30 | |
| 7 | 11:03 | QQQ P602 | Buy | 1 | $2.89 | |
| 8 | 11:03 | SPY P682 | Buy | 1 | $2.06 | |
| 9 | 11:03 | SPY P683 | Sell | 2 | $2.55 | **+$132** (+34.9%) |
| 10 | 11:03 | QQQ P600 | Sell | 3 | $1.84 | **+$162** (+41.5%) |
| 11 | 11:04 | SPY P682 | Sell | 1 | $2.64 | **+$58** (+28.2%) |
| 12 | 11:04 | QQQ P602 | Sell | 1 | $3.15 | **+$26** (+9.0%) |

**小计: +$691**

### 拐点 ~11:05 ET — 市场开始反转（标的反弹上涨，PUT 下跌）

### 反转后（~11:05 - 11:44 ET）— 亏损阶段

| # | 时间(ET) | 标的 | 买/卖 | 数量 | 成交价 | 单笔盈亏 |
|---|----------|------|-------|------|--------|----------|
| 13 | 11:05 | QQQ P601 | Buy | 1 | $2.64 | |
| 14 | 11:14 | QQQ P599 | Buy | 3 | $1.89 | |
| 15 | 11:14 | QQQ P601 | Sell | 1 | $2.87 | **+$23** (+8.7%) |
| 16 | 11:19 | QQQ P599 | Sell | 3 | $1.31 | **-$174** (-30.7%) |
| 17 | 11:20 | SPY P681 | Buy | 2 | $1.97 | |
| 18 | 11:20 | SPY P682 | Buy | 1 | $1.87 | |
| 19 | 11:20 | SPY P681 | Sell | 2 | $1.45 | **-$104** (-26.4%) |
| 20 | 11:21 | QQQ P601 | Buy | 3 | $2.05 | |
| 21 | 11:21 | SPY P682 | Sell | 1 | $1.71 | **-$16** (-8.6%) |
| 22 | 11:25 | SPY P682 | Buy | 2 | $1.55 | |
| 23 | 11:39 | QQQ P601 | Sell(手动) | 3 | $1.52 | **-$159** (-25.9%) |
| 24 | 11:39 | QQQ P601 | Buy | 3 | $1.49 | (第三次入场) |
| 25 | 11:41 | SPY P682 | Sell(手动) | 2 | $1.36 | **-$38** (-12.3%) |
| 26 | 11:42 | QQQ P601 | Sell(手动) | 3 | $1.42 | **-$21** (-4.7%) |

**小计: -$512**

### 汇总

| 阶段 | 交易轮次 | 总盈亏 |
|------|---------|--------|
| 反转前 | 6轮 | +$691 |
| 反转后 | 7轮 | -$512 |
| **净结果** | **13轮** | **+$179**（扣手续费后约盈亏平衡） |

---

## 三、根因分析

### 根因 A（P0）：无日内累计亏损熔断机制

搜索整个 `api/src/services/` 目录，**不存在** `dailyPnL` / `dailyLoss` / `日内亏损` 相关逻辑。当前止损仅作用于**单笔持仓级别**（`option-dynamic-exit.service.ts`），没有任何**策略级或账户级的日内亏损熔断**。

**后果**: 即使连续4笔亏损累计 -$512，系统仍在每次平仓后冷却期结束后立即重新入场。

### 根因 B（P1）：冷却期过短，形同虚设

`strategy-scheduler.service.ts:1420-1440` 的 0DTE 动态冷却逻辑：

```
前2笔: 无冷却
3-4笔: 1分钟
5笔起: 3分钟
```

在快速反转的市场中，1-3 分钟冷却约等于无冷却。实际表现：11:19 卖出 QQQ P599（亏-$174）后，仅隔约1分钟就在 11:20 买入 SPY P681 和 SPY P682。

### 根因 C（P1）：信号系统无市场环境感知（不感知反转）

信号生成 `generateSignal()` 基于**当前快照**（分时评分、K线形态），**不考虑最近交易的盈亏结果**。执行循环：

```
IDLE → generateSignal → 有BUY信号就执行 → 持仓 → 退出条件触发 → 平仓 → IDLE → 再次generateSignal...
```

市场 ~11:05 反转后，分时评分可能仍偏空（惯性），PUT 信号继续产生。系统无法从最近交易的连续亏损中推断出"当前方向判断可能错误"。

### 根因 D（P0，已修复未部署）：grossPnLPercent 归零导致止损失效

#20 QQQ P601（入场$2.05）在 11:21-11:39 期间持续显示 `盈亏 +0.0%`，实际亏损高达 37%（$2.05→$1.29）。**止损34%从未触发**，直到 11:39 手动平仓。

根因：`multiplier` 从 JSONB 反序列化为字符串 `"100"` 导致 `costBasis=NaN`，百分比计算结果为 0。详见 `docs/fixes/260224-盈亏百分比归零与LIT止盈保护修复.md`。

---

## 四、亏损放大链路图

```
市场反转（~11:05 ET）
  │
  ├─ 信号系统无反转感知 → 继续产生 PUT 买入信号（根因C）
  │
  ├─ 冷却期 0-3 分钟 → 平仓后立即重入（根因B）
  │
  ├─ 无日内累计亏损熔断 → 连续亏损无上限（根因A）
  │
  └─ grossPnLPercent=0% → 止损34%永远不触发 → 亏损扩大（根因D）
      │
      └─ 手动干预平仓（11:39 - 11:42）才终止死循环
```

---

## 五、系统性缺陷清单与建议

| 优先级 | 缺陷 | 当前状态 | 建议修复方案 |
|--------|------|----------|-------------|
| **P0** | grossPnLPercent 归零 | 代码已修复，未部署 | 尽快部署 |
| **P0** | 无日内累计亏损熔断 | **缺失** | 新增：日亏 ≥ $N 或 ≥ X% 时暂停策略至收盘 |
| **P1** | 冷却期不感知连续亏损 | 0-3分钟固定值 | 连续亏损后指数级加长冷却期（如亏2笔→5min, 亏3笔→15min） |
| **P1** | 信号系统无反转感知 | 仅看当前快照 | 加入最近N笔交易胜率/PnL作为信号权重或抑制因子 |
| **P2** | 无同方向最大并发入场限制 | 同一方向可无限开仓 | 限制同一 underlying 同方向最大并发持仓数 |

---

## 六、关联文档

- [260224-盈亏百分比归零与LIT止盈保护修复](../fixes/260224-盈亏百分比归零与LIT止盈保护修复.md) — 根因D的修复方案
- [260216-0DTE单腿动态风控开发文档](../features/260216-0DTE单腿动态风控开发文档.md) — 0DTE 动态风控设计
