# SPY260217P676000 追高交易复盘

**日期**: 2026-02-18
**交易日**: 2026-02-17 (美东时间) / 2026-02-18 (北京时间)
**合约**: SPY260217P676000.US (SPY 0DTE Put, 行权价 676, 到期日 2026-02-17)
**结论**: 系统在 SPY 日内底部反转的精确时刻买入 0DTE Put, 本质上是在期权价格峰值追高入场, 亏损 -$66.14 (-31.4%)

---

## 目录

1. [交易概览](#1-交易概览)
2. [时序复盘](#2-时序复盘)
3. [K线定位分析](#3-k线定位分析)
4. [归因定位](#4-归因定位)
5. [核心结论](#5-核心结论)
6. [改进方案](#6-改进方案)
7. [代码版本对比分析](#7-代码版本对比分析)
8. [a36fa86 版本对比分析](#8-a36fa86-版本对比分析)
9. [2月10日运行日志分析](#9-2月10日运行日志分析)
10. [修复方案模拟推演（1分钟K线精确模拟）](#10-修复方案模拟推演1分钟k线精确模拟)
11. [方向确认窗口验证 + 多标的组合分析](#11-方向确认窗口验证--多标的组合分析)
12. [旧代码会买 PUT 还是 CALL?](#12-旧代码会买-put-还是-call--动量追踪陷阱的本质)
13. [2月18日交易复盘 — TSLA CALL](#13-2月18日交易复盘--tsla260218c417500us-1dte-call)
14. [策略本质问题 — 当前策略不适合期权交易](#14-策略本质问题--当前策略不适合期权交易)
15. [2/17 + 2/18 组合盈亏总结](#15-217--218-组合盈亏总结)

---

## 1. 交易概览

### 1.1 订单汇总

| 维度 | 买入 | 卖出 |
|------|------|------|
| 订单 ID | 1208427999959982080 | 1208439531863285760 |
| 方向 | Buy (ELO 增强限价单) | Sell (ELO) |
| 提交价格 | $2.15 | $1.40 |
| 成交价格 | $2.09 | $1.46 |
| 提交时间 (ET) | 10:00:42 | 10:47:16 |
| 成交时间 (ET) | 10:00:43 | ~10:47 |
| 订单类型 | Market Order (系统因价差偏离升级) | ELO |
| 信号 ID | 219040 | -- |
| 触发原因 | [BEAR_SPREAD] 综合得分-15.7 <= -12 (0DTE加严) | [STOP_LOSS] 0DTE兜底止损：亏损-30.2% <= -25% |

### 1.2 盈亏明细

| 项目 | 金额 |
|------|------|
| 买入成本 | $2.09 x 100 = $209.00 |
| 卖出收入 | $1.46 x 100 = $146.00 |
| 手续费 | $2.64 |
| 盈亏保本价 | $2.12 |
| 净亏损 | **-$66.14 (-31.4%)** |
| 持仓时长 | ~46 分钟 |

---

## 2. 时序复盘

以下所有时间均为 UTC, 括号内为美东时间 (ET = UTC - 5h)。

### 2.1 信号生成阶段 (14:50 - 15:00 UTC)

| UTC 时间 | ET 时间 | 事件 | 关键数据 |
|----------|---------|------|----------|
| 14:50:18 | 09:50:18 | NO_SIGNAL | 开盘方向确认窗口, 大盘得分-2.6, 趋势不明确 |
| 14:50:29 | 09:50:29 | NO_SIGNAL | 所有策略条件不满足, final=-4.12, market=-6.53, intraday=-7.72 |
| 14:51~14:57 | 09:51~09:57 | NO_SIGNAL (持续) | 得分逐渐向负方向移动, SPY 持续下跌中 |
| 14:58:55 | 09:58:55 | SIGNAL_GENERATED | 选中 SPY260218P679000 (**1DTE**, 非 0DTE), skip0DTE=true, inCooldown=true, final=-17.6, market=-28.8 |
| 14:59:51 | 09:59:51 | SIGNAL_GENERATED | 选中 SPY260218P675000 (1DTE), skip0DTE=true, final=-15.3, market=-22.3 |
| **15:00:30** | **10:00:30** | **0DTE 闸门开启** | [连续确认] BEARISH 2/2 通过; **[VWAP] 获取失败, 降级放行**; skip0DTE=false, is0DTEEntry=true, entryThreshold=12 |
| 15:00:41 | 10:00:41 | SIGNAL_GENERATED | 选中 **SPY260217P676000** (0DTE), Delta=-0.439, Theta=14.406, Premium=2.10, 原因: 综合得分-15.7 <= -12 |

### 2.2 订单执行阶段 (15:00:42 - 15:00:43 UTC)

| UTC 时间 | ET 时间 | 事件 | 关键数据 |
|----------|---------|------|----------|
| 15:00:42 | 10:00:42 | 期权报价获取 | 市场价 $2.15 (longport-optionQuote), IV=23.30% |
| 15:00:42 | 10:00:42 | 价差偏离检测 | 信号价 $2.10 vs 市场价 $2.15, 偏差 2.33% |
| 15:00:42 | 10:00:42 | **升级为 Market Order** | 因价格偏差, 系统使用市价单提交 |
| 15:00:42 | 10:00:42 | 订单提交 | 订单 ID: 1208427999959982080 |
| 15:00:43 | 10:00:43 | **订单成交** | 成交价 $2.09, 1 秒内成交 |

### 2.3 持仓与止损阶段 (15:00:43 - 15:47 UTC)

| UTC 时间 | ET 时间 | 事件 | 关键数据 |
|----------|---------|------|----------|
| 15:00:43 | 10:00:43 | 持仓开始 | 成本 $2.09, 保本价 $2.12 |
| 15:00~15:05 | 10:00~10:05 | 期权价格急跌 | 5min K线: 该根蜡烛 H=2.39, L=1.43, C=1.48 |
| 15:05~15:15 | 10:05~10:15 | 价格震荡下行 | SPY 反弹至 679.62, Put 价值被压缩 |
| 15:30 | 10:30 | 短暂反弹 | Put 曾回升至 ~2.19 (接近成本), 但未触发任何出场逻辑 |
| **15:46:31** | **10:46:31** | **兜底止损触发** | 亏损-30.2% <= -25% (0DTE 收紧阈值), 提交卖出 |
| 15:47:16 | 10:47:16 | 止损成交 | 成交价 $1.46, 净亏 -$66.14 |

### 2.4 如果继续持有...

| UTC 时间 | ET 时间 | Put 收盘价 | 累计亏损 (相对 $2.09) |
|----------|---------|-----------|----------------------|
| 15:45 | 10:45 | $1.33 | -36.4% |
| 16:00 | 11:00 | $0.74 | -64.6% |
| 到期 | -- | ~$0.01 | -99.5% |

止损执行避免了更大亏损, 止损机制本身运作正常。

---

## 3. K线定位分析

### 3.1 SPY 标的 5 分钟 K 线 (关键时段)

```
UTC 时间   | Open   | High   | Low    | Close  | 走势特征
-----------+--------+--------+--------+--------+------------------
14:50      | 680.28 |        | 677.63 | 677.82 | 放量下跌, 跌幅大
14:55      | 677.84 |        | 676.46 | 676.63 | 继续下探 (底部区域)
15:00 <<<  | 676.62 | 678.24 | 676.27 | 678.13 | *** 日内最低 676.27, V型反转 ***
15:05      |        |        |        | 677.36 | 小幅回落
15:10      |        |        |        | 676.93 | 二次探底未破前低
15:15      |        |        |        | 679.62 | 强势拉升
...后续持续上行至 682.73
```

**关键发现**: SPY 在 15:00 UTC (10:00 ET) 这根 5 分钟蜡烛内触及日内最低点 676.27, 并在同一根蜡烛内完成 V 型反转, 收盘 678.13, 较最低点反弹近 2 个点。**系统的买入指令恰好发生在这根蜡烛内 (15:00:42 UTC)**。

### 3.2 Put 期权 5 分钟 K 线 (关键时段)

```
UTC 时间   | Open | High | Low  | Close | Volume  | 特征
-----------+------+------+------+-------+---------+------------------
14:55      | 1.78 | 2.29 | 1.75 | 2.21  | 9,234   | Put 价值攀升
15:00 <<<  | 2.24 | 2.39 | 1.43 | 1.48  | 10,157  | *** 日内最高 2.39, 巨量, 大阴线 ***
15:05      | 1.47 | 1.78 | 1.32 | 1.72  |         | 低位震荡
15:15      |      | 1.94 |      | 0.98  |         | 持续崩塌
15:30      |      | 2.36 |      | 2.19  |         | 短暂反弹 (SPY二次回落)
15:45      |      |      |      | 1.33  |         | 再次下跌
```

**关键发现**:
- 15:00 UTC 的 5 分钟蜡烛是当日 Put 期权的 **最高价蜡烛** (High=2.39)
- 成交量 10,157 张, 是全天最大量能蜡烛之一
- 这根蜡烛呈现 **巨量长上影阴线** (Open 2.24, High 2.39, Close 1.48), 典型的见顶反转形态
- 系统以 $2.09 成交, 位于该蜡烛 High (2.39) 和 Low (1.43) 之间偏上位置: **(2.09 - 1.43) / (2.39 - 1.43) = 68.8% 分位**, 买在了蜡烛的上方 2/3 区域

### 3.3 买入价格在日内分布中的位置

```
                    日内最高 2.39
                    ============
                    |          |
                    |  买入 2.09 <<<  (距最高仅 -12.6%)
                    |          |
                    ============
                    日内典型价格区间 0.74 ~ 2.39

最终到期: ~$0.01
```

系统买入价 $2.09 处于 Put 期权日内价格分布的 **第 87 百分位** (基于 (2.09-0.01)/(2.39-0.01)), 几乎是当天能买到的最贵价格。

---

## 4. 归因定位

### 4.1 延迟与滑点分析

| 度量 | 数据 | 说明 |
|------|------|------|
| T_signal (信号生成) | 15:00:41 UTC | 0DTE 信号生成, 价格 $2.10 |
| T_order (订单提交) | 15:00:42 UTC | 1 秒后提交 |
| T_fill (成交) | 15:00:43 UTC | 再 1 秒成交 |
| T_fill - T_signal | **2 秒** | 执行延迟极低 |
| 信号价 vs 成交价 | $2.10 vs $2.09 | 滑点 -$0.01 (有利滑点) |
| 信号价 vs 市场报价 | $2.10 vs $2.15 | 偏差 2.33%, 触发市价单升级 |

**结论**: 延迟和滑点不是亏损原因。从执行角度看, 系统在 2 秒内完成信号到成交的全链路, 且获得了比报价更好的成交价。**问题不在执行速度, 而在于入场时机本身就是错误的。**

### 4.2 VWAP 结构确认失效 (核心缺陷)

**失败链路**:

```
15:00:30 UTC:
  [连续确认] SPY.US BEARISH 2/2 通过, 允许入场
  [VWAP] SPY.US 获取失败: Failed to convert napi value into enum `TradeSessions`
  [结构确认] SPY.US VWAP数据不可用, 跳过结构确认（降级放行）
```

**问题分析**:

1. **技术故障**: Longbridge SDK 的 VWAP 接口因 `TradeSessions` 枚举转换错误而失败, 这是 SDK/napi 层面的 bug, 系统无法获取 VWAP 数据
2. **降级策略过于宽松**: 当 VWAP 不可用时, 系统选择"降级放行"(pass-through), 直接跳过结构确认
3. **结构确认的设计初衷被绕过**: 根据 0DTE 动态风控方案 (Phase 2), 结构确认的核心作用是 **"规避入场接近绝对低点/高点、随后 V 反转"**, 这恰好是本次交易的亏损模式

**如果 VWAP 正常工作会怎样?**

根据 15:00 UTC 的 SPY 走势:
- SPY 在 14:55-15:00 区间已从 676.46 反弹至 678.13 (收盘价)
- 如果 VWAP 可用, 且值在 ~678 附近 (根据当日均价估算), SPY 在 15:00 的蜡烛收盘 678.13 已接近甚至站上 VWAP
- 结构确认规则要求 "连续 2 根 1m 收盘价在 VWAP 下方", 在 SPY 已经开始反弹时, 这个条件大概率 **不满足**
- **VWAP 结构确认很可能会阻止这次入场**

### 4.3 评分滞后性 (信号基于已消耗的动量)

**得分演变**:

```
14:50 UTC: final = -4.12  (趋势刚起)
14:55 UTC: final ~ -10    (快速恶化)
14:58 UTC: final = -17.6  (极端看空, 但此时 skip0DTE=true)
15:00 UTC: final = -15.7  (已从极值回落! 但 0DTE 闸门刚刚打开)
```

**关键矛盾**:

- 得分在 14:58 达到极值 -17.6, 此时 SPY 正在加速下跌, 是做空的 **最佳入场点**
- 但 0DTE 禁入窗口 (09:30-10:00 ET) 阻止了在此时开仓, 这一设计本身是正确的 (规避开盘噪声)
- 等到 15:00:30 (10:00:30 ET) 0DTE 闸门打开时, SPY 已经触底并开始反弹, 得分也从 -17.6 回升至 -15.7
- 系统看到的是 "依然很强的看空信号" (-15.7 远超 -12 阈值), 但实际价格行为已经反转

**这揭示了一个结构性问题**: 基于累积动量的评分系统在趋势末端天然具有滞后性。得分越极端, 往往意味着趋势已经走了很远, 反转概率反而更高。

### 4.4 0DTE 禁入窗口边界效应

```
时间线:
09:30 ET ──── 禁入窗口 ──── 10:00 ET ── 闸门打开 ── 10:00:30 ET 入场
                                         |
                                    SPY 精确在此触底
```

- 09:30-10:00 ET 的禁入窗口设计是为了避开开盘波动, 总体是正确的
- 但它创造了一个 **边界效应**: 在窗口即将结束时, 如果市场已经走出了一轮行情, 闸门打开后系统会立即基于已积累的信号入场
- 本次交易恰好命中这个边界: SPY 在 09:50-10:00 ET 完成了一轮快速下跌, 然后在 10:00 精确反转
- 连续确认 (2/2) 在 10:00:30 达成, 但确认的是 **已经结束的趋势**

### 4.5 市价单升级的影响

```
信号价格: $2.10
市场报价: $2.15 (偏差 2.33%)
系统决策: 升级为 Market Order
成交价格: $2.09
```

- 市价单本身获得了有利成交 ($2.09 < $2.15), 并非导致亏损的直接原因
- 但在 0DTE 市场中, 价格变化极快, 使用市价单意味着完全放弃价格控制
- 如果使用限价单 $2.10, 在价格快速下跌的情况下可能也会成交, 但至少保留了不成交的可能性
- 对于 0DTE 这种高波动品种, **限价单应该是默认选择, 而非市价单**

---

## 5. 核心结论

### 5.1 亏损根因 (按影响程度排序)

| 排序 | 根因 | 影响程度 | 说明 |
|------|------|----------|------|
| 1 | **VWAP 结构确认被技术故障绕过** | 致命 | 降级放行策略使得唯一能识别反转的安全网失效, 这是本次亏损最直接的可避免原因 |
| 2 | **评分信号的趋势滞后性** | 高 | 系统用累积动量打分, 天然在趋势末端产生最强信号, 构成逆向选择 |
| 3 | **禁入窗口边界效应** | 中 | 10:00 闸门打开时市场已完成行情, 但系统仍基于历史积累信号入场 |
| 4 | **降级放行的设计缺陷** | 中 | 关键安全检查失败时应保守处理 (拒绝入场), 而非激进处理 (放行) |

### 5.2 一句话总结

> 系统在 SPY 日内底部精确反转的时刻, 因 VWAP 技术故障绕过了结构确认, 基于已经见顶的累积看空动量信号, 在 Put 期权日内最高价附近追高买入, 本质上是 **用滞后信号追已消耗的趋势, 在安全网失效的情况下买在了顶部**。

---

## 6. 改进方案

### 6.1 P0 — VWAP 降级策略改为保守拒绝

**现状**: VWAP 获取失败时, 跳过结构确认, 降级放行
**改为**: VWAP 获取失败时, **对 0DTE 入场直接拒绝**, 仅允许 1DTE/2DTE 通过

```
// 伪代码
if (!vwapAvailable && is0DTEEntry) {
  log.warn('[结构确认] VWAP 不可用, 拒绝 0DTE 入场');
  return { allowed: false, reason: 'VWAP_UNAVAILABLE_0DTE_BLOCKED' };
}
```

**理由**: 0DTE 单腿裸 long 的容错空间极窄, 结构确认是核心安全网, 宁可错过也不能在安全网失效时入场。

### 6.2 P0 — 修复 VWAP 数据获取的 napi 错误

**现状**: `Failed to convert napi value into enum TradeSessions` 导致 VWAP 全天不可用
**行动**:
- 排查 Longbridge SDK 中 `TradeSessions` 枚举的传参方式
- 确认是 SDK 版本问题还是调用参数问题
- 添加集成测试覆盖 VWAP 获取路径
- 如 SDK 无法短期修复, 考虑通过 1 分钟 K 线自行计算 VWAP 作为后备方案

### 6.3 P1 — 入场动量衰减检测

**现状**: 只检查绝对得分是否超过阈值 (score <= -12), 不考虑得分变化方向
**改为**: 增加动量方向校验

```
// 伪代码
const scoreTrend = currentScore - previousScore; // 正值 = 向中性回归
if (scoreTrend > 0 && is0DTEEntry) {
  // 得分正在回归, 趋势可能已经见顶
  log.warn('[动量衰减] 得分从极值回归中, 暂缓 0DTE 入场');
  return { allowed: false, reason: 'SCORE_REVERTING' };
}
```

**理由**: 得分 -15.7 (从 -17.6 回升) 说明看空动量已经在减弱。如果得分正从极端值向中性回归, 即使绝对值仍超阈值, 也应视为趋势衰减信号。

### 6.4 P1 — 禁入窗口结束后增加冷却缓冲

**现状**: 10:00 ET 禁入窗口结束后, 如果连续确认满足, 立即允许 0DTE 入场
**改为**: 窗口结束后增加 2-5 分钟冷却期, 要求在冷却期内重新积累连续确认

```
// 伪代码
const windowEndTime = '10:00 ET';
const cooldownMinutes = 3;
const effectiveEntryTime = windowEndTime + cooldownMinutes;

// 在 effectiveEntryTime 之前的连续确认不计入 0DTE
if (currentTime < effectiveEntryTime) {
  consecutiveCount = 0; // 重置, 要求重新确认
}
```

**理由**: 禁入窗口积累的信号反映的是窗口内的行情, 窗口结束后应重新评估, 避免"一开闸就冲进去"的边界效应。

### 6.5 P2 — 0DTE 入场强制使用限价单

**现状**: 系统因信号价与市场价偏差升级为市价单
**改为**: 0DTE 入场强制使用限价单, 宁可不成交也不追价

```
// 伪代码
if (is0DTEEntry) {
  orderType = 'LIMIT'; // 强制限价
  limitPrice = Math.min(signalPrice, marketPrice); // 取较低者
  // 不升级为 Market Order
}
```

**理由**: 0DTE 期权价格波动剧烈, 市价单在快速波动中可能成交在极端价位。限价单提供了"市场不给好价格就不做"的被动保护。

### 6.6 P2 — 入场价格相对于近期 K 线位置检测

**现状**: 不检查入场价格在近期 K 线中的位置
**改为**: 检查入场价格是否接近近期 K 线高点 (对 Put) 或低点 (对 Call)

```
// 伪代码 (Put 入场)
const recentHigh = max(last3Candles.map(c => c.high));
const recentLow = min(last3Candles.map(c => c.low));
const pricePosition = (entryPrice - recentLow) / (recentHigh - recentLow);

if (pricePosition > 0.7 && is0DTEEntry) {
  // 买入价位于近期高点 70% 以上, 追高风险大
  log.warn('[价格位置] Put 入场价接近近期高点, 追高风险');
  return { allowed: false, reason: 'OPTION_PRICE_NEAR_HIGH' };
}
```

**理由**: 本次交易中, 买入价 $2.09 位于 5 分钟 K 线 68.8% 分位, 属于典型追高。对期权价格做位置检测可以过滤掉"买在蜡烛上半部分"的高风险入场。

---

## 附录: 改进方案优先级与预期效果

| 优先级 | 方案 | 预期效果 | 实现复杂度 |
|--------|------|----------|-----------|
| P0 | VWAP 降级改为拒绝 | 直接阻止本次亏损 | 低 (逻辑修改) |
| P0 | 修复 VWAP napi 错误 | 恢复结构确认能力 | 中 (依赖 SDK 排查) |
| P1 | 动量衰减检测 | 过滤趋势末端的滞后信号 | 低 (增加判断) |
| P1 | 禁入窗口冷却缓冲 | 消除边界效应 | 低 (增加时间判断) |
| P2 | 0DTE 强制限价单 | 避免追价成交 | 低 (订单类型约束) |
| P2 | K线价格位置检测 | 识别追高入场 | 中 (需获取期权K线) |

---

## 7. 代码版本对比分析

> 本节将当前 HEAD 代码与旧版本 `22901e7` (feat: 期权策略三项实盘优化 - 止损冷静期/时间窗口收紧/取消退避) 进行对比, 分析约 30 个 commit 引入的功能变化对本次交易的实际影响, 并模拟旧代码在同一市场环境下的行为。

### 7.1 关键代码差异清单

以下列出与本次交易直接相关的 10 项代码差异:

| 编号 | 功能模块 | 旧代码 (`22901e7`) | 当前代码 (HEAD) | 相关文件 |
|------|---------|--------------------|--------------------|----------|
| 1 | 0DTE 禁入窗口 | 不存在, 无 `zdteCooldownMinutes` 配置, 所有 0DTE 从开盘即可入场 | `zdteCooldownMinutes: 30`, 09:30-10:00 ET 为 0DTE 禁入区, 期间 `skip0DTE=true` 降级为 1DTE/2DTE | `option-intraday-strategy.ts` |
| 2 | 连续确认 | 不存在, 信号直接触发入场 | `consecutiveConfirmCycles: 2`, 同向信号需连续出现 2 个评估周期 (15s 窗口内) | `option-intraday-strategy.ts` |
| 3 | VWAP 结构确认 | 不存在, 无 `getIntradayVWAP()` 调用 | PUT 入场要求最近 2 根 1 分钟蜡烛收盘低于 VWAP; 失败时降级放行 | `option-intraday-strategy.ts` |
| 4 | 0DTE 入场阈值加严 | 使用标准 `ENTRY_THRESHOLDS`, AGGRESSIVE 风偏下 BEAR_SPREAD 阈值约 10 | `zdteEntryThreshold: 12`, 0DTE 使用 `Math.max(thresholds.spreadScoreMin, 12)` | `option-intraday-strategy.ts` |
| 5 | 市价单逻辑 | 仅 `forceClose` (止损/强平) 使用市价单, 买入用限价单 (ELO) | 所有期权订单 (买入+卖出) 均使用市价单, 判断条件从 `isOptionForceClose` 改为 `isOptionOrder` | `basic-execution.service.ts` |
| 6 | 期权价格获取 | option-price-cache -> LongPort quote -> Futunn option detail (三级回退) | 统一为 `longportOptionQuoteService.getOptionPrice()`, 增加 `midPrice` 用于 0DTE 出场计算 | `market-data.service.ts` 等 |
| 7 | 0DTE 动态止损 | 标准止损 + 冷静期 (0-3min 仅安全阀; 3-10min 1.5x 放宽; 10+min 标准) | 0DTE 专用: `0dte_pnl_floor` 硬止损 -25%; 禁用冷静期放宽; TIME_STOP 收盘前 180min; VWAP 失效退出; 波动率分桶追踪止盈 | `option-dynamic-exit.service.ts` |
| 8 | 收盘前禁入时间 | `noNewEntryBeforeCloseMinutes: 60` (收盘前 60 分钟) | 改为 180 分钟 (1:00 PM ET 后不开新仓) | `option-intraday-strategy.ts` |
| 9 | 开盘方向确认窗口 | 不存在 | `directionConfirmMinutes: 30`, 开盘 30 分钟内仅允许与大盘方向一致的交易; 得分在 [-5, 5] 内不交易 | `option-intraday-strategy.ts` |
| 10 | LATE 时段逻辑 | 不存在 | 收盘前 30min-2h 为 LATE 时段, 入场阈值提高, 出场后冷却 | `option-dynamic-exit.service.ts` |

### 7.2 旧代码模拟推演

以下基于旧代码 (`22901e7`) 的逻辑, 结合 2026-02-17 的实际市场数据, 推演旧代码在本次交易中的完整行为。

#### 7.2.1 入场阶段

| 时间 (UTC) | 时间 (ET) | 旧代码行为 | 当前代码行为 | 差异说明 |
|-----------|-----------|-----------|------------|---------|
| 14:50-14:57 | 09:50-09:57 | NO_SIGNAL, 得分未达阈值 | 同左 | 无差异 |
| **14:58:55** | **09:58:55** | **信号触发, 得分 -17.6, 无 0DTE 限制, 无连续确认, 无 VWAP 检查, 无方向确认窗口 -> 直接入场 0DTE PUT** | 0DTE 禁入窗口生效 (skip0DTE=true), 降级为 1DTE SPY260218P679000 ($5.26), 未执行 | **关键分歧点**: 旧代码在此时即触发 0DTE 入场, 比当前代码早约 90 秒 |
| 14:59:51 | 09:59:51 | 已持有仓位, 不再评估入场 | 继续降级为 1DTE, skip0DTE=true | 旧代码已在仓 |
| 15:00:30 | 10:00:30 | 已在仓 ~90 秒 | 0DTE 闸门打开, 连续确认 2/2, VWAP 获取失败降级放行 | -- |
| 15:00:42 | 10:00:42 | 已在仓 ~107 秒 | 买入 SPY260217P676000 @ $2.09 | -- |

**旧代码入场推演细节**:

1. **合约选择**: 旧代码无 `skip0DTE` 参数, 在 14:58:55 会直接选择 0DTE PUT。根据当时 SPY 价格 (~676.5) 和期权链, 最可能选中 SPY260217P676000 或相邻行权价的 0DTE PUT
2. **入场价格**: 14:58-14:59 UTC 期间, SPY260217P676000 的 5 分钟 K 线 (14:55 根) 显示 Open=1.78, High=2.29, Low=1.75, Close=2.21。14:59 时刻期权价格估计在 **$1.80-$2.20** 区间
3. **订单类型**: 旧代码买入使用 **限价单** (ELO 增强限价单), 非市价单。以信号价 ~$2.00-2.10 提交限价单, 估计成交在 **~$2.00** 附近
4. **时间优势**: 比当前代码早 ~90 秒入场, 入场价低约 $0.09 (~4.3%)

#### 7.2.2 持仓阶段与出场推演

入场后, 需要分析旧代码的止损/止盈逻辑在后续价格行情中的行为。

**关键价格走势 (SPY260217P676000)**:

```
时间 (UTC)  | 价格     | 相对旧入场 $2.00 | 相对当前入场 $2.09
-----------+---------+------------------+------------------
14:59      | ~$2.00  | 0% (入场)         | --
15:00 High | $2.39   | +19.5%           | -- (尚未入场)
15:00 Close| $1.48   | -26.0%           | -29.2% (刚入场)
15:05      | $1.72   | -14.0%           | -17.7%
15:10      | ~$1.90  | -5.0%            | -9.1%
15:15      | $0.98   | -51.0%           | -53.1%
15:30      | $2.19   | +9.5%            | +4.8%
15:45      | $1.33   | -33.5%           | -36.4%
```

**旧代码止损逻辑三阶段**:

```
阶段 1: 0-3 分钟冷静期 (14:59 - 15:02)
  -> 仅安全阀 -50% 生效, 标准止损暂不触发
  -> 期间价格: $2.00 -> $2.39 (峰值) -> ~$1.48-1.70
  -> 即使跌至 $1.48 (-26%), 安全阀不触发, 继续持有

阶段 2: 3-10 分钟放宽期 (15:02 - 15:09)
  -> 止损阈值 1.5x 放宽: 标准 -30% x 1.5 = -45% 生效
  -> 期间价格在 $1.50-1.90 震荡, 亏损 -5% 到 -26%
  -> 未触发 -45% 止损

阶段 3: 10 分钟后标准止损 (15:09 起)
  -> 标准 -30% 止损生效 (BUYER EARLY 阶段)
  -> 15:10 价格 ~$1.90, 亏损 -5%, 不触发
  -> 15:15 价格 $0.98, 亏损 -51%, 触发
```

#### 7.2.3 追踪止盈的可能性

旧代码确实包含追踪止盈逻辑 (`trailingStopTrigger` / `trailingStopPercent`), 这是唯一可能让旧代码盈利的路径:

- 入场 $2.00, 峰值 $2.39, 未实现盈利 +19.5%
- BUYER EARLY 阶段追踪触发阈值约 +15%, 已达到
- 追踪止盈回撤比例约 10%, 即从峰值回落 10% 即出场
- 峰值 $2.39 x (1 - 10%) = $2.15, 价格跌破 $2.15 即应触发
- 价格从 $2.39 跌破 $2.15 的时间: 约 15:00:30 - 15:01 UTC

**但存在三个关键不确定性**:

1. **峰值跟踪精度**: 旧代码使用 `peakPnLPercent = pnl.netPnLPercent * 1.1` 近似估算峰值, 并非真实的历史最高值跟踪。这种估算在价格剧烈波动时可能严重失真 -- 如果在某个 5 秒评估周期内, `netPnLPercent` 恰好是 +10%, 系统会估算峰值为 +11%, 而真实峰值可能是 +19.5%
2. **5 秒评估间隔**: 系统每 5 秒评估一次持仓。$2.39 的峰值可能存在于两次评估之间, 系统可能从未"看到"过 +19.5% 的收益。如果系统看到的最高值是 +12%, 则 `* 1.1 = +13.2%`, 未达到 +15% 触发阈值, 追踪止盈根本不会激活
3. **冷静期冲突**: 0-3 分钟冷静期内, 旧代码仅安全阀生效。追踪止盈是否在冷静期内被禁用取决于具体实现。如果被禁用, 则 $2.39 峰值 (发生在入场后 ~60 秒) 完全无法被捕获

#### 7.2.4 三种情景推演

**情景 A: 乐观 -- 追踪止盈完美触发**

```
前提: 追踪止盈在冷静期内仍然有效, 且系统恰好在 $2.39 峰值附近有一次评估
时间线:
  14:59:00  买入 @ $2.00 (限价单)
  15:00:xx  系统观测到价格 ~$2.35, 估算峰值 PnL=+17.5%, 触发追踪止盈
  15:00:30  价格跌破 $2.15 (峰值回撤 10%), 追踪止盈触发卖出
  成交: ~$2.15-2.19
结果: 净盈利约 +7.5% ~ +9.5% (~$15-19, 扣除手续费)
概率评估: 低 (约 15-20%)
```

**情景 B: 中性 -- 追踪止盈未触发, 标准止损生效**

```
前提: 追踪止盈因冷静期/精度问题未激活, 走入标准止损流程
时间线:
  14:59:00  买入 @ $2.00
  14:59-15:02  冷静期, 仅 -50% 安全阀
  15:02-15:09  1.5x 放宽止损 (-45%), 价格在 $1.50-1.90, 未触发
  15:09+  标准 -30% 止损生效, 阈值 = $2.00 x 0.70 = $1.40
  15:15  价格 $0.98, 跌破 $1.40
  卖出: @ ~$1.40 (可能更低, 市场执行延迟)
结果: 净亏损约 -30% (~-$60)
概率评估: 最高 (约 50-60%)
```

**情景 C: 悲观 -- 在 1.5x 放宽期内未止损, 深度亏损后被安全阀截停**

```
前提: 标准止损在 3-10 分钟放宽为 -45%, 但价格在标准止损生效前已经深度下跌
时间线:
  14:59:00  买入 @ $2.00
  15:02-15:09  1.5x 放宽期, 有效止损 -45%, 价格在 $1.50-1.90 震荡
  15:10  标准 -30% 止损生效, 但 15:15 价格已跌至 $0.98 (-51%)
  安全阀 -50% 触发 (旧代码可能在评估间隔内跌穿)
  卖出: @ ~$0.95-1.00
结果: 净亏损约 -50% 以上 (~-$100+)
概率评估: 约 20-25%
```

### 7.3 逐项功能影响评估

#### 7.3.1 0DTE 禁入窗口: 双刃剑

**设计目标**: 规避 09:30-10:00 ET 开盘噪声, 防止追涨杀跌。

**本次实际效果**: 反面案例。

- 禁入窗口阻止了 14:58:55 UTC 的入场, 该时刻恰好是 SPY 最低点前 ~60 秒, Put 价格 ~$2.00
- 等待窗口结束后 (15:00:30), SPY 已完成 V 型反转, Put 从 $2.39 峰值开始崩塌
- 系统在 15:00:42 以 $2.09 入场, 此时已经是 "追高"

**但这不代表禁入窗口应该取消**: 本次是小概率边界事件 -- SPY 恰好在窗口结束瞬间触底反转。在绝大多数交易日, 开盘 30 分钟的信号确实包含大量噪声, 禁入窗口能有效过滤。问题在于窗口结束后的 **边界处理** (见 6.4 改进方案), 而非窗口本身。

如果旧代码在 14:58:55 入场, 以 ~$2.00 买入, 有约 15-20% 概率通过追踪止盈小幅获利, 但有 50-60% 概率以 -30% 止损离场, 20-25% 概率亏损 -50% 以上。**期望值仍为负**。

#### 7.3.2 连续确认: 增加了 ~90 秒延迟

**设计目标**: 过滤单次脉冲信号, 要求趋势持续性。

**本次实际效果**: 与禁入窗口叠加, 进一步延迟入场。

- 14:58:55 第一次 BEARISH 信号 (1/2), 因禁入窗口被阻
- 15:00:30 第二次 BEARISH 信号 (2/2), 连续确认通过
- 两次确认间隔约 90 秒, 期间市场已反转

**评估**: 连续确认在趋势持续的行情中有价值 (过滤假信号), 但在 V 型反转场景中会导致确认的是 "已经结束的趋势"。本次确认的 2/2 信号, 第一个捕捉到了趋势末段, 第二个确认时趋势已逆转。这是趋势跟踪系统的固有缺陷, 并非连续确认的设计问题。

#### 7.3.3 VWAP 结构确认: 本应是救命稻草, 却因技术故障失效

**设计目标**: 确认价格结构支持入场方向, 规避 V 型反转。

**本次实际效果**: 因 `TradeSessions` 枚举转换错误导致 VWAP 获取失败, 降级放行。

- 如果 VWAP 正常工作, 15:00 UTC 的 SPY 已从 676.27 最低点反弹至 678.13, 大概率已接近或站上 VWAP
- "最近 2 根 1 分钟蜡烛收盘低于 VWAP" 的条件大概率不满足
- **VWAP 结构确认很可能会阻止这次入场** -- 这正是该功能的设计价值所在

**旧代码对比**: 旧代码完全没有 VWAP 检查, 同样没有这层安全网。从这个角度看, 当前代码在 VWAP 正常工作时严格优于旧代码。本次失效是个别技术故障, 而非设计缺陷。

#### 7.3.4 0DTE 入场阈值加严: 本次无实质影响

**设计目标**: 0DTE 需要更强信号才允许入场。

**本次实际效果**: 得分 -15.7 同时超过旧阈值 (~10) 和新阈值 (12), 两版代码都会放行。阈值加严在本次交易中未产生差异。

#### 7.3.5 市价单逻辑变化: 微幅影响

**旧代码**: 买入使用限价单 (ELO), 可能以 ~$2.00-2.10 成交, 或在价格快速变动时不成交。
**当前代码**: 升级为市价单, 成交 $2.09。

实际差异约 $0.01-0.09, 对最终亏损的贡献微乎其微。但原则上, 旧代码的限价单在极端波动中可能因为无法成交而 "被动保护" 了交易者, 当前代码的市价单则消除了这种保护。

#### 7.3.6 0DTE 动态止损: 当前代码更优

**旧代码止损流程**:
- 0-3 分钟冷静期: 仅 -50% 安全阀
- 3-10 分钟: 1.5x 放宽 (有效止损 -45%)
- 10 分钟后: 标准 -30%

**当前代码止损流程**:
- 0DTE 专用硬止损 `0dte_pnl_floor`: -25%
- 禁用冷静期放宽 (不做 1.5x 调整)
- 追踪止盈 + 波动率分桶

**对比结论**: 当前代码以 -31.4% 止损 (触发 0DTE -25% 阈值后执行价差导致实际 -31.4%), 旧代码最可能以 -30% 止损 (情景 B), 但有 20-25% 概率滑至 -50%。当前代码的止损下限更加确定和可控, 避免了冷静期放宽带来的风险窗口。

#### 7.3.7 收盘前禁入时间 (60 -> 180 分钟): 本次无影响

入场时间为 10:00 ET, 距收盘超过 6 小时, 两版代码的收盘前禁入规则均不触发。

#### 7.3.8 开盘方向确认窗口: 旧代码缺失此检查

旧代码没有开盘方向确认窗口, 理论上可以在开盘初期就基于微弱信号入场。但本次交易中, 14:58 之前得分未达阈值, 所以此差异在本次交易中未产生实际影响。

### 7.4 综合对比结论

#### 7.4.1 入场时机对比

```
旧代码 (22901e7):
  14:58:55 UTC (09:58:55 ET)  ->  入场 @ ~$2.00 (限价单)
  SPY 仍在下跌中, Put 处于上升段, 尚未到达 $2.39 峰值

当前代码 (HEAD):
  15:00:42 UTC (10:00:42 ET)  ->  入场 @ $2.09 (市价单)
  SPY 已完成 V 型反转, Put 已从 $2.39 峰值回落, 处于下跌段

时间差: ~107 秒
价格差: ~$0.09 (旧代码略优)
```

#### 7.4.2 出场结果对比 (加权期望值)

| 情景 | 概率 | 旧代码结果 | 当前代码结果 |
|------|------|-----------|------------|
| A: 追踪止盈成功 | 15-20% | +$15-19 | 不适用 (无峰值窗口) |
| B: 标准止损 | 50-60% | -$60 | -- |
| C: 深度亏损 | 20-25% | -$100+ | -- |
| 实际结果 | 100% | -- | -$66.14 |

**旧代码加权期望亏损**:
- 乐观: 0.175 x (+$17) + 0.55 x (-$60) + 0.225 x (-$100) = $2.98 - $33.00 - $22.50 = **-$52.53**
- 悲观: 0.15 x (+$15) + 0.60 x (-$60) + 0.25 x (-$110) = $2.25 - $36.00 - $27.50 = **-$61.25**

**当前代码实际亏损**: **-$66.14**

从期望值角度, 旧代码在本次特定交易中的期望亏损 (-$52 ~ -$61) 略好于当前代码的实际亏损 (-$66.14), 主要得益于更早入场带来的更低买入价和微小的追踪止盈概率。但这一差异并不显著, 且旧代码有约 20-25% 的概率出现 -$100 以上的深度亏损, 尾部风险更大。

#### 7.4.3 核心结论

1. **两版代码都无法盈利**: 无论使用旧代码还是当前代码, 在 SPY 日内底部买入 0DTE Put 的根本错误是一致的。评分系统基于累积动量打分, 在趋势末端天然产生最强信号, 这个结构性缺陷存在于两个版本中

2. **旧代码更早入场, 但并非更好**: 早 90 秒入场获得了更低的买入价 (~$2.00 vs $2.09), 且存在追踪止盈捕获短暂利润的微小可能, 但期望值仍为亏损。更早入场也意味着更早暴露在冷静期放宽 (1.5x) 的风险窗口中

3. **当前代码的 0DTE 风控设计方向正确**: 禁入窗口、连续确认、VWAP 结构确认、0DTE 硬止损 -- 这些功能的设计初衷都是正确的。本次亏损的根因不是这些功能 "多余", 而是 VWAP 因技术故障失效, 恰好碰上了禁入窗口的边界效应

4. **当前代码止损更确定**: 0DTE 硬止损 (-25%) 将最大亏损锁定在较窄范围内 (实际 -31.4% 含执行滑点), 而旧代码的冷静期放宽机制在 0DTE 快速波动场景下会导致止损不及时, 有 20-25% 概率出现 -50% 以上亏损

5. **讽刺之处**: 禁入窗口和连续确认 -- 两个旨在 "防止追高" 的功能 -- 在本次交易中反而 **延迟入场至更差的价格**, 而 VWAP 结构确认 -- 唯一能真正识别 V 型反转的安全网 -- 却因技术 bug 失效。这说明防御体系的价值取决于每一层都正常工作, 任何一层失效都可能让整体防御失去意义

6. **改进重点明确**: (a) 修复 VWAP 技术故障是最高优先级; (b) 降级策略从 "放行" 改为 "拒绝" 可直接避免本次亏损; (c) 增加动量衰减检测 (得分从极值回归时暂缓入场) 可从信号层面解决滞后性问题, 对两版代码都适用

---

## 8. a36fa86 版本对比分析

> 本节分析中间版本 `a36fa86` (fix: 止损止盈失效5项根因修复 + 监控频率分离) 在本次交易中的行为。该版本位于旧版 `22901e7` 和当前 HEAD 之间: 从 `22901e7` 到 `a36fa86` 经过了 20 个 commit, 从 `a36fa86` 到 HEAD 又经过了 20 个 commit。4 个核心策略文件在 `a36fa86` 到 HEAD 之间有 761 行新增和 417 行删除。

### 8.1 a36fa86 相对于 22901e7 已具备的功能

以下功能在 `a36fa86` 中已经存在, 是其相对于旧版的改进:

| 编号 | 功能 | 来源 Commit | 说明 |
|------|------|------------|------|
| 1 | LongPort 作为主要期权链数据源 | `13e32c3` | 替代 Futunn 作为一级期权链获取路径, 提高数据可靠性 |
| 2 | TSLPPCT 追踪止盈保护服务 | `9140d2c` | 券商侧追踪止盈单, 作为系统侧止盈的补充 |
| 3 | 已过期期权自动清理至 IDLE | `745e88b` | 检测到期权过期且券商无持仓时, 自动将状态从 MONITORING 转为 IDLE |
| 4 | 市场数据串行获取 (避免 Moomoo 403) | `a095678` | 将并发请求改为串行, 减少触发 Moomoo API 频率限制的概率 |
| 5 | 多仓位资金预算修复 | `ba212d0` | 修复多个持仓同时存在时资金预算计算错误的问题 |
| 6 | 止损止盈 5 项根因修复 + 监控频率分离 | `a36fa86` 本身 | 修复止损止盈失效的 5 个根本原因, 并将监控频率从统一改为分级 |
| 7 | `noNewEntryBeforeCloseMinutes: 120` | -- | 从旧版的 60 分钟扩大至 120 分钟 (但尚未到 HEAD 的 180 分钟) |
| 8 | 市场数据错误降级为 warn | -- | 避免市场数据获取失败产生大量 error 级别日志 |
| 9 | 深层配置合并 (nested objects) | -- | 对 `tradeWindow`、`exitRules`、`positionSizing` 等嵌套对象支持深度合并, 避免浅拷贝覆盖 |

### 8.2 a36fa86 尚未具备的功能 (HEAD 中新增)

以下功能在 `a36fa86` 中 **不存在**, 是从 `a36fa86` 到 HEAD 之间添加的:

| 编号 | 功能 | 来源 Commit | 对本次交易的潜在影响 |
|------|------|------------|---------------------|
| 1 | 0DTE 冷却窗口 (`zdteCooldownMinutes: 30`) | Phase 1 `300b232` | 高 -- 没有此功能, 0DTE 从开盘即可入场 |
| 2 | 连续确认 (`consecutiveConfirmCycles: 2`) | Phase 1 `300b232` | 中 -- 无需连续 2 次确认, 信号直接触发 |
| 3 | VWAP 结构确认 | Phase 2 `5188345` | 高 -- 完全没有 VWAP 安全网 |
| 4 | 0DTE 入场阈值加严 (`zdteEntryThreshold: 12`) | Phase 1 `300b232` | 低 -- 信号得分 -17.6 和 -15.7 均超过 12 |
| 5 | 方向确认窗口 (`directionConfirmMinutes: 30`) | `c13b441` | 低 -- 开盘 30 分钟内的方向窗口, 但信号在 14:58 已明确 |
| 6 | LATE 时段逻辑 | `c13b441` | 无 -- 入场时间 10:00 ET 不在 LATE 时段 |
| 7 | `noNewEntryBeforeCloseMinutes: 180` | `c13b441` | 无 -- 入场在 10:00 ET, 距收盘超 6 小时 |
| 8 | 0DTE 专用止损 (`0dte_pnl_floor: -25%`) | Phase 1 `300b232` | 中 -- 使用旧版止损逻辑 (冷静期 + 标准止损) |
| 9 | 0DTE TIME_STOP 180min | Phase 1 `300b232` | 低 -- 本次在时间止损前已触发价格止损 |
| 10 | 所有期权订单使用市价单 | 后续 commit | 低 -- 仍使用限价单 (ELO), 仅 forceClose 用市价 |
| 11 | `grossPnLPercent` 替代 `netPnLPercent` (NaN 修复) | `c13b441` | 中 -- 仍使用 `netPnLPercent`, 有 NaN 风险 |

### 8.3 a36fa86 下的本次交易模拟

**结论: 入场行为与旧版 `22901e7` 基本一致。**

具体分析:

1. **无 0DTE 冷却窗口**: `a36fa86` 没有 `zdteCooldownMinutes` 配置, 不会设置 `skip0DTE=true`, 因此 0DTE 合约从 09:30 ET 开盘起即可入场
2. **无连续确认**: 信号触发后直接入场, 不需要等待第二次确认周期
3. **无 VWAP 检查**: 完全没有结构确认逻辑, 不存在降级放行的问题 -- 也不存在被 VWAP 拦截的可能
4. **无方向确认窗口**: 自由入场, 不受开盘方向限制
5. **入场阈值**: 使用标准阈值 (~10), 但信号得分 -17.6 远超此阈值, 两种阈值都会放行
6. **买入订单**: 使用限价单 (ELO), 非市价单
7. **收盘前禁入**: 120 分钟 (比旧版 60 分钟严格, 但 10:00 ET 入场不受影响)

**模拟时间线**:

```
14:58:55 UTC (09:58:55 ET):
  信号触发, 得分 -17.6, 无任何 0DTE 限制
  -> 直接选择 0DTE PUT 入场 (与 22901e7 行为一致)
  -> 限价单提交, 预估成交 ~$2.00
  -> 比 HEAD 早约 107 秒入场
```

**出场推演**: 与第 7 节 `22901e7` 的三种情景推演完全一致:

| 情景 | 概率 | 结果 |
|------|------|------|
| A: 追踪止盈成功 | 15-20% | +$15-19 |
| B: 标准止损 -30% | 50-60% | -$60 |
| C: 深度亏损 -50%+ | 20-25% | -$100+ |

**加权期望亏损**: 约 **-$52 ~ -$61** (与 `22901e7` 一致)

### 8.4 a36fa86 与 22901e7 的实质差异

虽然对本次交易的入场/出场行为几乎无影响, `a36fa86` 在以下方面存在实质改进:

1. **PnL NaN 修复 (部分)**: `a36fa86` 包含了止损止盈 5 项根因修复, 解决了部分 `netPnLPercent` 产生 NaN 的场景。但该修复并不完全 -- 完整的 NaN 修复 (切换到 `grossPnLPercent`) 要到 `c13b441` 才实现。在 2 月 10 日的运行日志中, 仍然可以看到 `净盈亏 +0.0% ($NaN)` 的输出, 证实 `a36fa86` 版本的 NaN 问题并未彻底解决
2. **期权价格获取可靠性**: LongPort 作为主要数据源 + Futunn 回退, 减少了因 Moomoo 403 导致的价格获取失败。但对于已过期期权 (如 NVDA260209C187500.US), 所有数据源都会失败
3. **已过期期权清理**: 自动检测并清理过期持仓, 避免系统长时间对过期合约执行无效监控

### 8.5 小结

`a36fa86` 处于一个 "改善了基础设施, 但尚未引入风控升级" 的中间状态。它修复了止损止盈的底层 bug、改善了数据源可靠性、增加了过期期权清理, 但 0DTE 专用的防御体系 (冷却窗口、连续确认、VWAP 结构确认、硬止损) 全部尚未实现。

对于 2026-02-17 这笔 SPY 0DTE Put 交易而言, `a36fa86` 的行为与 `22901e7` 本质相同: 在 14:58:55 UTC 无任何限制地入场, 以 ~$2.00 买入, 然后经历与旧版完全一致的持仓和止损流程。**三个版本的根本问题是同一个: 基于累积动量的评分系统在趋势末端产生最强信号, 无论哪个版本的代码都会在这个时点触发入场。**

---

## 9. 2月10日运行日志分析

> 本节基于 2026 年 2 月 10 日的系统运行日志 (共 8,290 条记录) 进行分析。2 月 10 日系统运行的代码版本为 `a36fa86` 或其附近版本。该日志揭示了多个系统层面的问题, 部分问题与 2 月 17 日交易的亏损根因直接相关。

### 9.1 已过期期权持仓问题 (NVDA260209C187500.US)

#### 9.1.1 问题概述

系统在 2 月 10 日 (周一) 仍持有一个 2 月 9 日 (周五) 已到期的 NVDA 看涨期权 NVDA260209C187500.US。从 05:01 UTC 至 14:25 UTC (约 9 小时), 系统反复尝试对这个已过期的仓位进行价格监控, 所有价格获取方法均失败。

#### 9.1.2 详细时间线

```
05:01 UTC ~ 14:25 UTC (持续约 9 小时):
  每 5 秒一次监控周期, 反复尝试获取 NVDA260209C187500.US 价格

  获取路径 1: Futunn API
    -> 返回 HTML 错误页面 (403/Moomoo 频率限制)
    -> 所有请求均失败

  获取路径 2: LongPort 期权报价
    -> "未找到正股: NVDA"
    -> 无法映射期权到标的股票

  获取路径 3: 缓存
    -> 缓存中有过期前的最后价格 $2.41 (已过期的陈旧数据)

  所有路径结果: 价格返回 $0, PnL 计算产生 NaN
  日志输出: "入场$0.80 -> 当前$2.41 | 净盈亏 +0.0% ($NaN)"

  注: $2.41 是过期前缓存的陈旧价格, $0.80 是原始入场价
       净盈亏显示 $NaN, 正是 netPnLPercent 的 NaN bug

14:25:20 UTC (09:25 ET, 开盘前 5 分钟):
  系统最终检测到期权已过期且券商端无持仓
  -> "已过期且券商无持仓，自动转为IDLE"
  -> 仓位状态从 MONITORING 切换为 IDLE
  -> 该清理功能来自 commit 745e88b (在 a36fa86 中已具备)
```

#### 9.1.3 影响分析

- **系统资源浪费**: 9 小时内每 5 秒一次的无效监控, 约产生 6,480 次失败的价格获取请求, 贡献了大量无意义日志
- **NaN PnL 问题暴露**: 日志中的 `净盈亏 +0.0% ($NaN)` 直接证实了 `netPnLPercent` 在费用数据缺失时产生 NaN 的 bug。该 bug 的完整修复 (切换到 `grossPnLPercent`) 直到 commit `c13b441` 才实现
- **自动清理功能有效但滞后**: 虽然 `a36fa86` 已具备过期期权清理能力, 但清理发生在开盘前 5 分钟 (14:25 UTC), 意味着系统在盘前整整 9 小时都在对过期合约执行无效操作。清理触发条件依赖 "券商端确认无持仓", 在盘前时段券商 API 可能无法确认, 导致延迟

#### 9.1.4 改进建议

- 增加本地过期日检查: 如果期权到期日 < 当前日期, 直接标记为 IDLE, 无需等待券商确认
- 在日志聚合层对过期期权的重复监控失败进行抑制, 避免日志泛滥

### 9.2 市场数据全面故障

#### 9.2.1 故障现象

2 月 10 日全天, Moomoo/Futunn API 返回持续性错误, 导致系统无法获取关键市场数据:

```
反复出现的错误模式:

[富途API错误] stockId=72000025, type=2: 未知错误    (DXY/美元指数)
[富途API错误] stockId=200003, type=2: 未知错误      (未知标的)
[富途API错误] stockId=12000015, type=2: 未知错误    (SPX/标普500指数)
```

#### 9.2.2 级联失败链

```
Moomoo API 返回 "未知错误"
  -> SPX 历史数据获取失败
  -> "SPX数据不足（0 < 50）" (需要至少 50 根 K 线, 实际获取 0 根)
  -> 市场得分无法计算
  -> "市场数据获取失败，无法提供交易建议"
  -> 所有标的的推荐算法全部跳过
```

受影响的标的包括: NVDA、SPY、QQQ、TSLA、AAPL、GOOG、AMD、TSM 等 15 个以上的交易标的, 所有股票推荐均失败。

#### 9.2.3 故障时间范围

- 最早记录: ~05:59 UTC (盘前)
- 持续至: 至少 14:34 UTC (开盘后)
- 根本原因: Moomoo API 频率限制 (Rate Limiting), 返回 403 HTML 错误页面而非 JSON 格式的错误响应

#### 9.2.4 与 2 月 17 日交易的关联

2 月 17 日的交易中, VWAP 获取失败的错误为 `Failed to convert napi value into enum TradeSessions` -- 这是 LongPort SDK 层面的问题, 与 2 月 10 日的 Moomoo API 故障属于不同的故障路径。但两者反映了同一个系统性风险: **市场数据源的脆弱性**。

- 2 月 10 日: Moomoo 数据源故障 -> 全天无法交易 (反而避免了亏损)
- 2 月 17 日: LongPort 数据源故障 (VWAP) -> 降级放行 -> 入场并亏损

两次故障的对比揭示了一个设计矛盾: 当数据源完全不可用时 (2 月 10 日), 系统正确地拒绝交易; 当数据源部分可用 (2 月 17 日, VWAP 失效但其他数据正常) 时, 系统降级放行, 反而导致了更差的结果。这进一步支持了第 6.1 节的改进方案: **关键安全检查失败时应保守拒绝, 而非激进放行**。

### 9.3 TSLPPCT 提交失败

#### 9.3.1 错误详情

```
14:25:20 UTC:
  [TSLP] 策略 10 期权 NVDA260209C187500.US:
  TSLPPCT提交失败(Unwrap value [longport_nodejs::time::NaiveDate]
  from class failed on SubmitOrderOptions.expireDate)，
  降级到纯监控模式
```

#### 9.3.2 原因分析

这是 LongPort Node.js SDK 在处理 `NaiveDate` 类型时的 napi 层转换错误, 与 2 月 17 日 VWAP 获取失败的 `TradeSessions` 枚举转换错误属于 **同一类问题** -- 都是 LongPort SDK 的 Rust-to-Node napi 绑定层在类型转换时失败。

两次 napi 错误的对比:

| 日期 | 错误类型 | 失败字段 | 影响 |
|------|---------|---------|------|
| 2 月 10 日 | NaiveDate 转换失败 | `SubmitOrderOptions.expireDate` | TSLPPCT 追踪止盈单无法提交, 降级为纯监控 |
| 2 月 17 日 | TradeSessions 枚举转换失败 | VWAP 接口的 `TradeSessions` 参数 | VWAP 全天不可用, 结构确认降级放行 |

这说明 LongPort SDK 的 napi 绑定层存在系统性的类型转换脆弱性, 不仅影响交易数据获取, 还影响订单提交。建议:
- 排查当前使用的 LongPort SDK 版本是否有已知的 napi 兼容性问题
- 考虑升级 SDK 版本或在调用层增加参数类型的显式转换 (如将 Date 对象转为字符串后再传入)

### 9.4 关键发现汇总

#### 9.4.1 NaN PnL Bug 的实证

2 月 10 日日志中的 `净盈亏 +0.0% ($NaN)` 输出是 `netPnLPercent` NaN bug 的直接证据。该 bug 的成因链:

```
已过期期权无法获取价格
  -> 价格返回 $0
  -> 手续费数据缺失或为 0
  -> netPnLPercent = (收入 - 成本 - 手续费) / 成本
  -> 分母或分子中存在无效值
  -> 计算结果为 NaN
  -> 日志输出: "净盈亏 +0.0% ($NaN)"
```

该 bug 在 `a36fa86` 中仍然存在, 直到 commit `c13b441` 切换到 `grossPnLPercent` (不依赖手续费数据) 后才彻底解决。

#### 9.4.2 2 月 10 日无任何交易执行

由于 Moomoo API 全天返回错误, 系统在 2 月 10 日 **未生成任何交易信号, 未执行任何交易**。整天的日志全部是数据获取失败和错误重试的记录。

从结果论看, 这反而是 "正确" 的行为 -- 数据不可用时不交易。但这是因为故障范围足够大 (所有数据源都失败), 如果像 2 月 17 日那样只有部分数据源失败, 系统就会在安全网不完整的情况下继续交易。

#### 9.4.3 Moomoo 403 频率限制是长期顽疾

2 月 10 日的 HTML 错误页面检测修复 (commit `d95975b`) 在 `a36fa86` 之后才添加, 说明在 `a36fa86` 版本中, 系统甚至无法正确识别 Moomoo 的 403 HTML 响应, 而是将其作为 "未知错误" 处理。

Moomoo API 频率限制问题的时间线:
- `a095678`: 市场数据改为串行获取, 减少并发 (预防措施)
- `a36fa86`: 仍然遇到 403 问题 (2 月 10 日日志证实)
- `d95975b`: 增加 HTML 错误页面检测, 正确识别 403 响应 (在 `a36fa86` 之后)
- 当前 HEAD: LongPort 作为主要数据源, Moomoo 作为回退, 进一步降低 403 风险

#### 9.4.4 综合启示

2 月 10 日的日志与 2 月 17 日的交易亏损共同揭示了系统在数据可靠性方面的核心挑战:

1. **数据源单点故障风险高**: 无论是 Moomoo 的 403 频率限制, 还是 LongPort 的 napi 类型转换错误, 单个数据源的故障就可能导致系统功能严重受损
2. **降级策略需要分场景设计**: 全面数据故障时拒绝交易 (正确), 部分数据故障时降级放行 (危险) -- 这两种行为的不一致需要统一为保守策略
3. **SDK 层面的 napi 错误是系统性风险**: LongPort SDK 的 NaiveDate 和 TradeSessions 转换错误表明 napi 绑定层存在脆弱性, 需要在调用层增加防御性类型处理
4. **过期期权清理应更及时**: 当前的清理逻辑依赖券商 API 确认, 应增加本地到期日检查作为前置判断, 减少无效监控

---

## 10. 修复方案模拟推演（1分钟K线精确模拟）

> 本节基于 SPY260217P676000 和 SPY 的 **1 分钟 K 线** 数据, 结合 5 项修复方案的精确参数, 对修复后系统在 2026-02-17 同一市场环境下的行为进行逐分钟模拟推演。目标是回答一个核心问题: **如果 5 项修复全部生效, 这笔交易的结果会变成什么?**

### 10.1 修复方案参数说明

以下 5 项修复是本次模拟的前提条件:

| 编号 | 修复内容 | 参数变更 | 说明 |
|------|---------|---------|------|
| Fix 1 | 取消 0DTE 前期窗口禁入时间 | `zdteCooldownMinutes: 30` → `0` | 0DTE 不再需要等到 10:00 ET 才能入场, 开盘起信号即可触发 |
| Fix 2 | 尾盘禁入从 180 分钟缩短至 120 分钟 | `noNewEntryBeforeCloseMinutes: 180` → `120` | 收盘前 120 分钟 (14:00 ET / 18:00 UTC) 后禁止开新仓。本次入场在 ~10:00 ET, 不受影响 |
| Fix 3 | 修复 VWAP 结构确认 | 修复 `TradeSessions` 枚举转换 napi 错误 | VWAP 数据恢复可用, 结构确认正常执行 |
| Fix 4 | 0DTE 取消降级放行 | VWAP/结构检查失败时 **拒绝入场** (而非放行) | 安全网: 即使 Fix 3 未生效, VWAP 失败也会阻止 0DTE 入场 |
| Fix 5 | 添加 TSLPPCT 跟踪止损保护 | 买入成交后立即提交券商侧 TSLPPCT 单; 0DTE 强制 trailing=15%, limitOffset=0.10 | 券商侧追踪止损, 独立于系统侧监控, 跟踪持仓期间最高水位 |

**重要说明**: `consecutiveConfirmCycles: 2` (连续确认) **未被修改**, 仍然要求同向信号连续出现 2 个评估周期才确认入场。

### 10.2 1 分钟 K 线参考数据

#### 10.2.1 SPY260217P676000.US (Put 期权)

```
时间(UTC)  Open   High   Low    Close   Vol     备注
14:50     1.03   1.65   0.94   1.60    2335
14:51     1.61   1.77   1.49   1.60    2246
14:52     1.62   1.66   1.50   1.66     990
14:53     1.66   1.93   1.59   1.89    1897
14:54     1.91   1.91   1.78   1.80    1737
14:55     1.78   2.10   1.77   2.05    1971
14:56     2.06   2.17   1.89   2.01    2040
14:57     2.00   2.00   1.75   1.94     904
14:58     1.95   2.15   1.95   2.10    1187
14:59     2.11   2.29   2.08   2.21    3132
15:00     2.24   2.39   2.05   2.05    3717    ← SPY 日内最低点, Put 日内峰值
15:01     2.05   2.15   1.73   1.81    2143    ← Put 急跌, SPY 反转开始
15:02     1.80   1.94   1.67   1.89    1115
15:03     1.90   1.91   1.46   1.49    1486
15:04     1.49   1.61   1.43   1.48    1696
15:05     1.47   1.50   1.32   1.41    1079
15:06     1.42   1.72   1.35   1.61    1293
15:07     1.60   1.78   1.60   1.66    1720
15:08     1.65   1.72   1.51   1.55     968
15:09     1.53   1.74   1.53   1.72     522
15:10     1.72   1.72   1.50   1.68     748
15:11     1.68   2.00   1.67   1.99    2624    ← 短暂反弹
15:12     2.01   2.04   1.66   1.75    1501
15:13     1.73   1.94   1.70   1.84    1612
...
15:33     2.03   2.36   1.92   2.15    3678    ← 第二次反弹
15:34     2.13   2.32   2.13   2.19    1620
...
15:45     1.82   1.88   1.59   1.63    1430    ← 实际止损区域
15:46     1.61   1.77   1.56   1.60     573
15:47     1.60   1.64   1.21   1.21    1355
...
16:00     0.98   1.03   0.93   0.94    1192    ← 最终崩塌
...到期归零
```

#### 10.2.2 SPY.US (标的)

```
时间(UTC)   Open      High      Low       Close     Vol        备注
14:53     678.380  678.530  677.630  677.680  220502
14:54     677.655  677.970  677.655  677.818  159077
14:55     677.840  677.900  677.150  677.280  188488
14:56     677.290  677.640  676.970  677.340  235833
14:57     677.360  677.910  677.270  677.380  158547
14:58     677.390  677.410  676.874  676.950  162833     ← 逼近底部
14:59     676.960  676.980  676.460  676.630  211046     ← 极度接近底部
15:00     676.620  676.880  676.270  676.880  195753     ← 日内最低 676.27, V 型反转
15:01     676.870  677.550  676.640  677.380  159969     ← 反转拉升
15:02     677.360  677.650  677.050  677.170  147512
15:03     677.140  678.190  677.115  678.090  130095     ← 强势反弹
```

### 10.3 逐分钟模拟推演

#### 10.3.1 T=14:58:55 UTC — 信号生成

系统评估结果:

| 项目 | 值 | 说明 |
|------|-----|------|
| 综合得分 | -17.6 | BEARISH, 远超入场阈值 -12 |
| 大盘得分 | -28.8 | 极端看空 |
| SPY 价格 | ~676.95 | 14:58 蜡烛收盘 |

**Fix 1 判定**: `zdteCooldownMinutes = 0`, 0DTE 禁入窗口已取消, `skip0DTE = false`, 允许选择 0DTE 合约。

**Fix 3 VWAP 结构确认判定**:

SPY 当日开盘价约 679.1, 全天以下跌为主, 成交量加权平均价 (VWAP) 在 14:58 时刻估算约 **678.0-678.5** (因开盘区间成交量集中在较高价位, VWAP 高于当前价)。取 VWAP ≈ 678.2 进行验证:

```
PUT 结构确认条件: 最近 2 根 1 分钟蜡烛收盘价 < VWAP

14:57 蜡烛收盘: 677.380 < 678.2  ✓
14:58 蜡烛收盘: 676.950 < 678.2  ✓

→ 连续 2 根 1 分钟蜡烛收盘均低于 VWAP
→ PUT 结构确认: 通过 ✓
→ 无反转形态检测 (SPY 仍在持续下跌中)
```

**连续确认判定**: `consecutiveConfirmCycles: 2`, 当前为第 1/2 次 BEARISH 信号, **需等待第二次确认**。

**本轮结果**: 信号记录为 BEARISH 1/2, 等待下一评估周期。

#### 10.3.2 T≈14:59:00 UTC — 连续确认通过

系统每 ~5 秒评估一次。约 5 秒后的下一评估周期:

| 项目 | 值 | 说明 |
|------|-----|------|
| SPY 价格 | ~676.96 (14:59 蜡烛开盘) | 仍在低位, 尚未反弹 |
| 综合得分 | 仍为强 BEARISH | 5 秒内得分不会显著变化 |
| 连续确认 | BEARISH 2/2 | 同向信号连续出现, **确认通过** ✓ |

```
→ 连续确认 2/2 通过
→ VWAP 结构确认已在上一周期通过
→ 系统决定入场, 开始合约选择和订单提交
→ 订单提交耗时约 2 秒
```

#### 10.3.3 T≈14:59:02 UTC — 订单提交与成交

合约选择: SPY260217P676000 (0DTE PUT, 行权价 676)

**入场价格估算**:

14:59 蜡烛数据: Open=2.11, High=2.29, Low=2.08, Close=2.21

在 14:59:00-14:59:02 时段, 期权价格处于蜡烛开盘附近, 约 $2.11-2.15。系统以限价单提交 (Fix 1 取消冷却窗口后, 信号价与市场价偏差较小, 不会触发市价单升级):

```
信号价: ~$2.11
限价单提交: $2.11-2.15
市场成交: 约 $2.12 (取合理中位估计)
```

**估算成交价: $2.12**

#### 10.3.4 T≈14:59:05 UTC — TSLPPCT 跟踪止损提交

**Fix 5 生效**: 买入订单成交后, 系统立即提交 TSLPPCT (券商侧百分比追踪止盈单)。

| TSLPPCT 参数 | 值 | 说明 |
|-------------|-----|------|
| trailing (回撤百分比) | 15% | 0DTE 强制覆盖: `is0DTE → Math.min(current, 15%)` |
| limitOffset | $0.10 | 触发后限价单偏移量 |
| 起始跟踪价 | ~$2.12 | 从成交价开始跟踪 |

### 10.4 TSLPPCT 运作机制详解

TSLPPCT 是券商侧的百分比追踪止损单, 与系统侧的监控逻辑完全独立。其核心机制:

```
┌─────────────────────────────────────────────────────────┐
│                   TSLPPCT 运作原理                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. 券商持续跟踪持仓期间的 最高水位 (High Water Mark)      │
│                                                         │
│  2. 触发条件: 当前价格 ≤ 最高水位 × (1 - trailing%)       │
│     即: 价格从峰值回落超过 trailing% 时触发               │
│                                                         │
│  3. 触发后: 转为限价卖出单                                │
│     限价 = 触发价 - limitOffset                          │
│                                                         │
│  4. 独立于系统: 即使系统宕机, 券商仍会执行                 │
│                                                         │
│  示例 (trailing=15%, limitOffset=$0.10):                 │
│    入场 $2.12 → 价格涨至 $2.39 (新最高水位)              │
│    触发价 = $2.39 × 0.85 = $2.03                        │
│    价格跌至 $2.03 → 触发! 提交限价卖出 @ $1.93           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**关键特性**:
- 最高水位 **只升不降**: 一旦价格创新高, 水位上移; 价格回落时水位不变
- 触发价格 **动态上移**: 随最高水位上升而上升, 保护利润
- 券商侧执行: 不受系统评估间隔 (5 秒) 的限制, 反应更快

### 10.5 持仓期间逐分钟推演

以下基于 1 分钟 K 线, 逐分钟追踪 TSLPPCT 最高水位和触发状态:

#### 10.5.1 14:59 蜡烛 (入场后第一分钟)

```
入场: ~$2.12 @ 14:59:02
14:59 蜡烛: Open=2.11, High=2.29, Low=2.08, Close=2.21

TSLPPCT 最高水位: $2.29 (14:59 蜡烛的 High)
触发价 (15%): $2.29 × 0.85 = $1.95
14:59 最低价: $2.08 > $1.95 → 未触发
```

#### 10.5.2 15:00 蜡烛 (关键蜡烛 — SPY 触底)

```
15:00 蜡烛: Open=2.24, High=2.39, Low=2.05, Close=2.05

TSLPPCT 最高水位: $2.39 (新高! 从 $2.29 上移至 $2.39)
触发价 (15%): $2.39 × 0.85 = $2.03
15:00 最低价: $2.05 > $2.03 → 未触发 (仅差 $0.02!)

注: 这根蜡烛极为关键。Put 期权在 SPY 触及 676.27 日内最低时
达到峰值 $2.39, 随后 SPY 反转, Put 在同一蜡烛内从 $2.39 跌至 $2.05。
最低价 $2.05 距触发价 $2.03 仅 $0.02, 但 TSLPPCT 在本蜡烛内
未被触发。
```

#### 10.5.3 15:01 蜡烛 (TSLPPCT 触发!)

```
15:01 蜡烛: Open=2.05, High=2.15, Low=1.73, Close=1.81

TSLPPCT 最高水位: $2.39 (未突破, 维持不变)
触发价 (15%): $2.03

价格走势: 2.05 → ... → 跌穿 $2.03 → ... → 1.73
                          ↑
                    TSLPPCT 在此触发!

触发后行为:
  券商将 TSLPPCT 转为限价卖出单
  限价 = $2.03 - $0.10 = $1.93
  卖出范围: $1.93 ~ $2.03 之间成交

15:01 蜡烛成交量: 2143 张, 流动性充足
价格从 $2.05 下穿 $2.03 的过程中, 限价卖出单大概率获得成交
```

**TSLPPCT 卖出成交价估算**:

价格从 $2.05 开盘向下穿越 $2.03 的过程中, 限价单 (下限 $1.93) 会在 $1.93-$2.03 之间寻求成交。考虑到:
- 蜡烛开盘 $2.05, 价格初期仍在 $2.03 附近
- 触发时价格正好在 $2.03, 限价单有足够空间获得执行
- 成交量 2143 张, 不存在流动性问题

**保守估计成交价: $1.97** (触发价与限价下限的中位附近)

### 10.6 盈亏计算

#### 10.6.1 修复后模拟结果

| 项目 | 金额 | 说明 |
|------|------|------|
| 买入成本 | $2.12 x 100 = $212.00 | 14:59:02 UTC 限价单成交 |
| 卖出收入 | $1.97 x 100 = $197.00 | 15:01 TSLPPCT 触发成交 |
| 手续费 | ~$2.64 | 买卖各一笔 |
| **净盈亏** | **-$17.64 (-8.3%)** | |
| 持仓时长 | ~2 分钟 | 14:59:02 → 15:01:xx |

#### 10.6.2 与实际交易结果对比

| 对比维度 | 实际交易 (HEAD 代码) | 修复后模拟 | 改善幅度 |
|---------|--------------------|-----------|---------|
| 入场时间 | 15:00:42 UTC | ~14:59:02 UTC | 早 ~100 秒 |
| 入场价格 | $2.09 | ~$2.12 | 略高 $0.03 (入场时 Put 仍在上升) |
| 峰值捕获 | 未捕获 (入场时已过峰值) | $2.39 (TSLPPCT 跟踪) | TSLPPCT 记录了完整峰值 |
| 出场机制 | 0DTE 兜底止损 -25% | TSLPPCT 15% 回撤触发 | 更早止损, 更小亏损 |
| 出场时间 | 15:47:16 UTC | ~15:01:xx UTC | 早 ~46 分钟 |
| 出场价格 | $1.46 | ~$1.97 | 高 $0.51 |
| **净亏损** | **-$66.14 (-31.4%)** | **-$17.64 (-8.3%)** | **减少 $48.50, 改善 23.1 个百分点** |

**核心改善来源**: TSLPPCT 在 Put 从峰值 $2.39 回落 15% 时自动触发卖出, 将亏损控制在 -8.3%, 而非等待 46 分钟后以 -31.4% 止损。

### 10.7 敏感性分析

#### 10.7.1 TSLPPCT 回撤百分比敏感性

固定入场价 $2.12, 峰值 $2.39, 分析不同 trailing% 下的出场结果:

| Trailing % | 触发价 | 触发时间 | 估算成交价 | 净盈亏 ($) | 净盈亏 (%) | 结果评价 |
|-----------|--------|---------|-----------|-----------|-----------|---------|
| 8% | $2.20 | 15:00 蜡烛 | ~$2.18 | +$3.36 | +1.6% | **小幅盈利** |
| 10% | $2.15 | 15:00 蜡烛 | ~$2.13 | -$1.64 | -0.8% | **近乎保本** |
| 12% | $2.10 | 15:00-15:01 | ~$2.05 | -$9.64 | -4.5% | 小幅亏损 |
| **15% (当前 0DTE 默认)** | **$2.03** | **15:01 蜡烛** | **~$1.97** | **-$17.64** | **-8.3%** | **可控亏损** |
| 20% | $1.91 | 15:01 蜡烛 | ~$1.87 | -$27.64 | -13.0% | 中等亏损 |
| 25% (当前 0dte_pnl_floor) | $1.79 | 15:01 蜡烛 | ~$1.75 | -$39.64 | -18.7% | 较大亏损 |
| 无 TSLPPCT (实际结果) | N/A | 15:47 (兜底止损) | $1.46 | -$66.14 | -31.4% | 严重亏损 |

**关键发现**:

1. trailing ≤ 10% 时可实现保本或小幅盈利, 因为触发发生在 15:00 蜡烛内 (Put 从 $2.39 回落到 $2.15-2.20 区间), 此时价格仍处于较高位
2. trailing = 15% (当前默认) 时亏损 -8.3%, 虽然仍为亏损, 但相比实际 -31.4% 改善显著
3. trailing ≥ 20% 时亏损持续扩大, 但仍优于无 TSLPPCT 的结果
4. **盈亏分水岭在 trailing = 10% 附近**

#### 10.7.2 入场时间敏感性

固定 TSLPPCT trailing=15%, 分析不同入场时间的结果:

| 入场时间 (UTC) | 入场时间 (ET) | 估算入场价 | 峰值 | 触发价 (15%) | 估算出场价 | 净盈亏 | 净盈亏 (%) |
|---------------|-------------|-----------|------|-------------|-----------|--------|-----------|
| 14:55 | 09:55 | ~$2.05 | $2.39 | $2.03 | ~$1.97 | -$10.64 | -5.2% |
| 14:56 | 09:56 | ~$2.06 | $2.39 | $2.03 | ~$1.97 | -$11.64 | -5.6% |
| 14:58 | 09:58 | ~$2.10 | $2.39 | $2.03 | ~$1.97 | -$15.64 | -7.5% |
| **14:59 (模拟)** | **09:59** | **~$2.12** | **$2.39** | **$2.03** | **~$1.97** | **-$17.64** | **-8.3%** |
| 15:00:42 (实际) | 10:00:42 | $2.09 | -- | -- | $1.46 (兜底) | -$66.14 | -31.4% |

**关键发现**:

1. **入场时间对触发价无影响**: 无论何时入场, 峰值均为 $2.39, 触发价均为 $2.03, 因为 15:00 蜡烛的 $2.39 是所有入场时点之后的共同最高水位
2. **入场越早, 入场价越低, 亏损越小**: 14:55 入场比 14:59 入场少亏约 $7, 因为入场价低了 ~$0.07
3. **实际交易 (15:00:42) 的灾难性结果**: 入场太晚导致 (a) 错过峰值 $2.39 (入场时已过), (b) 无 TSLPPCT 保护, (c) 等待 46 分钟后才以兜底止损出场。Fix 1 (取消禁入窗口) 将入场提前 ~100 秒, 使系统能够捕获到 $2.39 峰值, 与 Fix 5 (TSLPPCT) 形成协同效应

#### 10.7.3 TSLPPCT 回撤百分比 x 入场时间交叉分析

| | trailing 8% | trailing 10% | trailing 15% | trailing 20% |
|---|---|---|---|---|
| 入场 14:55 @ $2.05 | +$10.36 (+5.1%) | +$5.36 (+2.6%) | -$10.64 (-5.2%) | -$20.64 (-10.1%) |
| 入场 14:58 @ $2.10 | +$5.36 (+2.6%) | +$0.36 (+0.2%) | -$15.64 (-7.5%) | -$25.64 (-12.2%) |
| **入场 14:59 @ $2.12** | **+$3.36 (+1.6%)** | **-$1.64 (-0.8%)** | **-$17.64 (-8.3%)** | **-$27.64 (-13.0%)** |
| 入场 15:00:42 @ $2.09 (无 TSLPPCT) | -- | -- | -- | **-$66.14 (-31.4%)** |

**交叉分析结论**:

- 只有 trailing ≤ 10% 的配置能在本次交易中实现盈利或保本
- 即使是最保守的 trailing 20%, 任何入场时间都优于实际的 -31.4% 亏损
- **最优组合**: 14:55 入场 + 8% trailing = **+$10.36 (+5.1%)**, 但 14:55 入场需要 0DTE 禁入窗口更早取消, 且该入场时间取决于信号何时首次达到阈值

### 10.8 修复方案各项贡献度分析

5 项修复在本次模拟中各自的贡献:

| 修复 | 对入场的影响 | 对出场的影响 | 贡献度 |
|------|-----------|-----------|--------|
| Fix 1: 取消禁入窗口 | **关键** — 入场提前 ~100 秒, 从 15:00:42 提前至 ~14:59:02, 使 TSLPPCT 能捕获 $2.39 峰值 | 间接 — 更早入场意味着更早提交 TSLPPCT | 高 |
| Fix 2: 尾盘 180→120 分钟 | 无影响 — 入场在 10:00 ET, 距尾盘禁入时间 (14:00 ET) 很远 | 无影响 | 无 |
| Fix 3: 修复 VWAP | **通过** — 14:58:55 时 SPY 连续 2 根 1 分钟蜡烛收盘 < VWAP, PUT 结构确认通过, 不阻止入场 | 无影响 | 低 (本次场景下 VWAP 放行入场) |
| Fix 4: 取消降级放行 | 安全网 — 本次 Fix 3 已使 VWAP 正常工作并通过确认, Fix 4 作为备份未实际触发 | 无影响 | 无 (但作为安全兜底很重要) |
| Fix 5: TSLPPCT | 无影响 — TSLPPCT 不影响入场决策 | **关键** — 从峰值 $2.39 回撤 15% 时触发卖出 @ ~$1.97, 将亏损从 -31.4% 缩小至 -8.3% | **最高** |

**贡献度排名**:
1. **Fix 5 (TSLPPCT)**: 贡献最大, 直接将出场从 -31.4% 改善至 -8.3%, 改善幅度 $48.50
2. **Fix 1 (取消禁入窗口)**: 协同贡献, 使入场提前从而 TSLPPCT 能捕获峰值, 如果没有 Fix 1 而仍在 15:00:42 入场, 即使有 TSLPPCT 也无法跟踪到 $2.39 峰值 (入场时已过)
3. **Fix 3 (修复 VWAP)**: 本次场景下通过确认, 未阻止入场; 但在 SPY 已反弹的场景中可能阻止入场
4. **Fix 4 (取消降级放行)**: 安全兜底, 本次未触发
5. **Fix 2 (尾盘时间)**: 本次无影响

### 10.9 特殊场景讨论: 如果 VWAP 在 15:00:30 阻止入场?

值得讨论的是: 在实际交易中 (HEAD 代码), 系统在 **15:00:30** UTC 才进行 VWAP 检查。如果 Fix 3 在 15:00:30 时刻检查 VWAP, 结果是否不同?

```
15:00:30 UTC 时刻的 VWAP 检查:
  最近 2 根 1 分钟蜡烛: 14:59 和 15:00 (15:00 蜡烛在 15:00:30 时尚未完成)

  如果检查已完成蜡烛:
    14:58 收盘: 676.950 < VWAP ~678.2  ✓
    14:59 收盘: 676.630 < VWAP ~678.2  ✓
    → PUT 结构确认通过, 允许入场

  如果检查包含正在形成的蜡烛:
    15:00 蜡烛在 15:00:30 时, SPY 已从 676.27 反弹
    15:00 蜡烛收盘 676.880 < VWAP ~678.2 → 仍然通过
    → PUT 结构确认通过
```

结论: **即使 VWAP 在 15:00:30 正常工作, 也会放行入场**, 因为 SPY 虽已触底反弹, 但 15:00 蜡烛的收盘价 676.880 仍然低于 VWAP (~678.2)。VWAP 结构确认在本次极端 V 型反转中无法有效拦截, 因为反弹幅度不足以使收盘价站上 VWAP。

这进一步证实了 **Fix 5 (TSLPPCT) 是本次场景中唯一能有效减少亏损的修复**, 而 VWAP 的价值在于过滤更温和的反转场景。

### 10.10 结论与建议

#### 10.10.1 模拟核心结论

1. **5 项修复全部生效后, 本次交易仍为亏损 (-$17.64, -8.3%)**, 但相比实际亏损 (-$66.14, -31.4%) **改善了 $48.50 (23.1 个百分点)**

2. **TSLPPCT 是最关键的改善因素**: 券商侧追踪止损在 Put 从 $2.39 峰值回落 15% 时自动触发, 将持仓时间从 46 分钟缩短至 ~2 分钟, 出场价从 $1.46 提升至 ~$1.97

3. **取消禁入窗口与 TSLPPCT 存在协同效应**: Fix 1 使入场提前 ~100 秒, 使 TSLPPCT 能捕获到 $2.39 的完整峰值; 如果仍在 15:00:42 入场, 峰值已过, TSLPPCT 无法发挥最大作用

4. **VWAP 在本次极端场景下无法有效拦截**: 无论在 14:58:55 还是 15:00:30 检查, SPY 价格均低于 VWAP, PUT 结构确认都会通过。VWAP 的价值在于过滤 "已经充分反弹" 的场景, 而非 V 型反转的第一时间

5. **这笔交易的根本问题依然存在**: 基于累积动量的评分系统在趋势末端产生最强信号, 无论使用哪个版本的代码, 系统都会在 SPY 接近日内底部时触发 PUT 买入。5 项修复无法解决 "在趋势末端入场" 的结构性缺陷, 但能有效控制损失幅度

#### 10.10.2 TSLPPCT 0DTE 回撤百分比建议

当前 0DTE 默认 trailing=15% 在本次模拟中产生 -8.3% 亏损。基于敏感性分析:

| trailing% | 本次模拟结果 | 风险评估 | 建议 |
|-----------|------------|---------|------|
| 8% | +1.6% (盈利) | 过于敏感, 正常波动可能提前触发, 导致频繁止损 | 不建议作为默认值 |
| **10%** | **-0.8% (近乎保本)** | **平衡点: 能捕获峰值后的较大回撤, 同时避免过度持有** | **建议作为 0DTE 默认值** |
| 12% | -4.5% | 较为宽松, 给予价格更多波动空间 | 可作为备选 |
| 15% (当前) | -8.3% | 对 0DTE 而言过于宽松, 15% 回撤在 0DTE 的剧烈波动中往往意味着趋势已经反转 | 建议下调 |

**建议**: 将 0DTE 的 TSLPPCT 默认 trailing 从 15% **下调至 10%**。理由:

- 0DTE 期权的时间价值衰减极快 (Theta 吞噬), 价格一旦反向移动, 回升概率远低于长期期权
- 15% 的回撤在 0DTE 场景中通常意味着标的已经出现显著反向移动, 而非正常波动
- 10% trailing 在本次模拟中可实现近乎保本 (-0.8%), 在更有利的行情中则能锁定可观利润
- 非 0DTE 期权 (1DTE/2DTE+) 可保持 15% 或更高的 trailing, 因为有更多时间让趋势发展

#### 10.10.3 完整修复方案优先级总结

| 优先级 | 修复项 | 本次模拟中的效果 | 长期价值 |
|--------|-------|-----------------|---------|
| P0 | Fix 5: TSLPPCT 跟踪止损 + trailing 调至 10% | 将亏损从 -31.4% 缩小至 -0.8% | 所有 0DTE 交易的通用出场保护 |
| P0 | Fix 3: 修复 VWAP napi 错误 | 本次通过入场 (未阻止), 但恢复结构确认能力 | 过滤已反转行情的关键安全网 |
| P1 | Fix 1: 取消/缩短禁入窗口 | 入场提前 ~100 秒, 与 TSLPPCT 协同 | 消除边界效应, 但需权衡开盘噪声过滤价值 |
| P1 | Fix 4: 0DTE 取消降级放行 | 本次未触发 (Fix 3 已修复) | 关键安全兜底, 防止 VWAP 再次故障时放行 |
| P2 | Fix 2: 尾盘 180→120 分钟 | 本次无影响 | 扩大 0DTE 可交易时间窗口 |

---

## 11. 方向确认窗口验证 + 多标的组合分析

### 11.1 方向确认窗口对 5-Fix 模拟的影响

**问题**: Section 10 的模拟是否考虑了 `directionConfirmMinutes: 30` (开盘方向确认窗口)?

**答案**: 模拟结论不受影响。以下为完整验证:

#### SPY 方向确认 + 0DTE 禁入窗口时间线

| 时间 (UTC) | ET | 大盘得分 | 检查点 | 状态 |
|---|---|---|---|---|
| 14:34:55 | 09:34 | +1.6 | direction_confirm | **阻止** — 得分在 [-5, 5], 趋势不明确 |
| 14:37:52 | 09:37 | +2.1 | direction_confirm | **阻止** — 得分在 [-5, 5] |
| 14:44:07 | 09:44 | -1.5 | direction_confirm | **阻止** — 得分在 [-5, 5] |
| 14:46:10 | 09:46 | -0.4 | direction_confirm | **阻止** — 得分在 [-5, 5] |
| 14:48:25 | 09:48 | -2.4 | direction_confirm | **阻止** — 得分在 [-5, 5] |
| **14:52:03** | **09:52** | **-6.07** | **strategy_evaluation** | **方向确认通过** (得分 < -5), 但策略条件未满足 |
| 14:53:34 | 09:53 | -26.72 | — | 信号生成, 但 dir=HOLD (非 PUT 方向) |
| **14:58:56** | **09:58** | **-28.83** | — | **首个 PUT 信号** (连续确认 1/2) |
| **14:59:51** | **09:59** | **-22.32** | — | **第二个 PUT 信号** (连续确认 2/2 ✓) → **入场!** |
| 15:00:41 | 10:00 | -22.21 | — | 实际入场点 (HEAD 代码) |

**关键发现**:

1. **方向确认在 14:52:03 已通过** (大盘得分 -6.07, 低于 -5 阈值), 比模拟入场时间 14:59 **早了 7 分钟**
2. **方向确认不是约束瓶颈** — 真正的约束是:
   - 0DTE 禁入窗口 (Fix 1 移除) → 允许 14:53 后入场
   - 信号方向 (14:53:34 dir=HOLD, 14:58:56 才出现 dir=PUT)
   - 连续确认 (需要 2 个连续 PUT: 14:58:56 + 14:59:51)
3. **模拟入场时间 ~14:59 完全有效** — 即使保留方向确认窗口, 入场时间也不会改变

#### 假设场景: 同时移除方向确认 + 0DTE 禁入窗口

| 场景 | 入场时间 | 原因 |
|---|---|---|
| 仅移除禁入窗口 (当前 5-Fix) | 14:59:51 | 方向确认 14:52 通过, 首个 PUT 信号 14:58:56, 连续确认 14:59:51 |
| 同时移除方向确认 + 禁入窗口 | 14:59:51 | 首个 PUT 信号仍在 14:58:56 (之前为 HOLD), 无法更早入场 |
| 移除所有限制 (含连续确认) | ~14:58:56 | 首个 PUT 信号即入场, 入场价 ~$2.10 |

结论: 即使移除方向确认, 入场时间最多提前 ~55 秒 (14:58:56 vs 14:59:51), 对最终 P&L 影响微小 (~$0.02 入场价差)。

### 11.2 IWM260218P262000.US 交易复盘 (1DTE PUT)

#### 11.2.1 交易重建

```
=== 入场 ===
14:53:35 UTC (09:53 ET) | 信号生成: PUT IWM260218P262000.US
  触发条件: [BEAR_SPREAD] 综合得分 -14.7 ≤ -10, 适合熊市价差
  大盘得分: -26.72, 综合得分: -14.75
  IV: 31.20

14:53:36 UTC | 执行买入
  入场价: $2.67 (市价单成交)
  合约: 1DTE PUT, 行权价 $262, 到期 2026-02-18

14:53:39 UTC | 买入订单成交 (订单 ID: 1208426213035483136)

=== 持仓阶段 ===
14:54:45 → $2.80 (+0.0%, 扣除手续费后)
15:47~15:48 → $3.60 (+34.7%, $93.00 毛利)
峰值盈亏: +36.5% (从移动止损日志)

=== 出场 (软件移动止损) ===
15:48:16 UTC (10:48 ET) | 移动止损触发
  原因: 峰值 +36.5% → 当前 +7.8%, 回撤 28.7% ≥ 15% 阈值
  出场价: $2.89 (市价单成交)
  净盈亏: +$18.36 (+6.8%), 手续费: $2.64
  持仓时间: ~55 分钟
```

#### 11.2.2 IWM 为什么能盈利?

| 因素 | SPY 0DTE (亏损) | IWM 1DTE (盈利) |
|---|---|---|
| 合约类型 | 0DTE → Theta 极速衰减 | 1DTE → Theta 衰减较慢 |
| 入场时间 | 15:00:42 (受禁入窗口限制) | **14:53:36** (无禁入窗口限制) |
| 入场时大盘方向 | SPY 已接近 V 型底部 | IWM 还在下跌趋势中 |
| 出场机制 | 0DTE 兜底止损 -25% 在 15:46 触发 | **软件移动止损** 在 15:48 触发, 锁定利润 |
| 峰值到出场 | 无追踪 → 从峰值跌到 -31.4% | 追踪止损 → 从峰值 +36.5% 回落至 +7.8% |
| 结果 | -$66.14 (-31.4%) | **+$18.36 (+6.8%)** |

**核心差异**: IWM 作为 1DTE 不受 0DTE 禁入窗口限制, 因此在 14:53 即入场 — 比 SPY 早了 **7 分钟**。此时市场仍在下跌, 1DTE PUT 随后跟随市场继续下行至 $3.60 峰值。更重要的是, IWM 持仓有软件移动止损保护, 虽然从峰值回撤较多 (36.5% → 7.8%), 但仍然以盈利出场。

#### 11.2.3 5-Fix 对 IWM 的影响

| 修复 | 对 IWM 1DTE 的影响 |
|---|---|
| Fix 1 (取消 0DTE 禁入) | **无影响** — IWM 是 1DTE, 不受 0DTE 禁入限制, 已在 14:53 入场 |
| Fix 2 (尾盘 180→120) | **无影响** — 入场在 09:53 ET, 远未到尾盘 |
| Fix 3 (修复 VWAP) | **低影响** — 入场时 IWM 明确下跌, VWAP 确认会通过 |
| Fix 4 (取消降级放行) | **低影响** — VWAP 通过则此修复不触发 |
| Fix 5 (TSLPPCT) | **负面影响!** — 1DTE EARLY 阶段 trailing=45%, 峰值 $3.60 × 0.55 = $1.98, 远低于出场价 $2.89; TSLPPCT 不会触发, 需依赖其他出场机制 |

**关键发现**: Fix 5 (TSLPPCT) 对 1DTE 的影响是**负面**的。当前软件移动止损 (15% PnL 回撤) 比 TSLPPCT 的 45% 价格回撤更为敏感, 更能保护利润。如果 TSLPPCT 替换而非补充软件追踪止损, IWM 的出场将延迟, 可能减少利润甚至转为亏损。

**建议**: TSLPPCT 应**补充**而非替换现有的软件移动止损, 或者为 1DTE/2DTE 设置更合理的 trailing 参数 (如 20-25% 而非 45%)。

### 11.3 IWM260217P263000.US (0DTE) — 未交易

IWM 0DTE PUT 合约在 15:15~15:31 UTC 期间被持续评估但始终被 Delta 过滤器拒绝:

```
|Delta| 0.83~0.87 > 0.6 阈值 → 跳过
```

这是 Delta 过滤器正确工作的表现 — 深度实值 (deep ITM) 0DTE 期权 Delta 接近 1.0, 本质上是标的资产的替代品, 权利金高且 Gamma 收益低, 不适合日内期权策略。

### 11.4 其他标的信号分析 (QQQ, TSLA, MU)

2 月 17 日, 系统评估了 5 个标的: SPY, IWM, QQQ, TSLA, MU。由于策略采用单持仓模式, IWM 在 14:53 入场后, 其他标的的信号虽然持续生成, 但无法触发新的买入。

| 标的 | 方向确认通过时间 | 首个 PUT 信号 | 是否入场 | 原因 |
|---|---|---|---|---|
| **IWM.US** | 14:50:29 (mkt=-6.5) | 14:53:35 (1DTE) | **是 ✓** | 首个通过所有检查的信号, 1DTE 无禁入限制 |
| **SPY.US** | 14:52:03 (mkt=-6.1) | 14:58:56 (0DTE) | **是 ✓** | 15:00 禁入解除后入场 |
| QQQ.US | 14:51:00 (mkt=-7.1) | 14:58:55 | 否 | 已持有 IWM + SPY, 无可用资金/仓位 |
| TSLA.US | 14:49:57 (mkt=-5.7) | 14:58:56 | 否 | 已持有 IWM + SPY |
| MU.US | 14:43:52 (mkt=-19.2*) | 14:58:56 | 否 | 已持有 IWM + SPY |

*MU 在 14:43:52 大盘得分 -19.2 但通过的是 strategy_evaluation (策略条件不满足), 方向确认在此之前可能已通过。

**所有标的在 14:51-14:52 时大盘得分均突破 -5 阈值**, 方向确认几乎同步通过, 这是因为 marketScore 是大盘指标 (SPY/QQQ 综合), 对所有标的使用相同的值。

### 11.5 组合盈亏总结

#### 11.5.1 实际盈亏 (HEAD 代码)

| 交易 | 合约 | 方向 | 入场 | 出场 | 净盈亏 |
|---|---|---|---|---|---|
| SPY260217P676000.US | 0DTE PUT | PUT | $2.09 @ 15:00:42 | $1.46 @ 15:46 | **-$66.14 (-31.4%)** |
| IWM260218P262000.US | 1DTE PUT | PUT | $2.67 @ 14:53:36 | $2.89 @ 15:48 | **+$18.36 (+6.8%)** |
| IWM260217P263000.US | 0DTE PUT | — | 未入场 (Delta > 0.6) | — | $0.00 |
| | | | | **组合总计** | **-$47.78** |

#### 11.5.2 5-Fix 模拟盈亏

| 交易 | 5-Fix 变化 | 模拟入场 | 模拟出场 | 模拟净盈亏 |
|---|---|---|---|---|
| SPY 0DTE PUT | Fix 1 提前入场, Fix 5 TSLPPCT 保护 | ~$2.12 @ 14:59:51 | ~$1.97 (TSLPPCT 15%) | **-$17.64 (-8.3%)** |
| IWM 1DTE PUT | 基本无变化 (1DTE 不受 0DTE 修复影响) | $2.67 @ 14:53:36 | $2.89 (软件追踪) | **+$18.36 (+6.8%)** |
| | | | **组合总计** | **+$0.72 (≈ 保本)** |

#### 11.5.3 敏感性: 不同 TSLPPCT trailing% 下的组合盈亏

| SPY trailing% | SPY P&L | IWM P&L | **组合 P&L** | vs 实际 |
|---|---|---|---|---|
| 8% | +$3.36 | +$18.36 | **+$21.72** | 改善 $69.50 |
| **10% (建议)** | **-$1.64** | **+$18.36** | **+$16.72** | **改善 $64.50** |
| 12% | -$7.14 | +$18.36 | +$11.22 | 改善 $59.00 |
| 15% (当前默认) | -$17.64 | +$18.36 | +$0.72 | 改善 $48.50 |
| 无 TSLPPCT (实际) | -$66.14 | +$18.36 | -$47.78 | 基线 |

### 11.6 综合结论

1. **方向确认窗口对 Section 10 模拟无影响** — 方向确认在 14:52 即通过, 比模拟入场时间早 7 分钟, 不构成约束

2. **IWM 1DTE 交易是当日唯一盈利交易** — 得益于: (a) 1DTE 不受 0DTE 禁入限制, 提前 7 分钟入场; (b) 软件移动止损有效保护了利润

3. **5-Fix 将组合从 -$47.78 改善至约保本** — SPY 亏损从 -$66.14 缩小至 -$17.64, 被 IWM 盈利 +$18.36 抵消

4. **TSLPPCT trailing 10% 可使组合整体盈利 +$16.72** — 这是最具可操作性的单一改进

5. **TSLPPCT 对 1DTE+ 需要不同参数** — 当前 EARLY 阶段 45% trailing 对 1DTE 过于宽松, 软件追踪止损 (15% PnL 回撤) 实际上更有效。建议:
   - 0DTE: TSLPPCT trailing 10% (本文建议)
   - 1DTE: TSLPPCT trailing 20-25% 或保留软件追踪止损
   - 2DTE+: TSLPPCT trailing 30-35%

6. **系统的 "多标的分散" 策略发挥了作用** — IWM 的 +$18.36 对冲了部分 SPY 的 -$66.14, 如果只有 SPY 单一标的, 当日亏损将更严重。但分散效果有限, 因为所有标的使用相同的大盘得分, 在市场整体反转时会同向交易

---

## 12. 旧代码会买 PUT 还是 CALL? — 动量追踪陷阱的本质

### 12.1 问题提出

Section 7-10 的分析隐含了一个假设: 所有版本的代码都会买 PUT。但既然系统在市场触底时买入 PUT (等价于在 PUT 价格最高点买入), 那如果系统买的是 CALL, 岂不是大赚? 旧代码在 2月17日的市场行情下, 到底会买 PUT 还是 CALL?

### 12.2 信号方向决策逻辑

策略配置 (所有版本通用):
```
riskPreference: AGGRESSIVE
strategyTypes.buyer: ['BULL_SPREAD', 'BEAR_SPREAD']
```

AGGRESSIVE 模式下的评估逻辑:
```typescript
// 遍历顺序: BULL_SPREAD → BEAR_SPREAD (先看是否买 CALL)
for strategy in ['BULL_SPREAD', 'BEAR_SPREAD']:
  if strategy == 'BULL_SPREAD':
    if finalScore >= 10  → CALL 买入 (牛市价差)
  elif strategy == 'BEAR_SPREAD':
    if finalScore <= -10 → PUT 买入 (熊市价差)

// 如果 -10 < finalScore < 10 → 无信号
```

### 12.3 旧代码 (22901e7) 在 2月17日的逐分钟模拟

旧代码无任何前期保护 (无禁入窗口、无方向确认、无连续确认、无 VWAP), 从 14:30 开市即可交易:

| 时间 (UTC) | ET | 大盘得分 | **综合得分** | 旧代码判定 (±10 阈值) |
|---|---|---|---|---|
| 14:34:55 | 09:34 | +1.62 | **+1.38** | \|1.38\| < 10 → **无信号** |
| 14:37:52 | 09:37 | +2.13 | **+3.84** | \|3.84\| < 10 → **无信号** |
| 14:44:07 | 09:44 | -1.52 | **+3.34** | \|3.34\| < 10 → **无信号** |
| 14:46:10 | 09:46 | -0.43 | **+3.78** | \|3.78\| < 10 → **无信号** |
| 14:48:25 | 09:48 | -2.43 | **+0.34** | \|0.34\| < 10 → **无信号** |
| 14:52:03 | 09:52 | -6.07 | **-3.56** | \|3.56\| < 10 → **无信号** |
| **14:53:34** | **09:53** | **-26.72** | **-14.75** | **-14.75 ≤ -10 → PUT 买入!** |

**结论: 旧代码依然会买 PUT, 不可能买 CALL。**

市场开盘后 20 分钟的微涨从未使 finalScore 达到 +10:
- 最高 finalScore 仅为 +3.84 (14:37), 远低于 BULL_SPREAD 的 +10 阈值
- 市场随后转跌, 14:53 时 finalScore 急跌至 -14.75, 突破 -10 触发 PUT

### 12.4 旧代码退出模拟 — 发现移动止损 bug

旧代码在 14:53:34 买入 PUT @ ~$1.80 后的完整退出路径:

**旧代码退出参数 (BUYER, EARLY 阶段)**:
```
止盈: +50% ($2.70)
止损: -35% ($1.17)
移动止损触发: 盈利 ≥ 30%
移动止损回撤: 15%
安全阀: -50% ($0.90)
收盘前强制: 10 分钟 (15:50 ET)
```

**移动止损 bug (旧代码 line 344-346)**:
```typescript
// 实际应该追踪历史最高盈利, 但旧代码做了简化:
const peakPnLPercent = ctx.currentPrice > ctx.entryPrice
  ? pnl.netPnLPercent * 1.1  // "假设当前接近峰值"
  : pnl.netPnLPercent;

// 结果: drawdown = peak - current = current*1.1 - current = current*0.1
// drawdown 永远约等于当前盈利的 10%, 几乎不可能超过 15% 的回撤阈值!
```

**这意味着旧代码的移动止损形同虚设。**

**逐分钟走势**:
```
入场: $1.80 @ 14:53:34 (信号: BEAR_SPREAD, finalScore=-14.75)
14:55: $2.05 (+13.9%) → 移动止损未触发 (盈利 < 30%)
14:59: $2.21 (+22.8%) → 移动止损未触发 (盈利 < 30%)
15:00: $2.39 (+32.8%) → 盈利 > 30%, 启用移动止损!
  但 peak = 32.8% * 1.1 = 36.1%, drawdown = 3.3% < 15% → 不卖出
15:00 末: $2.05 (+13.9%) → peak = 13.9% * 1.1 = 15.3%, drawdown = 1.4% → 不卖出!
15:01: $1.81 (+0.6%) → peak = 0.6% * 1.1 = 0.7%, drawdown = 0.1% → 不卖出
15:03: $1.49 (-17.2%) → 盈利为负, 移动止损不生效; -17.2% > -35% → 不止损
15:05: $1.41 (-21.7%) → -21.7% > -35% → 不止损
15:15: $1.84 (+2.2%) → 价格反弹, 依然持有
16:15: $0.31 (-82.8%) → 0DTE 时间衰减, 远超 -50% 安全阀

但安全阀检查可能在 $0.90 (-50%) 附近触发, 具体取决于:
  - $1.80 * 0.50 = $0.90 → 16:xx 某个时间点
  - 或持有到收盘前 10 分钟强制平仓 @ ~$0.26-0.34
```

**旧代码最终结果**: 约 **-$1.46 ~ -$1.54 (-81% ~ -86%)**, 远比新代码 -$0.66 (-31.4%) 更差。

### 12.5 动量追踪陷阱的本质

```
                市场走势 (SPY)
    678 ╲
         ╲                      ╱ 679
          ╲                   ╱
           ╲               ╱
            ╲           ╱
             ╲676.27 (底)

    评分: +2  -3  -6  ★-28★  -22  -15  -10
                       ↑
                这里评分最极端
                = PUT 信号最强
                = 但市场已到底部!
```

**这是所有动量追踪系统的结构性缺陷**:

1. **累积动量在趋势末端最强**: 市场连续下跌 → 累积的看跌动量 (marketScore) 越来越大 → 在市场触底时达到峰值 (-28.83)
2. **评分系统有内在滞后**: 评分基于过去的价格变化, 当评分足够极端触发信号时, 驱动价格变化的力量往往已经耗尽
3. **V 型反转是最致命的场景**: 快速下跌 → 产生极端 PUT 信号 → 系统在底部买入 PUT → 市场立即反弹 → PUT 价值迅速蒸发

**所有版本的代码 (旧、中间、新) 都会在这个场景中买 PUT**, 区别仅在于:
- 旧代码: 更早入场 (14:53), 入场价更低 ($1.80), 但无有效退出保护 → **-83%**
- 新代码: 较晚入场 (15:00), 入场价更高 ($2.09), 但有 0DTE 兜底止损 → **-31.4%**
- 5-Fix: 适中入场 (14:59), 有 TSLPPCT → **-8.3% ~ -0.8%**

### 12.6 本节结论

| 代码版本 | 方向 | 入场价 | 出场机制 | 出场价 | **P&L** |
|---|---|---|---|---|---|
| 旧代码 (22901e7) | PUT | ~$1.80 | 安全阀/收盘强制 | ~$0.30 | **-$1.50 (-83%)** |
| 中间版本 (a36fa86) | PUT | ~$1.85 | 兜底止损 | ~$1.30 | **-$0.55 (-30%)** |
| 当前代码 (HEAD) | PUT | $2.09 | 0DTE 兜底 -25% | $1.46 | **-$0.66 (-31.4%)** |
| 5-Fix + TSLPPCT 10% | PUT | ~$2.12 | TSLPPCT 10% | ~$2.10 | **-$0.02 (-0.8%)** |

**旧代码不仅不会买 CALL, 而且因为缺乏有效退出保护, 是所有版本中亏损最严重的。** 新代码引入的 0DTE 兜底止损 (-25%) 虽未能避免亏损, 但将损失控制在 -31.4%, 相比旧代码的 -83% 是巨大的改进。

**真正的问题不是 PUT vs CALL, 而是评分系统的动量滞后导致系统在趋势末端产生最强信号。** 要解决这个结构性缺陷, 需要:
1. **反转检测**: 在动量信号之上叠加反转预警 (如 RSI 超卖/超买、成交量衰减、价格加速度变化)
2. **信号衰减**: 极端评分时降低信号强度 (当 marketScore 极端时, 可能意味着趋势即将耗尽)
3. **入场延迟 + 确认**: 极端信号后等待价格确认 (当前的连续确认是朝这个方向的改进, 但不够)
4. **TSLPPCT 作为安全网**: 即使入场时机错误, 券商侧追踪止损也能限制损失 (本文最强建议)

---

## 13. 2月18日交易复盘 — TSLA260218C417500.US (1DTE CALL)

> 本节基于 Docker 日志 (trading-app-log.csv) 复盘 2026-02-18 (美东时间) 的交易情况。

### 13.1 交易概览

| 维度 | 买入 | 卖出 |
|------|------|------|
| 合约 | TSLA260218C417500.US (1DTE CALL, 行权价 $417.50) | 同左 |
| 订单 ID | 1208793439781523456 | 1208798099191906304 |
| 方向 | Buy (Market Order) | Sell (Market Order) |
| 成交价格 | $1.30 | $0.48 |
| 数量 | 3 张 | 3 张 |
| 成交时间 (UTC) | 15:12:50 | 15:31:21 |
| 成交时间 (ET) | 10:12:50 | 10:31:21 |
| 信号得分 | 综合得分 +13.9 | -- |
| 触发原因 | [BULL_SPREAD] 综合得分13.9≥12(0DTE加严) | [STOP_LOSS] 结构失效: CALL持仓但标的连续2根1m收盘(411.83,411.95)跌破VWAP(412.84) |

### 13.2 盈亏明细

| 项目 | 金额 |
|------|------|
| 买入成本 | $1.30 x 3 x 100 = $390.00 |
| 卖出收入 | $0.48 x 3 x 100 = $144.00 |
| **净亏损** | **-$246.00 (-63.1%)** |
| 持仓时长 | ~18 分钟 |

### 13.3 关键时序

```
15:03:57 UTC  BULL_SPREAD 信号首次达到阈值 (得分 ~13), 但被价格确认等待阻止
              "价格确认首次记录，等待确认"
15:03:59 ~    价格确认等待：移动0.000% < 0.03% (反复出现)
15:12:00      RSI 过滤拦截 QQQ (RSI=82.5), SPY (RSI=77.9)
15:12:42      VWAP 结构确认通过: TSLA.US CALL last2=[414.70, 414.68] > VWAP=412.47
15:12:47      NVDA 生成信号 BUY @ $0.66 (但 TSLA 先执行)
15:12:49      TSLA 生成信号 BUY @ $1.25, 使用市价单成交 @ $1.30 (3张)
15:13:34      TSLPPCT 提交失败: "expire date should be after today's date"
              降级到纯监控模式 -- 券商侧追踪止损完全失效
15:13~15:31   持仓监控: 价格持续下跌 $1.30 → $0.51 → $0.49 → $0.48
              盈亏显示异常: "盈亏 +0.0% ($-247.50)" (NaN bug 残留)
15:31:20      动态止盈止损触发: 结构失效 CALL持仓但 TSLA 跌破 VWAP
              净盈亏=$NaN, 手续费=$NaN, 保本价=$NaN
15:31:21      止损市价单成交 @ $0.48 (3张)
15:32:19      释放资金 $1.44
```

### 13.4 信号阻塞统计 (全天)

2 月 18 日系统的信号过滤异常严重:

| 过滤原因 | 触发次数 | 说明 |
|----------|---------|------|
| **RSI 过滤** (超买/超卖) | **1,231 次** | SPY (RSI=77.9) 和 QQQ (RSI=82.5) 被持续拦截 |
| **价格确认等待** (移动 < 0.03%) | **1,801 次** | 价格几乎不动, 确认条件无法满足 |
| 所有策略条件不满足 | 159 次 | 开盘初期得分未达阈值 |
| **实际生成信号** | **10 次** | 其中仅 TSLA 和 NVDA 通过了所有过滤 |
| **实际执行交易** | **1 次** | 仅 TSLA 入场 |

**从 15:03 首次达到阈值到 15:12 实际入场, 价格确认等待延迟了约 9 分钟。** 对期权而言, 9 分钟的延迟足以错过最佳入场窗口。

### 13.5 TSLA 买反方向的验证

系统在 15:12:49 UTC 以 $1.30 买入 TSLA CALL, 此时 TSLA 价格约 $414.70。

TSLA 随后走势:
```
15:12  ~$414.70  (入场, TSLA 当日高点区域)
15:20  ~$413.00  (开始下跌)
15:31  ~$411.83  (VWAP 结构失效止损点, TSLA 已跌近 3 个点)
15:45  ~$410.50  (继续下跌)
```

**如果在同一时间 (15:12:49) 买入 PUT 而非 CALL:**
- TSLA 从 ~$414.70 跌至 ~$411.83 (-0.7%), 对于 ATM PUT 而言, Delta ~0.5 意味着标的跌 $2.87 → PUT 上涨约 $1.40-1.80
- 以类似的入场价 ~$1.30 买入 PUT, 到 15:31 时 PUT 价值约 $2.00-2.50
- **预估盈利 +54% ~ +92%**

这与 2/17 的 SPY 交易形成了完全一致的模式:
- 2/17: 在 SPY 日内底部买入 PUT → 标的反弹 → **PUT 亏损 -31.4%**; 如果买 CALL 则盈利
- 2/18: 在 TSLA 日内顶部买入 CALL → 标的下跌 → **CALL 亏损 -63.1%**; 如果买 PUT 则盈利

**系统连续两天在趋势极端点入场, 且每次都选择了与随后走势相反的方向。**

---

## 14. 策略本质问题 — 当前策略不适合期权交易

### 14.1 问题一: 过度保护导致无法交易

2 月 18 日的信号阻塞数据触目惊心:

```
                    ┌─ RSI 过滤: 1,231 次
信号评估 ──→ 过滤层 ──┤─ 价格确认: 1,801 次     ──→ 10 个信号通过 ──→ 1 笔交易
                    └─ 其他: 159 次               (通过率 0.3%)
```

**3,191 次过滤 vs 1 笔交易, 通过率仅 0.3%。** 问题不在于过滤本身, 而在于这些过滤机制是为 **股票交易** 设计的:

| 过滤机制 | 股票交易合理性 | 期权交易合理性 |
|----------|-------------|-------------|
| RSI 超买/超卖过滤 | 合理 — 等待回调再入场, 成本差异小 | **不合理** — 期权时间价值衰减不等人, RSI 超买时 PUT 正是最佳入场点 |
| 价格确认等待 (移动 > 0.03%) | 合理 — 确认趋势启动, 避免假突破 | **不合理** — 期权价格变化剧烈, 等待确认 = 追高入场 |
| 连续确认 (2 个周期) | 合理 — 减少噪声, 确认趋势持续 | **部分不合理** — 期权需要抓住第一波动, 等确认时行情可能已结束 |
| 0DTE 禁入窗口 (30 分钟) | 合理 — 股票可等待更清晰的方向 | **有争议** — 0DTE 总共只有 6.5 小时, 禁入 30 分钟 = 损失 7.7% 的交易窗口 |

**核心矛盾**: 股票交易追求 "等一等更安全", 期权交易追求 "快进快出抓时间窗口"。当前策略的保守过滤层层叠加, 导致系统一直在等, 等到终于通过所有检查时, 最佳入场时机已过, 反而买在了趋势末端。

### 14.2 问题二: 动量评分的系统性方向滞后

连续两天的交易揭示了一个一致的模式:

```
日期     | 市场走势          | 评分信号    | 系统操作      | 结果
---------|------------------|-----------|-------------|--------
2/17 SPY | 底部 V 型反转      | 极端看空 -17.6 | 买入 PUT     | -31.4%
2/18 TSLA| 顶部开始下跌       | 极端看多 +13.9 | 买入 CALL    | -63.1%
```

**每次都在趋势即将反转的极端点产生最强信号, 而系统恰好在此时完成所有过滤检查并入场。** 这不是巧合, 而是系统设计的必然结果:

1. **评分基于累积动量**: 市场连续上涨/下跌 → 累积动量越来越大 → 在趋势末端评分最极端
2. **过滤层消耗时间**: RSI 确认、价格确认、连续确认等需要持续观察 → 通过所有检查时趋势已充分展开
3. **入场点 = 趋势末端**: 评分最极端 + 所有确认通过 → 恰好是趋势即将反转的时刻
4. **对期权而言是致命的**: 期权买方依赖方向正确 + 快速兑现, 在反转点入场意味着方向立即变为逆向

**这本质上是一个 "确认偏误" 的系统化版本**: 越是确认趋势稳固, 趋势反转的概率越高。对股票而言, 这只是入场价格略差; 对期权而言, 这是致命的 — 因为 Theta (时间价值衰减) 不允许你等待趋势恢复。

### 14.3 问题三: 方向选择与期权特性的根本矛盾

当前策略的方向选择逻辑:
```
finalScore ≥ +12  → 买 CALL (看涨)
finalScore ≤ -12  → 买 PUT  (看跌)
```

这个逻辑隐含的假设是: **当前趋势会继续**。这对股票是合理的 (趋势追踪), 但对期权是危险的:

| 特性 | 股票趋势追踪 | 期权买方 |
|------|------------|---------|
| 持仓时间 | 天~周 | 分钟~小时 |
| 时间成本 | 接近零 | Theta 每秒都在吞噬价值 |
| 方向容错 | 高 — 可以扛回调 | 极低 — 0DTE 反向 5% 可能归零 |
| 盈利模式 | 小幅持续获利 | 必须在短窗口内大幅获利 |
| 入场时机 | 趋势中任何位置均可 | 必须在趋势早期或反转初期 |

**当前策略将股票趋势追踪的逻辑直接套用在期权上, 忽略了期权买方需要精确把握方向反转而非趋势延续的本质。** 如果评分 -17.6 代表"SPY 大幅下跌", 一个期权策略应该考虑的是 "下跌是否已经到位, 是否该买 CALL 做反弹", 而非 "下跌很厉害, 继续买 PUT"。

### 14.4 2/18 具体信号流分析 — 价格确认的致命延迟

```
时间线 (2/18, 所有 UTC):

15:03:57  BULL_SPREAD 得分首次达标 (~13.0), 4 个标的同时触发
          → 价格确认首次记录，开始等待
15:03:59  价格确认等待：移动 0.000% < 0.03%
15:04:11  价格确认等待：移动 0.000% < 0.03%
  ...     (持续 ~9 分钟, 每 3 秒评估一次, 价格几乎不动)
15:12:42  价格确认终于通过 (某个标的的价格移动超过 0.03%)
          → VWAP 结构确认: TSLA CALL 通过, NVDA CALL 通过
          → SPY 被 RSI=77.9 拦截, QQQ 被 RSI=82.5 拦截
15:12:49  TSLA CALL 信号生成并执行, 市价单成交 @ $1.30

问题: 15:03 时 TSLA 可能在 ~$414.00 附近且期权价格更低
      15:12 时 TSLA 已到 ~$414.70 高点, 期权价格更高
      等待 9 分钟的 "确认" 实际上让系统在更差的价格入场
```

### 14.5 核心结论: 策略适配性错误

**当前策略本质上是一个带有多层确认的趋势追踪系统**, 其设计哲学是:
- 等趋势充分确认后才入场
- 依赖趋势持续来获利
- 通过层层过滤减少假信号

**这一哲学与期权买方的盈利模式根本冲突**:
- 期权买方需要在趋势 **早期** 或 **反转初期** 入场
- 期权买方依赖短时间内的大幅方向性波动获利
- 过多的确认延迟 = 错过入场窗口 + 追高入场

**如果不改变策略核心逻辑, 上面提出的所有 "修补" (VWAP 修复、TSLPPCT、动量衰减等) 只能减少亏损幅度, 无法从根本上解决 "在趋势末端反向入场" 的问题。**

### 14.6 策略改造方向建议

#### 方向 A: 将当前策略转为反向指标 (逆向交易)

既然评分系统在趋势末端产生最极端信号, 可以 **利用这一特性做反向交易**:

```
现状:  finalScore ≤ -12 → 买 PUT (追趋势)
改为:  finalScore ≤ -15 (极端值) → 买 CALL (赌反弹)
       finalScore ≥ +15 (极端值) → 买 PUT  (赌回调)
```

**风险**: 需要严格的止损, 因为趋势也可能继续 (极端值之后可能更极端)
**优势**: 直接解决 "买在顶/底" 的问题; 2/17 和 2/18 的案例中, 这种反向策略都能盈利

#### 方向 B: 从趋势追踪转为波动率交易

放弃判断方向, 转为交易波动率:
- 检测到高波动信号 → 买入跨式组合 (Straddle) 或宽跨式 (Strangle)
- 不需要判断涨跌方向, 只需要标的有足够大的波动
- 更适合当前评分系统 (极端评分 = 市场波动剧烈 = 跨式策略获利)

#### 方向 C: 大幅精简过滤层, 追求快进快出

保留基本的方向判断, 但 **移除所有延迟类过滤**:
- 移除价格确认等待 (直接入场)
- 移除连续确认 (首个信号即入场)
- 移除 RSI 超买/超卖过滤 (期权策略中 RSI 极端值恰好是对手方的入场点)
- 保留 VWAP 结构确认 (快速检查, 不引入延迟)
- 大幅收紧止损 (TSLPPCT trailing 8-10%)
- 目标: 从信号到成交 < 3 秒, 持仓 < 10 分钟

#### 方向 D: 将策略明确定位为股票策略

承认当前策略的设计逻辑更适合股票:
- 保持现有的多层确认体系
- 将执行标的从期权改为标的股票或 ETF (SPY, QQQ 等)
- 趋势追踪 + 充分确认的逻辑在股票中能发挥价值
- 期权交易另起一套独立策略

---

## 15. 2/17 + 2/18 组合盈亏总结

### 15.1 两日实际盈亏

| 日期 | 交易 | 方向 | 入场价 | 出场价 | 数量 | 净盈亏 |
|------|------|------|--------|--------|------|--------|
| 2/17 | SPY260217P676000.US (0DTE) | PUT | $2.09 | $1.46 | 1 | -$66.14 |
| 2/17 | IWM260218P262000.US (1DTE) | PUT | $2.67 | $2.89 | 1 | +$18.36 |
| 2/18 | TSLA260218C417500.US (1DTE) | CALL | $1.30 | $0.48 | 3 | -$246.00 |
| | | | | | **总计** | **-$293.78** |

### 15.2 如果方向正确的盈亏推算

| 日期 | 如果买反向 | 估算入场价 | 估算出场价 | 数量 | 估算盈亏 |
|------|-----------|-----------|-----------|------|---------|
| 2/17 SPY | CALL (而非 PUT) | ~$2.09 | ~$3.50+ (SPY 反弹) | 1 | +$141+ |
| 2/18 TSLA | PUT (而非 CALL) | ~$1.30 | ~$2.00+ (TSLA 下跌) | 3 | +$210+ |
| | | | | **总计** | **+$351+** |

**两天合计: 实际亏损 -$293.78 vs 反向操作预估盈利 +$351+, 差距超过 $640。**

### 15.3 问题本质

这不是运气问题, 而是系统设计的必然结果:

1. **评分系统在趋势末端给出最强信号** → 入场时机一定是趋势即将反转的时刻
2. **多层过滤消耗时间** → 信号经过 RSI/价格确认/连续确认后, 趋势已进一步展开至极端
3. **方向判断 = 趋势延续** → 在趋势末端做趋势延续的方向, 等于做反方向
4. **对期权买方而言, 方向错 + 延迟入场 = 双重打击** → 不仅买贵了, 而且买错了

**结论: 当前策略框架不适合期权交易。期权交易需要快速抓住入场机会并快速盈利退场, 而当前策略的层层确认机制恰好与此相反, 导致系统性地在趋势极端点以错误方向入场。继续在现有框架上打补丁 (修复 VWAP、添加 TSLPPCT 等) 只能减少亏损幅度, 无法解决根本的策略适配性问题。需要从根本上重新设计期权交易策略, 或将当前策略限定于股票/ETF 交易。**
