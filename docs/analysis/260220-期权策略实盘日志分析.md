# 260220 期权策略实盘日志分析

## 概述

分析 2026-02-20 策略 #10（7000刀期权 / OPTION_INTRADAY_V1）全天运行日志，验证策略逻辑正确性。

- **策略配置**: BEAR_SPREAD + BULL_SPREAD, AGGRESSIVE, 阈值 ±8
- **标的**: QQQ.US, SPY.US
- **交易窗口**: 9:30-14:00 ET（`noNewEntryBeforeCloseMinutes: 120`）
- **结果**: 全天 0 笔实际成交

---

## 一、全天 Score 时间线

### 评分公式

```
finalScore = marketScore * 0.4 + intradayScore * 0.4 + timeWindowAdjustment * 0.2
```

### 时间窗口调整值 (timeWindowAdjustment)

| 时段 (ET) | 值 | 说明 |
|---|---|---|
| 9:30-10:30 | +20 | 开盘首小时加分 |
| 10:30-11:30 | 0 | 无调整 |
| 11:30-14:30 | -10 | 午盘衰减 |
| 14:30-15:30 | -30 | 临近收盘加速衰减 |
| 15:30-16:00 | -50 | 收盘前急速衰减 |

### 评分演变

| 时段 (ET) | 大盘分 (mkt) | 日内分 (ida) | 时间窗 (tw) | 最终分 (final) | 状态 |
|---|---|---|---|---|---|
| 10:04-10:10 | -12 ~ -17 | +0.3 ~ +0.8 | +20 | **-1.6 ~ -2.5** | NO_SIGNAL |
| 10:10-10:30 | -13 ~ -16 | +0.2 ~ +0.6 | +20 | **-1.2 ~ -2.5** | NO_SIGNAL |
| 10:30-12:57 | -14 ~ -15 | +0.5 ~ +0.8 | -10 | **-7.3 ~ -7.9** | NO_SIGNAL |
| 12:57 (异常) | **-19.9** | +0.8 | -10 | **-9.6** | 温度失败 spike |
| 13:00-13:20 | -14 ~ -15 | +0.7 ~ +0.8 | -10 | **-7.3 ~ -7.8** | NO_SIGNAL |
| **13:21:53** | **-20.0** | +0.8 | -10 | **-9.7** | **SIGNAL (温度失败)** |
| 13:22-13:27 | -14.6 ~ -15.2 | +0.7 ~ +0.8 | -10 | -7.5 ~ -7.8 | NO_SIGNAL |
| **13:27:53** | **-19.9** | +0.7 | -10 | **-9.7** | **SIGNAL (温度失败)** |
| 13:28-14:00 | -3 ~ -15 | +0.7 ~ +1.1 | -10 | -1.0 ~ -7.5 | NO_SIGNAL |

### 关键观察

1. **正常情况下 final score 始终在 -7.3 ~ -7.9**，差 0.1-0.7 分就达到 -8 阈值
2. **开盘首小时 tw=+20 将 score 拉回到 -1 ~ -2**，远离阈值
3. **两次信号触发都是市场温度 API 失败导致的虚假信号**

---

## 二、大盘评分明细分解

以典型的正常评分 `mkt = -15.0` 为例：

| 因子 | 原始值 | 权重/计算 | 贡献分 |
|---|---|---|---|
| SPX趋势 | -24.0 | × 0.4 | -9.6 |
| USD Index | +26.5 | × -0.2（反向） | -5.3 |
| BTC | -51.0 | × 0.1（低相关性） | -5.1 |
| VIX | 正常 | 无额外加减 | 0 |
| 市场温度 | 67 | (67-50)×0.3 = +5.1 | +5.1 |
| **合计** | | | **-14.9** |

温度失败时（`mkt = -20.0`）：

| 因子 | 贡献分 |
|---|---|
| SPX + USD + BTC | -20.0 |
| 温度（缺失） | 0（原 +5.1 消失） |
| **合计** | **-20.0** |

**温度消失导致大盘评分变动 5 分，是信号跨越阈值的直接原因。**

---

## 三、信号生成与资金拦截详情

### 第一次信号 (13:21 ET)

```
13:21:51  ❌ [市场温度] 调用失败
13:21:53  大盘评分 = -20.0（温度分量消失）
          → final = -20.0×0.4 + 0.8×0.4 + (-10)×0.2 = -9.7
13:21:57  信号: BEAR_SPREAD PUT QQQ260220P604000.US (13张, $0.72, $943.87)
          ⛔ 资金拒绝: 申请$943.87 > 上限$561.52 (总$1123.05 / 2标的)
13:21:59  信号: BEAR_SPREAD PUT SPY260220P686000.US (9张, $1.05, $950.46)
          ⛔ 资金拒绝: 申请$950.46 > 上限$561.52
```

### 第二次信号 (13:27 ET)

```
13:27:51  ❌ [市场温度] 调用失败
13:27:53  大盘评分 = -19.9
          → final = -9.7
13:27:57  信号: BEAR_SPREAD PUT QQQ260220P606000.US (7张, $1.25, $879.25)
          ⛔ 资金拒绝: 申请$879.25 > 上限$561.52
13:27:59  信号: BEAR_SPREAD PUT SPY260220P687000.US (7张, $1.38, $970.25)
          ⛔ 资金拒绝: 申请$970.25 > 上限$561.52
```

---

## 四、发现的问题

### 问题 1: 市场温度 API 失败导致虚假信号 (P0 - 严重)

**根因**: `market-data.service.ts:561` — 内层 `catch` 直接 `return null`，跳过了外层 `catch`（626-645行）中的缓存回退逻辑。

```typescript
// 内层 catch (line 547-562) — BUG：直接返回 null
catch (error: any) {
  logger.error(`[市场温度] 调用失败:`, error.message);
  return null;  // ← 跳过了外层 catch 的缓存回退！
}

// 外层 catch (line 626-645) — 有缓存回退，但永远不会执行
catch (error: any) {
  if (this.temperatureCache) {
    return this.temperatureCache.value;  // ← 死代码
  }
}
```

**影响**: 温度失败时温度分量 (+4.8 ~ +7.2) 归零，大盘评分从 ~-15 跳到 ~-20，导致 final score 跨越 -8 阈值。

### 问题 2: 资金上限计算不一致 (P1 - 重要)

**根因**: `getMaxPositionPerSymbol()` 和 `requestAllocation()` 对策略总资金的计算方式不同。

| 方法 | 策略总资金 | 每标的上限 |
|---|---|---|
| `getMaxPositionPerSymbol()` (line 329) | `allocation_value` 原值 = $2,000 | $2,000 / 2 = $1,000 |
| `requestAllocation()` (line 423) | `min(allocation_value, totalCapital)` = $1,123 | $1,123 / 2 = $561.52 |

期权策略的仓位计算调用 `getMaxPositionPerSymbol()` 获取预算（line 641），得到 $1,000；但实际下单时 `requestAllocation()` 用调整后的 $561.52 做校验 → 被拒绝。

**结果**: 策略按 $1,000 预算计算 13 张合约，提交后被 $561.52 上限拒绝。应该一开始就用 $561.52 计算，得到 6 张合约。

### 问题 3: 日内分（intradayScore）贡献极低 (P2 - 设计缺陷)

全天 intradayScore 始终在 +0.2 ~ +1.1 范围（满分 ±100）：

- BTC 小时 K 动量: -0.7 ~ +0.4 → 权重 40% → -0.3 ~ +0.2
- USD 小时 K 动量: ~0 → 权重 20% → ~0
- SPX 近 5 日动量: +0.9 ~ +2.7 → 权重 40% → +0.4 ~ +1.1

intradayScore 在 finalScore 中占 40% 权重但只贡献了 0.1 ~ 0.4 分（实际范围 -100 ~ +100），相当于这 40% 权重被浪费了。

---

## 五、市场环境回顾 (2/20)

- **SPX**: 全天小幅下跌 ~-0.5%，SPX趋势分 -22 ~ -27
- **USD Index**: 强势（+25 ~ +28），对股市不利
- **BTC**: 下跌（-48 ~ -61），拖累评分
- **市场温度**: 63 ~ 74（偏暖，贡献正分 +3.9 ~ +7.2）
- **综合**: 温和偏空，不足以触发 0DTE 交易

---

## 六、结论

1. **策略逻辑基本正确** — 在温和偏空市场不入场是合理的，0DTE PUT 在 SPX 仅跌 0.5% 时盈利概率低
2. **市场温度 API 失败是唯一导致虚假信号的原因** — 需要修复缓存回退的代码路径
3. **资金管理正确拦截了虚假信号** — 虽然拦截原因是资金上限不一致，但客观上避免了亏损
4. **intradayScore 设计需要长期优化** — 当前几乎不贡献有效信号
