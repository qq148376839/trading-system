# 盘前 DB 一致性检查清单

**日期**: 2026-02-28
**用途**: 每日开盘前运行以下 6 项 SQL 检查，确保系统状态干净

## 检查项

### 1. 孤立的非终态订单

```sql
SELECT eo.order_id, eo.symbol, eo.current_status, eo.strategy_id
FROM execution_orders eo
WHERE eo.current_status NOT IN ('FILLED', 'CANCELLED', 'REJECTED', 'EXPIRED')
  AND eo.created_at < NOW() - INTERVAL '1 hour';
```
**预期**: 空结果集。非空说明有滞留订单需人工处理。

### 2. 残留熔断状态

```sql
SELECT si.strategy_id, si.symbol, si.context->>'dailyRealizedPnL' as pnl,
       si.context->>'consecutiveLosses' as losses
FROM strategy_instances si
WHERE (si.context->>'dailyRealizedPnL')::text IN ('NaN', 'null', 'undefined')
   OR (si.context->>'consecutiveLosses')::text IN ('NaN', 'null', 'undefined');
```
**预期**: 空结果集。非空说明有 NaN 毒化残留。

### 3. 孤立的 HOLDING/OPENING/CLOSING 状态

```sql
SELECT si.strategy_id, si.symbol, si.current_state,
       si.context->>'tradedSymbol' as traded
FROM strategy_instances si
JOIN strategies s ON s.id = si.strategy_id
WHERE si.current_state IN ('HOLDING', 'OPENING', 'CLOSING')
  AND s.status != 'RUNNING';
```
**预期**: 空结果集。非空说明策略已停但仓位未清。

### 4. 资金分配一致性

```sql
SELECT ca.strategy_id, ca.allocated_amount, ca.used_amount,
       COUNT(si.symbol) FILTER (WHERE si.current_state = 'HOLDING') as holding_count
FROM capital_allocations ca
LEFT JOIN strategy_instances si ON si.strategy_id = ca.strategy_id
GROUP BY ca.strategy_id, ca.allocated_amount, ca.used_amount
HAVING ca.used_amount > 0 AND COUNT(si.symbol) FILTER (WHERE si.current_state = 'HOLDING') = 0;
```
**预期**: 空结果集。非空说明资金占用但无持仓（需 resetUsedAmount）。

### 5. 未处理的 fill

```sql
SELECT eo.order_id, eo.symbol, eo.current_status, eo.fill_processed
FROM execution_orders eo
WHERE eo.current_status = 'FILLED'
  AND (eo.fill_processed IS NULL OR eo.fill_processed = FALSE)
  AND eo.created_at > NOW() - INTERVAL '24 hours';
```
**预期**: 空结果集。非空说明有成交未处理。

### 6. 持仓级字段残留检查（peakPnLPercent 跨交易污染）

```sql
SELECT si.strategy_id, si.symbol, si.current_state,
       si.context->>'peakPnLPercent' as peak,
       si.context->>'entryTime' as entry_time
FROM strategy_instances si
WHERE si.current_state = 'IDLE'
  AND si.context->>'peakPnLPercent' IS NOT NULL
  AND (si.context->>'peakPnLPercent')::text != 'null'
  AND (si.context->>'peakPnLPercent')::numeric > 0;
```
**预期**: 空结果集（b188cdb 修复后）。非空说明 IDLE 状态仍残留旧峰值。
