# 量化交易系统 3.0 深度审查报告

**审查日期**: 2026-02-25
**审查范围**: Commits d8419a7 → c0d0631 → 2fda7ae (Feb 24-25)
**数据来源**: `/api/orders/today` (31 orders) + `/api/orders/history` (406 orders)

---

## 一、真实亏损数据（铁证）

### Feb 24 (今日订单) — 总亏损: **-$547**

| 标的 | 买入量 | 买入成本 | 卖出收入 | P&L | 备注 |
|------|--------|----------|----------|-----|------|
| QQQ 605 Put | 1 | $63 | $58 | **-$5** | TSLPPCT 10% 触发 |
| QQQ 606 Put | 11 | $1,077 | $914 | **-$163** | TSLPPCT 8% 多次触发 |
| QQQ 607 Put | 5 | $681 | $591 | **-$90** | TSLPPCT 8% + 2次TSLP被拒 |
| SPY 686 Put | 7 | $983 | $694 | **-$289** | **无TSLPPCT保护! 62%亏损** |

### Feb 23 (历史订单) — 总亏损: **-$290**

| 标的 | P&L | 备注 |
|------|-----|------|
| SPY 681 Put | **-$347** | 反转后最大亏损 |
| QQQ 599 Put | -$184 | |
| QQQ 600 Put | -$144 | |
| QQQ 601 Put | -$115 | |
| SPY 682 Put | +$63 | 盈利 |
| SPY 683 Put | +$121 | 盈利 |
| SPY 684 Put | +$82 | 盈利 |
| QQQ 604 Put | +$208 | 盈利 |
| QQQ 602 Put | +$26 | 盈利 |

**两日合计亏损: -$837 (未计手续费)**

---

## 二、订单数据逆向诊断：5大致命发现

### 发现 1: TSLPPCT "崩溃保护" 被 deviation 公式自我击杀 (P0)

**代码**: `strategy-scheduler.service.ts:874-892`

设计意图: TSLPPCT 放宽到 60% 作为"崩溃保护安全网"。
实际表现: **所有 TSLPPCT 都被压缩到 8-10%**, 变成了主动止损而非安全网。

| 订单 | trailing_percent | 触发时间 | 持仓时间 |
|------|-----------------|----------|----------|
| QQQ 605 Put | **10%** | 69秒后 | 69秒 |
| QQQ 606 Put (3x) | **8%** | 45秒后 | 45秒 |
| QQQ 606 Put (1x) | **8.78%** | 4.5分钟 | 4.5分钟 |
| QQQ 607 Put (1x) | **8%** | 即刻 | 即刻 |

**根因**: deviation 公式 `adjustment = min(deviation * 50, trailing - 8)`:
- 0DTE 基线 trailing = min(60, 45) = 45%
- 如果信号价与成交价偏差 >74%, adjustment = 45-8 = 37, trailing = 8% (最小值)
- 即使偏差只有 10%, adjustment = 5, trailing = 40% — 仍然过于激进

**结果**: TSLPPCT 在秒级触发, 锁定小额亏损, 完全违背"崩溃保护"的设计意图。

### 发现 2: SPY 686 Put 完全没有 TSLPPCT 保护 (P0)

**铁证**: 31个今日订单中, SPY 686 Put 的订单:
- BUY 4 @ $1.40 → SELL 4 @ $1.33 (软件退出, 16秒)
- BUY 3 @ $1.41 → **SELL 3 @ $0.54** (MIT 强制平仓, 34分钟后, **-62% 亏损**)
- **没有任何 TSLPPCT 或 LIT 订单** — 零保护

**最可能原因**:
1. 第一轮 BUY 4 在 16 秒内被软件退出平仓, TSLPPCT 还没来得及提交
2. 第二轮 BUY 3 时, `context.protectionOrderId` 可能残留上一轮的值 (因为 P1-OPEN-1 的 isTslpFill 检测失效, protectionOrderId 不会被清除)
3. 条件 `!context.protectionOrderId` (line 860) 为 false, 跳过了 TSLPPCT 提交

**代码位置**: `strategy-scheduler.service.ts:860`
```typescript
if (isOptionAsset && !context.protectionOrderId) {
  // 提交 TSLPPCT...
}
```
如果 protectionOrderId 残留, 新仓位永远不会获得 TSLPPCT 保护。

### 发现 3: 买入后 16-23 秒闪电平仓, 锁定亏损 (P1)

**铁证**:
| 订单 | 买入时间 | 卖出时间 | 间隔 | P&L |
|------|---------|---------|------|-----|
| QQQ 606 5x | 16:31:52 | 16:32:08 | **16秒** | -$30 |
| SPY 686 4x | 16:31:53 | 16:32:09 | **16秒** | -$28 |
| QQQ 607 3x | 16:32:24 | 16:32:47 | **23秒** | -$9 |

系统在买入后的第一个监控周期(5秒)就决定退出。然后1-2分钟后以更差的价格重新入场。
这是动态退出服务的"时间止损"或"结构确认"逻辑在入场后立即触发。

### 发现 4: TSLPPCT 提交被拒绝后无重试 (P1)

**铁证**: QQQ 607 Put 有 2 个 TSLPPCT 订单被 REJECTED:
```
16:32:52 | TSLPPCT REJECTED | trailing=10 | qty=0
16:32:57 | TSLPPCT REJECTED | trailing=10 | qty=0
```
这两个订单在软件已经平仓后才提交 (软件在 16:32:47 已卖出 3 contracts)。
TSLPPCT 提交与软件退出存在竞态: 软件先退出 → TSLPPCT 后提交 → 被拒绝。

### 发现 5: 所有 LIT 止盈单全部取消, 无一触发 (P2)

**铁证**: 7个 TP_LIT_AUTO 订单全部 CancelledStatus, 0 executed。
2fda7ae 移除 LIT 调用逻辑是正确的 — 但**这些已经挂出去的 LIT 单是谁取消的？**
如果是代码自动取消(2fda7ae的清理逻辑), 说明修复生效。
如果是券商到期自动取消, 说明 LIT 从来没有价值。

---

## 三、代码漏洞清单 (按优先级)

### P0 — 明日开盘前必须修复

| # | 漏洞 | 位置 | 影响 |
|---|------|------|------|
| 1 | **deviation 公式将 TSLPPCT 压到 8%** — 变成秒级止损而非崩溃保护 | `strategy-scheduler.service.ts:874-892` | TSLPPCT 69秒内触发, 完全失去安全网功能 |
| 2 | **protectionOrderId 残留导致新仓位无保护** — SPY 686 Put -62% 的根因 | `strategy-scheduler.service.ts:860` + `isTslpFill` 检测失效 (line 949) | 新仓位没有任何券商端保护 |

### P1 — 明日开盘前应修复

| # | 漏洞 | 位置 | 影响 |
|---|------|------|------|
| 3 | **isTslpFill 检测永远为 false** — SELECT 未包含 execution_stage/remark, 且 remark 列不存在于 DB | `strategy-scheduler.service.ts:949` + `000_init_schema.sql` | exitReason 追踪错误, protectionOrderId 残留 |
| 4 | **TSLPPCT 提交与软件退出竞态** — 软件先平仓, TSLPPCT 后被拒 | `strategy-scheduler.service.ts:860-916` | 短持仓位无 TSLPPCT 保护 |
| 5 | **Partial Fill 处理空缺** — PartialFilledStatus 视为 FILLED, 未成交部分被遗弃 | `strategy-scheduler.service.ts:577+619` | 资金泄漏 (已分配未使用) |

### P2 — 一周内修复

| # | 漏洞 | 位置 | 影响 |
|---|------|------|------|
| 6 | **DST 时区硬编码** — `T16:00:00-05:00` 在夏令时(3月8日起)会导致所有时段计算偏移1小时 | `option-dynamic-exit.service.ts:596` | 3月8日变成 P0 |
| 7 | **卖出 PnL 手续费估算** — `sellEntryFees * 2` 而非使用实际出场手续费 | `strategy-scheduler.service.ts:966` | 熔断阈值精度偏差 |

---

## 四、修复方案

### Fix 1: deviation 公式重新设计 (P0)

**文件**: `strategy-scheduler.service.ts:874-892`

**当前逻辑**: `adjustment = min(deviation * 50, trailing - 8)` → 稍有偏差就压到极限
**修复方案**: 移除 deviation 动态调整, 或改为温和调整:

```typescript
// 方案A: 完全移除 deviation 调整 (推荐 — 让 TSLPPCT 回归崩溃保护本位)
// 删除 lines 874-892, 让 0DTE 始终使用 45% trailing

// 方案B: 温和调整 (保留但限制幅度)
if (actualDeviation > 0.10) {  // 阈值从 2% 提高到 10%
  const adjustment = Math.min(actualDeviation * 20, 15); // 最多调整 15%
  trailingPct = Math.max(trailingPct - adjustment, 30);  // 最低 30% 不是 8%
}
```

### Fix 2: protectionOrderId 清理 + isTslpFill 修复 (P0+P1)

**文件**: `strategy-scheduler.service.ts:949` + `000_init_schema.sql`

```typescript
// 方案: 用 context.protectionOrderId 匹配替代 execution_stage/remark
const isTslpFill = Boolean(
  context.protectionOrderId && context.protectionOrderId === dbOrder.order_id
);
```

同时在 IDLE 状态转换中强制清除:
```typescript
await strategyInstance.updateState(instanceKeySymbol, 'IDLE', {
  protectionOrderId: null,       // 强制清除
  protectionTrailingPct: null,   // 强制清除
  // ... 其他字段
});
```

### Fix 3: TSLPPCT 提交优先于软件退出 (P1)

在 buy fill 处理中, TSLPPCT 提交应该在 `updateState(HOLDING)` 之前完成, 或者在第一个监控周期中跳过软件退出评估直到 TSLPPCT 确认。

### Fix 4: DST 时区修复 (P2, 3月8日前)

**文件**: `option-dynamic-exit.service.ts:596`

```typescript
// 替代硬编码 -05:00
const closeTime = new Date(
  new Date(`${year}-${month}-${day}T16:00:00`).toLocaleString('en-US', { timeZone: 'America/New_York' })
);
```

---

## 五、明日开盘前 Checklist

### 必做 (MUST)

- [ ] **Fix 1**: 修复 deviation 公式 — 让 TSLPPCT 回归 45% 崩溃保护
- [ ] **Fix 2**: 修复 isTslpFill 检测 + protectionOrderId 强制清除
- [ ] **验证 DB 状态**:
  ```sql
  -- 检查是否有 fill_processed 遗漏的订单
  SELECT order_id, symbol, current_status, fill_processed
  FROM execution_orders
  WHERE current_status = 'FILLED' AND fill_processed IS NOT TRUE
  AND created_at >= NOW() - INTERVAL '48 hours';

  -- 检查 stuck HOLDING 状态
  SELECT strategy_id, symbol, current_state, context->>'protectionOrderId' as tslp_id
  FROM strategy_instances
  WHERE current_state IN ('HOLDING','OPENING','CLOSING');

  -- 检查资金泄漏
  SELECT s.id, ca.current_usage
  FROM strategies s JOIN capital_allocations ca ON s.capital_allocation_id = ca.id
  WHERE ca.current_usage > 0
  AND NOT EXISTS (
    SELECT 1 FROM strategy_instances si
    WHERE si.strategy_id = s.id AND si.current_state = 'HOLDING'
  );
  ```
- [ ] **验证券商端**: 检查 Longbridge 是否有残留的 TSLPPCT/LIT 订单未取消
- [ ] **清除 protectionOrderId 残留**: 对所有 IDLE 状态的 instance, 将 protectionOrderId 设为 null

### 应做 (SHOULD)

- [ ] Fix 3: TSLPPCT 提交优先级调整
- [ ] 添加日志监控: 当 TSLPPCT trailing < 20% 时输出 WARN 日志
- [ ] 审查 0DTE close window (180分钟) 是否合理

---

## 六、核心文件清单

| 文件 | 关键行号 | 修改内容 |
|------|---------|---------|
| `api/src/services/strategy-scheduler.service.ts` | 860, 874-892, 949, 984-993 | Fix 1 (deviation), Fix 2 (isTslpFill), Fix 2b (protectionOrderId清除) |
| `api/src/services/trailing-stop-protection.service.ts` | 340-375 | 确认 TSLPPCT 参数 (不改) |
| `api/src/services/option-dynamic-exit.service.ts` | 596 | Fix 4 (DST, 3月8日前) |
| `api/migrations/000_init_schema.sql` | 350-365 | 参考: 确认无 remark 列 |

---

## 七、结论

**昨日两个 commit (d8419a7, c0d0631) 修复了 3 个 P0 bug (无限重复处理、PnL 归零、WebSocket 竞态), 但同时引入了 1 个新的 P0 bug (deviation 公式) 和暴露了 1 个已有的 P0 bug (protectionOrderId 残留)。**

今日 commit (2fda7ae) 修复了无限重复处理循环, 但 deviation 公式和 protectionOrderId 残留问题未被触及。

**2月24日的 -$547 亏损中:**
- **-$289 (53%)** 归因于 SPY 686 Put 无 TSLPPCT 保护 (protectionOrderId 残留 bug)
- **-$163 (30%)** 归因于 QQQ 606 Put TSLPPCT 8% 秒级触发 (deviation 公式 bug)
- 剩余 -$95 (17%) 为正常交易亏损

**Fix 1 和 Fix 2 必须在明日 (2月26日) 开盘前完成。**
