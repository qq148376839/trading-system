# äº¤æ˜“æ—¥å¿—åˆ†ææŠ¥å‘Š - 2025-12-17

## ğŸ“‹ åˆ†ææ¦‚è¿°

**åˆ†ææ—¶é—´**: 2025-12-17  
**æ—¥å¿—æ–‡ä»¶**: 
- `logs-2025-12-17 warning.json` (1359æ¡è­¦å‘Šæ—¥å¿—)
- `logs-2025-12-17 info.json` (ä¿¡æ¯æ—¥å¿—)

**åˆ†æé‡ç‚¹**:
1. åªæœ‰å–å‡ºæ²¡æœ‰ä¹°å…¥æ˜¯å¦æ­£å¸¸
2. å¸‚åœºç¯å¢ƒè·å–å¤±è´¥é—®é¢˜
3. æœªæ‰¾åˆ°è®¢å•é—®é¢˜
4. æ¥å£è°ƒç”¨é¢‘ç¹é—®é¢˜

---

## ğŸ” é—®é¢˜1: åªæœ‰å–å‡ºæ²¡æœ‰ä¹°å…¥

### é—®é¢˜æè¿°

æ ¹æ®æä¾›çš„æŒ‡æ ‡ç›‘æ§æ•°æ®ï¼š
- **Order Deduplication Metrics**: Total Prevented: 1 (å…¨éƒ¨æ˜¯å–å‡ºè®¢å•)
- **Trade Push Metrics**: Received: 9
- **Order Rejection Metrics**: Rejected by Duplicate: 1

æ—¥å¿—ä¸­åªå‘ç°å–å‡ºè®¢å•ï¼ˆSELLï¼‰ï¼Œæ²¡æœ‰ä¹°å…¥è®¢å•ï¼ˆBUYï¼‰ã€‚

### å¯èƒ½åŸå› åˆ†æ

#### 1. ç­–ç•¥é€»è¾‘åªæ‰§è¡Œå¹³ä»“æ“ä½œ âœ… **æœ€å¯èƒ½**

æ ¹æ®ä»£ç åˆ†æï¼Œç­–ç•¥å¯èƒ½å¤„äºä»¥ä¸‹çŠ¶æ€ï¼š
- **å·²æœ‰æŒä»“ï¼Œåªæ‰§è¡Œå–å‡ºå¹³ä»“**ï¼šå¦‚æœç­–ç•¥å·²æœ‰æŒä»“ï¼Œå½“å‰å‘¨æœŸå¯èƒ½åªç”Ÿæˆå–å‡ºä¿¡å·ç”¨äºå¹³ä»“
- **ç­–ç•¥å¤„äºå¹³ä»“é˜¶æ®µ**ï¼šæŸäº›ç­–ç•¥åœ¨ç‰¹å®šå¸‚åœºç¯å¢ƒä¸‹åªæ‰§è¡Œå¹³ä»“æ“ä½œ

**ä»£ç ä½ç½®**: `trading-system/api/src/services/strategy-scheduler.service.ts`

```typescript:842:1051:trading-system/api/src/services/strategy-scheduler.service.ts
private async processSymbol(
  strategyInstance: StrategyBase,
  strategyId: number,
  symbol: string
): Promise<void> {
  // ... ç­–ç•¥æ‰§è¡Œé€»è¾‘
  // å¦‚æœæ˜¯ä¹°å…¥ä¿¡å·ï¼Œæ‰§è¡Œäº¤æ˜“
  if (intent.action === 'BUY') {
    // ç”³è¯·èµ„é‡‘é¢åº¦
    const availableCapital = await capitalManager.getAvailableCapital(strategyId);
    
    if (availableCapital <= 0) {
      logger.log(`ç­–ç•¥ ${strategyId} æ ‡çš„ ${symbol}: å¯ç”¨èµ„é‡‘ä¸è¶³ï¼Œè·³è¿‡ä¹°å…¥`);
      return;
    }
    // ... ä¹°å…¥é€»è¾‘
  }
}
```

#### 2. èµ„é‡‘ä¸è¶³å¯¼è‡´ä¹°å…¥è¢«è·³è¿‡ âš ï¸ **éœ€è¦æ£€æŸ¥**

ä¹°å…¥è®¢å•åˆ›å»ºå‰ä¼šæ£€æŸ¥å¯ç”¨èµ„é‡‘ï¼š
- å¦‚æœ `availableCapital <= 0`ï¼Œä¹°å…¥ä¼šè¢«è·³è¿‡
- ä½†è¿™ç§æƒ…å†µåº”è¯¥ä¼šè®°å½•æ—¥å¿—ï¼š`å¯ç”¨èµ„é‡‘ä¸è¶³ï¼Œè·³è¿‡ä¹°å…¥`

**å»ºè®®æ£€æŸ¥**:
- æŸ¥çœ‹æ˜¯å¦æœ‰"å¯ç”¨èµ„é‡‘ä¸è¶³"çš„æ—¥å¿—
- æ£€æŸ¥èµ„é‡‘ç®¡ç†é…ç½®

#### 3. ä¹°å…¥è®¢å•è¢«é£é™©æ§åˆ¶è¿‡æ»¤ âš ï¸ **éœ€è¦æ£€æŸ¥**

ä¹°å…¥è®¢å•å¯èƒ½è¢«ä»¥ä¸‹æœºåˆ¶è¿‡æ»¤ï¼š
- æŒä»“éªŒè¯å¤±è´¥
- ä»·æ ¼éªŒè¯å¤±è´¥
- å¸‚åœºç¯å¢ƒä¸æ»¡è¶³ä¹°å…¥æ¡ä»¶

#### 4. ä¹°å…¥ä¿¡å·æœªç”Ÿæˆ âš ï¸ **éœ€è¦æ£€æŸ¥**

ç­–ç•¥å¯èƒ½æ²¡æœ‰ç”Ÿæˆä¹°å…¥ä¿¡å·ï¼š
- å¸‚åœºç¯å¢ƒä¸æ»¡è¶³ä¹°å…¥æ¡ä»¶
- æŠ€æœ¯æŒ‡æ ‡æœªè§¦å‘ä¹°å…¥ä¿¡å·
- ç­–ç•¥é€»è¾‘é™åˆ¶

### éªŒè¯æ–¹æ³•

1. **æ£€æŸ¥ç­–ç•¥æ—¥å¿—**:
   ```sql
   -- æŸ¥è¯¢ç­–ç•¥æ‰§è¡Œæ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ä¹°å…¥ä¿¡å·ç”Ÿæˆ
   SELECT * FROM strategy_execution_logs 
   WHERE DATE(created_at) = '2025-12-17' 
   AND message LIKE '%BUY%' OR message LIKE '%ä¹°å…¥%'
   ORDER BY created_at;
   ```

2. **æ£€æŸ¥èµ„é‡‘çŠ¶æ€**:
   ```sql
   -- æŸ¥è¯¢ç­–ç•¥èµ„é‡‘çŠ¶æ€
   SELECT * FROM strategy_capital 
   WHERE strategy_id = 5 
   AND DATE(updated_at) = '2025-12-17';
   ```

3. **æ£€æŸ¥æŒä»“çŠ¶æ€**:
   ```sql
   -- æŸ¥è¯¢å½“å‰æŒä»“
   SELECT * FROM auto_trades 
   WHERE strategy_id = 5 
   AND close_time IS NULL;
   ```

### ç»“è®º

**å¦‚æœç­–ç•¥å·²æœ‰æŒä»“ï¼Œåªæœ‰å–å‡ºæ˜¯æ­£å¸¸çš„**ã€‚è¿™æ˜¯å¹³ä»“æ“ä½œï¼Œç¬¦åˆç­–ç•¥é€»è¾‘ã€‚

**å¦‚æœç­–ç•¥æ²¡æœ‰æŒä»“ï¼Œåªæœ‰å–å‡ºä¸æ­£å¸¸**ï¼Œéœ€è¦æ£€æŸ¥ï¼š
- ä¹°å…¥ä¿¡å·æ˜¯å¦ç”Ÿæˆ
- èµ„é‡‘æ˜¯å¦å……è¶³
- ä¹°å…¥è®¢å•æ˜¯å¦è¢«è¿‡æ»¤

---

## ğŸ” é—®é¢˜2: å¸‚åœºç¯å¢ƒè·å–å¤±è´¥

### é—®é¢˜æè¿°

æ—¥å¿—ä¸­é¢‘ç¹å‡ºç°å¸‚åœºç¯å¢ƒè·å–å¤±è´¥çš„è­¦å‘Šã€‚

### ä»£ç ä½ç½®

å¸‚åœºç¯å¢ƒè·å–é€»è¾‘åœ¨ `dynamic-position-manager.service.ts`:

```typescript:104:121:trading-system/api/src/services/dynamic-position-manager.service.ts
async getCurrentMarketEnvironment(symbol: string): Promise<{
  marketEnv: string;
  marketStrength: number;
}> {
  try {
    const recommendation = await tradingRecommendationService.calculateRecommendation(symbol);
    return {
      marketEnv: recommendation.market_environment,
      marketStrength: recommendation.comprehensive_market_strength,
    };
  } catch (error: any) {
    logger.warn(`è·å–å¸‚åœºç¯å¢ƒå¤±è´¥ (${symbol}):`, error.message);
    return {
      marketEnv: 'ä¸­æ€§',
      marketStrength: 0,
    };
  }
}
```

### å¤±è´¥åŸå› åˆ†æ

#### 1. `calculateRecommendation()` è°ƒç”¨å¤±è´¥

`tradingRecommendationService.calculateRecommendation()` éœ€è¦ï¼š
- è·å–SPXæ•°æ®
- è·å–USD Indexæ•°æ®
- è·å–BTCæ•°æ®
- è·å–è‚¡ç¥¨Kçº¿æ•°æ®

**å¯èƒ½å¤±è´¥åŸå› **:
- APIè°ƒç”¨è¶…æ—¶
- ç½‘ç»œè¿æ¥é—®é¢˜
- APIè¿”å›é”™è¯¯
- æ•°æ®æ ¼å¼å¼‚å¸¸

#### 2. å¸‚åœºæ•°æ®APIä¸ç¨³å®š

å¸‚åœºæ•°æ®è·å–é€»è¾‘åœ¨ `market-data.service.ts` å’Œ `market-data-cache.service.ts`:

```typescript:98:166:trading-system/api/src/services/market-data-cache.service.ts
async getMarketData(count: number = 100, includeIntraday: boolean = false): Promise<MarketDataCache> {
  const now = Date.now();
  const cacheDuration = this.getCacheDurationMs();
  const intradayCacheDuration = this.getIntradayCacheDurationMs();

  // æ£€æŸ¥æ—¥Kæ•°æ®ç¼“å­˜
  const dailyCacheValid = this.cache && (now - this.cache.timestamp) < cacheDuration;
  
  // æ£€æŸ¥åˆ†æ—¶æ•°æ®ç¼“å­˜ï¼ˆå¦‚æœå¯ç”¨ï¼‰
  const hourlyCacheValid = includeIntraday && 
    this.cache?.hourlyTimestamp && 
    (now - this.cache.hourlyTimestamp) < intradayCacheDuration;

  // å¦‚æœæ—¥Kå’Œåˆ†æ—¶æ•°æ®éƒ½æœ‰æ•ˆï¼Œç›´æ¥è¿”å›ï¼ˆä¸è¾“å‡ºæ—¥å¿—ï¼Œé¿å…é‡å¤ï¼‰
  if (dailyCacheValid && (!includeIntraday || hourlyCacheValid)) {
    return this.cache!;
  }

  // å¦‚æœæ­£åœ¨è·å–æ•°æ®ï¼Œç­‰å¾…æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚å®Œæˆ
  if (this.isFetching && this.fetchPromise) {
    return this.fetchPromise;
  }

  // ç¼“å­˜è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œé‡æ–°è·å–
  this.isFetching = true;
  // ... è·å–å¸‚åœºæ•°æ®
}
```

**å¯èƒ½å¤±è´¥åŸå› **:
- ç¬¬ä¸‰æ–¹APIï¼ˆmoomoo/futunnï¼‰ä¸ç¨³å®š
- ç½‘ç»œä»£ç†é…ç½®é—®é¢˜
- APIé™æµ
- æ•°æ®æ ¼å¼å˜åŒ–

### å½±å“åˆ†æ

**å½“å‰å¤„ç†æ–¹å¼**: å¤±è´¥æ—¶è¿”å›é»˜è®¤å€¼ï¼ˆ`marketEnv: 'ä¸­æ€§', marketStrength: 0`ï¼‰

**å½±å“**:
- âœ… ä¸ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒ
- âš ï¸ å¸‚åœºç¯å¢ƒåˆ¤æ–­å¯èƒ½ä¸å‡†ç¡®
- âš ï¸ å¯èƒ½å½±å“äº¤æ˜“å†³ç­–

### è§£å†³æ–¹æ¡ˆ

#### 1. å¢åŠ é‡è¯•æœºåˆ¶

```typescript
async getCurrentMarketEnvironment(symbol: string, retries: number = 3): Promise<{
  marketEnv: string;
  marketStrength: number;
}> {
  for (let i = 0; i < retries; i++) {
    try {
      const recommendation = await tradingRecommendationService.calculateRecommendation(symbol);
      return {
        marketEnv: recommendation.market_environment,
        marketStrength: recommendation.comprehensive_market_strength,
      };
    } catch (error: any) {
      if (i === retries - 1) {
        logger.warn(`è·å–å¸‚åœºç¯å¢ƒå¤±è´¥ (${symbol}):`, error.message);
        return {
          marketEnv: 'ä¸­æ€§',
          marketStrength: 0,
        };
      }
      // ç­‰å¾…åé‡è¯•
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}
```

#### 2. å¢åŠ ç¼“å­˜æœºåˆ¶

- ç¼“å­˜å¸‚åœºç¯å¢ƒç»“æœï¼ˆçŸ­æœŸç¼“å­˜ï¼Œå¦‚5åˆ†é’Ÿï¼‰
- å‡å°‘APIè°ƒç”¨é¢‘ç‡

#### 3. ç›‘æ§å’Œå‘Šè­¦

- è®°å½•å¤±è´¥é¢‘ç‡
- å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼æ—¶å‘é€å‘Šè­¦

---

## ğŸ” é—®é¢˜3: æœªæ‰¾åˆ°è®¢å•å…³è”çš„ä¿¡å·

### é—®é¢˜æè¿°

æ—¥å¿—ä¸­é¢‘ç¹å‡ºç°ï¼š
```
æœªæ‰¾åˆ°è®¢å• 1185589679152447488 å…³è”çš„ä¿¡å· (strategy_id=5, symbol=ROKU.US, side=SELL)
æœªæ‰¾åˆ°è®¢å• 1185668710078103552 å…³è”çš„ä¿¡å· (strategy_id=5, symbol=TSLA.US, side=SELL)
```

### ä»£ç ä½ç½®

è®¢å•å’Œä¿¡å·å…³è”é€»è¾‘åœ¨ `basic-execution.service.ts`:

```typescript:950:975:trading-system/api/src/services/basic-execution.service.ts
if (result.rowCount !== null && result.rowCount > 0) {
  const signalIds = result.rows.map(r => r.id);
  logger.debug(`è®¢å• ${orderId} é€šè¿‡æ—¶é—´çª—å£åŒ¹é…æ›´æ–°äº†ä¿¡å·çŠ¶æ€: ${signalIds.join(',')}`);
  
  // Optionally, backfill signal_id for future use
  if (signalIds.length === 1) {
    await pool.query(
      `UPDATE execution_orders SET signal_id = $1 WHERE order_id = $2`,
      [signalIds[0], orderId]
    );
    logger.debug(`å·²å›å¡«è®¢å• ${orderId} çš„ signal_id=${signalIds[0]}`);
  }
} else {
  logger.warn(
    `æœªæ‰¾åˆ°è®¢å• ${orderId} å…³è”çš„ä¿¡å· ` +
    `(strategy_id=${order.strategy_id}, symbol=${order.symbol}, side=${orderSide})`
  );
}
```

### å¤±è´¥åŸå› åˆ†æ

#### 1. æ—¶é—´çª—å£åŒ¹é…å¤±è´¥ âš ï¸ **æœ€å¯èƒ½**

è®¢å•å’Œä¿¡å·çš„å…³è”é€šè¿‡æ—¶é—´çª—å£åŒ¹é…ï¼š
- è®¢å•åˆ›å»ºæ—¶é—´ vs ä¿¡å·åˆ›å»ºæ—¶é—´
- å¦‚æœæ—¶é—´å·®è¿‡å¤§ï¼ŒåŒ¹é…å¤±è´¥

**ä»£ç é€»è¾‘**:
```sql
-- æŸ¥æ‰¾åŒ¹é…çš„ä¿¡å·
SELECT * FROM strategy_signals 
WHERE strategy_id = $1 
AND symbol = $2 
AND side = $3 
AND created_at BETWEEN $4 AND $5  -- æ—¶é—´çª—å£
```

**å¯èƒ½åŸå› **:
- æ—¶é—´çª—å£è®¾ç½®è¿‡å°
- è®¢å•åˆ›å»ºå’Œä¿¡å·åˆ›å»ºæ—¶é—´å·®è¿‡å¤§
- æ—¶åŒºé—®é¢˜

#### 2. è®¢å•åˆ›å»ºæ—¶æœªåˆ›å»ºä¿¡å·è®°å½• âš ï¸ **éœ€è¦æ£€æŸ¥**

è®¢å•å¯èƒ½é€šè¿‡ä»¥ä¸‹æ–¹å¼åˆ›å»ºï¼š
- æ‰‹åŠ¨åˆ›å»ºï¼ˆä¸é€šè¿‡ç­–ç•¥ï¼‰
- å¤–éƒ¨ç³»ç»Ÿåˆ›å»º
- ä¿¡å·åˆ›å»ºå¤±è´¥ä½†è®¢å•åˆ›å»ºæˆåŠŸ

#### 3. strategy_idã€symbolã€side ä¸åŒ¹é… âš ï¸ **éœ€è¦æ£€æŸ¥**

åŒ¹é…æ¡ä»¶ï¼š
- `strategy_id` å¿…é¡»ä¸€è‡´
- `symbol` å¿…é¡»ä¸€è‡´
- `side` å¿…é¡»ä¸€è‡´ï¼ˆBUY/SELLï¼‰

**å¯èƒ½åŸå› **:
- è®¢å•çš„ `strategy_id` é”™è¯¯
- è®¢å•çš„ `symbol` æ ¼å¼ä¸ä¸€è‡´ï¼ˆå¦‚ `ROKU.US` vs `ROKU`)
- è®¢å•çš„ `side` æ ¼å¼ä¸ä¸€è‡´ï¼ˆå¦‚ `SELL` vs `Sell`)

### å½±å“åˆ†æ

**å½“å‰å¤„ç†æ–¹å¼**: è®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä½†ä¸å½±å“è®¢å•æ‰§è¡Œ

**å½±å“**:
- âœ… è®¢å•å¯ä»¥æ­£å¸¸æ‰§è¡Œ
- âš ï¸ æ— æ³•æ›´æ–°ä¿¡å·çŠ¶æ€
- âš ï¸ æ— æ³•è¿½è¸ªè®¢å•å’Œä¿¡å·çš„å…³è”å…³ç³»

### è§£å†³æ–¹æ¡ˆ

#### 1. æ”¾å®½æ—¶é—´çª—å£

æ£€æŸ¥å½“å‰æ—¶é—´çª—å£è®¾ç½®ï¼Œé€‚å½“æ”¾å®½ï¼š

```typescript
// å½“å‰æ—¶é—´çª—å£å¯èƒ½æ˜¯ Â±5åˆ†é’Ÿï¼Œå¯ä»¥æ”¾å®½åˆ° Â±30åˆ†é’Ÿ
const timeWindow = 30 * 60 * 1000; // 30åˆ†é’Ÿ
```

#### 2. æ”¹è¿›åŒ¹é…é€»è¾‘

- ä½¿ç”¨æ›´å®½æ¾çš„åŒ¹é…æ¡ä»¶
- æ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼ˆå¦‚ symbol æ ¼å¼æ ‡å‡†åŒ–ï¼‰

#### 3. è®¢å•åˆ›å»ºæ—¶å¼ºåˆ¶åˆ›å»ºä¿¡å·

ç¡®ä¿è®¢å•åˆ›å»ºæ—¶åŒæ—¶åˆ›å»ºä¿¡å·è®°å½•ï¼š

```typescript
// åœ¨ submitOrder() ä¸­
if (!signalId) {
  // åˆ›å»ºä¿¡å·è®°å½•
  signalId = await createSignal(strategyId, symbol, side);
}
```

#### 4. å›å¡«æœºåˆ¶

å¯¹äºå†å²è®¢å•ï¼Œå®ç°å›å¡«æœºåˆ¶ï¼š
- å®šæœŸæ‰«ææœªå…³è”çš„è®¢å•
- å°è¯•åŒ¹é…å†å²ä¿¡å·
- æ›´æ–°å…³è”å…³ç³»

---

## ğŸ” é—®é¢˜4: æ¥å£è°ƒç”¨é¢‘ç¹/é™æµ

### é—®é¢˜æè¿°

æ—¥å¿—ä¸­å¯èƒ½å‡ºç°æ¥å£è°ƒç”¨é¢‘ç¹æˆ–é™æµçš„é”™è¯¯ï¼ˆ429é”™è¯¯ï¼‰ã€‚

### ä»£ç ä½ç½®

APIé™æµå¤„ç†åœ¨å¤šä¸ªä½ç½®ï¼š

#### 1. APIé™æµæœåŠ¡

```typescript:22:121:trading-system/api/src/services/api-rate-limiter.service.ts
class ApiRateLimiterService {
  private queue: Array<() => Promise<any>> = []
  private running: number = 0;
  private config: RateLimitConfig;
  private lastCallTime: number = 0;
  
  constructor(config?: Partial<RateLimitConfig>) {
    this.config = {
      maxConcurrent: 3,           // æœ€å¤š3ä¸ªå¹¶å‘è¯·æ±‚
      minInterval: 6000,          // æœ€å°é—´éš”6ç§’ï¼ˆæ¯åˆ†é’Ÿæœ€å¤š10æ¬¡ï¼‰
      maxCallsPerHour: 300,       // æ¯å°æ—¶æœ€å¤š300æ¬¡
      retryDelay: 1000,           // åˆå§‹é‡è¯•å»¶è¿Ÿ1ç§’
      maxRetries: 3,              // æœ€å¤šé‡è¯•3æ¬¡
    };
  }
  
  async execute<T>(fn: () => Promise<T>): Promise<T> {
    // ... é™æµé€»è¾‘
    // å¦‚æœæ˜¯é™æµé”™è¯¯ï¼ˆ429ï¼‰ï¼Œå¢åŠ ç­‰å¾…æ—¶é—´
    if (error?.response?.status === 429 || error?.status === 429) {
      const waitTime = this.config.retryDelay * Math.pow(2, retries);
      console.warn(`APIé™æµï¼Œç­‰å¾… ${waitTime}ms åé‡è¯•`);
      await new Promise(resolve => setTimeout(resolve, waitTime));
      retries++;
    }
  }
}
```

#### 2. APIé¢‘æ¬¡é™åˆ¶å·¥å…·

```typescript:6:65:trading-system/api/src/utils/api-rate-limiter.ts
class APIRateLimiter {
  private requests: number[] = [];  // è®°å½•è¯·æ±‚æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
  private readonly maxRequests = 60;  // æœ€å¤§è¯·æ±‚æ•°
  private readonly timeWindow = 30000;  // æ—¶é—´çª—å£ï¼ˆ30ç§’ï¼Œæ¯«ç§’ï¼‰

  async waitIfNeeded(): Promise<void> {
    const now = Date.now();
    
    // æ¸…ç†30ç§’å‰çš„è¯·æ±‚è®°å½•
    this.requests = this.requests.filter(t => now - t < this.timeWindow);
    
    // å¦‚æœè¯·æ±‚æ•°å·²è¾¾åˆ°é™åˆ¶ï¼Œéœ€è¦ç­‰å¾…
    if (this.requests.length >= this.maxRequests) {
      const oldestRequest = this.requests[0];
      const waitTime = this.timeWindow - (now - oldestRequest) + 100;  // å¤šç­‰100msç¡®ä¿å®‰å…¨
      
      if (waitTime > 0) {
        console.log(`[APIé¢‘æ¬¡é™åˆ¶] ç­‰å¾… ${Math.ceil(waitTime / 1000)} ç§’åç»§ç»­...`);
        await new Promise(resolve => setTimeout(resolve, waitTime));
      }
    }
    
    // è®°å½•æœ¬æ¬¡è¯·æ±‚
    this.requests.push(Date.now());
  }
}
```

#### 3. è®¢å•æŸ¥è¯¢é™æµå¤„ç†

```typescript:730:742:trading-system/api/src/services/basic-execution.service.ts
} catch (queryError: any) {
  // å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä½†ç»§ç»­é‡è¯•
  // å¦‚æœæ˜¯é¢‘ç‡é™åˆ¶é”™è¯¯ï¼Œå»¶é•¿ç­‰å¾…æ—¶é—´
  if (queryError.message && (queryError.message.includes('429') || queryError.message.includes('429002'))) {
    logger.warn(`è®¢å•æŸ¥è¯¢é¢‘ç‡é™åˆ¶ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´åé‡è¯• (${orderId})`);
    await new Promise((resolve) => setTimeout(resolve, 5000)); // ç­‰å¾…5ç§’
  } else {
    logger.warn(`æ‰¹é‡æŸ¥è¯¢ä»Šæ—¥è®¢å•å¤±è´¥ (${orderId}):`, queryError.message);
    await new Promise((resolve) => setTimeout(resolve, 2000));
  }
}
```

### å¤±è´¥åŸå› åˆ†æ

#### 1. APIè°ƒç”¨é¢‘ç‡è¿‡é«˜ âš ï¸ **æœ€å¯èƒ½**

å¯èƒ½çš„åŸå› ï¼š
- å¤šä¸ªç­–ç•¥åŒæ—¶è¿è¡Œï¼Œå¹¶å‘è°ƒç”¨API
- è®¢å•æŸ¥è¯¢é¢‘ç‡è¿‡é«˜ï¼ˆå¦‚æ¯1ç§’æŸ¥è¯¢ä¸€æ¬¡ï¼‰
- å¸‚åœºæ•°æ®è·å–é¢‘ç‡è¿‡é«˜

#### 2. æœªä½¿ç”¨é™æµæœåŠ¡ âš ï¸ **éœ€è¦æ£€æŸ¥**

æŸäº›APIè°ƒç”¨å¯èƒ½æœªä½¿ç”¨ `ApiRateLimiterService` æˆ– `apiRateLimiter`ï¼š
- ç›´æ¥è°ƒç”¨APIï¼Œæœªç»è¿‡é™æµ
- é™æµé…ç½®ä¸åˆç†

#### 3. æ‰¹é‡æŸ¥è¯¢æœªä¼˜åŒ– âš ï¸ **éœ€è¦æ£€æŸ¥**

è®¢å•æŸ¥è¯¢å¯èƒ½ä½¿ç”¨äº†å¤šæ¬¡å•ç‹¬æŸ¥è¯¢ï¼Œè€Œä¸æ˜¯æ‰¹é‡æŸ¥è¯¢ï¼š

```typescript
// ä¸å¥½çš„åšæ³•ï¼šå¤šæ¬¡å•ç‹¬æŸ¥è¯¢
for (const orderId of orderIds) {
  const order = await tradeCtx.orderDetail(orderId); // æ¯æ¬¡è°ƒç”¨API
}

// å¥½çš„åšæ³•ï¼šæ‰¹é‡æŸ¥è¯¢
const todayOrders = await tradeCtx.todayOrders({}); // ä¸€æ¬¡è°ƒç”¨è·å–æ‰€æœ‰è®¢å•
```

### è§£å†³æ–¹æ¡ˆ

#### 1. ç¡®ä¿æ‰€æœ‰APIè°ƒç”¨éƒ½ä½¿ç”¨é™æµæœåŠ¡

```typescript
// ä½¿ç”¨ ApiRateLimiterService
const result = await apiRateLimiterService.execute(async () => {
  return await tradeCtx.orderDetail(orderId);
});

// æˆ–ä½¿ç”¨ apiRateLimiter
await apiRateLimiter.waitIfNeeded();
const result = await tradeCtx.orderDetail(orderId);
```

#### 2. ä¼˜åŒ–æ‰¹é‡æŸ¥è¯¢

- ä½¿ç”¨ `todayOrders()` æ‰¹é‡æŸ¥è¯¢ï¼Œè€Œä¸æ˜¯ `orderDetail()` å•ç‹¬æŸ¥è¯¢
- ç¼“å­˜æŸ¥è¯¢ç»“æœï¼Œå‡å°‘é‡å¤æŸ¥è¯¢

#### 3. å¢åŠ è¯·æ±‚é—´éš”

- å¢åŠ  `minInterval` é…ç½®ï¼ˆå¦‚ä»6ç§’å¢åŠ åˆ°10ç§’ï¼‰
- å‡å°‘å¹¶å‘æ•°ï¼ˆå¦‚ä»3ä¸ªå‡å°‘åˆ°2ä¸ªï¼‰

#### 4. ç›‘æ§APIè°ƒç”¨é¢‘ç‡

- è®°å½•APIè°ƒç”¨æ¬¡æ•°å’Œæ—¶é—´
- è®¾ç½®å‘Šè­¦é˜ˆå€¼
- å®šæœŸåˆ†æAPIè°ƒç”¨æ¨¡å¼

---

## ğŸ“Š é—®é¢˜ä¼˜å…ˆçº§æ€»ç»“

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | ä¼˜å…ˆçº§ | å½±å“ |
|------|---------|--------|------|
| åªæœ‰å–å‡ºæ²¡æœ‰ä¹°å…¥ | ä¸­-é«˜ | P1 | å¦‚æœç­–ç•¥åº”è¯¥ä¹°å…¥ä½†æ²¡æœ‰ä¹°å…¥ï¼Œå½±å“ç­–ç•¥æ”¶ç›Š |
| å¸‚åœºç¯å¢ƒè·å–å¤±è´¥ | ä¸­ | P2 | å¯èƒ½å½±å“äº¤æ˜“å†³ç­–ï¼Œä½†æœ‰é»˜è®¤å€¼å…œåº• |
| æœªæ‰¾åˆ°è®¢å•å…³è”çš„ä¿¡å· | ä½-ä¸­ | P3 | ä¸å½±å“è®¢å•æ‰§è¡Œï¼Œä½†å½±å“è¿½è¸ªå’Œç»Ÿè®¡ |
| æ¥å£è°ƒç”¨é¢‘ç¹/é™æµ | é«˜ | P1 | å¯èƒ½å¯¼è‡´APIè°ƒç”¨å¤±è´¥ï¼Œå½±å“ç³»ç»Ÿç¨³å®šæ€§ |

---

## ğŸ¯ å»ºè®®è¡ŒåŠ¨é¡¹

### ç«‹å³æ‰§è¡Œï¼ˆP1ï¼‰

1. **æ£€æŸ¥ä¹°å…¥è®¢å•ç¼ºå¤±åŸå› **
   - [ ] æŸ¥è¯¢ç­–ç•¥æ‰§è¡Œæ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æœ‰ä¹°å…¥ä¿¡å·ç”Ÿæˆ
   - [ ] æ£€æŸ¥èµ„é‡‘çŠ¶æ€ï¼Œç¡®è®¤æ˜¯å¦æœ‰å¯ç”¨èµ„é‡‘
   - [ ] æ£€æŸ¥æŒä»“çŠ¶æ€ï¼Œç¡®è®¤æ˜¯å¦å·²æœ‰æŒä»“ï¼ˆåªæœ‰å–å‡ºæ˜¯æ­£å¸¸çš„ï¼‰

2. **ä¼˜åŒ–APIè°ƒç”¨é¢‘ç‡**
   - [ ] ç¡®ä¿æ‰€æœ‰APIè°ƒç”¨éƒ½ä½¿ç”¨é™æµæœåŠ¡
   - [ ] ä¼˜åŒ–æ‰¹é‡æŸ¥è¯¢é€»è¾‘
   - [ ] å¢åŠ è¯·æ±‚é—´éš”æ—¶é—´

### çŸ­æœŸæ‰§è¡Œï¼ˆP2ï¼‰

3. **æ”¹è¿›å¸‚åœºç¯å¢ƒè·å–**
   - [ ] å¢åŠ é‡è¯•æœºåˆ¶
   - [ ] å¢åŠ ç¼“å­˜æœºåˆ¶
   - [ ] ç›‘æ§å¤±è´¥ç‡

### é•¿æœŸä¼˜åŒ–ï¼ˆP3ï¼‰

4. **æ”¹è¿›è®¢å•å’Œä¿¡å·å…³è”**
   - [ ] æ”¾å®½æ—¶é—´çª—å£åŒ¹é…æ¡ä»¶
   - [ ] æ”¹è¿›åŒ¹é…é€»è¾‘
   - [ ] å®ç°å›å¡«æœºåˆ¶

---

## ğŸ“ é™„å½•

### ç›¸å…³ä»£ç æ–‡ä»¶

- `trading-system/api/src/services/strategy-scheduler.service.ts` - ç­–ç•¥è°ƒåº¦å™¨
- `trading-system/api/src/services/basic-execution.service.ts` - è®¢å•æ‰§è¡ŒæœåŠ¡
- `trading-system/api/src/services/dynamic-position-manager.service.ts` - æŒä»“ç®¡ç†æœåŠ¡
- `trading-system/api/src/services/trading-recommendation.service.ts` - äº¤æ˜“æ¨èæœåŠ¡
- `trading-system/api/src/services/market-data-cache.service.ts` - å¸‚åœºæ•°æ®ç¼“å­˜æœåŠ¡
- `trading-system/api/src/services/api-rate-limiter.service.ts` - APIé™æµæœåŠ¡
- `trading-system/api/src/utils/api-rate-limiter.ts` - APIé¢‘æ¬¡é™åˆ¶å·¥å…·

### ç›¸å…³æ–‡æ¡£

- [è®¢å•å»é‡æœºåˆ¶æ–‡æ¡£](../features/251216-LOG_SYSTEM_OPTIMIZATION_PRD.md)
- [ä»»åŠ¡é˜Ÿåˆ—ä¿®å¤æ–‡æ¡£](../features/251216-TASK_QUEUES_FIX_IMPLEMENTATION.md)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-12-17  
**åˆ†æäººå‘˜**: AI Product Manager




