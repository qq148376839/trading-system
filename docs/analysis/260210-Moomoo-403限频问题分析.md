# Moomoo API 403 限频问题分析

**日期**: 2026-02-10
**状态**: 临时修复已上线，待长期方案

---

## 问题描述

系统在获取市场数据时频繁遇到 Moomoo API 返回 `403 Operations too frequent` 错误，导致 SPX / USD Index / BTC 三个关键市场指标数据获取失败，策略无法执行。

**错误表现**:
```
[富途API错误] stockId=72000025, type=2: 未知错误
BTC数据不足（0 < 50），无法提供交易建议
USD Index数据不足（0 < 50），无法提供交易建议
```

**403 响应内容**: Moomoo 返回 HTML 页面，标题 `403 - Operations too frequent`

---

## 根因分析

### 1. 并发请求触发限频

`market-data.service.ts` 的 `getAllMarketData()` 使用 `Promise.all` 同时发出 3 个关键请求（SPX + USD Index + BTC），加上可选的分时数据（USD Index 小时K + BTC 小时K），共 5 个请求几乎同时发出。

每个请求内部还有 `retryWithBackoff`（最多 3 次重试），失败后立刻重试会进一步加剧请求密度。

### 2. 多个调用方叠加

| 调用来源 | 频率 | 并发请求数 |
|----------|------|-----------|
| 策略调度器（期权策略） | 每 90 秒 | 5-7 个 |
| 前端日志/监控页面 | 用户操作时 | 1-2 个 |
| 账户余额同步 | 定时 | 0（不直接调用，但可能触发其他服务） |
| 系统启动时 | 一次性 | 5-7 个 |

系统启动或策略重启时，所有服务同时初始化，请求峰值最高。

### 3. Moomoo API 限频策略（观察结论）

| 观察项 | 结论 |
|--------|------|
| 单次请求间隔 > 3 秒 | 始终成功 |
| 2 个并发请求 | 通常成功 |
| 3+ 个并发请求 | 经常触发 403 |
| 403 后恢复时间 | 约 3-10 秒 |
| 基于 IP 还是 Cookie | 基于 IP（无 Cookie 的游客模式也会触发） |
| 特定 stockId 更敏感 | USD Index (72000025) 和 BTC (12000015) 比 SPX (200003) 更容易被限 |

### 4. 边缘函数代理的影响

所有请求通过 `cfapi.riowang.win`（Cloudflare Worker）代理转发到 Moomoo。从 Moomoo 角度看，所有请求来自同一个 Cloudflare IP，加剧了限频。

---

## 当前临时修复 (a095678)

将 `getAllMarketData()` 和 `getHistoricalMarketData()` 中的并发请求改为**串行请求**，每次间隔 800ms：

```
SPX → (800ms) → USD Index → (800ms) → BTC → (800ms) → VIX/分时...
```

同时将 `retryWithBackoff` 的 `initialDelayMs` 从 500ms 提高到 1000ms。

**优点**: 简单有效，不触发限频
**缺点**: 总获取时间从约 2 秒增加到约 5 秒

---

## 可选长期方案

### 方案 A: 多 IP 分散请求

通过部署多个边缘函数实例（不同 Cloudflare 账号或不同代理服务），每个 stockId 使用不同的出口 IP。

- 优点: 彻底解决限频，可恢复并发
- 缺点: 运维成本，需要多个代理部署

### 方案 B: 数据源替换/混合

对部分指标使用其他免费数据源替代 Moomoo：

| 指标 | 替代方案 |
|------|---------|
| SPX | Yahoo Finance API, Alpha Vantage, TradingView |
| USD Index (DXY) | FRED API（美联储数据）, Twelve Data |
| BTC | CoinGecko API, Binance API |

- 优点: 降低对 Moomoo 的依赖，每个源有独立的限频额度
- 缺点: 数据格式不统一，需要适配层

### 方案 C: 服务端缓存 + 异步刷新

将市场数据缓存到数据库或 Redis，由独立的后台任务按固定节奏（如每 30 秒）刷新，策略调度器直接读取缓存而非实时请求。

- 优点: 策略执行不再依赖实时 API 调用，延迟稳定
- 缺点: 数据有 30 秒延迟（对日K数据影响可忽略，对分时数据需评估）

### 方案 D: LongPort SDK 补充数据

LongPort SDK 可获取 K 线数据（已有 `quoteCtx.candlesticks()` 方法），但目前仅用于期权报价。可将 SPX 等指标的数据获取迁移到 LongPort。

- 优点: 使用已有的 SDK，有独立的限频额度
- 缺点: LongPort 是否覆盖 USD Index / BTC 需确认

### 方案 E: 请求合并 + 全局速率限制

在 moomoo-proxy 层添加全局请求队列，所有 Moomoo API 请求进入统一队列，按固定速率（如每秒 1 个）依次发出。

- 优点: 架构层面解决，所有调用方自动受益
- 缺点: 需要改造 proxy 层，增加复杂度

---

## 相关文件

- `api/src/services/market-data.service.ts` — 市场数据获取（已改串行）
- `api/src/services/market-data-cache.service.ts` — 市场数据缓存层
- `api/src/utils/moomoo-proxy.ts` — Moomoo API 代理工具
- `edge-functions/` — Cloudflare Worker 边缘函数

---

## 监控要点

- 日志关键词: `富途API错误`, `数据不足`, `403`, `Operations too frequent`
- 熔断器日志: `[熔断器] stockId=XXX 连续失败N次`
- 正常情况下市场数据获取应在 5 秒内完成（串行模式）
