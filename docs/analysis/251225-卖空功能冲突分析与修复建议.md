# å–ç©ºåŠŸèƒ½å†²çªåˆ†æä¸ä¿®å¤å»ºè®®

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
- **åˆ›å»ºæ—¶é—´**ï¼š2025-12-25
- **æ–‡æ¡£ä½œè€…**ï¼šAI Product Manager
- **å®¡æ ¸çŠ¶æ€**ï¼šå¾…å®¡æ ¸

---

## 1. é—®é¢˜æ£€æŸ¥ç»“æœ

### âœ… 1.1 unsubscribe ä½¿ç”¨æ£€æŸ¥

**æ£€æŸ¥ç»“æœ**ï¼š**æ­£ç¡®ä½¿ç”¨** âœ…

**æ£€æŸ¥ä½ç½®**ï¼š
- `api/src/server.ts` ç¬¬187-189è¡Œï¼šä¼˜é›…å…³é—­æ—¶è°ƒç”¨ `unsubscribe()`
- `api/src/services/trade-push.service.ts` ç¬¬224-267è¡Œï¼š`unsubscribe()` å®ç°

**å®ç°æ­£ç¡®æ€§**ï¼š
- âœ… æœ‰çŠ¶æ€æ£€æŸ¥ï¼ˆå¹‚ç­‰æ€§ï¼‰
- âœ… æœ‰é”™è¯¯å¤„ç†
- âœ… æœ‰å›è°ƒå‡½æ•°æ¸…ç†
- âœ… ç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§

**ç»“è®º**ï¼šæ— éœ€ä¿®æ”¹

---

### âš ï¸ 1.2 å½“å‰é€»è¾‘å†²çªæ£€æŸ¥

**å‘ç°ä»¥ä¸‹å†²çªç‚¹**ï¼š

#### å†²çª1ï¼šIDLEçŠ¶æ€ä¸‹å¿½ç•¥SELLä¿¡å·
**ä½ç½®**ï¼š`api/src/services/strategy-scheduler.service.ts` ç¬¬952è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
// IDLEçŠ¶æ€ä¸‹åªèƒ½æ‰§è¡ŒBUYæ“ä½œï¼ŒSELLä¿¡å·åº”è¯¥è¢«å¿½ç•¥ï¼ˆæ— æŒä»“å¯å–ï¼‰
if (intent.action === 'SELL' && currentState === 'IDLE') {
  logger.debug(`[ç­–ç•¥æ‰§è¡Œ] ç­–ç•¥ ${strategyId} æ ‡çš„ ${symbol}: IDLEçŠ¶æ€ä¸‹å¿½ç•¥SELLä¿¡å·ï¼ˆæ— æŒä»“å¯å–ï¼Œå¯èƒ½æ˜¯ç­–ç•¥ç”Ÿæˆçš„åšç©ºä¿¡å·ï¼‰`);
  summary.idle.push(symbol);
  return;
}
```

**é—®é¢˜**ï¼š
- âŒ é˜»æ­¢äº†IDLEçŠ¶æ€ä¸‹çš„åšç©ºæ“ä½œ
- âŒ æ³¨é‡Šæ˜ç¡®è¯´æ˜"å¯èƒ½æ˜¯ç­–ç•¥ç”Ÿæˆçš„åšç©ºä¿¡å·"ï¼Œä½†ä»ç„¶è¢«å¿½ç•¥

**ä¿®å¤å»ºè®®**ï¼š
```typescript
// IDLEçŠ¶æ€ä¸‹ï¼šSELLä¿¡å· = åšç©ºï¼ˆå¼€ä»“ï¼‰
if (intent.action === 'SELL' && currentState === 'IDLE') {
  // æ£€æŸ¥æ˜¯å¦æœ‰å–ç©ºæƒé™å’Œä¿è¯é‡‘
  // æ‰§è¡Œåšç©ºæ“ä½œ
  await this.executeShortIntent(strategyId, symbol, intent);
  return;
}
```

---

#### å†²çª2ï¼šæ•°é‡éªŒè¯æ‹’ç»è´Ÿæ•°
**ä½ç½®**ï¼š`api/src/services/strategy-scheduler.service.ts` ç¬¬1002è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
if (!intent.quantity || intent.quantity <= 0) {
  summary.errors.push(`${symbol}(INVALID_QUANTITY)`);
  return;
}
```

**é—®é¢˜**ï¼š
- âŒ `intent.quantity <= 0` ä¼šæ‹’ç»è´Ÿæ•°æ•°é‡ï¼ˆå–ç©ºè®¢å•ï¼‰
- âŒ å–ç©ºè®¢å•æ•°é‡åº”è¯¥æ˜¯è´Ÿæ•°

**ä¿®å¤å»ºè®®**ï¼š
```typescript
// éªŒè¯æ•°é‡ï¼ˆå…è®¸è´Ÿæ•°ï¼Œè¡¨ç¤ºå–ç©ºï¼‰
if (!intent.quantity || intent.quantity === 0) {
  summary.errors.push(`${symbol}(INVALID_QUANTITY)`);
  return;
}

// å¦‚æœæ˜¯å–ç©ºè®¢å•ï¼Œæ•°é‡åº”è¯¥æ˜¯è´Ÿæ•°
if (intent.action === 'SELL' && currentState === 'IDLE' && intent.quantity > 0) {
  // è½¬æ¢ä¸ºè´Ÿæ•°ï¼ˆå–ç©ºï¼‰
  intent.quantity = -intent.quantity;
}
```

---

#### å†²çª3ï¼šæŒä»“éªŒè¯åªè€ƒè™‘æ­£æ•°æŒä»“
**ä½ç½®**ï¼š`api/src/services/basic-execution.service.ts` ç¬¬330è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
// éªŒè¯å–å‡ºæ•°é‡
if (quantity > positionInfo.availableQuantity) {
  return {
    valid: false,
    reason: `å¯ç”¨æŒä»“ä¸è¶³ï¼šå®é™…æŒä»“=${positionInfo.availableQuantity}ï¼Œæœªæˆäº¤è®¢å•å ç”¨=${positionInfo.pendingQuantity}ï¼Œå¯ç”¨æŒä»“=${positionInfo.availableQuantity}ï¼Œè¯·æ±‚å–å‡º=${quantity}`
  };
}
```

**é—®é¢˜**ï¼š
- âŒ åªéªŒè¯ `quantity > availableQuantity`ï¼Œæ²¡æœ‰è€ƒè™‘è´Ÿæ•°æŒä»“
- âŒ å–ç©ºæŒä»“æ—¶ï¼Œ`availableQuantity` å¯èƒ½æ˜¯è´Ÿæ•°
- âŒ å¹³ä»“å–ç©ºæŒä»“æ—¶ï¼Œéœ€è¦éªŒè¯ä¹°å…¥æ•°é‡æ˜¯å¦è¶…è¿‡å–ç©ºæ•°é‡

**ä¿®å¤å»ºè®®**ï¼š
```typescript
async validateSellPosition(
  symbol: string,
  quantity: number,
  strategyId: number
): Promise<ValidationResult> {
  const positionInfo = await this.calculateAvailablePosition(symbol);
  
  // åˆ¤æ–­æ˜¯å¹³ä»“è¿˜æ˜¯å–ç©º
  if (quantity < 0) {
    // å–ç©ºè®¢å•ï¼ˆè´Ÿæ•°ï¼‰
    // éªŒè¯ï¼šå–ç©ºæ•°é‡ä¸èƒ½è¶…è¿‡å¯ç”¨ä¿è¯é‡‘
    // TODO: æ·»åŠ ä¿è¯é‡‘éªŒè¯
    return { valid: true, ...positionInfo };
  } else if (positionInfo.actualQuantity < 0) {
    // æœ‰å–ç©ºæŒä»“ï¼Œä¹°å…¥å¹³ä»“
    // éªŒè¯ï¼šä¹°å…¥æ•°é‡ä¸èƒ½è¶…è¿‡å–ç©ºæ•°é‡
    const shortQuantity = Math.abs(positionInfo.actualQuantity);
    if (quantity > shortQuantity) {
      return {
        valid: false,
        reason: `å¹³ä»“æ•°é‡(${quantity})ä¸èƒ½è¶…è¿‡å–ç©ºæ•°é‡(${shortQuantity})`
      };
    }
    return { valid: true, ...positionInfo };
  } else {
    // åšå¤šæŒä»“ï¼Œå–å‡ºå¹³ä»“
    if (quantity > positionInfo.availableQuantity) {
      return {
        valid: false,
        reason: `å¯ç”¨æŒä»“ä¸è¶³ï¼šå®é™…æŒä»“=${positionInfo.actualQuantity}ï¼Œå¯ç”¨æŒä»“=${positionInfo.availableQuantity}ï¼Œè¯·æ±‚å–å‡º=${quantity}`
      };
    }
    return { valid: true, ...positionInfo };
  }
}
```

---

#### å†²çª4ï¼šå¯ç”¨æŒä»“è®¡ç®—æœªè€ƒè™‘è´Ÿæ•°
**ä½ç½®**ï¼š`api/src/services/basic-execution.service.ts` ç¬¬223-305è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
async calculateAvailablePosition(symbol: string): Promise<{
  actualQuantity: number;
  pendingQuantity: number;
  availableQuantity: number;
}> {
  // ...
  const actualQuantity = position ? parseFloat(position.quantity?.toString() || '0') : 0;
  
  // æŸ¥è¯¢æœªæˆäº¤å–å‡ºè®¢å•
  let pendingQuantity = 0;
  for (const order of todayOrders) {
    const orderSide = order.side;
    const isSell = orderSide === 'Sell' || orderSide === 2 || orderSide === 'SELL';
    if (orderSymbol === symbol && isSell) {
      // ç´¯åŠ æœªæˆäº¤å–å‡ºè®¢å•æ•°é‡
      pendingQuantity += orderQuantity;
    }
  }
  
  // è®¡ç®—å¯ç”¨æŒä»“
  const availableQuantity = actualQuantity - pendingQuantity;
  
  return {
    actualQuantity,
    pendingQuantity,
    availableQuantity
  };
}
```

**é—®é¢˜**ï¼š
- âš ï¸ ä»£ç æœ¬èº«æ”¯æŒè´Ÿæ•°ï¼ˆ`actualQuantity` å¯ä»¥æ˜¯è´Ÿæ•°ï¼‰
- âš ï¸ ä½†æ³¨é‡Šè¯´"é¿å…å–ç©º"ï¼ˆç¬¬298è¡Œï¼‰
- âš ï¸ æœªæˆäº¤è®¢å•è®¡ç®—æ—¶ï¼Œæ²¡æœ‰åŒºåˆ†å–ç©ºè®¢å•å’Œå¹³ä»“è®¢å•

**ä¿®å¤å»ºè®®**ï¼š
```typescript
async calculateAvailablePosition(symbol: string): Promise<{
  actualQuantity: number;
  pendingQuantity: number;
  availableQuantity: number;
  positionType: 'LONG' | 'SHORT' | 'NONE';
}> {
  // ...
  const actualQuantity = position ? parseFloat(position.quantity?.toString() || '0') : 0;
  
  // åˆ¤æ–­æŒä»“ç±»å‹
  let positionType: 'LONG' | 'SHORT' | 'NONE';
  if (actualQuantity > 0) {
    positionType = 'LONG';
  } else if (actualQuantity < 0) {
    positionType = 'SHORT';
  } else {
    positionType = 'NONE';
  }
  
  // æŸ¥è¯¢æœªæˆäº¤è®¢å•
  let pendingSellQuantity = 0;  // æœªæˆäº¤å–å‡ºè®¢å•ï¼ˆå¹³ä»“æˆ–å–ç©ºï¼‰
  let pendingBuyQuantity = 0;   // æœªæˆäº¤ä¹°å…¥è®¢å•ï¼ˆå¼€ä»“æˆ–å¹³ä»“ï¼‰
  
  for (const order of todayOrders) {
    const orderSide = order.side;
    const isSell = orderSide === 'Sell' || orderSide === 2 || orderSide === 'SELL';
    const isBuy = orderSide === 'Buy' || orderSide === 1 || orderSide === 'BUY';
    
    if (orderSymbol === symbol) {
      if (isSell) {
        pendingSellQuantity += orderQuantity;
      } else if (isBuy) {
        pendingBuyQuantity += orderQuantity;
      }
    }
  }
  
  // è®¡ç®—å¯ç”¨æŒä»“
  let availableQuantity: number;
  if (positionType === 'LONG') {
    // åšå¤šæŒä»“ï¼šå¯ç”¨ = å®é™…æŒä»“ - æœªæˆäº¤å–å‡ºè®¢å•
    availableQuantity = actualQuantity - pendingSellQuantity;
  } else if (positionType === 'SHORT') {
    // å–ç©ºæŒä»“ï¼šå¯ç”¨ = |å®é™…æŒä»“| - æœªæˆäº¤ä¹°å…¥è®¢å•ï¼ˆå¹³ä»“ï¼‰
    availableQuantity = Math.abs(actualQuantity) - pendingBuyQuantity;
  } else {
    // æ— æŒä»“ï¼šå¯ç”¨ = 0
    availableQuantity = 0;
  }
  
  return {
    actualQuantity,
    pendingQuantity: positionType === 'LONG' ? pendingSellQuantity : pendingBuyQuantity,
    availableQuantity,
    positionType
  };
}
```

---

#### å†²çª5ï¼šæŒä»“çŠ¶æ€åŒæ­¥åªå¤„ç†æ­£æ•°æŒä»“
**ä½ç½®**ï¼š`api/src/services/strategy-scheduler.service.ts` ç¬¬1163è¡Œã€ç¬¬1575è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
// ç¬¬1163è¡Œ
if (quantity > 0) {
  // å¤„ç†åšå¤šæŒä»“
}

// ç¬¬1575è¡Œ
if (quantity <= 0) return;
```

**é—®é¢˜**ï¼š
- âŒ åªå¤„ç†æ­£æ•°æŒä»“ï¼Œå¿½ç•¥è´Ÿæ•°æŒä»“ï¼ˆå–ç©ºï¼‰
- âŒ å–ç©ºæŒä»“æ— æ³•åŒæ­¥çŠ¶æ€

**ä¿®å¤å»ºè®®**ï¼š
```typescript
// å¤„ç†æŒä»“çŠ¶æ€åŒæ­¥
const quantity = parseFloat(actualPosition.quantity?.toString() || '0');

if (quantity > 0) {
  // åšå¤šæŒä»“ï¼šåŒæ­¥åˆ° HOLDING çŠ¶æ€
  await this.syncLongPositionState(strategyId, symbol, quantity, costPrice);
} else if (quantity < 0) {
  // å–ç©ºæŒä»“ï¼šåŒæ­¥åˆ° SHORT çŠ¶æ€
  await this.syncShortPositionState(strategyId, symbol, quantity, costPrice);
} else {
  // æ— æŒä»“ï¼šåŒæ­¥åˆ° IDLE çŠ¶æ€
  await this.syncIdleState(strategyId, symbol);
}
```

---

### âš ï¸ 1.3 å–å¤šå’Œå–ç©ºå†²çªæ£€æŸ¥

**å‘ç°ä»¥ä¸‹å†²çªç‚¹**ï¼š

#### å†²çª6ï¼šè®¢å•æ–¹å‘åˆ¤æ–­ä¸å®Œæ•´
**ä½ç½®**ï¼š`api/src/services/trade-push.service.ts` ç¬¬150è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
// æ ‡å‡†åŒ–è®¢å•æ–¹å‘
const isSell = side === 'Sell' || side === 2 || side === 'SELL' || side === 'sell';
const action = isSell ? 'SELL' : 'BUY';
```

**é—®é¢˜**ï¼š
- âš ï¸ æ²¡æœ‰åŒºåˆ†"å–å‡ºå¼€ä»“"ï¼ˆå–ç©ºï¼‰å’Œ"å–å‡ºå¹³ä»“"ï¼ˆå¹³ä»“åšå¤šæŒä»“ï¼‰
- âš ï¸ æ²¡æœ‰åŒºåˆ†"ä¹°å…¥å¼€ä»“"ï¼ˆåšå¤šï¼‰å’Œ"ä¹°å…¥å¹³ä»“"ï¼ˆå¹³ä»“å–ç©ºæŒä»“ï¼‰

**ä¿®å¤å»ºè®®**ï¼š
```typescript
// æ ‡å‡†åŒ–è®¢å•æ–¹å‘
const isSell = side === 'Sell' || side === 2 || side === 'SELL' || side === 'sell';
const isBuy = side === 'Buy' || side === 1 || side === 'BUY' || side === 'buy';

// è·å–å½“å‰æŒä»“åˆ¤æ–­è®¢å•ç±»å‹
const position = await getPositionFromSDK(symbol);
const currentQuantity = position?.quantity || 0;

let action: 'BUY' | 'SELL';
let orderType: 'OPEN' | 'CLOSE';

if (isSell) {
  if (currentQuantity > 0) {
    // å–å‡ºå¹³ä»“ï¼ˆå¹³ä»“åšå¤šæŒä»“ï¼‰
    action = 'SELL';
    orderType = 'CLOSE';
  } else {
    // å–å‡ºå¼€ä»“ï¼ˆå–ç©ºï¼‰
    action = 'SELL';
    orderType = 'OPEN';
  }
} else if (isBuy) {
  if (currentQuantity < 0) {
    // ä¹°å…¥å¹³ä»“ï¼ˆå¹³ä»“å–ç©ºæŒä»“ï¼‰
    action = 'BUY';
    orderType = 'CLOSE';
  } else {
    // ä¹°å…¥å¼€ä»“ï¼ˆåšå¤šï¼‰
    action = 'BUY';
    orderType = 'OPEN';
  }
}
```

---

#### å†²çª7ï¼šç›ˆäºè®¡ç®—æœªåŒºåˆ†å–ç©º
**ä½ç½®**ï¼š`api/src/services/strategy-scheduler.service.ts` ç¬¬1633è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
const positionPnl = (currentPrice - costPrice) * quantity;
```

**é—®é¢˜**ï¼š
- âŒ åªè€ƒè™‘äº†åšå¤šç›ˆäºè®¡ç®—ï¼š`(currentPrice - costPrice) Ã— quantity`
- âŒ å–ç©ºç›ˆäºè®¡ç®—åº”è¯¥æ˜¯ï¼š`(costPrice - currentPrice) Ã— |quantity|`

**ä¿®å¤å»ºè®®**ï¼š
```typescript
// ç›ˆäºè®¡ç®—ï¼ˆåŒºåˆ†åšå¤šå’Œå–ç©ºï¼‰
let positionPnl: number;
if (quantity > 0) {
  // åšå¤šï¼šä»·æ ¼ä¸Šæ¶¨ç›ˆåˆ©
  positionPnl = (currentPrice - costPrice) * quantity;
} else if (quantity < 0) {
  // å–ç©ºï¼šä»·æ ¼ä¸‹è·Œç›ˆåˆ©
  positionPnl = (costPrice - currentPrice) * Math.abs(quantity);
} else {
  positionPnl = 0;
}
```

---

#### å†²çª8ï¼šé”™è¯¯å¤„ç†ä¸å®Œå–„
**ä½ç½®**ï¼šå¤šå¤„

**é—®é¢˜**ï¼š
1. **å–ç©ºæƒé™æ£€æŸ¥ç¼ºå¤±**ï¼š
   - æ²¡æœ‰æ£€æŸ¥è´¦æˆ·æ˜¯å¦æœ‰å–ç©ºæƒé™
   - æ²¡æœ‰æ£€æŸ¥æ ‡çš„æ˜¯å¦æ”¯æŒå–ç©º

2. **ä¿è¯é‡‘éªŒè¯ç¼ºå¤±**ï¼š
   - æ²¡æœ‰éªŒè¯ä¿è¯é‡‘æ˜¯å¦å……è¶³
   - æ²¡æœ‰è®¡ç®—å–ç©ºæ‰€éœ€ä¿è¯é‡‘

3. **æ•°é‡éªŒè¯ä¸å®Œæ•´**ï¼š
   - æ²¡æœ‰éªŒè¯å–ç©ºæ•°é‡æ˜¯å¦åˆç†
   - æ²¡æœ‰éªŒè¯å¹³ä»“æ•°é‡æ˜¯å¦è¶…è¿‡å–ç©ºæ•°é‡

4. **çŠ¶æ€è½¬æ¢éªŒè¯ç¼ºå¤±**ï¼š
   - æ²¡æœ‰éªŒè¯çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
   - ä¾‹å¦‚ï¼šSHORTçŠ¶æ€ä¸èƒ½ç›´æ¥è½¬ä¸ºHOLDINGçŠ¶æ€

**ä¿®å¤å»ºè®®**ï¼š
```typescript
// 1. å–ç©ºæƒé™æ£€æŸ¥
async function checkShortPermission(symbol: string): Promise<boolean> {
  // TODO: è°ƒç”¨SDKæ£€æŸ¥è´¦æˆ·æ˜¯å¦æœ‰å–ç©ºæƒé™
  // TODO: æ£€æŸ¥æ ‡çš„æ˜¯å¦æ”¯æŒå–ç©º
  return true;
}

// 2. ä¿è¯é‡‘éªŒè¯
async function validateMargin(symbol: string, quantity: number): Promise<ValidationResult> {
  const requiredMargin = calculateShortMargin(symbol, quantity);
  const availableMargin = await getAvailableMargin();
  
  if (requiredMargin > availableMargin) {
    return {
      valid: false,
      error: `ä¿è¯é‡‘ä¸è¶³ï¼šéœ€è¦=${requiredMargin}ï¼Œå¯ç”¨=${availableMargin}`
    };
  }
  
  return { valid: true };
}

// 3. æ•°é‡éªŒè¯
function validateQuantity(quantity: number, action: string, currentQuantity: number): ValidationResult {
  if (action === 'SELL' && quantity < 0) {
    // å–ç©ºè®¢å•ï¼šæ•°é‡å¿…é¡»æ˜¯è´Ÿæ•°
    if (quantity >= 0) {
      return { valid: false, error: 'å–ç©ºè®¢å•æ•°é‡å¿…é¡»ä¸ºè´Ÿæ•°' };
    }
  } else if (action === 'BUY' && currentQuantity < 0) {
    // å¹³ä»“å–ç©ºæŒä»“ï¼šä¹°å…¥æ•°é‡ä¸èƒ½è¶…è¿‡å–ç©ºæ•°é‡
    const shortQuantity = Math.abs(currentQuantity);
    if (quantity > shortQuantity) {
      return {
        valid: false,
        error: `å¹³ä»“æ•°é‡(${quantity})ä¸èƒ½è¶…è¿‡å–ç©ºæ•°é‡(${shortQuantity})`
      };
    }
  }
  
  return { valid: true };
}

// 4. çŠ¶æ€è½¬æ¢éªŒè¯
function validateStateTransition(from: string, to: string): ValidationResult {
  const validTransitions: Record<string, string[]> = {
    'IDLE': ['OPENING', 'SHORTING'],
    'OPENING': ['HOLDING', 'IDLE'],
    'SHORTING': ['SHORT', 'IDLE'],
    'HOLDING': ['CLOSING', 'IDLE'],
    'SHORT': ['COVERING', 'IDLE'],
    'CLOSING': ['IDLE'],
    'COVERING': ['IDLE'],
  };
  
  const allowedStates = validTransitions[from] || [];
  if (!allowedStates.includes(to)) {
    return {
      valid: false,
      error: `æ— æ•ˆçš„çŠ¶æ€è½¬æ¢ï¼š${from} â†’ ${to}`
    };
  }
  
  return { valid: true };
}
```

---

## 2. ä¿®å¤ä¼˜å…ˆçº§

### P0ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
1. âœ… **å†²çª1**ï¼šIDLEçŠ¶æ€ä¸‹å¿½ç•¥SELLä¿¡å·
2. âœ… **å†²çª2**ï¼šæ•°é‡éªŒè¯æ‹’ç»è´Ÿæ•°
3. âœ… **å†²çª3**ï¼šæŒä»“éªŒè¯åªè€ƒè™‘æ­£æ•°æŒä»“
4. âœ… **å†²çª4**ï¼šå¯ç”¨æŒä»“è®¡ç®—æœªè€ƒè™‘è´Ÿæ•°

### P1ï¼ˆé‡è¦ä¿®å¤ï¼‰
5. âœ… **å†²çª5**ï¼šæŒä»“çŠ¶æ€åŒæ­¥åªå¤„ç†æ­£æ•°æŒä»“
6. âœ… **å†²çª6**ï¼šè®¢å•æ–¹å‘åˆ¤æ–­ä¸å®Œæ•´
7. âœ… **å†²çª7**ï¼šç›ˆäºè®¡ç®—æœªåŒºåˆ†å–ç©º

### P2ï¼ˆå®Œå–„ä¿®å¤ï¼‰
8. âœ… **å†²çª8**ï¼šé”™è¯¯å¤„ç†ä¸å®Œå–„

---

## 3. ä¿®å¤å»ºè®®æ€»ç»“

### 3.1 å¿…é¡»ä¿®æ”¹çš„æ–‡ä»¶

1. **`api/src/services/strategy-scheduler.service.ts`**
   - ä¿®æ”¹IDLEçŠ¶æ€ä¸‹SELLä¿¡å·å¤„ç†ï¼ˆæ”¯æŒåšç©ºï¼‰
   - ä¿®æ”¹æ•°é‡éªŒè¯é€»è¾‘ï¼ˆå…è®¸è´Ÿæ•°ï¼‰
   - ä¿®æ”¹æŒä»“çŠ¶æ€åŒæ­¥ï¼ˆæ”¯æŒè´Ÿæ•°æŒä»“ï¼‰
   - ä¿®æ”¹ç›ˆäºè®¡ç®—ï¼ˆåŒºåˆ†åšå¤šå’Œå–ç©ºï¼‰

2. **`api/src/services/basic-execution.service.ts`**
   - ä¿®æ”¹ `calculateAvailablePosition`ï¼ˆæ”¯æŒè´Ÿæ•°æŒä»“ï¼‰
   - ä¿®æ”¹ `validateSellPosition`ï¼ˆåŒºåˆ†å¹³ä»“å’Œå–ç©ºï¼‰
   - æ·»åŠ å–ç©ºæƒé™æ£€æŸ¥
   - æ·»åŠ ä¿è¯é‡‘éªŒè¯

3. **`api/src/services/trade-push.service.ts`**
   - ä¿®æ”¹è®¢å•æ–¹å‘åˆ¤æ–­ï¼ˆåŒºåˆ†å¼€ä»“å’Œå¹³ä»“ï¼‰

### 3.2 éœ€è¦æ–°å¢çš„åŠŸèƒ½

1. **å–ç©ºæƒé™æ£€æŸ¥æœåŠ¡**
2. **ä¿è¯é‡‘ç®¡ç†æœåŠ¡**
3. **çŠ¶æ€è½¬æ¢éªŒè¯æœåŠ¡**
4. **å–ç©ºæŒä»“åŒæ­¥æœåŠ¡**

---

## 4. æµ‹è¯•å»ºè®®

### 4.1 å•å…ƒæµ‹è¯•
- æµ‹è¯•è´Ÿæ•°æ•°é‡éªŒè¯
- æµ‹è¯•å–ç©ºæŒä»“è®¡ç®—
- æµ‹è¯•å¹³ä»“æ•°é‡é™åˆ¶
- æµ‹è¯•çŠ¶æ€è½¬æ¢éªŒè¯

### 4.2 é›†æˆæµ‹è¯•
- æµ‹è¯•å–ç©ºè®¢å•æäº¤æµç¨‹
- æµ‹è¯•å–ç©ºæŒä»“ç®¡ç†æµç¨‹
- æµ‹è¯•å¹³ä»“æµç¨‹
- æµ‹è¯•æ··åˆæŒä»“å¤„ç†

### 4.3 è¾¹ç•Œæµ‹è¯•
- æµ‹è¯•å–ç©ºæ•°é‡ä¸º0çš„æƒ…å†µ
- æµ‹è¯•å¹³ä»“æ•°é‡è¶…è¿‡å–ç©ºæ•°é‡çš„æƒ…å†µ
- æµ‹è¯•ä¿è¯é‡‘ä¸è¶³çš„æƒ…å†µ
- æµ‹è¯•æ— å–ç©ºæƒé™çš„æƒ…å†µ

---

## 5. é£é™©è¯„ä¼°

### 5.1 é«˜é£é™©
- âš ï¸ **æ•°é‡éªŒè¯é”™è¯¯**ï¼šå¯èƒ½å¯¼è‡´é”™è¯¯çš„è®¢å•æäº¤
- âš ï¸ **æŒä»“è®¡ç®—é”™è¯¯**ï¼šå¯èƒ½å¯¼è‡´èµ„é‡‘æŸå¤±
- âš ï¸ **çŠ¶æ€åŒæ­¥é”™è¯¯**ï¼šå¯èƒ½å¯¼è‡´ç­–ç•¥æ‰§è¡Œé”™è¯¯

### 5.2 ä¸­é£é™©
- âš ï¸ **ç›ˆäºè®¡ç®—é”™è¯¯**ï¼šå¯èƒ½å¯¼è‡´é”™è¯¯çš„å†³ç­–
- âš ï¸ **è®¢å•æ–¹å‘åˆ¤æ–­é”™è¯¯**ï¼šå¯èƒ½å¯¼è‡´é”™è¯¯çš„è®¢å•ç±»å‹

### 5.3 ä½é£é™©
- âš ï¸ **é”™è¯¯å¤„ç†ä¸å®Œå–„**ï¼šå¯èƒ½å¯¼è‡´ç”¨æˆ·ä½“éªŒé—®é¢˜

---

## 6. å®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šæ ¸å¿ƒä¿®å¤ï¼ˆ1å‘¨ï¼‰
1. ä¿®å¤å†²çª1-4ï¼ˆP0ä¼˜å…ˆçº§ï¼‰
2. æ·»åŠ åŸºç¡€æµ‹è¯•

### é˜¶æ®µ2ï¼šå®Œå–„åŠŸèƒ½ï¼ˆ1å‘¨ï¼‰
1. ä¿®å¤å†²çª5-7ï¼ˆP1ä¼˜å…ˆçº§ï¼‰
2. æ·»åŠ é›†æˆæµ‹è¯•

### é˜¶æ®µ3ï¼šé”™è¯¯å¤„ç†ï¼ˆ1å‘¨ï¼‰
1. ä¿®å¤å†²çª8ï¼ˆP2ä¼˜å…ˆçº§ï¼‰
2. å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-12-25  
**çŠ¶æ€**ï¼šå¾…å®¡æ ¸


