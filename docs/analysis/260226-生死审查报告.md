# 量化交易系统生死审查报告

**日期**: 2026-02-26
**审查范围**: commit `ee213f2` 之后的残余漏洞审计
**审查人**: 系统审计

---

## 一、裁决: CONDITIONAL PASS (有条件放行)

Feb 26 可以开盘交易，但必须满足以下全部条件：

1. 开盘前执行 6 条 DB 预检查询，处理所有异常
2. 修复 4 个 P0 安全漏洞 (V1, V2, V11, V12) — 共约 10 行代码
3. 修复分时评分系统 + 实装 VIX 自适应阈值
4. 策略诊断 API 升级 — 新增分时评分测试端点 + simulate 增强
5. 通过诊断 API 验证所有数据源正常、评分计算正确
6. 交易全程按监控清单执行

---

## 二、证据基础

| 数据源 | 状态 |
|--------|------|
| commit `22901e7` diff (2/9 策略优化) | 已获取 |
| commit `21efbe52` diff (2/23 — 仅 favicon，无交易逻辑) | 已获取 |
| commit `ee213f2` diff (6项P0修复 + Iron Dome) | 已获取 |
| 当前 HEAD 代码审查 | 已完成 |
| `docs/analysis/260225-订单数据逆向审查报告.md` | 已读取 |
| `docs/analysis/260225-二次深度审查报告.md` | 已读取 |
| Docker 日志 `trading-app-25.csv` (212,740 行) | 已分析 |
| API 订单 JSON (2/23 + 2/9) | Cloudflare 拦截，使用文档汇总数据 |

---

## 三、ee213f2 修复验证

对 commit `ee213f2` 中的 6 项 P0 修复逐一进行代码验证，确认全部生效：

| Fix | 内容 | 代码验证 |
|-----|------|---------|
| A | 删除 deviation 公式 (line 906-908 注释替代) | TSLPPCT 固定 45%/60% |
| B | protectionOrderId 无条件清除 (line 1031) | 不再依赖 isTslpFill 分支 |
| C | SELL 时取消 broker 端 TSLPPCT (line 1006-1018) | cancelProtection 调用 |
| D | SELECT 加 execution_stage + isTslpFill 重写 (line 583, 967-970) | 双路径检测 |
| E | fill_processed 前移到 TSLPPCT 之前 (line 751-753) | 消除重入窗口 |
| F | DST 时区自适应 (option-dynamic-exit:590-607) | 动态计算 UTC-ET 偏移 |

**主因链已斩断**: `deviation -> SELECT缺列 -> isTslpFill恒false -> protectionOrderId残留 -> 新仓位零保护` 的连锁已不再可能。

---

## 四、残余漏洞清单 (12 项)

### P0 — 开盘前修复

#### V1. Shadow-Pricer costPrice 回退导致 Layer 1 失效

- **文件**: `strategy-scheduler.service.ts:4149-4151`
- **问题**: `currentPrice` 回退链中包含 `costPrice`（入场成本价）。当 `currentPrice/lastPrice` 都缺失时回退到 `costPrice`，导致 `currentPrice < entryPrice * 0.10` 变成 `entryPrice < entryPrice * 0.10`，永远 false。Shadow-Pricer Layer 1 失效。
- **修复**: 删除 `pos.costPrice || pos.cost_price`，让 `currentPrice` 归零后被 `if (currentPrice <= 0) continue` 跳过。**1 行改动。**

#### V2. Reconciliation 不更新 dailyRealizedPnL — 熔断器盲区

- **文件**: `strategy-scheduler.service.ts:4252-4260`
- **问题**: 0DTE 到期归零 -> reconciliation 标记 `BROKER_TERMINATED` -> 写了 `lastTradePnL` 但没写 `dailyRealizedPnL` -> 熔断器 SUM 查询看不到这笔亏损 -> 策略继续开新仓。
- **修复**: 在 updateState 中增加 `dailyRealizedPnL`、`consecutiveLosses`、`dailyTradeCount`。**3 行改动。**

#### V11. MIN_TRAILING_PERCENT = 8 是潜伏的回归入口

- **文件**: `trailing-stop-protection.service.ts:27`
- **问题**: deviation 公式已删，当前 TSLPPCT 不可能触及 8%。但常量仍为 8，未来任何新的调整逻辑都可能重蹈覆辙。
- **修复**: `MIN_TRAILING_PERCENT = 8` -> `MIN_TRAILING_PERCENT = 30`。**1 行改动。**

#### V12. dailyRealizedPnL NaN 毒化 — 熔断器完全失效

- **文件**: `strategy-scheduler.service.ts:996`
- **Docker 日志铁证**: `[2026-02-24 16:32:25] 策略 10 标的 SPY.US: 本笔PnL=$NaN, 日内累计=$NaN, 连亏=0笔`
- **根因**: ee213f2 在 line 985 增加 `if (sellEntryPrice > 0 && avgPrice > 0)` 防止新的 NaN 产生，但 line 996 的 `context.dailyRealizedPnL ?? 0` 无法捕获已存在的 NaN（NaN 不是 null/undefined，`??` 运算符不生效）。
- **IEEE 754 致命性**: `NaN <= -300` -> `false`。熔断器永远不触发。这是 Feb 24 亏损从 -$51 滚到 -$547 的直接推手。
- **修复**: 读取时增加 NaN guard。**4 行改动。**

```typescript
const rawPrevPnL = parseFloat(String(context.dailyRealizedPnL ?? 0));
const prevDailyPnL = isNaN(rawPrevPnL) ? 0 : rawPrevPnL;
const rawPrevLosses = parseInt(String(context.consecutiveLosses ?? 0), 10);
const prevConsecutiveLosses = isNaN(rawPrevLosses) ? 0 : rawPrevLosses;
```

### P1 — 本周内修复

| 编号 | 漏洞 | 位置 | 影响 | 建议 |
|------|------|------|------|------|
| V3 | 熔断器不强平 HOLDING 仓位 | line 1469-1472 | 熔断后已持有仓位继续被普通退出逻辑管理 | 熔断触发时对 HOLDING 设置 -15% 止损 |
| V4 | TSLP 失败计数器进程重启归零 | line 65 | 重启后允许 2 笔裸仓交易 | 持久化到 JSONB context |
| V5 | PartialFilledStatus 资金泄漏 | line 651 vs 741 | 部分成交未成交部分资金不释放 | 加入 fill 处理条件 |
| V6 | PnL 手续费 `sellEntryFees * 2` 估算 | line 987 | 熔断阈值精度偏差 $15-25/天 | 用实际费用替代 |

### P2 — 两周内修复

| 编号 | 漏洞 | 位置 | 影响 | 时限 |
|------|------|------|------|------|
| V7 | DST 修复依赖非标准 `toLocaleString` 解析 | option-dynamic-exit:599-601 | 当前正常，但规范不保证 | 3/8 DST 切换前 |
| V8 | 持仓缓存最大 90 秒延迟 | POSITION_CACHE_TTL = 30s + 60s Iron Dome 周期 | 对 90% 亏损阈值可接受 | 无需修改 |
| V9 | 熔断器重置有边缘空洞 | line 1545-1567 | 无 lastExitTime 的实例永远不重置 | DB 预检清理 |
| V10 | TSLPPCT 成交 PnL 追踪 5-10 秒窗口 | line 2787-2804 vs 976-998 | 最终一致性可接受 | 无需修改 |

---

## 五、修复实施记录

### Commit 1: 4 个 P0 安全漏洞修复

| 修改 | 文件 | 行号 | 操作 | 改动量 |
|------|------|------|------|--------|
| V1 | `strategy-scheduler.service.ts` | 4149-4151 | 删除 `costPrice` 回退 | 1 行 |
| V2 | `strategy-scheduler.service.ts` | 4252-4260 | reconciliation 加 PnL/亏损计数 | 3 行 |
| V12 | `strategy-scheduler.service.ts` | 994-996 | NaN guard (prevDailyPnL + prevConsecutiveLosses) | 4 行 |
| V11 | `trailing-stop-protection.service.ts` | 27 | `MIN_TRAILING_PERCENT` 8 -> 30 | 1 行 |

### Commit 2: 分时评分系统重写 + VIX 自适应阈值

| 修改 | 文件 | 内容 |
|------|------|------|
| 分时评分重写 | `option-recommendation.service.ts` | 重写 `calculateIntradayScore` — 引入标的 1m VWAP + 动量 + SPX 分时 |
| 权重调整 | `option-recommendation.service.ts` | `market * 0.4 + intraday * 0.4` -> `market * 0.2 + intraday * 0.6` |
| 结构一致性检查 | `option-recommendation.service.ts` | 方向决策后 VWAP 位置验证 |
| VIX 自适应 | `option-intraday-strategy.ts` | `getThresholds()` 加入 VIX 因子 |
| SPX 分时数据 | `market-data.service.ts` | 新增 `getSPXHourlyCandlesticks()` |
| 缓存更新 | `market-data-cache.service.ts` | 接口增加 `spxHourly` |

### Commit 3: 策略诊断 API 升级

| 修改 | 文件 | 内容 |
|------|------|------|
| 接口扩展 | `option-recommendation.service.ts` | `OptionRecommendation` 增加 intradayComponents/vwapData/structureCheck/currentVix |
| simulate 增强 | `quant.ts` | 展示 VIX 因子、分时各组件得分、结构检查 |
| 分时诊断端点 | `quote.ts` | 新增 `GET /api/quote/intraday-scoring-test` |
| SPX 分时测试 | `futunn-test.ts` | 新增 `GET /api/futunn-test/test-spx-hourly` |

---

## 六、开盘前 DB 预检 (6 条 SQL)

```sql
-- Q1: 孤儿非终态订单
SELECT order_id, symbol, side, current_status, fill_processed, created_at
FROM execution_orders
WHERE created_at >= CURRENT_DATE - INTERVAL '2 days'
  AND current_status NOT IN ('FILLED', 'CANCELLED', 'FAILED')
ORDER BY created_at DESC;
-- 期望: 空

-- Q2: 残留熔断状态
SELECT strategy_id, symbol, current_state,
       context->>'circuitBreakerActive' as cb_active,
       context->>'circuitBreakerReason' as cb_reason
FROM strategy_instances
WHERE context->>'circuitBreakerActive' = 'true';
-- 期望: 空。若有前日残留:
-- UPDATE strategy_instances SET context = context - 'circuitBreakerActive'
--   - 'circuitBreakerReason' - 'circuitBreakerTime'
-- WHERE context->>'circuitBreakerActive' = 'true';

-- Q3: 孤儿 HOLDING 状态
SELECT si.strategy_id, si.symbol, si.current_state,
       si.context->>'tradedSymbol' as traded_symbol,
       si.context->>'protectionOrderId' as protection_id
FROM strategy_instances si
WHERE si.current_state IN ('HOLDING', 'OPENING', 'CLOSING');
-- 期望: 空

-- Q4: 资金一致性
SELECT ca.strategy_id, s.name, ca.used_amount,
       (SELECT COUNT(*) FROM strategy_instances si
        WHERE si.strategy_id = ca.strategy_id AND si.current_state = 'HOLDING') as holding_count
FROM capital_allocations ca
JOIN strategies s ON ca.strategy_id = s.id
WHERE s.status = 'RUNNING' AND ca.used_amount > 0;
-- 期望: used_amount > 0 仅当 holding_count > 0

-- Q5: 未处理成交
SELECT order_id, symbol, side, current_status, fill_processed
FROM execution_orders
WHERE current_status = 'FILLED' AND fill_processed IS NOT TRUE
  AND created_at >= CURRENT_DATE - INTERVAL '2 days';
-- 期望: 空

-- Q6: PnL/亏损计数器状态
SELECT strategy_id, symbol,
       context->>'dailyRealizedPnL' as daily_pnl,
       context->>'consecutiveLosses' as consec_losses
FROM strategy_instances
WHERE (context->>'dailyRealizedPnL')::numeric != 0;
-- 期望: 如 lastExitTime 是昨天的，值会在首个周期自动重置
```

---

## 七、首日交易监控清单

### 盘前

- [ ] 进程启动日志含 `Iron Dome: 60秒`
- [ ] DB 预检 Q1-Q6 全部通过
- [ ] 无 `TSLP_BLOCKED` 日志（计数器归零）

### 首笔交易 (10 秒内观察)

- [ ] `fill_processed = TRUE` 出现在 `TSLPPCT保护单已提交` 之前
- [ ] TSLPPCT trailing = 45% (0DTE) 或 60% (非0DTE)，不是 8%
- [ ] `protectionOrderId` 已写入 context

### 持续监控 (每 5 分钟)

- [ ] `[IRON_DOME:SHADOW_PRICER]` — 出现说明 Layer 1 运行中
- [ ] `[IRON_DOME:RECONCILIATION]` — 出现说明账实不符，立即检查
- [ ] `[CIRCUIT_BREAKER]` — 出现说明日内亏损触发熔断
- [ ] `日内累计` PnL 数值与券商一致

### 收盘后

- [ ] 所有 strategy_instances 为 IDLE
- [ ] `dailyRealizedPnL` 与券商 P&L 报表对账
- [ ] 无残留 TSLPPCT 订单
- [ ] `used_amount = 0`

---

## 八、亏损归因

### Feb 24 (-$547)

| 标的 | 亏损 | 占比 | 归因 | 修复状态 |
|------|------|------|------|---------|
| SPY 686 Put | -$289 | 53% | protectionOrderId 残留 -> 零保护 | ee213f2 Fix B+C |
| QQQ 606 Put | -$163 | 30% | deviation 公式压缩 TSLPPCT 到 8% | ee213f2 Fix A |
| QQQ 607 Put | -$90 | 16% | TSLPPCT 8% + 竞态被拒 | ee213f2 Fix A+E |
| QQQ 605 Put | -$5 | 1% | TSLPPCT 10% 触发 | ee213f2 Fix A |

**系统致因占比**: ~85% ($452/$547) 归因于可证实的代码缺陷，已修复。

### Feb 23 (-$290 net)

反转行情亏损，已有熔断修复 (consecutiveLosses >= 4 触发)。

**市场致因占比**: ~15% 正常交易亏损 + Feb 23 反转。

---

## 九、Docker 日志分析 (Feb 24 交易日)

### 数据来源

`trading-app-25.csv`，212,740 行日志。

### 入场信号决策链

大盘评分体系 (日志原文):

```
[大盘评分明细] 总分=-15.0~-15.2
  SPX趋势: -24.2~-24.8 -> 加权后 -9.7~-9.9
  USD Index: +25.1~+25.2 -> 加权后 -5.0
  BTC: -74.1~-75.0 -> *0.1 -> -7.4~-7.5
  市场温度: 74 -> +7.2
```

综合得分 -15.0 <= -8 阈值 -> 触发 BEAR_SPREAD (买入 PUT)。

### 入场时间线 (ET)

| 时间 (ET) | 事件 | 备注 |
|-----------|------|------|
| 16:31:04 | SPY.US 生成 BUY 信号, price=1.38, BEAR_SPREAD 得分-8.3 | 首次入场信号 |
| 16:31:04 | QQQ.US 生成 BUY 信号, price=1.01, BEAR_SPREAD 得分-8.3 | 同时信号 |
| 16:31:36 | 执行买入 QQQ260224P607000.US, qty=3, price=1.38 | 市价单 |
| 16:31:55 | QQQ260224P606000.US 成交 -> HOLDING | 成交确认 |
| 16:31:55 | SPY260224P686000.US 成交 -> HOLDING | 成交确认 |
| 16:32:00 | QQQ 607 SELL: 结构失效 — PUT 但标的站回 VWAP 上方 | **16 秒后退出** |
| 16:31:21 | SPY 686 SELL: 结构失效 — PUT 但标的站回 VWAP 上方 | 更早已在卖 |
| 16:32:25 | SPY PnL=$NaN, 日内累计=$NaN, 连亏=0 | **NaN 毒化** |

### NaN 毒化发现

**代码路径推演:**

1. 第一笔 SPY PUT 卖出 -> `sellEntryPrice` 或 `avgPrice` 为 0 或 undefined
2. `tradePnL = (avgPrice - sellEntryPrice) * sellQty * sellMultiplier - sellEntryFees * 2` -> **NaN**
3. `newDailyPnL = prevDailyPnL + tradePnL` -> **NaN**
4. 写入 context: `dailyRealizedPnL: NaN`
5. 后续所有 PnL 计算: `NaN + anyNumber = NaN`
6. 熔断检查: `NaN <= -300` -> **false** (IEEE 754)
7. **熔断器永远不触发**

这是 Feb 24 从 -$51 滚到 -$547 的直接原因: 熔断器被 NaN 毒化后完全失效。

### 入场方向审查

**结论: PUT 入场方向决策本身合理，但入场-退出系统存在维度冲突。**

支持 PUT 的证据:
- 大盘综合得分 -15.0 到 -15.2 (远超 -8 阈值)
- VIX = 19.53-19.63 (中等偏高)
- 市场温度 = 74-76 (偏热，有回调压力)
- USD Index 偏强 (+25.1)

问题不在入场方向，而在:
1. **16 秒闪电平仓**: 入场后第一个监控周期就触发退出，入场时机与退出条件矛盾
2. **PnL = NaN**: 导致后续所有 PnL 追踪失效
3. **日内累计始终 -$51 不增长**: NaN 写入 context 后无法恢复
4. **无限重新入场**: 得分持续 -8.0 到 -8.3，每个周期都触发新的 BUY 信号

### 根因: 入场-退出看不同时间维度

| 时间 (ET) | 大盘评分 | 分时评分 | finalScore | 标的 vs VWAP |
|-----------|---------|---------|------------|-------------|
| 16:31:31 | -15.4 | -0.0 | -8.1 | SPY 685.45 > VWAP 684.30 |
| 16:31:52 | -15.5 | -0.0 | -8.0 | QQQ 606.70 > VWAP 605.12 |
| 16:32:00 | -- | -- | -- | 结构失效退出 (16秒后) |

得分构成: `finalScore = marketScore(-15) * 0.4 + intradayScore(-0.0) * 0.4 + timeWindow * 0.2 = -8.0`

- **入场系统**: 日线趋势 + 宏观指标 -> "空"
- **退出系统**: 分钟K线 + VWAP -> "结构不支持空"
- 两个系统用完全不同的时间维度做决策，互相打架

---

## 十、分时评分系统重写 (已实施)

### 旧系统 (问题诊断)

Docker 日志铁证:
```
[分时评分明细] 总分=0.0 | BTC时K=0.1->0.0 | USD时K=0.0->0.0 | SPX近5日动量=-0.2->-0.1
```

分时评分三个组件全部约等于 0，`finalScore` 完全由 `marketScore` (日线数据) 单独驱动。

**旧组件构成**:

| 组件 | 权重 | 数据源 | 实际频率 | 问题 |
|------|------|--------|---------|------|
| BTC 小时K | 40% | Moomoo 小时K | 小时 | 非标的数据，API 可能返回 <10 根则跳过 |
| USD 小时K | 20% | Moomoo 小时K | 小时 | 非标的数据，同上 |
| SPX 近5日 | 40% | `marketData.spx.slice(-5)` | **日线** | 完全不是分时，是日K伪装成分时 |

**致命后果**: 入场系统用日线得分买 PUT -> 退出系统用 1m VWAP 发现结构不支持 -> 16 秒平仓 -> 反复循环 -> -$547。

### 新系统

| 组件 | 权重 | 数据源 | 说明 |
|------|------|--------|------|
| 标的 1m 动量 | 30% | `getIntradayVWAP(symbol).recentKlines` | 标的自身分钟级动量 (已有 API) |
| VWAP 位置得分 | 15% | `getIntradayVWAP(symbol).vwap` | 价格在 VWAP 上方=看涨，下方=看跌 |
| SPX 分时动量 | 25% | `getSPXHourlyCandlesticks()` (新增) | 真正的 SPX 分时数据替代日K |
| BTC 小时K | 15% | 现有 `marketData.btcHourly` | 保留但降权 (风险情绪参考) |
| USD 小时K | 15% | 现有 `marketData.usdIndexHourly` | 保留但降权 (反向) |

### 权重变更

```
旧: finalScore = marketScore * 0.4 + intradayScore * 0.4 + timeWindow * 0.2
新: finalScore = marketScore * 0.2 + intradayScore * 0.6 + timeWindow * 0.2
```

**经济学逻辑**: 0DTE 期权 6.5 小时到期，日线趋势只是背景参考，分钟级动量和结构才是决策核心。

### 结构一致性前置检查

入场方向决策后，新增 VWAP 结构验证:

- 如果 `direction = PUT` 但价格在 VWAP 上方，且 `|finalScore| < 30` -> 降级为 HOLD
- 如果 `direction = CALL` 但价格在 VWAP 下方，且 `|finalScore| < 30` -> 降级为 HOLD
- 只有极强信号 (`|finalScore| >= 30`) 才允许方向与 VWAP 不一致

**Feb 24 假设推演**: 标的在 VWAP 上方 -> PUT 信号被拒 -> 首轮 3 笔闪退 -$67 完全避免。

### 降级逻辑

- `underlyingVWAP` 为 null -> 标的动量和 VWAP 组件返回 0 (丢失 45% 权重)
- `spxHourly` 不足 -> SPX 分时组件返回 0 (丢失 25% 权重)
- 所有分时数据缺失 -> `intradayScore` 约等于 0 -> `finalScore` 约等于 `marketScore * 0.2` -> 几乎不可能超过方向阈值 -> **不入场，安全降级**

---

## 十一、风险模式入场阈值分析：固定值 vs 动态公式

### 当前架构两层阈值矛盾

系统有**两层阈值**，彼此独立且存在设计矛盾：

**层 1 — 信号方向判定** (`option-recommendation.service.ts:120-141`)
```
CALL: finalScore > 15 | PUT: finalScore < -15 | HOLD: [-15, 15]
```
硬编码 ±15，不受风险模式影响。

**层 2 — 策略入场门控** (`option-intraday-strategy.ts:314-377`)
```
CONSERVATIVE: |score| >= 20 才入场
STANDARD:     |score| >= 12 才入场
AGGRESSIVE:   |score| >= 8  才入场
```
风险模式控制的固定阈值。

**矛盾 1**: AGGRESSIVE 阈值 8 对 spread 策略生效（绕过层 1 方向判定），但 directional 策略需要 `|score| >= 15` 才有方向，所以阈值 8 对 directional 无效。

**矛盾 2**: STANDARD 模式的 `riskPreference` 设为 `'AGGRESSIVE'`（前端 line 53），但 `entryThresholdOverride` 为 12。覆盖了后端 `ENTRY_THRESHOLDS.AGGRESSIVE` 的基础值 10，实际比后端定义的 AGGRESSIVE 还保守。

### 固定阈值的三大问题

**问题 1: 对期权波动率的盲视**
- VIX = 12 时，score = -12 的 PUT 可能是强趋势信号
- VIX = 35 时，score = -12 的 PUT 可能只是正常噪音
- 同一阈值在不同 VIX 环境下含义完全不同

**问题 2: 对信号分布的假设过于天真**
- 震荡市：score 不超过 ±20，阈值 20 (CONSERVATIVE) 永远不入场
- 单边趋势市：score 可达 ±60，阈值 8 (AGGRESSIVE) 几乎不过滤

**问题 3: 缺少信号强度与仓位联动**
- score = -8 和 score = -50 入场合约数完全相同

### Feb 24 实证

- BEAR_SPREAD 阈值 = 8（AGGRESSIVE）
- 得分在 -8.0 到 -8.3 窄幅波动，每个周期刚过阈值就触发信号
- 反复入场 → 16 秒闪退 → 再入场 → 再闪退

### 可选增强：信号强度联动仓位（P2）

```typescript
function getPositionMultiplier(score: number, threshold: number): number {
  const signalStrength = Math.abs(score) / threshold;
  if (signalStrength < 1.5) return 1.0;
  if (signalStrength < 2.5) return 1.0 + (signalStrength - 1.5) * 0.5;
  return 1.5;
}
```

弱信号用小仓位试探，强信号用正常/大仓位跟进。

### 逆势识别分析 (P2)

当日线和分钟级结构矛盾时（如日线空 + VWAP 上方），不应直接反转做 CALL。

**建议方案 — 矛盾检测 + 观望**:
- 方案 A (保守): 不入场，等结构统一 → return HOLD
- 方案 B (激进): 矛盾持续 ≥3 个周期且 intradayScore > 5 → 半仓 CALL 试探

**Feb 24 推演 (方案 B)**: 分时评分全程 ≈ 0，`intradayScore > 5` 不满足 → CALL 不会触发。在 Feb 24 数据下方案 B 也不会产生 CALL 信号。

**根本改进**: 当前分时评分不包含标的自身数据 — 已在本次重写中修复（新增标的 1m 动量 + VWAP 位置），使入场和退出看同一套数据。

### 综合对比

| 维度 | 固定阈值 (旧) | VIX-自适应阈值 (新) |
|------|----------------|---------------------|
| 震荡市过滤 | 差（AGGRESSIVE 几乎不过滤） | 好（VIX 高时自动提高阈值） |
| 趋势市捕捉 | 差（CONSERVATIVE 永远不入场） | 好（VIX 低时自动降低阈值） |
| 边缘信号 | 反复触发（Feb 24 实证） | 被 VIX 因子过滤 |
| 实现复杂度 | 零 | 低（1 个函数 + VIX 数据已有） |

---

## 十二、VIX 自适应阈值 (已实施)

### 核心思想

固定阈值 (8/12/20) 完全忽略当前 VIX 环境:
- VIX = 12 (低波动) 时，score = -12 的信号可能代表强趋势
- VIX = 35 (高波动) 时，score = -12 可能只是正常噪音

高 VIX = 高噪音 -> 需要更强的信号才值得入场。低 VIX = 低噪音 -> 较弱的信号也有可靠性。

### 公式

```
effectiveThreshold = baseThreshold * vixFactor
vixFactor = max(0.5, min(2.5, VIX / 20))
```

### 阈值效果表

| VIX | 因子 | AGGRESSIVE (base=8) | STANDARD (base=12) | CONSERVATIVE (base=20) |
|-----|------|---------------------|---------------------|------------------------|
| 12 | 0.60 | 5 | 7 | 12 |
| 15 | 0.75 | 6 | 9 | 15 |
| 20 | 1.00 | 8 | 12 | 20 |
| 25 | 1.25 | 10 | 15 | 25 |
| 30 | 1.50 | 12 | 18 | 30 |
| 35 | 1.75 | 14 | 21 | 35 |

### 数据传递

`option-recommendation.service.ts` 返回 `currentVix` -> `option-intraday-strategy.ts` 在 `generateSignal` 中取出 -> 传入 `getThresholds(vix)`。VIX 不可用时 `factor = 1.0`，回退到固定阈值。

---

## 十三、诊断 API 使用指南

### 端点 1: 分时评分数据管道测试

```
GET /api/quote/intraday-scoring-test?symbol=SPY.US
```

独立验证分时评分各组件数据获取和计算，不触发任何交易逻辑。

**调用示例**:
```bash
curl "http://localhost:3000/api/quote/intraday-scoring-test?symbol=SPY.US"
```

**返回结构**:
```json
{
  "symbol": "SPY.US",
  "timestamp": "2026-02-26T...",
  "underlyingVWAP": {
    "success": true,
    "vwap": 684.30,
    "dataPoints": 120,
    "recentKlines": [{"time": "...", "close": 685.45}],
    "latency_ms": 230
  },
  "spxHourly": {
    "success": true,
    "barCount": 78,
    "latestBar": {"time": "...", "open": 5950.2, "close": 5955.8, "volume": 1234567},
    "latency_ms": 180
  },
  "btcHourly": { "success": true, "barCount": 24, "latestBar": {...}, "latency_ms": 150 },
  "usdHourly": { "success": true, "barCount": 24, "latestBar": {...}, "latency_ms": 150 },
  "vix": { "success": true, "currentValue": 19.53, "vixFactor": 0.98 },
  "scoring": {
    "underlyingMomentum": 12.5,
    "vwapPosition": -8.3,
    "spxIntraday": 5.2,
    "btcHourly": -3.1,
    "usdHourly": 1.8,
    "intradayScore": 8.1,
    "marketScore": -15.2,
    "finalScore": -1.8,
    "direction": "HOLD",
    "structureMismatch": false
  },
  "thresholds": {
    "aggressive": { "base": 8, "effective": 7.8 },
    "standard": { "base": 12, "effective": 11.7 },
    "conservative": { "base": 20, "effective": 19.5 }
  }
}
```

**验证要点**:
- 所有 `success = true`
- `scoring` 各组件非零
- `vixFactor` 在 [0.5, 2.5] 范围内
- `underlyingVWAP.dataPoints >= 5`

### 端点 2: SPX 分时数据测试

```
GET /api/futunn-test/test-spx-hourly
```

**调用示例**:
```bash
curl "http://localhost:3000/api/futunn-test/test-spx-hourly"
```

**验证要点**:
- `barCount >= 10`
- `latestBar` 的时间为今日盘中时间
- 延迟合理 (< 5000ms)

### 端点 3: 策略模拟 (增强版)

```
POST /api/quant/strategies/{id}/simulate
```

**调用示例**:
```bash
curl -X POST "http://localhost:3000/api/quant/strategies/10/simulate" \
  -H "Content-Type: application/json" \
  -d '{"symbols": ["SPY.US"]}'
```

**新增返回字段**:
```json
{
  "marketData": {
    "marketScore": -15.2,
    "intradayScore": 8.1,
    "finalScore": -1.8,
    "intradayComponents": {
      "underlyingMomentum": 12.5,
      "vwapPosition": -8.3,
      "spxIntraday": 5.2,
      "btcHourly": -3.1,
      "usdHourly": 1.8
    },
    "currentVix": 19.53,
    "vwapData": { "vwap": 684.30, "lastPrice": 685.45, "distancePct": 0.17, "priceAboveVWAP": true },
    "structureCheck": {
      "mismatch": true,
      "originalDirection": "PUT",
      "finalDirection": "HOLD",
      "reason": "PUT但价格>VWAP, 得分8.0<30, 降级HOLD"
    }
  },
  "signalEvaluation": {
    "thresholds": {
      "directionalScoreMin": 8,
      "spreadScoreMin": 6,
      "vixFactor": 0.98,
      "baseThreshold": 8,
      "effectiveThreshold": 8
    }
  }
}
```

**验证要点**:
- `intradayComponents` 各字段有值
- `vixFactor` 在合理范围
- `structureCheck` 有值且逻辑正确

### 盘前自动化检查流程

1. 调用 `intraday-scoring-test`，验证 5 个数据源全部返回
2. 确认 VIX 因子在 [0.5, 2.5] 范围内
3. 确认 `underlyingVWAP` 有 >= 5 根 K 线
4. 调用 `test-spx-hourly`，确认 `barCount >= 10`
5. 调用 simulate 端点，确认 `intradayComponents`、`vixFactor`、`structureCheck` 有值

---

## 附录: 关键文件清单

| 文件 | 修改内容 | 行号 |
|------|---------|------|
| `api/src/services/strategy-scheduler.service.ts` | V1: 删 costPrice 回退 | 4149-4151 |
| `api/src/services/strategy-scheduler.service.ts` | V2: reconciliation 加 PnL 追踪 | 4252-4260 |
| `api/src/services/strategy-scheduler.service.ts` | V12: NaN guard | 994-996 |
| `api/src/services/trailing-stop-protection.service.ts` | V11: MIN_TRAILING 8->30 | 27 |
| `api/src/services/option-recommendation.service.ts` | 分时评分重写 + 权重 + 结构检查 + 接口扩展 | 101-321 |
| `api/src/services/strategies/option-intraday-strategy.ts` | VIX 自适应阈值 | 249-258 |
| `api/src/services/market-data.service.ts` | 新增 getSPXHourlyCandlesticks | 714-736 |
| `api/src/services/market-data-cache.service.ts` | 缓存接口增加 spxHourly | 22-33 |
| `api/src/routes/quant.ts` | simulate 端点增强 | 2125-2267 |
| `api/src/routes/quote.ts` | 新增 intraday-scoring-test | 新增 |
| `api/src/routes/futunn-test.ts` | 新增 SPX 分时测试 | 新增 |
