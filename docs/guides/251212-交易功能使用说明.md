# 交易功能使用说明

## 功能概述

现在系统已经支持在前端直接交易股票！您可以：
- ✅ 买入股票
- ✅ 卖出股票
- ✅ 查看交易记录
- ✅ 取消订单

## 如何使用

### 1. 在主页面交易

1. **打开主页**：访问主页，您会看到所有持仓和关注的股票
2. **点击交易按钮**：
   - 对于**没有持仓**的股票，显示"**买入**"按钮（蓝色）
   - 对于**有持仓**的股票，显示"**卖出**"按钮（蓝色）
3. **填写交易信息**：
   - 选择交易方向（买入/卖出）
   - 选择订单类型：
     - **限价单 (LO)**：需要指定价格，按设定价格成交
     - **竞价单 (AO)**：不需要指定价格，按市场价格成交
     - **增强限价单 (ELO)**：需要指定价格，增强版限价单
     - **特别限价单 (EAO)**：不需要指定价格，特别限价单
   - 输入数量（必须是整数）
   - 如果是限价单，输入价格（可以使用快捷按钮：-1%、当前价、+1%）
4. **确认交易**：点击"确认买入"或"确认卖出"按钮
5. **查看结果**：订单提交后，可以在"交易记录"页面查看订单状态

### 2. 订单类型说明

| 订单类型 | 代码 | 是否需要价格 | 说明 |
|---------|------|------------|------|
| 限价单 | LO | ✅ 是 | 按指定价格成交 |
| 竞价单 | AO | ❌ 否 | 按市场价格成交 |
| 增强限价单 | ELO | ✅ 是 | 增强版限价单 |
| 特别限价单 | EAO | ❌ 否 | 特别限价单 |

### 3. 查看交易记录

访问"交易记录"页面，可以查看：
- 所有历史交易记录
- 订单状态（成功/失败/处理中/已取消）
- 订单ID
- 交易时间

### 4. 账户余额查询

可以通过API查询账户余额（需要在代码中调用）：
```typescript
import { ordersApi } from '@/lib/api'

const balance = await ordersApi.getAccountBalance('USD')
```

## API接口

### 提交订单
```
POST /api/orders/submit
Body: {
  symbol: string        // 股票代码，例如：AAPL.US
  side: 'Buy' | 'Sell' // 交易方向
  orderType: 'LO' | 'AO' | 'ELO' | 'EAO' // 订单类型
  quantity: number     // 数量
  price?: number       // 价格（限价单需要）
}
```

### 取消订单
```
DELETE /api/orders/:orderId
```

### 查询账户余额
```
GET /api/orders/account-balance?currency=USD
```

## 注意事项

### ⚠️ 重要提醒

1. **交易权限**：确保您的长桥账户已开通交易权限
2. **Token配置**：确保`.env`文件中的`LONGPORT_ACCESS_TOKEN`有交易权限
3. **资金安全**：交易会实际执行，请谨慎操作
4. **订单状态**：订单提交后状态为"待处理"，实际成交后状态会更新
5. **美股交易**：当前账户只有美股Basic行情权限，交易也仅限美股

### 订单状态说明

- **PENDING**：订单已提交，等待处理
- **SUCCESS**：订单已成功成交
- **FAILED**：订单提交失败
- **CANCELLED**：订单已取消

### 错误处理

如果遇到错误：
1. 检查网络连接
2. 检查API服务是否运行
3. 检查Token是否有效
4. 查看浏览器控制台的错误信息
5. 查看API服务的日志

## 代码结构

### 后端文件
- `api/src/config/longport.ts` - TradeContext配置
- `api/src/routes/orders.ts` - 交易API路由

### 前端文件
- `frontend/components/TradeModal.tsx` - 交易下单组件
- `frontend/lib/api.ts` - 交易API客户端
- `frontend/app/page.tsx` - 主页（已集成交易按钮）

## 使用示例

### 买入100股AAPL，限价单，价格150美元
1. 点击AAPL股票的"买入"按钮
2. 选择"限价单 (LO)"
3. 输入数量：100
4. 输入价格：150
5. 点击"确认买入"

### 卖出50股TSLA，竞价单（市价）
1. 点击TSLA股票的"卖出"按钮
2. 选择"竞价单 (AO)"
3. 输入数量：50
4. 点击"确认卖出"

## 后续功能

后续可以添加的功能：
- [ ] 订单状态实时更新
- [ ] 持仓自动同步
- [ ] 订单列表页面
- [ ] 订单详情页面
- [ ] 批量下单功能
- [ ] 条件单功能

## 故障排查

### 问题：订单提交失败
**解决方案**：
1. 检查Token是否有交易权限
2. 检查账户余额是否充足
3. 检查股票代码格式是否正确（例如：AAPL.US）
4. 检查数量是否为整数且大于0

### 问题：TradeContext初始化失败
**解决方案**：
1. 检查`.env`文件中的长桥配置
2. 确保Token有效且有交易权限
3. 重启API服务

### 问题：前端无法连接API
**解决方案**：
1. 检查API服务是否运行在3001端口
2. 检查`NEXT_PUBLIC_API_URL`环境变量
3. 检查CORS配置

---

**现在您可以在前端直接交易股票了！** 🎉





