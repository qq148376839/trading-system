# 日志分析看板使用说明

## 📊 概述

本工具用于清洗和分析交易系统的日志文件，生成清晰的看板报告，方便快速排查问题。

## 🎯 生成的文件

1. **logs-analysis-dashboard.txt** - 文本版看板报告
2. **logs-analysis-dashboard.html** - HTML交互式看板
3. **logs-analysis-detailed.json** - 详细的分析数据（JSON格式）

## 🚀 使用方法

### 1. 分析日志文件

```bash
python scripts/analyze-logs.py
```

这会分析 `logs-2026-01-27.json` 文件，并生成：
- 文本版看板报告
- JSON详细分析数据

### 2. 生成HTML看板

```bash
python scripts/generate-html-dashboard.py
```

这会根据JSON分析数据生成美观的HTML看板。

### 3. 查看结果

- **文本版**: 打开 `logs-analysis-dashboard.txt`
- **HTML版**: 在浏览器中打开 `logs-analysis-dashboard.html`

## 📈 看板内容

### 1. 概览统计
- 总日志数
- 错误数和错误率
- 警告数和警告率
- 信息日志数量

### 2. 日志级别分布
- 🔴 ERROR (错误)
- ⚠️ WARNING (警告)
- 🔵 INFO (信息)
- 🔍 DEBUG (调试)

每个级别显示：
- 数量
- 百分比
- 可视化进度条

### 3. 关键问题

#### 数据库错误
- 问题: 验证失败日志表不存在 (错误码: 42P01)
- 出现次数: 780次
- 建议: 检查数据库迁移，确保所有表已正确创建

#### API限流问题
- 错误: openapi error: code=429002
- 出现次数: 1,088次
- 受影响模块: Strategy.Scheduler (864次), Service.Short.Position.Validation.Service (224次)
- 建议: 实现请求速率控制，添加重试机制

#### 订单相关问题
- 信号关联失败: 1,867次
- 价格更新失败: 1,040次
- 建议: 优化订单-信号关联逻辑，修复Decimal类型转换问题

### 4. 模块活动统计
显示日志记录最多的Top 10模块：
1. Strategy.Scheduler (80.87%)
2. Execution.Basic (14.03%)
3. Service.Short.Position.Validation.Service (4.08%)
...

### 5. 策略执行统计

**策略 5:**
- 执行次数: 390次
- 执行耗时: 4,845ms
- 标的状态: IDLE=7, HOLDING=3, OTHER=4
- 错误数: 5个
- 警告数: 2,390个

**策略 10:**
- 执行次数: 390次
- 执行耗时: 210ms
- 标的状态: IDLE=1

### 6. Top 错误类型

按出现次数排序的前10个错误：

1. **数据库表缺失** (780次)
   - 记录验证失败日志失败

2. **订单提交失败 - BMNR.US** (331次)

3. **订单提交失败 - HOOD.US** (296次)

4. **订单提交失败 - ACHR.US** (292次)

...

### 7. Top 警告类型

按出现次数排序的前10个警告：

1. **订单信号关联失败 - TEM.US** (780次)

2. **订单信号关联失败 - SHOP.US** (774次)

3. **订单价格更新失败 - AMD.US** (770次)
   - Decimal类型转换问题

4. **持仓context为空 - CRCL.US** (390次)

...

### 8. 优化建议

1. **修复数据库表缺失问题** - 检查并创建缺失的验证失败日志表
2. **实现API请求速率限制** - 添加请求队列和延迟机制
3. **增加API调用重试逻辑** - 使用指数退避策略
4. **修复Decimal类型转换问题** - 检查订单数量的数据类型处理
5. **优化订单-信号关联逻辑** - 检查时间窗口匹配算法
6. **降低错误率** (当前15.2%) - 需要优先处理关键错误
7. **降低警告率** (当前18.2%) - 建议检查并处理警告信息

## 🔍 关键发现

### 1. 数据库问题（高优先级）
- **问题**: 验证失败日志表不存在
- **影响**: 780次错误
- **解决方案**:
  ```sql
  -- 需要创建缺失的表
  CREATE TABLE IF NOT EXISTS validation_failure_logs (
    id SERIAL PRIMARY KEY,
    strategy_id INTEGER,
    symbol VARCHAR(20),
    failure_type VARCHAR(50),
    reason TEXT,
    timestamp TIMESTAMP DEFAULT NOW()
  );
  ```

### 2. API限流问题（高优先级）
- **问题**: 429002 错误，API请求频率过高
- **影响**: 1,088次限流
- **解决方案**:
  - 实现请求队列
  - 添加速率限制器 (Rate Limiter)
  - 实现指数退避重试策略

### 3. 订单-信号关联问题（中优先级）
- **问题**: 大量订单找不到对应的信号
- **影响**: 1,867次关联失败
- **可能原因**:
  - 时间窗口匹配算法有问题
  - 订单创建和信号创建的时间不一致
- **解决方案**:
  - 检查并优化时间窗口匹配逻辑
  - 增加日志记录，追踪订单和信号的创建时间

### 4. Decimal类型转换问题（中优先级）
- **问题**: `Unwrap value [longport_nodejs::decimal::Decimal] from class failed`
- **影响**: 1,040次价格更新失败
- **解决方案**:
  - 检查订单数量的数据类型处理
  - 确保正确使用LongPort SDK的Decimal类型

## 📝 后续行动

### 立即处理（本周）
1. ✅ 创建缺失的数据库表
2. ✅ 实现API请求速率限制
3. ✅ 修复Decimal类型转换问题

### 短期优化（2周内）
1. 优化订单-信号关联逻辑
2. 实现API调用重试机制
3. 增加更详细的错误日志

### 长期改进（1个月内）
1. 降低整体错误率到 <5%
2. 降低警告率到 <10%
3. 优化策略执行性能

## 🛠️ 工具改进计划

### 已实现功能
- ✅ 日志文件加载和解析
- ✅ 多级别日志统计
- ✅ 模块活动分析
- ✅ 错误和警告分类
- ✅ 策略执行统计
- ✅ 文本版看板
- ✅ HTML交互式看板

### 未来功能
- ⏳ 日志趋势分析（时间序列）
- ⏳ 错误关联分析（错误链路追踪）
- ⏳ 性能瓶颈分析
- ⏳ 自动告警功能
- ⏳ 实时日志监控

## 📚 相关文档

- [系统架构文档](./docs/technical/251202-量化交易系统技术文档.md)
- [API设计规范](./.cursor/rules/api-design.md)
- [测试指南](./.cursor/rules/testing.md)

## 🤝 贡献

如果发现任何问题或有改进建议，请：
1. 创建Issue描述问题
2. 提交PR进行改进

---

**生成时间**: 2026-01-27
**分析日志**: logs-2026-01-27.json
**日志数量**: 24,630条
