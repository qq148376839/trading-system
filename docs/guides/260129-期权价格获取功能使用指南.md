# æœŸæƒä»·æ ¼è·å–åŠŸèƒ½ä½¿ç”¨æŒ‡å—

**ç‰ˆæœ¬**: 2.0 (Enhanced)
**æ›´æ–°æ—¥æœŸ**: 2026-01-29

---

## ğŸ“– æ¦‚è¿°

æ–°ç‰ˆæœ¬çš„ä»·æ ¼è·å–åŠŸèƒ½æä¾›äº†æ›´å¯é çš„æœŸæƒä»·æ ¼è·å–èƒ½åŠ›ï¼Œæ”¯æŒå¤šç§ä»·æ ¼æºå›é€€å’Œè‡ªåŠ¨ç¼“å­˜ã€‚

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. å¤šçº§ä»·æ ¼å›é€€

ç³»ç»Ÿä¼šæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§å°è¯•è·å–ä»·æ ¼ï¼š

```
ä¼˜å…ˆçº§ 1: lastDoneï¼ˆæœ€è¿‘æˆäº¤ä»·ï¼‰
         â†“ ä¸å¯ç”¨
ä¼˜å…ˆçº§ 2: ä¸­é—´ä»· (bid + ask) / 2
         â†“ ä¸å¯ç”¨
ä¼˜å…ˆçº§ 3: askPriceï¼ˆå–ä¸€ä»·ï¼‰
         â†“ ä¸å¯ç”¨
ä¼˜å…ˆçº§ 4: bidPriceï¼ˆä¹°ä¸€ä»·ï¼‰
         â†“ ä¸å¯ç”¨
è¿”å› null
```

### 2. è‡ªåŠ¨ç¼“å­˜ï¼ˆä»…æœŸæƒï¼‰

- **ç¼“å­˜æ—¶é•¿**: 5åˆ†é’Ÿ
- **è‡ªåŠ¨æ¸…ç†**: æ¯10åˆ†é’Ÿæ¸…ç†è¿‡æœŸç¼“å­˜
- **é€‚ç”¨åœºæ™¯**: æœŸæƒåˆçº¦ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰
- **ä¸ç¼“å­˜**: æ™®é€šè‚¡ç¥¨ä»·æ ¼

### 3. è¯¦ç»†æ—¥å¿—

ç³»ç»Ÿä¼šè®°å½•ï¼š
- ä»·æ ¼æ¥æºï¼ˆlastDone/mid/ask/bidï¼‰
- ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­
- bid/askä»·æ ¼ä¿¡æ¯
- ä»·æ ¼å­—æ®µæœ‰æ•ˆæ€§

---

## ğŸ’» ä»£ç ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•ï¼ˆå†…éƒ¨è°ƒç”¨ï¼‰

```typescript
// åœ¨ BasicExecutionService ä¸­è‡ªåŠ¨è°ƒç”¨
const currentPrice = await this.getCurrentMarketPrice(symbol);

if (currentPrice === null) {
  logger.warn(`æ— æ³•è·å–${symbol}çš„å½“å‰å¸‚åœºä»·æ ¼`);
  // å¤„ç†ä»·æ ¼è·å–å¤±è´¥çš„æƒ…å†µ
}
```

### æ‰‹åŠ¨è°ƒç”¨æœŸæƒä»·æ ¼ç¼“å­˜

```typescript
import optionPriceCacheService from './services/option-price-cache.service';

// æ£€æŸ¥ç¼“å­˜
const cached = optionPriceCacheService.get('QQQ260131C635000');
if (cached) {
  console.log(`ç¼“å­˜ä»·æ ¼: ${cached.price}`);
  console.log(`Bid: ${cached.bid}, Ask: ${cached.ask}`);
  console.log(`ä¸­é—´ä»·: ${cached.mid}`);
}

// æ‰‹åŠ¨è®¾ç½®ç¼“å­˜
optionPriceCacheService.set('QQQ260131C635000', {
  price: 1.25,
  bid: 1.20,
  ask: 1.30,
  mid: 1.25,
  timestamp: Date.now(),
  underlyingPrice: 450.00,
  source: 'longport',
});

// è·å–ç¼“å­˜ç»Ÿè®¡
const stats = optionPriceCacheService.getStats();
console.log(`æ€»ç¼“å­˜: ${stats.totalEntries}`);
console.log(`æœ‰æ•ˆç¼“å­˜: ${stats.validEntries}`);
console.log(`è¿‡æœŸç¼“å­˜: ${stats.expiredEntries}`);
```

---

## ğŸ”§ é…ç½®é€‰é¡¹

### è°ƒæ•´ç¼“å­˜TTL

```typescript
import optionPriceCacheService from './services/option-price-cache.service';

// è®¾ç½®ä¸º3åˆ†é’Ÿ
optionPriceCacheService.setTTL(3 * 60 * 1000);

// è·å–å½“å‰TTL
const currentTTL = optionPriceCacheService.getTTL();
console.log(`å½“å‰TTL: ${currentTTL}ms`);
```

### æ¸…ç©ºç¼“å­˜

```typescript
// æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
optionPriceCacheService.clear();

// åˆ é™¤ç‰¹å®šåˆçº¦ç¼“å­˜
optionPriceCacheService.delete('QQQ260131C635000');
```

---

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹ä»·æ ¼è·å–æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰ä»·æ ¼ç›¸å…³æ—¥å¿—
grep "getCurrentMarketPrice\|ä½¿ç”¨ç¼“å­˜ä»·æ ¼\|ä½¿ç”¨ä¸­é—´ä»·" logs.txt

# æŸ¥çœ‹ä»·æ ¼è·å–å¤±è´¥çš„æ—¥å¿—
grep "æ— æ³•è·å–.*å¸‚åœºä»·æ ¼" logs.txt
```

### ç¼“å­˜æ€§èƒ½ç›‘æ§

```typescript
// å®šæœŸè¾“å‡ºç¼“å­˜ç»Ÿè®¡
setInterval(() => {
  const stats = optionPriceCacheService.getStats();
  console.log('[ç¼“å­˜ç»Ÿè®¡]', {
    æ€»æ¡ç›®: stats.totalEntries,
    æœ‰æ•ˆ: stats.validEntries,
    è¿‡æœŸ: stats.expiredEntries,
    å‘½ä¸­ç‡: stats.validEntries / Math.max(1, stats.totalEntries)
  });
}, 60000); // æ¯åˆ†é’Ÿ
```

---

## ğŸ§ª æµ‹è¯•

### è¿è¡Œé›†æˆæµ‹è¯•

```bash
cd api
npx ts-node test-option-price-fetch.ts
```

### è¿è¡Œå•å…ƒæµ‹è¯•

```bash
cd api
npm test -- option-price-fetch.test.ts
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æœŸæƒè¯†åˆ«è§„åˆ™

ç³»ç»Ÿé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¯†åˆ«æœŸæƒåˆçº¦ï¼š

```typescript
const isOption = /[A-Z]{1,5}\d{6}[CP]\d+/.test(symbol);
```

ç¬¦åˆä»¥ä¸‹æ ¼å¼çš„ä¼šè¢«è¯†åˆ«ä¸ºæœŸæƒï¼š
- âœ… `QQQ260131C635000` - QQQçœ‹æ¶¨æœŸæƒ
- âœ… `SPY260228P580000` - SPYçœ‹è·ŒæœŸæƒ
- âŒ `QQQ.US` - æ™®é€šè‚¡ç¥¨
- âŒ `AAPL.US` - æ™®é€šè‚¡ç¥¨

### 2. ä»·æ ¼å›é€€é€»è¾‘

- **ä¹°å…¥è®¢å•**: ä¼˜å…ˆä½¿ç”¨ä¸­é—´ä»·æˆ–askä»·
- **å–å‡ºè®¢å•**: ä¼˜å…ˆä½¿ç”¨ä¸­é—´ä»·æˆ–bidä»·
- **ä»·æ ¼éªŒè¯**: ä½¿ç”¨æœ€å¯é çš„ä»·æ ¼æº

### 3. ç¼“å­˜ç­–ç•¥

- **åªç¼“å­˜æœŸæƒ**: è‚¡ç¥¨ä»·æ ¼å®æ—¶æ€§è¦æ±‚é«˜ï¼Œä¸ç¼“å­˜
- **TTL=5åˆ†é’Ÿ**: é€‚åˆæ—¥å†…äº¤æ˜“ï¼Œå¯æ ¹æ®ç­–ç•¥è°ƒæ•´
- **è‡ªåŠ¨æ¸…ç†**: é¿å…å†…å­˜æ³„æ¼

### 4. é”™è¯¯å¤„ç†

```typescript
// ä»·æ ¼è·å–å¤±è´¥æ—¶
if (currentPrice === null || currentPrice <= 0) {
  logger.warn(`æ— æ³•è·å–${symbol}çš„å½“å‰å¸‚åœºä»·æ ¼ï¼Œè·³è¿‡ä»·æ ¼åå·®éªŒè¯`);
  // ç³»ç»Ÿä¼šè·³è¿‡ä»·æ ¼éªŒè¯ï¼Œä½†ä»ç„¶å…è®¸è®¢å•æäº¤
  // å¯æ ¹æ®é£é™©åå¥½è°ƒæ•´è¿™ä¸€è¡Œä¸º
}
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: æœŸæƒä»·æ ¼æ€»æ˜¯è·å–å¤±è´¥

**å¯èƒ½åŸå› **:
- æœŸæƒåˆçº¦å·²è¿‡æœŸ
- æœŸæƒåˆçº¦ä¸å­˜åœ¨
- å¸‚åœºæœªå¼€ç›˜
- APIé™æµ

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥åˆçº¦ä»£ç æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤åˆçº¦åˆ°æœŸæ—¥æœŸ
3. æ£€æŸ¥å¸‚åœºäº¤æ˜“æ—¶é—´
4. æŸ¥çœ‹APIè°ƒç”¨é¢‘ç‡

### é—®é¢˜2: ç¼“å­˜æœªå‘½ä¸­

**å¯èƒ½åŸå› **:
- åˆçº¦ä»£ç æ ¼å¼ä¸åŒ¹é…
- ç¼“å­˜å·²è¿‡æœŸï¼ˆ>5åˆ†é’Ÿï¼‰
- é¦–æ¬¡è°ƒç”¨

**è§£å†³æ–¹æ³•**:
```typescript
// æ£€æŸ¥æ˜¯å¦ä¸ºæœŸæƒ
const isOption = /[A-Z]{1,5}\d{6}[CP]\d+/.test(symbol);
console.log(`${symbol} æ˜¯å¦ä¸ºæœŸæƒ: ${isOption}`);

// æ£€æŸ¥ç¼“å­˜
const cached = optionPriceCacheService.get(symbol);
console.log(`ç¼“å­˜çŠ¶æ€:`, cached ? 'å‘½ä¸­' : 'æœªå‘½ä¸­');
```

### é—®é¢˜3: ä»·æ ¼åç¦»è¿‡å¤§

**å¯èƒ½åŸå› **:
- ä½¿ç”¨äº†bidæˆ–askå•è¾¹ä»·æ ¼
- å¸‚åœºæµåŠ¨æ€§å·®
- ç›˜å‰ç›˜åä»·æ ¼å¼‚å¸¸

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥ä»·æ ¼æ¥æºï¼ˆæŸ¥çœ‹æ—¥å¿—ä¸­çš„priceSourceï¼‰
2. ä¼˜å…ˆä½¿ç”¨ä¸­é—´ä»·
3. è°ƒæ•´ä»·æ ¼åç¦»é˜ˆå€¼

---

## ğŸ“ˆ æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®ç¼“å­˜TTL

```typescript
// æ—¥å†…äº¤æ˜“ç­–ç•¥ï¼š3-5åˆ†é’Ÿ
optionPriceCacheService.setTTL(3 * 60 * 1000);

// æ³¢æ®µç­–ç•¥ï¼š1-2åˆ†é’Ÿ
optionPriceCacheService.setTTL(1 * 60 * 1000);

// é«˜é¢‘ç­–ç•¥ï¼š30ç§’-1åˆ†é’Ÿ
optionPriceCacheService.setTTL(30 * 1000);
```

### 2. ç›‘æ§ç¼“å­˜æ€§èƒ½

```typescript
// å®šæœŸæ£€æŸ¥ç¼“å­˜æ•ˆç‡
const stats = optionPriceCacheService.getStats();
const hitRate = stats.validEntries / Math.max(1, stats.totalEntries);

if (hitRate < 0.5) {
  logger.warn(`ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½: ${(hitRate * 100).toFixed(2)}%`);
  // è€ƒè™‘è°ƒæ•´TTLæˆ–é¢„çƒ­ç­–ç•¥
}
```

### 3. ä»·æ ¼éªŒè¯ç­–ç•¥

```typescript
// ä¸¥æ ¼æ¨¡å¼ï¼šå¿…é¡»æœ‰ä»·æ ¼æ‰æäº¤è®¢å•
if (currentPrice === null) {
  return {
    success: false,
    error: 'æ— æ³•è·å–å¸‚åœºä»·æ ¼ï¼Œæ‹’ç»æäº¤è®¢å•'
  };
}

// å®½æ¾æ¨¡å¼ï¼šæ— ä»·æ ¼æ—¶è·³è¿‡éªŒè¯ï¼ˆé»˜è®¤ï¼‰
if (currentPrice === null) {
  logger.warn('æ— æ³•è·å–å¸‚åœºä»·æ ¼ï¼Œè·³è¿‡ä»·æ ¼éªŒè¯');
  // ç»§ç»­æäº¤è®¢å•
}
```

---

## ğŸ“š ç›¸å…³èµ„æº

- [æœŸæƒä»·æ ¼è·å–ä¿®å¤æ€»ç»“](../fixes/260129-æœŸæƒä»·æ ¼è·å–å¤±è´¥ä¿®å¤æ€»ç»“.md)
- [æœŸæƒä»·æ ¼ç¼“å­˜æœåŠ¡æºç ](../../api/src/services/option-price-cache.service.ts)
- [åŸºç¡€æ‰§è¡ŒæœåŠ¡æºç ](../../api/src/services/basic-execution.service.ts)
- [æµ‹è¯•ç”¨ä¾‹](../../api/src/services/__tests__/option-price-fetch.test.ts)

---

## ğŸ¤ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ—¥å¿—ï¼š`logs-*.json`
2. æŸ¥çœ‹æ–‡æ¡£ï¼šæœ¬æŒ‡å—å’Œä¿®å¤æ€»ç»“
3. è¿è¡Œæµ‹è¯•ï¼šéªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸
4. æäº¤Issueï¼šè®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-29
