# Docker 部署指南

**创建日期**: 2025-12-14
**最后更新**: 2026-02-05
**状态**: 已完成 ✅

---

## 📚 文档索引

### 文档结构

本文档整合了Docker部署的所有相关内容，包括：
- 部署状态和修复总结：已修复的问题和解决方案
- 部署流程：首次部署和更新部署步骤
- 环境配置：环境变量和关键配置说明
- 故障排除：常见问题和解决方案
- 生产环境建议：生产部署的最佳实践

### 快速导航

**想快速开始部署？** → 查看「1. 快速开始」

**想了解修复内容？** → 查看「2. 修复内容总结」

**想了解详细配置？** → 查看「3. 环境配置」

**遇到问题？** → 查看「4. 故障排除」

**生产环境部署？** → 查看「5. 生产环境部署」

---

# 1. 快速开始

## ✅ 部署状态

**完成时间**: 2025-12-12  
**状态**: ✅ 已完全修复并测试通过  
**测试环境**: Synology NAS (Linux)

**支持的平台**:
- ✅ Linux (包括 Synology NAS)
- ✅ macOS
- ✅ Windows (通过 WSL2)

## 🚀 首次部署

### 前置要求

- Docker Desktop（Mac）或 Docker Engine
- Docker Compose

### 部署步骤

```bash
# 1. 克隆项目
git clone <repository-url>
cd trading-system

# 2. 配置环境变量（项目根目录创建 .env 文件）
cat > .env << EOF
# 数据库配置（必需）
POSTGRES_USER=trading_user
POSTGRES_PASSWORD=your_secure_password
POSTGRES_DB=trading_db

# 长桥 API 配置（必需）
LONGPORT_APP_KEY=your_app_key
LONGPORT_APP_SECRET=your_app_secret
LONGPORT_ACCESS_TOKEN=your_access_token
LONGPORT_ENABLE_OVERNIGHT=false
EOF

# 3. 构建镜像（使用 Ubuntu 24.04 基础镜像）
docker-compose build

# 4. 启动服务（单容器部署，前后端在同一容器）
docker-compose up -d

# 5. 等待服务启动（约1-2分钟）
docker-compose ps

# 6. 创建管理员账户
docker-compose exec app node api/scripts/create-admin.js admin your_password

# 7. 查看日志确认
docker-compose logs -f app

# 8. 访问应用
# 访问: http://你的NAS地址:3001
# API: http://你的NAS地址:3001/api/health
```

### 更新部署

```bash
# 1. 拉取最新代码
git pull

# 2. 重新构建（如果代码或配置有变化）
docker-compose build

# 3. 重启服务
docker-compose up -d --force-recreate

# 4. 查看日志
docker-compose logs -f
```

### 开发环境

使用开发环境配置，支持热重载：

```bash
docker-compose -f docker-compose.dev.yml up
```

**开发环境特点**:
- 源代码挂载，修改代码自动重载
- 包含开发依赖和工具
- 适合本地开发和调试

---

# 2. 修复内容总结

## 📋 已修复的问题

### 2026-02-05 最新修复 ⭐

#### 1. 升级到 Ubuntu 24.04 基础镜像 ✅

**问题**: longport SDK 3.0.21 需要 GLIBC 2.39，Alpine 和 Debian 只有较旧版本

**修复**:
- 从 `node:20-alpine` 升级到 `ubuntu:24.04`
- Ubuntu 24.04 提供 GLIBC 2.39+，满足 longport SDK 要求
- 分别为 api-builder 和 runner 阶段使用 Ubuntu 24.04

#### 2. 手动下载 longport 原生绑定 ✅

**问题**: pnpm 不会自动安装平台特定的原生绑定包

**修复**:
- 添加 curl 命令直接下载 `longport-linux-x64-gnu-3.0.21.tgz`
- 解压到正确的 node_modules 路径
- 在 api-builder 和 runner 阶段都执行下载
- 添加验证步骤确保文件存在

#### 3. Next.js 网络绑定修复 ✅

**问题**: Next.js 默认只监听 localhost，Docker 容器外无法访问

**修复**:
- 在 `deploy/start-all.sh` 中添加 `HOSTNAME=0.0.0.0`
- Next.js 现在监听所有网络接口
- 允许从容器外部访问前端服务

#### 4. 中国网络镜像优化 ✅

**问题**: 国内网络访问 Ubuntu 和 npm 官方源速度慢或超时

**修复**:
- 配置 apt 使用阿里云镜像（`mirrors.aliyun.com`）
- 配置 npm 使用淘宝镜像（`registry.npmmirror.com`）
- 配置 pnpm 使用相同的镜像源
- 提升构建速度和成功率

#### 5. 替换 corepack 为直接安装 ✅

**问题**: corepack 可能有网络问题或兼容性问题

**修复**:
- 使用 `npm install -g pnpm@10.28.2` 直接安装 pnpm
- 避免 corepack 的潜在问题
- 确保 pnpm 版本一致

#### 6. 单容器部署架构 ✅

**问题**: 前后端分离部署需要配置多个端口和网络

**修复**:
- 前端和后端在同一容器运行
- 只暴露一个端口（3001）
- 前端通过 `/api` 路径代理访问后端
- 简化部署和网络配置

### 历史修复（2025-12）

#### 7. 包管理器统一 ✅

**问题**: 项目使用 pnpm，但 Dockerfile 使用 npm

**修复**:
- API Dockerfile: 安装 pnpm，使用 `pnpm install --frozen-lockfile`
- Frontend Dockerfile: 支持 pnpm，智能检测 lock 文件
- 生成并提交 `pnpm-lock.yaml` 文件

#### 8. 原生模块编译支持 ✅

**问题**: bcrypt 需要编译原生模块，Alpine 缺少构建工具

**修复**:
- 添加构建工具：python3, make, g++, build-essential
- 构建后清理工具以减小镜像大小

#### 9. 端口冲突修复 ✅

**问题**: PostgreSQL 端口 5432 与系统服务冲突

**修复**:
- 移除外部端口映射
- 容器间通过 Docker 网络通信（使用服务名 `postgres`）

#### 10. NAS 系统兼容性 ✅

**问题**: Synology NAS 不支持 CPU CFS 调度器

**修复**:
- 移除 `deploy.resources` 配置
- 添加注释说明原因

---

# 3. 环境配置

## 📝 环境变量配置

### 项目根目录 `.env` 文件

```bash
# 数据库配置（Docker Compose 使用）
POSTGRES_USER=trading_user
POSTGRES_PASSWORD=your_secure_password
POSTGRES_DB=trading_db

# 长桥 API 配置
LONGPORT_APP_KEY=your_app_key
LONGPORT_APP_SECRET=your_app_secret
LONGPORT_ACCESS_TOKEN=your_access_token
LONGPORT_ENABLE_OVERNIGHT=false
```

**说明**:
- `POSTGRES_USER`: 数据库用户名（默认：trading_user）
- `POSTGRES_PASSWORD`: 数据库密码（请设置强密码）
- `POSTGRES_DB`: 数据库名称（默认：trading_db）
- `LONGPORT_APP_KEY`、`LONGPORT_APP_SECRET`、`LONGPORT_ACCESS_TOKEN`: 长桥 API 凭证

### API 服务 `.env` 文件 (`api/.env`)

```bash
# 数据库连接（使用 Docker 服务名）
DATABASE_URL=postgresql://trading_user:trading_password@postgres:5432/trading_db

# 长桥 API 配置（可选，优先使用数据库配置）
LONGPORT_APP_KEY=your_app_key
LONGPORT_APP_SECRET=your_app_secret
LONGPORT_ACCESS_TOKEN=your_access_token

# 服务器配置
PORT=3001
NODE_ENV=production
```

## 🎯 关键配置要点

### 1. 数据库配置

**数据库凭证**:
- 用户名：`POSTGRES_USER`（默认：trading_user）
- 密码：`POSTGRES_PASSWORD`（默认：trading_password）
- 数据库名：`POSTGRES_DB`（默认：trading_db）

**重要提示**:
- 在 Docker 环境中，API 使用服务名 `postgres` 连接数据库，不是 `localhost`
- 容器间通过 Docker 网络通信
- PostgreSQL 不映射外部端口（避免端口冲突）

### 2. 网络和端口

**单容器部署架构**:
- 只暴露一个端口：3001
- 前端和后端在同一容器运行
- 前端通过 `/api` 路径代理访问后端

**访问方式**:
- 应用访问：`http://你的NAS地址:3001`
- API 访问：`http://你的NAS地址:3001/api/health`

### 3. 管理员账户创建

**首次部署后必须创建管理员账户**:
```bash
# 注意：使用 app 容器名称，不是 api
docker-compose exec app node api/scripts/create-admin.js admin your_password
```

**参数说明**:
- 第一个参数：用户名（如 admin）
- 第二个参数：密码（请设置强密码）

### 4. 数据库初始化

数据库容器启动时会自动执行 `api/migrations/000_init_schema.sql` 初始化脚本。

**注意**:
- 只执行统一的初始化脚本
- 历史迁移脚本已归档
- 数据库会使用 `.env` 文件中的凭证创建

### 5. longport SDK 要求

**系统要求**:
- GLIBC 2.39+ （Ubuntu 24.04 提供）
- longport SDK 3.0.21 的原生绑定会自动下载
- 使用 `longport-linux-x64-gnu` 平台包

---

# 4. 验证和故障排除

## 🔍 验证步骤

### 1. 检查服务状态

```bash
docker-compose ps
```

所有服务应该显示为 `healthy` 状态。

### 2. 检查 API 服务

```bash
# 查看日志
docker-compose logs api

# 测试健康检查
curl http://localhost:3001/api/health
```

### 3. 检查前端服务

```bash
# 查看日志
docker-compose logs frontend

# 访问前端页面
# 浏览器访问: http://你的NAS地址:3000
```

### 4. 检查数据库

```bash
# 测试数据库连接
docker-compose exec postgres psql -U trading_user -d trading_db -c "SELECT 1"
```

## 🔧 故障排除

> **详细故障排查指南**: 请参考 [Docker故障排查和优化指南](251216-Docker故障排查和优化指南.md) 获取完整的故障排查步骤和解决方案。

### 常见问题快速参考

#### API 服务无法连接数据库

**快速解决方案**:
- 检查 `api/.env` 文件中的 `DATABASE_URL` 是否使用服务名 `postgres` 而不是 `localhost`
- 查看日志：`docker-compose logs api`
- 确认 PostgreSQL 容器正在运行：`docker-compose ps postgres`

**详细排查**: 参考 [故障排查指南 - API容器启动失败](251216-Docker故障排查和优化指南.md#4-容器启动问题排查)

#### Frontend 无法连接 API

**快速解决方案**:
- 检查 `NEXT_PUBLIC_API_URL` 是否设置为 NAS 的实际 IP 地址
- **重要**: 修改后必须重新构建前端镜像：`docker-compose build --no-cache frontend`
- 查看浏览器控制台（F12）的网络请求，确认请求的 URL

**详细排查**: 参考 [故障排查指南 - Frontend容器启动失败](251216-Docker故障排查和优化指南.md#frontend-容器启动失败)

#### 镜像拉取超时

**快速解决方案**:
- 检查 Docker 镜像源配置：`cat /etc/docker/daemon.json`
- 尝试手动拉取镜像：`docker pull node:20`
- 配置国内镜像源或使用代理

**详细排查**: 参考 [故障排查指南 - 镜像拉取超时问题](251216-Docker故障排查和优化指南.md#1-镜像拉取超时问题)

#### 构建失败

**常见错误和解决方案**:
- **longport 模块错误**：已修复，使用 Debian 基础镜像
- **bcrypt 编译错误**：已修复，添加了构建工具
- **pnpm lockfile 错误**：已修复，使用 pnpm 并同步 lockfile
- **依赖安装失败**：检查网络连接，可能需要配置镜像源

**详细排查**: 参考 [故障排查指南 - 构建问题排查](251216-Docker故障排查和优化指南.md#3-构建问题排查)

### 查看日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f api
docker-compose logs -f frontend
docker-compose logs -f postgres
```

### 停止和清理

```bash
# 停止服务
docker-compose down

# 清理数据（包括数据库）
docker-compose down -v

# 清理镜像（重新构建）
docker-compose build --no-cache
```

---

# 5. 生产环境部署

## 📋 部署检查清单

- [ ] 配置环境变量（`.env` 文件）
- [ ] 设置 `NEXT_PUBLIC_API_URL` 为实际 IP 或域名
- [ ] 创建管理员账户：`docker-compose exec api node scripts/create-admin.js admin your_password`
- [ ] 配置长桥 API 凭证（通过配置管理页面或环境变量）
- [ ] 验证所有服务健康状态：`docker-compose ps`
- [ ] 测试 API 健康检查：`curl http://localhost:3001/api/health`
- [ ] 测试前端访问：浏览器访问前端页面
- [ ] 测试前端连接 API：检查浏览器控制台网络请求

## 🎯 生产环境建议

### 1. 安全配置

- **强密码**: 使用强密码（数据库、管理员账户）
- **加密密钥**: 配置 `CONFIG_ENCRYPTION_KEY` 环境变量（32字符以上）
- **密钥管理**: 使用环境变量文件或密钥管理服务
- **HTTPS**: 配置 HTTPS 和反向代理（如 Nginx）

### 2. 网络配置

- **反向代理**: 配置 HTTPS 和反向代理（如 Nginx）
- **域名**: 使用域名而不是 IP 地址
- **防火墙**: 配置防火墙规则，只开放必要端口
- **内网访问**: 考虑使用内网域名或固定 IP

### 3. 数据管理

- **数据库备份**: 设置数据库备份策略
- **数据卷备份**: 定期备份 `postgres_data` 卷
- **磁盘监控**: 监控磁盘空间使用
- **数据迁移**: 保留迁移脚本和备份

### 4. 监控和日志

- **日志收集**: 配置日志收集和监控
- **健康检查**: 设置健康检查告警
- **定期检查**: 定期查看服务日志
- **性能监控**: 监控服务性能和资源使用

### 5. 版本管理

- **镜像标签**: 使用 Docker 镜像标签版本管理
- **版本回滚**: 保留历史版本以便回滚
- **Git 标签**: 使用 Git 标签标记发布版本
- **变更记录**: 记录每次部署的变更内容

---

# 6. 本地开发环境（不使用 Docker）

## Mac 环境

### 1. 安装依赖

```bash
cd api
npm install

cd ../frontend
npm install
```

现在 `bcryptjs` 不需要编译，安装应该会成功。

### 2. 配置数据库

确保 PostgreSQL 正在运行，并创建数据库：

```bash
createdb trading_db
```

运行迁移脚本：

```bash
psql trading_db < api/migrations/000_init_schema.sql
```

**注意**: 现在使用统一初始化脚本 `000_init_schema.sql`，历史迁移脚本已归档。

### 3. 配置环境变量

在 `api` 目录创建 `.env` 文件：

```bash
DATABASE_URL=postgresql://user:password@localhost:5432/trading_db
PORT=3001
NODE_ENV=development
LONGPORT_APP_KEY=your_app_key
LONGPORT_APP_SECRET=your_app_secret
LONGPORT_ACCESS_TOKEN=your_access_token
```

在 `frontend` 目录创建 `.env.local` 文件：

```bash
NEXT_PUBLIC_API_URL=http://localhost:3001
```

### 4. 启动服务

```bash
# 启动 API（终端 1）
cd api
npm run dev

# 启动 Frontend（终端 2）
cd frontend
npm run dev
```

---

# 7. 相关文件和文档

## 📁 Docker 配置文件

- `docker-compose.yml` - 生产环境配置
- `docker-compose.dev.yml` - 开发环境配置
- `api/Dockerfile` - API 服务 Dockerfile
- `api/Dockerfile.dev` - API 开发环境 Dockerfile
- `frontend/Dockerfile` - Frontend 服务 Dockerfile
- `frontend/Dockerfile.dev` - Frontend 开发环境 Dockerfile

## 📁 依赖文件

- `api/pnpm-lock.yaml` - API 依赖锁定文件
- `api/pnpm-workspace.yaml` - pnpm 工作区配置
- `frontend/pnpm-lock.yaml` - Frontend 依赖锁定文件
- `frontend/public/.gitkeep` - public 目录占位文件

## 📚 相关文档

- [Docker故障排查和优化指南](251216-Docker故障排查和优化指南.md) - 详细的故障排查和优化说明 ⭐ 推荐
- [环境变量配置指南](251216-环境变量配置指南.md) - 环境变量详细说明
- [配置管理功能设置指南](250127-配置管理功能设置指南.md) - 系统配置管理
- [NAS-Docker部署指南](251212-NAS-Docker部署指南.md) - NAS 部署详细指南

---

# 8. 测试清单

## ✅ 部署验证

- [x] Docker 构建成功
- [x] 所有服务正常启动
- [x] 健康检查通过
- [x] 数据库连接正常
- [x] API 服务正常响应
- [x] 前端可以访问
- [x] 前端可以连接 API
- [x] 管理员账户创建成功
- [x] 配置管理页面可以访问
- [x] 长桥 API 配置可以更新

---

## 🎉 部署成功

Docker 部署已完全修复并测试通过，可以在生产环境中使用。

**下一步**:
1. 创建管理员账户
2. 配置长桥 API 凭证
3. 开始使用系统

---

**文档版本**：v1.0  
**最后更新**：2025-12-16  
**状态**：已完成 ✅

