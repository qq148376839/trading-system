# Docker æ•…éšœæ’æŸ¥å’Œä¼˜åŒ–æŒ‡å—

**åˆ›å»ºæ—¥æœŸ**: 2025-12-16  
**æœ€åæ›´æ–°**: 2025-12-16  
**çŠ¶æ€**: å·²å®Œæˆ âœ…

---

## ğŸ“š æ–‡æ¡£ç´¢å¼•

### æ–‡æ¡£ç»“æ„

æœ¬æ–‡æ¡£æ•´åˆäº†Dockeréƒ¨ç½²çš„æ‰€æœ‰æ•…éšœæ’æŸ¥å’Œä¼˜åŒ–å†…å®¹ï¼ŒåŒ…æ‹¬ï¼š
- é•œåƒæ‹‰å–è¶…æ—¶é—®é¢˜è§£å†³æ–¹æ¡ˆ
- Dockeré…ç½®ä¼˜åŒ–è¯´æ˜
- è¯¦ç»†æ•…éšœæ’æŸ¥æ­¥éª¤
- æ„å»ºé—®é¢˜ä¿®å¤è¯´æ˜

### å¿«é€Ÿå¯¼èˆª

**é‡åˆ°é•œåƒæ‹‰å–è¶…æ—¶ï¼Ÿ** â†’ æŸ¥çœ‹ã€Œ1. é•œåƒæ‹‰å–è¶…æ—¶é—®é¢˜ã€

**æƒ³äº†è§£é…ç½®ä¼˜åŒ–ï¼Ÿ** â†’ æŸ¥çœ‹ã€Œ2. Dockeré…ç½®ä¼˜åŒ–ã€

**é‡åˆ°æ„å»ºå¤±è´¥ï¼Ÿ** â†’ æŸ¥çœ‹ã€Œ3. æ„å»ºé—®é¢˜æ’æŸ¥ã€

**é‡åˆ°å®¹å™¨å¯åŠ¨å¤±è´¥ï¼Ÿ** â†’ æŸ¥çœ‹ã€Œ4. å®¹å™¨å¯åŠ¨é—®é¢˜æ’æŸ¥ã€

**é‡åˆ°ç½‘ç»œé—®é¢˜ï¼Ÿ** â†’ æŸ¥çœ‹ã€Œ5. ç½‘ç»œé—®é¢˜æ’æŸ¥ã€

---

# 1. é•œåƒæ‹‰å–è¶…æ—¶é—®é¢˜

## é—®é¢˜æè¿°

Docker æ„å»ºæ—¶å‡ºç° TLS handshake timeout é”™è¯¯ï¼Œæ— æ³•ä»é•œåƒæºæ‹‰å– `node:20` é•œåƒã€‚

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ£€æŸ¥å¹¶ä¿®å¤ Docker é•œåƒæºé…ç½®ï¼ˆæ¨èï¼‰

åœ¨ NAS ä¸Šæ£€æŸ¥ Docker çš„é•œåƒæºé…ç½®ï¼š

```bash
# æ£€æŸ¥ Docker daemon é…ç½®
cat /etc/docker/daemon.json
```

å¦‚æœé…ç½®äº†è‡ªå®šä¹‰é•œåƒæºï¼ˆå¦‚ `dockerhub.riowang.win`ï¼‰ï¼Œå¯ä»¥ï¼š

**é€‰é¡¹ Aï¼šä½¿ç”¨å®˜æ–¹ Docker Hub**
```json
{
  "registry-mirrors": []
}
```

**é€‰é¡¹ Bï¼šä½¿ç”¨å›½å†…é•œåƒæºï¼ˆå¦‚æœåœ¨ä¸­å›½ï¼‰**
```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
```

ä¿®æ”¹åé‡å¯ Dockerï¼š
```bash
sudo systemctl restart docker
# æˆ–è€…åœ¨ Synology NAS ä¸Šé€šè¿‡ DSM ç•Œé¢é‡å¯ Docker
```

### æ–¹æ¡ˆ 2: ä½¿ç”¨ä»£ç†ï¼ˆå¦‚æœ NAS æœ‰ä»£ç†ï¼‰

å¦‚æœ NAS é…ç½®äº†ä»£ç†ï¼Œç¡®ä¿ Docker å¯ä»¥ä½¿ç”¨ä»£ç†ï¼š

```bash
# åˆ›å»ºæˆ–ç¼–è¾‘ Docker æœåŠ¡é…ç½®
sudo mkdir -p /etc/systemd/system/docker.service.d
sudo nano /etc/systemd/system/docker.service.d/http-proxy.conf
```

æ·»åŠ ï¼š
```ini
[Service]
Environment="HTTP_PROXY=http://proxy.example.com:8080"
Environment="HTTPS_PROXY=http://proxy.example.com:8080"
Environment="NO_PROXY=localhost,127.0.0.1"
```

ç„¶åï¼š
```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### æ–¹æ¡ˆ 3: æ‰‹åŠ¨æ‹‰å–é•œåƒ

å¦‚æœé•œåƒæºä¸ç¨³å®šï¼Œå¯ä»¥æ‰‹åŠ¨æ‹‰å–é•œåƒï¼š

```bash
# å°è¯•ç›´æ¥æ‹‰å–
docker pull node:20

# å¦‚æœå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å®˜æ–¹æº
docker pull docker.io/library/node:20

# æˆ–è€…ä½¿ç”¨å…¶ä»–é•œåƒæº
docker pull registry.cn-hangzhou.aliyuncs.com/acs/node:20
```

### æ–¹æ¡ˆ 4: ä½¿ç”¨å›½å†…é•œåƒï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æœä¸Šè¿°æ–¹æ¡ˆéƒ½ä¸è¡Œï¼Œå¯ä»¥ä¿®æ”¹ Dockerfile ä½¿ç”¨å›½å†…é•œåƒï¼š

```dockerfile
FROM registry.cn-hangzhou.aliyuncs.com/acs/node:20
```

**æ³¨æ„**: è¿™æ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨æ–¹æ¡ˆ1æˆ–æ–¹æ¡ˆ2ã€‚

### æ–¹æ¡ˆ 5: å¢åŠ è¶…æ—¶æ—¶é—´å’Œé‡è¯•

åœ¨ docker-compose.yml ä¸­æ·»åŠ æ„å»ºå‚æ•°ï¼š

```yaml
services:
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
```

æˆ–è€…ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼š
```bash
export DOCKER_BUILDKIT=1
export BUILDKIT_STEP_LOG_MAX_SIZE=10485760
docker-compose build --no-cache api
```

## æ¨èæ“ä½œæ­¥éª¤

1. **é¦–å…ˆæ£€æŸ¥ Docker é•œåƒæºé…ç½®**
   ```bash
   cat /etc/docker/daemon.json
   ```

2. **å¦‚æœé…ç½®äº†ä¸ç¨³å®šçš„é•œåƒæºï¼Œä¸´æ—¶ç§»é™¤æˆ–æ›´æ¢**
   ```bash
   sudo nano /etc/docker/daemon.json
   # ä¿®æ”¹æˆ–æ¸…ç©º registry-mirrors
   ```

3. **é‡å¯ Docker æœåŠ¡**
   ```bash
   sudo systemctl restart docker
   # æˆ–åœ¨ Synology DSM ä¸­é‡å¯ Docker å¥—ä»¶
   ```

4. **é‡æ–°å°è¯•æ„å»º**
   ```bash
   docker-compose build --no-cache api
   ```

5. **å¦‚æœä»ç„¶è¶…æ—¶ï¼Œå°è¯•æ‰‹åŠ¨æ‹‰å–é•œåƒ**
   ```bash
   docker pull node:20
   docker-compose build --no-cache api
   ```

## Synology NAS ç‰¹å®šè¯´æ˜

åœ¨ Synology NAS ä¸Šï¼š

1. **é€šè¿‡ DSM ç•Œé¢é…ç½®**ï¼š
   - æ‰“å¼€ Docker å¥—ä»¶
   - è¿›å…¥"æ³¨å†Œè¡¨" â†’ "è®¾ç½®"
   - æ£€æŸ¥æˆ–ä¿®æ”¹é•œåƒæºè®¾ç½®

2. **é€šè¿‡ SSH é…ç½®**ï¼š
   ```bash
   sudo vi /var/packages/Docker/etc/dockerd.json
   # ä¿®æ”¹ registry-mirrors é…ç½®
   # ç„¶åé‡å¯ Docker å¥—ä»¶
   ```

3. **æ£€æŸ¥ç½‘ç»œè¿æ¥**ï¼š
   - ç¡®ä¿ NAS å¯ä»¥è®¿é—®äº’è”ç½‘
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   - æ£€æŸ¥ DNS è®¾ç½®

## éªŒè¯

æ„å»ºæˆåŠŸåï¼ŒéªŒè¯é•œåƒï¼š
```bash
docker images | grep node
docker-compose up -d api
docker-compose logs api
```

---

# 2. Dockeré…ç½®ä¼˜åŒ–

## ğŸ“‹ ä¼˜åŒ–å†…å®¹

### 1. Dockerfile ä¼˜åŒ–

#### API Dockerfile (`api/Dockerfile`)

**å·²å®ç°çš„ä¼˜åŒ–**:
- âœ… æ·»åŠ  `curl` ç”¨äºå¥åº·æ£€æŸ¥
- âœ… æ·»åŠ å¥åº·æ£€æŸ¥æŒ‡ä»¤ (`HEALTHCHECK`)
- âœ… åˆ›å»ºé root ç”¨æˆ·è¿è¡ŒæœåŠ¡ï¼ˆå®‰å…¨ï¼‰
- âœ… è®¾ç½®æ–‡ä»¶æƒé™
- âœ… ä½¿ç”¨ pnpm åŒ…ç®¡ç†å™¨
- âœ… æ”¯æŒ bcrypt åŸç”Ÿæ¨¡å—ç¼–è¯‘
- âœ… ä½¿ç”¨ Debian åŸºç¡€é•œåƒï¼ˆæ”¯æŒ longportï¼‰

**å¥åº·æ£€æŸ¥é…ç½®**:
```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:3001/api/health || exit 1
```

#### Frontend Dockerfile (`frontend/Dockerfile`)

**å·²å®ç°çš„ä¼˜åŒ–**:
- âœ… æ·»åŠ  `curl` ç”¨äºå¥åº·æ£€æŸ¥
- âœ… æ·»åŠ å¥åº·æ£€æŸ¥æŒ‡ä»¤ (`HEALTHCHECK`)
- âœ… ä¼˜åŒ–å¤šé˜¶æ®µæ„å»º
- âœ… æ™ºèƒ½æ£€æµ‹ lock æ–‡ä»¶ï¼ˆpnpm-lock.yaml æˆ– package-lock.jsonï¼‰
- âœ… åˆ›å»ºé root ç”¨æˆ·è¿è¡ŒæœåŠ¡

**å¥åº·æ£€æŸ¥é…ç½®**:
```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:3000/ || exit 1
```

### 2. Docker Compose ä¼˜åŒ–

#### ç”Ÿäº§ç¯å¢ƒ (`docker-compose.yml`)

**å·²å®ç°çš„ä¼˜åŒ–**:
- âœ… API æœåŠ¡æ·»åŠ å¥åº·æ£€æŸ¥
- âœ… Frontend æœåŠ¡æ·»åŠ å¥åº·æ£€æŸ¥
- âœ… PostgreSQL å¥åº·æ£€æŸ¥
- âœ… ä¼˜åŒ–è¿ç§»è„šæœ¬æŒ‚è½½ï¼ˆåªæŒ‚è½½åˆå§‹åŒ–è„šæœ¬ï¼‰
- âœ… Frontend ä¾èµ– API å¥åº·çŠ¶æ€

**å¥åº·æ£€æŸ¥é…ç½®ç¤ºä¾‹**:
```yaml
services:
  postgres:
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trading_user -d trading_db"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  api:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  
  frontend:
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
```

#### å¼€å‘ç¯å¢ƒ (`docker-compose.dev.yml`)

**å·²å®ç°çš„ä¼˜åŒ–**:
- âœ… API æœåŠ¡æ·»åŠ å¥åº·æ£€æŸ¥
- âœ… Frontend æœåŠ¡æ·»åŠ å¥åº·æ£€æŸ¥
- âœ… Frontend ä¾èµ– API å¥åº·çŠ¶æ€
- âœ… æ”¯æŒæºä»£ç çƒ­é‡è½½

### 3. è¿ç§»è„šæœ¬ä¼˜åŒ–

**é—®é¢˜**ï¼šä¹‹å‰æŒ‚è½½æ•´ä¸ª `migrations` ç›®å½•ä¼šå¯¼è‡´æ‰§è¡Œæ‰€æœ‰ SQL æ–‡ä»¶ï¼ŒåŒ…æ‹¬å†å²è¿ç§»è„šæœ¬ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåªæŒ‚è½½ `000_init_schema.sql` åˆå§‹åŒ–è„šæœ¬ã€‚

```yaml
volumes:
  - ./api/migrations/000_init_schema.sql:/docker-entrypoint-initdb.d/000_init_schema.sql:ro
```

### 4. æœåŠ¡ä¾èµ–å…³ç³»

```
PostgreSQL (å¥åº·æ£€æŸ¥)
    â†“
API (å¥åº·æ£€æŸ¥)
    â†“
Frontend (å¥åº·æ£€æŸ¥)
```

**è¯´æ˜**:
- Frontend ç­‰å¾… API å¥åº·åæ‰å¯åŠ¨
- API ç­‰å¾… PostgreSQL å¥åº·åæ‰å¯åŠ¨
- ç¡®ä¿æœåŠ¡æŒ‰æ­£ç¡®é¡ºåºå¯åŠ¨

### 5. èµ„æºé™åˆ¶ï¼ˆå¯é€‰ï¼‰

**æ³¨æ„**: Synology NAS ä¸æ”¯æŒ CPU CFS è°ƒåº¦å™¨ï¼Œå› æ­¤ç”Ÿäº§ç¯å¢ƒé…ç½®ä¸­å·²ç§»é™¤èµ„æºé™åˆ¶ã€‚

å¦‚æœéœ€è¦åœ¨å…¶ä»–å¹³å°ä½¿ç”¨èµ„æºé™åˆ¶ï¼š

```yaml
deploy:
  resources:
    limits:
      cpus: '1.0'
      memory: 512M
    reservations:
      cpus: '0.5'
      memory: 256M
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡æ–‡ä»¶**ï¼šç¡®ä¿ `api/.env` æ–‡ä»¶å­˜åœ¨å¹¶é…ç½®æ­£ç¡®
2. **è¿ç§»è„šæœ¬**ï¼šåªæŒ‚è½½ `000_init_schema.sql`ï¼Œé¿å…æ‰§è¡Œå†å²è¿ç§»è„šæœ¬
3. **å¥åº·æ£€æŸ¥**ï¼šæœåŠ¡å¯åŠ¨éœ€è¦ä¸€å®šæ—¶é—´ï¼Œå¥åº·æ£€æŸ¥æœ‰ `start_period` å»¶è¿Ÿ
4. **é root ç”¨æˆ·**ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨é root ç”¨æˆ·è¿è¡Œï¼Œæé«˜å®‰å…¨æ€§
5. **èµ„æºé™åˆ¶**ï¼šæ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ CPU å’Œå†…å­˜é™åˆ¶ï¼ˆæ³¨æ„å¹³å°å…¼å®¹æ€§ï¼‰

---

# 3. æ„å»ºé—®é¢˜æ’æŸ¥

## å¸¸è§æ„å»ºé—®é¢˜

### é—®é¢˜ 1: pnpm lockfile é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
npm error The `npm ci` command can only install with an existing package-lock.json
```

**åŸå› **:
- é¡¹ç›®ä½¿ç”¨ pnpm ç®¡ç†ä¾èµ–ï¼Œä½† Dockerfile ä½¿ç”¨äº† `npm ci`
- `npm ci` éœ€è¦ `package-lock.json`ï¼Œä½†é¡¹ç›®åªæœ‰ `pnpm-lock.yaml`

**è§£å†³æ–¹æ¡ˆ**:
- âœ… å·²ä¿®å¤ï¼šAPI Dockerfile ä½¿ç”¨ `pnpm install --frozen-lockfile`
- âœ… å·²ä¿®å¤ï¼šFrontend Dockerfile æ™ºèƒ½æ£€æµ‹ lock æ–‡ä»¶

**éªŒè¯**:
```bash
# æ£€æŸ¥ lock æ–‡ä»¶
ls -la api/pnpm-lock.yaml
ls -la frontend/pnpm-lock.yaml

# é‡æ–°æ„å»º
docker-compose build --no-cache
```

### é—®é¢˜ 2: longport åŸç”Ÿæ¨¡å—é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
Error: Cannot find module 'longport-linux-x64-musl'
```

**åŸå› **:
- longport åŒ…éœ€è¦ glibcï¼ŒAlpine ä½¿ç”¨ musl ä¸å…¼å®¹

**è§£å†³æ–¹æ¡ˆ**:
- âœ… å·²ä¿®å¤ï¼šä» `node:20-alpine` åˆ‡æ¢åˆ° `node:20` (Debian/glibc)

### é—®é¢˜ 3: bcrypt ç¼–è¯‘é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
gyp ERR! build error
```

**åŸå› **:
- bcrypt éœ€è¦ç¼–è¯‘åŸç”Ÿæ¨¡å—ï¼ŒAlpine ç¼ºå°‘æ„å»ºå·¥å…·

**è§£å†³æ–¹æ¡ˆ**:
- âœ… å·²ä¿®å¤ï¼šæ·»åŠ æ„å»ºå·¥å…·ï¼ˆpython3, make, g++, build-essentialï¼‰
- âœ… å·²ä¿®å¤ï¼šæ„å»ºåæ¸…ç†å·¥å…·ä»¥å‡å°é•œåƒå¤§å°

### é—®é¢˜ 4: ä¾èµ–å®‰è£…å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
npm ERR! network timeout
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. é…ç½®é•œåƒæºï¼ˆå‚è€ƒã€Œ1. é•œåƒæ‹‰å–è¶…æ—¶é—®é¢˜ã€ï¼‰
3. ä½¿ç”¨ä»£ç†ï¼ˆå¦‚æœæœ‰ï¼‰

### é—®é¢˜ 5: Frontend æ„å»ºå¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
Error: NEXT_PUBLIC_API_URL is not defined
```

**åŸå› **:
- `NEXT_PUBLIC_API_URL` éœ€è¦åœ¨æ„å»ºæ—¶æ³¨å…¥

**è§£å†³æ–¹æ¡ˆ**:
- âœ… å·²ä¿®å¤ï¼šDockerfile æ·»åŠ  ARG æ¥æ”¶æ„å»ºå‚æ•°
- âœ… å·²ä¿®å¤ï¼šdocker-compose.yml ä½¿ç”¨ build.args ä¼ é€’å‚æ•°

**éªŒè¯**:
```bash
# æ£€æŸ¥æ„å»ºå‚æ•°
docker-compose build --build-arg NEXT_PUBLIC_API_URL=http://192.168.31.18:3001 frontend
```

## æœ€ä½³å®è·µå»ºè®®

1. **ç»Ÿä¸€ä½¿ç”¨ pnpm**ï¼šæ•´ä¸ªé¡¹ç›®åº”è¯¥ç»Ÿä¸€ä½¿ç”¨ pnpm ç®¡ç†ä¾èµ–
2. **æäº¤ lock æ–‡ä»¶**ï¼šç¡®ä¿ `pnpm-lock.yaml` æäº¤åˆ° Gitï¼Œä¿è¯æ„å»ºä¸€è‡´æ€§
3. **ä¸è¦æ··ç”¨ npm å’Œ pnpm**ï¼šé¿å…åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­æ··ç”¨ä¸¤ç§åŒ…ç®¡ç†å™¨
4. **ä½¿ç”¨æ„å»ºç¼“å­˜**ï¼šåˆ©ç”¨ Docker æ„å»ºç¼“å­˜åŠ é€Ÿæ„å»ºè¿‡ç¨‹

---

# 4. å®¹å™¨å¯åŠ¨é—®é¢˜æ’æŸ¥

## API å®¹å™¨å¯åŠ¨å¤±è´¥ï¼ˆunhealthyï¼‰

### 1. æŸ¥çœ‹ API å®¹å™¨æ—¥å¿—

```bash
docker-compose logs api
```

æˆ–è€…æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—ï¼š
```bash
docker-compose logs --tail=100 api
```

### 2. å¸¸è§é—®é¢˜

#### é—®é¢˜ 1: æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼šæ—¥å¿—ä¸­æ˜¾ç¤º "æ•°æ®åº“è¿æ¥å¤±è´¥" æˆ– "Database connection error"

**åŸå› **:
- `DATABASE_URL` é…ç½®ä¸æ­£ç¡®
- `api/.env` æ–‡ä»¶ä¸­çš„ `DATABASE_URL` è¦†ç›–äº† docker-compose.yml ä¸­çš„é…ç½®
- æ•°æ®åº“æœåŠ¡è¿˜æœªå®Œå…¨å¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**:

1. **æ£€æŸ¥ `api/.env` æ–‡ä»¶**ï¼š
   ```bash
   cat api/.env | grep DATABASE_URL
   ```
   
   å¦‚æœå­˜åœ¨ `DATABASE_URL`ï¼Œç¡®ä¿å®ƒä½¿ç”¨ Docker æœåŠ¡å `postgres`ï¼š
   ```bash
   DATABASE_URL=postgresql://trading_user:trading_password@postgres:5432/trading_db
   ```
   
   **æ³¨æ„**ï¼šä¸è¦ä½¿ç”¨ `localhost`ï¼Œåº”è¯¥ä½¿ç”¨æœåŠ¡å `postgres`

2. **å¦‚æœ `api/.env` æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ²¡æœ‰ DATABASE_URL**ï¼š
   docker-compose.yml ä¸­çš„ç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„ DATABASE_URL

3. **ä¸´æ—¶åˆ é™¤ `api/.env` æ–‡ä»¶**ï¼ˆå¦‚æœå®ƒåŒ…å«é”™è¯¯çš„é…ç½®ï¼‰ï¼š
   ```bash
   mv api/.env api/.env.backup
   docker-compose up -d --force-recreate api
   ```

#### é—®é¢˜ 2: ç¯å¢ƒå˜é‡ç¼ºå¤±

**ç—‡çŠ¶**ï¼šæ—¥å¿—ä¸­æ˜¾ç¤º "LongPort credentials not configured"

**è§£å†³æ–¹æ¡ˆ**ï¼š
ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶æˆ– `api/.env` æ–‡ä»¶ä¸­è®¾ç½®äº†ï¼š
```bash
LONGPORT_APP_KEY=your_app_key
LONGPORT_APP_SECRET=your_app_secret
LONGPORT_ACCESS_TOKEN=your_access_token
```

#### é—®é¢˜ 3: æ•°æ®åº“æœªåˆå§‹åŒ–

**ç—‡çŠ¶**ï¼šæ•°æ®åº“è¿æ¥æˆåŠŸä½†è¡¨ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²åˆå§‹åŒ–ï¼š
```bash
docker-compose exec postgres psql -U trading_user -d trading_db -c "\dt"
```

å¦‚æœæ²¡æœ‰è¡¨ï¼Œæ£€æŸ¥åˆå§‹åŒ–è„šæœ¬ï¼š
```bash
docker-compose exec postgres psql -U trading_user -d trading_db -f /docker-entrypoint-initdb.d/000_init_schema.sql
```

### 3. æ‰‹åŠ¨æµ‹è¯•æ•°æ®åº“è¿æ¥

```bash
# è¿›å…¥ API å®¹å™¨
docker-compose exec api sh

# åœ¨å®¹å™¨å†…æµ‹è¯•æ•°æ®åº“è¿æ¥
node -e "const { Pool } = require('pg'); const pool = new Pool({ connectionString: process.env.DATABASE_URL }); pool.query('SELECT 1').then(() => console.log('OK')).catch(e => console.error(e)).finally(() => process.exit());"
```

### 4. æ£€æŸ¥å¥åº·æ£€æŸ¥ç«¯ç‚¹

```bash
# ä»å®¿ä¸»æœºæµ‹è¯•
curl http://localhost:3001/api/health

# ä»å®¹å™¨å†…æµ‹è¯•
docker-compose exec api curl http://localhost:3001/api/health
```

### 5. é‡æ–°å¯åŠ¨æœåŠ¡

```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# æ¸…ç†å·ï¼ˆæ³¨æ„ï¼šè¿™ä¼šåˆ é™¤æ•°æ®åº“æ•°æ®ï¼‰
# docker-compose down -v

# é‡æ–°å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f api
```

## Frontend å®¹å™¨å¯åŠ¨å¤±è´¥

### æŸ¥çœ‹æ—¥å¿—

```bash
docker-compose logs frontend
```

### å¸¸è§é—®é¢˜

#### é—®é¢˜ï¼šæ— æ³•è¿æ¥åˆ° API

**è§£å†³æ–¹æ¡ˆ**ï¼š
ç¡®ä¿ `NEXT_PUBLIC_API_URL` é…ç½®æ­£ç¡®ã€‚å¦‚æœå‰ç«¯éœ€è¦ä»æµè§ˆå™¨è®¿é—® APIï¼Œåº”è¯¥ä½¿ç”¨å®¿ä¸»æœºçš„åœ°å€æˆ–åŸŸåï¼Œè€Œä¸æ˜¯å®¹å™¨å†…éƒ¨åœ°å€ã€‚

**é‡è¦**: ä¿®æ”¹åå¿…é¡»é‡æ–°æ„å»ºå‰ç«¯é•œåƒï¼š
```bash
docker-compose build --no-cache frontend
docker-compose up -d frontend
```

## æ•°æ®åº“å®¹å™¨é—®é¢˜

### æŸ¥çœ‹æ—¥å¿—

```bash
docker-compose logs postgres
```

### æ£€æŸ¥æ•°æ®åº“çŠ¶æ€

```bash
docker-compose exec postgres pg_isready -U trading_user -d trading_db
```

### æ£€æŸ¥æ•°æ®åº“åˆå§‹åŒ–

```bash
# æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
docker-compose exec postgres psql -U trading_user -d trading_db -c "\dt"

# æ‰‹åŠ¨æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
docker-compose exec postgres psql -U trading_user -d trading_db -f /docker-entrypoint-initdb.d/000_init_schema.sql
```

---

# 5. ç½‘ç»œé—®é¢˜æ’æŸ¥

## æ£€æŸ¥å®¹å™¨ç½‘ç»œ

```bash
docker network inspect trading-system_trading-network
```

## æµ‹è¯•å®¹å™¨é—´é€šä¿¡

```bash
# ä» API å®¹å™¨ ping æ•°æ®åº“å®¹å™¨
docker-compose exec api ping postgres

# ä» API å®¹å™¨æµ‹è¯•æ•°æ®åº“ç«¯å£
docker-compose exec api nc -zv postgres 5432

# ä» Frontend å®¹å™¨æµ‹è¯• API ç«¯å£
docker-compose exec frontend nc -zv api 3001
```

## ç«¯å£å†²çªé—®é¢˜

### æ£€æŸ¥ç«¯å£å ç”¨

```bash
# Linux/Mac
netstat -tulpn | grep 3000
netstat -tulpn | grep 3001
netstat -tulpn | grep 5432

# Windows
netstat -ano | findstr :3000
netstat -ano | findstr :3001
netstat -ano | findstr :5432
```

### è§£å†³æ–¹æ¡ˆ

**PostgreSQL ç«¯å£å†²çª**ï¼š
- âœ… å·²ä¿®å¤ï¼šä¸å†æ˜ å°„å¤–éƒ¨ç«¯å£ï¼Œå®¹å™¨é—´é€šè¿‡ Docker ç½‘ç»œé€šä¿¡

**API/Frontend ç«¯å£å†²çª**ï¼š
- å¯ä»¥åœ¨ `docker-compose.yml` ä¸­ä¿®æ”¹ç«¯å£æ˜ å°„
  ```yaml
  ports:
    - "3002:3001"  # ä¿®æ”¹å¤–éƒ¨ç«¯å£
  ```

---

# 6. å®Œæ•´é‡å¯æµç¨‹

å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œå°è¯•å®Œæ•´é‡å¯ï¼š

```bash
# 1. åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# 2. æ¸…ç†æœªä½¿ç”¨çš„èµ„æºï¼ˆå¯é€‰ï¼‰
docker system prune -f

# 3. é‡æ–°æ„å»ºé•œåƒï¼ˆå¦‚æœéœ€è¦ï¼‰
docker-compose build --no-cache

# 4. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 5. æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# 6. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps
```

---

# 7. éªŒè¯æ¸…å•

## æ„å»ºéªŒè¯

- [ ] Docker æ„å»ºæˆåŠŸ
- [ ] é•œåƒå¤§å°åˆç†
- [ ] å¥åº·æ£€æŸ¥é…ç½®æ­£ç¡®

## å¯åŠ¨éªŒè¯

- [ ] æ‰€æœ‰æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] API æœåŠ¡æ­£å¸¸å“åº”
- [ ] å‰ç«¯å¯ä»¥è®¿é—®
- [ ] å‰ç«¯å¯ä»¥è¿æ¥ API

## åŠŸèƒ½éªŒè¯

- [ ] ç®¡ç†å‘˜è´¦æˆ·åˆ›å»ºæˆåŠŸ
- [ ] é…ç½®ç®¡ç†é¡µé¢å¯ä»¥è®¿é—®
- [ ] é•¿æ¡¥ API é…ç½®å¯ä»¥æ›´æ–°
- [ ] äº¤æ˜“åŠŸèƒ½æ­£å¸¸

---

# 8. ç›¸å…³æ–‡æ¡£

- [Dockeréƒ¨ç½²æŒ‡å—](251214-Dockeréƒ¨ç½²æŒ‡å—.md) - å®Œæ•´çš„éƒ¨ç½²æŒ‡å—
- [ç¯å¢ƒå˜é‡é…ç½®æŒ‡å—](251216-ç¯å¢ƒå˜é‡é…ç½®æŒ‡å—.md) - ç¯å¢ƒå˜é‡è¯¦ç»†è¯´æ˜
- [NAS-Dockeréƒ¨ç½²æŒ‡å—](251212-NAS-Dockeréƒ¨ç½²æŒ‡å—.md) - NAS éƒ¨ç½²è¯¦ç»†æŒ‡å—

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-12-16  
**çŠ¶æ€**ï¼šå·²å®Œæˆ âœ…




