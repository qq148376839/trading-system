# 前端期权功能测试指南

**日期**: 2026-01-28
**测试范围**: http://localhost:3000/options/chain 期权链页面
**测试目标**: 验证期权策略修复后的前端集成

---

## 📋 测试前准备

### 1. 启动服务

```powershell
# 终端1：启动API服务
cd D:\Python\trading-system\api
npm run build
npm start
# 或
pm2 restart trading-api

# 终端2：启动前端服务
cd D:\Python\trading-system\frontend
npm run dev

# 终端3：监控日志
cd D:\Python\trading-system\api
tail -f logs/*.log | findstr /C:"期权" /C:"option" /C:"Greeks" /C:"Delta"
```

### 2. 验证服务健康

```bash
# 检查API健康
curl http://localhost:3001/api/health

# 检查前端可访问
# 浏览器访问：http://localhost:3000
```

---

## 🧪 测试场景

### 场景1：QQQ期权链查询（基础功能）

#### 测试步骤
1. 打开浏览器：http://localhost:3000/options/chain?symbol=QQQ.US
2. 等待页面加载（约3-5秒）
3. 观察期权链显示

#### 预期结果
✅ **期权到期日期列表**：
- 显示25个左右的到期日期
- 最近的日期在列表顶部
- 日期格式：`2026-01-27 (0天后)`

✅ **正股信息显示**：
- 股票代码：QQQ
- 当前价格：约430-435 USD
- 涨跌幅显示

✅ **期权链数据**：
- CALL期权在左侧
- PUT期权在右侧
- 显示行权价、买价、卖价、成交量、持仓量

#### 验证要点
- [ ] 页面无错误提示
- [ ] 期权链数据加载成功
- [ ] 底层资产价格正确显示
- [ ] 期权价格实时更新（如在交易时间）

#### API调用验证
在浏览器开发者工具（F12 → Network）中检查：
```
GET /api/options/chain?symbol=QQQ.US
→ 返回200 OK
→ 响应包含 strikeDates 和 optionChain

GET /api/options/quote?symbol=QQQ260127C500000.US
→ 返回200 OK
→ 响应包含 underlyingPrice（新增字段）
```

---

### 场景2：SPX指数期权链查询（0DTE测试）

#### 测试步骤
1. 在搜索框输入：SPX
2. 选择：S&P 500 Index (.SPX.US)
3. 等待期权链加载

#### 预期结果
✅ **指数期权特性**：
- 期权链加载成功
- 显示0DTE期权（当天到期）
- 行权价密集（每5点或10点一个行权价）

✅ **0DTE期权验证**：
- 在到期日期列表中找到 `leftDay=0` 的日期
- 选择该日期，查看期权链
- 观察是否有详细的Greeks数据

#### 验证要点
- [ ] SPX指数搜索成功
- [ ] 期权链加载（不报错）
- [ ] 0DTE期权显示
- [ ] Greeks数据完整（Delta、Theta、IV等）

#### 后端日志验证
在日志中查找：
```
grep "选择0DTE期权" logs/*.log
grep "SPX.*stockId" logs/*.log
grep "使用已知指数映射" logs/*.log
```

预期输出：
```
[使用已知指数映射] SPX -> stockId=200003
[选择0DTE期权] strikeDate=YYYYMMDD, leftDay=0
```

---

### 场景3：期权详情查看（数据完整性）

#### 测试步骤
1. 在期权链页面中，点击任意一个期权（如 QQQ260127C500000）
2. 查看期权详情弹窗或详情页面

#### 预期结果
✅ **期权基本信息**：
- 期权代码：QQQ260127C500000.US
- 期权类型：CALL 或 PUT
- 行权价：500.00
- 到期日期：2026-01-27

✅ **价格信息**：
- 当前价格：实时更新
- 买价/卖价：显示买卖价差
- 买卖量：显示挂单量

✅ **Greeks信息**：
- Delta：0.xxxx（4位小数）
- Theta：-x.xxxx
- Gamma、Vega、Rho
- 隐含波动率：xx.xx%

✅ **底层资产信息**（新增）：
- 底层价格：430.9
- 底层涨跌：-4.3
- 底层涨跌幅：-0.99%

#### 验证要点
- [ ] 期权详情弹窗/页面打开
- [ ] 所有字段显示完整
- [ ] 底层资产价格显示（新增字段）
- [ ] Greeks数据完整

#### API调用验证
```
GET /api/options/quote?symbol=QQQ260127C500000.US
→ 检查响应中的 underlyingPrice 字段
```

预期响应结构：
```json
{
  "success": true,
  "data": {
    "price": 10.5,
    "priceBid": 10.4,
    "priceAsk": 10.6,
    "underlyingPrice": 430.9,        // ← 新增字段
    "underlyingChange": -4.3,        // ← 新增字段
    "underlyingChangeRatio": "-0.99%", // ← 新增字段
    "option": {
      "greeks": {
        "delta": 0.5,
        "theta": -0.3
      }
    }
  }
}
```

---

### 场景4：Greeks过滤验证（高级功能）

#### 测试步骤
1. 在期权链页面，观察日志输出（需要打开开发者工具 Console）
2. 搜索不同的股票（TSLA、NVDA、AAPL等）
3. 观察不同行权价期权的Greeks值

#### 预期结果
✅ **过滤日志**（在后端日志中）：
```
[期权 502660798] Delta 0.0442 < 0.3，跳过
[期权 502585868] 价差% 29.79% > 10%，跳过
[期权 502602041] 持仓量 11 < 50，跳过
```

✅ **Greeks数据显示**：
- ATM期权：Delta约0.5
- ITM期权：Delta约0.7-0.9
- OTM期权：Delta约0.1-0.3
- 所有期权：Theta为负值（时间价值衰减）

#### 验证要点
- [ ] Greeks数据合理（符合期权定价规律）
- [ ] 过滤日志详细（记录过滤原因）
- [ ] 无"Greeks数据不可用"警告（在交易时间）

---

### 场景5：期权下单测试（谨慎操作）

⚠️ **风险提示**：此测试涉及真实下单，请使用小金额测试或模拟账户！

#### 测试步骤
1. 在期权链中选择一个流动性好的期权（持仓量>1000）
2. 点击"买入"按钮
3. 输入数量：1张
4. 确认下单

#### 预期结果
✅ **订单提交**：
- 订单成功提交到长桥API
- 返回订单ID
- 显示成功提示

✅ **数据库记录**（检查 `execution_orders` 表）：
```sql
SELECT order_id, symbol, side, quantity, price,
       metadata->>'allocationAmountOverride' as allocation,
       metadata->>'multiplier' as multiplier,
       metadata->>'estimatedFees' as fees
FROM execution_orders
WHERE symbol LIKE '%260127%'
ORDER BY created_at DESC LIMIT 1;
```

预期字段：
- `symbol`: QQQ260127C500000.US
- `side`: BUY
- `quantity`: 1
- `price`: 10.5（权利金）
- `allocationAmountOverride`: 1051.29（10.5×100×1+1.29）
- `multiplier`: 100
- `estimatedFees`: 1.29

#### 验证要点
- [ ] 订单成功提交
- [ ] `allocationAmountOverride` 正确保存
- [ ] `multiplier` 正确记录
- [ ] 手续费正确计算

⚠️ **重要**：测试完成后立即取消订单或等待成交后平仓！

---

### 场景6：策略自动执行测试（完整流程）

⚠️ **建议**：在交易时间内进行

#### 测试步骤
1. 访问：http://localhost:3000/quant/strategies
2. 创建新策略：
   ```json
   {
     "strategyName": "QQQ-0DTE-Test",
     "strategyType": "OPTION_INTRADAY_V1",
     "symbolPool": ["QQQ.US"],
     "config": {
       "assetClass": "OPTION",
       "expirationMode": "0DTE",
       "directionMode": "FOLLOW_SIGNAL",
       "positionSizing": {
         "mode": "FIXED_CONTRACTS",
         "fixedContracts": 1
       },
       "liquidityFilters": {
         "minOpenInterest": 100,
         "maxBidAskSpreadPct": 20.0
       },
       "greekFilters": {
         "deltaMin": 0.2,
         "deltaMax": 0.8
       },
       "tradeWindow": {
         "noNewEntryBeforeCloseMinutes": 60,
         "forceCloseBeforeCloseMinutes": 30
       },
       "entryPriceMode": "ASK"
     },
     "capitalAllocation": {
       "allocationType": "FIXED",
       "fixedAmount": 2000
     }
   }
   ```
3. 启动策略
4. 监控日志

#### 预期行为

**阶段1：信号生成**（约1-2分钟）
```
[策略调度器] 策略 XX 标的 QQQ.US: 生成信号 BUY
[期权策略] 选择0DTE CALL期权
[选择0DTE期权] strikeDate=YYYYMMDD, leftDay=0
[期权 XXXXXX] Delta 0.4523（符合条件）
[期权 XXXXXX] 持仓量 5234（符合条件）
[期权 XXXXXX] 价差% 3.21%（符合条件）
```

**阶段2：开仓执行**
```
[资金管理] 策略 XX 申请资金: 1051.29 USD（allocationAmountOverride）
[订单执行] 提交买入订单: QQQ260127C500000.US, 数量=1, 限价=10.50
[订单监控] 订单 XXXXXX 已成交
[状态更新] 策略 XX 标的 QQQ.US: IDLE → HOLDING
```

**阶段3：持仓监控**（每分钟）
```
[持仓监控] 策略 XX 期权 QQQ260127C500000.US: 当前价格=11.20（来自cache(futunn)）
[持仓监控] 策略 XX 期权: 盈亏=(11.20-10.50)*100*1=70.00 USD
```

**阶段4：强制平仓**（收盘前30分钟）
```
[市场时段] 收盘前30分钟，触发强制平仓
[订单执行] 提交卖出订单: QQQ260127C500000.US, 数量=1, 限价=11.20
[订单监控] 卖出订单已成交
[资金管理] 策略 XX 释放资金: 1051.29 USD（来自allocationAmount）
[状态更新] 策略 XX 标的 QQQ.US: HOLDING → IDLE
```

#### 验证要点
- [ ] 信号生成成功
- [ ] 期权选择正确（0DTE、符合过滤条件）
- [ ] 资金锁定金额正确
- [ ] 持仓监控正常
- [ ] 价格缓存生效
- [ ] 强制平仓触发
- [ ] 资金释放金额一致

---

## 📊 关键监控指标

### 1. 资金管理指标

```bash
# 监控资金分配和释放
tail -f logs/*.log | findstr /C:"申请资金" /C:"释放资金" /C:"allocationAmount"
```

**验证点**：
- 申请金额 = 权利金×乘数×合约数 + 手续费
- 释放金额 = 申请金额（必须一致）
- 无"allocationAmount缺失"警告

**示例日志**：
```
[资金管理] 策略 10 申请资金: 1051.29 USD
[资金管理] 策略 10 期权 QQQ260127C500000.US: 资金释放 1051.29 USD（来自allocationAmount）
```

### 2. 期权价格获取指标

```bash
# 监控价格获取来源
tail -f logs/*.log | findstr /C:"期权.*价格" /C:"priceSource" /C:"cache" /C:"futunn"
```

**验证点**：
- 首次获取：来自 LongPort 或 富途详情
- 后续获取：来自 cache（缓存命中）
- 无"富途详情获取失败"错误

**示例日志**：
```
[持仓监控] 策略 10 期权 QQQ260127C500000.US: 当前价格=11.20（来自cache(futunn)）
[持仓监控] 策略 10 期权 QQQ260127C500000.US: 从富途详情获取价格 11.20（bid=11.10, ask=11.30）
```

### 3. Greeks过滤指标

```bash
# 监控Greeks过滤
tail -f logs/*.log | findstr /C:"Delta.*跳过" /C:"Theta.*跳过" /C:"价差.*跳过"
```

**验证点**：
- 详细记录过滤原因
- Delta、Theta范围合理
- 无"Greeks数据不可用"警告（交易时间）

**示例日志**：
```
[期权 502660798] Delta 0.0442 < 0.3，跳过
[期权 502585868] 价差% 29.79% > 10%，跳过
[期权 502602041] 持仓量 11 < 50，跳过
```

### 4. 0DTE期权识别指标

```bash
# 监控0DTE识别
tail -f logs/*.log | findstr /C:"0DTE" /C:"leftDay=0"
```

**验证点**：
- 正确识别当日到期期权
- 降级到NEAREST时有日志记录

**示例日志**：
```
[选择0DTE期权] strikeDate=1769490000, leftDay=0
```

---

## 🔍 故障排查

### 问题1：期权链加载失败

**症状**：
- 页面显示"加载失败"
- 控制台显示API错误

**排查步骤**：
1. 检查API服务是否启动：`curl http://localhost:3001/api/health`
2. 检查富途配置：查看 `system_config` 表中的 `futunn_csrf_token` 和 `futunn_cookies`
3. 检查边缘函数：访问 https://cfapi.riowang.win/api/moomooapi 是否正常
4. 查看后端日志：`tail -f logs/*.log | findstr /C:"Moomoo代理" /C:"富途"`

**解决方案**：
- 如果是配置问题：更新数据库中的富途配置
- 如果是网络问题：检查边缘函数服务状态
- 如果是API限流：等待1-2分钟后重试

### 问题2：期权详情显示不完整

**症状**：
- 底层价格未显示
- Greeks数据缺失

**排查步骤**：
1. 检查API响应：F12 → Network → 查看 `/api/options/quote` 响应
2. 验证是否包含 `underlyingPrice` 字段
3. 检查后端日志：是否有"数据不可用"警告

**解决方案**：
- 如果字段缺失：重启API服务（确保使用最新代码）
- 如果Greeks缺失：可能是非交易时间或期权不活跃

### 问题3：0DTE期权未找到

**症状**：
- 日志显示"0DTE期权不可用，降级到最近期权"

**排查步骤**：
1. 检查当前时间：是否在交易时间内
2. 检查期权到期日期列表：是否有 `leftDay=0` 的日期
3. 查看日志：`grep "0DTE" logs/*.log`

**原因**：
- 可能没有当日到期的期权（非每天都有0DTE）
- 可能已过收盘时间（0DTE期权已过期）

**解决方案**：
- 使用 `NEAREST` 模式代替 `0DTE`
- 选择有0DTE期权的标的（SPX/SPXW每天都有）

### 问题4：Greeks过滤太严格，无法选择期权

**症状**：
- 日志显示所有候选期权都被过滤
- 策略无法开仓

**排查步骤**：
1. 查看过滤日志：所有期权被过滤的原因
2. 检查过滤条件：是否太严格

**解决方案**：
```json
// 放宽过滤条件
{
  "liquidityFilters": {
    "minOpenInterest": 50,           // 降低到50
    "maxBidAskSpreadPct": 30.0       // 放宽到30%
  },
  "greekFilters": {
    "deltaMin": 0.2,                 // 放宽到0.2-0.8
    "deltaMax": 0.8
  }
}
```

---

## 📋 测试清单

### 基础功能（必须全部通过）
- [ ] API服务正常启动
- [ ] 前端服务正常启动
- [ ] 期权链页面可访问
- [ ] QQQ期权链加载成功
- [ ] SPX期权链加载成功
- [ ] 期权详情显示完整
- [ ] 底层资产价格显示（新增字段）
- [ ] Greeks数据显示完整

### 日志验证（必须检查）
- [ ] 无TypeScript编译错误
- [ ] 无"allocationAmount缺失"警告
- [ ] 无"multiplier缺失"错误
- [ ] 无"Greeks数据不可用"警告（交易时间）
- [ ] 有详细的过滤日志
- [ ] 有详细的价格获取日志

### 数据验证（交易时间内）
- [ ] 期权订单正确保存到数据库
- [ ] `allocationAmountOverride` 正确计算
- [ ] 资金分配记录正确
- [ ] 资金释放金额一致
- [ ] 持仓状态正确同步

---

## 🎯 成功标准

### 基础功能（100%必须通过）
- ✅ 编译通过（无TypeScript错误）
- ✅ 单元测试通过（9/9）
- ✅ API服务启动成功
- ✅ 前端页面加载成功
- ✅ 期权链查询成功

### 核心修复（90%必须验证）
- ✅ 资金管理逻辑正确
- ✅ 期权价格获取成功
- ✅ Greeks过滤器工作
- ✅ 0DTE识别正确
- ⏸️ 完整流程验证（待交易时间）

### 性能指标（建议达成）
- 📈 期权价格缓存命中率 > 80%
- 📈 富途API调用频率 < 10次/分钟
- 📈 持仓监控循环延迟 < 2秒

---

## 📞 支持与反馈

### 测试过程中遇到问题？

1. **查看详细文档**：
   - `docs/fixes/260128-期权策略完整诊断与修复方案.md`（诊断+修复）
   - `docs/fixes/260128-期权策略修复完成总结.md`（修复总结）
   - `docs/test/260128-期权策略修复验证报告.md`（测试报告）

2. **查看日志**：
   ```bash
   # 实时监控
   tail -f logs/*.log

   # 搜索关键字
   grep "期权" logs/*.log
   grep "allocationAmount" logs/*.log
   grep "Greeks" logs/*.log
   ```

3. **检查数据库**：
   ```sql
   -- 检查策略实例
   SELECT * FROM strategy_instances WHERE context->>'optionMeta' IS NOT NULL;

   -- 检查期权订单
   SELECT * FROM execution_orders WHERE metadata->>'assetClass' = 'OPTION';
   ```

---

## ✅ 测试完成确认

测试完成后，请确认以下项：

- [ ] 所有基础功能测试通过
- [ ] 至少一个完整的期权交易流程验证成功
- [ ] 资金分配和释放一致性验证通过
- [ ] 无严重错误或警告日志
- [ ] 性能指标符合预期

**测试签名**：
- 测试日期：____________
- 测试人员：____________
- 测试环境：____________
- 测试结果：✅ 通过 / ⚠️ 部分通过 / ❌ 未通过

---

**文档版本**: v1.0
**最后更新**: 2026-01-28
**维护者**: Trading System Team
