# 盈亏百分比归零与 LIT 止盈保护修复

**日期**: 2026-02-24
**类型**: Bug Fix + Feature
**状态**: ✅ 已完成
**严重性**: P0 — 止盈止损完全失效

---

## 问题描述

### 核心问题：grossPnLPercent 始终为 0.0%，止盈止损完全失效

**实际影响**:
- QQQ260223P601000.US: 入场$2.05→当前$1.29，实际亏损37%，但显示 `盈亏 +0.0%`，止损34%未触发
- SPY260223P682000.US: 入场$1.55→当前$1.13，实际亏损29%，但显示 `盈亏 +0.0%`
- 策略还在亏损时继续买入新仓位（16:24买入SPY260223P682000.US）
- 更早的 QQQ260223P604000.US 也有同样问题: 涨到37%未触发止盈
- 而更早的 QQQ260223P600000.US/SPY260223P683000.US 百分比正常（+22.5%），成功止盈

### 根因分析

P&L计算公式（`option-dynamic-exit.service.ts:193-214`）:
```
grossPnL = priceDiff * quantity * multiplier
costBasis = entryPrice * quantity * multiplier + entryFees
grossPnLPercent = costBasis > 0 ? (grossPnL / costBasis) * 100 : 0
```

美元金额(`grossPnL`)正确但百分比为0 → 说明 `costBasis <= 0`。

**根因**: `multiplier` 字段从 `optionMeta` 提取时未做 `Number()` 转换。当数据库 JSON 字段返回字符串 `"100"` 而非数字 `100` 时：
- `entryPrice * quantity * multiplier` → `1.55 * 1 * "100"` → 字符串拼接 `"155100"` 或 NaN
- `costBasis` 变为 NaN → `NaN > 0` 为 false → `grossPnLPercent = 0`
- `grossPnL = priceDiff * quantity * multiplier` 碰巧因为乘法顺序不同而正确（JS 隐式转换顺序）

**佐证**: 早期仓位（正常的）可能直接从 API 获取了数字类型的 multiplier，而后续仓位从数据库 JSONB 反序列化得到字符串类型。

---

## 修复方案

### 修复1: calculatePnL 防御性数值化 + 诊断日志 + 回退公式

**文件**: `api/src/services/option-dynamic-exit.service.ts`

1. 所有输入参数强制 `Number()` 转换，防止字符串/null/undefined 导致 NaN
2. **安全回退**: 当 `costBasis` 异常（<=0/NaN/Infinity）但有价格差异时，使用简化公式 `(priceDiff / entryPrice) * 100`（不依赖 quantity 和 multiplier）
3. 诊断日志: 回退时 `console.warn()` 输出各字段原始值和 `typeof`，帮助追踪根因
4. 最终 `isFinite()` 兜底，确保百分比永远不会是 NaN/Infinity
5. `breakEvenPrice` 增加 quantity/multiplier 为0时的保护

### 修复2: positionCtx 构建处数值类型强化

**文件**: `api/src/services/strategy-scheduler.service.ts`

- `multiplier`: `optionMeta.multiplier || 100` → `Number(optionMeta.multiplier) || 100`
- `positionCtx` 构建: `entryPrice`, `currentPrice`, `quantity`, `multiplier` 全部 `Number()` 包裹（双重保险）

### 修复3: LIT 止盈保护单（新增）

**文件**: `api/src/services/trailing-stop-protection.service.ts`

新增 `submitTakeProfitProtection()` 方法:
- 使用 `OrderType.LIT`（触价限价单）+ `OrderSide.Sell`
- `triggerPrice` = entryPrice × (1 + takeProfitPercent/100)
- `submittedPrice`（限价）= triggerPrice × 0.97（留3%滑点空间确保成交）
- `TimeInForce` = GoodTilDate（同期权到期日）
- 写入 `execution_orders` 表

新增 `cancelTakeProfitProtection()` 方法（复用 `cancelProtection` 逻辑）。

**设计思路**: TSLPPCT 防回撤（跌时保护），LIT 确保止盈触发（涨时保护）。两者互补构成双保险。

### 修复4: 买入成交后同时提交 TSLPPCT + LIT

**文件**: `api/src/services/strategy-scheduler.service.ts`

**买入成交后**:
1. 提交 TSLPPCT 跟踪止损（已有逻辑）
2. **新增**: 计算止盈触发价（基于 `strategyConfig.exitRules.takeProfitPercent`，默认25%），调用 `submitTakeProfitProtection()` 提交 LIT 止盈单
3. 将 `takeProfitOrderId` 存入 context

**持仓监控时**:
1. 检查 TSLPPCT 状态（已有逻辑）
2. **新增**: 检查 LIT 止盈单状态 — 若已成交则同时取消 TSLPPCT 并转 IDLE
3. 若 LIT 已取消/过期则清除 `takeProfitOrderId`

**软件退出前**:
1. 取消 TSLPPCT（已有逻辑）
2. **新增**: 取消 LIT 止盈单 — 若发现已成交则跳过软件卖出，直接转 IDLE

---

## 修改文件清单

| 文件 | 改动 |
|------|------|
| `api/src/services/option-dynamic-exit.service.ts` | `calculatePnL()` 防御性 `Number()` 转换 + NaN 回退公式 + 诊断日志 |
| `api/src/services/strategy-scheduler.service.ts` | `multiplier` 和 `positionCtx` 数值类型保护；买入后提交 LIT 止盈单；持仓监控 LIT 状态检查；退出前取消 LIT |
| `api/src/services/trailing-stop-protection.service.ts` | 新增 `submitTakeProfitProtection()` + `cancelTakeProfitProtection()` |

---

## 保护单生命周期

```
期权买入成交
  ├─ 提交 TSLPPCT 跟踪止损保护单（防回撤）
  └─ 提交 LIT 止盈保护单（确保止盈）
      │
持仓期间
  ├─ 软件监控: calculatePnL → checkExitCondition（动态止盈止损）
  ├─ TSLPPCT 状态检查: filled → 转IDLE+取消LIT / cancelled → 清除ID
  └─ LIT 状态检查: filled → 转IDLE+取消TSLPPCT / cancelled → 清除ID
      │
软件触发平仓
  ├─ 取消 TSLPPCT（若已成交 → 跳过卖出）
  ├─ 取消 LIT（若已成交 → 跳过卖出）
  └─ 执行市价卖出
```

---

## 验证方法

```bash
# TypeScript 编译检查
cd api && npx tsc --noEmit
```

功能验证（下次交易日观察日志）:
- [ ] 盈亏百分比正确显示（非0.0%）— 日志中 `grossPnLPercent` 应与 `(priceDiff/entryPrice)*100` 一致
- [ ] 若触发回退公式，日志中出现 `[PnL诊断] costBasis异常` 并显示各字段 typeof
- [ ] 止盈止损正常触发 — 当盈亏达到阈值时应触发平仓
- [ ] 买入成交后日志显示两个保护单提交成功（TSLPPCT + LIT）
- [ ] LIT 止盈单参数正确: triggerPrice = entryPrice × (1 + tp%), limitPrice = triggerPrice × 0.97
- [ ] 平仓前日志显示取消两个保护单（TSLPPCT + LIT）
- [ ] 若 LIT/TSLPPCT 在软件卖出前已触发成交，日志显示跳过软件卖出

---

## 关联文档

- [260212-止盈止损配置生效修复](./260212-止盈止损配置生效修复.md) — 用户配置的止盈止损比例传递给退出引擎
- [260218-期权信号系统动态化改造开发文档](../features/260218-期权信号系统动态化改造开发文档.md) — TSLPPCT 初始集成
- [260216-0DTE单腿动态风控开发文档](../features/260216-0DTE单腿动态风控开发文档.md) — 0DTE 动态风控
