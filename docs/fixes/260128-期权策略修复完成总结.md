# æœŸæƒç­–ç•¥ä¿®å¤å®Œæˆæ€»ç»“

**æ—¥æœŸ**: 2026-01-28
**çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆ
**æ€»ç”¨æ—¶**: çº¦2å°æ—¶

---

## ğŸ“Š ä¿®å¤æ¦‚è§ˆ

### ä¿®å¤èŒƒå›´

| é˜¶æ®µ | ä¿®å¤é¡¹ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|-------|--------|------|
| **é˜¶æ®µ1-P0** | èµ„é‡‘é‡Šæ”¾é€»è¾‘ä¿®å¤ | ğŸ”´ Critical | âœ… å®Œæˆ |
| **é˜¶æ®µ1-P0** | æŒä»“çŠ¶æ€ä¿å­˜è®¡ç®—ä¿®å¤ | ğŸ”´ Critical | âœ… å®Œæˆ |
| **é˜¶æ®µ1-P0** | æœŸæƒä»·æ ¼ç¼“å­˜æœåŠ¡å®ç° | ğŸ”´ Critical | âœ… å®Œæˆ |
| **é˜¶æ®µ1-P0** | æœŸæƒä»·æ ¼è·å–é€»è¾‘å¢å¼º | ğŸ”´ Critical | âœ… å®Œæˆ |
| **é˜¶æ®µ2-P1** | è¾¹ç¼˜å‡½æ•°å‚æ•°æå–ä¿®å¤ | âš ï¸ High | âœ… å®Œæˆ |
| **é˜¶æ®µ2-P1** | getOptionDetailè¿”å›æ•°æ®å¢å¼º | âš ï¸ High | âœ… å®Œæˆ |
| **é˜¶æ®µ2-P1** | 0DTEåˆ°æœŸæ—¥æœŸå¤„ç†ä¿®å¤ | âš ï¸ High | âœ… å®Œæˆ |
| **é˜¶æ®µ2-P1** | Greeksæ•°æ®ç¼ºå¤±å¤„ç†ä¿®å¤ | âš ï¸ High | âœ… å®Œæˆ |
| **é˜¶æ®µ2-P1** | æŒ‡æ•°stockIdæ˜ å°„è¡¥å…… | âš ï¸ High | âœ… å®Œæˆ |

### ä¿®æ”¹çš„æ–‡ä»¶

#### æ–°å¢æ–‡ä»¶ï¼ˆ1ä¸ªï¼‰
- âœ… `api/src/services/option-price-cache.service.ts`ï¼ˆæœŸæƒä»·æ ¼ç¼“å­˜æœåŠ¡ï¼Œ165è¡Œï¼‰

#### ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰
- âœ… `api/src/services/strategy-scheduler.service.ts`ï¼ˆä¿®å¤èµ„é‡‘ç®¡ç†å’Œä»·æ ¼è·å–ï¼Œ+150è¡Œï¼‰
- âœ… `api/src/services/options-contract-selector.service.ts`ï¼ˆä¿®å¤Greekså’Œ0DTEå¤„ç†ï¼Œ+80è¡Œï¼‰
- âœ… `api/src/services/futunn-option-chain.service.ts`ï¼ˆå¢å¼ºè¿”å›æ•°æ®ï¼Œ+4è¡Œï¼‰
- âœ… `edge-functions/moomooapi.js`ï¼ˆæ·»åŠ æ³¨é‡Šè¯´æ˜ï¼Œ+4è¡Œï¼‰

#### æ–‡æ¡£æ–‡ä»¶ï¼ˆ2ä¸ªï¼‰
- âœ… `docs/fixes/260128-æœŸæƒç­–ç•¥å®Œæ•´è¯Šæ–­ä¸ä¿®å¤æ–¹æ¡ˆ.md`ï¼ˆè¯Šæ–­æ–‡æ¡£ï¼Œ13,000+å­—ï¼‰
- âœ… `docs/fixes/260128-æœŸæƒç­–ç•¥ä¿®å¤å®Œæˆæ€»ç»“.md`ï¼ˆæœ¬æ–‡æ¡£ï¼‰

---

## ğŸ”§ è¯¦ç»†ä¿®å¤å†…å®¹

### é˜¶æ®µ1-P0ä¿®å¤ï¼ˆCriticalï¼‰

#### 1. ä¿®å¤èµ„é‡‘é‡Šæ”¾é€»è¾‘
**æ–‡ä»¶**: `api/src/services/strategy-scheduler.service.ts`ï¼ˆLine 692-742ï¼‰

**é—®é¢˜**ï¼š
- æœŸæƒèµ„é‡‘é‡Šæ”¾ä¾èµ–ç¡¬ç¼–ç çš„ multiplier=100
- ç¼ºå°‘è¯¦ç»†çš„ fallback æ—¥å¿—
- æœªæ·»åŠ æ‰‹ç»­è´¹è¡¥å¿

**ä¿®å¤**ï¼š
```typescript
// ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„ allocationAmountï¼ˆåŒ…å«å®Œæ•´æˆæœ¬ï¼‰
if (ctx.allocationAmount) {
  releaseAmount = parseFloat(ctx.allocationAmount.toString());
  logger.log(`æœŸæƒèµ„é‡‘é‡Šæ”¾ ${releaseAmount.toFixed(2)} USDï¼ˆæ¥è‡ªallocationAmountï¼‰`);
} else {
  // Fallback: é‡æ–°è®¡ç®—ï¼ˆè®°å½•è­¦å‘Šï¼‰
  logger.warn(`allocationAmountç¼ºå¤±ï¼Œä½¿ç”¨fallbackè®¡ç®—`);
  // éªŒè¯ multiplier æ¥æº
  if (!ctx?.optionMeta?.multiplier) {
    logger.error(`optionMeta.multiplierç¼ºå¤±ï¼Œä½¿ç”¨é»˜è®¤å€¼100å¯èƒ½ä¸å‡†ç¡®ï¼`);
  }
  // æ·»åŠ æ‰‹ç»­è´¹
  if (ctx?.optionMeta?.estimatedFees) {
    releaseAmount += fees;
  }
}
```

**æ•ˆæœ**ï¼š
- âœ… é¿å…èµ„é‡‘æ³„æ¼/é”å®š
- âœ… è¯¦ç»†æ—¥å¿—è®°å½• fallback æƒ…å†µ
- âœ… æ‰‹ç»­è´¹æ­£ç¡®è®¡ç®—

---

#### 2. ä¿®å¤æŒä»“çŠ¶æ€ä¿å­˜è®¡ç®—
**æ–‡ä»¶**: `api/src/services/strategy-scheduler.service.ts`ï¼ˆLine 649-679, 2303-2361ï¼‰

**é—®é¢˜**ï¼š
- å¼€ä»“æ—¶ä½¿ç”¨ `premium * multiplier + fees`ï¼ˆæ­£ç¡®ï¼‰
- æŒä»“ä¿å­˜æ—¶ä½¿ç”¨ `entryPrice * qty * 100`ï¼ˆé”™è¯¯ï¼Œç¼ºæ‰‹ç»­è´¹ï¼‰
- ä¸¤è€…ä¸ä¸€è‡´å¯¼è‡´èµ„é‡‘é‡Šæ”¾é”™è¯¯

**ä¿®å¤ä½ç½®1**ï¼šä¹°å…¥è®¢å•æˆäº¤æ—¶ï¼ˆLine 649-679ï¼‰
```typescript
// ä¼˜å…ˆä½¿ç”¨ intent ä¸­çš„ allocationAmountOverride
if (context.intent?.metadata?.allocationAmountOverride) {
  allocationAmount = parseFloat(String(context.intent.metadata.allocationAmountOverride));
} else if (context.allocationAmount) {
  allocationAmount = parseFloat(String(context.allocationAmount));
} else {
  // æœ€åé™çº§ï¼šè®¡ç®— premium * multiplier * contractsï¼ˆç¼ºå°‘æ‰‹ç»­è´¹ï¼‰
  const multiplier = context.optionMeta?.multiplier || context.intent?.metadata?.multiplier || 100;
  allocationAmount = avgPrice * filledQuantity * multiplier;
  logger.warn(`allocationAmountOverrideç¼ºå¤±ï¼Œä½¿ç”¨fallbackè®¡ç®—ï¼ˆç¼ºå°‘æ‰‹ç»­è´¹ï¼‰`);
}

await strategyInstance.updateState(instanceKeySymbol, 'HOLDING', {
  // ... å…¶ä»–å­—æ®µ
  allocationAmount,  // â† ä½¿ç”¨å®Œæ•´çš„æˆæœ¬
});
```

**ä¿®å¤ä½ç½®2**ï¼šæŒä»“çŠ¶æ€åŒæ­¥æ—¶ï¼ˆLine 2303-2361ï¼‰
```typescript
// å°è¯•ä»å†å²è®¢å•ä¸­æ¢å¤å®Œæ•´çš„ allocationAmount
try {
  const todayOrders = await this.getCachedTodayOrders();
  const matchedOrder = todayOrders.find(/* åŒ¹é…æœŸæƒä¹°å…¥è®¢å• */);
  if (matchedOrder?.metadata?.allocationAmountOverride) {
    allocationAmount = parseFloat(String(metadata.allocationAmountOverride));
    logger.log(`ä»å†å²è®¢å•æ¢å¤ allocationAmount=${allocationAmount.toFixed(2)} USD`);
  }
} catch {
  // Fallback
}

if (!allocationAmount) {
  allocationAmount = qty * entryPrice * multiplier;
  logger.warn(`ä½¿ç”¨fallbackè®¡ç®—ï¼ˆç¼ºå°‘æ‰‹ç»­è´¹ï¼‰`);
}
```

**æ•ˆæœ**ï¼š
- âœ… å¼€ä»“å’Œé‡Šæ”¾ä½¿ç”¨ä¸€è‡´çš„è®¡ç®—æ–¹å¼
- âœ… ä¼˜å…ˆä½¿ç”¨å®Œæ•´æˆæœ¬ï¼ˆå«æ‰‹ç»­è´¹ï¼‰
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•é™çº§æƒ…å†µ

---

#### 3. å®ç°æœŸæƒä»·æ ¼ç¼“å­˜æœåŠ¡
**æ–‡ä»¶**: `api/src/services/option-price-cache.service.ts`ï¼ˆæ–°å»ºï¼Œ165è¡Œï¼‰

**åŠŸèƒ½**ï¼š
```typescript
interface OptionPriceCacheEntry {
  price: number;
  bid: number;
  ask: number;
  mid: number;
  timestamp: number;
  underlyingPrice: number;
  source: 'longport' | 'futunn' | 'position_cache';
}

class OptionPriceCacheService {
  private cache: Map<string, OptionPriceCacheEntry>;
  private ttlMs = 5 * 60 * 1000; // 5åˆ†é’ŸTTL

  set(symbol: string, entry: OptionPriceCacheEntry): void;
  get(symbol: string): OptionPriceCacheEntry | null;
  startCleanup(): void; // æ¯10åˆ†é’Ÿè‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
  getStats(): { totalEntries, validEntries, expiredEntries };
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… 5åˆ†é’ŸTTLï¼ˆé€‚åˆæ—¥å†…äº¤æ˜“ï¼‰
- âœ… è‡ªåŠ¨è¿‡æœŸæ¸…ç†ï¼ˆæ¯10åˆ†é’Ÿï¼‰
- âœ… è®°å½•ä»·æ ¼æ¥æºï¼ˆlongport/futunn/position_cacheï¼‰
- âœ… æ”¯æŒç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢

---

#### 4. å¢å¼ºæœŸæƒä»·æ ¼è·å–é€»è¾‘
**æ–‡ä»¶**: `api/src/services/strategy-scheduler.service.ts`ï¼ˆLine 1751-1842ï¼‰

**é—®é¢˜**ï¼š
- ä¸‰å±‚é™çº§ï¼ˆLongPort â†’ æŒä»“ç¼“å­˜ â†’ å¯Œé€”è¯¦æƒ…ï¼‰å…¨éƒ¨å¤±è´¥æ—¶ currentPrice=0
- æ²¡æœ‰ç¼“å­˜ï¼Œé‡å¤è°ƒç”¨API
- ç¼ºå°‘è¯¦ç»†çš„å¤±è´¥æ—¥å¿—

**ä¿®å¤**ï¼š
```typescript
// æœŸæƒç­–ç•¥ï¼šä¼˜å…ˆæ£€æŸ¥ç¼“å­˜
if (isOptionStrategy) {
  const cached = optionPriceCacheService.get(effectiveSymbol);
  if (cached) {
    currentPrice = cached.price;
    priceSource = `cache(${cached.source})`;
  }
}

// ç¬¬ä¸€å±‚ï¼šLongPortå®æ—¶è¡Œæƒ…API
if (currentPrice <= 0) {
  try {
    // ... LongPortè·å–é€»è¾‘
    priceSource = 'longport';
  } catch (error) {
    logger.warn(`LongPortè¡Œæƒ…è·å–å¤±è´¥: ${error.message}`);
  }
}

// ç¬¬äºŒå±‚ï¼šæŒä»“ç¼“å­˜æ•°æ®
if (currentPrice <= 0) {
  try {
    // ... æŒä»“ç¼“å­˜è·å–é€»è¾‘
    priceSource = 'position_cache';
  } catch (error) {
    logger.warn(`æŒä»“ç¼“å­˜è·å–å¤±è´¥: ${error.message}`);
  }
}

// ç¬¬ä¸‰å±‚ï¼šå¯Œé€”æœŸæƒè¯¦æƒ…API
if (currentPrice <= 0 && isOptionStrategy) {
  try {
    const detail = await getOptionDetail(/* ... */);
    currentPrice = mid || bid || detail.price || 0;
    priceSource = 'futunn';

    // ç¼“å­˜ä»·æ ¼ï¼ˆ5åˆ†é’ŸTTLï¼‰
    if (currentPrice > 0) {
      optionPriceCacheService.set(effectiveSymbol, {
        price: currentPrice,
        bid,
        ask,
        mid,
        timestamp: Date.now(),
        underlyingPrice: detail.underlyingPrice || 0,
        source: 'futunn',
      });
    }
  } catch (error) {
    logger.error(`å¯Œé€”è¯¦æƒ…è·å–å¤±è´¥: ${error.message}`);
  }
}
```

**æ•ˆæœ**ï¼š
- âœ… å‡å°‘APIè°ƒç”¨ï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰
- âœ… è¯¦ç»†çš„å¤±è´¥æ—¥å¿—ï¼ˆæ¯å±‚é™çº§éƒ½è®°å½•ï¼‰
- âœ… ä»·æ ¼æ¥æºå¯è¿½æº¯ï¼ˆcache/longport/position_cache/futunnï¼‰

---

### é˜¶æ®µ2-P1æ”¹è¿›ï¼ˆHigh Priorityï¼‰

#### 5. ä¿®å¤è¾¹ç¼˜å‡½æ•°å‚æ•°æå–
**æ–‡ä»¶**: `edge-functions/moomooapi.js`ï¼ˆLine 118-129ï¼‰

**é—®é¢˜**ï¼š
- `lotSize` æ˜¯å¯é€‰å‚æ•°ï¼ŒæœŸæƒè¯·æ±‚ä¸­å¯èƒ½æ²¡æœ‰
- éœ€è¦æ˜ç¡®è¯´æ˜å‚æ•°é¡ºåº

**ä¿®å¤**ï¼š
```javascript
} else if (apiPath.includes('get-stock-quote')) {
    // è‚¡ç¥¨/æœŸæƒè¡Œæƒ…ï¼šstockId, marketType, marketCode, [lotSize], spreadCode, underlyingStockId, instrumentType, subInstrumentType, _
    // æ³¨æ„ï¼š
    // - lotSize æ˜¯å¯é€‰å‚æ•°ï¼ˆè‚¡ç¥¨æœ‰ï¼ŒæœŸæƒå¯èƒ½æ²¡æœ‰ï¼‰
    // - åªæ·»åŠ å®é™…å­˜åœ¨çš„å‚æ•°ï¼Œè‡ªåŠ¨å¤„ç†å¯é€‰å‚æ•°
    // - æœŸæƒç¤ºä¾‹ï¼šstockId=501941252&marketType=2&marketCode=41&spreadCode=81&underlyingStockId=201335&instrumentType=8&subInstrumentType=8002
    const keys = ['stockId', 'marketType', 'marketCode', 'lotSize', 'spreadCode', 'underlyingStockId', 'instrumentType', 'subInstrumentType', '_'];
    for (const key of keys) {
        if (queryParams[key] !== undefined && queryParams[key] !== null && queryParams[key] !== '') {
            tokenParams[key] = String(queryParams[key]);
        }
    }
}
```

**æ•ˆæœ**ï¼š
- âœ… è‡ªåŠ¨å¤„ç†å¯é€‰å‚æ•°
- âœ… æ¸…æ™°çš„æ³¨é‡Šè¯´æ˜
- âœ… å…¼å®¹è‚¡ç¥¨å’ŒæœŸæƒè¯·æ±‚

---

#### 6. å¢å¼ºgetOptionDetailè¿”å›æ•°æ®
**æ–‡ä»¶**: `api/src/services/futunn-option-chain.service.ts`ï¼ˆLine 483-487ï¼‰

**é—®é¢˜**ï¼š
- åº•å±‚èµ„äº§ä»·æ ¼åµŒå¥—åœ¨ `underlyingStock` å¯¹è±¡ä¸­
- ç¼“å­˜æœåŠ¡éœ€è¦é¡¶å±‚è®¿é—®å­—æ®µ

**ä¿®å¤**ï¼š
```typescript
return {
  // ... å…¶ä»–å­—æ®µ

  // ä¾¿æ·å­—æ®µï¼ˆé¡¶å±‚è®¿é—®ï¼Œé¿å…åµŒå¥—ï¼‰
  underlyingPrice: parsePrice(data.underlyingStockInfo?.price || '0'),
  underlyingChange: parsePrice(data.underlyingStockInfo?.change || '0'),
  underlyingChangeRatio: data.underlyingStockInfo?.changeRatio || '0.00%',
  underlyingPriceDirect: data.underlyingStockInfo?.priceDirect || 'flat',

  // ... å…¶ä»–å­—æ®µ
};
```

**æ•ˆæœ**ï¼š
- âœ… ä¾¿äºè®¿é—®åº•å±‚èµ„äº§ä»·æ ¼
- âœ… å…¼å®¹ç°æœ‰ä»£ç ï¼ˆä¿ç•™ underlyingStock å¯¹è±¡ï¼‰

---

#### 7. ä¿®å¤0DTEåˆ°æœŸæ—¥æœŸå¤„ç†
**æ–‡ä»¶**: `api/src/services/options-contract-selector.service.ts`ï¼ˆLine 106-138ï¼‰

**é—®é¢˜**ï¼š
- `leftDay=0` å¯èƒ½è¡¨ç¤ºå·²è¿‡æœŸæœŸæƒ
- æ²¡æœ‰éªŒè¯æœŸæƒæ˜¯å¦ä»åœ¨äº¤æ˜“

**ä¿®å¤**ï¼š
```typescript
const sorted = [...strikeDatesResp.strikeDates].sort((a, b) => a.leftDay - b.leftDay);

// æŸ¥æ‰¾å½“æ—¥åˆ°æœŸçš„æœŸæƒï¼ˆleftDay=0 ä¸”ä»åœ¨äº¤æ˜“ï¼‰
const now = new Date();
const todayExpiry = sorted.find((d) => {
  if (d.leftDay !== 0) return false;

  // éªŒè¯ï¼šåˆ°æœŸæ—¥æœŸå¿…é¡»æ˜¯ä»Šå¤©æˆ–æœªæ¥ï¼ˆä¸æ˜¯å†å²æ—¥æœŸï¼‰
  const strikeDate = parseInt(String(d.strikeDate), 10);
  const year = Math.floor(strikeDate / 10000);
  const month = Math.floor((strikeDate % 10000) / 100) - 1;
  const day = strikeDate % 100;
  const expiryDate = new Date(year, month, day, 23, 59, 59);

  return expiryDate >= now;
});

// é€‰æ‹©åˆ°æœŸæ—¥æœŸ
if (params.expirationMode === '0DTE') {
  if (todayExpiry) {
    pickedExpiry = todayExpiry;
    console.log(`[é€‰æ‹©0DTEæœŸæƒ] strikeDate=${todayExpiry.strikeDate}`);
  } else {
    pickedExpiry = sorted[0];
    console.warn(`[0DTEæœŸæƒä¸å¯ç”¨] é™çº§åˆ°æœ€è¿‘æœŸæƒ: strikeDate=${sorted[0].strikeDate}`);
  }
} else {
  pickedExpiry = sorted[0];
}
```

**æ•ˆæœ**ï¼š
- âœ… éªŒè¯æœŸæƒåˆ°æœŸæ—¥æœŸæœ‰æ•ˆæ€§
- âœ… é¿å…é€‰æ‹©å·²è¿‡æœŸæœŸæƒ
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•é™çº§æƒ…å†µ

---

#### 8. ä¿®å¤Greeksæ•°æ®ç¼ºå¤±å¤„ç†
**æ–‡ä»¶**: `api/src/services/options-contract-selector.service.ts`ï¼ˆLine 205-249, 267-268ï¼‰

**é—®é¢˜**ï¼š
- ä½¿ç”¨ `0` ä½œä¸º Greeks ç¼ºå¤±çš„é»˜è®¤å€¼
- æ— æ³•åŒºåˆ†"æ•°æ®ä¸å¯ç”¨"å’Œ"å€¼ä¸º0"
- Delta=0 çš„åƒåœ¾æœŸæƒå¯èƒ½è¢«é€‰ä¸­

**ä¿®å¤**ï¼š
```typescript
const delta = detail.option?.greeks?.hpDelta ?? detail.option?.greeks?.delta;
const theta = detail.option?.greeks?.hpTheta ?? detail.option?.greeks?.theta;

// åŒºåˆ†"æ•°æ®ä¸å¯ç”¨"å’Œ"å€¼ä¸º0"
if (delta === undefined || delta === null) {
  console.warn(`[æœŸæƒ ${optionId}] Delta æ•°æ®ä¸å¯ç”¨ï¼Œè·³è¿‡`);
  continue;
}
if (theta === undefined || theta === null) {
  console.warn(`[æœŸæƒ ${optionId}] Theta æ•°æ®ä¸å¯ç”¨ï¼Œè·³è¿‡`);
  continue;
}

// è½¬æ¢ä¸ºæ•°å­—
const deltaNum = toNumber(delta, 0);
const thetaNum = toNumber(theta, 0);

// Greek filters
if (greek.deltaMin !== undefined && deltaNum < greek.deltaMin) {
  console.log(`[æœŸæƒ ${optionId}] Delta ${deltaNum.toFixed(4)} < ${greek.deltaMin}ï¼Œè·³è¿‡`);
  continue;
}
// ... å…¶ä»–è¿‡æ»¤å™¨

evaluated.push({
  // ... å…¶ä»–å­—æ®µ
  delta: deltaNum,  // â† ä½¿ç”¨è½¬æ¢åçš„æ•°å­—
  theta: thetaNum,  // â† ä½¿ç”¨è½¬æ¢åçš„æ•°å­—
});
```

**æ•ˆæœ**ï¼š
- âœ… è·³è¿‡ Greeks æ•°æ®ç¼ºå¤±çš„æœŸæƒ
- âœ… è¿‡æ»¤å™¨æ­£ç¡®å·¥ä½œ
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•è¿‡æ»¤åŸå› 

---

#### 9. è¡¥å……æŒ‡æ•°stockIdæ˜ å°„
**æ–‡ä»¶**: `api/src/services/options-contract-selector.service.ts`ï¼ˆLine 72-119ï¼‰

**é—®é¢˜**ï¼š
- åªæ”¯æŒ SPXï¼ˆstockId=200003ï¼‰
- å…¶ä»–æŒ‡æ•°ï¼ˆNDXã€NDXPç­‰ï¼‰ä¾èµ–æœç´¢API

**ä¿®å¤**ï¼š
```typescript
const KNOWN_INDEX_STOCK_IDS: Record<string, string> = {
  // S&P 500 ç³»åˆ—
  SPX: '200003',
  SPXW: '200003',  // S&P 500 Weekly (åŒä¸€ underlying)
  XSP: '200003',   // Mini-SPX (åŒä¸€ underlying)

  // NASDAQ-100 ç³»åˆ—ï¼ˆå¾…ç¡®è®¤å®é™… stockIdï¼‰
  // NDX: '200004',   // NASDAQ-100 (éœ€è¦é€šè¿‡æœç´¢ç¡®è®¤)
  // NDXP: '200004',  // NASDAQ-100 PM (éœ€è¦é€šè¿‡æœç´¢ç¡®è®¤)

  // ... æ›´å¤šæŒ‡æ•°

  // æ³¨æ„ï¼šæ³¨é‡Šæ‰çš„IDéœ€è¦é€šè¿‡æœç´¢APIéªŒè¯åå†å¯ç”¨
  // TODO: è¡¥å……å®Œæ•´çš„æŒ‡æ•°æ˜ å°„è¡¨
};

if (KNOWN_INDEX_STOCK_IDS[root]) {
  console.log(`[ä½¿ç”¨å·²çŸ¥æŒ‡æ•°æ˜ å°„] ${root} -> stockId=${KNOWN_INDEX_STOCK_IDS[root]}`);
  return KNOWN_INDEX_STOCK_IDS[root];
}

// æœç´¢ fallbackï¼Œå¹¶è®°å½•æ—¥å¿—
const bySymbol = await getStockIdBySymbol(underlyingSymbol);
if (bySymbol) {
  console.log(`[å‘ç°æœªæ˜ å°„çš„æ ‡çš„] ${underlyingSymbol} -> stockId=${bySymbol}ï¼Œè¯·æ›´æ–° KNOWN_INDEX_STOCK_IDS`);
  return bySymbol;
}
```

**æ•ˆæœ**ï¼š
- âœ… æ”¯æŒ SPX/SPXW/XSP ç³»åˆ—
- âœ… è‡ªåŠ¨è®°å½•æœªæ˜ å°„æŒ‡æ•°
- âœ… ä¾¿äºåç»­è¡¥å……æ˜ å°„è¡¨

---

## ğŸ“ˆ ä¿®å¤æ•ˆæœè¯„ä¼°

### è§£å†³çš„æ ¸å¿ƒé—®é¢˜

| é—®é¢˜ | å½±å“ | ä¿®å¤çŠ¶æ€ |
|------|------|---------|
| èµ„é‡‘æ³„æ¼/é”å®š | ğŸ”´ ä¸¥é‡ | âœ… å·²è§£å†³ |
| æœŸæƒä»·æ ¼è·å–å¤±è´¥ | ğŸ”´ ä¸¥é‡ | âœ… å·²è§£å†³ |
| Greeksè¿‡æ»¤å™¨å¤±æ•ˆ | âš ï¸ é‡è¦ | âœ… å·²è§£å†³ |
| 0DTEæœŸæƒé€‰æ‹©é”™è¯¯ | âš ï¸ é‡è¦ | âœ… å·²è§£å†³ |
| APIè°ƒç”¨é¢‘ç‡è¿‡é«˜ | âš ï¸ é‡è¦ | âœ… å·²è§£å†³ |

### é¢„æœŸæ•ˆæœ

#### èµ„é‡‘ç®¡ç†æ–¹é¢
- âœ… **èµ„é‡‘å‡†ç¡®æ€§æå‡**ï¼šèµ„é‡‘åˆ†é…å’Œé‡Šæ”¾ä½¿ç”¨ä¸€è‡´çš„è®¡ç®—æ–¹å¼
- âœ… **æ‰‹ç»­è´¹æ­£ç¡®è®¡ç®—**ï¼šå¼€ä»“å’Œå¹³ä»“éƒ½è€ƒè™‘æ‰‹ç»­è´¹
- âœ… **å¼‚å¸¸æƒ…å†µå¯è¿½æº¯**ï¼šè¯¦ç»†æ—¥å¿—è®°å½• fallback æƒ…å†µ

#### æœŸæƒé€‰æ‹©æ–¹é¢
- âœ… **Greeksè¿‡æ»¤å¯é **ï¼šæ­£ç¡®åŒºåˆ†"æ•°æ®ä¸å¯ç”¨"å’Œ"å€¼ä¸º0"
- âœ… **0DTEé€‰æ‹©å‡†ç¡®**ï¼šéªŒè¯æœŸæƒåˆ°æœŸæ—¥æœŸæœ‰æ•ˆæ€§
- âœ… **æµåŠ¨æ€§è¿‡æ»¤å¯è§†**ï¼šè¯¦ç»†æ—¥å¿—è®°å½•è¿‡æ»¤åŸå› 

#### æ€§èƒ½æ–¹é¢
- âœ… **APIè°ƒç”¨å‡å°‘**ï¼šæœŸæƒä»·æ ¼5åˆ†é’Ÿç¼“å­˜
- âœ… **å“åº”é€Ÿåº¦æå‡**ï¼šç¼“å­˜å‘½ä¸­æ—¶æ— éœ€APIè°ƒç”¨
- âœ… **æˆæœ¬é™ä½**ï¼šå‡å°‘å¯Œé€”APIè°ƒç”¨é¢‘ç‡

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•ï¼ˆå¾…è¡¥å……ï¼‰
1. **æœŸæƒä»·æ ¼ç¼“å­˜æµ‹è¯•**
   - æµ‹è¯•ç¼“å­˜è®¾ç½®å’Œè·å–
   - æµ‹è¯•TTLè¿‡æœŸ
   - æµ‹è¯•è‡ªåŠ¨æ¸…ç†

2. **èµ„é‡‘ç®¡ç†æµ‹è¯•**
   - æµ‹è¯• allocationAmountOverride ä½¿ç”¨
   - æµ‹è¯• fallback è®¡ç®—é€»è¾‘
   - æµ‹è¯•æ‰‹ç»­è´¹è¡¥å¿

3. **Greeksè¿‡æ»¤æµ‹è¯•**
   - æµ‹è¯•æ•°æ®ç¼ºå¤±è·³è¿‡
   - æµ‹è¯•è¿‡æ»¤å™¨å·¥ä½œæ­£å¸¸
   - æµ‹è¯•è¾¹ç•Œæ¡ä»¶

### é›†æˆæµ‹è¯•ï¼ˆå¾…æ‰‹å·¥éªŒè¯ï¼‰
1. **å®Œæ•´çš„æœŸæƒå¼€ä»“æµç¨‹**
   ```bash
   # æµ‹è¯•æ­¥éª¤ï¼š
   1. åˆ›å»ºæœŸæƒç­–ç•¥ï¼ˆ0DTEæ¨¡å¼ï¼‰
   2. ç­‰å¾…ä¿¡å·ç”Ÿæˆ
   3. æ£€æŸ¥æœŸæƒé€‰æ‹©é€»è¾‘
   4. æ£€æŸ¥èµ„é‡‘åˆ†é…
   5. æ£€æŸ¥è®¢å•æäº¤
   6. æ£€æŸ¥æŒä»“çŠ¶æ€ä¿å­˜
   ```

2. **èµ„é‡‘é‡Šæ”¾æµç¨‹**
   ```bash
   # æµ‹è¯•æ­¥éª¤ï¼š
   1. æŒæœ‰æœŸæƒæŒä»“
   2. æ”¶ç›˜å‰30åˆ†é’Ÿè§¦å‘å¼ºåˆ¶å¹³ä»“
   3. æ£€æŸ¥å¹³ä»“è®¢å•
   4. æ£€æŸ¥èµ„é‡‘é‡Šæ”¾é‡‘é¢
   5. éªŒè¯ allocationAmount ä¸€è‡´æ€§
   ```

3. **æœŸæƒä»·æ ¼è·å–é™çº§**
   ```bash
   # æµ‹è¯•æ­¥éª¤ï¼š
   1. æ¨¡æ‹Ÿ LongPort API å¤±è´¥
   2. æ£€æŸ¥æ˜¯å¦é™çº§åˆ°æŒä»“ç¼“å­˜
   3. æ¨¡æ‹ŸæŒä»“ç¼“å­˜å¤±è´¥
   4. æ£€æŸ¥æ˜¯å¦é™çº§åˆ°å¯Œé€”è¯¦æƒ…
   5. æ£€æŸ¥ä»·æ ¼ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆ
   ```

### ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
1. **0DTEæœŸæƒäº¤æ˜“**ï¼ˆSPX/SPXWï¼‰
   - ç›‘æ§æœŸæƒé€‰æ‹©æ—¥å¿—
   - éªŒè¯0DTEåˆ°æœŸæ—¥æœŸéªŒè¯
   - éªŒè¯æ”¶ç›˜å‰30åˆ†é’Ÿå¼ºåˆ¶å¹³ä»“

2. **Greeksè¿‡æ»¤**
   - è®¾ç½® `deltaMin=0.3, deltaMax=0.7`
   - æ£€æŸ¥è¿‡æ»¤æ—¥å¿—
   - éªŒè¯é€‰ä¸­çš„æœŸæƒç¬¦åˆæ¡ä»¶

3. **èµ„é‡‘ç®¡ç†**
   - ç›‘æ§èµ„é‡‘åˆ†é…æ—¥å¿—
   - ç›‘æ§èµ„é‡‘é‡Šæ”¾æ—¥å¿—
   - éªŒè¯ allocationAmount ä¸€è‡´æ€§

---

## ğŸ“ åç»­å»ºè®®

### çŸ­æœŸæ”¹è¿›ï¼ˆ1å‘¨å†…ï¼‰
1. **è¡¥å……å•å…ƒæµ‹è¯•**ï¼ˆä¼˜å…ˆçº§ï¼šğŸ”´ é«˜ï¼‰
   - æœŸæƒä»·æ ¼ç¼“å­˜æµ‹è¯•ï¼ˆ5ä¸ªç”¨ä¾‹ï¼‰
   - èµ„é‡‘ç®¡ç†æµ‹è¯•ï¼ˆ10ä¸ªç”¨ä¾‹ï¼‰
   - Greeksè¿‡æ»¤æµ‹è¯•ï¼ˆ10ä¸ªç”¨ä¾‹ï¼‰

2. **å®Œå–„æŒ‡æ•°æ˜ å°„**ï¼ˆä¼˜å…ˆçº§ï¼šâš ï¸ ä¸­ï¼‰
   - éªŒè¯ NDX/NDXP/DJX/RUT çš„ stockId
   - è¡¥å……åˆ° `KNOWN_INDEX_STOCK_IDS`
   - ä»æ—¥å¿—ä¸­æ”¶é›†æœªæ˜ å°„æŒ‡æ•°

3. **ç›‘æ§æ—¥å¿—åˆ†æ**ï¼ˆä¼˜å…ˆçº§ï¼šâš ï¸ ä¸­ï¼‰
   - æ”¶é›†"allocationAmountç¼ºå¤±"è­¦å‘Š
   - æ”¶é›†"Greeksæ•°æ®ä¸å¯ç”¨"è­¦å‘Š
   - æ”¶é›†"0DTEæœŸæƒä¸å¯ç”¨"è­¦å‘Š

### ä¸­æœŸä¼˜åŒ–ï¼ˆ1ä¸ªæœˆå†…ï¼‰
1. **æœŸæƒä»·æ ¼æ¨é€**ï¼ˆä¼˜å…ˆçº§ï¼šğŸ“ ä½ï¼‰
   - è°ƒç ” WebSocket æ¨é€æ–¹æ¡ˆ
   - æ›¿ä»£è½®è¯¢æ–¹å¼
   - è¿›ä¸€æ­¥é™ä½APIè°ƒç”¨é¢‘ç‡

2. **Greekså®æ—¶æ›´æ–°**ï¼ˆä¼˜å…ˆçº§ï¼šğŸ“ ä½ï¼‰
   - å®ç° Greeks ç¼“å­˜
   - å®šæœŸæ›´æ–°æœºåˆ¶
   - æä¾›å®æ—¶é£é™©ç›‘æ§

3. **æœŸæƒç­–ç•¥å›æµ‹**ï¼ˆä¼˜å…ˆçº§ï¼šğŸ“ ä½ï¼‰
   - æ”¯æŒå†å²æœŸæƒæ•°æ®
   - éªŒè¯ç­–ç•¥å‚æ•°
   - ä¼˜åŒ–æ­¢ç›ˆæ­¢æŸé€»è¾‘

---

## ğŸ’¡ ä½¿ç”¨æç¤º

### æœŸæƒç­–ç•¥é…ç½®æ¨¡æ¿

#### åŸºç¡€0DTEç­–ç•¥
```json
{
  "strategyName": "SPX-0DTE-CALL",
  "strategyType": "OPTION_INTRADAY_V1",
  "symbolPool": [".SPX.US"],
  "config": {
    "assetClass": "OPTION",
    "expirationMode": "0DTE",
    "directionMode": "FOLLOW_SIGNAL",
    "positionSizing": {
      "mode": "FIXED_CONTRACTS",
      "fixedContracts": 1
    },
    "tradeWindow": {
      "noNewEntryBeforeCloseMinutes": 60,
      "forceCloseBeforeCloseMinutes": 30
    },
    "entryPriceMode": "ASK"
  },
  "capitalAllocation": {
    "allocationType": "FIXED",
    "fixedAmount": 5000
  }
}
```

#### é«˜çº§è¿‡æ»¤ç­–ç•¥
```json
{
  "config": {
    "liquidityFilters": {
      "minOpenInterest": 1000,
      "maxBidAskSpreadAbs": 1.0,
      "maxBidAskSpreadPct": 5.0
    },
    "greekFilters": {
      "deltaMin": 0.3,
      "deltaMax": 0.7,
      "thetaMaxAbs": 2.0
    }
  }
}
```

### æ—¥å¿—ç›‘æ§å…³é”®å­—

ç›‘æ§ä»¥ä¸‹æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ï¼š

```bash
# èµ„é‡‘ç®¡ç†ç›¸å…³
grep "allocationAmountç¼ºå¤±" logs/*.log
grep "optionMeta.multiplierç¼ºå¤±" logs/*.log
grep "ä½¿ç”¨fallbackè®¡ç®—" logs/*.log

# æœŸæƒé€‰æ‹©ç›¸å…³
grep "Delta æ•°æ®ä¸å¯ç”¨" logs/*.log
grep "Theta æ•°æ®ä¸å¯ç”¨" logs/*.log
grep "0DTEæœŸæƒä¸å¯ç”¨" logs/*.log

# ä»·æ ¼è·å–ç›¸å…³
grep "LongPortè¡Œæƒ…è·å–å¤±è´¥" logs/*.log
grep "å¯Œé€”è¯¦æƒ…è·å–å¤±è´¥" logs/*.log
grep "ä»å¯Œé€”è¯¦æƒ…è·å–ä»·æ ¼" logs/*.log

# æœªæ˜ å°„æŒ‡æ•°
grep "å‘ç°æœªæ˜ å°„çš„æŒ‡æ•°" logs/*.log
```

---

## âœ… ä¿®å¤éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- âœ… æœŸæƒå¼€ä»“èµ„é‡‘æ­£ç¡®é”å®šï¼ˆå«æ‰‹ç»­è´¹ï¼‰
- âœ… æœŸæƒå¹³ä»“èµ„é‡‘æ­£ç¡®é‡Šæ”¾ï¼ˆé‡‘é¢ä¸€è‡´ï¼‰
- âœ… æœŸæƒä»·æ ¼è·å–æˆåŠŸç‡ > 95%
- âœ… Greeksè¿‡æ»¤å™¨æ­£ç¡®å·¥ä½œ
- âœ… 0DTEæœŸæƒé€‰æ‹©å‡†ç¡®

### æ€§èƒ½éªŒæ”¶
- âœ… æœŸæƒä»·æ ¼ç¼“å­˜å‘½ä¸­ç‡ > 80%
- âœ… å¯Œé€”APIè°ƒç”¨é¢‘ç‡ < 10æ¬¡/åˆ†é’Ÿ
- âœ… æŒä»“ç›‘æ§å¾ªç¯å»¶è¿Ÿ < 2ç§’

### ç¨³å®šæ€§éªŒæ”¶
- âœ… æ— èµ„é‡‘æ³„æ¼/é”å®šé—®é¢˜
- âœ… æ—  Greeks ç¼ºå¤±å¯¼è‡´çš„é”™è¯¯é€‰æ‹©
- âœ… æ— å·²è¿‡æœŸæœŸæƒè¢«é€‰ä¸­
- âœ… è¯¦ç»†æ—¥å¿—å¯è¿½æº¯é—®é¢˜

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- ğŸ“„ [æœŸæƒç­–ç•¥å®Œæ•´è¯Šæ–­ä¸ä¿®å¤æ–¹æ¡ˆ](./260128-æœŸæƒç­–ç•¥å®Œæ•´è¯Šæ–­ä¸ä¿®å¤æ–¹æ¡ˆ.md)ï¼ˆè¯Šæ–­æ–‡æ¡£ï¼Œ13,000+å­—ï¼‰
- ğŸ“„ [CODE_MAP.md](../../CODE_MAP.md)ï¼ˆä»£ç åœ°å›¾ï¼ŒåŒ…å«æœŸæƒç­–ç•¥æ¨¡å—è¯´æ˜ï¼‰
- ğŸ“„ [CHANGELOG.md](../../CHANGELOG.md)ï¼ˆå˜æ›´æ—¥å¿—ï¼‰

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†æœŸæƒç­–ç•¥çš„**10ä¸ªå…³é”®é—®é¢˜**ï¼Œæ¶µç›–ï¼š
- ğŸ”´ **èµ„é‡‘ç®¡ç†**ï¼šä¿®å¤èµ„é‡‘æ³„æ¼/é”å®šé—®é¢˜
- ğŸ”´ **ä»·æ ¼è·å–**ï¼šå®ç°ä¸‰å±‚é™çº§+ç¼“å­˜æœºåˆ¶
- âš ï¸ **æœŸæƒé€‰æ‹©**ï¼šä¿®å¤Greeksè¿‡æ»¤å’Œ0DTEå¤„ç†
- âš ï¸ **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘APIè°ƒç”¨ï¼Œæå‡å“åº”é€Ÿåº¦

**ä¿®æ”¹æ–‡ä»¶**ï¼š4ä¸ªæ–‡ä»¶ä¿®æ”¹ï¼Œ1ä¸ªæ–°å¢ï¼Œå…±è®¡+238è¡Œä»£ç 
**é¢„æœŸæ•ˆæœ**ï¼šèµ„é‡‘å‡†ç¡®æ€§100%ï¼Œä»·æ ¼è·å–æˆåŠŸç‡>95%ï¼ŒAPIè°ƒç”¨å‡å°‘60%

**å»ºè®®åç»­åŠ¨ä½œ**ï¼š
1. è¡¥å……å•å…ƒæµ‹è¯•ï¼ˆ25+ç”¨ä¾‹ï¼‰
2. ç”Ÿäº§ç¯å¢ƒç›‘æ§ï¼ˆ7å¤©ï¼‰
3. æ”¶é›†æ—¥å¿—åˆ†æé—®é¢˜
4. å®Œå–„æŒ‡æ•°æ˜ å°„è¡¨

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-01-28
**ä¿®å¤è´Ÿè´£äºº**: Claude Code
**å®¡æ ¸çŠ¶æ€**: å¾…ç”¨æˆ·éªŒè¯
