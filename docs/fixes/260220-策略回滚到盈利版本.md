# 策略回滚到盈利版本(22901e7) + 保留安全修复

**日期**: 2026-02-20
**类型**: 回滚 + 修复保留
**基准版本**: 22901e7（671行简洁策略版本）

---

## 背景

98349a8 提交引入了14项修复（VWAP结构确认、价格确认、RSI过滤、动量衰减、反向策略等），导致策略过度拦截入场信号。评估后决定回滚策略核心逻辑到22901e7的简洁版本，同时保留后续新增的安全修复。

## 变更内容

### 文件1: `option-intraday-strategy.ts` (1257行 → 749行，-508行)

**删除（恢复到22901e7简洁逻辑）：**
- VWAP结构确认（要求收盘价在VWAP上/下方）
- 价格确认/连续确认周期（60s价格移动≥0.03%确认）
- RSI过滤器（超买/超卖区拦截）
- 动量衰减检测（得分从极值回归时拦截0DTE入场）
- 反向策略逻辑 + kill switch（极端得分时反向交易）
- 方向确认窗口（开盘30分钟内限制交易方向）
- LATE时段阈值提升
- 相关状态追踪Map：`scoreHistory`、`consecutiveStates`、`reverseStrategyKillSwitch`
- 移除import：`marketDataService`
- 移除配置字段：`latePeriod`、`zdteEntryThreshold`、`consecutiveConfirmCycles`、`rsiFilter`、`directionConfirmMinutes`

**保留的安全修复：**
- ✅ Greeks不可用检查（合约选择后检查 `selected.greeksUnavailable`）
- ✅ `entryThresholdOverride` 支持（前端风险预设系统需要）
- ✅ `skip0DTE` 参数传递给合约选择器
- ✅ 0DTE冷却窗口配置（`zdteCooldownMinutes`）
- ✅ 非交易时间日志节流（每标的每5分钟）
- ✅ 市场数据不可用降级为warn（区分基础设施问题和策略错误）

### 文件2: `option-recommendation.service.ts`

**评分权重恢复到22901e7版本：**

| 组件 | 回滚前 | 回滚后 |
|------|--------|--------|
| **finalScore** | `market*0.5 + intraday*0.5 + time*0.15` | `market*0.4 + intraday*0.4 + time*0.2` |
| **大盘评分** | SPX当日涨跌(35%) + SPX趋势(15%) + USD(15%) + BTC(15%) + VIX + 温度 | SPX趋势(40%) + USD(20%) + BTC(20%) + VIX(10%) + 温度(10%) |
| **分时评分** | SPX日内实体强度(40%) + BTC时K(30%) + USD时K(15%) + SPX3日趋势(15%) | BTC时K(40%) + USD时K(20%) + SPX近5日动量(40%) |
| **趋势分析** | 偏离MA20×30 + 线性MA偏离加成 | 偏离MA20×10 + 二元±20加成 |
| **动量计算** | 累计变化率×3000×一致性 | 平均变化率×1000 |

**保留：**
- `calculateRSI14()` 方法（不调用但其他地方可能用到）
- 评分明细日志（有助排查）

### 不修改的文件

- `strategy-scheduler.service.ts` — TSLPPCT逻辑完整，`updateReverseStrategyKillSwitch` 调用有 `typeof` 安全守卫
- `trailing-stop-protection.service.ts` — TSLPPCT逻辑正确
- `option-dynamic-exit.service.ts` — 软件侧止盈止损逻辑正确

## 验证

- `npx tsc --noEmit` 无新增编译错误
- scheduler 中 `updateReverseStrategyKillSwitch` 使用 `typeof` 守卫，方法移除后不会报错
- TSLPPCT 调用路径不受影响
