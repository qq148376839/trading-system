# Dockeré…ç½®è¯Šæ–­ä¸æ¸…ç†æŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-30
**çŠ¶æ€**: âœ… å·²å®Œæˆ
**å½±å“èŒƒå›´**: Dockeréƒ¨ç½²æ¶æ„ä¼˜åŒ–

---

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

é¡¹ç›®ä¸­çš„Dockeré…ç½®å­˜åœ¨å¤šä¸ªé—®é¢˜ï¼š
1. APIå¼€å‘ç¯å¢ƒä½¿ç”¨äº†ä¸å…¼å®¹çš„AlpineåŸºç¡€é•œåƒ
2. åŒ…ç®¡ç†å™¨é…ç½®æ··ä¹±ï¼ˆåŒæ—¶ä½¿ç”¨pnpmå’Œnpmï¼‰
3. æ ¹ç›®å½•å­˜åœ¨å¤šä½™çš„.dockerignoreæ–‡ä»¶

---

## ğŸ” é—®é¢˜è¯Šæ–­

### 1. Dockeræ–‡ä»¶ç»“æ„åˆ†æ

**åŸå§‹ç»“æ„:**
```
trading-system/
â”œâ”€â”€ docker-compose.yml          # ç”Ÿäº§ç¯å¢ƒç¼–æ’
â”œâ”€â”€ docker-compose.dev.yml      # å¼€å‘ç¯å¢ƒç¼–æ’
â”œâ”€â”€ .dockerignore               # âŒ å¤šä½™æ–‡ä»¶ï¼ˆå·²åˆ é™¤ï¼‰
â”‚
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ Dockerfile              # APIç”Ÿäº§é•œåƒ
â”‚   â”œâ”€â”€ Dockerfile.dev          # APIå¼€å‘é•œåƒ
â”‚   â”œâ”€â”€ .dockerignore           # âœ… æœ‰æ•ˆ
â”‚   â”œâ”€â”€ package-lock.json       # æœ€æ–°ï¼ˆ2026-01-26ï¼‰
â”‚   â””â”€â”€ pnpm-lock.yaml          # æ—§æ–‡ä»¶ï¼ˆ2025-12-19ï¼‰
â”‚
â””â”€â”€ frontend/
    â”œâ”€â”€ Dockerfile              # Frontendç”Ÿäº§é•œåƒ
    â”œâ”€â”€ Dockerfile.dev          # Frontendå¼€å‘é•œåƒ
    â”œâ”€â”€ .dockerignore           # âœ… æœ‰æ•ˆ
    â”œâ”€â”€ package-lock.json       # æœ€æ–°ï¼ˆ2026-01-20ï¼‰
    â””â”€â”€ pnpm-lock.yaml          # æ—§æ–‡ä»¶ï¼ˆ2025-12-16ï¼‰
```

### 2. å…·ä½“é—®é¢˜åˆ†æ

#### é—®é¢˜ 1: API Dockerfile.dev ä½¿ç”¨ä¸å…¼å®¹çš„åŸºç¡€é•œåƒ âš ï¸ CRITICAL

**ä½ç½®**: `api/Dockerfile.dev:2`

```dockerfile
# âŒ é”™è¯¯é…ç½®
FROM node:20-alpine
```

**é—®é¢˜åŸå› :**
- ç”Ÿäº§ç¯å¢ƒ(`api/Dockerfile`)ä½¿ç”¨ `node:20` (Debian/glibc)
- å¼€å‘ç¯å¢ƒä½¿ç”¨ `node:20-alpine` (musl libc)
- **longport SDK ä¾èµ– glibc**ï¼ŒAlpine ä¸æ”¯æŒ musl libc
- è¿™ä¼šå¯¼è‡´å¼€å‘ç¯å¢ƒå®Œå…¨æ— æ³•è¿è¡Œ longport ç›¸å…³åŠŸèƒ½

**å½±å“:**
- å¼€å‘ç¯å¢ƒæ— æ³•å¯åŠ¨
- å¼€å‘ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´ï¼Œå¯èƒ½å¯¼è‡´"å¼€å‘æ­£å¸¸ä½†ç”Ÿäº§å¤±è´¥"

---

#### é—®é¢˜ 2: APIç”Ÿäº§DockerfileåŒ…ç®¡ç†å™¨æ··ä¹±

**ä½ç½®**: `api/Dockerfile`

```dockerfile
# âŒ æ··ä¹±çš„é…ç½®
RUN npm install -g pnpm                         # å®‰è£…pnpm
COPY package.json pnpm-lock.yaml* ...           # å¤åˆ¶pnpmé”æ–‡ä»¶
RUN pnpm install --frozen-lockfile              # ä½¿ç”¨pnpmå®‰è£…
RUN pnpm run build                              # ä½¿ç”¨pnpmæ„å»º
CMD ["pnpm", "start"]                           # ä½¿ç”¨pnpmå¯åŠ¨
```

**é—®é¢˜åŸå› :**
- Dockerfile é…ç½®ä½¿ç”¨ pnpm
- ä½†å®é™…é¡¹ç›®ä½¿ç”¨ npmï¼ˆpackage-lock.jsonæ›´æ–°ï¼Œpnpm-lock.yamlè¿‡æ—¶ï¼‰
- å¯¼è‡´ä¸å¿…è¦çš„pnpmå®‰è£…å¼€é”€

**å½±å“:**
- é•œåƒä½“ç§¯å¢å¤§ï¼ˆå¤šå®‰è£…äº†pnpmï¼‰
- æ„å»ºæ—¶é—´å¢åŠ 
- é…ç½®ä¸ä¸€è‡´å¯èƒ½å¯¼è‡´ä¾èµ–é—®é¢˜

---

#### é—®é¢˜ 3: Frontend Dockerfile åŒ…ç®¡ç†å™¨æ£€æµ‹é€»è¾‘è¿‡äºå¤æ‚

**ä½ç½®**: `frontend/Dockerfile:19-40`

```dockerfile
# âŒ è¿‡äºå¤æ‚çš„é€»è¾‘
RUN if [ -f pnpm-lock.yaml ]; then \
      pnpm install --frozen-lockfile; \
    elif [ -f package-lock.json ]; then \
      npm ci; \
    else \
      echo "Warning: No lock file found, using pnpm install"; \
      pnpm install; \
    fi
```

**é—®é¢˜åŸå› :**
- é¡¹ç›®å·²ç»æ˜ç¡®ä½¿ç”¨ npm
- ä¸éœ€è¦å¤æ‚çš„åŒ…ç®¡ç†å™¨æ£€æµ‹é€»è¾‘

**å½±å“:**
- Dockerfile å¯è¯»æ€§å·®
- ç»´æŠ¤æˆæœ¬é«˜

---

#### é—®é¢˜ 4: æ ¹ç›®å½• .dockerignore å¤šä½™

**ä½ç½®**: `D:\Python\trading-system\.dockerignore`

**é—®é¢˜åŸå› :**
- `docker-compose.yml` ä¸­çš„æ„å»ºä¸Šä¸‹æ–‡æ˜¯ `./api` å’Œ `./frontend`
- Docker ä¼šä½¿ç”¨å­ç›®å½•ä¸­çš„ `.dockerignore`
- æ ¹ç›®å½•çš„ `.dockerignore` ä¸ä¼šè¢«ä½¿ç”¨

**å½±å“:**
- æ–‡ä»¶å†—ä½™ï¼Œé€ æˆæ··æ·†
- å¯èƒ½è¯¯å¯¼å¼€å‘è€…

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: API Dockerfile.dev åŸºç¡€é•œåƒ âœ…

**æ–‡ä»¶**: `api/Dockerfile.dev`

```dockerfile
# âœ… ä¿®å¤å
FROM node:20

# å®‰è£… curl ç”¨äºå¥åº·æ£€æŸ¥ï¼ˆDebian é•œåƒå·²åŒ…å«ï¼‰
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl && \
    rm -rf /var/lib/apt/lists/*
```

**ä¿®å¤å†…å®¹:**
- ä» `node:20-alpine` æ”¹ä¸º `node:20`
- æ·»åŠ æ³¨é‡Šè¯´æ˜ longport SDK éœ€è¦ glibc
- ä½¿ç”¨ apt-get å®‰è£… curlï¼ˆDebian åŒ…ç®¡ç†å™¨ï¼‰

**æ•ˆæœ:**
- âœ… å¼€å‘ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒåŸºç¡€é•œåƒä¸€è‡´
- âœ… longport SDK å¯æ­£å¸¸è¿è¡Œ
- âœ… é¿å…å¼€å‘/ç”Ÿäº§ç¯å¢ƒå·®å¼‚

---

### ä¿®å¤ 2: APIç”Ÿäº§Dockerfileç»Ÿä¸€ä½¿ç”¨npm âœ…

**æ–‡ä»¶**: `api/Dockerfile`

```dockerfile
# âœ… ä¿®å¤å
# å¤åˆ¶ package.json å’Œ package-lock.json
COPY package.json package-lock.json ./

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependenciesï¼Œç”¨äºæ„å»ºï¼‰
RUN npm ci

# æ„å»º TypeScript ä»£ç 
RUN npm run build

# å¯åŠ¨æœåŠ¡
CMD ["npm", "start"]
```

**ä¿®å¤å†…å®¹:**
- ç§»é™¤ pnpm å®‰è£…
- ç»Ÿä¸€ä½¿ç”¨ npm
- ä½¿ç”¨ `npm ci` è¿›è¡Œå¹²å‡€å®‰è£…

**æ•ˆæœ:**
- âœ… å‡å°‘é•œåƒä½“ç§¯ï¼ˆä¸å®‰è£…pnpmï¼‰
- âœ… åŠ å¿«æ„å»ºé€Ÿåº¦
- âœ… é…ç½®æ¸…æ™°ä¸€è‡´

---

### ä¿®å¤ 3: Frontend Dockerfileç®€åŒ– âœ…

**æ–‡ä»¶**: `frontend/Dockerfile`

```dockerfile
# âœ… ä¿®å¤å
# å¤åˆ¶ package.json å’Œ package-lock.json
COPY package.json package-lock.json ./

# å®‰è£…ä¾èµ–
RUN npm ci

# æ„å»º Next.js åº”ç”¨ï¼ˆæ­¤æ—¶ NEXT_PUBLIC_API_URL å·²å¯ç”¨ï¼‰
RUN npm run build
```

**ä¿®å¤å†…å®¹:**
- ç§»é™¤å¤æ‚çš„åŒ…ç®¡ç†å™¨æ£€æµ‹é€»è¾‘
- ç§»é™¤ pnpm ç›¸å…³ä»£ç 
- ç›´æ¥ä½¿ç”¨ npm

**æ•ˆæœ:**
- âœ… Dockerfile æ›´æ˜“è¯»
- âœ… é™ä½ç»´æŠ¤æˆæœ¬
- âœ… æ„å»ºè¿‡ç¨‹æ›´å¯é¢„æµ‹

---

### ä¿®å¤ 4: åˆ é™¤æ ¹ç›®å½•.dockerignore âœ…

**æ“ä½œ**: åˆ é™¤ `D:\Python\trading-system\.dockerignore`

**æ•ˆæœ:**
- âœ… æ¸…ç†å†—ä½™æ–‡ä»¶
- âœ… é¿å…æ··æ·†

---

## ğŸ“Š ä¿®å¤å¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **APIåŸºç¡€é•œåƒ** | Dev: Alpine, Prod: Debian | âœ… ç»Ÿä¸€ä½¿ç”¨ Debian |
| **åŒ…ç®¡ç†å™¨** | æ··ç”¨ pnpm/npm | âœ… ç»Ÿä¸€ä½¿ç”¨ npm |
| **Dockerfileå¤æ‚åº¦** | é«˜ï¼ˆæ¡ä»¶åˆ¤æ–­å¤šï¼‰ | âœ… ä½ï¼ˆç›´æ¥æ˜ç¡®ï¼‰ |
| **é•œåƒä½“ç§¯** | è¾ƒå¤§ï¼ˆå¤šä½™pnpmï¼‰ | âœ… ç²¾ç®€ |
| **æ„å»ºæ—¶é—´** | è¾ƒé•¿ | âœ… ç¼©çŸ­ |
| **é…ç½®æ–‡ä»¶æ•°é‡** | 7ä¸ªDockerç›¸å…³æ–‡ä»¶ | âœ… 6ä¸ªï¼ˆåˆ é™¤1ä¸ªå†—ä½™ï¼‰ |

---

## ğŸ¯ æœ€ç»ˆæ¶æ„

### ä¼˜åŒ–åçš„Dockeræ¶æ„

```
trading-system/
â”œâ”€â”€ docker-compose.yml              # ç”Ÿäº§ç¯å¢ƒç¼–æ’
â”œâ”€â”€ docker-compose.dev.yml          # å¼€å‘ç¯å¢ƒç¼–æ’
â”‚
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ Dockerfile                  # âœ… node:20 + npm
â”‚   â”œâ”€â”€ Dockerfile.dev              # âœ… node:20 + npm (ä¸ç”Ÿäº§ä¸€è‡´)
â”‚   â”œâ”€â”€ .dockerignore
â”‚   â””â”€â”€ package-lock.json           # âœ… å”¯ä¸€é”æ–‡ä»¶
â”‚
â””â”€â”€ frontend/
    â”œâ”€â”€ Dockerfile                  # âœ… node:20-alpine + npm
    â”œâ”€â”€ Dockerfile.dev              # âœ… node:20-alpine + npm
    â”œâ”€â”€ .dockerignore
    â””â”€â”€ package-lock.json           # âœ… å”¯ä¸€é”æ–‡ä»¶
```

### æ¶æ„ä¼˜åŠ¿

1. **ä¸€è‡´æ€§**: å¼€å‘/ç”Ÿäº§ç¯å¢ƒåŸºç¡€é•œåƒä¸€è‡´ï¼ˆAPIéƒ½ç”¨Debianï¼‰
2. **ç®€æ´æ€§**: ç§»é™¤ä¸å¿…è¦çš„åŒ…ç®¡ç†å™¨æ£€æµ‹é€»è¾‘
3. **å¯ç»´æŠ¤æ€§**: é…ç½®æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹
4. **æ€§èƒ½**: é•œåƒä½“ç§¯æ›´å°ï¼Œæ„å»ºé€Ÿåº¦æ›´å¿«

---

## ğŸ”§ åç»­å»ºè®®

### 1. æ¸…ç†è¿‡æ—¶çš„pnpmé”æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

å¦‚æœç¡®è®¤ä¸å†ä½¿ç”¨pnpmï¼Œå¯åˆ é™¤ï¼š
```bash
rm api/pnpm-lock.yaml
rm frontend/pnpm-lock.yaml
```

### 2. éªŒè¯Dockeræ„å»º

å»ºè®®æµ‹è¯•æ‰€æœ‰Dockeré…ç½®ï¼š

```bash
# æµ‹è¯•å¼€å‘ç¯å¢ƒæ„å»º
docker-compose -f docker-compose.dev.yml build

# æµ‹è¯•ç”Ÿäº§ç¯å¢ƒæ„å»º
docker-compose build

# æµ‹è¯•è¿è¡Œ
docker-compose up -d
```

### 3. æ›´æ–°CI/CDé…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰

å¦‚æœé¡¹ç›®æœ‰CI/CDé…ç½®ä½¿ç”¨pnpmï¼Œéœ€è¦åŒæ­¥æ›´æ–°ä¸ºnpmã€‚

### 4. æ›´æ–°æ–‡æ¡£

æ›´æ–°éƒ¨ç½²ç›¸å…³æ–‡æ¡£ï¼Œè¯´æ˜å½“å‰ä½¿ç”¨npmä½œä¸ºåŒ…ç®¡ç†å™¨ã€‚

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–è§£å†³äº†Dockeré…ç½®ä¸­çš„4ä¸ªå…³é”®é—®é¢˜ï¼š

1. âœ… **ä¿®å¤APIå¼€å‘ç¯å¢ƒä¸å…¼å®¹é—®é¢˜** - ä»Alpineæ”¹ä¸ºDebianï¼Œç¡®ä¿longport SDKæ­£å¸¸è¿è¡Œ
2. âœ… **ç»Ÿä¸€åŒ…ç®¡ç†å™¨é…ç½®** - å…¨éƒ¨ä½¿ç”¨npmï¼Œæ¸…ç†pnpmç›¸å…³é…ç½®
3. âœ… **ç®€åŒ–Dockerfileé€»è¾‘** - ç§»é™¤å¤æ‚çš„æ¡ä»¶åˆ¤æ–­ï¼Œæé«˜å¯è¯»æ€§
4. âœ… **æ¸…ç†å†—ä½™æ–‡ä»¶** - åˆ é™¤æ ¹ç›®å½•å¤šä½™çš„.dockerignore

è¿™äº›ä¿®å¤ç¡®ä¿äº†ï¼š
- å¼€å‘ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒä¸€è‡´æ€§
- é…ç½®æ¸…æ™°ã€æ˜“äºç»´æŠ¤
- é•œåƒä½“ç§¯æ›´å°ã€æ„å»ºé€Ÿåº¦æ›´å¿«
- é¿å…æ½œåœ¨çš„éƒ¨ç½²é—®é¢˜

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-01-30
**å½±å“æ–‡ä»¶æ•°**: 4ä¸ª
**åˆ é™¤å†—ä½™æ–‡ä»¶**: 1ä¸ª
**æµ‹è¯•çŠ¶æ€**: å¾…éªŒè¯
