# 止盈止损配置生效修复

**日期**: 2026-02-12
**类型**: Bug Fix
**状态**: ✅ 已完成

---

## 问题描述

用户在创建/编辑策略时可通过 UI 配置 `takeProfitPercent`（止盈%）和 `stopLossPercent`（止损%），但这两个参数从未在实际交易退出逻辑中生效。

### 根因

`option-dynamic-exit.service.ts` 的 `getDynamicExitParams()` 方法完全使用硬编码的 `BUYER_PARAMS[phase]` 作为基础参数，从不读取策略配置的 `exitRules`。

**调用链**:
```
strategy-scheduler.service.ts → processOptionDynamicExit()
  → optionDynamicExitService.checkExitCondition(positionCtx)
    → getDynamicExitParams(ctx)
      → BUYER_PARAMS[phase]  // 硬编码，忽略用户配置
```

### 硬编码值 vs 用户配置

| Phase | 硬编码 TP | 硬编码 SL | 用户配置 | 状态 |
|-------|:---------:|:---------:|:--------:|------|
| EARLY | 50% | 35% | exitRules.takeProfitPercent / stopLossPercent | ❌ 被忽略 |
| MID   | 40% | 30% | — | — |
| LATE  | 30% | 25% | — | — |
| FINAL | 20% | 20% | — | — |

---

## 修复方案

### 设计思路

用户配置的 `takeProfitPercent` / `stopLossPercent` 作为 **EARLY 阶段的基准值**，随时间阶段按原始比例递减（保留现有的时间衰减逻辑）。IV、价格行为等动态调整照旧生效。

**比例缩放公式**:
- `actualTP = userTP × (phaseTP / EARLY_TP_DEFAULT)`
- `actualSL = userSL × (phaseSL / EARLY_SL_DEFAULT)`

**示例**（用户设 TP=60, SL=40）:

| Phase | TP | SL |
|-------|:--:|:--:|
| EARLY | 60 | 40 |
| MID   | 48 (60×40/50) | 34 (40×30/35) |
| LATE  | 36 (60×30/50) | 29 (40×25/35) |
| FINAL | 24 (60×20/50) | 23 (40×20/35) |

### 向后兼容

未配置 `exitRules` 的旧策略行为不变，继续使用原始硬编码参数表。

---

## 修改文件

### 1. `api/src/services/option-dynamic-exit.service.ts`

- **新增 `ExitRulesOverride` 接口** — 定义可选的 `takeProfitPercent` 和 `stopLossPercent`
- **修改 `getDynamicExitParams()`** — 新增可选参数 `exitRulesOverride`，在获取硬编码基础参数后按比例缩放
- **修改 `checkExitCondition()`** — 新增可选参数 `exitRulesOverride`，透传给 `getDynamicExitParams()`

### 2. `api/src/services/strategy-scheduler.service.ts`

- **`processOptionDynamicExit()`** — 从 `strategyConfig.exitRules` 提取用户配置，构建 `exitRulesOverride` 传给 `checkExitCondition()` 和 `getDynamicExitParams()`

---

## 配置审计总结

| 配置项 | UI可配 | 实际生效 | 状态 |
|--------|:------:|:-------:|------|
| `riskPreference` | ✓ | ✓ | ✅ 正常（控制入场信号门槛） |
| `strategyTypes` | ✓ | ✓ | ✅ 正常 |
| `takeProfitPercent` | ✓ | ✓ | ✅ **本次修复** |
| `stopLossPercent` | ✓ | ✓ | ✅ **本次修复** |
| `firstHourOnly` | ✓ | ✓ | ✅ 正常 |
| `expirationMode` | ✓ | ✓ | ✅ 正常 |
| `entryPriceMode` | ✓ | ✓ | ✅ 正常 |
| `positionSizing` | ✓ | ✓ | ✅ 正常 |
| `noNewEntryBeforeCloseMinutes` | ✓ | 部分 | ⚠️ 后续修订 |
| `forceCloseBeforeCloseMinutes` | ✗ | 硬编码30 | ⚠️ 后续修订 |
| 0DTE强平时间 | ✗ | 硬编码210 | ⚠️ 后续修订 |

---

## 验证方法

```bash
# TypeScript 编译检查
cd api && npx tsc --noEmit
```

功能验证（下次交易日观察日志）:
- [ ] 创建策略时设置 TP=60%, SL=40%
- [ ] 日志中 `dynamicParams` 显示 EARLY 阶段 TP=60, SL=40（而非硬编码 50/35）
- [ ] MID 阶段 TP 缩放为 ~48, SL 缩放为 ~34
- [ ] IV、价格行为调整仍正常叠加
- [ ] 未配置 exitRules 的旧策略行为不变
