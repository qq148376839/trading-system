# æœŸæƒç­–ç•¥10æœªç”Ÿæ•ˆé—®é¢˜è¯Šæ–­ä¸ä¿®å¤

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**ç­–ç•¥ID**: 10
**ç­–ç•¥åç§°**: 5000åˆ€æœŸæƒ
**ç­–ç•¥ç±»å‹**: OPTION_INTRADAY_V1ï¼ˆæœŸæƒæ—¥å†…ç­–ç•¥ï¼‰
**é—®é¢˜**: ç­–ç•¥æ‰§è¡Œ390æ¬¡ï¼Œä½†æ²¡æœ‰ç”Ÿæˆä»»ä½•ä¿¡å·å’Œè®¢å•ï¼Œæ— æŒä»“è®°å½•
**å‘ç°æ—¶é—´**: 2026-01-27
**ä¿®å¤æ—¶é—´**: 2026-01-27

## ğŸ” é—®é¢˜è¯Šæ–­

### æ—¥å¿—åˆ†æï¼ˆæ¥è‡ªlogs-analysis-dashboard.htmlï¼‰

ä»æ—¥å¿—åˆ†æçœ‹æ¿å‘ç°ï¼š
- **æ‰§è¡Œæ¬¡æ•°**: 390æ¬¡
- **IDLEæ ‡çš„**: 1ä¸ª
- **æŒä»“æ ‡çš„**: 0ä¸ª
- **é”™è¯¯æ¬¡æ•°**: 46ä¸ª
- **è­¦å‘Šæ¬¡æ•°**: 0ä¸ª
- **æœ€åæ‰§è¡Œ**: 2026-01-26T14:30:08

### æ•°æ®åº“æ£€æŸ¥

1. **Strategy Configuration** âœ…
   ```json
   {
     "id": 10,
     "name": "5000åˆ€æœŸæƒ",
     "type": "OPTION_INTRADAY_V1",
     "symbol_pool_config": {
       "mode": "STATIC",
       "symbols": ["QQQ.US"]
     },
     "status": "RUNNING"
   }
   ```

2. **Strategy Instances** âŒ
   ```sql
   SELECT * FROM strategy_instances WHERE strategy_id = 10;
   -- Result: 0 rows (âŒ æ²¡æœ‰ä»»ä½•å®ä¾‹è®°å½•ï¼)
   ```

3. **Strategy Signals** âŒ
   ```sql
   SELECT * FROM strategy_signals WHERE strategy_id = 10
     AND created_at >= NOW() - INTERVAL '2 days';
   -- Result: 0 rows (âŒ æ²¡æœ‰ç”Ÿæˆä»»ä½•ä¿¡å·ï¼)
   ```

4. **Execution Orders** âŒ
   ```sql
   SELECT * FROM execution_orders WHERE strategy_id = 10
     AND created_at >= NOW() - INTERVAL '2 days';
   -- Result: 0 rows (âŒ æ²¡æœ‰æäº¤ä»»ä½•è®¢å•ï¼)
   ```

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜é“¾æ¡

```
ç­–ç•¥å¯åŠ¨
  â†“
runStrategyCycle() è·å–æ ‡çš„æ±  â†’ [QQQ.US]
  â†“
processSymbol(QQQ.US)
  â†“
getCurrentState() â†’ æŸ¥è¯¢strategy_instancesè¡¨ â†’ âŒ æ²¡æœ‰è®°å½• â†’ è¿”å›'IDLE'
  â†“
ç”Ÿæˆä¿¡å·: generateSignal(QQQ.US)
  â†“
calculateRecommendation(QQQ.US) â†’ âŒ è¿”å›HOLDæˆ–null
  â†“
generateSignal() â†’ âŒ è¿”å›null
  â†“
processSymbol() â†’ âŒ ç›´æ¥returnï¼Œæœªè°ƒç”¨updateStateåˆ›å»ºå®ä¾‹
  â†“
ç»“æœï¼šå®ä¾‹ä»æœªè¢«åˆ›å»ºåˆ°æ•°æ®åº“ï¼Œç­–ç•¥æ— æ³•ç”Ÿæ•ˆ
```

### æ ¹æœ¬åŸå› 

**ç­–ç•¥å®ä¾‹ä»æœªè¢«åˆ›å»ºåˆ°æ•°æ®åº“**ï¼

è¿™æ˜¯ä¸€ä¸ªé¸¡å’Œè›‹çš„é—®é¢˜ï¼š
1. `strategy_instances` è¡¨é€šè¿‡ `updateState()` çš„ `UPSERT` æ“ä½œåˆ›å»º
2. ä½† `updateState()` åªæœ‰åœ¨ä¿¡å·ç”ŸæˆæˆåŠŸåæ‰ä¼šè¢«è°ƒç”¨
3. å¦‚æœä¿¡å·ç”Ÿæˆå¤±è´¥ï¼ˆè¿”å›nullï¼‰ï¼Œå°±æ°¸è¿œä¸ä¼šåˆ›å»ºå®ä¾‹
4. æ²¡æœ‰å®ä¾‹ï¼Œç­–ç•¥å°±æ— æ³•è·Ÿè¸ªçŠ¶æ€å’Œæ‰§è¡Œäº¤æ˜“

### ä¸ºä»€ä¹ˆä¿¡å·è¿”å›nullï¼Ÿ

æ ¹æ® `option-intraday-strategy.ts:62-88`ï¼Œä¿¡å·ç”Ÿæˆå¯èƒ½åœ¨ä»¥ä¸‹æƒ…å†µè¿”å›nullï¼š

1. **æ¨èæœåŠ¡è¿”å›HOLDæˆ–null** (æœ€å¯èƒ½)
   ```typescript
   const rec = await tradingRecommendationService.calculateRecommendation(symbol);
   if (!rec || rec.action === 'HOLD') return null;  // â† è¿™é‡Œï¼
   ```

2. **æœŸæƒåˆçº¦é€‰æ‹©å¤±è´¥**
   ```typescript
   const selected = await selectOptionContract({...});
   if (!selected) return null;  // æµåŠ¨æ€§/Greekè¿‡æ»¤å¤ªä¸¥æ ¼
   ```

3. **Premiumè®¡ç®—å¤±è´¥**
   ```typescript
   const premium = entryPriceMode === 'MID' ? ...;
   if (!premium || premium <= 0) return null;
   ```

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¸´æ—¶ä¿®å¤ï¼ˆå·²æ‰§è¡Œï¼‰âœ…

**æ‰‹åŠ¨åˆå§‹åŒ–ç­–ç•¥å®ä¾‹**

æ‰§è¡Œè„šæœ¬ `quick-fix-strategy-10.js`ï¼Œæ‰‹åŠ¨åˆ›å»ºäº†QQQ.USçš„IDLEå®ä¾‹ï¼š

```sql
INSERT INTO strategy_instances (strategy_id, symbol, current_state, context, last_updated)
VALUES (10, 'QQQ.US', 'IDLE', null, NOW());
```

**ç»“æœ**ï¼š
- âœ… å®ä¾‹å·²åˆ›å»º
- âœ… ç­–ç•¥ç°åœ¨å¯ä»¥å¤„ç†QQQ.US
- âš ï¸  ä½†ä»éœ€è§£å†³ä¿¡å·ç”Ÿæˆé—®é¢˜

### æ ¹æœ¬æ€§ä¿®å¤æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: æ”¾å®½è¿‡æ»¤æ¡ä»¶ï¼ˆæ¨èï¼‰â­

**é—®é¢˜**: è¿‡æ»¤æ¡ä»¶å¯èƒ½å¤ªä¸¥æ ¼ï¼Œå¯¼è‡´æ‰¾ä¸åˆ°åˆé€‚çš„æœŸæƒåˆçº¦

**å½“å‰é…ç½®**:
```json
{
  "liquidityFilters": {
    "minOpenInterest": 500,        // â† å¯èƒ½å¤ªé«˜
    "maxBidAskSpreadAbs": 0.3,
    "maxBidAskSpreadPct": 25
  },
  "greekFilters": {
    "deltaMin": 0.25,
    "deltaMax": 0.6                 // â† èŒƒå›´å¯èƒ½å¤ªçª„
  }
}
```

**ä¿®å¤SQL**:
```sql
-- æ”¾å®½æµåŠ¨æ€§è¿‡æ»¤
UPDATE strategies SET config = jsonb_set(
  jsonb_set(
    config,
    '{liquidityFilters,minOpenInterest}',
    '100'
  ),
  '{liquidityFilters,maxBidAskSpreadPct}',
  '50'
) WHERE id = 10;

-- æ”¾å®½Greekè¿‡æ»¤
UPDATE strategies SET config = jsonb_set(
  jsonb_set(
    config,
    '{greekFilters,deltaMin}',
    '0.15'
  ),
  '{greekFilters,deltaMax}',
    '0.75'
) WHERE id = 10;
```

#### æ–¹æ¡ˆ2: å¼ºåˆ¶æ–¹å‘ï¼ˆä¸´æ—¶workaroundï¼‰

**é—®é¢˜**: æ¨èæœåŠ¡è¿”å›HOLDï¼Œå¯¼è‡´ä¸ç”Ÿæˆä¿¡å·

**ä¿®å¤**: å°† `directionMode` æ”¹ä¸º `CALL_ONLY`ï¼Œç»•è¿‡æ¨èæœåŠ¡

```sql
UPDATE strategies
SET config = jsonb_set(config, '{directionMode}', '"CALL_ONLY"')
WHERE id = 10;
```

**æ³¨æ„**: è¿™ä¼šè®©ç­–ç•¥æ€»æ˜¯ä¹°å…¥CALLæœŸæƒï¼Œä¸ç®¡å¸‚åœºæ–¹å‘

#### æ–¹æ¡ˆ3: æ¶æ„æ”¹è¿›ï¼ˆé•¿æœŸï¼‰

**é—®é¢˜**: ç­–ç•¥å®ä¾‹åˆå§‹åŒ–ä¾èµ–ä¿¡å·ç”Ÿæˆï¼Œå¯¼è‡´å†·å¯åŠ¨é—®é¢˜

**å»ºè®®**:
1. åœ¨ç­–ç•¥å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–æ‰€æœ‰æ ‡çš„æ± çš„å®ä¾‹
2. ä¿®æ”¹ `startStrategy()` æ–¹æ³•ï¼š

```typescript
// api/src/services/strategy-scheduler.service.ts
async startStrategy(strategyId: number): Promise<void> {
  // ... existing code ...

  // âœ… æ–°å¢ï¼šåˆå§‹åŒ–æ ‡çš„æ± å®ä¾‹
  const symbols = await stockSelector.getSymbolPool(strategy.symbol_pool_config);
  for (const symbol of symbols) {
    // ç¡®ä¿å®ä¾‹å­˜åœ¨
    const existing = await stateManager.getInstanceState(strategyId, symbol);
    if (!existing) {
      await stateManager.updateState(strategyId, symbol, 'IDLE', null);
      logger.log(`åˆå§‹åŒ–ç­–ç•¥ ${strategyId} çš„å®ä¾‹: ${symbol}`);
    }
  }

  // ... continue with interval setup ...
}
```

## ğŸ“Š éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥å®ä¾‹å·²åˆ›å»º

```sql
SELECT symbol, current_state, last_updated
FROM strategy_instances
WHERE strategy_id = 10;
```

**é¢„æœŸç»“æœ**:
```
 symbol  | current_state |      last_updated
---------+---------------+------------------------
 QQQ.US  | IDLE          | 2026-01-27 18:11:23+08
```

### 2. ç›‘æ§ä¿¡å·ç”Ÿæˆ

ç­‰å¾…ç­–ç•¥ä¸‹ä¸€æ¬¡æ‰§è¡Œï¼ˆæ¯60ç§’ï¼‰ï¼Œç„¶åæ£€æŸ¥ï¼š

```sql
SELECT id, symbol, signal_type, price, reason, created_at
FROM strategy_signals
WHERE strategy_id = 10
ORDER BY created_at DESC
LIMIT 10;
```

**é¢„æœŸ**: åº”è¯¥æœ‰æ–°ä¿¡å·ç”Ÿæˆ

### 3. ç›‘æ§è®¢å•æäº¤

```sql
SELECT id, symbol, side, quantity, price, current_status, created_at
FROM execution_orders
WHERE strategy_id = 10
ORDER BY created_at DESC
LIMIT 10;
```

**é¢„æœŸ**: å¦‚æœä¿¡å·ç”ŸæˆæˆåŠŸï¼Œåº”è¯¥æœ‰è®¢å•æäº¤

### 4. æŸ¥çœ‹æ—¥å¿—

æŸ¥çœ‹å®æ—¶æ—¥å¿—è¾“å‡ºï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
[2026-01-27T18:15:00.000Z] ç­–ç•¥ 10 æ ‡çš„ QQQ.US: ç”Ÿæˆä¿¡å· BUY, ä»·æ ¼=2.50, åŸå› =æœŸæƒå¼€ä»“(CALL)...
```

## ğŸ› å¯èƒ½ä»å­˜åœ¨çš„é—®é¢˜

å³ä½¿å®ä¾‹å·²åˆ›å»ºï¼Œç­–ç•¥å¯èƒ½ä»æ— æ³•ç”Ÿæˆä¿¡å·ï¼ŒåŸå› å¯èƒ½æ˜¯ï¼š

### é—®é¢˜A: æ¨èæœåŠ¡è¿”å›HOLD

**æ£€æŸ¥æ–¹æ³•**:
```javascript
const rec = await tradingRecommendationService.calculateRecommendation('QQQ.US');
console.log('Recommendation:', rec ? rec.action : 'null');
```

**è§£å†³**:
- ä½¿ç”¨æ–¹æ¡ˆ2ï¼ˆCALL_ONLYæ¨¡å¼ï¼‰
- æˆ–ä¼˜åŒ–æ¨èæœåŠ¡é€»è¾‘

### é—®é¢˜B: 0DTEæœŸæƒä¸å­˜åœ¨

**æ£€æŸ¥æ–¹æ³•**:
```javascript
const selected = await selectOptionContract({
  underlyingSymbol: 'QQQ.US',
  expirationMode: '0DTE',
  direction: 'CALL',
  candidateStrikes: 8
});
console.log('Selected contract:', selected ? selected.optionSymbol : 'null');
```

**è§£å†³**:
- æ”¹ç”¨ `NEAREST` åˆ°æœŸæ¨¡å¼
```sql
UPDATE strategies
SET config = jsonb_set(config, '{expirationMode}', '"NEAREST"')
WHERE id = 10;
```

### é—®é¢˜C: æ”¶ç›˜å‰ç¦æ­¢å¼€ä»“çª—å£

**æ£€æŸ¥æ–¹æ³•**:
- æŸ¥çœ‹å½“å‰æ—¶é—´æ˜¯å¦åœ¨æ”¶ç›˜å‰60åˆ†é’Ÿå†…

**è§£å†³**:
- ç¼©çŸ­ç¦æ­¢å¼€ä»“çª—å£
```sql
UPDATE strategies
SET config = jsonb_set(config, '{tradeWindow,noNewEntryBeforeCloseMinutes}', '30')
WHERE id = 10;
```

## ğŸ“ˆ ç»¼åˆä¿®å¤å»ºè®®

### ç«‹å³æ‰§è¡Œ

1. âœ… **å·²å®Œæˆ**: åˆå§‹åŒ–ç­–ç•¥å®ä¾‹
2. **æ”¾å®½è¿‡æ»¤æ¡ä»¶**ï¼ˆæ‰§è¡Œæ–¹æ¡ˆ1çš„SQLï¼‰
3. **ç›‘æ§ä¸‹ä¸€æ¬¡æ‰§è¡Œ**ï¼ˆåº”åœ¨2-3åˆ†é’Ÿå†…ï¼‰

### å¦‚æœä»æ— ä¿¡å·

4. **ä¸´æ—¶å¼ºåˆ¶æ–¹å‘**ï¼ˆæ‰§è¡Œæ–¹æ¡ˆ2çš„SQLï¼‰
5. **æ”¹ç”¨NEARESTåˆ°æœŸæ¨¡å¼**
6. **ç¼©çŸ­ç¦æ­¢å¼€ä»“çª—å£**

### é•¿æœŸæ”¹è¿›

7. **å®æ–½æ–¹æ¡ˆ3**: åœ¨ç­–ç•¥å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–å®ä¾‹
8. **å¢å¼ºæ—¥å¿—**: åœ¨ `generateSignal()` ä¸­è®°å½•ä¸ºä»€ä¹ˆè¿”å›null
9. **ç›‘æ§å‘Šè­¦**: ç­–ç•¥é•¿æ—¶é—´æ— ä¿¡å·æ—¶å‘é€å‘Šè­¦

## ğŸ“ ç›¸å…³æ–‡ä»¶

- **ç­–ç•¥å®ç°**: `api/src/services/strategies/option-intraday-strategy.ts`
- **è°ƒåº¦å™¨**: `api/src/services/strategy-scheduler.service.ts`
- **çŠ¶æ€ç®¡ç†**: `api/src/services/state-manager.service.ts`
- **åˆçº¦é€‰æ‹©**: `api/src/services/options-contract-selector.service.ts`
- **è¯Šæ–­è„šæœ¬**: `diagnose-strategy-10.md`, `api/quick-fix-strategy-10.js`

## âœ… ä¿®å¤çŠ¶æ€

- [x] é—®é¢˜è¯Šæ–­å®Œæˆ
- [x] æ ¹æœ¬åŸå› ç¡®è®¤
- [x] ä¸´æ—¶ä¿®å¤å·²åº”ç”¨ï¼ˆå®ä¾‹åˆå§‹åŒ–ï¼‰
- [ ] æ ¹æœ¬æ€§ä¿®å¤å¾…å®æ–½ï¼ˆæ–¹æ¡ˆ1-3ï¼‰
- [ ] éªŒè¯ç­–ç•¥ç”Ÿæ•ˆ

## ğŸ“ åç»­è·Ÿè¿›

è¯·åœ¨ç­–ç•¥ä¸‹æ¬¡æ‰§è¡Œåï¼ˆçº¦2-3åˆ†é’Ÿï¼‰æ£€æŸ¥ï¼š
1. æ˜¯å¦æœ‰ä¿¡å·ç”Ÿæˆï¼Ÿ
2. æ˜¯å¦æœ‰è®¢å•æäº¤ï¼Ÿ
3. å¦‚æœä»æ— ä¿¡å·ï¼Œæ‰§è¡Œç»¼åˆä¿®å¤å»ºè®®ä¸­çš„æ­¥éª¤4-6

---

**è¯Šæ–­äººå‘˜**: Claude Code
**è¯Šæ–­æ—¶é—´**: 2026-01-27
**ä¼˜å…ˆçº§**: P0ï¼ˆä¸¥é‡é—®é¢˜ - ç­–ç•¥å®Œå…¨æ— æ³•è¿è¡Œï¼‰
**çŠ¶æ€**: ä¸´æ—¶ä¿®å¤å·²åº”ç”¨ï¼Œç­‰å¾…éªŒè¯
