# æœŸæƒç­–ç•¥æ‰§è¡Œå¤±è´¥æ ¹å› è¯Šæ–­æŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-30
**é—®é¢˜ä¸¥é‡æ€§**: ğŸ”´ é«˜å±
**å½±å“èŒƒå›´**: ç­–ç•¥10ï¼ˆæœŸæƒæ—¥å†…äº¤æ˜“ç­–ç•¥ï¼‰
**çŠ¶æ€**: ğŸ” å·²è¯Šæ–­ï¼Œå¾…ä¿®å¤

---

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

æ˜¨æ™šï¼ˆ2026-01-29ï¼‰ç­–ç•¥10æ‰§è¡Œäº†390æ¬¡ï¼Œä½†**å…¨éƒ¨å¤±è´¥**ï¼š
- âœ… ç­–ç•¥æ­£å¸¸æ‰«æï¼ˆ390æ¬¡æ‰§è¡Œï¼‰
- âŒ æ‰€æœ‰äº¤æ˜“ä¿¡å·ç”Ÿæˆè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼ˆ39æ¬¡é”™è¯¯ï¼‰
- âŒ æ²¡æœ‰ç”Ÿæˆä»»ä½•äº¤æ˜“è®¢å•
- âŒ ç­–ç•¥å§‹ç»ˆä¿æŒIDLEçŠ¶æ€ï¼Œneverè¿›å…¥HOLDINGçŠ¶æ€

---

## ğŸ“Š æ—¥å¿—åˆ†æç»“æœ

### æ ¸å¿ƒæ•°æ®ï¼ˆä»logs-2026-01-30.jsonï¼‰

```
æ€»æ—¥å¿—æ•°: 1,617
é”™è¯¯æ•°: 57 (3.53%)

ç­–ç•¥10ç»Ÿè®¡ï¼š
- æ‰§è¡Œæ¬¡æ•°: 390æ¬¡
- é”™è¯¯æ¬¡æ•°: 39æ¬¡
- ä¿¡å·æ•°é‡: 0ä¸ª  âš ï¸
- è®¢å•æ•°é‡: 0ä¸ª  âš ï¸
- çŠ¶æ€: å§‹ç»ˆä¸ºIDLE (100%)
```

### å…³é”®é”™è¯¯æ¨¡å¼

**é”™è¯¯1**: ç­–ç•¥æ‰§è¡Œå¼‚å¸¸ï¼ˆ39æ¬¡ï¼‰
```
"ç­–ç•¥ 10 å¤„ç†æ ‡çš„ QQQ.US å‡ºé”™:"
```
ä½ç½®ï¼š`strategy-scheduler.service.ts:1379`

**é”™è¯¯2**: å¯Œé€”APIæœŸæƒè¯¦æƒ…è·å–å¤±è´¥ï¼ˆ18æ¬¡ï¼‰
```
"[HIGH] EXTERNAL_API_ERROR: å¯Œé€”API: è·å–æœŸæƒè¯¦æƒ…å¤±è´¥"
è·¯å¾„: /api/options/detail
```

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜é“¾æ¡

```
1. ç­–ç•¥è°ƒåº¦å™¨å¯åŠ¨
   â†“
2. è°ƒç”¨ strategyInstance.generateSignal(symbol='QQQ.US')
   â†“
3. OptionIntradayStrategy.generateSignal() æ‰§è¡Œ
   â†“
4. è°ƒç”¨ selectOptionContract() é€‰æ‹©æœŸæƒåˆçº¦
   â†“
5. selectOptionContract() è°ƒç”¨å¯Œé€”APIè·å–æœŸæƒè¯¦æƒ…
   â†“
6. âŒ getOptionDetail() è°ƒç”¨å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
   â†“
7. âŒ å¼‚å¸¸æœªè¢«æ•è·ï¼Œä¼ æ’­åˆ° generateSignal()
   â†“
8. âŒ å¼‚å¸¸ç»§ç»­ä¼ æ’­åˆ°ç­–ç•¥è°ƒåº¦å™¨çš„ try-catch
   â†“
9. âŒ ç­–ç•¥è°ƒåº¦å™¨è®°å½•é”™è¯¯ï¼š"ç­–ç•¥ 10 å¤„ç†æ ‡çš„ QQQ.US å‡ºé”™"
   â†“
10. âŒ æ²¡æœ‰ç”Ÿæˆä¿¡å·ï¼Œæ²¡æœ‰ä¸‹å•ï¼Œç­–ç•¥ä¿æŒIDLE
```

### å…³é”®ä»£ç è·¯å¾„

#### 1. ç­–ç•¥è°ƒåº¦å™¨ï¼ˆstrategy-scheduler.service.ts:1094-1098ï¼‰
```typescript
// ç”Ÿæˆä¿¡å·ï¼ˆmarketData å‚æ•°å¯é€‰ï¼Œç­–ç•¥å†…éƒ¨ä¼šè‡ªè¡Œè·å–ï¼‰
const intent = await strategyInstance.generateSignal(symbol, undefined);

if (!intent) {
  summary.idle.push(symbol); // æœªç”Ÿæˆä¿¡å·ï¼Œè§†ä¸º IDLE
  return;
}
```

è¿™æ®µä»£ç **æ²¡æœ‰try-catchåŒ…è£¹**ï¼Œå¦‚æœ`generateSignal()`æŠ›å‡ºå¼‚å¸¸ï¼Œä¼šè¢«å¤–å±‚çš„catchæ•è·ï¼ˆ1378-1381è¡Œï¼‰ã€‚

#### 2. æœŸæƒç­–ç•¥ä¿¡å·ç”Ÿæˆï¼ˆoption-intraday-strategy.ts:79-88ï¼‰
```typescript
// 3) Select contract (0DTE default)
const expirationMode: ExpirationMode = cfg.expirationMode || '0DTE';
const selected = await selectOptionContract({
  underlyingSymbol: symbol,
  expirationMode,
  direction,
  candidateStrikes: 8,
  liquidityFilters: cfg.liquidityFilters,
  greekFilters: cfg.greekFilters,
});

if (!selected) return null;
```

è¿™æ®µä»£ç **ä¹Ÿæ²¡æœ‰try-catchåŒ…è£¹**ï¼Œå¦‚æœ`selectOptionContract()`æŠ›å‡ºå¼‚å¸¸ï¼Œä¼šç›´æ¥å‘ä¸Šä¼ æ’­ã€‚

#### 3. æœŸæƒåˆçº¦é€‰æ‹©å™¨ï¼ˆoptions-contract-selector.service.tsï¼‰
```typescript
export async function selectOptionContract(params: SelectOptionContractParams): Promise<SelectedOptionContract | null> {
  // ...
  const detail = await getOptionDetail(optionId, underlyingStockId, marketType);
  // âŒ å¦‚æœ getOptionDetail æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™é‡Œæ²¡æœ‰æ•è·
  // ...
}
```

#### 4. å¯Œé€”APIè°ƒç”¨ï¼ˆfutunn-option-chain.service.tsï¼‰
```typescript
export async function getOptionDetail(
  optionId: string,
  underlyingStockId: string,
  marketType: number = 2
): Promise<OptionDetail | null> {
  // ... æ„å»ºè¯·æ±‚å‚æ•°
  const response = await edgeFunctionFetch(url, fetchOptions);

  if (!response.data || response.error) {
    // âŒ è¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸æ˜¯è¿”å›null
    throw new Error(`è·å–æœŸæƒè¯¦æƒ…å¤±è´¥: ${response.error || 'Unknown error'}`);
  }
  // ...
}
```

---

## ğŸ¯ é—®é¢˜æœ¬è´¨

### 1. **é”™è¯¯ä¼ æ’­é“¾å¤ªé•¿ï¼Œç¼ºä¹é˜²å¾¡æ€§ç¼–ç¨‹**

```
getOptionDetail (æŠ›å‡ºå¼‚å¸¸)
  â†’ selectOptionContract (ä¸æ•è·ï¼Œç»§ç»­ä¼ æ’­)
    â†’ generateSignal (ä¸æ•è·ï¼Œç»§ç»­ä¼ æ’­)
      â†’ strategy-scheduler (æ•è·ä½†åªè®°å½•é”™è¯¯)
        â†’ ç»“æœï¼šç­–ç•¥å®Œå…¨å¤±æ•ˆ
```

### 2. **å¯Œé€”APIç¨³å®šæ€§é—®é¢˜**

æ—¥å¿—æ˜¾ç¤ºåœ¨äº¤æ˜“æ—¶æ®µï¼ˆ14:30-19:30 ESTï¼‰ï¼Œå¯Œé€”APIé¢‘ç¹å¤±è´¥ï¼š
- 18æ¬¡"è·å–æœŸæƒè¯¦æƒ…å¤±è´¥"
- å¹³å‡æ¯30åˆ†é’Ÿå¤±è´¥1-2æ¬¡
- å¤±è´¥ç‡çº¦ 18/390 â‰ˆ 4.6%

### 3. **é”™è¯¯å¤„ç†ç­–ç•¥ä¸å½“**

å½“å‰å®ç°ï¼š
```typescript
// âŒ é”™è¯¯å¤„ç†ï¼šæŠ›å‡ºå¼‚å¸¸ â†’ æ•´ä¸ªç­–ç•¥å¤±æ•ˆ
if (!response.data || response.error) {
  throw new Error(`è·å–æœŸæƒè¯¦æƒ…å¤±è´¥: ${response.error}`);
}
```

ç†æƒ³å®ç°ï¼š
```typescript
// âœ… é”™è¯¯å¤„ç†ï¼šé™çº§å¤„ç† â†’ ç­–ç•¥ç»§ç»­è¿è¡Œ
if (!response.data || response.error) {
  logger.warn(`è·å–æœŸæƒè¯¦æƒ…å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ...`);
  return null; // æˆ–è€…è¿”å›ç¼“å­˜æ•°æ®
}
```

### 4. **ç¼ºå°‘é‡è¯•æœºåˆ¶**

å¯Œé€”APIæ˜¯å¤–éƒ¨æœåŠ¡ï¼Œå¯èƒ½ä¸´æ—¶ä¸å¯ç”¨ã€‚æ²¡æœ‰é‡è¯•æœºåˆ¶å¯¼è‡´ï¼š
- ç¬æ—¶æ•…éšœ â†’ æ•´æ¬¡ç­–ç•¥æ‰§è¡Œå¤±è´¥
- æ¢å¤æ—¶é—´æµªè´¹ â†’ é”™è¿‡äº¤æ˜“æœºä¼š

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå¤šå±‚é˜²å¾¡ + ä¼˜é›…é™çº§ï¼ˆæ¨èï¼‰ â­â­â­â­â­

#### ä¿®æ”¹1: options-contract-selector.service.ts
```typescript
export async function selectOptionContract(params: SelectOptionContractParams): Promise<SelectedOptionContract | null> {
  try {
    // ... ç°æœ‰é€»è¾‘ ...
    const detail = await getOptionDetail(optionId, underlyingStockId, marketType);

    if (!detail) {
      logger.warn(`[æœŸæƒé€‰æ‹©å™¨] è·å–æœŸæƒè¯¦æƒ…å¤±è´¥: ${optionId}, è·³è¿‡è¯¥åˆçº¦`);
      continue; // å°è¯•ä¸‹ä¸€ä¸ªå€™é€‰åˆçº¦
    }

    // ... éªŒè¯é€»è¾‘ ...
  } catch (error: any) {
    logger.error(`[æœŸæƒé€‰æ‹©å™¨] é€‰æ‹©æœŸæƒåˆçº¦å¤±è´¥: ${error.message}`, error);
    return null; // ä¼˜é›…é™çº§ï¼šè¿”å›nullï¼Œè€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
  }
}
```

#### ä¿®æ”¹2: futunn-option-chain.service.tsï¼ˆæ·»åŠ é‡è¯•æœºåˆ¶ï¼‰
```typescript
export async function getOptionDetail(
  optionId: string,
  underlyingStockId: string,
  marketType: number = 2
): Promise<OptionDetail | null> {
  const maxRetries = 3;
  const retryDelay = 1000; // 1ç§’

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const response = await edgeFunctionFetch(url, fetchOptions);

      if (!response.data || response.error) {
        if (attempt < maxRetries) {
          logger.warn(`[å¯Œé€”API] è·å–æœŸæƒè¯¦æƒ…å¤±è´¥ (å°è¯• ${attempt}/${maxRetries}): ${response.error}`);
          await new Promise(resolve => setTimeout(resolve, retryDelay * attempt));
          continue;
        }
        logger.error(`[å¯Œé€”API] è·å–æœŸæƒè¯¦æƒ…æœ€ç»ˆå¤±è´¥: ${response.error}`);
        return null; // è¿”å›nullï¼Œè€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
      }

      return parseOptionDetail(response.data);
    } catch (error: any) {
      if (attempt < maxRetries) {
        logger.warn(`[å¯Œé€”API] è¯·æ±‚å¤±è´¥ (å°è¯• ${attempt}/${maxRetries}): ${error.message}`);
        await new Promise(resolve => setTimeout(resolve, retryDelay * attempt));
        continue;
      }
      logger.error(`[å¯Œé€”API] è¯·æ±‚æœ€ç»ˆå¤±è´¥: ${error.message}`);
      return null;
    }
  }

  return null;
}
```

#### ä¿®æ”¹3: option-intraday-strategy.tsï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
```typescript
async generateSignal(symbol: string): Promise<TradingIntent | null> {
  try {
    // ... ç°æœ‰é€»è¾‘ ...

    // 3) Select contract (0DTE default)
    const expirationMode: ExpirationMode = cfg.expirationMode || '0DTE';
    const selected = await selectOptionContract({
      underlyingSymbol: symbol,
      expirationMode,
      direction,
      candidateStrikes: 8,
      liquidityFilters: cfg.liquidityFilters,
      greekFilters: cfg.greekFilters,
    });

    if (!selected) {
      logger.log(`[ç­–ç•¥10] æœªæ‰¾åˆ°åˆé€‚çš„æœŸæƒåˆçº¦: ${symbol} (${direction})`);
      return null;
    }

    // ... åç»­é€»è¾‘ ...
  } catch (error: any) {
    logger.error(`[ç­–ç•¥10] ç”Ÿæˆä¿¡å·å¤±è´¥ (${symbol}): ${error.message}`, error);
    return null; // ä¼˜é›…é™çº§
  }
}
```

---

### æ–¹æ¡ˆ2ï¼šç¼“å­˜æœºåˆ¶ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰ â­â­â­â­

ä¸ºæœŸæƒè¯¦æƒ…æ·»åŠ ç¼“å­˜ï¼Œå‡å°‘APIè°ƒç”¨ï¼š

```typescript
// æ–°å»º: option-detail-cache.service.ts
class OptionDetailCache {
  private cache = new Map<string, { data: OptionDetail, timestamp: number }>();
  private TTL = 60 * 1000; // 60ç§’ç¼“å­˜

  async get(optionId: string): Promise<OptionDetail | null> {
    const cached = this.cache.get(optionId);
    if (cached && Date.now() - cached.timestamp < this.TTL) {
      return cached.data;
    }
    return null;
  }

  set(optionId: string, data: OptionDetail): void {
    this.cache.set(optionId, { data, timestamp: Date.now() });
  }
}
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœé¢„æœŸ

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤åï¼ˆé¢„æœŸï¼‰ |
|------|--------|---------------|
| ç­–ç•¥æ‰§è¡ŒæˆåŠŸç‡ | 0% | 85-95% |
| APIå¤±è´¥å½±å“ | æ•´ä¸ªç­–ç•¥å¤±æ•ˆ | å•æ¬¡å°è¯•å¤±è´¥ï¼Œå…¶ä»–ç»§ç»­ |
| äº¤æ˜“ä¿¡å·ç”Ÿæˆç‡ | 0ä¸ª/390æ¬¡ | é¢„è®¡10-30ä¸ª/390æ¬¡ |
| ç³»ç»Ÿç¨³å®šæ€§ | â­â­ | â­â­â­â­â­ |

---

## ğŸš€ å®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šç´§æ€¥ä¿®å¤ï¼ˆ30åˆ†é’Ÿï¼‰
1. âœ… åœ¨`getOptionDetail`æ·»åŠ é‡è¯•æœºåˆ¶ï¼ˆ3æ¬¡é‡è¯•ï¼‰
2. âœ… å°†å¼‚å¸¸æ”¹ä¸ºè¿”å›null
3. âœ… åœ¨`selectOptionContract`æ·»åŠ try-catch
4. âœ… æµ‹è¯•æœŸæƒç­–ç•¥ä¿¡å·ç”Ÿæˆ

### é˜¶æ®µ2ï¼šå®Œå–„ä¼˜åŒ–ï¼ˆ1å°æ—¶ï¼‰
1. åœ¨`generateSignal`æ·»åŠ try-catch
2. æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—è®°å½•
3. æ·»åŠ æœŸæƒè¯¦æƒ…ç¼“å­˜
4. å®Œæ•´å›å½’æµ‹è¯•

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
1. `api/src/services/futunn-option-chain.service.ts` - æ·»åŠ é‡è¯•æœºåˆ¶
2. `api/src/services/options-contract-selector.service.ts` - æ·»åŠ é”™è¯¯å¤„ç†
3. `api/src/services/strategies/option-intraday-strategy.ts` - æ·»åŠ é”™è¯¯å¤„ç†

### å‚è€ƒæ–‡æ¡£
- [æœŸæƒé‡åŒ–ä¸‹å•æ¶æ„é‡æ„æ€»ç»“](./260129-æœŸæƒé‡åŒ–ä¸‹å•æ¶æ„é‡æ„å®Œæˆæ€»ç»“.md)
- [æœŸæƒé‡åŒ–ä¸‹å•å¤±è´¥æ ¹æœ¬åŸå› åˆ†æ](./260129-æœŸæƒé‡åŒ–ä¸‹å•å¤±è´¥æ ¹æœ¬åŸå› åˆ†æ.md)

---

## âœï¸ æ€»ç»“

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. âŒ å¯Œé€”APIè°ƒç”¨å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´æ•´ä¸ªç­–ç•¥æ‰§è¡Œé“¾ä¸­æ–­
2. âŒ ç¼ºå°‘é‡è¯•æœºåˆ¶ï¼Œç¬æ—¶æ•…éšœå¯¼è‡´ç­–ç•¥å®Œå…¨å¤±æ•ˆ
3. âŒ ç¼ºå°‘å¤šå±‚é˜²å¾¡ï¼Œå•ç‚¹æ•…éšœå½±å“å…¨å±€

**ä¿®å¤é‡ç‚¹**ï¼š
1. âœ… å°†å¼‚å¸¸å¤„ç†æ”¹ä¸ºè¿”å›nullï¼ˆä¼˜é›…é™çº§ï¼‰
2. âœ… æ·»åŠ 3æ¬¡é‡è¯•æœºåˆ¶ï¼ˆå¤„ç†ç¬æ—¶æ•…éšœï¼‰
3. âœ… å¤šå±‚try-catché˜²å¾¡ï¼ˆé¿å…å•ç‚¹æ•…éšœï¼‰
4. âœ… æ·»åŠ ç¼“å­˜æœºåˆ¶ï¼ˆå‡å°‘APIè°ƒç”¨ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- ç­–ç•¥æˆåŠŸç‡ï¼š0% â†’ 85-95%
- APIæ•…éšœå®¹å¿åº¦ï¼šâ­ â†’ â­â­â­â­â­
- ç³»ç»Ÿç¨³å®šæ€§ï¼šâ­â­ â†’ â­â­â­â­â­

---

**è¯Šæ–­äººå‘˜**: Claude Code
**è¯Šæ–­æ—¶é—´**: 2026-01-30
**ä¸‹ä¸€æ­¥**: ç«‹å³å®æ–½ä¿®å¤æ–¹æ¡ˆ1
