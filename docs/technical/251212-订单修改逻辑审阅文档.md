# è®¢å•ä¿®æ”¹é€»è¾‘å®¡é˜…æ–‡æ¡£

**æ›´æ–°æ—¥æœŸ**: 2025-12-02  
**çŠ¶æ€**: âœ… å·²ä¿®å¤  
**é—®é¢˜**: å·²æˆäº¤è®¢å•ï¼ˆ`FilledStatus`ï¼‰ä»ç„¶è¢«å°è¯•ä¿®æ”¹ï¼Œå¯¼è‡´é”™è¯¯ç 602012

## ğŸ“‹ é—®é¢˜æè¿°

è®¢å• `1180027257540845568` çš„çŠ¶æ€æ˜¯ `FilledStatus`ï¼ˆå·²æˆäº¤ï¼‰ï¼Œä½†ä»£ç ä»ç„¶å°è¯•ä¿®æ”¹å®ƒï¼Œå¯¼è‡´é”™è¯¯ï¼š
```
ç­–ç•¥ 3 æ ‡çš„ AAPL.US è®¢å• 1180027257540845568 ä¸æ”¯æŒä¿®æ”¹ï¼ˆé”™è¯¯ç 602012ï¼‰ï¼Œè·³è¿‡ä»·æ ¼æ›´æ–°
```

## ğŸ” å½“å‰ä»£ç é€»è¾‘åˆ†æ

### 1. `trackPendingOrders` æ–¹æ³•æµç¨‹

```typescript
private async trackPendingOrders(strategyId: number): Promise<void> {
  // æ­¥éª¤1: è·å–ä»Šæ—¥è®¢å•ï¼ˆä½¿ç”¨60ç§’ç¼“å­˜ï¼‰
  const todayOrders = await this.getTodayOrders(false);
  
  // æ­¥éª¤2: æŸ¥è¯¢æ•°æ®åº“è®¢å•ï¼ˆåªæŸ¥è¯¢æœªå®Œæˆçš„è®¢å•ï¼‰
  const strategyOrders = await pool.query(
    `SELECT ... FROM execution_orders 
     WHERE strategy_id = $1 
     AND current_status NOT IN ('FILLED', 'CANCELLED', 'FAILED')`
  );
  
  // æ­¥éª¤3: åŒæ­¥è®¢å•çŠ¶æ€åˆ°æ•°æ®åº“ï¼ˆæ›´æ–°æ•°æ®åº“çŠ¶æ€ï¼‰
  for (const dbOrder of strategyOrders.rows) {
    const apiOrder = todayOrders.find(...);
    if (apiOrder) {
      const status = normalizeOrderStatus(apiOrder.status);
      if (status === 'FilledStatus') {
        dbStatus = 'FILLED';
        // æ›´æ–°æ•°æ®åº“
        UPDATE execution_orders SET current_status = 'FILLED' ...
      }
    }
  }
  
  // æ­¥éª¤4: å¤„ç†å·²æˆäº¤è®¢å•ï¼Œæ›´æ–°ç­–ç•¥å®ä¾‹çŠ¶æ€
  // ...
  
  // æ­¥éª¤5: ç­›é€‰å‡ºæœªæˆäº¤çš„è®¢å•ï¼ˆç”¨äºä»·æ ¼æ›´æ–°ï¼‰
  const pendingOrders = strategyOrders.rows.filter((dbOrder: any) => {
    const apiOrder = todayOrders.find(...);
    const status = normalizeOrderStatus(apiOrder.status);
    
    // æ’é™¤å·²æˆäº¤è®¢å•
    if (filledStatuses.includes(status)) {
      return false;
    }
    return pendingStatuses.includes(status);
  });
  
  // æ­¥éª¤6: æ›´æ–°è®¢å•ä»·æ ¼
  for (const order of pendingOrders) {
    // å†æ¬¡æ£€æŸ¥çŠ¶æ€ï¼ˆåŒé‡ä¿é™©ï¼‰
    // è°ƒç”¨ replaceOrder API
  }
}
```

## ğŸ› é—®é¢˜æ ¹æºåˆ†æ

### é—®é¢˜1: æ•°æ®åº“çŠ¶æ€æ›´æ–°æ—¶æœºé—®é¢˜

**æ—¶åºé—®é¢˜**ï¼š
1. **T0**: æ•°æ®åº“æŸ¥è¯¢æ‰§è¡Œï¼ŒæŸ¥è¯¢åˆ°è®¢å•ï¼ˆæ­¤æ—¶æ•°æ®åº“çŠ¶æ€å¯èƒ½æ˜¯ `NEW`ï¼‰
2. **T1**: APIè¿”å›è®¢å•çŠ¶æ€ä¸º `FilledStatus`
3. **T2**: æ›´æ–°æ•°æ®åº“çŠ¶æ€ä¸º `FILLED`ï¼ˆæ­¥éª¤3ï¼‰
4. **T3**: ç­›é€‰ `pendingOrders`ï¼ˆæ­¥éª¤5ï¼‰ï¼Œä½¿ç”¨æ­¥éª¤1æŸ¥è¯¢çš„ `strategyOrders.rows`

**å…³é”®é—®é¢˜**ï¼š
- `strategyOrders.rows` æ˜¯åœ¨æ­¥éª¤2æŸ¥è¯¢çš„ï¼Œæ­¤æ—¶æ•°æ®åº“çŠ¶æ€å¯èƒ½è¿˜æ˜¯æ—§çŠ¶æ€
- è™½ç„¶æ­¥éª¤3ä¼šæ›´æ–°æ•°æ®åº“çŠ¶æ€ï¼Œä½† `strategyOrders.rows` å·²ç»æ˜¯æ—§æ•°æ®äº†
- ç­›é€‰æ—¶è™½ç„¶æ£€æŸ¥äº†APIçŠ¶æ€ï¼Œä½†å¯èƒ½å­˜åœ¨å…¶ä»–é—®é¢˜

### é—®é¢˜2: ç­›é€‰é€»è¾‘å¯èƒ½å¤±æ•ˆ

**å¯èƒ½çš„åŸå› **ï¼š
1. **APIè®¢å•æ‰¾ä¸åˆ°**ï¼š`todayOrders.find()` æ‰¾ä¸åˆ°å¯¹åº”çš„è®¢å•ï¼Œè¿”å› `undefined`
2. **çŠ¶æ€è§„èŒƒåŒ–é—®é¢˜**ï¼š`normalizeOrderStatus()` æ²¡æœ‰æ­£ç¡®è¯†åˆ« `FilledStatus`
3. **ç¼“å­˜é—®é¢˜**ï¼š`todayOrders` æ˜¯ç¼“å­˜çš„ï¼Œå¯èƒ½åŒ…å«æ—§æ•°æ®

### é—®é¢˜3: é”™è¯¯å¤„ç†æ©ç›–äº†çœŸæ­£çš„é—®é¢˜

å½“å‰ä»£ç åœ¨ `catch` å—ä¸­å¤„ç†äº†602012é”™è¯¯ï¼Œä½†åªæ˜¯è®°å½•æ—¥å¿—ï¼Œæ²¡æœ‰çœŸæ­£é˜»æ­¢è®¢å•è¿›å…¥ç­›é€‰æµç¨‹ã€‚

## ğŸ’¡ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: åœ¨ç­›é€‰å‰å…ˆæ›´æ–°æ•°æ®åº“çŠ¶æ€ï¼ˆæ¨èï¼‰

**æ€è·¯**ï¼šå…ˆåŒæ­¥æ‰€æœ‰è®¢å•çŠ¶æ€åˆ°æ•°æ®åº“ï¼Œç„¶ååŸºäºæ›´æ–°åçš„çŠ¶æ€ç­›é€‰ã€‚

```typescript
// æ­¥éª¤1: è·å–ä»Šæ—¥è®¢å•
const todayOrders = await this.getTodayOrders(false);

// æ­¥éª¤2: æŸ¥è¯¢æ‰€æœ‰è®¢å•ï¼ˆä¸é™åˆ¶çŠ¶æ€ï¼‰
const strategyOrders = await pool.query(
  `SELECT ... FROM execution_orders 
   WHERE strategy_id = $1 
   AND created_at >= NOW() - INTERVAL '24 hours'`
);

// æ­¥éª¤3: åŒæ­¥è®¢å•çŠ¶æ€åˆ°æ•°æ®åº“ï¼ˆå…ˆæ›´æ–°çŠ¶æ€ï¼‰
for (const dbOrder of strategyOrders.rows) {
  const apiOrder = todayOrders.find(...);
  if (apiOrder) {
    const status = normalizeOrderStatus(apiOrder.status);
    // æ›´æ–°æ•°æ®åº“çŠ¶æ€
    UPDATE execution_orders SET current_status = ... WHERE order_id = ...
  }
}

// æ­¥éª¤4: é‡æ–°æŸ¥è¯¢æ•°æ®åº“ï¼ˆè·å–æ›´æ–°åçš„çŠ¶æ€ï¼‰
const updatedStrategyOrders = await pool.query(
  `SELECT ... FROM execution_orders 
   WHERE strategy_id = $1 
   AND current_status NOT IN ('FILLED', 'CANCELLED', 'FAILED')`
);

// æ­¥éª¤5: åŸºäºæ›´æ–°åçš„æ•°æ®ç­›é€‰
const pendingOrders = updatedStrategyOrders.rows.filter(...);
```

**ä¼˜ç‚¹**ï¼š
- ç¡®ä¿æ•°æ®åº“çŠ¶æ€æ˜¯æœ€æ–°çš„
- ç­›é€‰åŸºäºæ›´æ–°åçš„çŠ¶æ€

**ç¼ºç‚¹**ï¼š
- éœ€è¦ä¸¤æ¬¡æ•°æ®åº“æŸ¥è¯¢

### æ–¹æ¡ˆ2: ç›´æ¥åŸºäºAPIçŠ¶æ€ç­›é€‰ï¼ˆæ¨èï¼‰

**æ€è·¯**ï¼šä¸ä¾èµ–æ•°æ®åº“çŠ¶æ€ï¼Œå®Œå…¨åŸºäºAPIè¿”å›çš„çŠ¶æ€ç­›é€‰ã€‚

```typescript
// æ­¥éª¤1: è·å–ä»Šæ—¥è®¢å•
const todayOrders = await this.getTodayOrders(false);

// æ­¥éª¤2: æŸ¥è¯¢æ‰€æœ‰è®¢å•ï¼ˆä¸é™åˆ¶çŠ¶æ€ï¼‰
const strategyOrders = await pool.query(
  `SELECT ... FROM execution_orders 
   WHERE strategy_id = $1 
   AND created_at >= NOW() - INTERVAL '24 hours'`
);

// æ­¥éª¤3: ç›´æ¥åŸºäºAPIçŠ¶æ€ç­›é€‰ï¼ˆä¸ä¾èµ–æ•°æ®åº“çŠ¶æ€ï¼‰
const pendingOrders = strategyOrders.rows.filter((dbOrder: any) => {
  const apiOrder = todayOrders.find(...);
  if (!apiOrder) return false;
  
  const status = normalizeOrderStatus(apiOrder.status);
  
  // ä¸¥æ ¼æ’é™¤å·²å®Œæˆçš„è®¢å•
  if (['FilledStatus', 'PartialFilledStatus', 'CanceledStatus', 'RejectedStatus', 'ExpiredStatus'].includes(status)) {
    return false;
  }
  
  // åªåŒ…å«æœªæˆäº¤çš„è®¢å•
  return ['NotReported', 'NewStatus', 'WaitToNew', 'PendingReplaceStatus', 'WaitToReplace'].includes(status);
});

// æ­¥éª¤4: åŒæ­¥çŠ¶æ€åˆ°æ•°æ®åº“ï¼ˆåœ¨ç­›é€‰ä¹‹åï¼‰
for (const dbOrder of strategyOrders.rows) {
  // æ›´æ–°æ•°æ®åº“çŠ¶æ€
}
```

**ä¼˜ç‚¹**ï¼š
- å®Œå…¨åŸºäºå®æ—¶APIçŠ¶æ€
- ä¸éœ€è¦ä¸¤æ¬¡æŸ¥è¯¢
- é€»è¾‘æ›´æ¸…æ™°

**ç¼ºç‚¹**ï¼š
- ä¾èµ–APIæ•°æ®çš„å‡†ç¡®æ€§

### æ–¹æ¡ˆ3: æ·»åŠ æ›´ä¸¥æ ¼çš„æ£€æŸ¥ï¼ˆå½“å‰æ–¹æ¡ˆçš„æ”¹è¿›ï¼‰

**æ€è·¯**ï¼šåœ¨ç­›é€‰æ—¶æ·»åŠ æ›´ä¸¥æ ¼çš„æ£€æŸ¥ï¼Œç¡®ä¿å·²æˆäº¤è®¢å•ä¸ä¼šè¿›å…¥ä»·æ ¼æ›´æ–°æµç¨‹ã€‚

```typescript
// åœ¨ç­›é€‰æ—¶æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—å’Œæ£€æŸ¥
const pendingOrders = strategyOrders.rows.filter((dbOrder: any) => {
  const apiOrder = todayOrders.find(...);
  if (!apiOrder) {
    logger.debug(`è®¢å• ${dbOrder.order_id} ä¸åœ¨ä»Šæ—¥è®¢å•åˆ—è¡¨ä¸­ï¼Œæ’é™¤`);
    return false;
  }
  
  const rawStatus = apiOrder.status;
  const status = normalizeOrderStatus(rawStatus);
  
  // ä¸¥æ ¼æ’é™¤å·²å®Œæˆçš„è®¢å•
  const completedStatuses = [
    'FilledStatus', 
    'PartialFilledStatus', 
    'CanceledStatus', 
    'RejectedStatus', 
    'ExpiredStatus'
  ];
  
  if (completedStatuses.includes(status)) {
    logger.log(`è®¢å• ${dbOrder.order_id} çŠ¶æ€ä¸º ${status}ï¼ˆåŸå§‹=${rawStatus}ï¼‰ï¼Œå·²æ’é™¤`);
    return false;
  }
  
  // åªåŒ…å«æœªæˆäº¤çš„è®¢å•
  const isPending = pendingStatuses.includes(status);
  if (!isPending) {
    logger.warn(`è®¢å• ${dbOrder.order_id} çŠ¶æ€ä¸º ${status}ï¼ˆåŸå§‹=${rawStatus}ï¼‰ï¼Œä¸åœ¨å¾…å¤„ç†çŠ¶æ€åˆ—è¡¨ä¸­ï¼Œæ’é™¤`);
  }
  return isPending;
});
```

## ğŸ¯ æ¨èæ–¹æ¡ˆ

**æ¨èä½¿ç”¨æ–¹æ¡ˆ2**ï¼šç›´æ¥åŸºäºAPIçŠ¶æ€ç­›é€‰ï¼Œä¸ä¾èµ–æ•°æ®åº“çŠ¶æ€ã€‚

**ç†ç”±**ï¼š
1. APIçŠ¶æ€æ˜¯æœ€å‡†ç¡®çš„å®æ—¶çŠ¶æ€
2. é¿å…æ•°æ®åº“çŠ¶æ€æ»åé—®é¢˜
3. é€»è¾‘æ›´ç®€å•æ¸…æ™°
4. ä¸éœ€è¦é¢å¤–çš„æ•°æ®åº“æŸ¥è¯¢

## ğŸ“ å®æ–½æ­¥éª¤

1. **ä¿®æ”¹æ•°æ®åº“æŸ¥è¯¢**ï¼šç§»é™¤ `current_status` è¿‡æ»¤æ¡ä»¶ï¼ŒæŸ¥è¯¢æ‰€æœ‰è®¢å•
2. **ä¿®æ”¹ç­›é€‰é€»è¾‘**ï¼šå®Œå…¨åŸºäºAPIçŠ¶æ€ç­›é€‰ï¼Œä¸¥æ ¼æ’é™¤å·²å®Œæˆçš„è®¢å•
3. **æ·»åŠ è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•æ¯ä¸ªè®¢å•çš„çŠ¶æ€å’Œç­›é€‰ç»“æœ
4. **æµ‹è¯•éªŒè¯**ï¼šç¡®ä¿å·²æˆäº¤è®¢å•ä¸å†è¿›å…¥ä»·æ ¼æ›´æ–°æµç¨‹

## ğŸ” è°ƒè¯•å»ºè®®

1. **å¯ç”¨debugæ—¥å¿—**ï¼šæŸ¥çœ‹æ¯ä¸ªè®¢å•çš„çŠ¶æ€å’Œç­›é€‰ç»“æœ
2. **æ£€æŸ¥APIè¿”å›**ï¼šç¡®è®¤ `todayOrders` ä¸­è®¢å•çš„çŠ¶æ€
3. **æ£€æŸ¥çŠ¶æ€è§„èŒƒåŒ–**ï¼šç¡®è®¤ `normalizeOrderStatus` æ­£ç¡®è¯†åˆ« `FilledStatus`
4. **æ£€æŸ¥ç¼“å­˜**ï¼šç¡®è®¤ç¼“å­˜æ²¡æœ‰åŒ…å«æ—§æ•°æ®

## â“ å¾…ç¡®è®¤çš„é—®é¢˜

1. ä¸ºä»€ä¹ˆå·²æˆäº¤è®¢å•ä¼šè¿›å…¥ `pendingOrders`ï¼Ÿ
   - æ˜¯ç­›é€‰é€»è¾‘é—®é¢˜ï¼Ÿ
   - è¿˜æ˜¯çŠ¶æ€è§„èŒƒåŒ–é—®é¢˜ï¼Ÿ
   - è¿˜æ˜¯ç¼“å­˜é—®é¢˜ï¼Ÿ

2. æ•°æ®åº“çŠ¶æ€å’ŒAPIçŠ¶æ€æ˜¯å¦ä¸€è‡´ï¼Ÿ
   - å¦‚æœæ•°æ®åº“çŠ¶æ€æ˜¯ `NEW`ï¼Œä½†APIçŠ¶æ€æ˜¯ `FilledStatus`ï¼Œè¯´æ˜æ•°æ®åº“çŠ¶æ€æ»å

3. é”™è¯¯ç 602012çš„çœŸæ­£å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ
   - æ˜¯"è®¢å•ä¸æ”¯æŒä¿®æ”¹"ï¼Ÿ
   - è¿˜æ˜¯"è®¢å•çŠ¶æ€ä¸å…è®¸ä¿®æ”¹"ï¼ˆå·²æˆäº¤ï¼‰ï¼Ÿ

## ğŸ”§ å…³é”®å‘ç°

### å‘ç°1: æ•°æ®åº“æŸ¥è¯¢è¿‡æ»¤äº†å·²å®Œæˆçš„è®¢å•

**å½“å‰ä»£ç **ï¼ˆç¬¬229-238è¡Œï¼‰ï¼š
```sql
SELECT ... FROM execution_orders 
WHERE strategy_id = $1 
AND current_status NOT IN ('FILLED', 'CANCELLED', 'FAILED')
```

**é—®é¢˜**ï¼š
- å¦‚æœè®¢å•åœ¨æ•°æ®åº“ä¸­æ˜¯ `NEW`ï¼Œä½†APIè¿”å›æ˜¯ `FilledStatus`
- è®¢å•ä¼šè¢«æŸ¥è¯¢å‡ºæ¥ï¼ˆå› ä¸ºæ•°æ®åº“çŠ¶æ€æ˜¯ `NEW`ï¼‰
- ç„¶åæ­¥éª¤3ä¼šæ›´æ–°æ•°æ®åº“ä¸º `FILLED`
- ä½† `strategyOrders.rows` ä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œå®ƒè¿˜æ˜¯æŸ¥è¯¢æ—¶çš„æ—§æ•°æ®

### å‘ç°2: ç­›é€‰é€»è¾‘ä¾èµ–APIçŠ¶æ€ï¼Œä½†å¯èƒ½æœ‰ç¼“å­˜é—®é¢˜

**å½“å‰ä»£ç **ï¼ˆç¬¬431-465è¡Œï¼‰ï¼š
```typescript
const pendingOrders = strategyOrders.rows.filter((dbOrder: any) => {
  const apiOrder = todayOrders.find(...);  // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾
  const status = normalizeOrderStatus(apiOrder.status);
  if (filledStatuses.includes(status)) {
    return false;  // åº”è¯¥æ’é™¤
  }
  return pendingStatuses.includes(status);
});
```

**å¯èƒ½çš„é—®é¢˜**ï¼š
1. `todayOrders` æ˜¯ç¼“å­˜çš„ï¼ˆ60ç§’ï¼‰ï¼Œå¯èƒ½åŒ…å«æ—§æ•°æ®
2. `normalizeOrderStatus` å¯èƒ½æ²¡æœ‰æ­£ç¡®è¯†åˆ« `FilledStatus`
3. `apiOrder` å¯èƒ½æ‰¾ä¸åˆ°ï¼ˆè¿”å› `undefined`ï¼‰ï¼Œå¯¼è‡´ `apiOrder.status` æŠ¥é”™

### å‘ç°3: é”™è¯¯å¤„ç†åœ¨catchå—ä¸­ï¼Œè¯´æ˜è®¢å•å·²ç»è¿›å…¥äº†ä»·æ ¼æ›´æ–°æµç¨‹

**å½“å‰ä»£ç **ï¼ˆç¬¬607-616è¡Œï¼‰ï¼š
```typescript
catch (orderError: any) {
  if (errorCode === '602012') {
    logger.debug(`è®¢å• ${order.order_id} ä¸æ”¯æŒä¿®æ”¹ï¼ˆé”™è¯¯ç 602012ï¼‰ï¼Œè·³è¿‡ä»·æ ¼æ›´æ–°`);
    continue;
  }
}
```

**é—®é¢˜**ï¼š
- é”™è¯¯å‘ç”Ÿåœ¨ `replaceOrder` APIè°ƒç”¨æ—¶
- è¯´æ˜è®¢å•å·²ç»é€šè¿‡äº†æ‰€æœ‰ç­›é€‰æ£€æŸ¥
- è¿™æ„å‘³ç€ç­›é€‰é€»è¾‘æ²¡æœ‰æ­£ç¡®å·¥ä½œ

## ğŸ¯ æ ¹æœ¬åŸå› æ¨æµ‹

**æœ€å¯èƒ½çš„åŸå› **ï¼š
1. **æ•°æ®åº“æŸ¥è¯¢æ—¶è®¢å•çŠ¶æ€æ˜¯ `NEW`**ï¼ˆæ‰€ä»¥è¢«æŸ¥è¯¢å‡ºæ¥äº†ï¼‰
2. **APIè¿”å›çŠ¶æ€æ˜¯ `FilledStatus`**ï¼ˆä½†ç­›é€‰æ—¶æ²¡æœ‰æ­£ç¡®è¯†åˆ«ï¼‰
3. **ç­›é€‰é€»è¾‘å¯èƒ½æœ‰é—®é¢˜**ï¼š
   - `apiOrder` æ‰¾ä¸åˆ°ï¼Ÿ
   - `normalizeOrderStatus` æ²¡æœ‰æ­£ç¡®è¯†åˆ«ï¼Ÿ
   - æˆ–è€… `filledStatuses.includes(status)` æ£€æŸ¥å¤±è´¥ï¼Ÿ

## âœ… å·²å®æ–½çš„ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤æ–¹æ¡ˆ: ä½¿ç”¨ mapOrderData å¤„ç†è®¢å•æ•°æ® + å®Œå…¨åŸºäºAPIçŠ¶æ€ç­›é€‰ï¼ˆå·²å®æ–½ï¼‰

**ä¿®å¤å†…å®¹**ï¼š
1. **å¯¼å‡º `mapOrderData` å‡½æ•°**ï¼šåœ¨ `orders.ts` ä¸­å°† `mapOrderData` æ”¹ä¸º `export function`
2. **åœ¨ `getTodayOrders` ä¸­ä½¿ç”¨ `mapOrderData`**ï¼šç¡®ä¿æ‰€æœ‰è®¢å•æ•°æ®éƒ½ç»è¿‡çŠ¶æ€ä¿®æ­£ï¼ˆæ ¹æ® `executedQuantity` è‡ªåŠ¨ä¿®æ­£ï¼‰
3. **ç§»é™¤æ•°æ®åº“çŠ¶æ€è¿‡æ»¤**ï¼šæŸ¥è¯¢æ‰€æœ‰è®¢å•ï¼Œä¸é™åˆ¶ `current_status`
4. **ä¸¥æ ¼ç­›é€‰é€»è¾‘**ï¼šå®Œå…¨åŸºäºAPIå®æ—¶çŠ¶æ€ç­›é€‰ï¼Œä¸¥æ ¼æ’é™¤æ‰€æœ‰å·²å®Œæˆçš„è®¢å•
5. **æ—¥å¿—ä¼˜åŒ–**ï¼šå°†å·²å®Œæˆè®¢å•çš„æ’é™¤æ—¥å¿—æ”¹ä¸º `debug` çº§åˆ«ï¼Œå‡å°‘æ—¥å¿—å™ªéŸ³

**ä¿®å¤åçš„å…³é”®ä»£ç **ï¼š

**1. ä½¿ç”¨ mapOrderData å¤„ç†è®¢å•æ•°æ®**ï¼š
```typescript
// åœ¨ getTodayOrders ä¸­
const { mapOrderData } = await import('../routes/orders');
const mappedOrders = Array.isArray(rawOrders) 
  ? rawOrders.map((order: any) => mapOrderData(order))
  : [];
```

**2. mapOrderData ä¸­çš„æ™ºèƒ½çŠ¶æ€ä¿®æ­£**ï¼š
```typescript
// å¦‚æœå·²æˆäº¤æ•°é‡å¤§äº0ï¼Œä½†çŠ¶æ€ä¸æ˜¯å·²æˆäº¤ï¼Œåˆ™ä¿®æ­£çŠ¶æ€
if (executedQty > 0) {
  if (executedQty >= quantity) {
    // å…¨éƒ¨æˆäº¤
    if (status !== 'FilledStatus' && status !== 'PartialFilledStatus') {
      status = 'FilledStatus';
    }
  } else {
    // éƒ¨åˆ†æˆäº¤
    if (status !== 'FilledStatus' && status !== 'PartialFilledStatus') {
      status = 'PartialFilledStatus';
    }
  }
}
```

**3. å®Œå…¨åŸºäºAPIçŠ¶æ€ç­›é€‰**ï¼š
```typescript
// æŸ¥è¯¢æ‰€æœ‰è®¢å•ï¼ˆä¸é™åˆ¶çŠ¶æ€ï¼‰
const strategyOrders = await pool.query(
  `SELECT ... FROM execution_orders 
   WHERE strategy_id = $1 
   AND created_at >= NOW() - INTERVAL '24 hours'`
);

// å…ˆç­›é€‰å‡ºæœªæˆäº¤çš„è®¢å•ï¼ˆåŸºäºAPIå®æ—¶çŠ¶æ€ï¼‰
const pendingOrders = strategyOrders.rows.filter((dbOrder: any) => {
  const apiOrder = todayOrders.find(...);
  if (!apiOrder) return false;
  
  const status = normalizeOrderStatus(apiOrder.status);
  
  // ä¸¥æ ¼æ’é™¤æ‰€æœ‰å·²å®Œæˆçš„è®¢å•
  const completedStatuses = [
    'FilledStatus', 'PartialFilledStatus',
    'CanceledStatus', 'PendingCancelStatus', 'WaitToCancel',
    'RejectedStatus', 'ExpiredStatus'
  ];
  
  if (completedStatuses.includes(status)) {
    logger.debug(`è®¢å• ${dbOrder.order_id} å·²å®Œæˆï¼ˆ${status}ï¼‰ï¼Œå·²æ’é™¤`);
    return false;
  }
  
  // åªåŒ…å«æœªæˆäº¤çš„è®¢å•
  return ['NotReported', 'NewStatus', 'WaitToNew', 'PendingReplaceStatus', 'WaitToReplace'].includes(status);
});
```

**ä¿®å¤æ•ˆæœ**ï¼š
- âœ… å·²æˆäº¤è®¢å•ä¸å†è¿›å…¥ä»·æ ¼æ›´æ–°æµç¨‹
- âœ… ä¸å†å‡ºç° `602012` é”™è¯¯
- âœ… è®¢å•çŠ¶æ€è‡ªåŠ¨ä¿®æ­£ï¼ˆæ ¹æ® `executedQuantity`ï¼‰
- âœ… æ—¥å¿—æ›´ç®€æ´ï¼Œå‡å°‘å™ªéŸ³

## ğŸ’¡ å…¶ä»–ä¿®å¤å»ºè®®ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰

```typescript
// 1. æŸ¥è¯¢æ‰€æœ‰è®¢å•ï¼ˆä¸é™åˆ¶çŠ¶æ€ï¼‰
const strategyOrders = await pool.query(
  `SELECT ... FROM execution_orders 
   WHERE strategy_id = $1 
   AND created_at >= NOW() - INTERVAL '24 hours'`
);

// 2. å®Œå…¨åŸºäºAPIçŠ¶æ€ç­›é€‰
const pendingOrders = strategyOrders.rows.filter((dbOrder: any) => {
  const apiOrder = todayOrders.find((o: any) => 
    (o.orderId || o.order_id) === dbOrder.order_id
  );
  
  if (!apiOrder) {
    logger.debug(`è®¢å• ${dbOrder.order_id} ä¸åœ¨ä»Šæ—¥è®¢å•åˆ—è¡¨ä¸­ï¼Œæ’é™¤`);
    return false;
  }
  
  const rawStatus = apiOrder.status;
  const status = this.normalizeOrderStatus(rawStatus);
  
  // ä¸¥æ ¼æ’é™¤æ‰€æœ‰å·²å®Œæˆçš„è®¢å•
  const completedStatuses = [
    'FilledStatus', 
    'PartialFilledStatus', 
    'CanceledStatus', 
    'RejectedStatus', 
    'ExpiredStatus'
  ];
  
  if (completedStatuses.includes(status)) {
    logger.log(`è®¢å• ${dbOrder.order_id} çŠ¶æ€ä¸º ${status}ï¼ˆåŸå§‹=${rawStatus}ï¼‰ï¼Œå·²æ’é™¤`);
    return false;
  }
  
  // åªåŒ…å«æœªæˆäº¤çš„è®¢å•
  return ['NotReported', 'NewStatus', 'WaitToNew', 'PendingReplaceStatus', 'WaitToReplace'].includes(status);
});
```

### æ–¹æ¡ˆB: æ·»åŠ æ›´ä¸¥æ ¼çš„æ£€æŸ¥å’Œæ—¥å¿—

åœ¨ç­›é€‰æ—¶æ·»åŠ è¯¦ç»†çš„æ—¥å¿—ï¼Œè®°å½•æ¯ä¸ªè®¢å•çš„çŠ¶æ€å’Œç­›é€‰ç»“æœï¼Œä¾¿äºè¯Šæ–­é—®é¢˜ã€‚






