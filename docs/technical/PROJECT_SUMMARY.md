# 项目总结

**最后更新**: 2025-12-02

## 📋 项目概述

长桥股票交易系统是一个基于 Node.js + Next.js 的量化交易平台，支持美股和港股的自动化交易、策略管理、订单追踪等功能。

## 🏗️ 技术栈

### 后端
- **运行时**: Node.js + TypeScript
- **框架**: Express.js
- **数据库**: PostgreSQL
- **交易API**: Longbridge SDK（长桥证券）
- **市场数据API**: Moomoo API（富途牛牛）

### 前端
- **框架**: Next.js 14 + React
- **UI库**: Tailwind CSS
- **状态管理**: React Hooks

## 🎯 核心功能

### 1. 量化交易策略系统
- **策略管理**: 创建、编辑、启动、停止策略
- **策略类型**: RECOMMENDATION_V1（基于市场分析的推荐策略）
- **状态管理**: IDLE → OPENING → HOLDING → CLOSING → IDLE
- **资金管理**: 策略资金分配、可用资金计算、标的级限制

### 2. 订单管理
- **订单提交**: 买入/卖出订单提交
- **订单追踪**: 实时监控订单状态，自动更新价格
- **订单查询**: 今日订单、历史订单查询
- **状态同步**: 订单状态自动同步到数据库

### 3. 持仓监控
- **止盈/止损**: 自动检查止盈/止损触发条件
- **实时价格**: 获取当前价格，计算盈亏
- **卖出信号**: 策略生成卖出信号时自动执行

### 4. 交易记录
- **自动记录**: 订单成交时自动记录交易
- **盈亏计算**: 自动计算交易盈亏
- **交易查询**: 查询历史交易记录

## 🔑 关键决策

### 1. 订单状态管理
- **方案**: 完全基于API实时状态，不依赖数据库状态
- **原因**: 避免数据库状态滞后导致的错误
- **实现**: 使用 `mapOrderData` 处理订单数据，根据 `executedQuantity` 自动修正状态

### 2. 订单追踪策略
- **方案**: 先筛选出未成交订单（基于API状态），后同步状态到数据库
- **原因**: 确保筛选基于最新的API状态，避免已成交订单进入价格更新流程
- **实现**: 方案二（完全基于API状态筛选）

### 3. 日志优化
- **方案**: 降低常规流程日志级别，只保留关键信息
- **原因**: 提高日志可读性，减少噪音
- **实现**: 将常规流程日志改为 `debug` 级别，关键操作保留 `log` 级别

### 4. 状态同步
- **方案**: 自动同步实际持仓到策略实例状态
- **原因**: 处理手动买入或状态不同步的情况
- **实现**: `syncPositionState` 方法，自动从实际持仓推断状态

## 📊 系统架构

### 核心服务

1. **StrategyScheduler** (`strategy-scheduler.service.ts`)
   - 策略生命周期管理
   - 策略周期执行
   - 订单追踪
   - 持仓监控

2. **CapitalManager** (`capital-manager.service.ts`)
   - 资金分配管理
   - 可用资金计算
   - 标的级限制计算

3. **BasicExecutionService** (`basic-execution.service.ts`)
   - 订单提交
   - 订单等待成交
   - 交易记录

4. **StateManager** (`state-manager.service.ts`)
   - 策略实例状态管理
   - 状态持久化

5. **MarketDataService** (`market-data.service.ts`)
   - 市场数据获取
   - 数据缓存

6. **TradingRecommendationService** (`trading-recommendation.service.ts`)
   - 交易信号生成
   - 市场分析

### 数据流

```
策略周期触发
  ↓
生成交易信号
  ↓
申请资金
  ↓
提交订单
  ↓
订单追踪（监控状态）
  ↓
订单成交 → 更新状态 → 记录交易
  ↓
持仓监控（检查止盈/止损）
  ↓
触发卖出 → 提交卖出订单
  ↓
卖出订单追踪
  ↓
卖出成交 → 更新状态 → 释放资金
```

## 🔧 关键优化

### 2025-12-02: 订单修改逻辑修复 ✅
- **问题**: 已成交订单仍然被尝试修改
- **解决**: 使用 `mapOrderData` 处理订单数据，完全基于API状态筛选
- **效果**: 不再出现 `602012` 错误

### 2025-12-02: 卖出监控完善 ✅
- **问题**: 只监控买入订单，没有卖出监控
- **解决**: 添加 `processHoldingPosition` 和 `processClosingPosition` 方法
- **效果**: 完整的买入→持仓→卖出流程

### 2025-12-02: 状态同步功能 ✅
- **问题**: 状态是 `IDLE` 但实际有持仓
- **解决**: 添加 `syncPositionState` 方法
- **效果**: 自动同步实际持仓到策略实例状态

### 2025-12-02: 日志优化 ✅
- **问题**: 日志噪音太大，可读性差
- **解决**: 降低常规流程日志级别，简化日志内容
- **效果**: 日志更简洁，关键信息更突出

## 📚 相关文档

- [代码地图](../../CODE_MAP.md) - 项目文件结构和调用关系
- [策略优化总结](STRATEGY_OPTIMIZATION_SUMMARY.md) - 所有策略优化的完整总结
- [策略逻辑审查](STRATEGY_LOGIC_REVIEW.md) - 策略详细逻辑说明
- [订单修改逻辑审查](ORDER_MODIFICATION_LOGIC_REVIEW.md) - 订单修改逻辑修复详情

---

**最后更新**: 2025-12-02


