# 期权行情获取API开发文档

## 概述

由于长桥API的期权行情权限限制（错误码301604），我们采用富途牛牛API作为替代方案来获取期权行情数据。

## 获取流程

### 步骤1：通过搜索接口获取正股信息

**接口地址：**
```
GET https://www.futunn.com/search-stock/predict?keyword={keyword}&lang=zh-cn&site=cn
```

**参数说明**：
- `keyword` (必需): 股票代码，例如：`tsla`
- `lang` (可选): 语言，默认 `zh-cn`
- `site` (可选): 站点，默认 `cn`

**响应示例**：
```json
{
    "code": 0,
    "message": "成功",
    "data": {
        "stock": [
            {
                "market": "us",
                "marketType": 2,
                "marketTypeName": "美股",
                "symbol": "TSLA.US",
                "stockName": "特斯拉",
                "stockSymbol": "TSLA",
                "stockId": "201335",
                "hasOption": true,
                "optional": 2
            }
        ]
    }
}
```

**关键字段**：
- `stockId`: 正股ID，用于后续接口调用
- `marketType`: 市场类型，美股为 `2`

---

### 步骤2：获取期权链数据

**接口地址：**
```
GET https://www.futunn.com/quote-api/quote-v2/get-option-chain
```

**参数说明**：
- `stockId` (必需): 正股ID，从步骤1获取
- `strikeDate` (必需): 行权日期时间戳（秒级），例如：`1763701200`（对应2025-11-21）
- `expiration` (必需): 到期类型，固定为 `1`
- `_` (必需): 时间戳（毫秒级），用于防止缓存

**鉴权方式**：
- 使用 `quote-token` 头部（与 `forex.ts` 中的鉴权方式一致）
- 需要设置 `futu-x-csrf-token` 头部
- 需要携带 cookies

**响应示例**：
```json
{
    "code": 0,
    "message": "成功",
    "data": [
        {
            "callOption": {
                "optionId": "58739819",
                "optionType": 1,
                "code": "TSLA251121C395000",
                "strikePrice": "395.00",
                "strikeDate": 1763701200,
                "openInterest": "4014",
                "priceAccuracy": 2,
                "optionExerciseMethod": 0,
                "standardType": 1,
                "indexOptionType": 0,
                "spreadTableCode": 81
            },
            "putOption": {
                "optionId": "58739929",
                "optionType": 2,
                "code": "TSLA251121P395000",
                "strikePrice": "395.00",
                "strikeDate": 1763701200,
                "openInterest": "1.18万",
                "priceAccuracy": 2,
                "optionExerciseMethod": 0,
                "standardType": 1,
                "indexOptionType": 0,
                "spreadTableCode": 81
            }
        }
    ]
}
```

**关键字段**：
- `optionId`: 期权ID，用于获取K线数据
- `optionType`: 期权类型，`1`=看涨期权(Call)，`2`=看跌期权(Put)
- `code`: 期权代码，例如：`TSLA251121P395000`

**日期转换说明**：
- 期权代码格式：`TSLA251121P395000` = `TSLA` + `251121`（2025-11-21） + `P`（Put） + `395000`（行权价）
- 日期 `251121` 转换为时间戳：`1763701200`（秒级）

---

### 步骤3：获取期权K线数据

**接口地址：**
```
GET https://www.futunn.com/quote-api/quote-v2/get-kline
```

**参数说明**：
- `stockId` (必需): 期权ID，从步骤2获取
- `marketType` (必需): 市场类型，美股为 `2`
- `type` (必需): K线类型，`1`=分时数据，`2`=日K
- `marketCode` (必需): 市场代码，美股期权为 `41`
- `instrumentType` (必需): 工具类型，期权为 `8`
- `subInstrumentType` (必需): 子工具类型，期权为 `8002`
- `_` (必需): 时间戳（毫秒级），用于防止缓存

**鉴权方式**：
- 使用 `quote-token` 头部（与 `forex.ts` 中的鉴权方式一致）
- 需要设置 `futu-x-csrf-token` 头部
- 需要携带 cookies

**响应示例（分时数据，type=1）**：
```json
{
    "code": 0,
    "message": "成功",
    "data": {
        "stockId": 58739929,
        "list": [
            {
                "time": 1763735460,
                "price": 3850,
                "cc_price": 3.85,
                "volume": 611,
                "turnover": 215627,
                "ratio": "-42.02",
                "change_price": -2.79
            }
        ],
        "time_section": [
            {
                "begin": 1763735460,
                "end": 1763758800
            }
        ],
        "server_time": 1763957294,
        "last_close_price": 6640,
        "highest_price": 11550,
        "lowest_price": 210
    }
}
```

**响应示例（日K数据，type=2）**：
```json
{
    "code": 0,
    "message": "成功",
    "data": {
        "stockId": 58739929,
        "list": [
            {
                "time": 1763701200,
                "open": 3850,
                "close": 4250,
                "high": 4500,
                "low": 3800,
                "volume": 1000,
                "turnover": 4200000
            }
        ]
    }
}
```

**关键字段**：
- `cc_price`: 收盘价（美分转美元）
- `price`: 价格（美分）
- `volume`: 成交量
- `turnover`: 成交额

---

## 鉴权实现

### quote-token 生成算法

与 `forex.ts` 中的 `generateQuoteToken` 函数一致：

1. 将请求参数序列化为JSON字符串（使用 `JSON.stringify`，保持参数顺序）
2. 使用 `HMAC-SHA512` 加密，密钥为 `"quote_web"`
3. 取HMAC结果的前10位
4. 对前10位进行 `SHA256` 哈希
5. 取SHA256结果的前10位作为最终的 `quote-token`

**TypeScript实现**：
```typescript
function generateQuoteToken(params?: Record<string, any>, data?: Record<string, any>): string {
  let dataStr: string;
  
  if (data !== undefined) {
    dataStr = JSON.stringify(data);
  } else if (params) {
    dataStr = JSON.stringify(params);
  } else {
    dataStr = '{}';
  }
  
  if (dataStr.length <= 0) {
    dataStr = 'quote';
  }
  
  const hmacResult = crypto
    .createHmac('sha512', 'quote_web')
    .update(dataStr)
    .digest('hex');
  
  const firstSlice = hmacResult.substring(0, 10);
  
  const sha256Result = crypto
    .createHash('sha256')
    .update(firstSlice)
    .digest('hex');
  
  const token = sha256Result.substring(0, 10);
  
  return token;
}
```

### Headers 设置

```typescript
const headers = {
  'authority': 'www.futunn.com',
  'accept': 'application/json, text/plain, */*',
  'accept-language': 'zh-CN,zh;q=0.9,en;q=0.8,ja;q=0.7',
  'cache-control': 'no-cache',
  'pragma': 'no-cache',
  'quote-token': quoteToken,
  'futu-x-csrf-token': 'wHaz3WlrucG684kMeoZcFTme',
  'referer': 'https://www.futunn.com/',
  'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36',
  'Cookie': cookieString, // 从浏览器获取的cookies
};
```

---

## 完整示例：获取 TSLA251121P395000 期权行情

### 1. 搜索TSLA正股
```
GET https://www.futunn.com/search-stock/predict?keyword=tsla
```
获取：`stockId = "201335"`, `marketType = 2`

### 2. 获取期权链（2025-11-21到期）
```
GET https://www.futunn.com/quote-api/quote-v2/get-option-chain?stockId=201335&strikeDate=1763701200&expiration=1&_=1763954625694
```
查找 `code = "TSLA251121P395000"` 的期权，获取：`optionId = "58739929"`

### 3. 获取期权K线
```
GET https://www.futunn.com/quote-api/quote-v2/get-kline?stockId=58739929&marketType=2&type=2&marketCode=41&instrumentType=8&subInstrumentType=8002&_=1763957269466
```

---

## 注意事项

1. **时间戳格式**：
   - `strikeDate` 使用秒级时间戳
   - `_` 参数使用毫秒级时间戳

2. **日期解析**：
   - 期权代码格式：`{SYMBOL}{YYMMDD}{C/P}{STRIKE}`
   - 例如：`TSLA251121P395000` = TSLA + 251121（2025-11-21） + P（Put） + 395000（395.000）

3. **价格单位**：
   - API返回的 `price` 字段为美分（需要除以100）
   - `cc_price` 字段已经是美元单位

4. **错误处理**：
   - 如果接口返回 `code: 500` 和 `message: "Params Error"`，检查参数是否正确
   - 确保 cookies 和 CSRF token 有效

5. **缓存策略**：
   - 正股信息可以缓存较长时间（1小时）
   - 期权链数据可以缓存较短时间（5分钟）
   - K线数据根据交易时间动态调整缓存时间

---

## 集成位置

富途牛牛期权行情API已在以下位置集成：

1. **`/api/quote/option`** (`api/src/routes/quote.ts`)
   - 当长桥API权限不足时，自动使用富途牛牛API作为备用
   - 返回格式与长桥API兼容

2. **`/api/positions`** (`api/src/routes/positions.ts`)
   - 持仓查询时自动获取期权行情
   - 优先使用长桥API，失败时自动切换到富途牛牛API
   - 正确计算期权持仓的市值和盈亏（考虑合约乘数）

## 期权持仓计算

在 `positions.ts` 中，期权持仓的计算逻辑：

- **合约乘数**: 从长桥API的 `option_extend.contract_multiplier` 获取，默认100
- **市值**: `quantity * currentPrice * contractMultiplier`
- **盈亏计算**:
  - 做多（quantity > 0）: `(currentPrice - costPrice) * quantity * contractMultiplier`
  - 卖空（quantity < 0）: `(costPrice - currentPrice) * abs(quantity) * contractMultiplier`
- **盈亏比例**: `(盈亏 / (abs(quantity) * costPrice * contractMultiplier)) * 100`

## 相关文件

- `api/src/routes/quote.ts` - 期权行情查询接口
- `api/src/routes/positions.ts` - 持仓查询接口（包含期权持仓计算）
- `api/src/services/futunn-option-quote.service.ts` - 富途牛牛期权行情服务
- `api/src/routes/forex.ts` - 参考鉴权实现
- `futunn获取行情.py` - Python实现参考

