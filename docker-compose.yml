version: '3.8'

# 单容器部署配置 - 前端和后端在同一个容器中运行
# 只需要一个 Cloudflare Tunnel 映射

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:16-alpine
    container_name: trading-postgres
    environment:
      # 支持从项目根目录的 .env 文件读取，如果没有则使用默认值
      POSTGRES_USER: ${POSTGRES_USER:-trading_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-trading_password}
      POSTGRES_DB: ${POSTGRES_DB:-trading_db}
    # 注意：不映射外部端口，因为容器之间通过 Docker 网络通信
    # 如果需要从宿主机访问数据库，可以取消下面的注释并修改端口号
    # ports:
    #   - "5433:5432"  # 使用 5433 避免与系统 PostgreSQL 冲突
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # 只挂载初始化脚本，避免执行历史迁移脚本
      - ./api/migrations/000_init_schema.sql:/docker-entrypoint-initdb.d/000_init_schema.sql:ro
    healthcheck:
      # 健康检查也使用环境变量
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-trading_user} -d ${POSTGRES_DB:-trading_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - trading-network

  # 统一应用服务（前端 + 后端）
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: trading-app
    environment:
      # 数据库连接URL，支持从环境变量读取账号密码
      DATABASE_URL: postgresql://${POSTGRES_USER:-trading_user}:${POSTGRES_PASSWORD:-trading_password}@postgres:5432/${POSTGRES_DB:-trading_db}

      # 后端配置
      PORT: 3001
      NODE_ENV: production

      # 前端配置（Next.js 运行在 3000 端口）
      FRONTEND_PORT: 3000

      # 长桥API配置（需要从环境变量或 .env 文件提供）
      LONGPORT_APP_KEY: ${LONGPORT_APP_KEY:-your_app_key}
      LONGPORT_APP_SECRET: ${LONGPORT_APP_SECRET:-your_app_secret}
      LONGPORT_ACCESS_TOKEN: ${LONGPORT_ACCESS_TOKEN:-your_access_token}
      LONGPORT_ENABLE_OVERNIGHT: ${LONGPORT_ENABLE_OVERNIGHT:-false}

      # 标记跳过长桥初始化（当长桥原生模块不可用时）
      SKIP_LONGPORT_INIT: "true"
    ports:
      # 单端口访问 - 通过后端代理访问前端
      # 访问 http://your-host:3001 可同时使用前端和 API
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # 挂载 .env 文件（只读）
      - ./api/.env:/app/api/.env:ro
      # 挂载日志目录（可选）
      - ./logs:/app/logs
    networks:
      - trading-network
    restart: unless-stopped
    healthcheck:
      # 健康检查后端 API
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  postgres_data:

networks:
  trading-network:
    driver: bridge

